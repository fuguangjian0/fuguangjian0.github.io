<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Java集合专题</title>
    <link href="/2023/12/30/Java%E9%9B%86%E5%90%88%E4%B8%93%E9%A2%98/"/>
    <url>/2023/12/30/Java%E9%9B%86%E5%90%88%E4%B8%93%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230150526641.png" alt="image-20231230150526641"></p><h3 id="集合框架体系"><a href="#集合框架体系" class="headerlink" title="集合框架体系"></a>集合框架体系</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230150552673.png" alt="image-20231230150552673"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230150610569.png" alt="image-20231230150610569"></p><p>集合主要有2组，<br>一组是单列集合（集合里面放的是的那个的对象），<br>另一组是双列集合，我那个网是键值对形式的</p><p>Collection接口有List和Set这两个主要的接口，他们的实现类都是单列集合<br>Map接口的实现子类是双列集合，存放key和value这样的数据</p><h3 id="Collections方法"><a href="#Collections方法" class="headerlink" title="Collections方法"></a>Collections方法</h3><p>Collection接口继承了Iterable接口<br>1 collection实现子类可以存放多个元素，每个元素可以是Object<br>2 有些Coolection的实现类可以存放重复的元素，有些不可以<br>3 有些Collectiond的实现类，存放数据是有序的，有些是无序的<br>4 Collection接口没有直接的实现子类，是通过子接口Set和List来实现的</p><p>接口是不能直接被实例化的，只有实现了接口的这个类才能被实例化</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230150713555.png" alt="image-20231230150713555"></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs csharp">package com.hspedu.collection_;<br><br>import java.util.ArrayList;<br>import java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @author 韩顺平</span><br><span class="hljs-comment"> * @version 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CollectionMethod</span> &#123;<br>    @SuppressWarnings(&#123;<span class="hljs-string">&quot;all&quot;</span>&#125;)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> &#123;<br>        List list = <span class="hljs-keyword">new</span> ArrayList();<br><span class="hljs-comment">//        add:添加单个元素</span><br>        list.<span class="hljs-keyword">add</span>(<span class="hljs-string">&quot;jack&quot;</span>);<br>        list.<span class="hljs-keyword">add</span>(<span class="hljs-number">10</span>);<span class="hljs-comment">//list.add(new Integer(10))</span><br>        list.<span class="hljs-keyword">add</span>(<span class="hljs-literal">true</span>);<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;list=&quot;</span> + list);<br><span class="hljs-comment">//        remove:删除指定元素</span><br>        <span class="hljs-comment">//list.remove(0);//删除第一个元素</span><br>        list.<span class="hljs-keyword">remove</span>(<span class="hljs-literal">true</span>);<span class="hljs-comment">//指定删除某个元素</span><br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;list=&quot;</span> + list);<br><span class="hljs-comment">//        contains:查找元素是否存在</span><br>        System.<span class="hljs-keyword">out</span>.println(list.contains(<span class="hljs-string">&quot;jack&quot;</span>));<span class="hljs-comment">//T</span><br><span class="hljs-comment">//        size:获取元素个数</span><br>        System.<span class="hljs-keyword">out</span>.println(list.size());<span class="hljs-comment">//2</span><br><span class="hljs-comment">//        isEmpty:判断是否为空</span><br>        System.<span class="hljs-keyword">out</span>.println(list.isEmpty());<span class="hljs-comment">//F</span><br><span class="hljs-comment">//        clear:清空</span><br>        list.clear();<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;list=&quot;</span> + list);<br><span class="hljs-comment">//        addAll:添加多个元素</span><br>        ArrayList list2 = <span class="hljs-keyword">new</span> ArrayList();<br>        list2.<span class="hljs-keyword">add</span>(<span class="hljs-string">&quot;红楼梦&quot;</span>);<br>        list2.<span class="hljs-keyword">add</span>(<span class="hljs-string">&quot;三国演义&quot;</span>);<br>        list.addAll(list2);<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;list=&quot;</span> + list);<br><span class="hljs-comment">//        containsAll:查找多个元素是否都存在</span><br>        System.<span class="hljs-keyword">out</span>.println(list.containsAll(list2));<span class="hljs-comment">//T</span><br><span class="hljs-comment">//        removeAll：删除多个元素</span><br>        list.<span class="hljs-keyword">add</span>(<span class="hljs-string">&quot;聊斋&quot;</span>);<br>        list.removeAll(list2);<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;list=&quot;</span> + list);<span class="hljs-comment">//[聊斋]</span><br><span class="hljs-comment">//        说明：以ArrayList实现类来演示.</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="迭代器遍历"><a href="#迭代器遍历" class="headerlink" title="迭代器遍历"></a>迭代器遍历</h3><p>Collection接口遍历元素的方式<br>1迭代器Iterator<br>Iterator对象称为迭代器，主要用于遍历Collection集合中的元素<br>所有实现了Collection接口的集合类都有一个Iterator()方法，用以返回一个实现了Iterator接口的对象，即可以返回一个迭代器<br>Iterator仅用于遍历集合，Iterator本身并不存储对象</p><p>迭代器的执行原理：指针不断下移，直到遍历完集合中的元素</p><p>注意返回的是指针下移以后指向的那个元素（有点像链表）</p><p>老韩提示:在调用iterator.next()方法之前必须要调用iterator.hasNext()进行检测。若不调用，且下一条记录无效,直接调用it.next()会抛出NoSuchElementException异常。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.collection_;<br><br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Collection;<br><span class="hljs-keyword">import</span> java.util.Iterator;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CollectionIterator</span> &#123;<br>    <span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">Collection</span> <span class="hljs-variable">col</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>        col.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-string">&quot;三国演义&quot;</span>, <span class="hljs-string">&quot;罗贯中&quot;</span>, <span class="hljs-number">10.1</span>));<br>        col.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-string">&quot;小李飞刀&quot;</span>, <span class="hljs-string">&quot;古龙&quot;</span>, <span class="hljs-number">5.1</span>));<br>        col.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-string">&quot;红楼梦&quot;</span>, <span class="hljs-string">&quot;曹雪芹&quot;</span>, <span class="hljs-number">34.6</span>));<br><br><br>        <span class="hljs-comment">//System.out.println(&quot;col=&quot; + col);</span><br>        <span class="hljs-comment">//现在老师希望能够遍历 col集合</span><br>        <span class="hljs-comment">//1. 先得到 col 对应的 迭代器</span><br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">iterator</span> <span class="hljs-operator">=</span> col.iterator();<br>        <span class="hljs-comment">//2. 使用while循环遍历</span><br><span class="hljs-comment">//        while (iterator.hasNext()) &#123;//判断是否还有数据</span><br><span class="hljs-comment">//            //返回下一个元素，类型是Object</span><br><span class="hljs-comment">//            Object obj = iterator.next();</span><br><span class="hljs-comment">//            System.out.println(&quot;obj=&quot; + obj);</span><br><span class="hljs-comment">//        &#125;</span><br>        <span class="hljs-comment">//老师教大家一个快捷键，快速生成 while =&gt; itit</span><br>        <span class="hljs-comment">//显示所有的快捷键的的快捷键 ctrl + j</span><br>        <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> iterator.next();<br>            System.out.println(<span class="hljs-string">&quot;obj=&quot;</span> + obj);<br><br>        &#125;<br>        <span class="hljs-comment">//3. 当退出while循环后 , 这时iterator迭代器，指向最后的元素</span><br>        <span class="hljs-comment">//   iterator.next();//NoSuchElementException</span><br>        <span class="hljs-comment">//4. 如果希望再次遍历，需要重置我们的迭代器</span><br>        iterator = col.iterator();<br>        System.out.println(<span class="hljs-string">&quot;===第二次遍历===&quot;</span>);<br>        <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> iterator.next();<br>            System.out.println(<span class="hljs-string">&quot;obj=&quot;</span> + obj);<br><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String author;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Book</span><span class="hljs-params">(String name, String author, <span class="hljs-type">double</span> price)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.author = author;<br>        <span class="hljs-built_in">this</span>.price = price;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>代码解读：<br>Object obj &#x3D; iterator.next();<br>obj的编译类型是 Object ，但是运行类型取决于真正取出来的数据类型（编译看左边，运行看右边）</p><ol start="3"><li>当退出while循环后 , 这时iterator迭代器，指向最后的元素 则会报异常iterator.next();&#x2F;&#x2F;NoSuchElementException</li><li>如果希望再次遍历，需要重置我们的迭代器 iterator &#x3D; col.iterator();</li></ol><figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nim"><span class="hljs-type">Iterator</span> <span class="hljs-keyword">iterator</span> = list2.<span class="hljs-keyword">iterator</span>();<br><span class="hljs-type">System</span>.<span class="hljs-keyword">out</span>.println(<span class="hljs-keyword">iterator</span> .hashCode());<br><span class="hljs-keyword">iterator</span> = list2.<span class="hljs-keyword">iterator</span>();<br><span class="hljs-type">System</span>.<span class="hljs-keyword">out</span>.println(<span class="hljs-keyword">iterator</span> .hashCode());<br></code></pre></td></tr></table></figure><p>但是注意，迭代器对象已经遍历，不是同一个对象，因为哈希值都不一样了</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230150927043.png" alt="image-20231230150927043"></p><h3 id="集合增强for"><a href="#集合增强for" class="headerlink" title="集合增强for"></a>集合增强for</h3><p>基本语法<br>for(元素类型 元素名：集合或数组名){<br>访问元素<br>}</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.collection_;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Collection;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CollectionFor</span> &#123;<br>    <span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Collection</span> <span class="hljs-variable">col</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>        col.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-string">&quot;三国演义&quot;</span>, <span class="hljs-string">&quot;罗贯中&quot;</span>, <span class="hljs-number">10.1</span>));<br>        col.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-string">&quot;小李飞刀&quot;</span>, <span class="hljs-string">&quot;古龙&quot;</span>, <span class="hljs-number">5.1</span>));<br>        col.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-string">&quot;红楼梦&quot;</span>, <span class="hljs-string">&quot;曹雪芹&quot;</span>, <span class="hljs-number">34.6</span>));<br><br>        <span class="hljs-comment">//老韩解读</span><br>        <span class="hljs-comment">//1. 使用增强for, 在Collection集合</span><br>        <span class="hljs-comment">//2. 增强for， 底层仍然是迭代器</span><br>        <span class="hljs-comment">//3. 增强for可以理解成就是简化版本的 迭代器遍历</span><br>        <span class="hljs-comment">//4. 快捷键方式 I</span><br><span class="hljs-comment">//        for (Object book : col) &#123;</span><br><span class="hljs-comment">//            System.out.println(&quot;book=&quot; + book);</span><br><span class="hljs-comment">//        &#125;</span><br>        <span class="hljs-keyword">for</span> (Object o : col) &#123;<br>            System.out.println(<span class="hljs-string">&quot;book=&quot;</span> + o);<br>        &#125;<br><br>        <span class="hljs-comment">//增强for，也可以直接在数组使用</span><br><span class="hljs-comment">//        int[] nums = &#123;1, 8, 10, 90&#125;;</span><br><span class="hljs-comment">//        for (int i : nums) &#123;</span><br><span class="hljs-comment">//            System.out.println(&quot;i=&quot; + i);</span><br><span class="hljs-comment">//        &#125;</span><br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>代码解读。增强for的底层仍然是迭代器，在for循环端点debug就可以看到了，会调用Iterator,增强for可以看成简易版的迭代器</p><h3 id="List接口方法"><a href="#List接口方法" class="headerlink" title="List接口方法"></a>List接口方法</h3><p>List接口是Collection接口的子接口<br>List的实现类中的元素是有序的，即添加顺序和取出元素的顺序是一样的，且可以重复<br>List集合中的每个额元素都有其对应的顺序索引，即支持索引<br>List容器的每个元素对应一个整数型的序号记载其在容器中的位置们可以根据序号存取容器中的元素（注意linkedList也是支持索引的哈）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">List list3= new LinkedList();<br>list3.<span class="hljs-built_in">add</span>(1);<br>list3.<span class="hljs-built_in">add</span>(12);<br>list3.<span class="hljs-built_in">add</span>(3);<br>System.out.println(list3.<span class="hljs-built_in">get</span>(1));<br><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230151035913.png" alt="image-20231230151035913"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">package com.hspedu.list_;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @author 韩顺平</span><br><span class="hljs-comment"> * @version 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> ListMethod &#123;<br>    @SuppressWarnings(&#123;&quot;all&quot;&#125;)<br>    <span class="hljs-built_in">public</span> static <span class="hljs-type">void</span> main(String[] args) &#123;<br>        List list = <span class="hljs-built_in">new</span> ArrayList();<br>        list.<span class="hljs-keyword">add</span>(&quot;张三丰&quot;);<br>        list.<span class="hljs-keyword">add</span>(&quot;贾宝玉&quot;);<br>//        <span class="hljs-type">void</span> <span class="hljs-keyword">add</span>(<span class="hljs-type">int</span> <span class="hljs-keyword">index</span>, <span class="hljs-keyword">Object</span> ele):在<span class="hljs-keyword">index</span>位置插入ele元素<br>        //在<span class="hljs-keyword">index</span> = <span class="hljs-number">1</span>的位置插入一个对象<br>        list.<span class="hljs-keyword">add</span>(<span class="hljs-number">1</span>, &quot;韩顺平&quot;);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;list=&quot; + list);<br>//        <span class="hljs-type">boolean</span> addAll(<span class="hljs-type">int</span> <span class="hljs-keyword">index</span>, Collection eles):从<span class="hljs-keyword">index</span>位置开始将eles中的所有元素添加进来<br>        List list2 = <span class="hljs-built_in">new</span> ArrayList();<br>        list2.<span class="hljs-keyword">add</span>(&quot;jack&quot;);<br>        list2.<span class="hljs-keyword">add</span>(&quot;tom&quot;);<br>        list.addAll(<span class="hljs-number">1</span>, list2);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;list=&quot; + list);<br>//        <span class="hljs-keyword">Object</span> <span class="hljs-keyword">get</span>(<span class="hljs-type">int</span> <span class="hljs-keyword">index</span>):获取指定<span class="hljs-keyword">index</span>位置的元素<br>        //说过<br>//        <span class="hljs-type">int</span> indexOf(<span class="hljs-keyword">Object</span> obj):返回obj在集合中首次出现的位置<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(list.indexOf(&quot;tom&quot;));//<span class="hljs-number">2</span><br>//        <span class="hljs-type">int</span> lastIndexOf(<span class="hljs-keyword">Object</span> obj):返回obj在当前集合中末次出现的位置<br>        list.<span class="hljs-keyword">add</span>(&quot;韩顺平&quot;);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;list=&quot; + list);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(list.lastIndexOf(&quot;韩顺平&quot;));<br>//        <span class="hljs-keyword">Object</span> remove(<span class="hljs-type">int</span> <span class="hljs-keyword">index</span>):移除指定<span class="hljs-keyword">index</span>位置的元素，并返回此元素<br>        list.remove(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;list=&quot; + list);<br>//        <span class="hljs-keyword">Object</span> <span class="hljs-keyword">set</span>(<span class="hljs-type">int</span> <span class="hljs-keyword">index</span>, <span class="hljs-keyword">Object</span> ele):设置指定<span class="hljs-keyword">index</span>位置的元素为ele , 相当于是替换.<br>        list.<span class="hljs-keyword">set</span>(<span class="hljs-number">1</span>, &quot;玛丽&quot;);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;list=&quot; + list);<br>//        List subList(<span class="hljs-type">int</span> fromIndex, <span class="hljs-type">int</span> toIndex):返回从fromIndex到toIndex位置的子集合<br>        // 注意返回的子集合 fromIndex &lt;= subList &lt; toIndex<br>        List returnlist = list.subList(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;returnlist=&quot; + returnlist);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>代码解读</p><p>list.subList(0, 2);注意返回的子集合 fromIndex &lt;&#x3D; subList &lt; toIndex，就是不包含toIndex对应的元素，<code>前闭后开</code>，可以理解，size&#x3D;toIndex- fromIndex</p><h3 id="List的三种遍历方式"><a href="#List的三种遍历方式" class="headerlink" title="List的三种遍历方式"></a>List的三种遍历方式</h3><p>迭代器 增强for 普通for</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ListFor</span> &#123;<br>    @SuppressWarnings(&#123;<span class="hljs-string">&quot;all&quot;</span>&#125;)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> &#123;<br><br>        <span class="hljs-comment">//List 接口的实现子类 Vector LinkedList</span><br>        <span class="hljs-comment">//List list = new ArrayList();</span><br>        <span class="hljs-comment">//List list = new Vector();</span><br>        List list = <span class="hljs-keyword">new</span> LinkedList();<br><br>        list.<span class="hljs-keyword">add</span>(<span class="hljs-string">&quot;jack&quot;</span>);<br>        list.<span class="hljs-keyword">add</span>(<span class="hljs-string">&quot;tom&quot;</span>);<br>        list.<span class="hljs-keyword">add</span>(<span class="hljs-string">&quot;鱼香肉丝&quot;</span>);<br>        list.<span class="hljs-keyword">add</span>(<span class="hljs-string">&quot;北京烤鸭子&quot;</span>);<br><br>        <span class="hljs-comment">//遍历</span><br>        <span class="hljs-comment">//1. 迭代器</span><br>        Iterator iterator = list.iterator();<br>        <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>            Object obj =  iterator.next();<br>            System.<span class="hljs-keyword">out</span>.println(obj);<br><br>        &#125;<br><br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;=====增强for=====&quot;</span>);<br>        <span class="hljs-comment">//2. 增强for</span><br>        <span class="hljs-keyword">for</span> (Object o : list) &#123;<br>            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;o=&quot;</span> + o);<br>        &#125;<br><br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;=====普通for====&quot;</span>);<br>        <span class="hljs-comment">//3. 使用普通for</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; list.size(); i++) &#123;<br>            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;对象=&quot;</span> + list.<span class="hljs-keyword">get</span>(i));<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="ArrayList源码剖析"><a href="#ArrayList源码剖析" class="headerlink" title="ArrayList源码剖析"></a>ArrayList源码剖析</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230151358224.png" alt="image-20231230151358224"></p><p>对象在序列化的时候，transient修饰的属性不会被序列化</p><p>2)当创建对象时，如果使用的是无参构造器,则初始elementData容量为0 (jdk7是10)</p><p>3)当添加元素时:先判断是否需要扩容,如果需要扩容，则调用grow方法，否则直接添加元素到合适位置</p><p>4)当创建ArrayList对象时，如果使用的是无参构造器，则初始elementData容量为0，第1次添加，则扩容elementData为10，如需要再次扩容，则扩容elementData为1.5倍。</p><p>5)如果使用的是指定容量capacity的构造器，则初始elementData容量为capacity</p><p>6)如果使用的是指定容量capacity的构造器,如果需要扩容，则直接扩容elementData为1.5倍。</p><p>ArrayList的扩容方式</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230151425945.png" alt="image-20231230151425945"></p><p>ArrayList是空间不够了才扩容的，假设现在插入第11个元素，但是只有10个空间，就触发grow扩容</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230151437953.png" alt="image-20231230151437953"></p><p>注意扩容之后调用了CopyOf函数</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230151448321.png" alt="image-20231230151448321"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.list_;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayListSource</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">//老韩解读源码</span><br>        <span class="hljs-comment">//注意，注意，注意，Idea 默认情况下，Debug 显示的数据是简化后的，如果希望看到完整的数据</span><br>        <span class="hljs-comment">//需要做设置.</span><br>        <span class="hljs-comment">//使用无参构造器创建ArrayList对象</span><br>        <span class="hljs-comment">//ArrayList list = new ArrayList();</span><br>        <span class="hljs-type">ArrayList</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(<span class="hljs-number">8</span>);<br>        <span class="hljs-comment">//使用for给list集合添加 1-10数据</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++) &#123;<br>            list.add(i);<br>        &#125;<br>        <span class="hljs-comment">//使用for给list集合添加 11-15数据</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">11</span>; i &lt;= <span class="hljs-number">15</span>; i++) &#123;<br>            list.add(i);<br>        &#125;<br>        list.add(<span class="hljs-number">100</span>);<br>        list.add(<span class="hljs-number">200</span>);<br>        list.add(<span class="hljs-literal">null</span>);<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><h3 id="vector底层结构和源码剖析"><a href="#vector底层结构和源码剖析" class="headerlink" title="vector底层结构和源码剖析"></a>vector底层结构和源码剖析</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230151508803.png" alt="image-20231230151508803"></p><h3 id="双向链表模拟"><a href="#双向链表模拟" class="headerlink" title="双向链表模拟"></a>双向链表模拟</h3><p>LinkedList说明：</p><ol><li>底层实现了双向链表和双端队列的特点</li><li>可以添加任意元素，元素可以重复，包括null</li><li>线程不安全，没有实现同步</li></ol><p>LinkedList的底层操作机制：</p><ol><li><p>LinkedList底层维护一个双向链表。</p></li><li><p>维护两个属性first和last分别指向首节点和尾节点</p></li><li><p>每个节点(Node对象)，里面维护了prev next item3个属性，通过prev指向前一个，通过next指向后一个节点，最终实现双向链表</p></li><li><p>所以LinkedList的元素的添加和删除，不是通过数组完成的，相对来说效率较高</p></li><li><p>模拟一个简单的双向链表</p></li></ol><h3 id="LinkedList源码图解"><a href="#LinkedList源码图解" class="headerlink" title="LinkedList源码图解"></a>LinkedList源码图解</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230151921759.png" alt="image-20231230151921759"></p><p>因为linkedList实现了list接口，所以它的遍历方式可以是迭代器，增强for循环以及传统的for循环遍历</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.list_;<br><br><span class="hljs-keyword">import</span> java.util.Iterator;<br><span class="hljs-keyword">import</span> java.util.LinkedList;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedListCRUD</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">LinkedList</span> <span class="hljs-variable">linkedList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>();<br>        linkedList.add(<span class="hljs-number">1</span>);<br>        linkedList.add(<span class="hljs-number">2</span>);<br>        linkedList.add(<span class="hljs-number">3</span>);<br>        System.out.println(<span class="hljs-string">&quot;linkedList=&quot;</span> + linkedList);<br><br>        <span class="hljs-comment">//演示一个删除结点的</span><br>        linkedList.remove(); <span class="hljs-comment">// 这里默认删除的是第一个结点</span><br>        <span class="hljs-comment">//linkedList.remove(2);</span><br><br>        System.out.println(<span class="hljs-string">&quot;linkedList=&quot;</span> + linkedList);<br><br>        <span class="hljs-comment">//修改某个结点对象</span><br>        linkedList.set(<span class="hljs-number">1</span>, <span class="hljs-number">999</span>);<br>        System.out.println(<span class="hljs-string">&quot;linkedList=&quot;</span> + linkedList);<br><br>        <span class="hljs-comment">//得到某个结点对象</span><br>        <span class="hljs-comment">//get(1) 是得到双向链表的第二个对象</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> linkedList.get(<span class="hljs-number">1</span>);<br>        System.out.println(o);<span class="hljs-comment">//999</span><br><br>        <span class="hljs-comment">//因为LinkedList 是 实现了List接口, 遍历方式</span><br>        System.out.println(<span class="hljs-string">&quot;===LinkeList遍历迭代器====&quot;</span>);<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">iterator</span> <span class="hljs-operator">=</span> linkedList.iterator();<br>        <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span>  iterator.next();<br>            System.out.println(<span class="hljs-string">&quot;next=&quot;</span> + next);<br><br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;===LinkeList遍历增强for====&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Object o1 : linkedList) &#123;<br>            System.out.println(<span class="hljs-string">&quot;o1=&quot;</span> + o1);<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;===LinkeList遍历普通for====&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; linkedList.size(); i++) &#123;<br>            System.out.println(linkedList.get(i));<br>        &#125;<br><br><br>        <span class="hljs-comment">//老韩源码阅读.</span><br>        <span class="hljs-comment">/* 1. LinkedList linkedList = new LinkedList();</span><br><span class="hljs-comment">              public LinkedList() &#123;&#125;</span><br><span class="hljs-comment">           2. 这时 linkeList 的属性 first = null  last = null</span><br><span class="hljs-comment">           3. 执行 添加</span><br><span class="hljs-comment">               public boolean add(E e) &#123;</span><br><span class="hljs-comment">                    linkLast(e);</span><br><span class="hljs-comment">                    return true;</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment">            4.将新的结点，加入到双向链表的最后</span><br><span class="hljs-comment">             void linkLast(E e) &#123;</span><br><span class="hljs-comment">                final Node&lt;E&gt; l = last;</span><br><span class="hljs-comment">                final Node&lt;E&gt; newNode = new Node&lt;&gt;(l, e, null);</span><br><span class="hljs-comment">                last = newNode;</span><br><span class="hljs-comment">                if (l == null)</span><br><span class="hljs-comment">                    first = newNode;</span><br><span class="hljs-comment">                else</span><br><span class="hljs-comment">                    l.next = newNode;</span><br><span class="hljs-comment">                size++;</span><br><span class="hljs-comment">                modCount++;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">          老韩读源码 linkedList.remove(); // 这里默认删除的是第一个结点</span><br><span class="hljs-comment">          1. 执行 removeFirst</span><br><span class="hljs-comment">            public E remove() &#123;</span><br><span class="hljs-comment">                return removeFirst();</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">         2. 执行</span><br><span class="hljs-comment">            public E removeFirst() &#123;</span><br><span class="hljs-comment">                final Node&lt;E&gt; f = first;</span><br><span class="hljs-comment">                if (f == null)</span><br><span class="hljs-comment">                    throw new NoSuchElementException();</span><br><span class="hljs-comment">                return unlinkFirst(f);</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">          3. 执行 unlinkFirst, 将 f 指向的双向链表的第一个结点拿掉</span><br><span class="hljs-comment">            private E unlinkFirst(Node&lt;E&gt; f) &#123;</span><br><span class="hljs-comment">                // assert f == first &amp;&amp; f != null;</span><br><span class="hljs-comment">                final E element = f.item;</span><br><span class="hljs-comment">                final Node&lt;E&gt; next = f.next;</span><br><span class="hljs-comment">                f.item = null;</span><br><span class="hljs-comment">                f.next = null; // help GC</span><br><span class="hljs-comment">                first = next;</span><br><span class="hljs-comment">                if (next == null)</span><br><span class="hljs-comment">                    last = null;</span><br><span class="hljs-comment">                else</span><br><span class="hljs-comment">                    next.prev = null;</span><br><span class="hljs-comment">                size--;</span><br><span class="hljs-comment">                modCount++;</span><br><span class="hljs-comment">                return element;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">         */</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="list集合选择"><a href="#list集合选择" class="headerlink" title="list集合选择"></a>list集合选择</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230153650258.png" alt="image-20231230153650258"></p><p>ArrayList插入数据涉及扩容操作，效率低，改和查的效率比较高，因为可以通过索引定位</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230153713436.png" alt="image-20231230153713436"></p><h3 id="Set接口和方法"><a href="#Set接口和方法" class="headerlink" title="Set接口和方法"></a>Set接口和方法</h3><p>set接口无序（添加和取出元素顺序不一样），没有索引，不支持随机访问</p><p>不允许有重复元素，最多一个null</p><p>和List接口一样，Set接口是Collection接口的子接口，因此常用方法和Collection接口一样，同Collection接口遍历方式一样，因为Set接口是Collection接口的子接口，所以Set接口的遍历可以使用迭代器和增强for</p><p>不能使用索引来获取</p><h3 id="HashSet全面说明"><a href="#HashSet全面说明" class="headerlink" title="HashSet全面说明"></a>HashSet全面说明</h3><p>HashSet实现了Set接口<br>HashSet底层实际上是HashMap</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HashSet</span><span class="hljs-params">()</span> </span>&#123;<br>    map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure><p>add方法用的也是map的方法</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-built_in">add</span>(E e) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">map</span>.<span class="hljs-property">put</span>(e, PRESENT)==<span class="hljs-literal">null</span>;<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>key值默认是PRESENT</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-comment">// Dummy value to associate with an Object in the backing Map</span><br> private <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Object</span> PRESENT = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Object</span>();<br></code></pre></td></tr></table></figure><p>可以存放null，只能有一个null</p><p>HashSet不保证元素是有序的,取决于hash后，再确定索引的结果.(即，不保证存放元素的顺序和取出顺序一致)</p><p>不能有重复元素&#x2F;对象.在前面Set 接口使用已经讲过</p><p>在存储对象进HashSet时，对象重写equals方法一定要重写hashCode方法，不然就会出现两个对象里面的数据一模一样，但是都可以存进HashSet集合中，因为如果没有重写HashCode方法，对象会使用父类Object类的hashCode方法，而Object的HashCode方法是根据地址来计算的，一定不会一样</p><p>&#x3D;&#x3D;使用的比较地址就是用的hashcode()喽</p><h3 id="数组链表模拟"><a href="#数组链表模拟" class="headerlink" title="数组链表模拟"></a>数组链表模拟</h3><p>HashSet底层是HashMap，HashMap底层是 数组加链表&#x2F;红黑树</p><p>数组的元素存放节点</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.hspedu.set_;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @author 韩顺平</span><br><span class="hljs-comment"> * @version 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings</span>(&#123;<span class="hljs-string">&quot;all&quot;</span>&#125;)<br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">HashSetStructure</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void main(<span class="hljs-keyword">String</span>[] args) &#123;<br>        <span class="hljs-comment">//模拟一个HashSet的底层 (HashMap 的底层结构)</span><br><br>        <span class="hljs-comment">//1. 创建一个数组，数组的类型是 Node[]</span><br>        <span class="hljs-comment">//2. 有些人，直接把 Node[] 数组称为 表</span><br>        Node[] table = <span class="hljs-keyword">new</span> <span class="hljs-type">Node</span>[<span class="hljs-number">16</span>];<br><br>        <span class="hljs-comment">//3. 创建结点</span><br>        Node john = <span class="hljs-keyword">new</span> <span class="hljs-type">Node</span>(<span class="hljs-string">&quot;john&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        table[<span class="hljs-number">2</span>] = john;<br>        Node jack = <span class="hljs-keyword">new</span> <span class="hljs-type">Node</span>(<span class="hljs-string">&quot;jack&quot;</span>, <span class="hljs-literal">null</span>);<br>        john.next = jack;<span class="hljs-comment">// 将jack 结点挂载到john</span><br>        Node rose = <span class="hljs-keyword">new</span> <span class="hljs-type">Node</span>(<span class="hljs-string">&quot;Rose&quot;</span>, <span class="hljs-literal">null</span>);<br>        jack.next = rose;<span class="hljs-comment">// 将rose 结点挂载到jack</span><br><br>        Node lucy = <span class="hljs-keyword">new</span> <span class="hljs-type">Node</span>(<span class="hljs-string">&quot;lucy&quot;</span>, <span class="hljs-literal">null</span>);<br>        table[<span class="hljs-number">3</span>] = lucy; <span class="hljs-comment">// 把lucy 放到 table表的索引为3的位置.</span><br>        System.out.println(<span class="hljs-string">&quot;table=&quot;</span> + table);<br><br><br>    &#125;<br>&#125;<br><span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">Node</span> </span>&#123; <span class="hljs-comment">//结点, 存储数据, 可以指向下一个结点，从而形成链表</span><br>    Object item; <span class="hljs-comment">//存放数据</span><br>    Node next; <span class="hljs-comment">// 指向下一个结点</span><br><br>    <span class="hljs-keyword">public</span> Node(Object item, Node next) &#123;<br>        <span class="hljs-built_in">this</span>.item = item;<br>        <span class="hljs-built_in">this</span>.next = next;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230161425917.png" alt="image-20231230161425917"></p><p>在hashmap底层，如果一条链表的节点的个数达到一定数量，就会变成红黑树，因为红黑树的存取效率更高</p><p><strong>为什么不直接把数据放在一个数组里面？</strong><br>答：数组的效率太低了</p><h3 id="HashSet扩容机制"><a href="#HashSet扩容机制" class="headerlink" title="HashSet扩容机制"></a>HashSet扩容机制</h3><p><strong>元素是怎么添加的？</strong></p><p><strong>为什么相同的对象无法添加？</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230161546598.png" alt="image-20231230161546598"></p><p>上图中的equals是我们自己可以重写的</p><p>如果单条链表节点超过了8但是总的节点数没达到64怎么办了？<br>答：扩容，按2倍扩</p><h3 id="HashSet源码分析"><a href="#HashSet源码分析" class="headerlink" title="HashSet源码分析"></a>HashSet源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.set_;<br><br><span class="hljs-keyword">import</span> java.util.HashSet;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashSetSource</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">HashSet</span> <span class="hljs-variable">hashSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>        hashSet.add(<span class="hljs-string">&quot;java&quot;</span>);<span class="hljs-comment">//到此位置，第1次add分析完毕.</span><br>        hashSet.add(<span class="hljs-string">&quot;php&quot;</span>);<span class="hljs-comment">//到此位置，第2次add分析完毕</span><br>        hashSet.add(<span class="hljs-string">&quot;java&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;set=&quot;</span> + hashSet);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        老韩对HashSet 的源码解读</span><br><span class="hljs-comment">        1. 执行 HashSet()</span><br><span class="hljs-comment">            public HashSet() &#123;</span><br><span class="hljs-comment">                map = new HashMap&lt;&gt;();</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">        2. 执行 add()</span><br><span class="hljs-comment">           public boolean add(E e) &#123;//e = &quot;java&quot;</span><br><span class="hljs-comment">                return map.put(e, PRESENT)==null;//(static) PRESENT = new Object();</span><br><span class="hljs-comment">           &#125;</span><br><span class="hljs-comment">         3.执行 put() , 该方法会执行 hash(key) 得到key对应的hash值 算法h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)</span><br><span class="hljs-comment">             public V put(K key, V value) &#123;//key = &quot;java&quot; value = PRESENT 共享</span><br><span class="hljs-comment">                return putVal(hash(key), key, value, false, true);</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">         4.执行 putVal</span><br><span class="hljs-comment">         final V putVal(int hash, K key, V value, boolean onlyIfAbsent,</span><br><span class="hljs-comment">                   boolean evict) &#123;</span><br><span class="hljs-comment">                Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i; //定义了辅助变量</span><br><span class="hljs-comment">                //table 就是 HashMap 的一个数组，类型是 Node[]</span><br><span class="hljs-comment">                //if 语句表示如果当前table 是null, 或者 大小=0</span><br><span class="hljs-comment">                //就是第一次扩容，到16个空间.</span><br><span class="hljs-comment">                if ((tab = table) == null || (n = tab.length) == 0)</span><br><span class="hljs-comment">                    n = (tab = resize()).length;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                //(1)根据key，得到hash 去计算该key应该存放到table表的哪个索引位置</span><br><span class="hljs-comment">                //并把这个位置的对象，赋给 p</span><br><span class="hljs-comment">                //(2)判断p 是否为null</span><br><span class="hljs-comment">                //(2.1) 如果p 为null, 表示还没有存放元素, 就创建一个Node (key=&quot;java&quot;,value=PRESENT)</span><br><span class="hljs-comment">                //(2.2) 就放在该位置 tab[i] = newNode(hash, key, value, null)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                if ((p = tab[i = (n - 1) &amp; hash]) == null)</span><br><span class="hljs-comment">                    tab[i] = newNode(hash, key, value, null);</span><br><span class="hljs-comment">                else &#123;</span><br><span class="hljs-comment">                    //一个开发技巧提示： 在需要局部变量(辅助变量)时候，在创建</span><br><span class="hljs-comment">                    Node&lt;K,V&gt; e; K k; //</span><br><span class="hljs-comment">                    //如果当前索引位置对应的链表的第一个元素和准备添加的key的hash值一样</span><br><span class="hljs-comment">                    //并且满足 下面两个条件之一:</span><br><span class="hljs-comment">                    //(1) 准备加入的key 和 p 指向的Node 结点的 key 是同一个对象</span><br><span class="hljs-comment">                    //(2)  p 指向的Node 结点的 key 的equals() 和准备加入的key比较后相同</span><br><span class="hljs-comment">                    //就不能加入</span><br><span class="hljs-comment">                    if (p.hash == hash &amp;&amp;</span><br><span class="hljs-comment">                        ((k = p.key) == key || (key != null &amp;&amp; key.equals(k))))</span><br><span class="hljs-comment">                        e = p;</span><br><span class="hljs-comment">                    //再判断 p 是不是一颗红黑树,</span><br><span class="hljs-comment">                    //如果是一颗红黑树，就调用 putTreeVal , 来进行添加</span><br><span class="hljs-comment">                    else if (p instanceof TreeNode)</span><br><span class="hljs-comment">                        e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value);</span><br><span class="hljs-comment">                    else &#123;//如果table对应索引位置，已经是一个链表, 就使用for循环比较</span><br><span class="hljs-comment">                          //(1) 依次和该链表的每一个元素比较后，都不相同, 则加入到该链表的最后</span><br><span class="hljs-comment">                          //    注意在把元素添加到链表后，立即判断 该链表是否已经达到8个结点</span><br><span class="hljs-comment">                          //    , 就调用 treeifyBin() 对当前这个链表进行树化(转成红黑树)</span><br><span class="hljs-comment">                          //    注意，在转成红黑树时，要进行判断, 判断条件</span><br><span class="hljs-comment">                          //    if (tab == null || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY(64))</span><br><span class="hljs-comment">                          //            resize();</span><br><span class="hljs-comment">                          //    如果上面条件成立，先table扩容.</span><br><span class="hljs-comment">                          //    只有上面条件不成立时，才进行转成红黑树</span><br><span class="hljs-comment">                          //(2) 依次和该链表的每一个元素比较过程中，如果有相同情况,就直接break</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                        for (int binCount = 0; ; ++binCount) &#123;</span><br><span class="hljs-comment">                            if ((e = p.next) == null) &#123;</span><br><span class="hljs-comment">                                p.next = newNode(hash, key, value, null);</span><br><span class="hljs-comment">                                if (binCount &gt;= TREEIFY_THRESHOLD(8) - 1) // -1 for 1st</span><br><span class="hljs-comment">                                    treeifyBin(tab, hash);</span><br><span class="hljs-comment">                                break;</span><br><span class="hljs-comment">                            &#125;</span><br><span class="hljs-comment">                            if (e.hash == hash &amp;&amp;</span><br><span class="hljs-comment">                                ((k = e.key) == key || (key != null &amp;&amp; key.equals(k))))</span><br><span class="hljs-comment">                                break;</span><br><span class="hljs-comment">                            p = e;</span><br><span class="hljs-comment">                        &#125;</span><br><span class="hljs-comment">                    &#125;</span><br><span class="hljs-comment">                    if (e != null) &#123; // existing mapping for key</span><br><span class="hljs-comment">                        V oldValue = e.value;</span><br><span class="hljs-comment">                        if (!onlyIfAbsent || oldValue == null)</span><br><span class="hljs-comment">                            e.value = value;</span><br><span class="hljs-comment">                        afterNodeAccess(e);</span><br><span class="hljs-comment">                        return oldValue;</span><br><span class="hljs-comment">                    &#125;</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment">                ++modCount;</span><br><span class="hljs-comment">                //size 就是我们每加入一个结点Node(k,v,h,next), size++</span><br><span class="hljs-comment">                if (++size &gt; threshold)</span><br><span class="hljs-comment">                    resize();//扩容</span><br><span class="hljs-comment">                afterNodeInsertion(evict);</span><br><span class="hljs-comment">                return null;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">         */</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>可以看到，不仅打印顺序和插入顺序不一样，也不能添加重复元素</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230170356772.png" alt="image-20231230170356772"></p><p>看到没有进来了，也就是说hashset底层的hash函数是利用了我们的key的hashcode()函数的，这里可以思考一下为什么重写了equals还要重写hashcode();</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span>(<span class="hljs-built_in">Object</span> <span class="hljs-built_in">key</span>) &#123;<br>      <span class="hljs-type">int</span> h;<br>      <span class="hljs-title function_">return</span> (<span class="hljs-built_in">key</span> == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = <span class="hljs-built_in">key</span>.<span class="hljs-property">hashCode</span>()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>  &#125;<br></code></pre></td></tr></table></figure><p>这里无符号右移16位，主要是为了防止冲突，让不同的key得到不同的hash值，避免碰撞<br>看到了吗，key&#x3D;null的时候返回0，这也就可以解释为什么你往set里面添加null元素的时候，你再遍历，输出的第一个值就是null，即null放在第一个位置</p><p>现在我们来拆解putVal方法</p><p>table是一个Node&lt;K,V&gt;类型的数组</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">transient <span class="hljs-keyword">Node</span><span class="hljs-title">&lt;K</span>,V&gt;[] table;<br></code></pre></td></tr></table></figure><p>他如果table为空数组，就先扩容</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-keyword">if</span> ((<span class="hljs-literal">tab</span> = table) == <span class="hljs-literal">null</span> || (n = <span class="hljs-literal">tab</span>.<span class="hljs-built_in">length</span>) == <span class="hljs-number">0</span>)<br>           n = (<span class="hljs-literal">tab</span> = <span class="hljs-built_in">resize</span>()).<span class="hljs-built_in">length</span>;<br><br></code></pre></td></tr></table></figure><p>接下来进入resize函数</p><p>先把table赋值给一个oldTab,然后计算这个oldTab的大小关系</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">Node</span><span class="hljs-title">&lt;K</span>,V&gt;[] oldTab = table;<br>       int oldCap = (oldTab == null) ? <span class="hljs-number">0</span> : oldTab.length;<br><br></code></pre></td></tr></table></figure><p>当我们第一次扩容，oldCap&#x3D;0，执行下面的代码</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">else</span> &#123;               <span class="hljs-comment">// zero initial threshold signifies using defaults</span><br>          <span class="hljs-keyword">new</span><span class="hljs-type">Cap</span> = DEFAULT_INITIAL_CAPACITY;<br>          <span class="hljs-keyword">new</span><span class="hljs-type">Thr</span> = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);<br>      &#125;<br><br></code></pre></td></tr></table></figure><p>newCap表示新开辟的数组空间<br>newThr是临界值，表示下一次数组里面的容量达到了这么多之后就要进行扩容了，初始容量16的时候，用来12个空间我们就要扩容了<br>加载因子 DEFAULT_LOAD_FACTOR是为了在空间利用率和哈希冲突之间平衡的一个参数</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> DEFAULT_INITIAL_CAPACITY = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>; <span class="hljs-comment">// aka 16</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> DEFAULT_LOAD_FACTOR = <span class="hljs-number">0.75f</span>;<br><br></code></pre></td></tr></table></figure><p>至于16为什么写成1&lt;&lt;4,有注释，提醒我们数组大小必须是2的n次方</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * The default initial capacity - MUST be a power of two.</span><br><span class="hljs-comment">     */</span><br><br></code></pre></td></tr></table></figure><p>然后根据newCap初始化一个newTab并赋值给table</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">Node</span><span class="hljs-title">&lt;K</span>,V&gt;[] newTab = (<span class="hljs-keyword">Node</span><span class="hljs-title">&lt;K</span>,V&gt;[])new <span class="hljs-keyword">Node</span><span class="hljs-title">[newCap</span>];<br>       table = newTab;<br><br></code></pre></td></tr></table></figure><p>接下来扩容之后，根据key计算出来的hash值来计算新的节点在tab中的索引，并把这个位置的对象赋值给辅助变量p<br>如果p为null，说明这个位置还没有存放过元素，就根据key,value创建一个node放在这个位置,为甚要把hash也存进去？因为将来要进行比较</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-keyword">if</span> ((p = <span class="hljs-literal">tab</span>[i = (n - <span class="hljs-number">1</span>) &amp; <span class="hljs-built_in">hash</span>]) == <span class="hljs-literal">null</span>)<br>            <span class="hljs-literal">tab</span>[i] = newNode(<span class="hljs-built_in">hash</span>, key, value, <span class="hljs-literal">null</span>);<br><br></code></pre></td></tr></table></figure><p>++modCount代表修改了一次</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++</span><span class="hljs-comment">modCount;</span><br><br></code></pre></td></tr></table></figure><p>下面这个方法在hashMap里面是空的，没有作用，只是为了让HashMap的子类比如LinkedHashMap去实现</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-built_in">void</span> <span class="hljs-title function_">afterNodeInsertion</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> evict</span>) &#123; &#125;<br><br></code></pre></td></tr></table></figure><p>最后的return null其实是代表添加成功</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230171357882.png" alt="image-20231230171357882"></p><p>如下是hashSet的add方法，当putVal方法返回空，add会返回true</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-built_in">add</span>(E e) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">map</span>.<span class="hljs-property">put</span>(e, PRESENT)==<span class="hljs-literal">null</span>;<br>  &#125;<br><br><br></code></pre></td></tr></table></figure><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs maxima">public V <span class="hljs-built_in">put</span>(K <span class="hljs-built_in">key</span>, V value) &#123;<br>        <span class="hljs-built_in">return</span> putVal(hash(<span class="hljs-built_in">key</span>), <span class="hljs-built_in">key</span>, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230171413515.png" alt="image-20231230171413515"></p><p>对于添加两个相同元素的情况，如此下代码，直接执行 e.value &#x3D; value;即保留key，覆盖value，并把就得value值返回。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// existing mapping for key</span><br>              <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> e.value;<br>              <span class="hljs-keyword">if</span> (!onlyIfAbsent || oldValue == <span class="hljs-literal">null</span>)<br>                  e.value = value;<br>              afterNodeAccess(e);<br>              <span class="hljs-keyword">return</span> oldValue;<br>          &#125;<br><br></code></pre></td></tr></table></figure><p>下面这段代码是当判断到新插入的元素产生哈希冲突后，遍历该数组位置上的链表，如果在链表上有重复元素，就停止加入，如果走到链表的尾部都还没有重复元素，就把新插入的元素挂载到链表的尾部，</p><p>而且可以看出，jdk1.8对于链表用的是尾插法</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs lisp">for (<span class="hljs-name">int</span> binCount = <span class="hljs-number">0</span><span class="hljs-comment">; ; ++binCount) &#123;</span><br>                   if ((<span class="hljs-name">e</span> = p.next) == null) &#123;<br>                       p.next = newNode(<span class="hljs-name">hash</span>, key, value, null)<span class="hljs-comment">;</span><br>                       if (<span class="hljs-name">binCount</span> &gt;= TREEIFY_THRESHOLD - <span class="hljs-number">1</span>) // <span class="hljs-number">-1</span> for <span class="hljs-number">1</span>st<br>                           treeifyBin(<span class="hljs-name">tab</span>, hash)<span class="hljs-comment">;</span><br>                       break<span class="hljs-comment">;</span><br>                   &#125;<br>                   if (<span class="hljs-name">e</span>.hash == hash <span class="hljs-symbol">&amp;&amp;</span><br>                       ((<span class="hljs-name">k</span> = e.key) == key || (<span class="hljs-name">key</span> != null <span class="hljs-symbol">&amp;&amp;</span> key.equals(<span class="hljs-name">k</span>))))<br>                       break<span class="hljs-comment">;</span><br>                   p = e<span class="hljs-comment">;</span><br>               &#125;<br><br></code></pre></td></tr></table></figure><p>如果添加元素之后，链表的节点数大于等于了（8个）TREEIFY_THRESHOLD - 1，就把当前这个链表转化成红黑树转成红黑树时会判断，如果节点数小于64，不会进行树化，而是扩容）</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-keyword">if</span> (<span class="hljs-literal">tab</span> == <span class="hljs-literal">null</span> || (n = <span class="hljs-literal">tab</span>.<span class="hljs-built_in">length</span>) &lt; MIN_TREEIFY_CAPACITY)<br>           <span class="hljs-built_in">resize</span>();<br><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230171438902.png" alt="image-20231230171438902"></p><p>测试链表转红黑树,自定义类，重写hashcode函数，返回一个固定值就可以了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.set_;<br><br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Objects;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashSetIncrement</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        HashSet底层是HashMap, 第一次添加时，table 数组扩容到 16，</span><br><span class="hljs-comment">        临界值(threshold)是 16*加载因子(loadFactor)是0.75 = 12</span><br><span class="hljs-comment">        如果table 数组使用到了临界值 12,就会扩容到 16 * 2 = 32,</span><br><span class="hljs-comment">        新的临界值就是 32*0.75 = 24, 依次类推</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">HashSet</span> <span class="hljs-variable">hashSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br><span class="hljs-comment">//        for(int i = 1; i &lt;= 100; i++) &#123;</span><br><span class="hljs-comment">//            hashSet.add(i);//1,2,3,4,5...100</span><br><span class="hljs-comment">//        &#125;</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        在Java8中, 如果一条链表的元素个数到达 TREEIFY_THRESHOLD(默认是 8 )，</span><br><span class="hljs-comment">        并且table的大小 &gt;= MIN_TREEIFY_CAPACITY(默认64),就会进行树化(红黑树),</span><br><span class="hljs-comment">        否则仍然采用数组扩容机制</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br><br><span class="hljs-comment">//        for(int i = 1; i &lt;= 12; i++) &#123;</span><br><span class="hljs-comment">//            hashSet.add(new A(i));//</span><br><span class="hljs-comment">//        &#125;</span><br><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            当我们向hashset增加一个元素，-&gt; Node -&gt; 加入table , 就算是增加了一个size++</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">7</span>; i++) &#123;<span class="hljs-comment">//在table的某一条链表上添加了 7个A对象</span><br>            hashSet.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">A</span>(i));<span class="hljs-comment">//</span><br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">7</span>; i++) &#123;<span class="hljs-comment">//在table的另外一条链表上添加了 7个B对象</span><br>            hashSet.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">B</span>(i));<span class="hljs-comment">//</span><br>        &#125;<br><br><br><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> n;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">B</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>        <span class="hljs-built_in">this</span>.n = n;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">200</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> n;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">A</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>        <span class="hljs-built_in">this</span>.n = n;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>对于下面这段代码，首先Hashmap会扩容到16，一直插入元素的时候，会形成一条链表，因为它们的hash值相同。当链表长度等于8的时候，因为数组长度没有达到64，所以不会转化为红黑树，会执行扩容，现在数组的长度是32，接着插入元素的时候，链表的长度又达到了8个还是会继续扩容，阔刀64之后，转化成红黑树</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">12</span>; i++) &#123;<br>         hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> A(i));<span class="hljs-comment">//</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>扩容之后，原来的元素会移动位置的，扩容之后，再插入的元素的计算hash的n就又改变了，所以不会挂载在同一根链表上面了</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230171514207.png" alt="image-20231230171514207"></p><p><strong>问题：假设元素达到12个就会扩容嘛，那么这个12是指的是table表的空间还是说要加上链表上面的节点呢？</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230171522437.png" alt="image-20231230171522437"></p><p>我们来看源码</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss">++modCount;<br>       if (++size &gt; threshold)<br>           <span class="hljs-attribute">resize</span>();<br><br></code></pre></td></tr></table></figure><p>加入一个元素的时候，不管是加载table表的某一个位置还是说table表的某一条链表上，都会执行size++</p><p>验证</p><p>就是下面这段代码，先加的7个A在一条链表上面，那么，我们在加入B的时候，加到5个的时候，链表就会扩容了，A B的hashcode不一样是为了把它们放到不同的链表上面。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">7</span>; i++) &#123;<span class="hljs-comment">//在table的某一条链表上添加了 7个A对象</span><br>           hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> A(i));<span class="hljs-comment">//</span><br>       &#125;<br><br>       <span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">7</span>; i++)   &#123;<span class="hljs-comment">//在table的另外一条链表上添加了 7个B对象</span><br>           hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> B(i));<span class="hljs-comment">//</span><br>       &#125;<br><br></code></pre></td></tr></table></figure><h3 id="LinkedHashSet介绍"><a href="#LinkedHashSet介绍" class="headerlink" title="LinkedHashSet介绍"></a>LinkedHashSet介绍</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230193133516.png" alt="image-20231230193133516"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230193527354.png" alt="image-20231230193527354"></p><h3 id="LinkedHashSet源码分析"><a href="#LinkedHashSet源码分析" class="headerlink" title="LinkedHashSet源码分析"></a>LinkedHashSet源码分析</h3><p>LinkedHashSet底层是LinkedHashMap，数组+双向链表<br>LinkedHashMaps是HashMap的子类<br>hashMap的table存放的是Node,而LinkedHashMap的table存放的是Entry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;E&gt;<br>    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashSet</span>&lt;E&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Set</span>&lt;E&gt;, Cloneable, java.io.Serializable &#123;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;K,V&gt;<br>    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>&lt;K,V&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>&lt;K,V&gt;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>.Node&lt;K,V&gt; &#123;<br>    Entry&lt;K,V&gt; before, after;<br>    Entry(<span class="hljs-type">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;<br>        <span class="hljs-built_in">super</span>(hash, key, value, next);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.set_;<br><br><span class="hljs-keyword">import</span> java.util.LinkedHashSet;<br><span class="hljs-keyword">import</span> java.util.Set;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedHashSetSource</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//分析一下LinkedHashSet的底层机制</span><br>        <span class="hljs-type">Set</span> <span class="hljs-variable">set</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>();<br>        set.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;AA&quot;</span>));<br>        set.add(<span class="hljs-number">456</span>);<br>        set.add(<span class="hljs-number">456</span>);<br>        set.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(<span class="hljs-string">&quot;刘&quot;</span>, <span class="hljs-number">1001</span>));<br>        set.add(<span class="hljs-number">123</span>);<br>        set.add(<span class="hljs-string">&quot;HSP&quot;</span>);<br><br>        System.out.println(<span class="hljs-string">&quot;set=&quot;</span> + set);<br>        <span class="hljs-comment">//老韩解读</span><br>        <span class="hljs-comment">//1. LinkedHashSet 加入顺序和取出元素/数据的顺序一致</span><br>        <span class="hljs-comment">//2. LinkedHashSet 底层维护的是一个LinkedHashMap(是HashMap的子类)</span><br>        <span class="hljs-comment">//3. LinkedHashSet 底层结构 (数组table+双向链表)</span><br>        <span class="hljs-comment">//4. 添加第一次时，直接将 数组table 扩容到 16 ,存放的结点类型是 LinkedHashMap$Entry</span><br>        <span class="hljs-comment">//5. 数组是 HashMap$Node[] 存放的元素/数据是 LinkedHashMap$Entry类型</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">                //继承关系是在内部类完成.</span><br><span class="hljs-comment">                static class Entry&lt;K,V&gt; extends HashMap.Node&lt;K,V&gt; &#123;</span><br><span class="hljs-comment">                    Entry&lt;K,V&gt; before, after;</span><br><span class="hljs-comment">                    Entry(int hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="hljs-comment">                        super(hash, key, value, next);</span><br><span class="hljs-comment">                    &#125;</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br><br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> no;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Customer</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> no)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.no = no;<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><h3 id="Map接口的特点"><a href="#Map接口的特点" class="headerlink" title="Map接口的特点"></a>Map接口的特点</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230194028794.png" alt="image-20231230194028794"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.map_;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Map_</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//老韩解读Map 接口实现类的特点, 使用实现类HashMap</span><br>        <span class="hljs-comment">//1. Map与Collection并列存在。用于保存具有映射关系的数据:Key-Value(双列元素)</span><br>        <span class="hljs-comment">//2. Map 中的 key 和  value 可以是任何引用类型的数据，会封装到HashMap$Node 对象中</span><br>        <span class="hljs-comment">//3. Map 中的 key 不允许重复，原因和HashSet 一样，前面分析过源码.</span><br>        <span class="hljs-comment">//4. Map 中的 value 可以重复</span><br>        <span class="hljs-comment">//5. Map 的key 可以为 null, value 也可以为null ，注意 key 为null,</span><br>        <span class="hljs-comment">//   只能有一个，value 为null ,可以多个</span><br>        <span class="hljs-comment">//6. 常用String类作为Map的 key</span><br>        <span class="hljs-comment">//7. key 和 value 之间存在单向一对一关系，即通过指定的 key 总能找到对应的 value</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;no1&quot;</span>, <span class="hljs-string">&quot;韩顺平&quot;</span>);<span class="hljs-comment">//k-v</span><br>        map.put(<span class="hljs-string">&quot;no2&quot;</span>, <span class="hljs-string">&quot;张无忌&quot;</span>);<span class="hljs-comment">//k-v</span><br>        map.put(<span class="hljs-string">&quot;no1&quot;</span>, <span class="hljs-string">&quot;张三丰&quot;</span>);<span class="hljs-comment">//当有相同的k , 就等价于替换.</span><br>        map.put(<span class="hljs-string">&quot;no3&quot;</span>, <span class="hljs-string">&quot;张三丰&quot;</span>);<span class="hljs-comment">//k-v</span><br>        map.put(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>); <span class="hljs-comment">//k-v</span><br>        map.put(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;abc&quot;</span>); <span class="hljs-comment">//等价替换</span><br>        map.put(<span class="hljs-string">&quot;no4&quot;</span>, <span class="hljs-literal">null</span>); <span class="hljs-comment">//k-v</span><br>        map.put(<span class="hljs-string">&quot;no5&quot;</span>, <span class="hljs-literal">null</span>); <span class="hljs-comment">//k-v</span><br>        map.put(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;赵敏&quot;</span>);<span class="hljs-comment">//k-v</span><br>        map.put(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(), <span class="hljs-string">&quot;金毛狮王&quot;</span>);<span class="hljs-comment">//k-v</span><br>        <span class="hljs-comment">// 通过get 方法，传入 key ,会返回对应的value</span><br>        System.out.println(map.get(<span class="hljs-string">&quot;no2&quot;</span>));<span class="hljs-comment">//张无忌</span><br>        System.out.println(<span class="hljs-string">&quot;map=&quot;</span> + map);<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230194432345.png" alt="image-20231230194432345"></p><p>虽然null是第二个打印出来的，但是从debug可以看出，key为null时是存在索引为0的位置的</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230194128768.png" alt="image-20231230194128768"></p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs arcade">final Node&lt;K,V&gt; getNode(int <span class="hljs-built_in">hash</span>, Object key) &#123;<br>        Node&lt;K,V&gt;[] <span class="hljs-literal">tab</span>; Node&lt;K,V&gt; <span class="hljs-built_in">first</span>, e; int n; K k;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-literal">tab</span> = table) != <span class="hljs-literal">null</span> &amp;&amp; (n = <span class="hljs-literal">tab</span>.<span class="hljs-built_in">length</span>) &gt; <span class="hljs-number">0</span> &amp;&amp;<br>            (<span class="hljs-built_in">first</span> = <span class="hljs-literal">tab</span>[(n - <span class="hljs-number">1</span>) &amp; <span class="hljs-built_in">hash</span>]) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">first</span>.<span class="hljs-built_in">hash</span> == <span class="hljs-built_in">hash</span> &amp;&amp; <span class="hljs-comment">// always check first node</span><br>                ((k = <span class="hljs-built_in">first</span>.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.<span class="hljs-built_in">equals</span>(k))))<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">first</span>;<br>            <span class="hljs-keyword">if</span> ((e = <span class="hljs-built_in">first</span>.next) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">first</span> instanceof TreeNode)<br>                    <span class="hljs-keyword">return</span> ((TreeNode&lt;K,V&gt;)<span class="hljs-built_in">first</span>).getTreeNode(<span class="hljs-built_in">hash</span>, key);<br>                <span class="hljs-keyword">do</span> &#123;<br>                    <span class="hljs-keyword">if</span> (e.<span class="hljs-built_in">hash</span> == <span class="hljs-built_in">hash</span> &amp;&amp;<br>                        ((k = e.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.<span class="hljs-built_in">equals</span>(k))))<br>                        <span class="hljs-keyword">return</span> e;<br>                &#125; <span class="hljs-keyword">while</span> ((e = e.next) != <span class="hljs-literal">null</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>我们来看看根据key获取value的过程</p><p>首先会获取key的hash值，根据这个hash值获取key所在的索引，然后根据这个索引值找到该索引下的第一个节点，判断该节点是否是我们要找的节点，如果是，就返回该节点，如果不是，再判断该节点处是否形成了红黑树，如果是，就根据红黑树的查找方法，如果不是，就再判断是否形成链表，是就遍历链表的节点，依次匹配，如果最终没有找到匹配的节点，就返回null</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    Node&lt;K,V&gt; e;<br>    <span class="hljs-keyword">return</span> (e = getNode(hash(key), key)) == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : e.value;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Map接口方法"><a href="#Map接口方法" class="headerlink" title="Map接口方法"></a>Map接口方法</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230194553530.png" alt="image-20231230194553530"></p><h3 id="Map的六大遍历方式"><a href="#Map的六大遍历方式" class="headerlink" title="Map的六大遍历方式"></a>Map的六大遍历方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.map_;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapFor</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;邓超&quot;</span>, <span class="hljs-string">&quot;孙俪&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;王宝强&quot;</span>, <span class="hljs-string">&quot;马蓉&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;宋喆&quot;</span>, <span class="hljs-string">&quot;马蓉&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;刘令博&quot;</span>, <span class="hljs-literal">null</span>);<br>        map.put(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;刘亦菲&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;鹿晗&quot;</span>, <span class="hljs-string">&quot;关晓彤&quot;</span>);<br><br>        <span class="hljs-comment">//第一组: 先取出 所有的Key , 通过Key 取出对应的Value</span><br>        <span class="hljs-type">Set</span> <span class="hljs-variable">keyset</span> <span class="hljs-operator">=</span> map.keySet();<br>        <span class="hljs-comment">//(1) 增强for</span><br>        System.out.println(<span class="hljs-string">&quot;-----第一种方式-------&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Object key : keyset) &#123;<br>            System.out.println(key + <span class="hljs-string">&quot;-&quot;</span> + map.get(key));<br>        &#125;<br>        <span class="hljs-comment">//(2) 迭代器</span><br>        System.out.println(<span class="hljs-string">&quot;----第二种方式--------&quot;</span>);<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">iterator</span> <span class="hljs-operator">=</span> keyset.iterator();<br>        <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span>  iterator.next();<br>            System.out.println(key + <span class="hljs-string">&quot;-&quot;</span> + map.get(key));<br>        &#125;<br><br>        <span class="hljs-comment">//第二组: 把所有的values取出</span><br>        <span class="hljs-type">Collection</span> <span class="hljs-variable">values</span> <span class="hljs-operator">=</span> map.values();<br>        <span class="hljs-comment">//这里可以使用所有的Collections使用的遍历方法</span><br>        <span class="hljs-comment">//(1) 增强for</span><br>        System.out.println(<span class="hljs-string">&quot;---取出所有的value 增强for----&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Object value : values) &#123;<br>            System.out.println(value);<br>        &#125;<br>        <span class="hljs-comment">//(2) 迭代器</span><br>        System.out.println(<span class="hljs-string">&quot;---取出所有的value 迭代器----&quot;</span>);<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">iterator2</span> <span class="hljs-operator">=</span> values.iterator();<br>        <span class="hljs-keyword">while</span> (iterator2.hasNext()) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span>  iterator2.next();<br>            System.out.println(value);<br><br>        &#125;<br><br>        <span class="hljs-comment">//第三组: 通过EntrySet 来获取 k-v</span><br>        <span class="hljs-type">Set</span> <span class="hljs-variable">entrySet</span> <span class="hljs-operator">=</span> map.entrySet();<span class="hljs-comment">// EntrySet&lt;Map.Entry&lt;K,V&gt;&gt;</span><br>        <span class="hljs-comment">//(1) 增强for</span><br>        System.out.println(<span class="hljs-string">&quot;----使用EntrySet 的 for增强(第3种)----&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Object entry : entrySet) &#123;<br>            <span class="hljs-comment">//将entry 转成 Map.Entry</span><br>            Map.<span class="hljs-type">Entry</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> (Map.Entry) entry;<br>            System.out.println(m.getKey() + <span class="hljs-string">&quot;-&quot;</span> + m.getValue());<br>        &#125;<br>        <span class="hljs-comment">//(2) 迭代器</span><br>        System.out.println(<span class="hljs-string">&quot;----使用EntrySet 的 迭代器(第4种)----&quot;</span>);<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">iterator3</span> <span class="hljs-operator">=</span> entrySet.iterator();<br>        <span class="hljs-keyword">while</span> (iterator3.hasNext()) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span>  iterator3.next();<br>            <span class="hljs-comment">//System.out.println(next.getClass());//HashMap$Node -实现-&gt; Map.Entry (getKey,getValue)</span><br>            <span class="hljs-comment">//向下转型 Map.Entry</span><br>            Map.<span class="hljs-type">Entry</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> (Map.Entry) entry;<br>            System.out.println(m.getKey() + <span class="hljs-string">&quot;-&quot;</span> + m.getValue());<br>        &#125;<br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="HashMap阶段小结"><a href="#HashMap阶段小结" class="headerlink" title="HashMap阶段小结"></a>HashMap阶段小结</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230200930869.png" alt="image-20231230200930869"></p><h3 id="HashMap底层机制"><a href="#HashMap底层机制" class="headerlink" title="HashMap底层机制"></a>HashMap底层机制</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230201053483.png" alt="image-20231230201053483"></p><h3 id="HashMap扩容与树化触发"><a href="#HashMap扩容与树化触发" class="headerlink" title="HashMap扩容与树化触发"></a>HashMap扩容与树化触发</h3><h4 id="树化"><a href="#树化" class="headerlink" title="树化"></a>树化</h4><p>这里存的同一个A对象</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashMapSource2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br><br><br>        <span class="hljs-title class_">HashMap</span> hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-keyword">for</span>(int i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">12</span>; i++) &#123;<br>            hashMap.<span class="hljs-title function_">put</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>(i), <span class="hljs-string">&quot;hello&quot;</span>);<br>        &#125;<br><br>        hashMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;bbb&quot;</span>);<br><br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;hashMap=&quot;</span> + hashMap);<span class="hljs-comment">//12个 k-v</span><br><br>        <span class="hljs-comment">//布置一个任务，自己设计代码去验证，table 的扩容</span><br>        <span class="hljs-comment">//0 -&gt; 16(12) -&gt; 32(24) -&gt; 64(64*0.75=48)-&gt; 128 (96) -&gt;</span><br>        <span class="hljs-comment">//自己设计程序，验证-》 增强自己阅读源码能力. 看别人代码.</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>  &#123;<br>    <span class="hljs-keyword">private</span> int num;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">A</span>(<span class="hljs-params">int num</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = num;<br>    &#125;<br><br>    <span class="hljs-comment">//所有的A对象的hashCode都是100</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> int <span class="hljs-title function_">hashCode</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">toString</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\nA&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;num=&quot;</span> + num +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>可以看到现在i已经加到8了，底层的table有7个元素（因为i对应的8还没有执行第8次添加元素）</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230201849422.png" alt="image-20231230201849422"></p><p>这是底层的排列情况，一条长度为7的链表</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230201859607.png" alt="image-20231230201859607"></p><p>现在我们再执行第8次添加</p><p>容量是15，链表的长度是8</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230201914232.png" alt="image-20231230201914232"></p><p>继续添加</p><p>由于链表长度到达了8，在添加第9个节点的时候，判断应该进行转化为红黑树，但是由于table中总的节点数没有达到64，所以只是进行了扩容，没有转化为红黑树，且此时链表的长度为9，</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202015703.png" alt="image-20231230202015703"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202022139.png" alt="image-20231230202022139"></p><p>继续添加第10个节点，数组容量依然没有达到64（此时是32），所以不会转化成红黑树，将会继续扩容（扩容到64），此时链表长度为10</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202032934.png" alt="image-20231230202032934"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202039415.png" alt="image-20231230202039415"></p><p>当添加第11个节点的时候，由于数组容量已经达到了64，所以会转化成红黑树，不再继续扩容</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202050471.png" alt="image-20231230202050471"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202057888.png" alt="image-20231230202057888"></p><p>注意扩容后会影响元素的索引位置，因为hash值重新计算了</p><h4 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> hspCollection.map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by 此生辽阔 on 2021/7/25 10:06</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Objects;<br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashMapSource2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        Random r=<span class="hljs-keyword">new</span>  <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">12</span>; i++) &#123;<br>            hashMap.put(r.nextInt(<span class="hljs-number">100</span>), <span class="hljs-string">&quot;hello&quot;</span>);<br>        &#125;<br>        hashMap.put(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;bbb&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;hashMap=&quot;</span> + hashMap);<span class="hljs-comment">//12个 k-v</span><br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202227917.png" alt="image-20231230202227917"></p><p>断点打在 hashMap.put(“aaa”, “bbb”);执行完结果如上图，现在还没有扩容，且节点数量刚好达到12各个，现在执行 hashMap.put(“aaa”, “bbb”);</p><p>执行了扩容，且影响了原来元素的位置排列</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202247391.png" alt="image-20231230202247391"></p><h3 id="HashTable使用"><a href="#HashTable使用" class="headerlink" title="HashTable使用"></a>HashTable使用</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202302200.png" alt="image-20231230202302200"></p><p>&#x2F;&#x2F;简单说明一下Hashtable的底层<br>&#x2F;&#x2F;1. 底层有数组 Hashtable$Entry[] 初始化大小为 11<br>&#x2F;&#x2F;2. 临界值 threshold 8 &#x3D; 11 * 0.75<br>&#x2F;&#x2F;3. 扩容: 按照自己的扩容机制来进行即可.<br>&#x2F;&#x2F;4. 执行 方法 addEntry(hash, key, value, index); 添加K-V 封装到Entry<br>&#x2F;&#x2F;5. 当 if (count &gt;&#x3D; threshold) 满足时，就进行扩容<br>&#x2F;&#x2F;6. 按照 int newCapacity &#x3D; (oldCapacity &lt;&lt; 1) + 1; 的大小扩容.（2倍加1）</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202331863.png" alt="image-20231230202331863"></p><h3 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h3><p>properties是hashtable的子类，所以间接地实现了Map接口</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202349905.png" alt="image-20231230202349905"></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Properties_</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> &#123;<br><br>        <span class="hljs-comment">//老韩解读</span><br>        <span class="hljs-comment">//1. Properties 继承  Hashtable</span><br>        <span class="hljs-comment">//2. 可以通过 k-v 存放数据，当然key 和 value 不能为 null</span><br>        <span class="hljs-comment">//增加</span><br>        Properties properties = <span class="hljs-keyword">new</span> Properties();<br>        <span class="hljs-comment">//properties.put(null, &quot;abc&quot;);//抛出 空指针异常</span><br>        <span class="hljs-comment">//properties.put(&quot;abc&quot;, null); //抛出 空指针异常</span><br>        properties.put(<span class="hljs-string">&quot;john&quot;</span>, <span class="hljs-number">100</span>);<span class="hljs-comment">//k-v</span><br>        properties.put(<span class="hljs-string">&quot;lucy&quot;</span>, <span class="hljs-number">100</span>);<br>        properties.put(<span class="hljs-string">&quot;lic&quot;</span>, <span class="hljs-number">100</span>);<br>        properties.put(<span class="hljs-string">&quot;lic&quot;</span>, <span class="hljs-number">88</span>);<span class="hljs-comment">//如果有相同的key ， value被替换</span><br><br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;properties=&quot;</span> + properties);<br><br>        <span class="hljs-comment">//通过k 获取对应值</span><br>        System.<span class="hljs-keyword">out</span>.println(properties.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;lic&quot;</span>));<span class="hljs-comment">//88</span><br><br>        <span class="hljs-comment">//删除</span><br>        properties.<span class="hljs-keyword">remove</span>(<span class="hljs-string">&quot;lic&quot;</span>);<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;properties=&quot;</span> + properties);<br><br>        <span class="hljs-comment">//修改</span><br>        properties.put(<span class="hljs-string">&quot;john&quot;</span>, <span class="hljs-string">&quot;约翰&quot;</span>);<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;properties=&quot;</span> + properties);      <br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><h3 id="集合选型规则"><a href="#集合选型规则" class="headerlink" title="集合选型规则"></a>集合选型规则</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202417527.png" alt="image-20231230202417527"></p><h3 id="TreeSet源码解读"><a href="#TreeSet源码解读" class="headerlink" title="TreeSet源码解读"></a>TreeSet源码解读</h3><p>TreeSet实现了Set接口，与HashSet最大的区别是可以排序</p><p>在向TreeSet添加元素时，如果不指定比较器，那么会将Key强制转化为比较器比较，因此key必须实现Comparable接口，不然无法添加元素</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">treesettEST</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> &#123;<br>        TreeSet&lt;Object&gt; treeSet = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;();<br>        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> person(<span class="hljs-number">2</span>));<br>        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> person(<span class="hljs-number">3</span>));<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title">person</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> i;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">person</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> i</span>)</span> &#123;<br>        <span class="hljs-keyword">this</span>.i = i;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202510188.png" alt="image-20231230202510188"></p><p>TreeSet底层是TreeMap,TreeMap有一个属性是comparator</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202518853.png" alt="image-20231230202518853"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.set_;<br><br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.TreeSet;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeSet_</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">//老韩解读</span><br>        <span class="hljs-comment">//1. 当我们使用无参构造器，创建TreeSet时，仍然是无序的</span><br>        <span class="hljs-comment">//2. 老师希望添加的元素，按照字符串大小来排序</span><br>        <span class="hljs-comment">//3. 使用TreeSet 提供的一个构造器，可以传入一个比较器(匿名内部类)</span><br>        <span class="hljs-comment">//   并指定排序规则</span><br>        <span class="hljs-comment">//4. 简单看看源码</span><br>        <span class="hljs-comment">//老韩解读</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        1. 构造器把传入的比较器对象，赋给了 TreeSet的底层的 TreeMap的属性this.comparator</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         public TreeMap(Comparator&lt;? super K&gt; comparator) &#123;</span><br><span class="hljs-comment">                this.comparator = comparator;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">         2. 在 调用 treeSet.add(&quot;tom&quot;), 在底层会执行到</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">             if (cpr != null) &#123;//cpr 就是我们的匿名内部类(对象)</span><br><span class="hljs-comment">                do &#123;</span><br><span class="hljs-comment">                    parent = t;</span><br><span class="hljs-comment">                    //动态绑定到我们的匿名内部类(对象)compare</span><br><span class="hljs-comment">                    cmp = cpr.compare(key, t.key);</span><br><span class="hljs-comment">                    if (cmp &lt; 0)</span><br><span class="hljs-comment">                        t = t.left;</span><br><span class="hljs-comment">                    else if (cmp &gt; 0)</span><br><span class="hljs-comment">                        t = t.right;</span><br><span class="hljs-comment">                    else //如果相等，即返回0,这个Key就没有加入</span><br><span class="hljs-comment">                        return t.setValue(value);</span><br><span class="hljs-comment">                &#125; while (t != null);</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">         */</span><br><span class="hljs-comment">//        TreeSet treeSet = new TreeSet();</span><br>        <span class="hljs-type">TreeSet</span> <span class="hljs-variable">treeSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Comparator</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Object o1, Object o2)</span> &#123;<br>                <span class="hljs-comment">//下面 调用String的 compareTo方法进行字符串大小比较</span><br>                <span class="hljs-comment">//如果老韩要求加入的元素，按照长度大小排序</span><br>                <span class="hljs-comment">//return ((String) o2).compareTo((String) o1);</span><br>                <span class="hljs-keyword">return</span> ((String) o1).length() - ((String) o2).length();<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">//添加数据.</span><br>        treeSet.add(<span class="hljs-string">&quot;jack&quot;</span>);<br>        treeSet.add(<span class="hljs-string">&quot;tom&quot;</span>);<span class="hljs-comment">//3</span><br>        treeSet.add(<span class="hljs-string">&quot;sp&quot;</span>);<br>        treeSet.add(<span class="hljs-string">&quot;a&quot;</span>);<br>        treeSet.add(<span class="hljs-string">&quot;abc&quot;</span>);<span class="hljs-comment">//3</span><br>        System.out.println(<span class="hljs-string">&quot;treeSet=&quot;</span> + treeSet);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="TreeMap源码解读"><a href="#TreeMap源码解读" class="headerlink" title="TreeMap源码解读"></a>TreeMap源码解读</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.map_;<br><br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.TreeMap;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeMap_</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">//使用默认的构造器，创建TreeMap, 是无序的(也没有排序)</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            老韩要求：按照传入的 k(String) 的大小进行排序</span><br><span class="hljs-comment">         */</span><br><span class="hljs-comment">//        TreeMap treeMap = new TreeMap();</span><br>        <span class="hljs-type">TreeMap</span> <span class="hljs-variable">treeMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Comparator</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Object o1, Object o2)</span> &#123;<br>                <span class="hljs-comment">//按照传入的 k(String) 的大小进行排序</span><br>                <span class="hljs-comment">//按照K(String) 的长度大小排序</span><br>                <span class="hljs-comment">//return ((String) o2).compareTo((String) o1);</span><br>                <span class="hljs-keyword">return</span> ((String) o2).length() - ((String) o1).length();<br>            &#125;<br>        &#125;);<br>        treeMap.put(<span class="hljs-string">&quot;jack&quot;</span>, <span class="hljs-string">&quot;杰克&quot;</span>);<br>        treeMap.put(<span class="hljs-string">&quot;tom&quot;</span>, <span class="hljs-string">&quot;汤姆&quot;</span>);<br>        treeMap.put(<span class="hljs-string">&quot;kristina&quot;</span>, <span class="hljs-string">&quot;克瑞斯提诺&quot;</span>);<br>        treeMap.put(<span class="hljs-string">&quot;smith&quot;</span>, <span class="hljs-string">&quot;斯密斯&quot;</span>);<br>        treeMap.put(<span class="hljs-string">&quot;hsp&quot;</span>, <span class="hljs-string">&quot;韩顺平&quot;</span>);<span class="hljs-comment">//加入不了</span><br><br>        System.out.println(<span class="hljs-string">&quot;treemap=&quot;</span> + treeMap);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">            老韩解读源码：</span><br><span class="hljs-comment">            1. 构造器. 把传入的实现了 Comparator接口的匿名内部类(对象)，传给给TreeMap的comparator</span><br><span class="hljs-comment">             public TreeMap(Comparator&lt;? super K&gt; comparator) &#123;</span><br><span class="hljs-comment">                this.comparator = comparator;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">            2. 调用put方法</span><br><span class="hljs-comment">            2.1 第一次添加, 把k-v 封装到 Entry对象，放入root</span><br><span class="hljs-comment">            Entry&lt;K,V&gt; t = root;</span><br><span class="hljs-comment">            if (t == null) &#123;</span><br><span class="hljs-comment">                compare(key, key); // type (and possibly null) check</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                root = new Entry&lt;&gt;(key, value, null);</span><br><span class="hljs-comment">                size = 1;</span><br><span class="hljs-comment">                modCount++;</span><br><span class="hljs-comment">                return null;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">            2.2 以后添加</span><br><span class="hljs-comment">            Comparator&lt;? super K&gt; cpr = comparator;</span><br><span class="hljs-comment">            if (cpr != null) &#123;</span><br><span class="hljs-comment">                do &#123; //遍历所有的key , 给当前key找到适当位置</span><br><span class="hljs-comment">                    parent = t;</span><br><span class="hljs-comment">                    cmp = cpr.compare(key, t.key);//动态绑定到我们的匿名内部类的compare</span><br><span class="hljs-comment">                    if (cmp &lt; 0)</span><br><span class="hljs-comment">                        t = t.left;</span><br><span class="hljs-comment">                    else if (cmp &gt; 0)</span><br><span class="hljs-comment">                        t = t.right;</span><br><span class="hljs-comment">                    else  //如果遍历过程中，发现准备添加Key 和当前已有的Key 相等，就不添加</span><br><span class="hljs-comment">                        return t.setValue(value);</span><br><span class="hljs-comment">                &#125; while (t != null);</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">         */</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="Collections工具类"><a href="#Collections工具类" class="headerlink" title="Collections工具类"></a>Collections工具类</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202911582.png" alt="image-20231230202911582"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230202917340.png" alt="image-20231230202917340"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hspedu.collections_;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 韩顺平</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Collections_</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">//创建ArrayList 集合，用于测试.</span><br>        <span class="hljs-type">List</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        list.add(<span class="hljs-string">&quot;tom&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;smith&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;king&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;milan&quot;</span>);<br>        list.add(<span class="hljs-string">&quot;tom&quot;</span>);<br><br><br><span class="hljs-comment">//        reverse(List)：反转 List 中元素的顺序</span><br>        Collections.reverse(list);<br>        System.out.println(<span class="hljs-string">&quot;list=&quot;</span> + list);<br><span class="hljs-comment">//        shuffle(List)：对 List 集合元素进行随机排序</span><br><span class="hljs-comment">//        for (int i = 0; i &lt; 5; i++) &#123;</span><br><span class="hljs-comment">//            Collections.shuffle(list);</span><br><span class="hljs-comment">//            System.out.println(&quot;list=&quot; + list);</span><br><span class="hljs-comment">//        &#125;</span><br><br><span class="hljs-comment">//        sort(List)：根据元素的自然顺序对指定 List 集合元素按升序排序</span><br>        Collections.sort(list);<br>        System.out.println(<span class="hljs-string">&quot;自然排序后&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;list=&quot;</span> + list);<br><span class="hljs-comment">//        sort(List，Comparator)：根据指定的 Comparator 产生的顺序对 List 集合元素进行排序</span><br>        <span class="hljs-comment">//我们希望按照 字符串的长度大小排序</span><br>        Collections.sort(list, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Comparator</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Object o1, Object o2)</span> &#123;<br>                <span class="hljs-comment">//可以加入校验代码.</span><br>                <span class="hljs-keyword">return</span> ((String) o2).length() - ((String) o1).length();<br>            &#125;<br>        &#125;);<br>        System.out.println(<span class="hljs-string">&quot;字符串长度大小排序=&quot;</span> + list);<br><span class="hljs-comment">//        swap(List，int， int)：将指定 list 集合中的 i 处元素和 j 处元素进行交换</span><br><br>        <span class="hljs-comment">//比如</span><br>        Collections.swap(list, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>        System.out.println(<span class="hljs-string">&quot;交换后的情况&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;list=&quot;</span> + list);<br><br>        <span class="hljs-comment">//Object max(Collection)：根据元素的自然顺序，返回给定集合中的最大元素</span><br>        System.out.println(<span class="hljs-string">&quot;自然顺序最大元素=&quot;</span> + Collections.max(list));<br>        <span class="hljs-comment">//Object max(Collection，Comparator)：根据 Comparator 指定的顺序，返回给定集合中的最大元素</span><br>        <span class="hljs-comment">//比如，我们要返回长度最大的元素</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">maxObject</span> <span class="hljs-operator">=</span> Collections.max(list, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Comparator</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Object o1, Object o2)</span> &#123;<br>                <span class="hljs-keyword">return</span> ((String)o1).length() - ((String)o2).length();<br>            &#125;<br>        &#125;);<br>        System.out.println(<span class="hljs-string">&quot;长度最大的元素=&quot;</span> + maxObject);<br><br><br>        <span class="hljs-comment">//Object min(Collection)</span><br>        <span class="hljs-comment">//Object min(Collection，Comparator)</span><br>        <span class="hljs-comment">//上面的两个方法，参考max即可</span><br><br>        <span class="hljs-comment">//int frequency(Collection，Object)：返回指定集合中指定元素的出现次数</span><br>        System.out.println(<span class="hljs-string">&quot;tom出现的次数=&quot;</span> + Collections.frequency(list, <span class="hljs-string">&quot;tom&quot;</span>));<br><br>        <span class="hljs-comment">//void copy(List dest,List src)：将src中的内容复制到dest中</span><br><br>        <span class="hljs-type">ArrayList</span> <span class="hljs-variable">dest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-comment">//为了完成一个完整拷贝，我们需要先给dest 赋值，大小和list.size()一样</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; list.size(); i++) &#123;<br>            dest.add(<span class="hljs-string">&quot;&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//拷贝</span><br>        Collections.copy(dest, list);<br>        System.out.println(<span class="hljs-string">&quot;dest=&quot;</span> + dest);<br><br>        <span class="hljs-comment">//boolean replaceAll(List list，Object oldVal，Object newVal)：使用新值替换 List 对象的所有旧值</span><br>        <span class="hljs-comment">//如果list中，有tom 就替换成 汤姆</span><br>        Collections.replaceAll(list, <span class="hljs-string">&quot;tom&quot;</span>, <span class="hljs-string">&quot;汤姆&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;list替换后=&quot;</span> + list);        <br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>集合</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学成在线项目优化模块</title>
    <link href="/2023/12/29/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96%E6%A8%A1%E5%9D%97/"/>
    <url>/2023/12/29/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="项目优化模块"><a href="#项目优化模块" class="headerlink" title="项目优化模块"></a>项目优化模块</h2><h3 id="优化需求"><a href="#优化需求" class="headerlink" title="优化需求"></a><strong>优化需求</strong></h3><p>视频播放页面用户未登录也可以访问，当用户观看试学课程时需要请求服务端查询数据，接口如下：</p><p>1、根据课程id查询课程信息。</p><p>2、根据文件id查询视频信息。</p><p>这些接口在用户未认证状态下也可以访问，如果接口的性能不高，当高并发到来很可能耗尽整个系统的资源，将整个系统压垮，所以特别需要对这些暴露在外边的接口进行优化。</p><p>下边对 根据课程id查询课程信息 接口进行优化，下边的内容将此接口简称为  课程查询接口。</p><p>接口地址：<a href="http://www.51xuecheng.cn/open/content/course/whole/%7BcourseId%7D">http://www.51xuecheng.cn/open/content/course/whole/{courseId}</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228204715093.png" alt="image-20231228204715093"></p><h3 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a><strong>压力测试</strong></h3><h4 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h4><p>对接口进行优化之前需要对接口进行压力测试，不仅接口需要压力测试，整个微服务在发布前也是需要经历压力测试的，因为压力测试可以暴漏功能测试所发现不了的问题。</p><p>功能测试即是对系统的功能按用户需求进行测试，比如：添加一门课程，根据需求文档先准备测试数据，再通过前端界面将一门课程添加到系统，测试是否可以操作成功。整个过程就是测试软件是否可以实现用户的需求。</p><p>压力测试是通过测试工具制造大规模的并发请求去访问系统，测试系统是否经受住压力。</p><p>比如：一个在线学习网站，上线要求该网站可以支持1万用户同时在线，此时就需要模拟1万并发请求去访问网站的关键业务流程，比如：测试点播学习流程，测试系统是否可以抗住1万并发请求。</p><p>一些功能测试时无法发现的问题在压力测试时就会发现，比如：内存泄露、线程安全、IO异常等问题。</p><p>压力测试常用的性能指标如下：</p><p>1、吞吐量</p><p>吞吐量是系统每秒可以处理的事务数，也称为TPS（Transaction Per Second）。</p><p>比如：一次点播流程，从请求进入系统到视频画图显示出来这整个流程就是一次事务。</p><p>所以吞吐量并不是一次数据库事务，它是完成一次业务的整体流程。</p><p>2、响应时间</p><p>响应时间是指客户端请求服务端，从请求进入系统到客户端拿到响应结果所经历的时间。响应时间包括：最大响应时间、最小响应时间、平均响应时间。</p><p>3、每秒查询数</p><p>每秒查询数即QPS（Queries-per-second），它是衡量查询接口的性能指标，比如：商品信息查询， 一秒可以请求该接口查询商品信息的次数就是QPS。</p><p>拿查询接口举例，一次查询请求内部不会再去请求其它接口，此时 QPS&#x3D;TPS</p><p>如果一次查询请求内容需要远程调用另一个接口查询数据，此时 QPS&#x3D;2 * TPS</p><p>4、错误率</p><p>错误率 是一批请求发生错误的请求占全部请求的比例。</p><p>不同的指标其要求不同，比如现在进行接口优化，优化后的接口响应时间应该越来越小，吞吐量越来越大，以及QPS值也是越大越好，错误率要保持在一个很小的范围。</p><p>另外除了关注这些性能指标以外还要关注系统的负载情况：</p><p>1、CPU使用率，不高于85%</p><p>2、内存利用率，不高于 85%</p><p>3、网络利用率，不高于 80%</p><p>4、磁盘IO</p><p>磁盘IO的性能指标是IOPS (Input&#x2F;Output Per Second)即每秒的输入输出量(或读写次数)。</p><p>如果过大说明IO操作密集，IO过大也会影响性能指标。</p><h4 id="安装Jmeter"><a href="#安装Jmeter" class="headerlink" title="安装Jmeter"></a>安装Jmeter</h4><p>Apache JMeter 是 Apache 组织基于 Java 开发的压力测试工具，用于对软件做压力测试。</p><p>下载Jmeter</p><p><a href="https://jmeter.apache.org/download_jmeter.cgi">https://jmeter.apache.org/download_jmeter.cgi</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228205501023.png" alt="image-20231228205501023"></p><p>下载，解压，进入bin目录修改jmeter.properties，设置中文和字体</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Java<br><span class="hljs-attribute">language</span>=zh_CN<br>jmeter.hidpi.<span class="hljs-attribute">mode</span>=<span class="hljs-literal">true</span><br>jmeter.hidpi.scale.<span class="hljs-attribute">factor</span>=1.8<br>jsyntaxtextarea.font.family= Hack<br>jsyntaxtextarea.font.<span class="hljs-attribute">size</span>=25<br>jmeter.toolbar.icons.<span class="hljs-attribute">size</span>=32x32<br>jmeter.tree.icons.<span class="hljs-attribute">size</span>=24x24<br><br></code></pre></td></tr></table></figure><p>双击运行bin目录下的jmeter.bat文件。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228205521713.png" alt="image-20231228205521713"></p><p>界面如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228205527355.png" alt="image-20231228205527355"></p><h4 id="压力测试-1"><a href="#压力测试-1" class="headerlink" title="压力测试"></a>压力测试</h4><p>样本数：200个线程，每个线程请求100次，共20000次</p><p>压力机：通常压力机是单独的客户端。</p><p>测试gateway+content</p><p>吞吐量180左右</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/clip_image002.gif" alt="img"></p><p>测试content</p><p>吞吐量300左右</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/clip_image004.gif" alt="img"></p><h3 id="优化日志"><a href="#优化日志" class="headerlink" title="优化日志"></a>优化日志</h3><p>内容管理日志级别改为info级别.</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228205641848.png" alt="image-20231228205641848"></p><p>单独请求内容管理测试，吞吐量达到1500左右</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228205648750.png" alt="image-20231228205648750"></p><h3 id="缓存优化"><a href="#缓存优化" class="headerlink" title="缓存优化"></a><strong>缓存优化</strong></h3><h4 id="redis缓存"><a href="#redis缓存" class="headerlink" title="redis缓存"></a>redis缓存</h4><p>测试用例根据id查询课程信息，这里不存在复杂的SQL，也没有数据库链接不释放的问题，暂时不考虑数据库优化</p><p>课程发布信息的特点是<code>查询较多，修改很少</code>，这里考虑课程发布信息进行缓存，课程信息缓存的流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228224233684.png" alt="image-20231228224233684"></p><p>在nacos配置redis-dev.yaml（group&#x3D;xuecheng-plus-common）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">Java</span><br><span class="hljs-attr">spring:</span> <br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">10</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">10000</span><br><br></code></pre></td></tr></table></figure><p>在content-api微服务加载redis-dev.yaml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml">Java<br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>定义查询缓存接口：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 查询缓存中的课程信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.xuecheng.content.model.po.CoursePublish</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/22 16:15</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-function">CoursePublish <span class="hljs-title">getCoursePublishCache</span><span class="hljs-params">(Long courseId)</span></span>;<br><br></code></pre></td></tr></table></figure><p>接口实现如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">public</span> CoursePublish getCoursePublishCache(<span class="hljs-built_in">Long</span> courseId)&#123;<br>    <span class="hljs-comment">//查询缓存</span><br>   Object  jsonObj = redisTemplate.opsForValue().<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;course:&quot;</span> + courseId);<br>    <span class="hljs-keyword">if</span>(jsonObj!=<span class="hljs-literal">null</span>)&#123;<br>    String jsonString = jsonObj.toString();<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;=================从缓存查=================&quot;</span>);<br>        CoursePublish coursePublish = JSON.parseObject(jsonString, CoursePublish.<span class="hljs-keyword">class</span>);<br>        <span class="hljs-keyword">return</span> coursePublish;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;从数据库查询...&quot;</span>);<br>        <span class="hljs-comment">//从数据库查询</span><br>        CoursePublish coursePublish = getCoursePublish(courseId);<br>        <span class="hljs-keyword">if</span>(coursePublish!=<span class="hljs-literal">null</span>)&#123;<br>            redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(<span class="hljs-string">&quot;course:&quot;</span> + courseId, JSON.toJSONString(coursePublish));<br>        &#125;<br>        <span class="hljs-keyword">return</span> coursePublish;<br>    &#125;<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>修改controller接口调用代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@ApiOperation(&quot;获取课程发布信息&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@GetMapping(&quot;/course/whole/&#123;courseId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> CoursePreviewDto <span class="hljs-title function_">getCoursePublish</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;<br>        <span class="hljs-comment">//查询课程发布信息</span><br>        <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> coursePublishService.getCoursePublishCache(courseId);<br><span class="hljs-comment">//        CoursePublish coursePublish = coursePublishService.getCoursePublish(courseId);</span><br>        <span class="hljs-keyword">if</span>(coursePublish==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePreviewDto</span>();<br>        &#125;<br><br>        <span class="hljs-comment">//课程基本信息</span><br>        <span class="hljs-type">CourseBaseInfoDto</span> <span class="hljs-variable">courseBase</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseBaseInfoDto</span>();<br>        BeanUtils.copyProperties(coursePublish, courseBase);<br>        <span class="hljs-comment">//课程计划</span><br>        List&lt;TeachplanDto&gt; teachplans = JSON.parseArray(coursePublish.getTeachplan(), TeachplanDto.class);<br>        <span class="hljs-type">CoursePreviewDto</span> <span class="hljs-variable">coursePreviewInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePreviewDto</span>();<br>        coursePreviewInfo.setCourseBase(courseBase);<br>        coursePreviewInfo.setTeachplans(teachplans);<br>        <span class="hljs-keyword">return</span> coursePreviewInfo;<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>重新测试请求内容管理服务课程查询接口。</p><p>吞吐量达到2700左右，增加了近一倍。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231229102953824.png" alt="image-20231229102953824"></p><h4 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h4><h5 id="什么是缓存穿透"><a href="#什么是缓存穿透" class="headerlink" title="什么是缓存穿透"></a><strong>什么是缓存穿透</strong></h5><p>使用缓存后代码性能有了很大的提高，虽然性能有很大的提高但是控制台打出很多从数据库查询的日志，明明判断了如果缓存存在课程信息则从缓存查询，为什么要有这么多从数据库查询的请求的？</p><p>这是因为并发数高，很多线程会同时到达查询数据库代码处去执行</p><p>我们分析下代码：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231229111243200.png" alt="image-20231229111243200"></p><p>如果存在恶意攻击的可能，如果有大量并发去查询一个不存在的课程信息会出现什么问题呢？</p><p>比如去请求&#x2F;content&#x2F;course&#x2F;whole&#x2F;181，查询181号课程，该课程并不在课程发布表中。</p><p>进行压力测试发现会去请求数据库。</p><p>大量并发去访问一个数据库不存在的数据，由于缓存中没有该数据导致大量并发查询数据库，这个现象叫缓存穿透。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231229111345629.png" alt="image-20231229111345629"></p><p>缓存穿透可以造成数据库瞬间压力过大，连接数等资源用完，最终数据库拒绝连接不可用。</p><h5 id="解决缓存穿透"><a href="#解决缓存穿透" class="headerlink" title="解决缓存穿透"></a>解决缓存穿透</h5><p>如何解决缓存穿透？</p><ol><li>对请求增加校验机制</li></ol><p>比如：课程ID是长整型，如果发来的不是长整型则直接返回</p><ol start="2"><li>使用布隆过滤器</li></ol><p>什么是布隆过滤器，以下摘自百度百科：</p><p>布隆过滤器可以用于检索一个元素是否在一个集合中。如果想要判断一个元素是不是在一个集合里，一般想到的是将所有元素保存起来，然后通过比较确定。<a href="https://baike.baidu.com/item/%E9%93%BE%E8%A1%A8/9794473?fromModule=lemma_inlink">链表</a>，树等等数据结构都是这种思路. 但是随着集合中元素的增加，我们需要的存储空间越来越大，<a href="https://baike.baidu.com/item/%E6%A3%80%E7%B4%A2%E9%80%9F%E5%BA%A6/20807841?fromModule=lemma_inlink">检索速度</a>也越来越慢(O(n),O(logn))。不过世界上还有一种叫作散列表（又叫<a href="https://baike.baidu.com/item/%E5%93%88%E5%B8%8C%E8%A1%A8/5981869?fromModule=lemma_inlink">哈希表</a>，Hash table）的数据结构。它可以通过一个Hash函数将一个元素映射成一个位阵列（Bit array）中的一个点。这样一来，我们只要看看这个点是不是1就可以知道集合中有没有它了。这就是布隆过滤器的基本思想。</p><p>布隆过滤器的特点是，高效地插入和查询，占用空间少；查询结果有不确定性，如果查询结果是存在则元素不一定存在，如果不存在则一定不存在；另外它只能添加元素不能删除元素，因为删除元素会增加误判率。</p><p>比如：将商品id写入布隆过滤器，如果分3次hash此时在布隆过滤器有3个点，当从布隆过滤器查询该商品id，通过hash找到了该商品id在过滤器中的点，此时返回1，如果找不到一定会返回0。</p><p>所以，为了避免缓存穿透我们需要缓存预热将要查询的课程或商品信息的id提前存入布隆过滤器，添加数据时将信息的id也存入过滤器，当去查询一个数据时先在布隆过滤器中找一下如果没有到到就说明不存在，此时直接返回。</p><p>实现方法有：</p><p>Google工具包Guava实现。</p><p>redisson 。</p><p>2、缓存空值或特殊值</p><p>请求通过了第一步的校验，查询数据库得到的数据不存在，此时我们仍然去缓存数据，缓存一个空值或一个特殊值的数据，下一次查这个数据就走缓存了。</p><p>但是要注意：如果缓存了空值或特殊值要设置一个短暂的过期时间。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CoursePublish getCoursePublishCache(<span class="hljs-built_in">Long</span> courseId) &#123;<br>    <span class="hljs-comment">//查询缓存</span><br>    Object jsonObject = redisTemplate.opsForValue().<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;course:&quot;</span> + courseId);<br>    <span class="hljs-keyword">if</span> (jsonObject!=<span class="hljs-literal">null</span>)&#123;<span class="hljs-comment">//查到了缓存</span><br>        String jsonStr = jsonObject.toString();<br>        <span class="hljs-keyword">if</span> (jsonStr.equals(<span class="hljs-string">&quot;null&quot;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;=================从缓存查=================&quot;</span>);<br>        CoursePublish coursePublish = JSON.parseObject(jsonStr, CoursePublish.<span class="hljs-keyword">class</span>);<br>        <span class="hljs-keyword">return</span> coursePublish;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;从数据库查询...&quot;</span>);<br>        <span class="hljs-comment">//从数据库查询</span><br>        CoursePublish coursePublish = getCoursePublish(courseId);<br>        <span class="hljs-comment">//if (coursePublish!=null)&#123;//存入缓存</span><br>        redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(<span class="hljs-string">&quot;course:&quot;</span>+courseId, JSON.toJSONString(coursePublish),<span class="hljs-number">30</span>, TimeUnit.SECONDS);<br>        <span class="hljs-comment">//&#125;</span><br>        <span class="hljs-keyword">return</span> coursePublish;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>再测试，虽然还存在个别请求去查询数据库，但不是所有请求都去查询数据库，基本上都命中缓存。</p><h4 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h4><h5 id="什么是缓存雪崩"><a href="#什么是缓存雪崩" class="headerlink" title="什么是缓存雪崩"></a><strong>什么是缓存雪崩</strong></h5><p>缓存雪崩是缓存中大量key失效后当高并发到来时导致大量请求到数据库，瞬间耗尽数据库资源，导致数据库无法使用</p><p>造成缓存雪崩问题的原因是大量key拥有相同的过期时间，比如对课程信息设置缓存过期时间10分钟，在大量请求同时查询大量课程信息时，此时有大量的课程有相同的过期时间，一旦失效将同时失效，造成雪崩问题</p><h5 id="解决缓存雪崩问题"><a href="#解决缓存雪崩问题" class="headerlink" title="解决缓存雪崩问题"></a>解决缓存雪崩问题</h5><p>如何解决缓存雪崩问题？</p><ol><li>使用同步锁控制查询数据库的线程</li></ol><p>使用同步锁控制查询数据库的线程，只允许一个线程去查询数据库，查询得到的数据存入缓存</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Java<br><span class="hljs-function"><span class="hljs-title">synchronized</span><span class="hljs-params">(obj)</span></span>&#123;<br>  <span class="hljs-comment">//查询数据库</span><br>  <span class="hljs-comment">//存入缓存</span><br>&#125;<br><br></code></pre></td></tr></table></figure><ol start="2"><li>对同一类型信息的key设置不同的过期时间</li></ol><p>通常对一类信息的key设置过期时间是相同的，这里可以在原有固定时间的基础上加上一个随机时间使他们的过期时间不同</p><p>示例代码如下：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss">Java<br>   <span class="hljs-comment">//设置过期时间300秒</span><br>  redisTemplate<span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(&quot;course:&quot; + courseId, JSON.toJSONString(coursePublish),<span class="hljs-number">300</span>+new <span class="hljs-built_in">Random</span>()<span class="hljs-selector-class">.nextInt</span>(<span class="hljs-number">100</span>), TimeUnit<span class="hljs-selector-class">.SECONDS</span>);<br><br></code></pre></td></tr></table></figure><ol start="3"><li>缓存预热</li></ol><p>不用等到请求到来再去查询数据库加入缓存，可以提前将数据加入缓存，使用缓存预热机制通常有专门的后台程序将数据库的数据同步到缓存</p><h4 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a><strong>缓存击穿</strong></h4><h5 id="什么是缓存击穿"><a href="#什么是缓存击穿" class="headerlink" title="什么是缓存击穿"></a>什么是缓存击穿</h5><p>大量并发访问同一个热点数据，当热点数据失效后同时去请求数据库，瞬间耗尽数据库资源，导致数据库无法使用</p><p>比如某手机新品发布，当缓存失效时有大量并发到来导致同时去访问数据库。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231229113418275.png" alt="image-20231229113418275"></p><h5 id="解决缓存击穿"><a href="#解决缓存击穿" class="headerlink" title="解决缓存击穿"></a>解决缓存击穿</h5><ol><li>使用同步锁控制查询数据库的线程</li></ol><p>使用同步锁控制查询数据库的代码，只允许有一个线程去查询数据库，查询得到数据存入缓存</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Java<br><span class="hljs-function"><span class="hljs-title">synchronized</span><span class="hljs-params">(obj)</span></span>&#123;<br>  <span class="hljs-comment">//查询数据库</span><br>  <span class="hljs-comment">//存入缓存</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>2、热点数据不过期</p><p>可以由后台程序提前将热点数据加入缓存，缓存过期时间不过期，由后台程序做好缓存同步。</p><p>下边使用synchronized对代码加锁。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">public</span>  CoursePublish getCoursePublishCache(<span class="hljs-built_in">Long</span> courseId)&#123;<br>    synchronized(<span class="hljs-keyword">this</span>)&#123;<br>        <span class="hljs-comment">//查询缓存</span><br>        String jsonString = (String) redisTemplate.opsForValue().<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;course:&quot;</span> + courseId);<br>        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(jsonString))&#123;<br>            <span class="hljs-keyword">if</span>(jsonString.equals(<span class="hljs-string">&quot;null&quot;</span>))<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            CoursePublish coursePublish = JSON.parseObject(jsonString, CoursePublish.<span class="hljs-keyword">class</span>);<br>            <span class="hljs-keyword">return</span> coursePublish;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;=========从数据库查询==========&quot;</span>);<br>            <span class="hljs-comment">//从数据库查询</span><br>            CoursePublish coursePublish = getCoursePublish(courseId);<br>           <span class="hljs-comment">//设置过期时间300秒</span><br>        redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(<span class="hljs-string">&quot;course:&quot;</span> + courseId, JSON.toJSONString(coursePublish),<span class="hljs-number">300</span>, TimeUnit.SECONDS);<br>            <span class="hljs-keyword">return</span> coursePublish;<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>测试，吞吐量有1300左右</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231229113710823.png" alt="image-20231229113710823"></p><p>对上边的代码进行优化，对查询缓存的代码不用synchronized加锁控制，只对查询数据库进行加锁，如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">public</span>  CoursePublish getCoursePublishCache(<span class="hljs-built_in">Long</span> courseId)&#123;<br><br>        <span class="hljs-comment">//查询缓存</span><br>         Object  jsonObj = redisTemplate.opsForValue().<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;course:&quot;</span> + courseId);<br>         <span class="hljs-keyword">if</span>(jsonObj!=<span class="hljs-literal">null</span>)&#123;<br>            String jsonString = jsonObj.toString();<br>            CoursePublish coursePublish = JSON.parseObject(jsonString, CoursePublish.<span class="hljs-keyword">class</span>);<br>            <span class="hljs-keyword">return</span> coursePublish;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            synchronized(<span class="hljs-keyword">this</span>)&#123;<br>                Object  jsonObj = redisTemplate.opsForValue().<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;course:&quot;</span> + courseId);<br>                <span class="hljs-keyword">if</span>(jsonObj!=<span class="hljs-literal">null</span>)&#123;<br>                   String jsonString = jsonObj.toString();<br>                    CoursePublish coursePublish = JSON.parseObject(jsonString, CoursePublish.<span class="hljs-keyword">class</span>);<br>                    <span class="hljs-keyword">return</span> coursePublish;<br>                &#125;<br>                 System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;=========从数据库查询==========&quot;</span>);<br>                <span class="hljs-comment">//从数据库查询</span><br>                CoursePublish coursePublish = getCoursePublish(courseId);<br>              <span class="hljs-comment">//设置过期时间300秒</span><br>                redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(<span class="hljs-string">&quot;course:&quot;</span> + courseId, JSON.toJSONString(coursePublish),<span class="hljs-number">300</span>, TimeUnit.SECONDS);<br>                <span class="hljs-keyword">return</span> coursePublish;<br>            &#125;<br>        &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>测试，查询数据库只发生一次，整个测试过程的吞吐量在3800左右。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231229113800399.png" alt="image-20231229113800399"></p><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>1）缓存穿透：</p><p>去访问一个数据库不存在的数据无法将数据进行缓存，导致查询数据库，当并发较大就会对数据库造成压力。缓存穿透可以造成数据库瞬间压力过大，连接数等资源用完，最终数据库拒绝连接不可用。</p><p>解决的方法：</p><p>缓存一个null值。</p><p>使用布隆过滤器。</p><p>2）缓存雪崩：</p><p>缓存中大量key失效后当高并发到来时导致大量请求到数据库，瞬间耗尽数据库资源，导致数据库无法使用。</p><p>造成缓存雪崩问题的原因是是大量key拥有了相同的过期时间。</p><p>解决办法：</p><p>使用同步锁控制</p><p>对同一类型信息的key设置不同的过期时间，比如：使用固定数+随机数作为过期时间。</p><p>3）缓存击穿</p><p>大量并发访问同一个热点数据，当热点数据失效后同时去请求数据库，瞬间耗尽数据库资源，导致数据库无法使用。</p><p>解决办法：</p><p>使用同步锁控制</p><p>设置key永不过期</p><p>无中生有是穿透，布隆过滤null隔离。<br> 缓存击穿key过期， 锁与非期解难题。<br> 大量过期成雪崩，过期时间要随机。<br> 面试必考三兄弟，可用限流来保底。</p><p>限流技术方案：</p><p>alibaba&#x2F;Sentinel </p><p>nginx+Lua</p><h4 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a><strong>分布式锁</strong></h4><h5 id="本地锁的问题"><a href="#本地锁的问题" class="headerlink" title="本地锁的问题"></a>本地锁的问题</h5><p>上边的程序使用了同步锁解决了缓存击穿、缓存雪崩的问题，保证同一个key过期后只会查询一次数据库。</p><p>如果将同步锁的程序分布式部署在多个虚拟机上则无法保证同一个key只会查询一次数据库，如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231229113925808.png" alt="image-20231229113925808"></p><p>一个同步锁程序只能保证同一个虚拟机中多个线程只有一个线程去数据库，如果高并发通过网关负载均衡转发给各个虚拟机，此时就会存在多个线程去查询数据库情况，因为虚拟机中的锁只能保证该虚拟机自己的线程去同步执行，无法跨虚拟机保证同步执行。</p><p>我们将虚拟机内部的锁叫本地锁，本地锁只能保证所在虚拟机的线程同步执行。</p><p>下边进行测试：</p><p>启动三个内容管理服务：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231229113935734.png" alt="image-20231229113935734"></p><p>通过网关访问课程查询，网关通过负载均衡将请求转发给三个服务。</p><p>通过测试发现，有两个服务各有一次数据库查询，这说明本地锁无法跨虚拟机保证同步执行。</p><h5 id="什么是分布锁"><a href="#什么是分布锁" class="headerlink" title="什么是分布锁"></a><strong>什么是分布锁</strong></h5><p>本地锁只能控制所在虚拟机中的线程同步执行，现在要实现分布式环境下所有虚拟机中的线程去同步执行就需要让多个虚拟机去共用一个锁，虚拟机可以分布式部署，锁也可以分布式部署，如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231229113957008.png" alt="image-20231229113957008"></p><p>虚拟机都去抢占同一个锁，锁是一个单独的程序提供加锁、解锁服务，谁抢到锁谁去查询数据库。</p><p>该锁已不属于某个虚拟机，而是分布式部署，由多个虚拟机所共享，这种锁叫分布式锁。</p><h5 id="分布式锁的实现方案"><a href="#分布式锁的实现方案" class="headerlink" title="分布式锁的实现方案"></a><strong>分布式锁的实现方案</strong></h5><p>实现分布式锁的方案有很多，常用的如下：</p><p>1、基于数据库实现分布锁</p><p>利用数据库主键唯一性的特点，或利用数据库唯一索引的特点，多个线程同时去插入相同的记录，谁插入成功谁就抢到锁。</p><p>2、基于redis实现锁</p><p>redis提供了分布式锁的实现方案，比如：SETNX、set nx、redisson等。</p><p>拿SETNX举例说明，SETNX命令的工作过程是去set一个不存在的key，多个线程去设置同一个key只会有一个线程设置成功，设置成功的的线程拿到锁。</p><p>3、使用zookeeper实现</p><p>zookeeper是一个分布式协调服务，主要解决分布式程序之间的同步的问题。zookeeper的结构类似的文件目录，多线程向zookeeper创建一个子目录(节点)只会有一个创建成功，利用此特点可以实现分布式锁，谁创建该结点成功谁就获得锁。</p><h5 id="Redis-NX实现分布式锁"><a href="#Redis-NX实现分布式锁" class="headerlink" title="Redis NX实现分布式锁"></a><strong>Redis NX</strong>实现分布式锁</h5><p>redis实现分布式锁的方案可以在redis.cn网站查阅，地址<a href="http://www.redis.cn/commands/set.html">http://www.redis.cn/commands/set.html</a></p><p>使用命令： SET resource-name anystring NX EX max-lock-time 即可实现。</p><p>NX：表示key不存在才设置成功。</p><p>EX：设置过期时间</p><p>这里启动三个ssh客户端，连接redis: docker exec -it redis redis-cli</p><p>先认证: auth redis</p><p>同时向三个客户端发送测试命令如下：</p><p>表示设置lock001锁，value为001，过期时间为30秒</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Plain</span> Text<br><span class="hljs-attribute">SET</span> lock001 <span class="hljs-number">001</span> NX EX <span class="hljs-number">30</span><br></code></pre></td></tr></table></figure><p>命令发送成功，观察三个ssh客户端发现只有一个设置成功，其它两个设置失败，设置成功的请求表示抢到了lock001锁。</p><p>如何在代码中使用Set nx去实现分布锁呢？</p><p>使用spring-boot-starter-data-redis 提供的api即可实现set nx。</p><p>添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml">Java<br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>添加依赖后，在bean中注入restTemplate。</p><p>我们先分析一段伪代码如下：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">Java</span><br><span class="hljs-function"><span class="hljs-title">if</span>(缓存中有)&#123;</span><br><span class="hljs-function"></span><br><span class="hljs-function">  返回缓存中的数据</span><br><span class="hljs-function">&#125;<span class="hljs-variable"><span class="hljs-keyword">else</span></span>&#123;</span><br><span class="hljs-function"></span><br><span class="hljs-function">  获取分布式锁</span><br><span class="hljs-function">  <span class="hljs-title">if</span>(获取锁成功）&#123;</span><br><span class="hljs-function">       <span class="hljs-variable"><span class="hljs-keyword">try</span></span>&#123;</span><br><span class="hljs-function">         查询数据库</span><br><span class="hljs-function">      &#125;<span class="hljs-variable"><span class="hljs-keyword">finally</span></span>&#123;</span><br><span class="hljs-function">         释放锁</span><br><span class="hljs-function">      &#125;</span><br><span class="hljs-function">  &#125;</span><br><span class="hljs-function"> </span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function"></span><br></code></pre></td></tr></table></figure><p>1、获取分布式锁</p><p>使用redisTemplate.opsForValue().setIfAbsent(key,vaue)获取锁</p><p>这里考虑一个问题，当set nx一个key&#x2F;value成功1后，这个key(就是锁)需要设置过期时间吗？</p><p>如果不设置过期时间当获取到了锁却没有执行finally这个锁将会一直存在，其它线程无法获取这个锁。</p><p>所以执行set nx时要指定过期时间，即使用如下的命令</p><p>SET resource-name anystring NX EX max-lock-time</p><p>具体调用的方法是：redisTemplate.opsForValue().setIfAbsent(K var1, V var2, long var3, TimeUnit var5)</p><p>2、如何释放锁</p><p>释放锁分为两种情况：key到期自动释放，手动删除。</p><p>1）key到期自动释放的方法</p><p>因为锁设置了过期时间，key到期会自动释放，但是会存在一个问题就是 查询数据库等操作还没有执行完时key到期了，此时其它线程就抢到锁了，最终重复查询数据库执行了重复的业务操作。</p><p>怎么解决这个问题？</p><p>可以将key的到期时间设置的长一些，足以执行完成查询数据库并设置缓存等相关操作。</p><p>如果这样效率会低一些，另外这个时间值也不好把控。</p><p>2）手动删除锁</p><p>如果是采用手动删除锁可能和key到期自动删除有所冲突，造成删除了别人的锁。</p><p>比如：当查询数据库等业务还没有执行完时key过期了，此时其它线程占用了锁，当上一个线程执行查询数据库等业务操作完成后手动删除锁就把其它线程的锁给删除了。</p><p>要解决这个问题可以采用删除锁之前判断是不是自己设置的锁，伪代码如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs stylus">JavaScript<br><span class="hljs-function"><span class="hljs-title">if</span><span class="hljs-params">(缓存中有)</span></span>&#123;<br><br>  返回缓存中的数据<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><br>  获取分布式锁: set lock <span class="hljs-number">01</span> NX<br>  <span class="hljs-built_in">if</span>(获取锁成功）&#123;<br>       try&#123;<br>         查询数据库<br>      &#125;finally&#123;<br>         <span class="hljs-built_in">if</span>(redis<span class="hljs-selector-class">.call</span>(<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;lock&quot;</span>)==<span class="hljs-string">&quot;01&quot;</span>)&#123;<br>            释放锁: redis<span class="hljs-selector-class">.call</span>(<span class="hljs-string">&quot;del&quot;</span>,<span class="hljs-string">&quot;lock&quot;</span>)<br>         &#125;<br>         <br>      &#125;<br>  &#125;<br> <br>&#125;<br><br></code></pre></td></tr></table></figure><p>以上代码第11行到13行非原子性，也会导致删除其它线程的锁。</p><p>查看文档上的说明：<a href="http://www.redis.cn/commands/set.html">http://www.redis.cn/commands/set.html</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/clip_image002.gif" alt="img"></p><p>在调用setnx命令设置key&#x2F;value时，每个线程设置不一样的value值，这样当线程去删除锁时可以先根据key查询出来判断是不是自己当时设置的vlaue，如果是则删除。</p><p>这整个操作是原子的，实现方法就是去执行上边的lua脚本。</p><p><em>Lua</em> 是一个小巧的脚本语言，redis在2.6版本就支持通过执行Lua脚本保证多个命令的原子性。</p><p>什么是原子性？</p><p>这些指令要么全成功要么全失败。</p><p>以上就是使用Redis Nx方式实现分布式锁，为了避免删除别的线程设置的锁需要使用redis去执行Lua脚本的方式去实现，这样就具有原子性，但是过期时间的值设置不存在不精确的问题。</p><h5 id="Redisson实现分布式锁"><a href="#Redisson实现分布式锁" class="headerlink" title="Redisson实现分布式锁"></a><strong>Redisson实现分布式锁</strong></h5><h6 id="什么是Redisson"><a href="#什么是Redisson" class="headerlink" title="什么是Redisson"></a><strong>什么是Redisson</strong></h6><p>再查阅 文档<a href="http://www.redis.cn/commands/set.html">http://www.redis.cn/commands/set.html</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/clip_image002.gif" alt="img"></p><p>点击链接查看</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/clip_image004.gif" alt="img"></p><p>我们选用Java的实现方案 <a href="https://github.com/redisson/redisson">https://github.com/redisson/redisson</a></p><p>Redisson的文档地址：<a href="https://github.com/redisson/redisson/wiki/Table-of-Content">https://github.com/redisson/redisson/wiki/Table-of-Content</a></p><p>Redisson底层采用的是<a href="http://netty.io/">Netty</a> 框架。支持<a href="http://redis.cn/">Redis</a> 2.8以上版本，支持Java1.6+以上版本。Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish &#x2F; Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) 。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/clip_image006.gif" alt="img"></p><p>使用Redisson可以非常方便将Java本地内存中的常用数据结构的对象搬到分布式缓存redis中。</p><p>也可以将常用的并发编程工具如：AtomicLong、CountDownLatch、Semaphore等支持分布式。</p><p>使用RScheduledExecutorService 实现分布式调度服务。</p><p>支持数据分片，将数据分片存储到不同的redis实例中。</p><p>支持分布式锁，基于Java的Lock接口实现分布式锁，方便开发。</p><p>下边使用Redisson将Queue队列的数据存入Redis，实现一个排队及出队的接口。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/clip_image008.gif" alt="img"></p><p>添加redisson的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml">Java<br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.11.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>从课程资料目录拷贝singleServerConfig.yaml到config工程下</p><p>在redis配置文件中添加：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dts">Java<br><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">  redis:</span><br><span class="hljs-symbol">    redisson:</span><br>      <span class="hljs-meta">#配置文件目录</span><br><span class="hljs-symbol">      config:</span> classpath:singleServerConfig.yaml<br>      <span class="hljs-meta">#config: classpath:clusterServersConfig.yaml</span><br></code></pre></td></tr></table></figure><p>redis集群配置clusterServersConfig.yaml.</p><p>Redisson相比set nx实现分布式锁要简单的多，工作原理如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231229114440919.png" alt="image-20231229114440919"></p><p>•     <strong>加锁机制</strong></p><p>线程获取锁，获取成功，执行lua脚本，保存数据到redis数据库</p><p>线程获取锁，获取失败，while循环尝试获取锁，获取成功后，执行lua，保存数据到redis</p><p>•     <strong>WatchDog</strong>自动延期看门狗机制</p><p>第一种情况：在一个分布式环境下，假如一个线程获得锁后，突然服务器宕机了，那么这个时候在一定时间后这个锁会自动释放，你也可以设置锁的有效时间(当不设置默认30秒时），这样的目的主要是防止死锁的发生</p><p>第二种情况：线程A业务还没有执行完，时间就过了，线程A 还想持有锁的话，就会启动一个watch dog后台线程，不断的延长锁key的生存时间。</p><p>•     <strong>lua</strong>脚本保证原子性操作</p><p>主要是如果你的业务逻辑复杂的话，通过封装在lua脚本中发送给redis，而且redis是单线程的，这样就保证这段复杂业务逻辑执行的原子性</p><p>具体使用RLock操作分布锁，RLock继承JDK的Lock接口，所以他有Lock接口的所有特性，比如lock、unlock、trylock等特性,同时它还有很多新特性：强制锁释放，带有效期的锁,。</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">Java<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RRLock</span> </span>&#123;<br>    <br>   <span class="hljs-comment">//----------------------Lock接口方法-----------------------</span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加锁 锁的有效期默认30秒</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span></span>;<br>    <br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加锁 可以手动设置锁的有效时间</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> leaseTime 锁有效时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> unit      时间单位 小时、分、秒、毫秒等</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">(<span class="hljs-keyword">long</span> leaseTime, TimeUnit unit)</span></span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * tryLock()方法是有返回值的，用来尝试获取锁，</span><br><span class="hljs-comment">     * 如果获取成功，则返回true，如果获取失败（即锁已被其他线程获取），则返回false .</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span></span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * tryLock(long time, TimeUnit unit)方法和tryLock()方法是类似的，</span><br><span class="hljs-comment">     * 只不过区别在于这个方法在拿不到锁时会等待一定的时间，</span><br><span class="hljs-comment">     * 在时间期限之内如果还拿不到锁，就返回false。如果如果一开始拿到锁或者在等待期间内拿到了锁，则返回true。</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time 等待时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> unit 时间单位 小时、分、秒、毫秒等</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(<span class="hljs-keyword">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 比上面多一个参数，多添加一个锁的有效时间</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> waitTime  等待时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> leaseTime 锁有效时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> unit      时间单位 小时、分、秒、毫秒等</span><br><span class="hljs-comment">     * waitTime 大于 leaseTime</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(<span class="hljs-keyword">long</span> waitTime, <span class="hljs-keyword">long</span> leaseTime, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 解锁</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span></span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>**lock()**：</p><p>•     此方法为加锁，但是锁的有效期采用<strong>默认</strong>30秒</p><p>•     如果主线程未释放，且当前锁未调用unlock方法，则进入到<strong>watchDog</strong>机制</p><p>•     如果主线程未释放，且当前锁调用unlock方法，则直接释放锁</p><h6 id="分布式锁避免缓存击穿"><a href="#分布式锁避免缓存击穿" class="headerlink" title="分布式锁避免缓存击穿"></a><strong>分布式锁避免缓存击穿</strong></h6><p>下面使用分布式锁修改查询课程信息的接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Redisson 分布式锁</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CoursePublish <span class="hljs-title function_">getCoursePublishCache</span><span class="hljs-params">(Long courseId)</span> &#123;<br><br>    <span class="hljs-comment">//查询缓存</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">&quot;course:&quot;</span> + courseId);<br>    <span class="hljs-keyword">if</span> (jsonObject != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//查到了缓存</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> jsonObject.toString();<br>        <span class="hljs-keyword">if</span> (jsonStr.equals(<span class="hljs-string">&quot;null&quot;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        System.out.println(<span class="hljs-string">&quot;=================从缓存查=================&quot;</span>);<br>        <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonStr, CoursePublish.class);<br>        <span class="hljs-keyword">return</span> coursePublish;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//每门课程设置一个锁</span><br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;coursequerylock:&quot;</span> + courseId);<br>        <span class="hljs-comment">//获取锁</span><br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            jsonObject = redisTemplate.opsForValue().get(<span class="hljs-string">&quot;course:&quot;</span> + courseId);<br>            <span class="hljs-keyword">if</span> (jsonObject != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//查到了缓存</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> jsonObject.toString();<br>                <span class="hljs-keyword">if</span> (jsonStr.equals(<span class="hljs-string">&quot;null&quot;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                System.out.println(<span class="hljs-string">&quot;=================从缓存查=================&quot;</span>);<br>                <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonStr, CoursePublish.class);<br>                <span class="hljs-keyword">return</span> coursePublish;<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;从数据库查询...&quot;</span>);<br>            <span class="hljs-comment">//从数据库查询</span><br>            <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> getCoursePublish(courseId);<br>            <span class="hljs-comment">//if (coursePublish!=null)&#123;//存入缓存</span><br>            <span class="hljs-comment">//设置过期时间300s</span><br>            redisTemplate.opsForValue().set(<span class="hljs-string">&quot;course:&quot;</span> + courseId, JSON.toJSONString(coursePublish), <span class="hljs-number">30</span>, TimeUnit.SECONDS);<br>            <span class="hljs-comment">//&#125;</span><br>            <span class="hljs-keyword">return</span> coursePublish;<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">//释放锁</span><br>            lock.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>启动多个内容管理服务实例，使用JMeter压力测试，只有一个实例查询一次数据库。</p><p>测试Redisson自动续期功能。</p><p>在查询数据库处添加休眠，观察锁是否会自动续期。</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs haxe">JavaScript<br><span class="hljs-keyword">try</span> &#123;<br>    Thread.sleep(<span class="hljs-number">60000</span>);<br>&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(e);<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
    <tags>
      
      <tag>学成在线</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学成在线项目部署模块</title>
    <link href="/2023/12/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%9D%97/"/>
    <url>/2023/12/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="项目部署模块"><a href="#项目部署模块" class="headerlink" title="项目部署模块"></a>项目部署模块</h2><h3 id="什么是DevOps（开发运维）"><a href="#什么是DevOps（开发运维）" class="headerlink" title="什么是DevOps（开发运维）"></a>什么是DevOps（开发运维）</h3><p>一个软件的生命周期：需求分析，设计，开发，测试，上线，维护，升级，废弃</p><p>通过示例说明如下：</p><p>1、产品人员进行需求分析</p><p>2、设计人员进行软件架构设计和模块设计。</p><p>3、每个模块的开发人员并行开发，设计接口、进行编码，并进行单元测试</p><p>4、开发完毕，将代码集成部署到测试服务器，测试人员进行测试。</p><p>5、测试人员发现bug，提交bug、开发人员修改bug</p><p>6、bug修改完毕再次集成、测试。</p><p>7、测试完毕，项目上线。</p><p>8、运维人员进行安装部署、培训。</p><p>9、用户提出问题，返回给运维人员。</p><p>10、运维人员反馈给开发人员，开发人员进行问题处理。</p><p>11、再次提交测试。</p><p>12、测试完毕再次部署升级。</p><p>最后软件上线。</p><p>整体生命周期比较核心的两个阶段是：开发阶段，维护阶段，开发阶段的成果是软件开发完成并成功上线，运维阶段则负责对软件的维护和升级，而运维阶段通常在一个软件 的生命周期中占比最多。</p><p>提高开发阶段、运维阶段的工作效率是企业在进行软件项目管理的重点。</p><p>因此，专家提出了DevOps，DevOps是什么呢？</p><p>下边是摘自百度百科的定义：</p><p>DevOps（Development和Operations的组合词）是一组过程、方法与系统的统称，用于促进开发（<a href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/5985445?fromModule=lemma_inlink">应用程序</a>&#x2F;软件工程）、技术运营和质量保障（<a href="https://baike.baidu.com/item/QA/476016?fromModule=lemma_inlink">QA</a>）部门之间的沟通、协作与整合。</p><p>它是一种重视“<a href="https://baike.baidu.com/item/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/3448966?fromModule=lemma_inlink">软件开发</a>人员（Dev）”和“<a href="https://baike.baidu.com/item/IT%E8%BF%90%E7%BB%B4/5727814?fromModule=lemma_inlink">IT运维</a>技术人员（Ops）”之间沟通合作的<code>文化、运动或惯例</code>。透过自动化“<a href="https://baike.baidu.com/item/%E8%BD%AF%E4%BB%B6%E4%BA%A4%E4%BB%98/638479?fromModule=lemma_inlink">软件交付</a>”和“架构变更”的流程，来使得构建、测试、发布软件能够更加地快捷、频繁和可靠。</p><p>他的出现是由于软件行业日益清晰认识到：为了按时交付软件产品和服务，开发和运维工作必须紧密合作</p><p>DevOps是一个工具吗？</p><p>DevOps是一个工作职位吗？</p><p>都不是。</p><p>DevOps是一种思想理念，它涵盖开发、测试、运维的整个过程。DevOps追求的目标是提高软件开发、测试、运维、运营等各部门的沟通与协作质量，DevOps强调软件开发人员与软件测试、软件运维、质量保障（QA）部门之间有效的沟通与协作，强调通过自动化方法去管理软件变更，软件集成，使软件从构建到测试，发布更加快捷，可靠，最终按时交付软件。</p><h3 id="什么是CI-CD"><a href="#什么是CI-CD" class="headerlink" title="什么是CI&#x2F;CD"></a><strong>什么是CI&#x2F;CD</strong></h3><p>如何落地实现DevOps呢？</p><p>DevOps兴起于2009年，近年来由于云计算、互联网的发展，促进了DevOps的基础设施及工具链的发展，涌现了一大批优秀的工具，这些工具包括开发、测试、运维的各各领域，例如：GitHub、Docker、Jenkins、Hudson、K8S、Ant&#x2F;Maven&#x2F;Gradle、Selenium、QUnit、JMeter等。下图是DevOps相关的工具集：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228200355683.png" alt="image-20231228200355683" style="zoom:150%;" /><p>好的工具有利于DevOps的实施，但不代表实施DevOps一定需要引入一堆工具</p><p>问题的关键：如何解决问题，而不是具体应用工具。</p><p>CI&#x2F;CD 是近年来企业有效实施DevOps的具体方案。</p><p>CI&#x2F;CD 包含了一个 CI 和两个 CD，CI全称 Continuous Integration，表示<code>持续集成</code>，CD包含 Continuous Delivery和 Continuous Deployment，分别是<code>持续交付和持续部署</code>，三者具有前后依赖关系。</p><p>CI 持续集成：</p><p>持续集成倡导团队成员需要频繁的集成他们的工作，将开发分支合并到主分支，每次集成都通过自动化构建（包括编译、构建、自动化测试）来验证，从而尽快地发现集成中的错误，让产品可以快速迭代，同时还能保持高质量。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228200603978.png" alt="image-20231228200603978"></p><p>CD持续交付:</p><p>持续交付将集成后的代码部署到类生产环境(预发布)，除了交付到类生产环境之外，还会执行一些集成测试、API测试。持续交付强调的是“交付”，交付给测试、产品验收，不管怎么更新，软件是随时随地可以交付的。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228200627203.png" alt="image-20231228200627203"></p><p>CD持续部署：</p><p>在持续交付的基础上由开发人员或运维人员自助式的定期向生产环境部署稳定的构建版本，持续部署的目标是代码在任何时刻都是可部署的，并可自动进入到生产环境。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228200636686.png" alt="image-20231228200636686"></p><h3 id="DevOps-实战"><a href="#DevOps-实战" class="headerlink" title="DevOps 实战"></a>DevOps 实战</h3><h4 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a><strong>技术方案</strong></h4><p>下图是比较流行的一种CI&#x2F;CD的技术方案：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228200738483.png" alt="image-20231228200738483"></p><p>下边我们参考该技术方案将学成在线项目使用Docker进行部署。</p><p>本次项目部署实战旨在理解CI&#x2F;CD的流程，考虑Kubernates的复杂性课堂上我们用Jenkins代替Kubernates完成容器部署。</p><h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a><strong>准备环境</strong></h4><p>准备一台Centos7 虚拟机，安装Docker、jdk、maven，通过Docker容器安装jenkins、Docker私服软件，其它软件为学成在线项目所需要的，如下：</p><table><thead><tr><th>Mysql</th><th>8.x</th><th>docker</th></tr></thead><tbody><tr><td>nacos</td><td>1.4.1</td><td>docker</td></tr><tr><td>rabbitmq</td><td>3.8.34</td><td>docker</td></tr><tr><td>redis</td><td>6.2.7</td><td>docker</td></tr><tr><td>xxl-job-admin</td><td>2.3.1</td><td>docker</td></tr><tr><td>minio</td><td>RELEASE.2022-09-07</td><td>docker</td></tr><tr><td>elasticsearch</td><td>7.12.1</td><td>docker</td></tr><tr><td>kibana</td><td>7.12.1</td><td>docker</td></tr><tr><td>gogs</td><td>0.13.0</td><td>docker</td></tr><tr><td>nginx</td><td>1.12.2</td><td>docker</td></tr></tbody></table><p>在课堂资料中提供了安装以上软件的虚拟机，使用VMware导入即可使用。</p><h4 id="人工部署方式"><a href="#人工部署方式" class="headerlink" title="人工部署方式"></a><strong>人工部署方式</strong></h4><p>如果不使用CI&#x2F;CD则需要人工手动对工程进行测试、打包、部署。使用CI&#x2F;CD后通过自动化的工具去完成。</p><p>下边先演示手动部署方式，之后采用工具进行部署。</p><h5 id="项目打包"><a href="#项目打包" class="headerlink" title="项目打包"></a><strong>项目打包</strong></h5><p>1、在父工程聚合各模块</p><p>首先在父(parent)工程添加modules，聚合各个模块</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml">Bash<br><span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-base<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-checkcode<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-auth<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-content<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-learning<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-media<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-orders<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-message-sdk<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-search<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>../xuecheng-plus-system<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>2、配置打包插件</p><p>使用springboot打包插件进行打包，在需要打可执行包的工程中配置spring-boot-maven-plugin插件否则报 “jar中没有主清单属性” 。</p><p>注意：在要打可执行jar包的工程中配置该插件。需要运行的工程，比如base不用加</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">Bash</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>$</span><span class="hljs-template-variable">&#123;project.artifactId&#125;</span><span class="language-xml">-$</span><span class="hljs-template-variable">&#123;project.version&#125;</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$</span><span class="hljs-template-variable">&#123;spring-boot.version&#125;</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span></span><br><span class="language-xml">                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span></span><br><span class="language-xml"></span><br></code></pre></td></tr></table></figure><p>说明：</p><p>配置了springboot打包插件即可在maven窗口显示如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228201552684.png" alt="image-20231228201552684"></p><p>功能说明：</p><p>build-info：生成项目的构建信息文件 build-info.properties</p><p>repackage：这个是默认 goal，在 mvn package 执行之后，这个命令再次打包生成可执行的 jar，同时将 mvn package 生成的 jar 重命名为 *.origin</p><p>run：这个可以用来运行 Spring Boot 应用</p><p>start：这个在 mvn integration-test 阶段，进行 Spring Boot 应用生命周期的管理</p><p>stop：这个在 mvn integration-test 阶段，进行 Spring Boot 应用生命周期的管理</p><p>在父工程执行：<code>clean install -DskipTests -f pom.xml</code> 对所有工程进行打包</p><p>打包完成可在本地通过java -jar 运行jar包观察是否可以正常运行。</p><p>下边测试验证码服务：</p><p>进入验证码服务的target目录，cmd运行：</p><p><code>java -Dfile.encoding=utf-8 -jar xuecheng-plus-checkcode-0.0.1-SNAPSHOT.jar </code></p><p>如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228201732974.png" alt="image-20231228201732974"></p><p>使用httpclient测试申请验证码：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs clean">JavaScript<br>### 申请验证码<br>POST localhost:<span class="hljs-number">63075</span>/checkcode/pic<br><br></code></pre></td></tr></table></figure><h5 id="部署到Linux"><a href="#部署到Linux" class="headerlink" title="部署到Linux"></a><strong>部署到Linux</strong></h5><p>将打成的jar包拷贝到Linux，生成镜像，并创建容器。</p><p>1、编写Dockerfile文件</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">JavaScript<br><span class="hljs-keyword">FROM</span> java:<span class="hljs-number">8</span>u20<br><span class="hljs-keyword">MAINTAINER</span> docker_maven docker_maven@email.com<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /ROOT</span><br><span class="hljs-keyword">ADD</span><span class="language-bash"> xuecheng-plus-checkcode-0.0.1-SNAPSHOT.jar xuecheng-plus-checkcode.jar</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-version&quot;</span>]</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-Dfile.encoding=utf-8&quot;</span>,<span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;xuecheng-plus-checkcode.jar&quot;</span>]</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">63075</span><br></code></pre></td></tr></table></figure><p>2、创建镜像</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">JavaScript</span><br><span class="hljs-attribute">docker</span> build -t checkcode:<span class="hljs-number">1</span>.<span class="hljs-number">0</span> .<br></code></pre></td></tr></table></figure><p>创建成功，查询镜像:</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228201836868.png" alt="image-20231228201836868"></p><p>3、创建容器</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">JavaScript</span><br><span class="hljs-attribute">docker</span> run --name xuecheng-plus-checkcode -p <span class="hljs-number">63075</span>:<span class="hljs-number">63075</span> -idt checkcode:<span class="hljs-number">1</span>.<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>再次测试</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs clean">JavaScript<br>### 申请验证码<br>POST <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span>:<span class="hljs-number">63075</span>/checkcode/pic<br></code></pre></td></tr></table></figure><h4 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a><strong>自动部署</strong></h4><h5 id="实战流程"><a href="#实战流程" class="headerlink" title="实战流程"></a><strong>实战流程</strong></h5><p>下边使用jenkins实现CI&#x2F;CD的流程</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228201933732.png" alt="image-20231228201933732"></p><ol><li>将代码使用Git托管</li><li>在jenkins创建任务，从Git拉取代码</li><li>拉取代码后进行自动构建：测试，打包，部署<ol><li>首先将代码打成镜像包上传到docker私服</li><li>自动创建容器，启动容器</li></ol></li><li>当有代码push到git实现自动构建</li></ol><h5 id="代码提交至Git"><a href="#代码提交至Git" class="headerlink" title="代码提交至Git"></a><strong>代码提交至Git</strong></h5><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228202154560.png" alt="image-20231228202154560"></p><h5 id="修改pom-xml文件"><a href="#修改pom-xml文件" class="headerlink" title="修改pom.xml文件"></a><strong>修改pom.xml文件</strong></h5><p>在pom.xml添加docker-maven-plugin插件实现将springboot工程创建镜像， 此pom.xml添加docker-maven-plugin插件用于生成镜像。</p><p>分别修改system-api、content-api、media-api、gateway、auth、checkcode服务的pom.xml文件。</p><p>插件的坐标如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.spotify<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>docker-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>修改pom.xml文件，以xuecheng-plus-checkcode为例，如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;-$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.spotify<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>docker-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--修改imageName节点的内容，改为私有仓库地址和端口，再加上镜像id和 TAG,我们要直接传到私服--&gt;</span><br>                <span class="hljs-comment">&lt;!--配置最后生成的镜像名，docker images里的，我们这边取项目名:版本--&gt;</span><br>                <span class="hljs-comment">&lt;!--&lt;imageName&gt;$&#123;project.artifactId&#125;:$&#123;project.version&#125;&lt;/imageName&gt;--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">imageName</span>&gt;</span>192.168.101.65:5000/$&#123;project.artifactId&#125;:$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">imageName</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--也可以通过以下方式定义image的tag信息。 --&gt;</span><br>                <span class="hljs-comment">&lt;!-- &lt;imageTags&gt;</span><br><span class="hljs-comment">                     &lt;imageTag&gt;$&#123;project.version&#125;&lt;/imageTag&gt;</span><br><span class="hljs-comment">                     &amp;lt;!&amp;ndash;build 时强制覆盖 tag，配合 imageTags 使用&amp;ndash;&amp;gt;</span><br><span class="hljs-comment">                     &lt;forceTags&gt;true&lt;/forceTags&gt;</span><br><span class="hljs-comment">                     &amp;lt;!&amp;ndash;build 完成后，push 指定 tag 的镜像，配合 imageTags 使用&amp;ndash;&amp;gt;</span><br><span class="hljs-comment">                     &lt;pushImageTag&gt;true&lt;/pushImageTag&gt;</span><br><span class="hljs-comment">                 &lt;/imageTags&gt;--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">baseImage</span>&gt;</span>java:8u20<span class="hljs-tag">&lt;/<span class="hljs-name">baseImage</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">maintainer</span>&gt;</span>docker_maven docker_maven@email.com<span class="hljs-tag">&lt;/<span class="hljs-name">maintainer</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">workdir</span>&gt;</span>/root<span class="hljs-tag">&lt;/<span class="hljs-name">workdir</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">cmd</span>&gt;</span>[&quot;java&quot;, &quot;-version&quot;]<span class="hljs-tag">&lt;/<span class="hljs-name">cmd</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--来指明Dockerfile文件的所在目录，如果配置了dockerDirectory则忽略baseImage，maintainer等配置--&gt;</span><br>                <span class="hljs-comment">&lt;!--&lt;dockerDirectory&gt;./&lt;/dockerDirectory&gt;--&gt;</span><br>                <span class="hljs-comment">&lt;!--2375是docker的远程端口，插件生成镜像时连接docker，这里需要指定docker远程端口--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dockerHost</span>&gt;</span>http://192.168.101.65:2375<span class="hljs-tag">&lt;/<span class="hljs-name">dockerHost</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--入口点，project.build.finalName就是project标签下的build标签下 的filename标签内容，testDocker--&gt;</span><br>                <span class="hljs-comment">&lt;!--相当于启动容器后，会自动执行java -jar ...--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">entryPoint</span>&gt;</span>[&quot;java&quot;, &quot;-Dfile.encoding=utf-8&quot;,&quot;-jar&quot;, &quot;/root/$&#123;project.build.finalName&#125;.jar&quot;]<span class="hljs-tag">&lt;/<span class="hljs-name">entryPoint</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--是否推送到docker私有仓库，旧版本插件要配置maven的settings文件。 --&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">pushImage</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">pushImage</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">registryUrl</span>&gt;</span>192.168.101.65:5000<span class="hljs-tag">&lt;/<span class="hljs-name">registryUrl</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 这里是复制 jar 包到 docker 容器指定目录配置 --&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">targetPath</span>&gt;</span>/root<span class="hljs-tag">&lt;/<span class="hljs-name">targetPath</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>                        <span class="hljs-comment">&lt;!--把哪个文件上传到docker，相当于Dockerfile里的add app.jar /--&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="自动构建测试"><a href="#自动构建测试" class="headerlink" title="自动构建测试"></a>自动构建测试</h5><p>找到jenkins_02任务，配置源码管理</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228203839170.png" alt="image-20231228203839170"></p><p>配置完毕，开始构建</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228203901778.png" alt="image-20231228203901778"></p><p>通过控制台输出日志观察构建情况 </p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228203911395.png" alt="image-20231228203911395"></p><p>如果控制台有报错，根据错误信息进行调试。</p><p>部署成功后，进入服务器查看docker容器是否启动成功</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228203918090.png" alt="image-20231228203918090"></p><h5 id="部署前端门户"><a href="#部署前端门户" class="headerlink" title="部署前端门户"></a>部署前端门户</h5><p>在虚拟机的docker中已经部署了nginx，修改nginx.conf的配置文件 </p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">JavaScript</span><br><br><span class="hljs-comment">#user  nobody;</span><br>worker_processes  <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">#error_log  logs/error.log;</span><br><span class="hljs-comment">#error_log  logs/error.log  notice;</span><br><span class="hljs-comment">#error_log  logs/error.log  info;</span><br><br><span class="hljs-comment">#pid        logs/nginx.pid;</span><br><br><br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><br><br><span class="hljs-section">http</span> &#123;<br>     <span class="hljs-attribute">server_names_hash_bucket_size</span> <span class="hljs-number">64</span>;<br>     <span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">100M</span>; <span class="hljs-comment"># 设置客户端请求体最大值</span><br>     <span class="hljs-attribute">client_body_buffer_size</span> <span class="hljs-number">128k</span>; <span class="hljs-comment"># 设置请求体缓存区大小</span><br>    <span class="hljs-attribute">include</span>       mime.types;<br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br><br>    <span class="hljs-comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>    <span class="hljs-comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>    <span class="hljs-comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><br>    <span class="hljs-comment">#access_log  logs/access.log  main;</span><br><br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment">#tcp_nopush     on;</span><br><br>    <span class="hljs-comment">#keepalive_timeout  0;</span><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br>   <span class="hljs-comment">#文件服务</span><br>  <span class="hljs-section">upstream</span> fileserver&#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.101.65:9000</span> weight=<span class="hljs-number">10</span>;<br>  &#125; <br>     <span class="hljs-comment">#后台网关</span><br>  <span class="hljs-section">upstream</span> gatewayserver&#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.101.65:63010</span> weight=<span class="hljs-number">10</span>;<br>  &#125; <br>    <span class="hljs-comment">#gzip  on;</span><br><br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  www.51xuecheng.cn localhost;<br>        <span class="hljs-comment">#rewrite ^(.*) https://$server_name$1 permanent;</span><br>        <span class="hljs-comment">#charset koi8-r;</span><br>        <span class="hljs-attribute">ssi</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">ssi_silent_errors</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br><br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">alias</span>   /etc/nginx/html/;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br>        <span class="hljs-comment">#api</span><br>        <span class="hljs-section">location</span> /api/ &#123;<br>                <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/;<br>        &#125; <br>        <span class="hljs-comment">#静态资源</span><br>        <span class="hljs-section">location</span> /static/img/ &#123;  <br>                <span class="hljs-attribute">alias</span>  /etc/nginx/html/img/;<br>        &#125; <br>        <span class="hljs-section">location</span> /static/css/ &#123;  <br>                <span class="hljs-attribute">alias</span>   /etc/nginx/html/css/;<br>        &#125; <br>        <span class="hljs-section">location</span> /static/js/ &#123;  <br>                <span class="hljs-attribute">alias</span>   /etc/nginx/html/js/;<br>        &#125; <br>        <span class="hljs-section">location</span> /static/plugins/ &#123;  <br>                <span class="hljs-attribute">alias</span>   /etc/nginx/html/plugins/;<br>                <span class="hljs-attribute">add_header</span> Access-Control-Allow-Origin http://ucenter.51xuecheng.cn;  <br>                <span class="hljs-attribute">add_header</span> Access-Control-Allow-Credentials <span class="hljs-literal">true</span>;  <br>                <span class="hljs-attribute">add_header</span> Access-Control-Allow-Methods GET;<br>        &#125; <br>        <span class="hljs-section">location</span> /plugins/ &#123;  <br>                <span class="hljs-attribute">alias</span>   /etc/nginx/html/plugins/;<br>        &#125; <br>        <span class="hljs-section">location</span> /course/preview/learning.html &#123;<br>                <span class="hljs-attribute">alias</span> /etc/nginx/html/course/learning.html;<br>        &#125; <br>        <span class="hljs-section">location</span> /course/search.html &#123;  <br>                <span class="hljs-attribute">root</span>   /etc/nginx/html;<br>        &#125; <br>        <span class="hljs-section">location</span> /course/learning.html &#123;  <br>                <span class="hljs-attribute">root</span>   /etc/nginx/html;<br>        &#125; <br>        <span class="hljs-section">location</span> /course/ &#123;  <br>                <span class="hljs-attribute">proxy_pass</span> http://fileserver/mediafiles/course/;<br>        &#125; <br>        <span class="hljs-comment">#openapi</span><br>        <span class="hljs-section">location</span> /open/content/ &#123;<br>                <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/content/open/;<br>        &#125; <br>        <span class="hljs-section">location</span> /open/media/ &#123;<br>                <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/media/open/;<br>        &#125; <br><br>        <span class="hljs-comment">#error_page  404              /404.html;</span><br><br>        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-attribute">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.html;<br>        <span class="hljs-section">location</span> = /50x.html &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>        &#125;<br><br>        <span class="hljs-comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment">#location ~ \.php$ &#123;</span><br>        <span class="hljs-comment">#    proxy_pass   http://127.0.0.1;</span><br>        <span class="hljs-comment">#&#125;</span><br><br>        <span class="hljs-comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment">#location ~ \.php$ &#123;</span><br>        <span class="hljs-comment">#    root           html;</span><br>        <span class="hljs-comment">#    fastcgi_pass   127.0.0.1:9000;</span><br>        <span class="hljs-comment">#    fastcgi_index  index.php;</span><br>        <span class="hljs-comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br>        <span class="hljs-comment">#    include        fastcgi_params;</span><br>        <span class="hljs-comment">#&#125;</span><br><br>        <span class="hljs-comment"># deny access to .htaccess files, if Apache&#x27;s document root</span><br>        <span class="hljs-comment"># concurs with nginx&#x27;s one</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment">#location ~ /\.ht &#123;</span><br>        <span class="hljs-comment">#    deny  all;</span><br>        <span class="hljs-comment">#&#125;</span><br>    &#125;<br><br>   <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  file.51xuecheng.cn;<br>        <span class="hljs-comment">#charset koi8-r;</span><br>        <span class="hljs-attribute">ssi</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">ssi_silent_errors</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>        <span class="hljs-section">location</span> /video &#123;<br>            <span class="hljs-attribute">proxy_pass</span>   http://fileserver;<br>        &#125;<br><br>        <span class="hljs-section">location</span> /mediafiles &#123;<br>            <span class="hljs-attribute">proxy_pass</span>   http://fileserver;<br>        &#125;<br>   &#125;<br> <br>   <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  teacher.51xuecheng.cn;<br>        <span class="hljs-comment">#charset koi8-r;</span><br>        <span class="hljs-attribute">ssi</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">ssi_silent_errors</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">alias</span>   /etc/nginx/html/dist/;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br>        <span class="hljs-comment">#location / &#123;</span><br>        <span class="hljs-comment">#    proxy_pass   http://uidevserver;</span><br>        <span class="hljs-comment">#&#125;</span><br><br>        <span class="hljs-section">location</span> /api/ &#123;<br>                <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/;<br>        &#125; <br>        <br>        <br>   &#125;<br><br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  ucenter.51xuecheng.cn;<br>        <span class="hljs-comment">#charset koi8-r;</span><br>        <span class="hljs-attribute">ssi</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">ssi_silent_errors</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">alias</span>   /etc/nginx/html/ucenter/;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br>        <span class="hljs-section">location</span> /include &#123;<br>            <span class="hljs-attribute">proxy_pass</span>   http://192.168.101.65;<br>        &#125;<br>        <span class="hljs-section">location</span> /img/ &#123;<br>            <span class="hljs-attribute">proxy_pass</span>   http://192.168.101.65/static/img/;<br>        &#125;<br>        <span class="hljs-section">location</span> /api/ &#123;<br>                <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/;<br>        &#125; <br>   &#125;<br>    <span class="hljs-comment"># another virtual host using mix of IP-, name-, and port-based configuration</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#server &#123;</span><br>    <span class="hljs-comment">#    listen       8000;</span><br>    <span class="hljs-comment">#    listen       somename:8080;</span><br>    <span class="hljs-comment">#    server_name  somename  alias  another.alias;</span><br><br>    <span class="hljs-comment">#    location / &#123;</span><br>    <span class="hljs-comment">#        root   html;</span><br>    <span class="hljs-comment">#        index  index.html index.htm;</span><br>    <span class="hljs-comment">#    &#125;</span><br>    <span class="hljs-comment">#&#125;</span><br><br><br>    <span class="hljs-comment"># HTTPS server</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#server &#123;</span><br>    <span class="hljs-comment">#    listen       443 ssl;</span><br>    <span class="hljs-comment">#    server_name  localhost;</span><br><br>    <span class="hljs-comment">#    ssl_certificate      cert.pem;</span><br>    <span class="hljs-comment">#    ssl_certificate_key  cert.key;</span><br><br>    <span class="hljs-comment">#    ssl_session_cache    shared:SSL:1m;</span><br>    <span class="hljs-comment">#    ssl_session_timeout  5m;</span><br><br>    <span class="hljs-comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br>    <span class="hljs-comment">#    ssl_prefer_server_ciphers  on;</span><br><br>    <span class="hljs-comment">#    location / &#123;</span><br>    <span class="hljs-comment">#        root   html;</span><br>    <span class="hljs-comment">#        index  index.html index.htm;</span><br>    <span class="hljs-comment">#    &#125;</span><br>    <span class="hljs-comment">#&#125;</span><br><br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>将前端门户的静态页面拷贝到 &#x2F;data&#x2F;soft&#x2F;nginx&#x2F;xuecheng_portal_static</p><p>启动nginx容器：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">JavaScript<br>docker <span class="hljs-literal">start</span> nginx<br><br></code></pre></td></tr></table></figure><p>修改本机hosts文件：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">JavaScript</span><br><span class="hljs-attribute">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">101</span>.<span class="hljs-number">65</span>   www.<span class="hljs-number">51</span>xuecheng.cn <span class="hljs-number">51</span>xuecheng.cn ucenter.<span class="hljs-number">51</span>xuecheng.cn teacher.<span class="hljs-number">51</span>xuecheng.cn file.<span class="hljs-number">51</span>xuecheng.cn<br><br></code></pre></td></tr></table></figure><p>将本机的nginx服务停掉，访问<a href="http://www.51xuecheng.cn./">www.51xuecheng.cn。</a></p><h5 id="部署机构端前端"><a href="#部署机构端前端" class="headerlink" title="部署机构端前端"></a>部署机构端前端</h5><p>将机构端的前端工程打包，运行yarn build</p><p>打包成功在工程目录生成dist目录</p><p>将此目录的内容拷贝到虚拟机的&#x2F;data&#x2F;soft&#x2F;nginx&#x2F;xuecheng_portal_static&#x2F;dist</p><h5 id="配置触发器"><a href="#配置触发器" class="headerlink" title="配置触发器"></a><strong>配置触发器</strong></h5><p>当向gogs提交代码时进行自动构建</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228204051305.png" alt="image-20231228204051305"></p><p>在gogs配置钩子</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228204058658.png" alt="image-20231228204058658"></p><p>推送地址设置jenkins的接口：</p><p><a href="http://192.168.101.65:8888/gogs-webhook/?job=jenkins_02">http://192.168.101.65:8888/gogs-webhook/?job=jenkins_02</a></p><p>配置好可以测试一下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228204113444.png" alt="image-20231228204113444"></p><p>测试后观察jenkina是否重新构建任务。</p><p>提交代码测试：</p><p>修改代码提交到gogs，观察jenkins是否自动构建任务</p><h4 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a><strong>功能测试</strong></h4><h5 id="测试认证功能"><a href="#测试认证功能" class="headerlink" title="测试认证功能"></a><strong>测试认证功能</strong></h5><p>部署成功后对功能进行测试。</p><p>1、首先测试认证功能</p><p>进入<a href="http://www.51xuecheng.cn,点击登录,输入账号和密码进行登录./">www.51xuecheng.cn，点击登录，输入账号和密码进行登录。</a></p><p>账号和密码：t1&#x2F;111111</p><h5 id="测试内容管理"><a href="#测试内容管理" class="headerlink" title="测试内容管理"></a><strong>测试内容管理</strong></h5><p>1、测试课程列表</p><p>出现 Request failed with status code 503 错误</p><p>通过nacos排查，进入服务列表</p><p>缺少system-api</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/clip_image002.gif" alt="img"></p><p>排查system-api工程的bootstrap.yml配置文件、依赖包等内容。</p><p>修改代码后重新提交git</p><p>再次进行jenkins构建。</p><p>2、测试上传课程图片</p><p>首先测试修改课程，上传一个新图片。</p><p>3、测试课程发布</p><p>首先观察xxl-job调度中心是否成功注册执行器</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/clip_image004.gif" alt="img"></p><p>启动课程发布任务</p><p>发布一门课程，观察content-api容器的日志</p><p>错误日志：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">JavaScript<br>java.io.FileNotFoundException: <span class="hljs-keyword">file</span>:<span class="hljs-regexp">/root/</span>xuecheng-<span class="hljs-keyword">plus</span>-content-api-<span class="hljs-number">0.0</span>.<span class="hljs-number">1</span>-SNAPSHOT.jar!<span class="hljs-regexp">/BOOT-INF/</span>classes!/templates does not exist.<br><br></code></pre></td></tr></table></figure><p>无法找到静态化的模板</p><p>屏蔽原来的方式，改如下方式</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">JavaScript<br><span class="hljs-string">//</span>            String classpath = this.getClass<span class="hljs-params">()</span><span class="hljs-string">.getResource</span><span class="hljs-params">(&quot;/&quot;)</span><span class="hljs-string">.getPath</span><span class="hljs-params">()</span>; <span class="hljs-string">//</span>打包jar无法获取模板<br><span class="hljs-string">//</span>            configuration.<span class="hljs-keyword">set</span>DirectoryForTemplateLoading<span class="hljs-params">(new File(classpath + &quot;/templates/&quot;)</span>);<br>        <span class="hljs-string">//</span>更改为如下方式<br>        configuration.<span class="hljs-keyword">set</span>TemplateLoader<span class="hljs-params">(new ClassTemplateLoader(this.getClass()</span><span class="hljs-string">.getClassLoader</span><span class="hljs-params">()</span>,<span class="hljs-string">&quot;/templates&quot;</span>));<br><br></code></pre></td></tr></table></figure><h5 id="测试媒资管理"><a href="#测试媒资管理" class="headerlink" title="测试媒资管理"></a><strong>测试媒资管理</strong></h5><p>1、配置ffmpeg的目录</p><p>将linux版本的ffmpeg拷贝到 &#x2F;data&#x2F;soft&#x2F;service 下，在nacos配置ffmpeg 的地址：</p><p>Ffmpeg linux版本下载地址：<a href="https://johnvansickle.com/ffmpeg/">https://johnvansickle.com/ffmpeg/</a></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts">JavaScript<br><span class="hljs-symbol">videoprocess:</span><br><span class="hljs-symbol"> ffmpegpath:</span> <span class="hljs-keyword">/root/</span>soft/ffmpeg<br></code></pre></td></tr></table></figure><p>2、测试上传视频</p>]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
    <tags>
      
      <tag>学成在线</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学成在线选课学习模块</title>
    <link href="/2023/12/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9D%97/"/>
    <url>/2023/12/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="选课学习模块"><a href="#选课学习模块" class="headerlink" title="选课学习模块"></a>选课学习模块</h2><h3 id="模块需求分析"><a href="#模块需求分析" class="headerlink" title="模块需求分析"></a><strong>模块需求分析</strong></h3><h4 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h4><p>本模块实现了学生选课、下单支付、学习的整体流程。</p><p>网站的课程有免费和收费两种，对于免费课程学生选课后可直接学习，对于收费课程学生需要下单且支付成功方可选课、学习。</p><p>选课：是将课程加入我的课程表的过程。</p><p>我的课程表：记录我在网站学习的课程，我的课程表中有免费课程和收费课程两种，对于免费课程可直接添加到我的课程表，对于收费课程需要下单、支付成功后自动加入我的课程表。</p><p>模块整体流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227183107025.png" alt="image-20231227183107025"></p><h4 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h4><h5 id="学习引导"><a href="#学习引导" class="headerlink" title="学习引导"></a><strong>学习引导</strong></h5><p>用户通过搜索课程、课程推荐等信息进入课程详情页面，点击“马上学习” 引导进入学习界面去学习。</p><p>流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227183311995.png" alt="image-20231227183311995"></p><p>1、进入课程详情点击马上学习</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227183325851.png" alt="image-20231227183325851"></p><p>2、课程免费时引导加入我的课程表、或进入学习界面。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227183352609.png" alt="image-20231227183352609"></p><p>3、课程收费时引导去支付、或试学。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227183405427.png" alt="image-20231227183405427"></p><h5 id="选课流程"><a href="#选课流程" class="headerlink" title="选课流程"></a><strong>选课流程</strong></h5><p>选课是将课程加入我的课程表的过程。</p><p>对免费课程选课后可直接加入我的课程表，对收费课程选课后需要下单支付成功系统自动加入我的课程表。</p><p>流程如下：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227183440601.png" alt="image-20231227183440601" style="zoom:70%;" /><h5 id="支付流程"><a href="#支付流程" class="headerlink" title="支付流程"></a><strong>支付流程</strong></h5><p>本项目与第三方支付平台对接完成支付操作</p><p>流程如下</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227183711890.png" alt="image-20231227183711890"></p><h5 id="在线学习"><a href="#在线学习" class="headerlink" title="在线学习"></a><strong>在线学习</strong></h5><p>选课成功用户可以在线学习，对于免费课程无需选课即可在线学习。</p><p>流程如下</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227183728480.png" alt="image-20231227183728480"></p><h5 id="免费课程续期"><a href="#免费课程续期" class="headerlink" title="免费课程续期"></a><strong>免费课程续期</strong></h5><p>免费课程加入我的课程表默认为1年有效期，到期用户可申请续期，流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227192817451.png" alt="image-20231227192817451"></p><h3 id="添加选课"><a href="#添加选课" class="headerlink" title="添加选课"></a><strong>添加选课</strong></h3><h5 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h5><h6 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h6><p>选课是将课程加入我的课程表的过程，根据选课的业务流程进行详细分析，业务流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227192938124.png" alt="image-20231227192938124"></p><p>选课信息存入选课记录表，免费课程被选课除了进入选课记录表同时进入我的课程表，收费课程进入选课记录表后需要经过下单、支付成功才可以进入我的课程表。</p><p>我的课程表记录了用户学习的课程，包括免费课程、收费课程（已经支付）。</p><p>1、选课记录表</p><p>当用户将课程添加到课程表时需要先创建选课记录</p><p>结构如<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227193034659.png" alt="image-20231227193034659">：</p><p>选课类型：免费课程、收费课程。</p><p>选课状态：选课成功、待支付、选课删除。</p><p>对于免费课程：课程价格为0，有效期默认365，开始服务时间为选课时间，结束服务时间为选课时间加1年后的时间，选课状态为选课成功。</p><p>对于收费课程：按课程的现价、有效期确定开始服务时间、结束服务时间，选课状态为待支付。</p><p>收费课程的选课记录需要支付成功后选课状态为成功。</p><p>2、我的课程表</p><p>我的课程表中记录了用户选课成功的课程，所以我的课程表的数据来源于选课记录表。</p><p>对于免费课程创建选课记录后同时向我的课程表添加记录。</p><p>对于收费课程创建选课记录后需要下单支付成功后自动向我的课程表添加记录。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227193134743.png" alt="image-20231227193134743"></p><h6 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a><strong>执行流程</strong></h6><p>在学习引导处，可以直接将免费课程加入我的课程表，如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227193209748.png" alt="image-20231227193209748"></p><p>对于收费课程先创建选课记录表，支付成功后，收到支付结果由系统自动加入我的课程表。</p><p>执行流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227193245036.png" alt="image-20231227193245036"></p><h5 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h5><h6 id="部署学习中心工程"><a href="#部署学习中心工程" class="headerlink" title="部署学习中心工程"></a><strong>部署学习中心工程</strong></h6><p>从课程资料拷贝学习中心服务工程到自己的工程目录，结构如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227193318603.png" alt="image-20231227193318603"></p><p>注意去修改nacos的命名空间。</p><p>创建数据库xc_learning，并导入数据</p><p>修改数据库的连接，改成自己的数据库。</p><p>nacos配置文件：learning-api-dev.yaml</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">YAML</span><br><span class="hljs-attribute">server</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">servlet</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">context-path</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/learning</span><br>  <span class="hljs-attribute">port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">63020</span><br><br><br></code></pre></td></tr></table></figure><p>learning-service-dev.yaml</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dts">YAML<br><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">  datasource:</span><br>    driver-class-name: com.mysql.cj.jdbc.Driver<br><span class="hljs-symbol">    url:</span> jdbc:mysql:<span class="hljs-comment">//192.168.101.65:3306/xc402_learning?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br><span class="hljs-symbol">    username:</span> root<br><span class="hljs-symbol">    password:</span> mysql<br><br></code></pre></td></tr></table></figure><h6 id="添加查询课程接口"><a href="#添加查询课程接口" class="headerlink" title="添加查询课程接口"></a><strong>添加查询课程接口</strong></h6><p>内容管理服务提供查询课程信息接口，此接口从课程发布表查询。</p><p>此接口主要提供其它微服务远程调用，所以此接口不用授权，本项目标记此类接口统一以 &#x2F;r开头。</p><p>在课程发布controller类中定义课程发布信息查询接口。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;查询课程发布信息&quot;</span>)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/r/coursepublish/&#123;courseId&#125;&quot;</span>)</span><br><span class="hljs-keyword">public</span> CoursePublish getCoursepublish(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> courseId) &#123;<br>    CoursePublish coursePublish = coursePublishService.getCoursePublish(courseId);<br>     <span class="hljs-keyword">return</span> coursePublish;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Service如下：</p><p>如果课程发布状态正常则正常返回，否则返回空。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">public</span> CoursePublish <span class="hljs-title function_">getCoursePublish</span><span class="hljs-params">(Long courseId)</span>&#123;<br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> coursePublishMapper.selectById(courseId);<br>    <span class="hljs-keyword">return</span> coursePublish ;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>测试：</p><p>启动内容管理服务，使用httpclient测试</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dts">Plain Text<br><span class="hljs-meta">### 查询课程发布信息</span><br><span class="hljs-title class_">GET</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>content_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">/content/</span>r<span class="hljs-keyword">/coursepublish/</span><span class="hljs-number">2</span><br><br></code></pre></td></tr></table></figure><p>由于是在网关处进行令牌校验，所以在微服务处不再校验令牌的合法性，修改内容管理content-api工程的ResouceServerConfig类，屏蔽authenticated()。</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">Java<br> @Override<br> public void configure<span class="hljs-params">(HttpSecurity http)</span> throws Exception &#123;<br>  http.csrf<span class="hljs-params">()</span><span class="hljs-string">.disable</span><span class="hljs-params">()</span><br>          <span class="hljs-string">.authorizeRequests</span><span class="hljs-params">()</span><br><span class="hljs-string">//</span>          <span class="hljs-string">.antMatchers</span><span class="hljs-params">(&quot;/r/**&quot;,&quot;/course/**&quot;)</span><span class="hljs-string">.authenticated</span><span class="hljs-params">()</span><span class="hljs-string">//</span>所有<span class="hljs-string">/r/</span>**的请求必须认证通过<br>          <span class="hljs-string">.anyRequest</span><span class="hljs-params">()</span><span class="hljs-string">.permitAll</span><span class="hljs-params">()</span><br>  ;<br> &#125;<br><br></code></pre></td></tr></table></figure><h6 id="测试查询课程信息接口"><a href="#测试查询课程信息接口" class="headerlink" title="测试查询课程信息接口"></a><strong>测试查询课程信息接口</strong></h6><p>学生中心服务远程调用内容管理服务的查询课程发布信息接口。</p><p>导入的学习中心工程已经存在ContentServiceClient 接口，通过此接口远程调用课程查询接口。</p><p>编写测试接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CoursePublish;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.feignclient.ContentServiceClient;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Assertions;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> Feign接口测试类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/24 17:15</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignClientTest</span> &#123;<br><br>  <span class="hljs-meta">@Autowired</span><br> ContentServiceClient contentServiceClient;<br><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testContentServiceClient</span><span class="hljs-params">()</span>&#123;<br>   <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursepublish</span> <span class="hljs-operator">=</span> contentServiceClient.getCoursepublish(<span class="hljs-number">18L</span>);<br>   Assertions.assertNotNull(coursepublish);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>在进行feign远程调用时会将字符串转成LocalDateTime，在CoursePublish 类中LocalDateTime的属性上边添加如下代码：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">@<span class="hljs-built_in">JsonFormat</span>(shape = JsonFormat<span class="hljs-selector-class">.Shape</span><span class="hljs-selector-class">.STRING</span>,pattern = <span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)<br></code></pre></td></tr></table></figure><h6 id="添加选课接口"><a href="#添加选课接口" class="headerlink" title="添加选课接口"></a><strong>添加选课接口</strong></h6><p> <strong>接口分析</strong></p><p>本接口支持免费课程选课、收费课程选课。</p><p>免费课程选课：添加选课记录、添加我的课程表。</p><p>收费课程选课：添加选课记录。</p><p><strong>接口定义</strong></p><p>1、请求参数：课程id、当前用户id</p><p>2、响应结果：选课记录信息、学习资格</p><p>学习资格：<code>[&#123;&quot;code&quot;:&quot;702001&quot;,&quot;desc&quot;:&quot;正常学习&quot;&#125;,&#123;&quot;code&quot;:&quot;702002&quot;,&quot;desc&quot;:&quot;没有选课或选课后没有支付&quot;&#125;,&#123;&quot;code&quot;:&quot;702003&quot;,&quot;desc&quot;:&quot;已过期需要申请续期或重新支付&quot;&#125;]</code></p><p>接口定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.learning.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.service.MyCourseTablesService;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.util.SecurityUtil;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 我的课程表接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/2 14:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = &quot;我的课程表接口&quot;, tags = &quot;我的课程表接口&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCourseTablesController</span> &#123;<br>    <span class="hljs-meta">@ApiOperation(&quot;添加选课&quot;)</span><br>     <span class="hljs-meta">@PostMapping(&quot;/choosecourse/&#123;courseId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> XcChooseCourseDto <span class="hljs-title function_">addChooseCourse</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>  &#123;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Service接口定义：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.po.XcChooseCourse;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.po.XcCourseTables;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 我的课程表service接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/2 16:07</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyCourseTablesService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 添加选课</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId 用户id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId 课程id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.xuecheng.learning.model.dto.XcChooseCourseDto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/24 17:33</span><br><span class="hljs-comment">*/</span><br> <span class="hljs-keyword">public</span> XcChooseCourseDto addChooseCourse(String userId, <span class="hljs-built_in">Long</span> courseId);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>Service接口执行流程</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">service</span>;<br><br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">content</span>.<span class="hljs-property">model</span>.<span class="hljs-property">po</span>.<span class="hljs-property">CoursePublish</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">feignclient</span>.<span class="hljs-property">ContentServiceClient</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">mapper</span>.<span class="hljs-property">XcChooseCourseMapper</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">mapper</span>.<span class="hljs-property">XcCourseTablesMapper</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">model</span>.<span class="hljs-property">dto</span>.<span class="hljs-property">XcChooseCourseDto</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">model</span>.<span class="hljs-property">po</span>.<span class="hljs-property">XcChooseCourse</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">model</span>.<span class="hljs-property">po</span>.<span class="hljs-property">XcCourseTables</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Autowired</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Service</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">transaction</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Transactional</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/27 20:23</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCourseTablesServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MyCourseTablesService</span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-title class_">XcChooseCourseMapper</span> xcChooseCourseMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-title class_">XcCourseTablesMapper</span> xcCourseTablesMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-title class_">ContentServiceClient</span> contentServiceClient;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-title class_">MyCourseTablesService</span> myCourseTablesService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-title class_">MyCourseTablesServiceImpl</span> currentProxy;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">XcChooseCourseDto</span> <span class="hljs-title function_">addChooseCourse</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userId,Long courseId</span>) &#123;<br>        <span class="hljs-comment">//查询课程信息</span><br>        <span class="hljs-title class_">CoursePublish</span> coursepublish = contentServiceClient.<span class="hljs-title function_">getCoursepublish</span>(courseId);<br>        <span class="hljs-comment">//课程收费标准</span><br>        <span class="hljs-title class_">String</span> charge = coursepublish.<span class="hljs-title function_">getCharge</span>();<br>        <span class="hljs-comment">//选课记录</span><br>        <span class="hljs-title class_">XcChooseCourse</span> chooseCourse = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;201000&quot;</span>.<span class="hljs-title function_">equals</span>(charge))&#123;<span class="hljs-comment">//课程免费</span><br>            <span class="hljs-comment">//添加免费课程</span><br>            chooseCourse  = <span class="hljs-title function_">addFreeCoruse</span>(userId, coursepublish);<br>            <span class="hljs-comment">//添加到我的课程表</span><br>            <span class="hljs-title class_">XcCourseTables</span> xcCourseTables = <span class="hljs-title function_">addCourseTables</span>(chooseCourse);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">//添加收费课程</span><br>            chooseCourse  = <span class="hljs-title function_">addChargeCoruse</span>(userId, coursepublish);<br>        &#125;<br>        <span class="hljs-comment">//获取学习资格</span><br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//添加免费课程,免费课程加入选课记录表、我的课程表</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">XcChooseCourse</span> <span class="hljs-title function_">addFreeCoruse</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userId, CoursePublish coursepublish</span>) &#123;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//添加收费课程</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">XcChooseCourse</span> <span class="hljs-title function_">addChargeCoruse</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userId,CoursePublish coursepublish</span>)&#123;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">//添加到我的课程表</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">XcCourseTables</span> <span class="hljs-title function_">addCourseTables</span>(<span class="hljs-params">XcChooseCourse xcChooseCourse</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>添加免费课程</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs perl">//添加免费课程,免费课程加入选课记录表、我的课程表<br>public XcChooseCourse addFreeCourse(String userId, CoursePublish coursepublish) &#123;<br>    <span class="hljs-regexp">//</span>查询选课记录表是否存在免费的且选课成功的订单<br>    LambdaQueryWrapper&lt;XcChooseCourse&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();<br>    queryWrapper = queryWrapper.e<span class="hljs-string">q(XcChooseCourse::getUserId, userId)</span><br>            .e<span class="hljs-string">q(XcChooseCourse::getCourseId, coursepublish.getId()</span>)<br>            .e<span class="hljs-string">q(XcChooseCourse::getOrderType, &quot;700001&quot;)</span>//免费课程<br>            .e<span class="hljs-string">q(XcChooseCourse::getStatus, &quot;701001&quot;)</span>;<span class="hljs-regexp">//</span>选课成功<br>    List&lt;XcChooseCourse&gt; xcChooseCourses = xcChooseCourseMapper.selectList(queryWrapper);<br>    <span class="hljs-keyword">if</span> (xcChooseCourses!=null&amp;&amp;xcChooseCourses.size()&gt;<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">return</span> xcChooseCourses.get(<span class="hljs-number">0</span>);<br>    &#125;<br>    //添加选课记录信息<br>    XcChooseCourse xcChooseCourse = new XcChooseCourse();<br>    xcChooseCourse.setCourseId(coursepublish.getId());<br>    xcChooseCourse.setCompanyId(coursepublish.getCompanyId());<br>    xcChooseCourse.setValidDays(coursepublish.getValidDays());<br>    xcChooseCourse.setStatus(coursepublish.getStatus());<br>    xcChooseCourse.setCoursePrice(0f);<span class="hljs-regexp">//</span>免费课程价格为<span class="hljs-number">0</span><br>    xcChooseCourse.setUserId(userId);<br>    xcChooseCourse.setOrderType(<span class="hljs-string">&quot;700001&quot;</span>);<span class="hljs-regexp">//</span>免费课程<br>    xcChooseCourse.setCreateDate(LocalDateTime.now());<br>    xcChooseCourse.setStatus(<span class="hljs-string">&quot;701001&quot;</span>);<span class="hljs-regexp">//</span>选课成功<br>    xcChooseCourse.setValidDays(<span class="hljs-number">365</span>);<br>    xcChooseCourse.setValidtimeStart(LocalDateTime.now());<br>    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(<span class="hljs-number">365</span>));<br>    xcChooseCourseMapper.insert(xcChooseCourse);<br>    <span class="hljs-keyword">return</span> xcChooseCourse;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>添加我的课程表</strong></p><p>我的课程表的记录来源于选课记录，选课记录成功将课程信息添加到我的课程表。如果我的课程表已存在课程可能已经过期，如果有新的课程记录则需要我的课程表中的现有信息。</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-comment">//添加到我的课程表</span><br>    <span class="hljs-keyword">public</span> XcCourseTables addCourseTables(XcChooseCourse xcChooseCourse)&#123;<br>        <span class="hljs-comment">//选课记录完成且未过期可以添加课程到课程表</span><br>        <span class="hljs-built_in">String</span> status = xcChooseCourse.getStatus();<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;701001&quot;</span>.<span class="hljs-keyword">equals</span>(status))&#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;选课未成功，无法添加到课程表&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//查询我的课程表</span><br>        XcCourseTables xcCourseTables = getXcCourseTables(xcChooseCourse.getUserId(), xcChooseCourse.getCourseId());<br>        <span class="hljs-keyword">if</span> (xcCourseTables!=<span class="hljs-built_in">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> xcCourseTables;<br>        &#125;<br>        XcCourseTables xcCourseTablesNew = <span class="hljs-literal">new</span> XcCourseTables();<br>        xcCourseTablesNew.setChooseCourseId(xcChooseCourse.getId());<br>        xcCourseTablesNew.setUserId(xcChooseCourse.getUserId());<br>        xcCourseTablesNew.setCourseId(xcChooseCourse.getCourseId());<br>        xcCourseTablesNew.setCompanyId(xcChooseCourse.getCompanyId());<br>        xcCourseTablesNew.setCourseName(xcChooseCourse.getCourseName());<br>        xcCourseTablesNew.setCreateDate(LocalDateTime.now());<br>        xcCourseTablesNew.setValidtimeStart(xcChooseCourse.getValidtimeStart());<br>        xcCourseTablesNew.setValidtimeEnd(xcChooseCourse.getValidtimeEnd());<br>        xcCourseTablesNew.setCourseType(xcChooseCourse.getOrderType());<br>        xcCourseTablesMapper.insert(xcCourseTablesNew);<br><br>        <span class="hljs-keyword">return</span> xcCourseTablesNew;<br>    &#125;<br><br>    <span class="hljs-comment">//根据课程和用户查询我的课程表中某一门课程</span><br>    <span class="hljs-keyword">private</span> XcCourseTables getXcCourseTables(<span class="hljs-built_in">String</span> userId, Long courseId) &#123;<br>        XcCourseTables xcCourseTables = xcCourseTablesMapper<br>                .selectOne(<span class="hljs-literal">new</span> LambdaQueryWrapper&lt;XcCourseTables&gt;()<br>                        .<span class="hljs-literal">eq</span>(XcCourseTables<span class="hljs-type">::getUserId</span>, userId)<br>                        .<span class="hljs-literal">eq</span>(XcCourseTables<span class="hljs-type">::getCourseId</span>, courseId));<br>        <span class="hljs-keyword">return</span> xcCourseTables;<br>    &#125;<br></code></pre></td></tr></table></figure><p><strong>添加收费课程</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs perl">//添加收费课程<br>public XcChooseCourse addChargeCourse(String userId,CoursePublish coursepublish)&#123;<br>    <span class="hljs-regexp">//</span>如果存在待支付交易记录直接返回<br>    LambdaQueryWrapper&lt;XcChooseCourse&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();<br>    queryWrapper = queryWrapper.e<span class="hljs-string">q(XcChooseCourse::getUserId,userId)</span><br>            .e<span class="hljs-string">q(XcChooseCourse::getCourseId,coursepublish.getId()</span>)<br>            .e<span class="hljs-string">q(XcChooseCourse::getOrderType, &quot;700002&quot;)</span>//收费订单<br>            .e<span class="hljs-string">q(XcChooseCourse::getStatus, &quot;701002&quot;)</span>;<span class="hljs-regexp">//</span>待支付<br>    List&lt;XcChooseCourse&gt; xcChooseCourses = xcChooseCourseMapper.selectList(queryWrapper);<br>    <span class="hljs-keyword">if</span> (xcChooseCourses!=null&amp;&amp;xcChooseCourses.size()&gt;<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">return</span> xcChooseCourses.get(<span class="hljs-number">0</span>);<br>    &#125;<br>    XcChooseCourse xcChooseCourse = new XcChooseCourse();<br>    xcChooseCourse.setCourseId(coursepublish.getId());<br>    xcChooseCourse.setCourseName(coursepublish.getName());<br>    xcChooseCourse.setCoursePrice(coursepublish.getPrice());<br>    xcChooseCourse.setUserId(userId);<br>    xcChooseCourse.setCompanyId(coursepublish.getCompanyId());<br>    xcChooseCourse.setOrderType(<span class="hljs-string">&quot;700002&quot;</span>);<span class="hljs-regexp">//</span>收费课程<br>    xcChooseCourse.setCreateDate(LocalDateTime.now());<br>    xcChooseCourse.setStatus(<span class="hljs-string">&quot;701002&quot;</span>);<span class="hljs-regexp">//</span>待支付<br><br>    xcChooseCourse.setValidDays(coursepublish.getValidDays());<br>    xcChooseCourse.setValidtimeStart(LocalDateTime.now());<br>    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(coursepublish.getValidDays()));<br>    xcChooseCourseMapper.insert(xcChooseCourse);<br>    <span class="hljs-keyword">return</span> xcChooseCourse;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>获取学习资格</strong></p><p>定义获取学习资格接口</p><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs julia">Java<br>public interface MyCourseTablesService &#123;<br><br>    public XcChooseCourseDto addChooseCourse(<span class="hljs-built_in">String</span> userId, Long courseId);<br>    /**<br>     * <span class="hljs-meta">@description</span> 判断学习资格<br>     * <span class="hljs-meta">@param</span> userId<br>     * <span class="hljs-meta">@param</span> courseId<br>     * <span class="hljs-meta">@return</span> XcCourseTablesDto 学习资格状态 [&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702001&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;正常学习&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702002&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;没有选课或选课后没有支付&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702003&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;已过期需要申请续期或重新支付&quot;</span>&#125;]<br>     * <span class="hljs-meta">@author</span> Mr.M<br>     * <span class="hljs-meta">@date</span> <span class="hljs-number">2022</span>/<span class="hljs-number">10</span>/<span class="hljs-number">3</span> <span class="hljs-number">7</span>:<span class="hljs-number">37</span><br>     */<br>    public XcCourseTablesDto getLearningStatus(<span class="hljs-built_in">String</span> userId, Long courseId);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>接口实现如下：</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">Java<br><span class="hljs-operator">/**</span><br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span>description 判断学习资格<br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span>param userId<br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span>param courseId<br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span><span class="hljs-keyword">return</span> XcCourseTablesDto 学习资格状态 [&#123;<span class="hljs-string">&quot;code&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;702001&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;正常学习&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;702002&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;没有选课或选课后没有支付&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;702003&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;已过期需要申请续期或重新支付&quot;</span>&#125;]<br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span>author Mr.M<br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span>date <span class="hljs-number">2022</span><span class="hljs-operator">/</span><span class="hljs-number">10</span><span class="hljs-operator">/</span><span class="hljs-number">3</span> <span class="hljs-number">7</span><span class="hljs-operator">:</span>37<br><span class="hljs-operator">*/</span><br><span class="hljs-keyword">public</span> XcCourseTablesDto getLearningStatus(String userId, Long courseId)&#123;<br>    <span class="hljs-comment">//查询我的课程表</span><br>    XcCourseTables xcCourseTables <span class="hljs-operator">=</span> getXcCourseTables(userId, courseId);<br>    <span class="hljs-keyword">if</span>(xcCourseTables<span class="hljs-operator">==</span><span class="hljs-literal">null</span>)&#123;<br>        XcCourseTablesDto xcCourseTablesDto <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> XcCourseTablesDto();<br>        <span class="hljs-comment">//没有选课或选课后没有支付</span><br>        xcCourseTablesDto.setLearnStatus(<span class="hljs-string">&quot;702002&quot;</span>);<br>        <span class="hljs-keyword">return</span> xcCourseTablesDto;<br>    &#125;<br>    XcCourseTablesDto xcCourseTablesDto <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> XcCourseTablesDto();<br>    BeanUtils.copyProperties(xcCourseTables,xcCourseTablesDto);<br>    <span class="hljs-comment">//是否过期,true过期，false未过期</span><br>    boolean isExpires <span class="hljs-operator">=</span> xcCourseTables.getValidtimeEnd().isBefore(LocalDateTime.now());<br>    <span class="hljs-keyword">if</span>(<span class="hljs-operator">!</span>isExpires)&#123;<br>        <span class="hljs-comment">//正常学习</span><br>        xcCourseTablesDto.setLearnStatus(<span class="hljs-string">&quot;702001&quot;</span>);<br>       <span class="hljs-keyword">return</span> xcCourseTablesDto;<br><br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-comment">//已过期</span><br>        xcCourseTablesDto.setLearnStatus(<span class="hljs-string">&quot;702003&quot;</span>);<br>        <span class="hljs-keyword">return</span> xcCourseTablesDto;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p> <strong>service接口完善</strong></p><p>完善Service接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> XcChooseCourseDto <span class="hljs-title function_">addChooseCourse</span><span class="hljs-params">(String userId,Long courseId)</span> &#123;<br>    <span class="hljs-comment">//查询课程信息</span><br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursepublish</span> <span class="hljs-operator">=</span> contentServiceClient.getCoursepublish(courseId);<br>    <span class="hljs-comment">//课程收费标准</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">charge</span> <span class="hljs-operator">=</span> coursepublish.getCharge();<br>    <span class="hljs-comment">//选课记录</span><br>    <span class="hljs-type">XcChooseCourse</span> <span class="hljs-variable">chooseCourse</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;201000&quot;</span>.equals(charge))&#123;<span class="hljs-comment">//课程免费</span><br>        <span class="hljs-comment">//添加免费课程</span><br>        chooseCourse  = addFreeCourse(userId, coursepublish);<br>        <span class="hljs-comment">//添加到我的课程表</span><br>        <span class="hljs-type">XcCourseTables</span> <span class="hljs-variable">xcCourseTables</span> <span class="hljs-operator">=</span> addCourseTables(chooseCourse);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-comment">//添加收费课程</span><br>        chooseCourse  = addChargeCourse(userId, coursepublish);<br>    &#125;<br>    <span class="hljs-type">XcChooseCourseDto</span> <span class="hljs-variable">xcChooseCourseDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XcChooseCourseDto</span>();<br>    BeanUtils.copyProperties(chooseCourse,xcChooseCourseDto);<br>    <span class="hljs-comment">//获取学习资格</span><br>    <span class="hljs-type">XcCourseTablesDto</span> <span class="hljs-variable">xcCourseTablesDto</span>  <span class="hljs-operator">=</span> getLearningStatus(userId, courseId);<br>    xcChooseCourseDto.setLearnStatus(xcCourseTablesDto.getLearnStatus());<br>    <span class="hljs-keyword">return</span> xcChooseCourseDto;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>完善controller</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@Autowired</span><br>MyCourseTablesService courseTablesService;<br><br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;添加选课&quot;</span>)</span><br><span class="hljs-meta">@PostMapping(<span class="hljs-string">&quot;/choosecourse/&#123;courseId&#125;&quot;</span>)</span><br><span class="hljs-keyword">public</span> XcChooseCourseDto addChooseCourse(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> courseId) &#123;<br>    <span class="hljs-comment">//登录用户</span><br>    SecurityUtil.XcUser user = SecurityUtil.getUser();<br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;请登录后继续选课&quot;</span>);<br>    &#125;<br>    String userId = user.getId();<br>    <span class="hljs-keyword">return</span>  courseTablesService.addChooseCourse(userId, courseId);<br><br>&#125;<br><br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;查询学习资格&quot;</span>)</span><br><span class="hljs-meta">@PostMapping(<span class="hljs-string">&quot;/choosecourse/learnstatus/&#123;courseId&#125;&quot;</span>)</span><br><span class="hljs-keyword">public</span> XcCourseTablesDto getLearnstatus(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> courseId) &#123;<br>    <span class="hljs-comment">//登录用户</span><br>    SecurityUtil.XcUser user = SecurityUtil.getUser();<br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;请登录后继续选课&quot;</span>);<br>    &#125;<br>    String userId = user.getId();<br>    <span class="hljs-keyword">return</span>  courseTablesService.getLeanringStatus(userId, courseId);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h5><h6 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a><strong>单元测试</strong></h6><p>1、准备测试环境</p><p>发布两门课程，一门为免费，一门为收费。</p><p>小技巧：可以更改课程发布表已有课程的收费标准进行测试。</p><p>2、测试添加免费课程</p><p>成功：选课记录表一条记录、我的课程表一条记录。</p><p>3、测试添加收费课程</p><p>成功：选课记录表一条记录</p><p>4、重复添加选课</p><p>重复添加相同的课程，观察是否存在异常。</p><p>5、生成令牌，为方便生成令牌暂时将PasswordAuthServiceImpl类中的验证码屏蔽</p><p>6、使用httpclient测试如下：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs llvm">Bash<br>### 添加选课<br>POST &#123;&#123;learning_host&#125;&#125;/learning/choosecourse/<span class="hljs-number">2</span><br>Authorization: Bearer eyJhbGciOiJIUzI<span class="hljs-number">1</span>NiIsInR<span class="hljs-number">5</span>cCI<span class="hljs-number">6</span>IkpXVCJ<span class="hljs-number">9</span>.eyJhdWQiOlsieHVlY<span class="hljs-number">2</span>hlbmctcGx<span class="hljs-number">1</span>cyJdLCJ<span class="hljs-number">1</span><span class="hljs-keyword">c</span><span class="hljs-number">2</span>VyX<span class="hljs-number">25</span>hbWUiOiJ<span class="hljs-number">7</span>XCJiaXJ<span class="hljs-number">0</span>aGRheVwiOlwiMjAyMi<span class="hljs-number">0</span>wOS<span class="hljs-number">0</span>yOFQxOToyODo<span class="hljs-number">0</span>NlwiLFwiY<span class="hljs-number">3</span>JlYXRlVGltZVwiOlwiMjAyMi<span class="hljs-number">0</span>wOS<span class="hljs-number">0</span>yOFQwODozMjowM<span class="hljs-number">1</span>wiLFwiaWRcIjpcIjUwXCIsXCJuYW<span class="hljs-number">1</span>lXCI<span class="hljs-number">6</span>XCLlrabnlJ<span class="hljs-number">8</span>xXCIsXCJuaWNrbmFtZVwiOlwi<span class="hljs-number">5</span>aSn<span class="hljs-number">5</span>rC<span class="hljs-number">054</span>mbXCIsXCJwZXJtaXNzaW<span class="hljs-number">9</span>uc<span class="hljs-number">1</span>wiOltcInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJcIixcInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJfdXNlclwiLFwieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">91</span><span class="hljs-keyword">c</span><span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>FkZFwiLFwieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">91</span><span class="hljs-keyword">c</span><span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>VkaXRcIixcInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJfdXNlcl<span class="hljs-number">92</span>aWV<span class="hljs-number">3</span>XCIsXCJ<span class="hljs-number">4</span>Y<span class="hljs-number">19</span>zeXNtYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">3</span>VzZXJfZGVsZXRlXCIsXCJ<span class="hljs-number">4</span>Y<span class="hljs-number">19</span>zeXNtYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>RvY<span class="hljs-number">1</span>wiLFwieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">9</span>sb<span class="hljs-number">2</span>dcIixcInhjX<span class="hljs-number">3</span>RlYWNobWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">3</span>Vyc<span class="hljs-number">2</span>VcIixcInhjX<span class="hljs-number">3</span>RlYWNobWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">3</span>Vyc<span class="hljs-number">2</span>VfYWRkXCIsXCJ<span class="hljs-number">4</span>Y<span class="hljs-number">190</span>ZWFjaG<span class="hljs-number">1</span>hbmFnZXJfY<span class="hljs-number">291</span>cnNlX<span class="hljs-number">2</span>Jhc<span class="hljs-number">2</span>VcIixcInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJfY<span class="hljs-number">29</span>tcGFueVwiLFwieGNfdGVhY<span class="hljs-number">2</span>htYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>NvdXJzZV<span class="hljs-number">9</span>saXN<span class="hljs-number">0XC</span>JdLFwic<span class="hljs-number">2</span>V<span class="hljs-number">4</span>XCI<span class="hljs-number">6</span>XCIxXCIsXCJzdGF<span class="hljs-number">0</span>dXNcIjpcIjFcIixcInVzZXJuYW<span class="hljs-number">1</span>lXCI<span class="hljs-number">6</span>XCJzdHUxXCIsXCJ<span class="hljs-number">1</span><span class="hljs-keyword">c</span><span class="hljs-number">2</span>VycGljXCI<span class="hljs-number">6</span>XCJodHRwOi<span class="hljs-number">8</span>vZmlsZS<span class="hljs-number">54</span>dWVjaGVuZy<span class="hljs-number">1</span>wbHVzLmNvbS<span class="hljs-number">9</span>kZGRmXCIsXCJ<span class="hljs-number">1</span>dHlwZVwiOlwiMTAxMDAxXCJ<span class="hljs-number">9</span>Iiwic<span class="hljs-number">2</span>NvcGUiOlsiYWxsIl<span class="hljs-number">0</span>sImV<span class="hljs-number">4</span>cCI<span class="hljs-number">6</span>MTY<span class="hljs-number">2</span>NzI<span class="hljs-number">5</span>OTQwNiwiYXV<span class="hljs-number">0</span>aG<span class="hljs-number">9</span>yaXRpZXMiOlsieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">9</span>kb<span class="hljs-number">2</span>MiLCJ<span class="hljs-number">4</span>Y<span class="hljs-number">19</span>zeXNtYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">3</span>VzZXJfdmlldyIsInhjX<span class="hljs-number">3</span>RlYWNobWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">3</span>Vyc<span class="hljs-number">2</span>UiLCJ<span class="hljs-number">4</span>Y<span class="hljs-number">19</span>zeXNtYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">3</span>VzZXJfYWRkIiwieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">21</span>wYW<span class="hljs-number">55</span>IiwieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">91</span><span class="hljs-keyword">c</span><span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>RlbGV<span class="hljs-number">0</span>ZSIsInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJfdXNlciIsInhjX<span class="hljs-number">3</span>RlYWNobWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">3</span>Vyc<span class="hljs-number">2</span>VfYmFzZSIsInhjX<span class="hljs-number">3</span>RlYWNobWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">3</span>Vyc<span class="hljs-number">2</span>VfbGlzdCIsInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXIiLCJ<span class="hljs-number">4</span>Y<span class="hljs-number">19</span>zeXNtYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>xvZyIsInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJfdXNlcl<span class="hljs-number">9</span>lZGl<span class="hljs-number">0</span>IiwieGNfdGVhY<span class="hljs-number">2</span>htYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>NvdXJzZV<span class="hljs-number">9</span>hZGQiXSwianRpIjoiOTYyOTYzMWQtYjRiMC<span class="hljs-number">00</span>NTlkLTgzYzktM<span class="hljs-number">2</span>Q<span class="hljs-number">4</span>MmRiNmI<span class="hljs-number">4</span>NDEzIiwiY<span class="hljs-number">2</span>xpZW<span class="hljs-number">50</span>X<span class="hljs-number">2</span>lkIjoiWGNXZWJBcHAifQ.b<span class="hljs-number">77</span>ZreiNlPoN-_dnAWxuBfH<span class="hljs-number">32</span>tPIoRwg<span class="hljs-number">2</span>ePgKn_aZ<span class="hljs-number">8</span><span class="hljs-keyword">c</span><br><br></code></pre></td></tr></table></figure><h6 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a><strong>前后端联调</strong></h6><p>测试流程：</p><p>1、启动认证服务、网关服务、验证码服务、学习中心服务、内容管理服务。</p><p>2、发布一门免费课程、一门收费课程</p><p>3、进入课程详情界面，点击“马上学习”</p><p>4、报名成功，自动跳转到学习界面。</p><p>5、观察选课记录表、我的课程表数据是否正确。</p><p>对于免费课程在课程详情页面点击“马上学习”，通过引导界面添加选课。</p><p>1、进入课程详情点击马上学习</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227210354604.png" alt="image-20231227210354604" style="zoom:50%;" /><p>2、课程免费时引导加入我的课程表、或进入学习界面。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227210412122.png" alt="image-20231227210412122" style="zoom:50%;" /><h3 id="支付"><a href="#支付" class="headerlink" title="支付"></a>支付</h3><h5 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h5><h6 id="执行流程-1"><a href="#执行流程-1" class="headerlink" title="执行流程"></a>执行流程</h6><p>用户去学习收费课程时引导其去支付，如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227220253997.png" alt="image-20231227220253997"></p><p>当用户点击“微信支付”或支付宝支付时执行流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227220317702.png" alt="image-20231227220317702"></p><ol><li>请求学习中心服务创建选课记录</li><li>请求订单服务创建商品订单，生成支付二维码</li><li>用户扫码请求订单支付服务，订单支付服务请求第三方支付平台生成支付订单</li><li>前端唤起支付客户端，用户输入密码完成支付</li><li>第三方支付平台支付完成支付通知</li><li>订单支付服务接收第三方支付通知结果</li><li>用户在前端查询支付结果，请求订单支付服务查询支付结果</li><li>订单支付服务向学习中心服务通知支付结果</li><li>学习中心服务收到支付结果，如果支付成功则更新选课记录，并添加到我的课程表</li></ol><h6 id="通用订单服务设计"><a href="#通用订单服务设计" class="headerlink" title="通用订单服务设计"></a><strong>通用订单服务设计</strong></h6><p>在本项目中不仅选课需要下单、购买学习资料、老师一对一答疑等所以收费项目都需要下单支付。</p><p>所以本项目设计通用的订单服务，通用的订单服务承接各业务模块的收费支付需求，当用户需要交费时统一生成商品订单并进行支付。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222035987.png" alt="image-20231227222035987" style="zoom:50%;" /><p>所有收费业务最终转换为商品订单记录在订单服务的<code>商品订单表</code>。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222119819.png" alt="image-20231227222119819" style="zoom:33%;" /><p>以选课为例，选课记录表的ID记录在商品订单表的out_business_id字段。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222135726.png" alt="image-20231227222135726" style="zoom:50%;" /><h5 id="支付接口调研"><a href="#支付接口调研" class="headerlink" title="支付接口调研"></a><strong>支付接口调研</strong></h5><h6 id="微信支付接口调研"><a href="#微信支付接口调研" class="headerlink" title="微信支付接口调研"></a><strong>微信支付接口调研</strong></h6><p>一般情况下，一个网站要支持在线支付功能通常接入第三方支付平台，比如：微信支付、支付宝、其它的聚合支付平台。</p><p>本项目的需求实现手机扫码支付，现在对微信、支付宝的支付接口进行调研。</p><p>微信目前提供的支付方式如下：</p><p>地址：<a href="https://pay.weixin.qq.com/static/product/product_index.shtml">https://pay.weixin.qq.com/static/product/product_index.shtml</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222217090.png" alt="image-20231227222217090" style="zoom:67%;" /><p>1、付款码支付是指用户展示微信钱包内的“付款码”给商户系统扫描后直接完成支付，适用于线下场所面对面收银的场景，例如商超、便利店、餐饮、医院、学校、电影院和旅游景区等具有明确经营地址的实体场所。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222239304.png" alt="image-20231227222239304" style="zoom:67%;" /><p>2、JSAPI支付是指商户通过调用微信支付提供的JSAPI接口，在支付场景中调起微信支付模块完成收款</p><p>线下场所：调用接口生成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p><p>公众号场景：用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付</p><p>PC网站场景：在网站中展示二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222332267.png" alt="image-20231227222332267" style="zoom:50%;" /><p>3、小程序支付是指商户通过调用微信支付小程序支付接口，在微信小程序平台内实现支付功能；用户打开商家助手小程序下单，输入支付密码并完成支付后，返回商家小程序。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222351730.png" alt="image-20231227222351730" style="zoom:67%;" /><p>4、Native支付是指商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站、实体店单品或订单、媒体广告支付等场景。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222526187.png" alt="image-20231227222526187"></p><p>5、APP支付是指商户通过在移动端应用APP中集成开放SDK调起微信支付模块来完成支付。适用于在移动端APP中集成微信支付功能的场景。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222546668.png" alt="image-20231227222546668"></p><p>6、刷脸支付是指用户在刷脸设备前通过摄像头刷脸、识别身份后进行的一种支付方式，安全便捷。适用于线下实体场所的收银场景，如商超、餐饮、便利店、医院、学校等。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222558986.png" alt="image-20231227222558986"></p><p>以上接口native和JSAPI都可以实现pc网站实现扫码支付，两者区别是什么？怎么选择？</p><p>JSAPI除了在pc网站扫码支付还可以实现公众号页面内支付，可以实现在手机端H5页面唤起微信客户端完成支付。</p><p>本项目选择JSAPI支付接口。</p><p>接口文档：<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml</a></p><p>如何开通JSAPI支付接口?</p><p>以企业身份注册微信公众号<a href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com/</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222720763.png" alt="image-20231227222720763" style="zoom:50%;" /><p>登录公众号，点击左侧菜单“微信支付”开通微信支付，如下：</p><p>需要提供营业执照、身份证等信息。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222732135.png" alt="image-20231227222732135" style="zoom:67%;" /><p>点击申请接入，需要注册微信商户号。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222748812.png" alt="image-20231227222748812"></p><p>注册微信商户号的过程请参考官方文档，本文档略。参考地址如下：</p><p><a href="https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none">https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none</a></p><p>开通微信支付后即可在微信商户平台（pay.weixin.qq.com）开通JSAPI支付。</p><p>登录商品平台，进入产品中心，开通JSAPI支付：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222759514.png" alt="image-20231227222759514"></p><p>注意：JSAPI支付方式需要在公众号配置回调域名，此域名为已经备案的外网域名。</p><p>最后在公众号开发信息中获取：开发者id、开发者密码。</p><h6 id="支付宝接口调研"><a href="#支付宝接口调研" class="headerlink" title="支付宝接口调研"></a><strong>支付宝接口调研</strong></h6><p>支付宝支付产品如下：</p><p>文档：<a href="https://b.alipay.com/signing/productSetV2.htm">https://b.alipay.com/signing/productSetV2.htm</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222846119.png" alt="image-20231227222846119"></p><p>与本项目需求相关的接口：电脑网站支付、手机网站支付。</p><p>1、电脑网站支付</p><p>PC网站轻松收款，资金马上到账：用户在商家PC网站消费，自动跳转支付宝PC网站收银台完成付款。 交易资金直接打入商家支付宝账户，实时到账。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222856243.png" alt="image-20231227222856243"></p><p>2、手机网站支付</p><p>用户在商家手机网站消费，通过浏览器自动跳转支付宝APP或支付宝网页完成付款。 轻松实现和APP支付相同的支付体验。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222910116.png" alt="image-20231227222910116"></p><p>对比两种支付方式：手机网站支付方式可以在H5网页唤起支付宝，手机扫码支付可以使用手机网站支付方式来完成，相比电脑网站支付形式更灵活。</p><p>本项目选择手机网站支付方式。</p><p>文档：<a href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p><p>如何开通支付宝手机网站支付接口？</p><p>进入网址：<a href="https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001">https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001</a></p><p>点击：立即开通</p><p>上传营业执照等资料，提交审核，根据提示进行开通。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227222955798.png" alt="image-20231227222955798"></p><h4 id="准备开发环境"><a href="#准备开发环境" class="headerlink" title="准备开发环境"></a><strong>准备开发环境</strong></h4><h5 id="支付宝开发环境"><a href="#支付宝开发环境" class="headerlink" title="支付宝开发环境"></a><strong>支付宝开发环境</strong></h5><p>第三方支付接口流程大同小异，考虑开发及教学的方便性，支付宝提供支付宝沙箱环境开发支付接口，在教学中接入支付宝手机网站支付接口。</p><p>1、配置沙箱环境</p><p>沙箱环境是支付宝开放平台为开发者提供的与生产环境完全隔离的联调测试环境，开发者在沙箱环境中完成的接口调用不会对生产环境中的数据造成任何影响。</p><p>接入手机网站支付需要具备如下条件：</p><p>•     申请前必须拥有经过实名认证的支付宝账户；</p><p>•     企业或个体工商户可申请；</p><p>•     需提供真实有效的营业执照，且支付宝账户名称需与营业执照主体一致；</p><p>•     网站能正常访问且页面显示完整，网站需要明确经营内容且有完整的商品信息；</p><p>•     网站必须通过ICP备案。如为个体工商户，网站备案主体需要与支付宝账户主体名称一致；</p><p>•     如为个体工商户，则团购不开放，且古玩、珠宝等奢侈品、投资类行业无法申请本产品。</p><p>详细参见：<a href="https://docs.open.alipay.com/203">https://docs.open.alipay.com/203</a></p><p>本文档使用支付宝沙箱进行开发测试，这里主要介绍支付宝沙箱环境配置。</p><p>详细参见：<a href="https://docs.open.alipay.com/200/105311/">https://docs.open.alipay.com/200/105311/</a></p><p>2、模拟器</p><p>下载模拟器：<a href="http://mumu.163.com/">http://mumu.163.com/</a></p><p>安装模拟器，安装在没有空格和中文的目录。</p><p>安装成功，启动模拟器</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227223708482.png" alt="image-20231227223708482" style="zoom:67%;" /><p>下一步在模拟器安装支付宝：</p><p>选择课程资料中支付宝安装包wallet_101521226_client_release_201812261416.apk（沙箱版本）</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227223728162.png" alt="image-20231227223728162"></p><p>安装成功后支付宝客户端的快捷方式出现在桌面上。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227223737861.png" alt="image-20231227223737861"></p><p>使用沙箱环境的买家账号登录沙箱版本的支付宝。</p><p>查看沙箱环境的账号</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227223753507.png" alt="image-20231227223753507"></p><h5 id="创建订单服务"><a href="#创建订单服务" class="headerlink" title="创建订单服务"></a><strong>创建订单服务</strong></h5><p>拷贝课程资料目录下的订单服务工程xuecheng-plus-orders到自己的工程目录。1</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227223819177.png" alt="image-20231227223819177" style="zoom:50%;" /><p>创建xc_orders数据库，并导入xcplus_orders.sql </p><p>修改nacos中orders-service-dev.yaml的数据库连接参数</p><h4 id="支付接口测试"><a href="#支付接口测试" class="headerlink" title="支付接口测试"></a><strong>支付接口测试</strong></h4><h5 id="阅读接口定义"><a href="#阅读接口定义" class="headerlink" title="阅读接口定义"></a><strong>阅读接口定义</strong></h5><p>手机网站支付接入流程详细参见：<a href="https://docs.open.alipay.com/203/105285/">https://docs.open.alipay.com/203/105285/</a></p><p>1、接口交互流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227224325344.png" alt="image-20231227224325344"></p><ol><li>用户在商户的H5网站下单支付后，商户系统按照<a href="https://docs.open.alipay.com/203/107090">手机网站支付接口alipay.trade.wap.pay</a>API的参数规范生成订单数据</li><li>前端页面通过Form表单形式请求到支付宝，此时支付宝自动将页面跳转至支付宝H5收银台页面，如果用户手机安装了支付宝APP，则自动唤起支付宝APP</li><li>输入支付密码完成支付</li><li>用户在支付宝APP或H5收银台完成支付后，会根据商户在手机网站支付API中传入的前台回跳地址return_url自动跳转回商户页面，同时在URL请求中以Query String的形式附带上支付结果参数，详细回跳参数见“手机网站支付接口alipay.trade.wap.pay”<a href="https://docs.open.alipay.com/203/107090#s2">前台回跳参数</a>。</li><li>支付宝会根据原始支付API中传入的异步通知地址notify_url, 通过POST请求形式将支付结果作为参数通知到商户系统，详情见<a href="https://docs.open.alipay.com/203/105286">支付结果异步通知</a>。</li></ol><p>2、接口定义</p><p>文档：<a href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p><p>接口定义：外部商户请求支付宝创建订单并支付</p><p>公共参数</p><p><strong>请求地址</strong>：</p><p>开发中使用沙箱地址：<a href="https://openapi.alipaydev.com/gateway.do">https://openapi.alipaydev.com/gateway.do</a></p><p>请求参数：</p><p>详细查阅<a href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p><p>一部分由sdk设置，一部分需要编写程序时指定。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228105119750.png" alt="image-20231228105119750"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228105127061.png" alt="image-20231228105127061"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228105132882.png" alt="image-20231228105132882"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228105136481.png" alt="image-20231228105136481"></p><p>其它扩展参数参见接口文档。</p><p>3、示例代码</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-type">Java</span><br><span class="hljs-keyword">public</span> void doPost(<span class="hljs-type">HttpServletRequest</span> httpRequest,<br>                   <span class="hljs-type">HttpServletResponse</span> httpResponse) <span class="hljs-keyword">throws</span> <span class="hljs-type">ServletException</span>, <span class="hljs-type">IOException</span> &#123;<br>    <span class="hljs-type">AlipayClient</span> alipayClient <span class="hljs-operator">=</span> <span class="hljs-operator">...</span> <span class="hljs-comment">//获得初始化的AlipayClient</span><br>    <span class="hljs-type">AlipayTradeWapPayRequest</span> alipayRequest <span class="hljs-operator">=</span> new <span class="hljs-type">AlipayTradeWapPayRequest</span>();<span class="hljs-comment">//创建API对应的request</span><br>    alipayRequest.setReturnUrl(<span class="hljs-string">&quot;http://domain.com/CallBack/return_url.jsp&quot;</span>);<br>    alipayRequest.setNotifyUrl(<span class="hljs-string">&quot;http://domain.com/CallBack/notify_url.jsp&quot;</span>);<span class="hljs-comment">//在公共参数中设置回跳和通知地址</span><br>    alipayRequest.setBizContent(<span class="hljs-string">&quot;&#123;&quot;</span> <span class="hljs-operator">+</span><br>            <span class="hljs-string">&quot;    <span class="hljs-subst">\&quot;</span>out_trade_no<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>20150320010101002<span class="hljs-subst">\&quot;</span>,&quot;</span> <span class="hljs-operator">+</span><br>            <span class="hljs-string">&quot;    <span class="hljs-subst">\&quot;</span>total_amount<span class="hljs-subst">\&quot;</span>:88.88,&quot;</span> <span class="hljs-operator">+</span><br>            <span class="hljs-string">&quot;    <span class="hljs-subst">\&quot;</span>subject<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>Iphone6 16G<span class="hljs-subst">\&quot;</span>,&quot;</span> <span class="hljs-operator">+</span><br>            <span class="hljs-string">&quot;    <span class="hljs-subst">\&quot;</span>product_code<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>QUICK_WAP_WAY<span class="hljs-subst">\&quot;</span>&quot;</span> <span class="hljs-operator">+</span><br>            <span class="hljs-string">&quot;  &#125;&quot;</span>);<span class="hljs-comment">//填充业务参数</span><br>    <span class="hljs-type">String</span> form <span class="hljs-operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="hljs-comment">//调用SDK生成表单</span><br>    httpResponse.setContentType(<span class="hljs-string">&quot;text/html;charset=&quot;</span> <span class="hljs-operator">+</span> <span class="hljs-type">AlipayServiceEnvConstants</span>.<span class="hljs-type">CHARSET</span>);<br>    httpResponse.getWriter().write(form);<span class="hljs-comment">//直接将完整的表单html输出到页面</span><br>    httpResponse.getWriter().flush();<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="下单执行流程"><a href="#下单执行流程" class="headerlink" title="下单执行流程"></a><strong>下单执行流程</strong></h5><p>根据接口描述，支付宝下单接口的执行流程如下：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228122017158.png" alt="image-20231228122017158" style="zoom:50%;" /><h5 id="支付接口测试-1"><a href="#支付接口测试-1" class="headerlink" title="支付接口测试"></a><strong>支付接口测试</strong></h5><h6 id="编写下单代码"><a href="#编写下单代码" class="headerlink" title="编写下单代码"></a><strong>编写下单代码</strong></h6><p>根据接口流程，首先在订单服务编写测试类请求支付宝下单的接口。</p><p>在订单服务api工程添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml">XML<br><span class="hljs-comment">&lt;!-- 支付宝SDK --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alipay.sdk<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>alipay-sdk-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.7.73.ALL<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 支付宝SDK依赖的日志 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>下载示例代码<a href="https://opendocs.alipay.com/open/203/105910">https://opendocs.alipay.com/open/203/105910</a></p><p>拷贝示例代码，修改、测试。</p><p>拷贝AlipayConfig.java到订单服务的service工程</p><p>编写测试PayTestController</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.orders.api;<br><br><span class="hljs-keyword">import</span> com.alipay.api.AlipayApiException;<br><span class="hljs-keyword">import</span> com.alipay.api.AlipayClient;<br><span class="hljs-keyword">import</span> com.alipay.api.DefaultAlipayClient;<br><span class="hljs-keyword">import</span> com.alipay.api.request.AlipayTradeWapPayRequest;<br><span class="hljs-keyword">import</span> com.xuecheng.orders.config.AlipayConfig;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 测试支付宝接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/20 22:19</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayTestController</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;pay.alipay.APP_ID&#125;&quot;)</span><br>    String APP_ID;<br>    <span class="hljs-meta">@Value(&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;)</span><br>    String APP_PRIVATE_KEY;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;)</span><br>    String ALIPAY_PUBLIC_KEY;<br><br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;/alipaytest&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest httpRequest,</span><br><span class="hljs-params">                       HttpServletResponse httpResponse)</span> <span class="hljs-keyword">throws</span> ServletException, IOException, AlipayApiException &#123;<br>        <span class="hljs-type">AlipayClient</span> <span class="hljs-variable">alipayClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY,AlipayConfig.SIGNTYPE);<br>        <span class="hljs-comment">//获得初始化的AlipayClient</span><br>        <span class="hljs-type">AlipayTradeWapPayRequest</span> <span class="hljs-variable">alipayRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayTradeWapPayRequest</span>();<span class="hljs-comment">//创建API对应的request</span><br><span class="hljs-comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span><br><span class="hljs-comment">//        alipayRequest.setNotifyUrl(&quot;http://domain.com/CallBack/notify_url.jsp&quot;);//在公共参数中设置回跳和通知地址</span><br>        alipayRequest.setBizContent(<span class="hljs-string">&quot;&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;out_trade_no\&quot;:\&quot;202210100010101002\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;total_amount\&quot;:0.1,&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;subject\&quot;:\&quot;Iphone6 16G\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;product_code\&quot;:\&quot;QUICK_WAP_WAY\&quot;&quot;</span> +<br>                <span class="hljs-string">&quot;  &#125;&quot;</span>);<span class="hljs-comment">//填充业务参数</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">form</span> <span class="hljs-operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="hljs-comment">//调用SDK生成表单</span><br>        httpResponse.setContentType(<span class="hljs-string">&quot;text/html;charset=&quot;</span> + AlipayConfig.CHARSET);<br>        httpResponse.getWriter().write(form);<span class="hljs-comment">//直接将完整的表单html输出到页面</span><br>        httpResponse.getWriter().flush();<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h6 id="生成二维码"><a href="#生成二维码" class="headerlink" title="生成二维码"></a><strong>生成二维码</strong></h6><p>用户在前端使用支付宝沙箱通过扫码请求下单接口，我们需要生成订单服务的下单接口的二维码。</p><p>ZXing是一个开源的类库，是用Java编写的多格式的1D &#x2F; 2D条码图像处理库，使用ZXing可以生成、识别QR Code（二维码）。常用的二维码处理库还有zbar，近几年已经不再更新代码，下边介绍ZXing生成二维码的方法。</p><p>1）引入依赖</p><p>在base工程pom.xml中添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml">XML<br>        <span class="hljs-comment">&lt;!-- 二维码生成&amp;识别组件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.zxing<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.zxing<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javase<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>2）生成二维码方法</p><p>拷贝课程资料中utils下的QRCodeUtil.java到base工程util包下。</p><p>测试根据内容生成二维码方法，在QRCodeUtil中添加main方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">QRCodeUtil</span> <span class="hljs-variable">qrCodeUtil</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QRCodeUtil</span>();<br>        System.out.println(qrCodeUtil.createQRCode(<span class="hljs-string">&quot;http://www.itcast.cn/&quot;</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>));<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>运行main方法输入二维码图片的base64串，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">Bash<br>data:image/png;<span class="hljs-built_in">base64</span>,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABQElEQVR42u2YPZKDMAyF5aFIuUfIUThafDSOwhEoUzC8fZKMySSbrVI8ZuICBX8uIvtZPxjeDfuSf8liPi7LFSgrzRTvV3XCKawXYLptFobviz6ZzB2xEfTjhyS9OwXB3A7jbMSngLOQ0I4v2AZf96wqTWJ9+9/dYEHSx2RYqfg/oqUgiX3nFBVfcCepcSbiJP67iwZ1G+5+Am7kyTzW9OcW/kRAX+QJ953+uCl8zO5PV5UsaffUp8rqP5+jiySJU8jtNxcNrysetCNK6A/V4lEQeU+xa0eZREE1tOTpFYod0VKXsKCqvRqMkW5pkza8Ggy3WgEuTvZcz0dcUBc+9MneL1DqkXjQz0eaZA1LqVtmzcMffTKPiPwz1mh2zkGyNwtT9kguTVI7LWv6ul7DCpOjX9iaGV66HDny/ZL1WfILfc/hMHLUpekAAAAASUVORK5CYII=<br><br><br></code></pre></td></tr></table></figure><p>将base64串复制到浏览器地址后回车将展示一个二维码，用户用手机扫此二维码将请求至<a href="http://www.itcast.cn/%E3%80%82">http://www.itcast.cn/。</a><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228122951520.png" alt="image-20231228122951520" style="zoom:25%;" /></p><h6 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h6><p>1、生成订单服务下单接口的二维码</p><p>修改二维码生成的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>      <span class="hljs-type">QRCodeUtil</span> <span class="hljs-variable">qrCodeUtil</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QRCodeUtil</span>();<br>      System.out.println(qrCodeUtil.createQRCode(<span class="hljs-string">&quot;http://localhost:63030/orders/alipaytest&quot;</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>注意：<a href="http://localhost:63030地址用模拟器无法访问，进入cmd命令状态，输入命令ipconfig">http://localhost:63030地址用模拟器无法访问，进入cmd命令状态，输入命令ipconfig</a> -all 查看本地网卡分配的局域网ip地址，将上边的地址修改如下</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade">Plain <span class="hljs-built_in">Text</span><br>http:<span class="hljs-comment">//192.168.101.1:63030/orders/alipaytest</span><br><br></code></pre></td></tr></table></figure><p>运行main方法，复制输出到控制台的base64串。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">Bash<br>data:image/png;<span class="hljs-built_in">base64</span>,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABxUlEQVR42u2YO46EMBBEGxE45AjcBC6GhCUuNtzER3DoANFbZT4zu9KmNavVOLAwj6BV/TXmvy37kL9Oopl1sS+DWV/M2oRzKyWL+95tfXDfenyzJK/vlCTZ0G1WGpzDDlKA9ST2YbfJrMnz2wiE8WQw8A2E/lkc6kQ66afnBKTGKCwaru179ApIXVBnzNb7gy+/ZbCAQJgB5zLCyrD6ZnSSlPAxm1VNyphh28NmKUFI7F3EQ55qrXJfL3VUBOGZJyssF74C45tWSjbEBW2DJslG94QPtQTNYsyzH9WSrgmXOiqCCBlgFmIUhMLwKCVcSFHkxsaagcY1vmSwgkRDZE5WO4YzT6tYSuIprNTEzskBedq5lNS4wEs2TOiEbT1tUxGslaW6OoX98+5ZKhLpmhYFi8LsTNY7T1WE7apNzE5UCgiDD2cpca+T612v0zNGZYQWMVDhJG7h2dE1BOoMSIujUjQcZUYxOWcXBodzeuKmJdddhtNTqZNcc1cxDTnuMmwbxr7dup5wjl8S44J9O75Mdkpyzo1hr/eqV9tUBE+8waBy80p1T3YictxpDyexcQUXk+Muw9m5RohZnWKU5PMX55+RLyKnzJvqtaeFAAAAAElFTkSuQmCC<br><br><br></code></pre></td></tr></table></figure><p>打开模拟器，在模拟器中打开浏览器，将base64串复制到浏览器的地址栏。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228123118940.png" alt="image-20231228123118940" style="zoom:50%;" /><p>使用截屏工具进行截屏，稍后使用支付宝沙箱客户端扫此图片。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228123217999.png" alt="image-20231228123217999"></p><p>2、启动订单服务</p><p>3、打开模拟器，在模拟器中打开支付宝沙箱客户端，并使用沙箱客户端账号密码登录。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228123246199.png" alt="image-20231228123246199" style="zoom:67%;" /><p>点击扫一扫选择相册中刚才截屏的二维码</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228123300596.png" alt="image-20231228123300596" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228123308530.png" alt="image-20231228123308530" style="zoom:67%;" /><p>扫码后如果提示系统繁忙再重试<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228123318978.png" alt="image-20231228123318978" style="zoom:67%;" /></p><p>如果提示请求勿重复提交则需要修改下单测试代码中指定的out_trade_no商品订单号，订单号在每个商户是唯一的，每次支付前修改out_trade_no 为一个没有使用过的订单号。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228123332015.png" alt="image-20231228123332015"></p><p>修改订单号后重启订单服务，再使用沙箱支付宝客户端扫码<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228123342421.png" alt="image-20231228123342421" style="zoom:50%;" /></p><p>输入支付密码进行支付。</p><p>支付密码为沙箱账号的支付密码，此支付所扣款为沙箱账号的虚拟货币余额。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228123354472.png" alt="image-20231228123354472"></p><p>支付成功界面：<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228123405580.png" alt="image-20231228123405580"></p><h5 id="支付结果查询接口"><a href="#支付结果查询接口" class="headerlink" title="支付结果查询接口"></a><strong>支付结果查询接口</strong></h5><p>支付完成可以调用第三方支付平台的支付结果查询接口 查询支付结果。</p><p>文档：<a href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p><p>示例代码：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Java<br>AlipayClient alipayClient = <span class="hljs-built_in">new</span> DefaultAlipayClient(&quot;https://openapi.alipay.com/gateway.do&quot;,&quot;app_id&quot;,&quot;your private_key&quot;,&quot;json&quot;,&quot;GBK&quot;,&quot;alipay_public_key&quot;,&quot;RSA2&quot;);<br>AlipayTradeQueryRequest request = <span class="hljs-built_in">new</span> AlipayTradeQueryRequest();<br>JSONObject bizContent = <span class="hljs-built_in">new</span> JSONObject();<br>bizContent.put(&quot;out_trade_no&quot;, &quot;20150320010101001&quot;);<br>//bizContent.put(&quot;trade_no&quot;, &quot;2014112611001004680073956707&quot;);<br>request.setBizContent(bizContent.toString());<br>AlipayTradeQueryResponse response = alipayClient.<span class="hljs-keyword">execute</span>(request);<br><span class="hljs-keyword">if</span>(response.isSuccess())&#123;<br>    <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;调用成功&quot;);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;调用失败&quot;);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>刚才订单付款成功，可以使用out_trade_no商品订单号或支付宝的交易流水号trade_no去查询支付结果。</p><p>out_trade_no商品订单号: 是在下单请求时指定的商品订单号。</p><p>支付宝的交易流水号trade_no：是支付完成后支付宝通知支付结果时发送的trade_no</p><p>我们使用out_trade_no商品订单号去查询，代码如下：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br>package com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">orders</span>.<span class="hljs-property">api</span>;<br><br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">fastjson</span>.<span class="hljs-property">JSONObject</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">AlipayApiException</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">AlipayClient</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">DefaultAlipayClient</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">request</span>.<span class="hljs-property">AlipayTradeQueryRequest</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">response</span>.<span class="hljs-property">AlipayTradeQueryResponse</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">junit</span>.<span class="hljs-property">jupiter</span>.<span class="hljs-property">api</span>.<span class="hljs-property">Test</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Value</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">test</span>.<span class="hljs-property">context</span>.<span class="hljs-property">SpringBootTest</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 支付宝查询接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/4 17:18</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AliPayTest</span> &#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.APP_ID&#125;&quot;</span>)<br>    <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">APP_ID</span>;<br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;</span>)<br>    <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">APP_PRIVATE_KEY</span>;<br>    <br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;</span>)<br>    <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">ALIPAY_PUBLIC_KEY</span>;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">queryPayResult</span>() throws <span class="hljs-title class_">AlipayApiException</span> &#123;<br>    <span class="hljs-title class_">AlipayClient</span> alipayClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAlipayClient</span>(<span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">URL</span>, <span class="hljs-variable constant_">APP_ID</span>, <span class="hljs-variable constant_">APP_PRIVATE_KEY</span>, <span class="hljs-string">&quot;json&quot;</span>, <span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">CHARSET</span>, <span class="hljs-variable constant_">ALIPAY_PUBLIC_KEY</span>, <span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">SIGNTYPE</span>); <span class="hljs-comment">//获得初始化的AlipayClient</span><br>    <span class="hljs-title class_">AlipayTradeQueryRequest</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayTradeQueryRequest</span>();<br>    <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> bizContent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>();<br>    bizContent.<span class="hljs-title function_">put</span>(<span class="hljs-string">&quot;out_trade_no&quot;</span>, <span class="hljs-string">&quot;202210100010101002&quot;</span>);<br>    <span class="hljs-comment">//bizContent.put(&quot;trade_no&quot;, &quot;2014112611001004680073956707&quot;);</span><br>    request.<span class="hljs-title function_">setBizContent</span>(bizContent.<span class="hljs-title function_">toString</span>());<br>    <span class="hljs-title class_">AlipayTradeQueryResponse</span> response = alipayClient.<span class="hljs-title function_">execute</span>(request);<br>    <span class="hljs-keyword">if</span> (response.<span class="hljs-title function_">isSuccess</span>()) &#123;<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;调用成功&quot;</span>);<br>        <span class="hljs-title class_">String</span> resultJson = response.<span class="hljs-title function_">getBody</span>();<br>        <span class="hljs-comment">//转map</span><br>        <span class="hljs-title class_">Map</span> resultMap = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parseObject</span>(resultJson, <span class="hljs-title class_">Map</span>.<span class="hljs-property">class</span>);<br>        <span class="hljs-title class_">Map</span> alipay_trade_query_response = (<span class="hljs-title class_">Map</span>) resultMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;alipay_trade_query_response&quot;</span>);<br>        <span class="hljs-comment">//支付结果</span><br>        <span class="hljs-title class_">String</span> trade_status = (<span class="hljs-title class_">String</span>) alipay_trade_query_response.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;trade_status&quot;</span>);<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(trade_status);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;调用失败&quot;</span>);<br>    &#125;<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>运行代码，输出如下：</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Plain</span> <span class="hljs-built_in">Text</span><br>调用成功<br><span class="hljs-type">TRADE_SUCCESS</span><br><br></code></pre></td></tr></table></figure><p>输出结果即是调用支付宝查询接口查询到的支付结果+</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228124613838.png" alt="image-20231228124613838"></p><p>参考文档<a href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a> 查阅每个参数的意义。</p><p>我们主要需要下边的参数：</p><p>“out_trade_no” : “20220520010101026”,</p><p>“trade_no”:”2022100422001422760505740639” ： 支付宝交易流水号</p><p>“total_amount” : “1.30”</p><p>“trade_status” : “TRADE_SUCCESS”： 交易状态</p><p>交易状态类型：</p><p>交易状态：WAIT_BUYER_PAY（交易创建，等待买家付款）</p><p>TRADE_CLOSED（未付款交易超时关闭，或支付完成后全额退款）</p><p>TRADE_SUCCESS（交易支付成功）</p><p>TRADE_FINISHED（交易结束，不可退款）</p><h5 id="支付结果通知接口"><a href="#支付结果通知接口" class="headerlink" title="支付结果通知接口"></a><strong>支付结果通知接口</strong></h5><h6 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a><strong>准备环境</strong></h6><p>对于手机网站支付产生的交易，支付宝会通知商户支付结果，有两种通知方式，通过return_url、notify_url进行通知，使用return_url不能保证通知到位，推荐使用notify_url完成支付结构通知。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228130333847.png" alt="image-20231228130333847"></p><p>具体的使用方法是在调用下单接口的 API 中传入的异步通知地址 notify_url，通过 POST 请求的形式将支付结果作为参数通知到商户系统。详情可查看 <a href="https://opendocs.alipay.com/support/01raw4">支付宝异步通知说明</a> 。</p><p>文档：<a href="https://opendocs.alipay.com/open/203/105286">https://opendocs.alipay.com/open/203/105286</a></p><p>根据下单执行流程，订单服务收到支付结果需要对内容进行验签，验签过程如下：</p><p>\1.    在通知返回参数列表中，除去sign、sign_type两个参数外，凡是通知返回回来的参数皆是待验签的参数。将剩下参数进行 url_decode，然后进行字典排序，组成字符串，得到待签名字符串； 生活号异步通知组成的待验签串里需要保留 sign_type 参数。</p><p>\2.    将签名参数（sign）使用 base64 解码为字节码串；</p><p>\3.    使用 RSA 的验签方法，通过签名字符串、签名参数（经过 base64 解码）及支付宝公钥验证签名。</p><p>\4.    验证签名正确后，必须再严格按照如下描述校验通知数据的正确性。</p><p>在上述验证通过后，商户必须根据支付宝不同类型的业务通知，正确的进行不同的业务处理，并且过滤重复的通知结果数据。</p><p>通过验证out_trade_no、total_amount、appid参数的正确性判断通知请求的合法性。</p><p>验证的过程可以参考sdk demo代码，下载 sdk demo代码，<a href="https://opendocs.alipay.com/open/203/105910">https://opendocs.alipay.com/open/203/105910</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228130352721.png" alt="image-20231228130352721"></p><p>参考demo中的alipay.trade.wap.pay-java-utf-8\WebContent\ notify_url.jsp</p><p>另外，支付宝通知订单服务的地址必须为外网域名且备案通过可以正常访问。</p><p>此接口仍然使用内网穿透技术。</p><h6 id="编写测试代码"><a href="#编写测试代码" class="headerlink" title="编写测试代码"></a><strong>编写测试代码</strong></h6><p>1、在下单请求时设置通知地址request.setNotifyUrl(“商户自己的notify_url地址”);</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@GetMapping(&quot;/alipaytest&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">alipaytest</span><span class="hljs-params">(HttpServletRequest httpRequest,</span><br><span class="hljs-params">                           HttpServletResponse httpResponse)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-comment">//构造sdk的客户端对象</span><br>        <span class="hljs-type">AlipayClient</span> <span class="hljs-variable">alipayClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAlipayClient</span>(serverUrl, APP_ID, APP_PRIVATE_KEY, <span class="hljs-string">&quot;json&quot;</span>, CHARSET, ALIPAY_PUBLIC_KEY, sign_type); <span class="hljs-comment">//获得初始化的AlipayClient</span><br>        <span class="hljs-type">AlipayTradeWapPayRequest</span> <span class="hljs-variable">alipayRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayTradeWapPayRequest</span>();<span class="hljs-comment">//创建API对应的request</span><br><span class="hljs-comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span><br>        alipayRequest.setNotifyUrl(<span class="hljs-string">&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify&quot;</span>);<span class="hljs-comment">//在公共参数中设置回跳和通知地址</span><br>        .....<br>        <br><br></code></pre></td></tr></table></figure><p>2、编写接收通知接口，接收参数并验签</p><p>参考课程资料下的alipay.trade.wap.pay-java-utf-8\WebContent\notify_url.jsp</p><p>代码如下：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs awk">Java<br><span class="hljs-regexp">//</span>接收通知<br>@PostMapping(<span class="hljs-string">&quot;/paynotify&quot;</span>)<br>public void paynotify(HttpServletRequest request,HttpServletResponse response) throws UnsupportedEncodingException, AlipayApiException &#123;<br>    Map&lt;String,String&gt; params = new HashMap&lt;String,String&gt;();<br>    Map requestParams = request.getParameterMap();<br>    <span class="hljs-keyword">for</span> (Iterator iter = requestParams.keySet().iterator(); iter.hasNext();) &#123;<br>        String name = (String) iter.<span class="hljs-keyword">next</span>();<br>        String[] values = (String[]) requestParams.get(name);<br>        String valueStr = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; values.length; i++) &#123;<br>            valueStr = (i == values.length - <span class="hljs-number">1</span>) ? valueStr + values[i]<br>                    : valueStr + values[i] + <span class="hljs-string">&quot;,&quot;</span>;<br>        &#125;<br>        <span class="hljs-regexp">//</span>乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化<br>        <span class="hljs-regexp">//</span>valueStr = new String(valueStr.getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>), <span class="hljs-string">&quot;gbk&quot;</span>);<br>        params.put(name, valueStr);<br>    &#125;<br><br>   <br>    <span class="hljs-regexp">//</span>获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以上仅供参考)<span class="hljs-regexp">//</span><br>    <span class="hljs-regexp">//</span>计算得出通知验证结果<br>    <span class="hljs-regexp">//</span>boolean AlipaySignature.rsaCheckV1(Map&lt;String, String&gt; params, String publicKey, String charset, String sign_type)<br>    boolean verify_result = AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="hljs-string">&quot;RSA2&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(verify_result) &#123;<span class="hljs-regexp">//</span>验证成功<br>        <span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><br>        <span class="hljs-regexp">//</span>请在这里加上商户的业务逻辑程序代码<br>        <br>         <span class="hljs-regexp">//</span>商户订单号<br>        String out_trade_no = new String(request.getParameter(<span class="hljs-string">&quot;out_trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-regexp">//</span>支付宝交易号<br>    <br>        String trade_no = new String(request.getParameter(<span class="hljs-string">&quot;trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>    <br>        <span class="hljs-regexp">//</span>交易状态<br>        String trade_status = new String(request.getParameter(<span class="hljs-string">&quot;trade_status&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br><br><br>        <span class="hljs-regexp">//</span>——请根据您的业务逻辑来编写程序（以下代码仅作参考）——<br><br>        <span class="hljs-keyword">if</span> (trade_status.equals(<span class="hljs-string">&quot;TRADE_FINISHED&quot;</span>)) &#123;<span class="hljs-regexp">//</span>交易结束<br>            <span class="hljs-regexp">//</span>判断该笔订单是否在商户网站中已经做过处理<br>            <span class="hljs-regexp">//</span>如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序<br>            <span class="hljs-regexp">//</span>请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的<br>            <span class="hljs-regexp">//</span>如果有做过处理，不执行商户的业务程序<br><br>            <span class="hljs-regexp">//</span>注意：<br>            <span class="hljs-regexp">//</span>如果签约的是可退款协议，退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知<br>            <span class="hljs-regexp">//</span>如果没有签约可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (trade_status.equals(<span class="hljs-string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;<span class="hljs-regexp">//</span>交易成功<br>            System.out.println(trade_status);<br>            <span class="hljs-regexp">//</span>判断该笔订单是否在商户网站中已经做过处理<br>            <span class="hljs-regexp">//</span>如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序<br>            <span class="hljs-regexp">//</span>请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的<br>            <span class="hljs-regexp">//</span>如果有做过处理，不执行商户的业务程序<br><br>            <span class="hljs-regexp">//</span>注意：<br>            <span class="hljs-regexp">//</span>如果签约的是可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。<br>        &#125;<br>        response.getWriter().write(<span class="hljs-string">&quot;success&quot;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        response.getWriter().write(<span class="hljs-string">&quot;fail&quot;</span>);<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><h6 id="通知接口测试"><a href="#通知接口测试" class="headerlink" title="通知接口测试"></a><strong>通知接口测试</strong></h6><p>1、重启订单服务，并在接收通知接口中打上断点</p><p>2、配置内网穿透的本地端口为订单服务端口，启动内网穿透客户端。</p><p>3、打开模拟器、支付宝沙箱，扫码、支付。</p><p>4、观察接收订单支付数据等是否正常。</p><h4 id="生成支付二维码"><a href="#生成支付二维码" class="headerlink" title="生成支付二维码"></a><strong>生成支付二维码</strong></h4><h5 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h5><h6 id="执行流程-2"><a href="#执行流程-2" class="headerlink" title="执行流程"></a><strong>执行流程</strong></h6><p>再次打开课程支付引导界面，点击“支付宝支付”按钮系统该如何处理？</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228130615281.png" alt="image-20231228130615281"></p><p>点击“支付宝支付”此时打开支付二维码，用户扫码支付。</p><p>所以首先需要生成支付二维码，用户扫描二维码开始请求支付宝下单，在向支付宝下单前需要添加选课记录、创建商品订单、生成支付交易记录。</p><p>生成二维码执行流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228130627772.png" alt="image-20231228130627772"></p><p>执行流程：</p><ol><li>前端调用学习中心服务的添加选课接口</li><li>添加选课成功请求订单服务生成支付二维码接口</li><li>生成二维码接口：创建商品订单，生成支付交易记录，生成二维码</li><li>将二维码返回给前端，用户扫码</li></ol><p>用户扫码支付流程如下：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228130911469.png" alt="image-20231228130911469" style="zoom:50%;" /><p>执行流程：</p><p>1、用户输入支付<code>密码</code>，支付成功。</p><p>2、接收第三方平台通知的<code>支付结果</code>。</p><p>3、根据支付结果更新支付交易记录的<code>支付状态</code>为支付成功。</p><h6 id="数据模型-1"><a href="#数据模型-1" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h6><p>订单支付模式的核心由三张表组成：订单表、订单明细表、支付交易记录表。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228131040367.png" alt="image-20231228131040367"></p><p>订单表：记录订单信息</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228131047937.png" alt="image-20231228131047937"></p><p>订单明细表记录订单的详细信息</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228131053925.png" alt="image-20231228131053925"></p><p>支付交易记录表记录每次支付的交易明细</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228131059488.png" alt="image-20231228131059488"></p><p>订单号注意唯一性，安全性，尽量短等特点，生成方案常用的如下：</p><ol><li>时间戳+随机数</li></ol><p>年月日时分秒毫秒+随机数</p><ol start="2"><li>高并发场景</li></ol><p>年月日时分秒毫秒+随机数+redis自增序列</p><ol start="3"><li>订单号中加上业务标识</li></ol><p>订单号加上业务标识方便客服，比如：第10位是业务类型，第11位是用户类型等。</p><ol start="4"><li>雪花算法</li></ol><p>雪花算法是推特内部使用的分布式环境下的唯一ID生成算法，它基于时间戳生成，保证有序递增，加以入计算机硬件等元素，可以满足高并发环境下ID不重复。</p><p>本项目订单号生成采用雪花算法。</p><h5 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h5><p>在订单服务中定义生成支付二维码接口。</p><p>请求：订单信息</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Java<br><span class="hljs-keyword">package</span> com.xuecheng.orders.model.dto;<br><br><span class="hljs-keyword">import</span> com.xuecheng.orders.model.po.XcOrders;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.ToString;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @author Mr.M</span><br><span class="hljs-comment"> * @version 1.0</span><br><span class="hljs-comment"> * @description 创建商品订单</span><br><span class="hljs-comment"> * @date 2022/10/4 10:21</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">AddOrderDto</span>  </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 总价</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">Float</span> totalPrice;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单类型</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> orderType;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> orderName;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单描述</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> orderDescrip;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单明细json，不可为空</span><br><span class="hljs-comment">     * [&#123;&quot;goodsId&quot;:&quot;&quot;,&quot;goodsType&quot;:&quot;&quot;,&quot;goodsName&quot;:&quot;&quot;,&quot;goodsPrice&quot;:&quot;&quot;,&quot;goodsDetail&quot;:&quot;&quot;&#125;,&#123;...&#125;]</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> orderDetail;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 外部系统业务id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> outBusinessId;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>响应：支付交易记录信息及二维码信息</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-type">Java</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ToString</span><br>public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayRecordDto</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">XcPayRecord</span> </span>&#123;<br><br>    <span class="hljs-comment">//二维码</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> qrcode;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>接口定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Api(value = &quot;订单支付接口&quot;, tags = &quot;订单支付接口&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;生成支付二维码&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/generatepaycode&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title function_">generatePayCode</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddOrderDto addOrderDto)</span> &#123;<br>        <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>用户扫码请求下单，定义下单接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;扫码下单接口&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/requestpay&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestpay</span><span class="hljs-params">(String payNo,HttpServletResponse httpResponse)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a>接口实现</h5><h6 id="保存商品订单"><a href="#保存商品订单" class="headerlink" title="保存商品订单"></a>保存商品订单</h6><p>定义保存订单信息接口</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">Java<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderService</span> </span>&#123;<br><br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 创建商品订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> addOrderDto 订单信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> PayRecordDto 支付交易记录(包括二维码)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/4 11:02</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-function">PayRecordDto <span class="hljs-title">createOrder</span><span class="hljs-params">(String userId,AddOrderDto addOrderDto)</span></span>;<br><br></code></pre></td></tr></table></figure><p>在保存订单接口中需要完成创建商品订单、创建支付交易记录，接口实现方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    XcOrdersMapper ordersMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    XcOrdersGoodsMapper ordersGoodsMapper;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    XcPayRecordMapper payRecordMapper;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId, AddOrderDto addOrderDto)</span> &#123;<br><br>        <span class="hljs-comment">//添加商品订单</span><br><br>        <span class="hljs-comment">//添加支付交易记录</span><br>        <br>        <span class="hljs-comment">//生成二维码</span><br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>编写创建商品订单方法，商品订单的数据来源于选课记录，在订单表需要存入选课记录的ID，这里需要作好幂等处理。</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs lasso">Java<br>@Transactional<br><span class="hljs-keyword">public</span> XcOrders saveXcOrders(<span class="hljs-built_in">String</span> userId,AddOrderDto addOrderDto)&#123;<br>    <span class="hljs-comment">//幂等性处理</span><br>    XcOrders <span class="hljs-keyword">order</span> = getOrderByBusinessId(addOrderDto.getOutBusinessId());<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">order</span>!=<span class="hljs-built_in">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">order</span>;<br>    &#125;<br>    <span class="hljs-keyword">order</span> = <span class="hljs-literal">new</span> XcOrders();<br>    <span class="hljs-comment">//生成订单号</span><br>    long orderId = IdWorkerUtils.getInstance().nextId();<br>    <span class="hljs-keyword">order</span>.setId(orderId);<br>    <span class="hljs-keyword">order</span>.setTotalPrice(addOrderDto.getTotalPrice());<br>    <span class="hljs-keyword">order</span>.setCreateDate(LocalDateTime.now());<br>    <span class="hljs-keyword">order</span>.setStatus(<span class="hljs-string">&quot;600001&quot;</span>);<span class="hljs-comment">//未支付</span><br>    <span class="hljs-keyword">order</span>.setUserId(userId);<br>    <span class="hljs-keyword">order</span>.setOrderType(addOrderDto.getOrderType());<br>    <span class="hljs-keyword">order</span>.setOrderName(addOrderDto.getOrderName());<br>    <span class="hljs-keyword">order</span>.setOrderDetail(addOrderDto.getOrderDetail());<br>    <span class="hljs-keyword">order</span>.setOrderDescrip(addOrderDto.getOrderDescrip());<br>    <span class="hljs-keyword">order</span>.setOutBusinessId(addOrderDto.getOutBusinessId());<span class="hljs-comment">//选课记录id</span><br>    ordersMapper.insert(<span class="hljs-keyword">order</span>);<br>    <span class="hljs-built_in">String</span> orderDetailJson = addOrderDto.getOrderDetail();<br>    <span class="hljs-built_in">List</span>&lt;XcOrdersGoods&gt; xcOrdersGoodsList = JSON.parseArray(orderDetailJson, XcOrdersGoods.class);<br>    xcOrdersGoodsList.forEach(goods-&gt;&#123;<br>        XcOrdersGoods xcOrdersGoods = <span class="hljs-literal">new</span> XcOrdersGoods();<br>        BeanUtils.copyProperties(goods,xcOrdersGoods);<br>        xcOrdersGoods.setOrderId(orderId);<span class="hljs-comment">//订单号</span><br>        ordersGoodsMapper.insert(xcOrdersGoods);<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">order</span>;<br>&#125;<br><br><span class="hljs-comment">//根据业务id查询订单</span><br><span class="hljs-keyword">public</span> XcOrders getOrderByBusinessId(<span class="hljs-built_in">String</span> businessId) &#123;<br>    XcOrders orders = ordersMapper.selectOne(<span class="hljs-literal">new</span> LambdaQueryWrapper&lt;XcOrders&gt;().<span class="hljs-literal">eq</span>(XcOrders<span class="hljs-type">::getOutBusinessId</span>, businessId));<br>    <span class="hljs-keyword">return</span> orders;<br>&#125;<br><br></code></pre></td></tr></table></figure><h6 id="创建支付交易记录"><a href="#创建支付交易记录" class="headerlink" title="创建支付交易记录"></a><strong>创建支付交易记录</strong></h6><p>为什么创建支付交易记录？</p><p>在请求微信或支付宝下单接口时需要传入 商品订单号，在与第三方支付平台对接时发现，当用户支付失败或因为其它原因最终该订单没有支付成功，此时再次调用第三方支付平台的下单接口发现报错“订单号已存在”，此时如果我们传入一个没有使用过的订单号就可以解决问题，但是商品订单已经创建，因为没有支付成功重新创建一个新订单是不合理的。</p><p>解决以上问题的方案是：</p><p>1、用户每次发起都创建一个新的支付交易记录 ，此交易记录与商品订单关联。</p><p>2、将支付交易记录的流水号传给第三方支付系统下单接口，这样就即使没有支付成功就不会出现上边的问题。</p><p>3、需要提醒用户不要重复支付。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228134423910.png" alt="image-20231228134423910"></p><p>编写创建支付交易记录的方法：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Java<br>public XcPayRecord createPayRecord(XcOrders orders)&#123;<br>    if(order<span class="hljs-operator">=</span><span class="hljs-operator">=</span>null)&#123;<br>       XueChengPlusException.cast(<span class="hljs-string">&quot;订单不存在&quot;</span>)<span class="hljs-comment">;</span><br>    &#125;<br>    if(orders.getStatus().equals(<span class="hljs-string">&quot;600002&quot;</span>))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;订单已支付&quot;</span>)<span class="hljs-comment">;</span><br>    &#125;<br>    XcPayRecord payRecord <span class="hljs-operator">=</span> new XcPayRecord()<span class="hljs-comment">;</span><br>    //生成支付交易流水号<br>    long payNo <span class="hljs-operator">=</span> IdWorkerUtils.getInstance().nextId()<span class="hljs-comment">;</span><br>    payRecord.setPayNo(payNo)<span class="hljs-comment">;</span><br>    payRecord.setOrderId(orders.getId())<span class="hljs-comment">;//商品订单号</span><br>    payRecord.setOrderName(orders.getOrderName())<span class="hljs-comment">;</span><br>    payRecord.setTotalPrice(orders.getTotalPrice())<span class="hljs-comment">;</span><br>    payRecord.setCurrency(<span class="hljs-string">&quot;CNY&quot;</span>)<span class="hljs-comment">;</span><br>    payRecord.setCreateDate(LocalDateTime.now())<span class="hljs-comment">;</span><br>    payRecord.setStatus(<span class="hljs-string">&quot;601001&quot;</span>)<span class="hljs-comment">;//未支付</span><br>    payRecord.setUserId(orders.getUserId())<span class="hljs-comment">;</span><br>    payRecordMapper.insert(payRecord)<span class="hljs-comment">;</span><br>    return payRecord<span class="hljs-comment">;</span><br><br>&#125;<br><br></code></pre></td></tr></table></figure><h6 id="生成支付二维码-1"><a href="#生成支付二维码-1" class="headerlink" title="生成支付二维码"></a><strong>生成支付二维码</strong></h6><p>1、在nacos中orders-service-dev.yaml配置二维码的url</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts">Java<br><span class="hljs-symbol">pay:</span><br><span class="hljs-symbol"> qrcodeurl:</span> http:<span class="hljs-comment">//192.168.101.1/api/orders/requestpay?payNo=%s</span><br></code></pre></td></tr></table></figure><p>2、完善创建订单service方法:</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PayRecordDto createOrder(<span class="hljs-keyword">String</span> userId, AddOrderDto addOrderDto) &#123;<br>    <span class="hljs-comment">//创建商品订单</span><br>    XcOrders orders = saveXcOrders(userId, addOrderDto);<br>    <span class="hljs-keyword">if</span>(orders==<span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.<span class="hljs-keyword">cast</span>(<span class="hljs-string">&quot;订单创建失败&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(orders.getStatus().equals(<span class="hljs-string">&quot;600002&quot;</span>))&#123;<br>        XueChengPlusException.<span class="hljs-keyword">cast</span>(<span class="hljs-string">&quot;订单已支付&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//生成支付记录</span><br>    XcPayRecord payRecord = createPayRecord(orders);<br>    <span class="hljs-comment">//生成二维码</span><br>    <span class="hljs-keyword">String</span> qrCode = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//url要可以被模拟器访问到，url为下单接口(稍后定义)</span><br>        <span class="hljs-keyword">String</span> url = <span class="hljs-keyword">String</span>.format(qrcodeurl, payRecord.getPayNo());<br>        qrCode = <span class="hljs-keyword">new</span> <span class="hljs-type">QRCodeUtil</span>().createQRCode(url, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        XueChengPlusException.<span class="hljs-keyword">cast</span>(<span class="hljs-string">&quot;生成二维码出错&quot;</span>);<br>    &#125;<br>    PayRecordDto payRecordDto = <span class="hljs-keyword">new</span> <span class="hljs-type">PayRecordDto</span>();<br>    BeanUtils.copyProperties(payRecord,payRecordDto);<br>    payRecordDto.setQrcode(qrCode);<br><br>    <span class="hljs-keyword">return</span> payRecordDto;<br>&#125;<br><br></code></pre></td></tr></table></figure><h6 id="生成二维码接口完善"><a href="#生成二维码接口完善" class="headerlink" title="生成二维码接口完善"></a><strong>生成二维码接口完善</strong></h6><p>完善生成支付二维码controller接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Autowired</span><br>OrderService orderService;<br>    <br><span class="hljs-meta">@ApiOperation(&quot;生成支付二维码&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/generatepaycode&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title function_">generatePayCode</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddOrderDto addOrderDto)</span> &#123;<br>    <span class="hljs-comment">//登录用户</span><br>    SecurityUtil.<span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> SecurityUtil.getUser();<br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;请登录后继续选课&quot;</span>);<br>    &#125;<br>   <span class="hljs-keyword">return</span> orderService.createOrder(user.getId(), addOrderDto);<br>   <br>&#125;<br></code></pre></td></tr></table></figure><h6 id="扫码下单接口完善"><a href="#扫码下单接口完善" class="headerlink" title="扫码下单接口完善"></a><strong>扫码下单接口完善</strong></h6><p>生成了支付二维码，用户扫码请求第三方支付平台下单、支付。</p><p>1、定义查询支付交易记录的Service接口与实现方法</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 查询支付交易记录</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> payNo  交易记录号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.xuecheng.orders.model.po.XcPayRecord</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/20 23:38</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-function">XcPayRecord <span class="hljs-title">getPayRecordByPayno</span><span class="hljs-params">(String payNo)</span></span>;<br></code></pre></td></tr></table></figure><p>实现如下：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs perl">Java<br>@Override<br>public XcPayRecord getPayRecordByPayno(String payNo) &#123;<br>    XcPayRecord xcPayRecord = payRecordMapper.selectOne(new LambdaQueryWrapper&lt;XcPayRecord&gt;().e<span class="hljs-string">q(XcPayRecord::getPayNo, payNo)</span>);<br>    <span class="hljs-keyword">return</span> xcPayRecord;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>2 定义下单接口如下：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-type">Java</span><br><span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.APP_ID&#125;&quot;</span>)<br><span class="hljs-type">String</span> <span class="hljs-type">APP_ID</span>;<br><span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;</span>)<br><span class="hljs-type">String</span> <span class="hljs-type">APP_PRIVATE_KEY</span>;<br><br><span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;</span>)<br><span class="hljs-type">String</span> <span class="hljs-type">ALIPAY_PUBLIC_KEY</span>;<br><br>    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">&quot;扫码下单接口&quot;</span>)<br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/requestpay&quot;</span>)<br>    <span class="hljs-keyword">public</span> void requestpay(<span class="hljs-type">String</span> payNo,<span class="hljs-type">HttpServletResponse</span> httpResponse) <span class="hljs-keyword">throws</span> <span class="hljs-type">IOException</span> &#123;<br>        <span class="hljs-comment">//如果payNo不存在则提示重新发起支付</span><br>        <span class="hljs-type">XcPayRecord</span> payRecord <span class="hljs-operator">=</span> orderService.getPayRecordByPayno(payNo);<br>        <span class="hljs-keyword">if</span>(payRecord <span class="hljs-operator">==</span> null)&#123;<br>            <span class="hljs-type">XueChengPlusException</span>.cast(<span class="hljs-string">&quot;请重新点击支付获取二维码&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//支付状态</span><br>        <span class="hljs-type">String</span> status <span class="hljs-operator">=</span> payRecord.getStatus();<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;601002&quot;</span>.equals(status))&#123;<br>            <span class="hljs-type">XueChengPlusException</span>.cast(<span class="hljs-string">&quot;订单已支付，请勿重复支付。&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//构造sdk的客户端对象</span><br>        <span class="hljs-type">AlipayClient</span> client <span class="hljs-operator">=</span> new <span class="hljs-type">DefaultAlipayClient</span>(<span class="hljs-type">AlipayConfig</span>.<span class="hljs-type">URL</span>, <span class="hljs-type">APP_ID</span>, <span class="hljs-type">APP_PRIVATE_KEY</span>, <span class="hljs-type">AlipayConfig</span>.<span class="hljs-type">FORMAT</span>, <span class="hljs-type">AlipayConfig</span>.<span class="hljs-type">CHARSET</span>, <span class="hljs-type">ALIPAY_PUBLIC_KEY</span>, <span class="hljs-type">AlipayConfig</span>.<span class="hljs-type">SIGNTYPE</span>);<span class="hljs-comment">//获得初始化的AlipayClient</span><br>        <span class="hljs-type">AlipayTradeWapPayRequest</span> alipayRequest <span class="hljs-operator">=</span> new <span class="hljs-type">AlipayTradeWapPayRequest</span>();<span class="hljs-comment">//创建API对应的request</span><br><span class="hljs-comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span><br><span class="hljs-comment">//        alipayRequest.setNotifyUrl(&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify&quot;);//在公共参数中设置回跳和通知地址</span><br>        alipayRequest.setBizContent(<span class="hljs-string">&quot;&#123;&quot;</span> <span class="hljs-operator">+</span><br>                <span class="hljs-string">&quot; <span class="hljs-subst">\&quot;</span>out_trade_no<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>&quot;</span><span class="hljs-operator">+</span>payRecord.getPayNo()<span class="hljs-operator">+</span><span class="hljs-string">&quot;<span class="hljs-subst">\&quot;</span>,&quot;</span> <span class="hljs-operator">+</span><br>                <span class="hljs-string">&quot; <span class="hljs-subst">\&quot;</span>total_amount<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>&quot;</span><span class="hljs-operator">+</span>payRecord.getTotalPrice()<span class="hljs-operator">+</span><span class="hljs-string">&quot;<span class="hljs-subst">\&quot;</span>,&quot;</span> <span class="hljs-operator">+</span><br>                <span class="hljs-string">&quot; <span class="hljs-subst">\&quot;</span>subject<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>&quot;</span><span class="hljs-operator">+</span>payRecord.getOrderName()<span class="hljs-operator">+</span><span class="hljs-string">&quot;<span class="hljs-subst">\&quot;</span>,&quot;</span> <span class="hljs-operator">+</span><br>                <span class="hljs-string">&quot; <span class="hljs-subst">\&quot;</span>product_code<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>QUICK_WAP_PAY<span class="hljs-subst">\&quot;</span>&quot;</span> <span class="hljs-operator">+</span><br>                <span class="hljs-string">&quot; &#125;&quot;</span>);<span class="hljs-comment">//填充业务参数</span><br>        <span class="hljs-type">String</span> form <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//请求支付宝下单接口,发起http请求</span><br>            form <span class="hljs-operator">=</span> client.pageExecute(alipayRequest).getBody(); <span class="hljs-comment">//调用SDK生成表单</span><br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-type">AlipayApiException</span> e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        httpResponse.setContentType(<span class="hljs-string">&quot;text/html;charset=&quot;</span> <span class="hljs-operator">+</span> <span class="hljs-type">AlipayConfig</span>.<span class="hljs-type">CHARSET</span>);<br>        httpResponse.getWriter().write(form);<span class="hljs-comment">//直接将完整的表单html输出到页面</span><br>        httpResponse.getWriter().flush();<br>        httpResponse.getWriter().close();<br>    &#125;<br><br></code></pre></td></tr></table></figure><h5 id="支付测试"><a href="#支付测试" class="headerlink" title="支付测试"></a><strong>支付测试</strong></h5><p>测试准备：</p><p>1、启动网关服务、认证服务、验证码服务、学习中心服务、订单服务、内容管理服务。</p><p>2、发布一门收费课程。</p><p>3、使用资料目录中的新模板course_template.ftl </p><p>测试流程：</p><p>1、进入收费课程详细页面，点击马上学习。</p><p>2、跟踪浏览器及微服务，观察选课记录是否创建成功、商品订单是否创建成功、支付交易记录是否创建成功。</p><p>3、观察生成二维码是否成功</p><p>4、使用模拟器扫码测试，是否可以正常支付。</p><p>如果报订单参数异常报如下错误，需要检查请求支付宝的下单数据是否正确。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228140552111.png" alt="image-20231228140552111"></p><h4 id="查询支付结果"><a href="#查询支付结果" class="headerlink" title="查询支付结果"></a><strong>查询支付结果</strong></h4><h5 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h5><p>根据之前的调研获取支付结果的接口，包括：主动查询支付结果，被动接受支付结果</p><p>这里先实现主动查询支付结果，当支付完成用户点击支付结果，将请求第三方支付平台查询支付结果。</p><p>在OrderController类中定义接口如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;查询支付结果&quot;</span>)</span><br><span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/payresult&quot;</span>)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> PayRecordDto payresult(String payNo) throws IOException &#123;<br><br>    <span class="hljs-comment">//查询支付结果</span><br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="接口实现-1"><a href="#接口实现-1" class="headerlink" title="接口实现"></a>接口实现</h5><h6 id="总体接口"><a href="#总体接口" class="headerlink" title="总体接口"></a>总体接口</h6><p>1、定义查询支付结果的service</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 请求支付宝查询支付结果</span><br><span class="hljs-comment"> * @param payNo 支付记录id</span><br><span class="hljs-comment"> * @return 支付记录信息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title">queryPayResult</span><span class="hljs-params">(<span class="hljs-type">String</span> payNo)</span></span>;<br><br></code></pre></td></tr></table></figure><p>2、service实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title function_">queryPayResult</span><span class="hljs-params">(String payNo)</span>&#123;<br>    <span class="hljs-type">XcPayRecord</span> <span class="hljs-variable">payRecord</span> <span class="hljs-operator">=</span> getPayRecordByPayno(payNo);<br>    <span class="hljs-keyword">if</span> (payRecord == <span class="hljs-literal">null</span>) &#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;请重新点击支付获取二维码&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//支付状态</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> payRecord.getStatus();<br>    <span class="hljs-comment">//如果支付成功直接返回</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;601002&quot;</span>.equals(status)) &#123;<br>        <span class="hljs-type">PayRecordDto</span> <span class="hljs-variable">payRecordDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PayRecordDto</span>();<br>        BeanUtils.copyProperties(payRecord, payRecordDto);<br>        <span class="hljs-keyword">return</span> payRecordDto;<br>    &#125;<br>    <span class="hljs-comment">//从支付宝查询支付结果</span><br>    <span class="hljs-type">PayStatusDto</span> <span class="hljs-variable">payStatusDto</span> <span class="hljs-operator">=</span> queryPayResultFromAlipay(payNo);<br>    <span class="hljs-comment">//保存支付结果</span><br>    currentProxy.saveAliPayStatus( payStatusDto);<br>    <span class="hljs-comment">//重新查询支付记录</span><br>    payRecord = getPayRecordByPayno(payNo);<br>    <span class="hljs-type">PayRecordDto</span> <span class="hljs-variable">payRecordDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PayRecordDto</span>();<br>    BeanUtils.copyProperties(payRecord, payRecordDto);<br>    <span class="hljs-keyword">return</span> payRecordDto;<br><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 请求支付宝查询支付结果</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> payNo 支付交易号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 支付结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> PayStatusDto <span class="hljs-title function_">queryPayResultFromAlipay</span><span class="hljs-params">(String payNo)</span>&#123;<br><br>&#125;<br><br><br><br><br></code></pre></td></tr></table></figure><h6 id="查询支付结果-1"><a href="#查询支付结果-1" class="headerlink" title="查询支付结果"></a><strong>查询支付结果</strong></h6><p>定义从支付宝查询支付结果的方法</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 请求支付宝查询支付结果</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> payNo 支付交易号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 支付结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_">PayStatusDto</span> <span class="hljs-title function_">queryPayResultFromAlipay</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> payNo</span>) &#123;<br><br>    <span class="hljs-comment">//========请求支付宝查询支付结果=============</span><br>    <span class="hljs-title class_">AlipayClient</span> alipayClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAlipayClient</span>(<span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">URL</span>, <span class="hljs-variable constant_">APP_ID</span>, <span class="hljs-variable constant_">APP_PRIVATE_KEY</span>, <span class="hljs-string">&quot;json&quot;</span>, <span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">CHARSET</span>, <span class="hljs-variable constant_">ALIPAY_PUBLIC_KEY</span>, <span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">SIGNTYPE</span>); <span class="hljs-comment">//获得初始化的AlipayClient</span><br>    <span class="hljs-title class_">AlipayTradeQueryRequest</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayTradeQueryRequest</span>();<br>    <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> bizContent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>();<br>    bizContent.<span class="hljs-title function_">put</span>(<span class="hljs-string">&quot;out_trade_no&quot;</span>, payNo);<br>    request.<span class="hljs-title function_">setBizContent</span>(bizContent.<span class="hljs-title function_">toString</span>());<br>    <span class="hljs-title class_">AlipayTradeQueryResponse</span> response = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        response = alipayClient.<span class="hljs-title function_">execute</span>(request);<br>        <span class="hljs-keyword">if</span> (!response.<span class="hljs-title function_">isSuccess</span>()) &#123;<br>            <span class="hljs-title class_">XueChengPlusException</span>.<span class="hljs-title function_">cast</span>(<span class="hljs-string">&quot;请求支付查询查询失败&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">AlipayApiException</span> e) &#123;<br>        log.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;请求支付宝查询支付结果异常:&#123;&#125;&quot;</span>, e.<span class="hljs-title function_">toString</span>(), e);<br>        <span class="hljs-title class_">XueChengPlusException</span>.<span class="hljs-title function_">cast</span>(<span class="hljs-string">&quot;请求支付查询查询失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//获取支付结果</span><br>    <span class="hljs-title class_">String</span> resultJson = response.<span class="hljs-title function_">getBody</span>();<br>    <span class="hljs-comment">//转map</span><br>    <span class="hljs-title class_">Map</span> resultMap = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parseObject</span>(resultJson, <span class="hljs-title class_">Map</span>.<span class="hljs-property">class</span>);<br>    <span class="hljs-title class_">Map</span> alipay_trade_query_response = (<span class="hljs-title class_">Map</span>) resultMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;alipay_trade_query_response&quot;</span>);<br>    <span class="hljs-comment">//支付结果</span><br>    <span class="hljs-title class_">String</span> trade_status = (<span class="hljs-title class_">String</span>) alipay_trade_query_response.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;trade_status&quot;</span>);<br>    <span class="hljs-title class_">String</span> total_amount = (<span class="hljs-title class_">String</span>) alipay_trade_query_response.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;total_amount&quot;</span>);<br>    <span class="hljs-title class_">String</span> trade_no = (<span class="hljs-title class_">String</span>) alipay_trade_query_response.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;trade_no&quot;</span>);<br>    <span class="hljs-comment">//保存支付结果</span><br>    <span class="hljs-title class_">PayStatusDto</span> payStatusDto = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PayStatusDto</span>();<br>    payStatusDto.<span class="hljs-title function_">setOut_trade_no</span>(payNo);<br>    payStatusDto.<span class="hljs-title function_">setTrade_status</span>(trade_status);<br>    payStatusDto.<span class="hljs-title function_">setApp_id</span>(<span class="hljs-variable constant_">APP_ID</span>);<br>    payStatusDto.<span class="hljs-title function_">setTrade_no</span>(trade_no);<br>    payStatusDto.<span class="hljs-title function_">setTotal_amount</span>(total_amount);<br>    <span class="hljs-keyword">return</span> payStatusDto;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h6 id="保存支付结果"><a href="#保存支付结果" class="headerlink" title="保存支付结果"></a><strong>保存支付结果</strong></h6><p>1、定义保存支付结果的接口</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 保存支付宝支付结果</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> payStatusDto  支付结果信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/4 16:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveAliPayStatus</span><span class="hljs-params">(PayStatusDto payStatusDto)</span> </span>;<br><br></code></pre></td></tr></table></figure><p>2、编写接口实现</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Java<br>@Transactional<br>@Override<br><span class="hljs-built_in">public</span> <span class="hljs-type">void</span> saveAliPayStatus(PayStatusDto payStatusDto) &#123;<br>    //支付流水号<br>    String payNo = payStatusDto.getOut_trade_no();<br>    XcPayRecord payRecord = getPayRecordByPayno(payNo);<br>    <span class="hljs-keyword">if</span> (payRecord == <span class="hljs-keyword">null</span>) &#123;<br>        XueChengPlusException.cast(&quot;支付记录找不到&quot;);<br>    &#125;<br>    //支付结果<br>    String trade_status = payStatusDto.getTrade_status();<br>    <span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;收到支付结果:&#123;&#125;,支付记录:&#123;&#125;&#125;&quot;, payStatusDto.toString(),payRecord.toString());<br>    <span class="hljs-keyword">if</span> (trade_status.equals(&quot;TRADE_SUCCESS&quot;)) &#123;<br><br>        //支付金额变为分<br>        <span class="hljs-type">Float</span> totalPrice = payRecord.getTotalPrice() * <span class="hljs-number">100</span>;<br>        <span class="hljs-type">Float</span> total_amount = <span class="hljs-type">Float</span>.parseFloat(payStatusDto.getTotal_amount()) * <span class="hljs-number">100</span>;<br>        //校验是否一致<br>        <span class="hljs-keyword">if</span> (!payStatusDto.getApp_id().equals(APP_ID) || totalPrice.intValue() != total_amount.intValue()) &#123;<br>            //校验失败<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;校验支付结果失败,支付记录:&#123;&#125;,APP_ID:&#123;&#125;,totalPrice:&#123;&#125;&quot; ,payRecord.toString(),payStatusDto.getApp_id(),total_amount.intValue());<br>            XueChengPlusException.cast(&quot;校验支付结果失败&quot;);<br>        &#125;<br>        <span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;更新支付结果,支付交易流水号:&#123;&#125;,支付结果:&#123;&#125;&quot;, payNo, trade_status);<br>        XcPayRecord payRecord_u = <span class="hljs-built_in">new</span> XcPayRecord();<br>        payRecord_u.setStatus(&quot;601002&quot;);//支付成功<br>        payRecord_u.setOutPayChannel(&quot;Alipay&quot;);<br>        payRecord_u.setOutPayNo(payStatusDto.getTrade_no());//支付宝交易号<br>        payRecord_u.setPaySuccessTime(LocalDateTime.now());//通知时间<br>        <span class="hljs-type">int</span> update1 = payRecordMapper.<span class="hljs-keyword">update</span>(payRecord_u, <span class="hljs-built_in">new</span> LambdaQueryWrapper&lt;XcPayRecord&gt;().eq(XcPayRecord::getPayNo, payNo));<br>        <span class="hljs-keyword">if</span> (update1 &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;更新支付记录状态成功:&#123;&#125;&quot;, payRecord_u.toString());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;更新支付记录状态失败:&#123;&#125;&quot;, payRecord_u.toString());<br>            XueChengPlusException.cast(&quot;更新支付记录状态失败&quot;);<br>        &#125;<br>        //关联的订单号<br>        Long orderId = payRecord.getOrderId();<br>        XcOrders orders = ordersMapper.selectById(orderId);<br>        <span class="hljs-keyword">if</span> (orders == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;根据支付记录[&#123;&#125;&#125;]找不到订单&quot;, payRecord_u.toString());<br>            XueChengPlusException.cast(&quot;根据支付记录找不到订单&quot;);<br>        &#125;<br>        XcOrders order_u = <span class="hljs-built_in">new</span> XcOrders();<br>        order_u.setStatus(&quot;600002&quot;);//支付成功<br>        <span class="hljs-type">int</span> <span class="hljs-keyword">update</span> = ordersMapper.<span class="hljs-keyword">update</span>(order_u, <span class="hljs-built_in">new</span> LambdaQueryWrapper&lt;XcOrders&gt;().eq(XcOrders::getId, orderId));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">update</span> &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;更新订单表状态成功,订单号:&#123;&#125;&quot;, orderId);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;更新订单表状态失败,订单号:&#123;&#125;&quot;, orderId);<br>            XueChengPlusException.cast(&quot;更新订单表状态失败&quot;);<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="接口测试-2"><a href="#接口测试-2" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h5><p>1、完善接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@ApiOperation(&quot;查询支付结果&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/payresult&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title function_">payresult</span><span class="hljs-params">(String payNo)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//调用支付宝接口查询</span><br>    <span class="hljs-type">PayRecordDto</span> <span class="hljs-variable">payRecordDto</span> <span class="hljs-operator">=</span> orderService.queryPayResult(payNo);<br>    <span class="hljs-keyword">return</span> payRecordDto;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>2、测试流程</p><p>完成生成支付二维码</p><p>用支付宝扫码但不支付</p><p>使用httpclient请求查询支付结果，查询失败</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Java<br><span class="hljs-comment">### 查询支付结果</span><br><span class="hljs-built_in">GET</span> &#123;&#123;orders_host&#125;&#125;/orders/payresult?<span class="hljs-attribute">payNo</span>=1628648111951941632<br>Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ7XCJiaXJ0aGRheVwiOlwiMjAyMi0wOS0yOFQxOToyODo0NlwiLFwiY3JlYXRlVGltZVwiOlwiMjAyMi0wOS0yOFQwODozMjowM1wiLFwiaWRcIjpcIjUwXCIsXCJuYW1lXCI6XCLlrabnlJ8xXCIsXCJuaWNrbmFtZVwiOlwi5aSn5rC054mbXCIsXCJwZXJtaXNzaW9uc1wiOltdLFwic2V4XCI6XCIxXCIsXCJzdGF0dXNcIjpcIjFcIixcInVzZXJuYW1lXCI6XCJzdHUxXCIsXCJ1c2VycGljXCI6XCJodHRwOi8vZmlsZS41MXh1ZWNoZW5nLmNuL2RkZGZcIixcInV0eXBlXCI6XCIxMDEwMDFcIn0iLCJzY29wZSI6WyJhbGwiXSwiZXhwIjoxNjc3MTQwMDI1LCJhdXRob3JpdGllcyI6WyJwMSJdLCJqdGkiOiJmYThiMmY1OS03ZTQ5LTRmODUtOTBlMC05NzYwNjlkYjE3ODIiLCJjbGllbnRfaWQiOiJYY1dlYkFwcCJ9.89sp5lPdFafZ_HdGhe8Cpv0anMJC3vT4PtaGMHgCkr8<br><br></code></pre></td></tr></table></figure><p>用支付宝扫码再次完成支付</p><p>使用httpclient请求查询支付结果，支付结果为成功，并更新支付记录状态和订单状态。</p><p>3、使用前后端联调</p><p>拷贝资料目录中LocalDateTimeConfig.java到base工程下，处理long转string精度损失的问题。</p><p>使用最新的门户代码xc-ui-pc-static-portal.zip</p><h4 id="接收支付通知"><a href="#接收支付通知" class="headerlink" title="接收支付通知"></a><strong>接收支付通知</strong></h4><h5 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h5><p>支付完成后第三方支付系统会主动通知支付结果，要实现主动通知需要在请求支付系统下单时传入NotifyUrl，这里有两个url：NotifyUrl和ReturnUrl，ReturnUrl是支付完成后支付系统携带支付结果重定向到ReturnUrl地址，NotifyUrl是支付完成后支付系统在后台定时去通知，使用NotifyUrl比使用ReturnUrl有保证。</p><p>根据接口描述：<a href="https://opendocs.alipay.com/open/203/105286%E7%9A%84%E5%86%85%E5%AE%B9%E4%B8%8B%E8%BE%B9%E5%9C%A8%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%AE%9A%E4%B9%89%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E9%80%9A%E7%9F%A5%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%82">https://opendocs.alipay.com/open/203/105286的内容下边在订单服务定义接收支付结果通知的接口。</a></p><p>首先在下单时指定NotifyUrl:</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Java<br>alipayRequest.setNotifyUrl(<span class="hljs-string">&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/receivenotify&quot;</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>接收支付结果通知接口如下：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Java<br><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">&quot;接收支付结果通知&quot;</span>)<br><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">&quot;/receivenotify&quot;</span>)<br><span class="hljs-keyword">public</span> void receivenotify(HttpServletRequest request,HttpServletResponse out) throws UnsupportedEncodingException, AlipayApiException &#123;<br>    Map&lt;<span class="hljs-keyword">String</span>,<span class="hljs-keyword">String</span>&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-type">HashMap</span>&lt;<span class="hljs-keyword">String</span>,<span class="hljs-keyword">String</span>&gt;();<br>    Map requestParams = request.getParameterMap();<br>    <span class="hljs-keyword">for</span> (Iterator iter = requestParams.keySet().iterator(); iter.hasNext();) &#123;<br>        <span class="hljs-keyword">String</span> name = (<span class="hljs-keyword">String</span>) iter.next();<br>        <span class="hljs-keyword">String</span>[] values = (<span class="hljs-keyword">String</span>[]) requestParams.<span class="hljs-keyword">get</span>(name);<br>        <span class="hljs-keyword">String</span> valueStr = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; values.length; i++) &#123;<br>            valueStr = (i == values.length - <span class="hljs-number">1</span>) ? valueStr + values[i]<br>                    : <span class="hljs-type">valueStr </span>+ values[i] + <span class="hljs-string">&quot;,&quot;</span>;<br>        &#125;<br>        params.put(name, valueStr);<br>    &#125;<br><br>    <span class="hljs-comment">//验签</span><br>    boolean verify_result = AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="hljs-string">&quot;RSA2&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(verify_result) &#123;<span class="hljs-comment">//验证成功</span><br><br>        <span class="hljs-comment">//商户订单号</span><br>        <span class="hljs-keyword">String</span> out_trade_no = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;out_trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//支付宝交易号</span><br>        <span class="hljs-keyword">String</span> trade_no = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//交易状态</span><br>        <span class="hljs-keyword">String</span> trade_status = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;trade_status&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//appid</span><br>        <span class="hljs-keyword">String</span> app_id = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;app_id&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//total_amount</span><br>        <span class="hljs-keyword">String</span> total_amount = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;total_amount&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br><br>        <span class="hljs-comment">//交易成功处理</span><br>        <span class="hljs-keyword">if</span> (trade_status.equals(<span class="hljs-string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;<br>           <br>           <span class="hljs-comment">//处理逻辑。。。</span><br>            <br>        &#125;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="接口实现-2"><a href="#接口实现-2" class="headerlink" title="接口实现"></a><strong>接口实现</strong></h5><p>完善contorller接口</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Java<br><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">&quot;接收支付结果通知&quot;</span>)<br><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">&quot;/receivenotify&quot;</span>)<br><span class="hljs-keyword">public</span> void receivenotify(HttpServletRequest request) throws UnsupportedEncodingException, AlipayApiException &#123;<br>    Map&lt;<span class="hljs-keyword">String</span>,<span class="hljs-keyword">String</span>&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-type">HashMap</span>&lt;<span class="hljs-keyword">String</span>,<span class="hljs-keyword">String</span>&gt;();<br>    Map requestParams = request.getParameterMap();<br>    <span class="hljs-keyword">for</span> (Iterator iter = requestParams.keySet().iterator(); iter.hasNext();) &#123;<br>        <span class="hljs-keyword">String</span> name = (<span class="hljs-keyword">String</span>) iter.next();<br>        <span class="hljs-keyword">String</span>[] values = (<span class="hljs-keyword">String</span>[]) requestParams.<span class="hljs-keyword">get</span>(name);<br>        <span class="hljs-keyword">String</span> valueStr = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; values.length; i++) &#123;<br>            valueStr = (i == values.length - <span class="hljs-number">1</span>) ? valueStr + values[i]<br>                    : <span class="hljs-type">valueStr </span>+ values[i] + <span class="hljs-string">&quot;,&quot;</span>;<br>        &#125;<br>        params.put(name, valueStr);<br>    &#125;<br><br>    <span class="hljs-comment">//验签</span><br>    boolean verify_result = AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="hljs-string">&quot;RSA2&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(verify_result) &#123;<span class="hljs-comment">//验证成功</span><br><br>        <span class="hljs-comment">//商户订单号</span><br>        <span class="hljs-keyword">String</span> out_trade_no = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;out_trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//支付宝交易号</span><br>        <span class="hljs-keyword">String</span> trade_no = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//交易状态</span><br>        <span class="hljs-keyword">String</span> trade_status = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;trade_status&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//appid</span><br>        <span class="hljs-keyword">String</span> app_id = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;app_id&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//total_amount</span><br>        <span class="hljs-keyword">String</span> total_amount = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;total_amount&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br><br>        <span class="hljs-comment">//交易成功处理</span><br>        <span class="hljs-keyword">if</span> (trade_status.equals(<span class="hljs-string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;<br><br>            PayStatusDto payStatusDto = <span class="hljs-keyword">new</span> <span class="hljs-type">PayStatusDto</span>();<br>            payStatusDto.setOut_trade_no(out_trade_no);<br>            payStatusDto.setTrade_status(trade_status);<br>            payStatusDto.setApp_id(app_id);<br>            payStatusDto.setTrade_no(trade_no);<br>            payStatusDto.setTotal_amount(total_amount);<br><br>           <span class="hljs-comment">//处理逻辑。。。</span><br>            orderService.saveAliPayStatus(payStatusDto);<br>        &#125;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="接口测试-3"><a href="#接口测试-3" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h5><p>测试准备：</p><p>1、启动网关服务、认证服务、验证码服务、学习中心服务、内容管理服务。</p><p>2、发布一门收费课程。</p><p>测试流程：</p><p>1、对选课进行支付</p><p>2、支付成功跟踪service方法的日志，支付成功需要更新支付交易表记录的状态、通知时间、支付宝交易号、支付渠道(Alipay)</p><p>支付成功更新订单表的状态为空。</p><h3 id="支付通知"><a href="#支付通知" class="headerlink" title="支付通知"></a><strong>支付通知</strong></h3><h4 id="需求分析-3"><a href="#需求分析-3" class="headerlink" title="需求分析"></a>需求分析</h4><p>订单服务作为通用服务在订单支付成功后需要将支付结果异步通知给其它微服务。</p><p>下图使用了消息队列完成支付结果通知：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228150138159.png" alt="image-20231228150138159"></p><p>学习中心服务：对收费课程选课需要支付，与订单服务对接完成支付。</p><p>学习资源服务：对收费的学习资料需要购买后下载，与订单服务对接完成支付。</p><p>订单服务完成支付后将支付结果发给每一个与订单服务对接的微服务，订单服务将消息发给交换机，由交换机广播消息，每个订阅消息的微服务都可以接收到支付结果.</p><p>微服务收到支付结果根据订单的类型去更新自己的业务数据。</p><h4 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a><strong>技术方案</strong></h4><p>使用消息队列进行异步通信需要保证消息的可靠性，即生产端将消息成功通知到消费端</p><p>消息从生产端发送到消费端经历了如下过程：</p><ol><li>消息发送到交换机</li><li>消息由交换机发送到队列</li><li>消费者收到消息进行处理</li></ol><p>保证消息的可靠性需要保证以上过程的可靠性，本项目使用RabbitMQ可以通过如下方面保证消息的可靠性：</p><ol><li>生产者的确认机制</li></ol><p>发送消息前使用数据库事务将消息保存在数据库表中</p><p>成功发送到交换机将消息从数据库删除</p><ol start="2"><li>mq持久化</li></ol><p>mq收到消息进行持久化，当mq重启及时消息没有消费也不会丢失</p><p>需要配置交换机持久化，队列持久化，发送消息时设置持久化</p><ol start="3"><li>消费者确认机制</li></ol><p>消费者消费成功自动发送ack，否则重试消费</p><h4 id="发送支付结果"><a href="#发送支付结果" class="headerlink" title="发送支付结果"></a><strong>发送支付结果</strong></h4><h5 id="订单服务集成MQ"><a href="#订单服务集成MQ" class="headerlink" title="订单服务集成MQ"></a>订单服务集成MQ</h5><p>订单服务通过消息队列将支付结果发给学习中心服务，消息队列采用发布订阅模式。</p><ol><li>订单服务创建支付结果通知交换机</li><li>学习中心服务绑定队列到交换机</li></ol><p>项目使用RabbitMQ作为消息队列，在课前下发的虚拟上已经安装了RabbitMQ.</p><p>执行docker start rabbitmq 启动RabbitMQ。访问：<a href="http://192.168.101.65:15672/">http://192.168.101.65:15672/</a> </p><p>账户密码：guest&#x2F;guest</p><p>交换机为Fanout广播模式。</p><p>首先需要在学习中心服务和订单服务工程配置连接消息队列。</p><p>1、首先在订单服务添加消息队列依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml">XML<br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>2、在nacos配置rabbitmq-dev.yaml为通用配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">YAML</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span> <span class="hljs-comment">#correlated 异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback</span><br>    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#开启publish-return功能，同样是基于callback机制，需要定义ReturnCallback</span><br>    <span class="hljs-attr">template:</span><br>      <span class="hljs-attr">mandatory:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">none</span> <span class="hljs-comment">#出现异常时返回unack，消息回滚到mq；没有异常，返回ack ,manual:手动控制,none:丢弃消息，不回滚到mq</span><br>        <span class="hljs-attr">retry:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#开启消费者失败重试</span><br>          <span class="hljs-attr">initial-interval:</span> <span class="hljs-string">1000ms</span> <span class="hljs-comment">#初识的失败等待时长为1秒</span><br>          <span class="hljs-attr">multiplier:</span> <span class="hljs-number">1</span> <span class="hljs-comment">#失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span><br>          <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span> <span class="hljs-comment">#最大重试次数</span><br>          <span class="hljs-attr">stateless:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#true无状态；false有状态。如果业务中包含事务，这里改为false</span><br><br></code></pre></td></tr></table></figure><p>3、在订单服务接口工程引入rabbitmq-dev.yaml配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">shared-configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">rabbitmq-$&#123;spring.profiles.active&#125;.yaml</span><br>    <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-common</span><br>    <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure><p>4、在订单服务service工程编写MQ配置类，配置交换机</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.orders.config;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.*;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/2/23 16:59</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayNotifyConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br><br>    <span class="hljs-comment">//交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;paynotify_exchange_fanout&quot;</span>;<br>    <span class="hljs-comment">//支付结果通知消息类型</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MESSAGE_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;payresult_notify&quot;</span>;<br>    <span class="hljs-comment">//支付通知队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PAYNOTIFY_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;paynotify_queue&quot;</span>;<br><br>    <span class="hljs-comment">//声明交换机，且持久化</span><br>    <span class="hljs-meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span><br>    <span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title function_">paynotify_exchange_fanout</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-comment">//支付通知队列,且持久化</span><br>    <span class="hljs-meta">@Bean(PAYNOTIFY_QUEUE)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">course_publish_queue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build();<br>    &#125;<br><br>    <span class="hljs-comment">//交换机和支付通知队列绑定</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">binding_course_publish_queue</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="hljs-meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-comment">// 获取RabbitTemplate</span><br>        <span class="hljs-type">RabbitTemplate</span> <span class="hljs-variable">rabbitTemplate</span> <span class="hljs-operator">=</span> applicationContext.getBean(RabbitTemplate.class);<br>        <span class="hljs-comment">//消息处理service</span><br>        <span class="hljs-type">MqMessageService</span> <span class="hljs-variable">mqMessageService</span> <span class="hljs-operator">=</span> applicationContext.getBean(MqMessageService.class);<br>        <span class="hljs-comment">// 设置ReturnCallback</span><br>        rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -&gt; &#123;<br>            <span class="hljs-comment">// 投递失败，记录日志</span><br>            log.info(<span class="hljs-string">&quot;消息发送失败，应答码&#123;&#125;，原因&#123;&#125;，交换机&#123;&#125;，路由键&#123;&#125;,消息&#123;&#125;&quot;</span>,<br>                    replyCode, replyText, exchange, routingKey, message.toString());<br>            <span class="hljs-type">MqMessage</span> <span class="hljs-variable">mqMessage</span> <span class="hljs-operator">=</span> JSON.parseObject(message.toString(), MqMessage.class);<br>            <span class="hljs-comment">//将消息再添加到消息表</span><br>            mqMessageService.addMessage(mqMessage.getMessageType(),mqMessage.getBusinessKey1(),mqMessage.getBusinessKey2(),mqMessage.getBusinessKey3());<br><br>        &#125;);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>重启订单服务，登录rabbitmq，查看交换机自动创建成功</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228154534620.png" alt="image-20231228154534620"></p><p>查看队列自动成功</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228154549404.png" alt="image-20231228154549404"></p><h5 id="发送支付结果-1"><a href="#发送支付结果-1" class="headerlink" title="发送支付结果"></a><strong>发送支付结果</strong></h5><p>在OrderService中定义接口</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发送通知结果</span><br><span class="hljs-comment"> * @param message</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">notifyPayResult</span><span class="hljs-params">(MqMessage message)</span></span>;<br><br></code></pre></td></tr></table></figure><p>编写接口实现方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyPayResult</span><span class="hljs-params">(MqMessage message)</span> &#123;<br><br>    <span class="hljs-comment">//1、消息体，转json</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> JSON.toJSONString(message);<br>    <span class="hljs-comment">//设置消息持久化</span><br>    <span class="hljs-type">Message</span> <span class="hljs-variable">msgObj</span> <span class="hljs-operator">=</span> MessageBuilder.withBody(msg.getBytes(StandardCharsets.UTF_8))<br>            .setDeliveryMode(MessageDeliveryMode.PERSISTENT)<br>            .build();<br>    <span class="hljs-comment">// 2.全局唯一的消息ID，需要封装到CorrelationData中</span><br>    <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(message.getId().toString());<br>    <span class="hljs-comment">// 3.添加callback</span><br>    correlationData.getFuture().addCallback(<br>            result -&gt; &#123;<br>                <span class="hljs-keyword">if</span>(result.isAck())&#123;<br>                    <span class="hljs-comment">// 3.1.ack，消息成功</span><br>                    log.debug(<span class="hljs-string">&quot;通知支付结果消息发送成功, ID:&#123;&#125;&quot;</span>, correlationData.getId());<br>                    <span class="hljs-comment">//删除消息表中的记录</span><br>                    mqMessageService.completed(message.getId());<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-comment">// 3.2.nack，消息失败</span><br>                    log.error(<span class="hljs-string">&quot;通知支付结果消息发送失败, ID:&#123;&#125;, 原因&#123;&#125;&quot;</span>,correlationData.getId(), result.getReason());<br>                &#125;<br>            &#125;,<br>            ex -&gt; log.error(<span class="hljs-string">&quot;消息发送异常, ID:&#123;&#125;, 原因&#123;&#125;&quot;</span>,correlationData.getId(),ex.getMessage())<br>    );<br>    <span class="hljs-comment">// 发送消息</span><br>    rabbitTemplate.convertAndSend(PayNotifyConfig.PAYNOTIFY_EXCHANGE_FANOUT, <span class="hljs-string">&quot;&quot;</span>, msgObj,correlationData);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>订单服务收到第三方平台的支付结果时，在saveAliPayStatus方法中添加代码，向数据库消息表添加消息并进行发送消息，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveAliPayStatus</span><span class="hljs-params">(PayStatusDto payStatusDto)</span> &#123;<br>        .......<br>        <span class="hljs-comment">//保存消息记录,参数1：支付结果通知类型，2: 业务id，3:业务类型</span><br>        <span class="hljs-type">MqMessage</span> <span class="hljs-variable">mqMessage</span> <span class="hljs-operator">=</span> mqMessageService.addMessage(<span class="hljs-string">&quot;payresult_notify&quot;</span>, orders.getOutBusinessId(), orders.getOrderType(), <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//通知消息</span><br>        notifyPayResult(mqMessage);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>配置交换机和队列</p><p>在order-service工程配置</p><p>消息发送方法</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发送通知结果</span><br><span class="hljs-comment"> * @param message</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">notifyPayResult</span><span class="hljs-params">(MqMessage message)</span></span>;<br><br><br><br></code></pre></td></tr></table></figure><h4 id="接收支付结果"><a href="#接收支付结果" class="headerlink" title="接收支付结果"></a><strong>接收支付结果</strong></h4><h5 id="学习中心服务集成MQ"><a href="#学习中心服务集成MQ" class="headerlink" title="学习中心服务集成MQ"></a><strong>学习中心服务集成MQ</strong></h5><p>1、在学习中心服务添加消息队列依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">XML<br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>2、在学习中心服务接口工程引入rabbitmq-dev.yaml配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">YAML</span><br><span class="hljs-attr">shared-configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">rabbitmq-$&#123;spring.profiles.active&#125;.yaml</span><br>    <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-common</span><br>    <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure><p>3、添加配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.config;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.*;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/2/23 16:59</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayNotifyConfig</span> &#123;<br><br>    <span class="hljs-comment">//交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;paynotify_exchange_fanout&quot;</span>;<br>    <span class="hljs-comment">//支付结果通知消息类型</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MESSAGE_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;payresult_notify&quot;</span>;<br>    <span class="hljs-comment">//支付通知队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PAYNOTIFY_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;paynotify_queue&quot;</span>;<br><br>    <span class="hljs-comment">//声明交换机，且持久化</span><br>    <span class="hljs-meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span><br>    <span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title function_">paynotify_exchange_fanout</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-comment">//支付通知队列,且持久化</span><br>    <span class="hljs-meta">@Bean(PAYNOTIFY_QUEUE)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">course_publish_queue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build();<br>    &#125;<br><br>    <span class="hljs-comment">//交换机和支付通知队列绑定</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">binding_course_publish_queue</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="hljs-meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="接收支付结果-1"><a href="#接收支付结果-1" class="headerlink" title="接收支付结果"></a><strong>接收支付结果</strong></h5><p>监听MQ，接收支付结果，定义ReceivePayNotifyService类如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.xuecheng.base.exception.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.config.PayNotifyConfig;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.service.MyCourseTablesService;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 接收支付结果</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/2/23 19:04</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReceivePayNotifyService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MqMessageService mqMessageService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MyCourseTablesService myCourseTablesService;<br><br><br>    <span class="hljs-comment">//监听消息队列接收支付结果通知</span><br>    <span class="hljs-meta">@RabbitListener(queues = PayNotifyConfig.PAYNOTIFY_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(Message message, Channel channel)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">5000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-comment">//获取消息</span><br>        <span class="hljs-type">MqMessage</span> <span class="hljs-variable">mqMessage</span> <span class="hljs-operator">=</span> JSON.parseObject(message.getBody(), MqMessage.class);<br>        log.debug(<span class="hljs-string">&quot;学习中心服务接收支付结果:&#123;&#125;&quot;</span>, mqMessage);<br><br>        <span class="hljs-comment">//消息类型</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">messageType</span> <span class="hljs-operator">=</span> mqMessage.getMessageType();<br>        <span class="hljs-comment">//订单类型,60201表示购买课程</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">businessKey2</span> <span class="hljs-operator">=</span> mqMessage.getBusinessKey2();<br>        <span class="hljs-comment">//这里只处理支付结果通知</span><br>        <span class="hljs-keyword">if</span> (PayNotifyConfig.MESSAGE_TYPE.equals(messageType) &amp;&amp; <span class="hljs-string">&quot;60201&quot;</span>.equals(businessKey2)) &#123;<br>            <span class="hljs-comment">//选课记录id</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">choosecourseId</span> <span class="hljs-operator">=</span> mqMessage.getBusinessKey1();<br>            <span class="hljs-comment">//添加选课</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> myCourseTablesService.saveChooseCourseStauts(choosecourseId);<br>            <span class="hljs-keyword">if</span>(!b)&#123;<br>                <span class="hljs-comment">//添加选课失败，抛出异常，消息重回队列</span><br>                XueChengPlusException.cast(<span class="hljs-string">&quot;收到支付结果，添加选课失败&quot;</span>);<br>            &#125;<br>        &#125;<br><br><br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="通知支付结果测试"><a href="#通知支付结果测试" class="headerlink" title="通知支付结果测试"></a><strong>通知支付结果测试</strong></h4><p>测试准备：</p><p>1、找一门已发布的收费课程。</p><p>2、如果在我的课程表存储则删除。</p><p>3、删除此课程的选课记录及订单信息。</p><p>测试流程：</p><p>1、进入课程详细页面，点击马上学习，生成二维码进行支付。</p><p>2、支付完成点击“支付完成”，观察订单服务控制台是否发送消息。</p><p>3、观察学习中心服务控制台是否接收到消息。</p><p>4、观察数据库中的消息表的相应记录是否已删除。</p><p>消费重试测试：</p><p>1、在学习中心服务接收支付结果方法中制造异常。</p><p>2、重新执行上边的测试流程，观察是否消费重试。</p><h3 id="在线学习-1"><a href="#在线学习-1" class="headerlink" title="在线学习"></a><strong>在线学习</strong></h3><h4 id="需求分析-4"><a href="#需求分析-4" class="headerlink" title="需求分析"></a>需求分析</h4><p>用户通过课程详情界面点击马上学习，进入视频播放界面进行视频点播</p><p>获取视频资源时进行<strong>学习资格校验</strong>，如下图： </p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228160002856.png" alt="image-20231228160002856"></p><p>拥有学习资格则继续播放视频，不具有学习资格则引导去购买、续期等操作。</p><p><strong>如何判断是否拥有学习资格？</strong></p><p>首先判断是否为试学视频，如果为试学视频则可以正常学习。</p><p>如果为非试学课程首先判断用户是否登录，如果已登录则判断是否选课，如果已经选课且没有过期可以正常学习。</p><p>详细流程如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228160054086.png" alt="image-20231228160054086"></p><h4 id="查询课程信息"><a href="#查询课程信息" class="headerlink" title="查询课程信息"></a><strong>查询课程信息</strong></h4><p>在视频点播页面需要查询课程信息，课程上线后也需要访问&#x2F;api&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p><p>课程预览时请求获取课程的接口为：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p><p>在nginx中进行配置：</p><p>&#x2F;open、&#x2F;api在nginx的配置如下：(已经配置的不要重复配置)</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">Plain Text<br>        <span class="hljs-comment">#api</span><br>        <span class="hljs-keyword">location</span> <span class="hljs-title">/api</span>/ &#123;<br>                proxy_pass http://gatewayserver/;<br>        &#125; <br>        <span class="hljs-comment">#openapi</span><br>        <span class="hljs-keyword">location</span> <span class="hljs-title">/open</span>/content/ &#123;<br>                proxy_pass http://gatewayserver/content/open/;<br>        &#125; <br>        <span class="hljs-keyword">location</span> <span class="hljs-title">/open</span>/media/ &#123;<br>                proxy_pass http://gatewayserver/media/open/;<br>        &#125; <br><br></code></pre></td></tr></table></figure><p>下边实现&#x2F;api&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId} 获取课程发布信息接口。</p><p>进入内容管理服务api工程CoursePublishController 类，定义查询课程预览信息接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@ApiOperation(&quot;获取课程发布信息&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@GetMapping(&quot;/course/whole/&#123;courseId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> CoursePreviewDto <span class="hljs-title function_">getCoursePublish</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;<br>    <span class="hljs-comment">//查询课程发布信息</span><br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> coursePublishService.getCoursePublish(courseId);<br>    <span class="hljs-keyword">if</span> (coursePublish == <span class="hljs-literal">null</span>) &#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePreviewDto</span>();<br>     &#125;<br><br>    <span class="hljs-comment">//课程基本信息</span><br>    <span class="hljs-type">CourseBaseInfoDto</span> <span class="hljs-variable">courseBase</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseBaseInfoDto</span>();<br>    BeanUtils.copyProperties(coursePublish, courseBase);<br>    <span class="hljs-comment">//课程计划</span><br>    List&lt;TeachplanDto&gt; teachplans = JSON.parseArray(coursePublish.getTeachplan(), TeachplanDto.class);<br>    <span class="hljs-type">CoursePreviewDto</span> <span class="hljs-variable">coursePreviewInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePreviewDto</span>();<br>    coursePreviewInfo.setCourseBase(courseBase);<br>    coursePreviewInfo.setTeachplans(teachplans);<br>    <span class="hljs-keyword">return</span> coursePreviewInfo;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>重启内容管理服务，进入学习界面查看课程计划、课程名称等信息是否显示正常。</p><h4 id="获取视频"><a href="#获取视频" class="headerlink" title="获取视频"></a><strong>获取视频</strong></h4><h5 id="需求分析-5"><a href="#需求分析-5" class="headerlink" title="需求分析"></a>需求分析</h5><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228160632215.png" alt="image-20231228160632215"></p><h5 id="接口定义-3"><a href="#接口定义-3" class="headerlink" title="接口定义"></a>接口定义</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcCourseTablesDto;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.service.LearningService;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.service.MyCourseTablesService;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.util.SecurityUtil;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 学习过程管理接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/2 14:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = <span class="hljs-string">&quot;学习过程管理接口&quot;</span>, tags = <span class="hljs-string">&quot;学习过程管理接口&quot;</span>)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLearningController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    LearningService learningService;<br><br><br>    <span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;获取视频&quot;</span>)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/open/learn/getvideo/&#123;courseId&#125;/&#123;teachplanId&#125;/&#123;mediaId&#125;&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;String&gt; getvideo(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> courseId,<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> teachplanId, <span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;mediaId&quot;</span>)</span> String mediaId) &#123;<br>        <span class="hljs-comment">//登录用户</span><br>        XcUser user = SecurityUtil.getUser();<br>        String userId = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span>(user != <span class="hljs-literal">null</span>)&#123;<br>            userId = user.getId();<br>        &#125;<br>        <span class="hljs-comment">//获取视频</span><br>       <br><br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>定义service接口</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcCourseTablesDto;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 学习过程管理service接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/2 16:07</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LearningService</span> &#123;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 获取教学视频</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId 课程id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> teachplanId 课程计划id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mediaId 视频文件id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.String&gt;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/5 9:08</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> RestResponse&lt;String&gt; getVideo(String userId,<span class="hljs-built_in">Long</span> courseId,<span class="hljs-built_in">Long</span> teachplanId,String mediaId);<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>获取视频远程接口</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.feignclient;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CoursePublish;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RequestMapping;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 媒资管理服务远程接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/20 20:29</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@FeignClient(value = <span class="hljs-string">&quot;media-api&quot;</span>,fallbackFactory = MediaServiceClientFallbackFactory.class)</span><br> <span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/media&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MediaServiceClient</span> &#123;<br><br> <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/open/preview/&#123;mediaId&#125;&quot;</span>)</span><br> <span class="hljs-keyword">public</span> RestResponse&lt;String&gt; getPlayUrlByMediaId(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;mediaId&quot;</span>)</span> String mediaId);<br><br> &#125;<br> <br><br></code></pre></td></tr></table></figure><p>FeignClient接口的降级类：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br><br> package com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">feignclient</span>;<br><br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">base</span>.<span class="hljs-property">model</span>.<span class="hljs-property">RestResponse</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">content</span>.<span class="hljs-property">model</span>.<span class="hljs-property">po</span>.<span class="hljs-property">CoursePublish</span>;<br><span class="hljs-keyword">import</span> feign.<span class="hljs-property">hystrix</span>.<span class="hljs-property">FallbackFactory</span>;<br><span class="hljs-keyword">import</span> lombok.<span class="hljs-property">extern</span>.<span class="hljs-property">slf4j</span>.<span class="hljs-property">Slf4j</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> <span class="hljs-variable">TODO</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/3 8:03</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaServiceClientFallbackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;<span class="hljs-title class_">MediaServiceClient</span>&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MediaServiceClient</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">Throwable throwable</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaServiceClient</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-title class_">RestResponse</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">getPlayUrlByMediaId</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> mediaId</span>) &#123;<br>                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;远程调用媒资管理服务熔断异常：&#123;&#125;&quot;</span>,throwable.<span class="hljs-title function_">getMessage</span>());<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="学习资格校验"><a href="#学习资格校验" class="headerlink" title="学习资格校验"></a><strong>学习资格校验</strong></h5><p>编写获取视频的接口实现方法：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs autoit">Java<br><span class="hljs-symbol">@Override</span><br>public RestResponse&lt;<span class="hljs-built_in">String</span>&gt; getVideo(<span class="hljs-built_in">String</span> userId,Long courseId,Long teachplanId, <span class="hljs-built_in">String</span> mediaId) &#123;<br>    //查询课程信息<br>    CoursePublish coursepublish = contentServiceClient.getCoursepublish(courseId)<span class="hljs-comment">;</span><br>    <span class="hljs-keyword">if</span>(coursepublish==<span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;课程信息不存在&quot;</span>)<span class="hljs-comment">;</span><br>    &#125;<br>    //校验学习资格<br><br>    //如果登录<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(userId))&#123;<br><br>        //判断是否选课，根据选课情况判断学习资格<br>        XcCourseTablesDto xcCourseTablesDto = myCourseTablesService.getLeanringStatus(userId, courseId)<span class="hljs-comment">;</span><br>        //学习资格状态 [&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702001&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;正常学习&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702002&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;没有选课或选课后没有支付&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702003&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;已过期需要申请续期或重新支付&quot;</span>&#125;]<br>        <span class="hljs-built_in">String</span> learnStatus = xcCourseTablesDto.getLearnStatus()<span class="hljs-comment">;</span><br>        <span class="hljs-keyword">if</span>(learnStatus.equals(<span class="hljs-string">&quot;702001&quot;</span>))&#123;<br>            <span class="hljs-keyword">return</span> mediaServiceClient.getPlayUrlByMediaId(mediaId)<span class="hljs-comment">;</span><br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(learnStatus.equals(<span class="hljs-string">&quot;702003&quot;</span>))&#123;<br>            RestResponse.validfail(<span class="hljs-string">&quot;您的选课已过期需要申请续期或重新支付&quot;</span>)<span class="hljs-comment">;</span><br>        &#125;<br>    &#125;<br><br>    //未登录或未选课判断是否收费<br>    <span class="hljs-built_in">String</span> charge = coursepublish.getCharge()<span class="hljs-comment">;</span><br>    <span class="hljs-keyword">if</span>(charge.equals(<span class="hljs-string">&quot;201000&quot;</span>))&#123;//免费可以正常学习<br>        <span class="hljs-keyword">return</span> mediaServiceClient.getPlayUrlByMediaId(mediaId)<span class="hljs-comment">;</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-string">&quot;请购买课程后继续学习&quot;</span>)<span class="hljs-comment">;</span><br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a><strong>测试</strong></h5><p>1、完善接口</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;获取视频&quot;</span>)</span><br><span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/open/learn/getvideo/&#123;courseId&#125;/&#123;teachplanId&#125;/&#123;mediaId&#125;&quot;</span>)</span><br><span class="hljs-keyword">public</span> RestResponse&lt;String&gt; getvideo(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> courseId, <span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> teachplanId, <span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;mediaId&quot;</span>)</span> String mediaId) &#123;<br><br>    <span class="hljs-comment">//登录用户</span><br>    SecurityUtil.XcUser user = SecurityUtil.getUser();<br>    String userId = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>        userId = user.getId();<br>    &#125;<br>    <span class="hljs-comment">//获取视频</span><br>    <span class="hljs-keyword">return</span> learningService.getVideo(userId, courseId, teachplanId, mediaId);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>2、测试准备</p><p>选课成功一门课程。</p><p>没有选课的免费课程、收费课程各一门，其中收费课程具有试学课程。</p><p>3、测试项目</p><p>1）选课成功的课程是否可以正常获取视频</p><p>2）免费课程没有选课是否可以正常学习</p><p>可修改选课记录表中的课程id为不存在进行测试，测试完再恢复原样。</p><p>3）收费课程没有选课是否可以正常学习</p><p>可修改选课记录表中的课程id为不存在进行测试，测试完再恢复原样。</p><h4 id="我的课表"><a href="#我的课表" class="headerlink" title="我的课表"></a>我的课表</h4><h5 id="需求分析-6"><a href="#需求分析-6" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h5><h6 id="业务流程-1"><a href="#业务流程-1" class="headerlink" title="业务流程"></a>业务流程</h6><p>登录网站，点击“我的学习”进入个人中心，</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228161740547.png" alt="image-20231228161740547"></p><p>我的课表中显示了选课成功的免费课程、收费课程。最近学习课程显示了当前用户最近学习的课程信息。</p><p>点击继续学习进入当前学习章节的视频继续学习。</p><p>点击课程评价进入课程评价界面。</p><h6 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a><strong>配置nginx</strong></h6><p>在nginx配置用户中心server ,如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">XML</span><br>    server &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  ucenter.51xuecheng.cn;<br>        <span class="hljs-comment">#charset koi8-r;</span><br>        <span class="hljs-attribute">ssi</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">ssi_silent_errors</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">alias</span>   D:/itcast2022/xc_edu3.<span class="hljs-number">0</span>/code_1/xc-ui-pc-static-portal/ucenter/;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br>        <span class="hljs-section">location</span> /include &#123;<br>            <span class="hljs-attribute">proxy_pass</span>   http://127.0.0.1;<br>        &#125;<br>        <span class="hljs-section">location</span> /img/ &#123;<br>            <span class="hljs-attribute">proxy_pass</span>   http://127.0.0.1/static/img/;<br>        &#125;<br>        <span class="hljs-section">location</span> /api/ &#123;<br>                <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/;<br>        &#125; <br>   &#125;<br><br></code></pre></td></tr></table></figure><h6 id="接口定义-4"><a href="#接口定义-4" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h6><p>在MyCourseTablesController中定义我的课程表接口：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;我的课程表&quot;</span>)</span><br><span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/mycoursetable&quot;</span>)</span><br><span class="hljs-keyword">public</span> PageResult&lt;XcCourseTables&gt; mycoursetable(MyCourseTableParams params) &#123;<br>   <br><br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h5><h6 id="DAO"><a href="#DAO" class="headerlink" title="DAO"></a><strong>DAO</strong></h6><p>使用自动生成的mapper即可实现分页查询。</p><h6 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h6><p>在service中定义我的课程表接口：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">Java<br>/<span class="hljs-symbol">*</span><span class="hljs-symbol">*</span><br> <span class="hljs-symbol">*</span> <span class="hljs-meta">@description</span> 我的课程表<br> <span class="hljs-symbol">*</span> <span class="hljs-meta">@param</span> params<br> <span class="hljs-symbol">*</span> <span class="hljs-meta">@return</span> com.xuecheng.base.model.PageResult<span class="hljs-variable">&lt;com.xuecheng.learning.model.po.XcCourseTables&gt;</span><br> <span class="hljs-symbol">*</span> <span class="hljs-meta">@author</span> Mr.M<br> <span class="hljs-symbol">*</span> <span class="hljs-meta">@date</span> 2022/10/27 9:24<br><span class="hljs-symbol">*</span>/<br>public PageResult<span class="hljs-variable">&lt;XcCourseTables&gt;</span> mycourestabls(MyCourseTableParams params);<br><br></code></pre></td></tr></table></figure><p>编写接口实现：</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs lasso">Java<br><span class="hljs-keyword">public</span> PageResult&lt;XcCourseTables&gt; mycourestabls( MyCourseTableParams <span class="hljs-keyword">params</span>)&#123;<br>    <span class="hljs-comment">//页码</span><br>    long pageNo = <span class="hljs-keyword">params</span>.getPage();<br>    <span class="hljs-comment">//每页记录数,固定为4</span><br>    long pageSize = <span class="hljs-number">4</span>;<br>    <span class="hljs-comment">//分页条件</span><br>    Page&lt;XcCourseTables&gt; page = <span class="hljs-literal">new</span> Page&lt;&gt;(pageNo, pageSize);<br>    <span class="hljs-comment">//根据用户id查询</span><br>    <span class="hljs-built_in">String</span> userId = <span class="hljs-keyword">params</span>.getUserId();<br>    LambdaQueryWrapper&lt;XcCourseTables&gt; lambdaQueryWrapper = <span class="hljs-literal">new</span> LambdaQueryWrapper&lt;XcCourseTables&gt;().<span class="hljs-literal">eq</span>(XcCourseTables<span class="hljs-type">::getUserId</span>, userId);<br>    <br>    <span class="hljs-comment">//分页查询</span><br>    Page&lt;XcCourseTables&gt; pageResult = courseTablesMapper.selectPage(page, lambdaQueryWrapper);<br>    <span class="hljs-built_in">List</span>&lt;XcCourseTables&gt; <span class="hljs-keyword">records</span> = pageResult.getRecords();<br>    <span class="hljs-comment">//记录总数</span><br>    long total = pageResult.getTotal();<br>    PageResult&lt;XcCourseTables&gt; courseTablesResult = <span class="hljs-literal">new</span> PageResult&lt;&gt;(<span class="hljs-keyword">records</span>, total, pageNo, pageSize);<br>    <span class="hljs-keyword">return</span> courseTablesResult;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>完善接口：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">Java<br>@ApiOperation(<span class="hljs-string">&quot;我的课程表&quot;</span>)<br>@GetMapping(<span class="hljs-string">&quot;/mycoursetable&quot;</span>)<br>public PageResult<span class="hljs-tag">&lt;XcCourseTables&gt;</span> mycoursetable(MyCourseTableParams <span class="hljs-keyword">params</span>) &#123;<br> //登录用户<br> SecurityUtil.XcUser <span class="hljs-keyword">user</span> <span class="hljs-title">= SecurityUtil</span>.getUser();<br> if(<span class="hljs-keyword">user</span> <span class="hljs-title">== null</span>)&#123;<br>  XueChengPlusException.cast(<span class="hljs-string">&quot;请登录后继续选课&quot;</span>);<br> &#125;<br> <span class="hljs-keyword">String</span> userId = user.getId();<br>//设置当前的登录用户<br> <span class="hljs-keyword">params</span>.setUserId(userId);<br><br>  return myCourseTablesService.mycourestabls(<span class="hljs-keyword">params</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="接口测试-4"><a href="#接口测试-4" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h4><p>登录网站，点击“我的学习”进入个人中心，查看我的课程表中课程是否是当前用户所选课程。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228162734898.png" alt="image-20231228162734898"></p>]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
    <tags>
      
      <tag>学成在线</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学成在线认证授权模块</title>
    <link href="/2023/12/27/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97/"/>
    <url>/2023/12/27/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="认证授权模块"><a href="#认证授权模块" class="headerlink" title="认证授权模块"></a>认证授权模块</h2><h3 id="模块需求分析"><a href="#模块需求分析" class="headerlink" title="模块需求分析"></a>模块需求分析</h3><h4 id="什么是认证授权？"><a href="#什么是认证授权？" class="headerlink" title="什么是认证授权？"></a>什么是认证授权？</h4><p>截至目前，项目已经完成了课程发布功能，课程发布后用户通过在线学习页面点播视频进行学习。如何记录学生的学习过程？要想掌握学生的学习情况需要知道用户的身份信息，记录哪个用户什么时间学习什么课程，如果用户要购买课程需要知道用户身份信息，所以，去管理学生的学习过程最基本的要实现用户的身份认证。</p><p>认证授权模块实现平台所有用户的<strong>身份认证和用户授权</strong>功能。</p><blockquote><p>什么是用户身份认证？</p><p>用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证表现形式有：<strong>用户密码登录，微信扫码</strong>等方法</p><p>项目包括学生，学习机构老师，平台运营人员三类用户，不管哪一类用户在访问项目受保护的资源需要身份认证，比如：发布课程操作，需要学习机构老师首先登录系统成功，然后再执行发布课程操作。创建订单，需要学生用户首先登录系统，才可以创建订单。如图</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224135916160.png" alt="image-20231224135916160" style="zoom:67%;" /><p>什么是用户授权？</p><p>用户认证通过后访问系统的资源，系统会判断用户是否拥有访问资源权限，只<strong>允许访问有权限的系统资源</strong>，<strong>没有权限的资源无法访问</strong>，这个过程叫用户授权。比如：用户去发布课程，系统首先进行用户身份认证，认证通过后继续判断用户是否有发布课程的权限，如果没有权限则拒绝继续访问系统，如果有权限则继续发布课程</p><p>如图</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224140155582.png" alt="image-20231224140155582" style="zoom:67%;" /></blockquote><h4 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h4><h5 id="统一认证"><a href="#统一认证" class="headerlink" title="统一认证"></a>统一认证</h5><p>项目包括学生，学习机构老师，平台运营人员三类用户，三类用户使用统一的认证入口，如图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224145850718.png" alt="image-20231224145850718" style="zoom:50%;" /><p>用户输入账号和密码提交认证，认证通过则继续操作。</p><p>项目由统一认证服务受理用户的认证请求，如下图</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224145910870.png" alt="image-20231224145910870" style="zoom:67%;" /><p>认证通过由认证服务向给用户颁发令牌，相当于访问系统的通行证，用户拿着令牌去访问系统的资源。</p><h5 id="单点登录"><a href="#单点登录" class="headerlink" title="单点登录"></a><strong>单点登录</strong></h5><p>本项目基于微服务架构构建，微服务包括：内容管理服务，媒资管理服务，学习中心服务，系统管理服务等，为了提高用户体验，<code>用户只需要认证一次即可在多个拥有访问权限的系统访问</code>，这个功能叫<code>单点登录</code></p><p>引用百度百科：单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。</p><p>如下图，用户只需要认证一次，便可以在多个拥有访问权限的系统中访问。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224150315672.png" alt="image-20231224150315672" style="zoom:50%;" /><h5 id="第三方认证"><a href="#第三方认证" class="headerlink" title="第三方认证"></a>第三方认证</h5><p>为了提高用户体验，很多网站有扫码登录的功能，如：微信扫码登录、QQ扫码登录等。扫码登录的好处是用户不用输入账号和密码，操作简便，另外一个好处就是有利于用户信息的共享，互联网的优势就是资源共享，用户也是一种资源，对于一个新网站如果让用户去注册是很困难的，如果提供了微信扫码登录将省去用户注册的成本，是一种非常有效的推广手段。</p><p>微信扫码登录其中的原理正是使用了第三方认证，如下图</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224150349007.png" alt="image-20231224150349007" style="zoom:50%;" /><h3 id="Spring-Security-认证"><a href="#Spring-Security-认证" class="headerlink" title="Spring Security 认证"></a>Spring Security 认证</h3><h4 id="Spring-Security-介绍"><a href="#Spring-Security-介绍" class="headerlink" title="Spring Security 介绍"></a>Spring Security 介绍</h4><p>认证功能几乎是每个项目都具备的功能，并且它与业务无关，市面上有很多认证框架，如：Apache Shiro、CAS、Spring Security等。由于本项目基于Spring Cloud技术构建，Spring Security是spring家族的一份子且和Spring Cloud集成的很好，所以本项目选用Spring Security作为认证服务的技术框架。</p><p>Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架，它是一个专注于为 Java 应用程序提供身份验证和授权的框架。</p><p>项目主页：<a href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></p><p>Spring cloud Security： <a href="https://spring.io/projects/spring-cloud-security">https://spring.io/projects/spring-cloud-security</a></p><h4 id="认证授权入门"><a href="#认证授权入门" class="headerlink" title="认证授权入门"></a>认证授权入门</h4><h5 id="创建认证服务工程"><a href="#创建认证服务工程" class="headerlink" title="创建认证服务工程"></a>创建认证服务工程</h5><p>下面我们使用spring security框架快速构建认证授权功能体系</p><ol><li>部署认证服务功能</li></ol><p>从课程资料中拷贝xuecheng-plus-auth工程到自己的工程目录下。</p><p>此工程是一个普通的spring boot工程，可以连接数据库。</p><p>此工程不具备认证授权的功能</p><ol start="2"><li>创建数据库</li></ol><p>创建xc_users数据库</p><p>导入课程资料中的xcplus_users.sql脚本。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224193913439.png" alt="image-20231224193913439" style="zoom:50%;" /><p>在nacos中新增auth-service-dev.yaml：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">server</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">servlet</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">context-path</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/auth</span><br>  <span class="hljs-attribute">port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">63070</span><br><span class="hljs-attribute">spring</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">datasource</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">driver-class-name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attribute">url</span><span class="hljs-punctuation">:</span> <span class="hljs-string">jdbc:mysql://192.168.101.65:3306/xc402_users?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br>    <span class="hljs-attribute">username</span><span class="hljs-punctuation">:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attribute">password</span><span class="hljs-punctuation">:</span> <span class="hljs-string">mysql</span><br></code></pre></td></tr></table></figure><p>初始工程自带了一个Controller类，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.auth.controller;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 测试controller</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/27 17:25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> &#123;<br><br>  <span class="hljs-meta">@Autowired</span><br>  XcUserMapper userMapper;<br><br>  <span class="hljs-meta">@RequestMapping(&quot;/login-success&quot;)</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">loginSuccess</span><span class="hljs-params">()</span>&#123;<br><br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;登录成功&quot;</span>;<br>  &#125;<br><br><br>  <span class="hljs-meta">@RequestMapping(&quot;/user/&#123;id&#125;&quot;)</span><br>  <span class="hljs-keyword">public</span> XcUser <span class="hljs-title function_">getuser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> String id)</span>&#123;<br>    <span class="hljs-type">XcUser</span> <span class="hljs-variable">xcUser</span> <span class="hljs-operator">=</span> userMapper.selectById(id);<br>    <span class="hljs-keyword">return</span> xcUser;<br>  &#125;<br><br>  <span class="hljs-meta">@RequestMapping(&quot;/r/r1&quot;)</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">r1</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;访问r1资源&quot;</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@RequestMapping(&quot;/r/r2&quot;)</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">r2</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;访问r2资源&quot;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>启动工程，尝试访问  <a href="http://localhost:63070/auth/r/r1">http://localhost:63070/auth/r/r1</a> :</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224194407935.png" alt="image-20231224194407935" style="zoom:50%;" /><p>访问用户信息：<a href="http://localhost:63070/auth/user/52">http://localhost:63070/auth/user/52</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224194933546.png" alt="image-20231224194933546" style="zoom:50%;" /><h5 id="认证测试"><a href="#认证测试" class="headerlink" title="认证测试"></a>认证测试</h5><p>下边向auth认证工程集成Spring security，向pom.xml加入Spring Security所需要的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>重启工程，访问<a href="http://localhost:63070/auth/r/r1">http://localhost:63070/auth/r/r1</a></p><p>自动进入&#x2F;login登录页面，&#x2F;login是spring security提供的,此页面有几个css样式加载会稍微慢点，如下图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224200453107.png" alt="image-20231224200453107" style="zoom:50%;" /><p>账号和密码是多少呢？下一步需要进行安全配置。</p><p>拷贝课程资料下的WebSecurityConfig.java到config下需要三部分内容：</p><ol><li>用户信息</li></ol><p>在内存配置两个用户: zhangsan  lisi </p><p>zhangsan 用户拥有权限  p1 </p><p>lisi用户拥有的权限为p2</p><ol start="2"><li>密码方式</li></ol><p>暂时采用明文方式</p><ol start="3"><li>安全拦截机制</li></ol><p>&#x2F;r&#x2F;** 开头的请求需要认证</p><p>登录成功到成功页面</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-comment">//配置用户信息服务</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span><br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>            manager.createUser(User.withUsername(<span class="hljs-string">&quot;zhangsan&quot;</span>).password(<span class="hljs-string">&quot;123&quot;</span>).authorities(<span class="hljs-string">&quot;p1&quot;</span>).build());<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;lisi&quot;</span>).password(<span class="hljs-string">&quot;456&quot;</span>).authorities(<span class="hljs-string">&quot;p2&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> manager;<br>&#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//密码为明文方式</span><br>        <span class="hljs-keyword">return</span> NoOpPasswordEncoder.getInstance();<br>    &#125;<br><br>    <span class="hljs-comment">//配置安全拦截机制</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http<br>                .authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/r/**&quot;</span>).authenticated()<span class="hljs-comment">//访问/r开始的请求需要认证通过</span><br>                .anyRequest().permitAll()<span class="hljs-comment">//其它请求全部放行</span><br>                .and()<br>                .formLogin().successForwardUrl(<span class="hljs-string">&quot;/login-success&quot;</span>);<span class="hljs-comment">//登录成功跳转到/login-success</span><br>                http.logout().logoutUrl(<span class="hljs-string">&quot;/logout&quot;</span>);<span class="hljs-comment">//退出地址</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>重启工程</p><p>1、访问<a href="http://localhost:63070/auth/user/52">http://localhost:63070/auth/user/52</a> 可以正常访问</p><p>2、访问<a href="http://localhost:63070/auth/r/r1">http://localhost:63070/auth/r/r1</a> 显示（跳转到）登录页面</p><p>账号zhangsan，密码为123，如果输入的密码不正确会认证失败，输入正确显示登录成功。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224210819390.png" alt="image-20231224210819390" style="zoom:50%;" /><p>http.logout().logoutUrl(“&#x2F;logout”);配置了退出页面，认证成功后访问&#x2F;logout可退出登录。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224210849405.png" alt="image-20231224210849405" style="zoom:25%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224210903149.png" alt="image-20231224210903149" style="zoom:25%;" /></p><h5 id="授权测试"><a href="#授权测试" class="headerlink" title="授权测试"></a>授权测试</h5><p>用户认证通过去访问系统资源时spring security进行授权控制，判断用户是否有该资源的访问权限，如果有则继续访问，如果没有则拒绝访问。</p><p>下边测试授权功能：</p><p>1、配置用户拥有哪些权限。</p><p>在WebSecurityConfig类配置zhangsan拥有p1权限，lisi拥有p2权限。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span><br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;zhangsan&quot;</span>).password(<span class="hljs-string">&quot;123&quot;</span>).authorities(<span class="hljs-string">&quot;p1&quot;</span>).build());<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;lisi&quot;</span>).password(<span class="hljs-string">&quot;456&quot;</span>).authorities(<span class="hljs-string">&quot;p2&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> manager;<br>&#125;<br></code></pre></td></tr></table></figure><p>2、指定资源与权限的关系。</p><p>什么是系统的资源？</p><p>比如：查询一个用户的信息，用户信息就是系统的资源，要访问资源需要通过URL，所以我们在controller中定义的每个http的接口就是访问资源的接口。</p><p>下边在controller中配置&#x2F;r&#x2F;r1需要p1权限，&#x2F;r&#x2F;r2需要p2权限。</p><p>hasAuthority(‘p1’)表示拥有p1权限方可访问。</p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/r/r1&quot;)</span><br><span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;p1&#x27;)&quot;)</span><span class="hljs-comment">//拥有p1权限方可访问</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">r1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;访问r1资源&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">@RequestMapping(&quot;/r/r2&quot;)</span><br><span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;p2&#x27;)&quot;)</span><span class="hljs-comment">//拥有p2权限方可访问</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">r2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;访问r2资源&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>现在重启工程。</p><p>当访问以&#x2F;r&#x2F;开头的url时会判断用户是否认证，如果没有认证则跳转到登录页面，如果已经认证则判断用户是否具有该URL的访问权限，如果具有该URL的访问权限则继续，否则拒绝访问。</p><p>例如：</p><p>访问&#x2F;r&#x2F;r1，使用zhangsan登录可以正常访问，因为在&#x2F;r&#x2F;r1的方法上指定了权限p1，zhangsan用户拥有权限p1,所以可以正常访问。</p><p>访问&#x2F;r&#x2F;r1，使用lisi登录则拒绝访问，由于lisi用户不具有权限p1需要拒绝访问</p><p>注意：如果访问上不加@PreAuthorize，此方法没有授权控制。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224211328473.png" alt="image-20231224211328473" style="zoom:50%;" /><h5 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h5><p>通过测试<code>认证</code>和<code>授权</code>两个功能，我们了解了Spring Security的基本使用方法，下边了解它的工作流程。</p><p>Spring Security 所解决的问题是 <code>安全访问控制</code>，而安全访问控制功能其实就是对所有进入系统的请求进行<code>拦截</code>，<code>校验每个请求是否能访问它所期望的资源</code>，根据前边知识的学习，可以通过Filter或AOP等技术来实现，Security 对Web资源的保护靠 Filter 实现， 索引从 Filter 技术入手，深入Security原理</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224211635903.png" alt="image-20231224211635903" style="zoom:50%;" /><p>FilterChainProxy是一个代理，真正起作用的是FilterChainProxy中的SecurityFilterChain (过滤器链) 所包含的各个Filter，同时这些Filter作为Bean被Spring管理，他们是Spring Security的核心，各有各的职责，但他们并不直接处理用户的<code>认证</code>，也不直接处理用户的授权，而是把他们交给认证管理器（AuthenticationManager）和决策管理器（AccessDecisionManager）来处理</p><p>Spring Security功能是实现主要由一系列过滤器链相互配合完成</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224212214373.png" alt="image-20231224212214373"></p><p>下面介绍过滤器链中的主要的几个过滤器及其作用</p><p><code>SecurityContextPersistenceFilter</code> 这个Filter是整个拦截过程的<code>入口和出口</code>，也就是第一个和最后一个拦截器，会在请求开始时从配置好的SecurityContextRepository中获取SecurityContext，然后把它设置给SecurityContextHolder，在请求完成后将SecurityContextHolder持有的SecurityContext再保存到配置好的SecurityContextRepository，同时清除securityContextHolder 所持有的SecurityContext；</p><p><code>UsernamePasswordAuthenticationFilter</code> 用于处理来自表单提交的<code>认证</code>，该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的AuthenticationSuccessHandler 和 AuthenticationFailureHandler，这些都可以根据需求做相关改变；</p><p><code>FilterSecurityInterceptor</code> 用于保护web资源的，使用AccessDecisionManager对当前用户进行<code>授权</code>访问，签名已经详细访问过了；</p><p><code>ExceptionTranslationFilter</code> 能够捕获来自 FilterChain 的所有异常，并进行处理，但它只会处理两类异常： AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。</p><p>Spring Security的执行流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224213256012.png" alt="image-20231224213256012"></p><ol><li>用户提交用户名，密码被SecurityFilterChain中的  <code>UsernamePasswordAuthenticationFilter</code>过滤器获取到，封装为请求Authentication，通常情况下是 UsernamePasswordAuthenticationToken 实现类</li><li>然后过滤器将<code>Authentication</code>提交至认证管理器<code>AuthenticationManager</code>进行认证。</li><li>认证成功后， <code>AuthenticationManager</code>身份管理器返回一个被填充满了信息的 (权限信息，身份信息，细节信息，但密码通常会被删除) <code>Authentication</code> 实例</li><li><code>SecurityContextHolder</code> 安全上下文容器将第3步填充了信息的 <code>Authentication</code>，通过SecurityContextHolder.getContext().setAuthentication(…)方法，设置到其中。</li><li>可以看出<code>AuthenticationManager</code>接口（<code>认证管理器</code>）是认证相关的核心接口，也是发起认证的出发点，他的实现类是 <code>ProviderManager</code>，而 Spring Security 支持多种认证方式，因此 <code>ProviderManager</code> 维护了一个 <code>List&lt;AuthenticationProvider&gt;</code> 列表，支持多种认证方式，最终实际的认证工作是由 <code>AuthenticationProvider</code> 完成的。<strong>Web表单</strong>对应 -&gt; 的<code>AuthentitaionProvider</code>实现类是<code>DaoAuthenticationProvider</code>，它的内部维护着一个 <code>UserDetailsService</code> 负责 <code>UserDetails</code> 的获取，最终<code> AuthenticationProvider</code> 将 <code>UserDetails</code> 填充到 <code>Authentication</code></li></ol><h4 id="什么是OAuth2"><a href="#什么是OAuth2" class="headerlink" title="什么是OAuth2"></a>什么是OAuth2</h4><h5 id="OAuth2认证流程"><a href="#OAuth2认证流程" class="headerlink" title="OAuth2认证流程"></a>OAuth2认证流程</h5><p>前面提到<code>微信扫码认证</code>，这是一种<code>第三方认证</code>方式，这种认证方式基于 OAuth2 协议实现的</p><p>OAuth 协议为用户资源提供一个安全，开放，简易的标准。同时，任何第三方都可以使用 OAuth 认证服务，任何服务提供商都可以实现自身的OAuth认证服务，因而OAuth是开放的。业界提供了OAuth的多种实现入PHP，JS，JAVA，Ruby等语言开发包，节约程序员时间，因此OAUTH是简易的。互联网很多服务如Open API，很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。</p><p>Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。</p><p>参考：<a href="https://baike.baidu.com/item/oAuth/7153134?fr=aladdin">https://baike.baidu.com/item/oAuth/7153134?fr=aladdin</a></p><p>Oauth协议：<a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a></p><p>下面分析一个 Oauth2 认证的例子，黑马程序员网站使用微信认证扫码登录过程：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224215931088.png" alt="image-20231224215931088"></p><p>具体流程如下：</p><ol><li>用户点击微信扫码</li></ol><p>用户进入黑马程序登录页面，点击微信图标打开微信扫码页面</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224220018348.png" alt="image-20231224220018348" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224220029966.png" alt="image-20231224220029966" style="zoom: 33%;" /></p><p>微信扫码目的是通过微信获取当前用户的身份信息才会让当前用户在黑马网站登录成功</p><p>现在搞清几个概念？</p><p>资源：用户信息，在微信中存储</p><p>资源拥有者：用户是用户信息资源的拥有者</p><p>认证服务：微信负责认证当前用户的身份，负责为客户端颁发令牌</p><p>客户端：客户端会携带令牌请求微信获取用户信息，黑马程序网站即客户端，黑马网站需在浏览器打开</p><ol start="2"><li>用户授权黑马网站访问用户信息</li></ol><p>资源拥有者扫描二维码表示资源拥有者请求微信进行认证，微信认证通过向用户手机返回授权页面，如下图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224221619711.png" alt="image-20231224221619711" style="zoom:50%;" /><p>询问用户是否授权黑马程序员访问自己在微信的用户信息，用户点击“确认登录”表示同意授权，微信认证服务器颁发一个授权码给黑马程序员网站</p><p>只有资源拥有者同意，微信才允许黑马网站访问资源</p><ol start="3"><li>黑马程序员网站获取一个<code>授权码</code></li><li>携带授权码请求微信认证服务器申请令牌，此交互过程用户看不到</li><li>微信认证服务器向黑马程序员网站响应令牌，此交互过程用户看不到</li><li>黑马程序员网站请求微信资源服务器获取资源即用户信息，黑马程序员网站携带<code>令牌</code>请求访问微信服务器获取用户基本信息</li><li>资源服务器返回受保护的资源，即用户信息</li><li>黑马网站接收到用户信息，此时用户在黑马网站登录成功</li></ol><p>理解了微信扫码登录黑马网站流程，接下来认识Oauth2.0的认证流程，如下：</p><p>引自Oauth2.0协议rfc6749 <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224222136941.png" alt="image-20231224222136941" style="zoom:50%;" /><p>Oauth2包括以下角色：</p><p>1、客户端</p><p>本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：手机客户端、浏览器等。</p><p>上边示例中黑马网站即为客户端，它需要通过浏览器打开。</p><p>2、资源拥有者</p><p>通常为用户，也可以是应用程序，即该资源的拥有者。</p><p>A表示 客户端请求资源拥有者授权。</p><p>B表示 资源拥有者授权客户端即黑马网站访问自己的用户信息。</p><p>3、授权服务器（也称认证服务器）</p><p>认证服务器对资源拥有者进行认证，还会对客户端进行认证并颁发令牌。</p><p>C 客户端即黑马网站携带授权码请求认证。</p><p>D认证通过颁发令牌。</p><p>4、资源服务器</p><p>存储资源的服务器。</p><p>E表示客户端即黑马网站携带令牌请求资源服务器获取资源。</p><p>F表示资源服务器校验令牌通过后提供受保护资源。</p><h5 id="OAuth2在本项目的应用"><a href="#OAuth2在本项目的应用" class="headerlink" title="OAuth2在本项目的应用"></a>OAuth2在本项目的应用</h5><p>Oauth2是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用Oauth2，本项目使用Oauth2实现如下目标：</p><p>1、学成在线访问第三方系统的资源。</p><p>本项目要接入微信扫码登录所以本项目要使用OAuth2协议访问微信中的用户信息。</p><p>2、外部系统访问学成在线的资源 。</p><p>同样当第三方系统想要访问学成在线网站的资源也可以基于OAuth2协议。</p><p>3、学成在线前端（客户端） 访问学成在线微服务的资源。</p><p>本项目是前后端分离架构，前端访问微服务资源也可以基于OAuth2协议进行认证。</p><h5 id="OAuth2的授权模式"><a href="#OAuth2的授权模式" class="headerlink" title="OAuth2的授权模式"></a>OAuth2的授权模式</h5><p>四种模式中<code>授权码模式</code>和<code>密码模式</code>应用Spring Security支持OAuth2认证，<code>OAuth2</code>提供授权码模式、密码模式、简化模式、客户端模式等<code>四种授权模式</code>，前边举的微信扫码登录的例子就是基于<code>授权码模式</code>，这较多，本节使用Spring Security演示<code>授权码模式、密码模式</code>，其余两种请自行查阅相关资料。</p><h6 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h6><p>OAuth2的几个授权模式是根据不同的应用场景以不同的方式去获取令牌，最终目的是要获取认证服务颁发的令牌，最终通过令牌去获取资源。</p><p>授权码模式简单理解是使用<code>授权码</code>去<code>获取令牌</code>，要想获取令牌先要<code>获取授权码</code>，授权码的获取需要资源拥有者亲自<code>授权同意</code>才可以获取。</p><p>下图是授权码模式的交互图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224233859129.png" alt="image-20231224233859129" style="zoom:50%;" /><p>以黑马网站微信扫码登录为例进行说明：</p><ol><li>用户打开浏览器</li><li>通过浏览器访问客户端（黑马网站）</li><li>用户通过浏览器向认证服务请求<strong>授权</strong>，请求授权时会携带客户端的URL，此URL为下发授权码的重定向地址</li><li>认证服务向资源拥有者返回授权页面</li><li>资源拥有者亲自授权同意</li><li>通过浏览器向认证服务发送授权同意</li><li>认证服务向客户端地址重定向并携带授权码</li><li>客户端收到授权码</li><li>客户端携带授权码向认证服务申请令牌</li><li>认证服务向客户端颁发令牌</li></ol><pre><code class=" mermaid">graph LR用户 --授权同意--&gt; 客户端 --发送授权同意--&gt; 认证服务认证服务1 --授权码--&gt; 客户端1客户端2 --携带授权码申请令牌--&gt; 认证服务2认证服务3 --颁发令牌--&gt; 客户端3</code></pre><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224235114107.png" alt="image-20231224235114107"></p><h6 id="授权码模式测试"><a href="#授权码模式测试" class="headerlink" title="授权码模式测试"></a>授权码模式测试</h6><p>1、从课程资料中拷贝 AuthorizationServer.java、TokenConfig.java到认证服务的config包下。</p><p>说明“：AuthorizationServer用 @EnableAuthorizationServer 注解标识并继承AuthorizationServerConfigurerAdapter来配置OAuth2.0 授权服务器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.auth.config;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpMethod;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.AuthorizationServerTokenServices;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 授权服务器配置</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/26 22:25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableAuthorizationServer</span> <span class="hljs-comment">//启用授权服务器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationServer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizationServerConfigurerAdapter</span> &#123;<br></code></pre></td></tr></table></figure><p>AuthorizationServerConfigurerAdapter要求配置以下几个类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationServerConfigurerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthorizationServerConfigurer</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AuthorizationServerConfigurerAdapter</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerSecurityConfigurer security)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><ol><li>ClientDetailsServiceConfigurer 用来配置客户端详情服务（ClientDetailsService），随便一个客户端都可以随便接入到它的认证服务吗？错，服务提供商会给批准介入的客户端一个<code>身份</code>，用于接入时的<code>凭据</code>，有<code>客户端标识和客户端密钥</code>，在这里配置批准介入的<code>客户端的详细信息</code></li><li>AuthorizationServerEndpointsConfigurer 用来配置令牌（token）的访问端点和令牌服务（token services）</li><li>AuthorizationServerSecurityConfigurer：用来配置令牌端点的安全约束.</li></ol><p>2.TokenConfig为令牌策略配置类</p><p>暂时先使用InMemoryTokenStore在内存存储令牌，令牌的有效期等信息配置如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//令牌管理服务</span><br><span class="hljs-meta">@Bean(name=&quot;authorizationServerTokenServicesCustom&quot;)</span><br><span class="hljs-keyword">public</span> AuthorizationServerTokenServices <span class="hljs-title function_">tokenService</span><span class="hljs-params">()</span> &#123;<br>    DefaultTokenServices service=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTokenServices</span>();<br>    service.setSupportRefreshToken(<span class="hljs-literal">true</span>);<span class="hljs-comment">//支持刷新令牌</span><br>    service.setTokenStore(tokenStore);<span class="hljs-comment">//令牌存储策略</span><br>    service.setAccessTokenValiditySeconds(<span class="hljs-number">7200</span>); <span class="hljs-comment">// 令牌默认有效期2小时</span><br>    service.setRefreshTokenValiditySeconds(<span class="hljs-number">259200</span>); <span class="hljs-comment">// 刷新令牌默认有效期3天</span><br>    <span class="hljs-keyword">return</span> service;<br>&#125;<br></code></pre></td></tr></table></figure><p>3.配置认证管理bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-comment">// 配置认证管理bean</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br></code></pre></td></tr></table></figure><p>重启认证服务</p><blockquote><p>注意：关闭所有代理</p></blockquote><ol><li>get请求获取授权码</li></ol><p>地址: </p><p><a href="http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&response_type=code&scope=all&redirect_uri=http://www.51xuecheng.cn">http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</a></p><p>参数列表如下：</p><p>•     client_id：客户端准入标识。</p><p>•     response_type：授权码模式固定为code。</p><p>•     scope：客户端权限。</p><p>•     redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）。</p><p>输入账号zhangsan、密码123登录成功，输入&#x2F;oauth&#x2F;authorize?client_id&#x3D;XcWebApp&amp;response_type&#x3D;code&amp;scope&#x3D;all&amp;redirect_uri&#x3D;<a href="http://www.51xuecheng.cn/">http://www.51xuecheng.cn</a></p><p>显示授权页面</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226100944623.png" alt="image-20231226100944623"></p><p>授权“XcWebApp”访问自己的受保护资源?</p><p>选择同意。</p><p>2、请求成功，重定向至<a href="http://www.51xuecheng.cn/?code=%E6%8E%88%E6%9D%83%E7%A0%81%EF%BC%8C%E6%AF%94%E5%A6%82%EF%BC%9Ahttp://www.51xuecheng.cn/?code=Wqjb5H">http://www.51xuecheng.cn/?code=授权码，比如：http://www.51xuecheng.cn/?code=Wqjb5H</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226101103155.png" alt="image-20231226101103155" style="zoom:50%;" /><p>3、使用httpclient工具post申请令牌</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">### 授权码模式<br>### 第一步申请授权码(浏览器请求)/oauth/authorize?client_id=c1&amp;response_type=code&amp;scope=all&amp;redirect_uri=http<span class="hljs-punctuation">:</span><span class="hljs-comment">//www.51xuecheng.cn</span><br>### 第二步申请令牌<br>### 将授权码进行替换<br>###### 授权码模式<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>auth_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=authorization_code&amp;code=<span class="hljs-number">8</span>k39Al&amp;redirect_uri=http<span class="hljs-punctuation">:</span><span class="hljs-comment">//www.51xuecheng.cn</span><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226104100548.png" alt="image-20231226104100548"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;access_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0f7edccc-7a63-44b0-a520-963198dbca90&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;token_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bearer&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;refresh_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;b0d51a8f-1bbf-44a3-be7b-794953208b20&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;expires_in&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7199</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;scope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;all&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>说明：</p><p>1、access_token，访问令牌，用于访问资源使用。</p><p>2、token_type，bearer是在RFC6750中定义的一种token类型，在携带令牌访问资源时需要在head中加入bearer 空格 令牌内容</p><p>3、refresh_token，当令牌快过期时使用刷新令牌可以再次生成令牌。</p><p>4、expires_in：过期时间（秒）</p><p>5、scope，令牌的权限范围，服务端可以根据令牌的权限范围去对令牌授权。</p><h6 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h6><p>密码模式相对授权码模式简单，授权码模式需要借助浏览器供用户亲自授权，密码模式不用借助浏览器，如下图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226104244665.png" alt="image-20231226104244665" style="zoom:50%;" /><ol><li>资源拥有者提供账号和密码</li><li>客户端向认证服务申请令牌，请求中携带账号和密码</li><li>认证服务校验账号密码正确，颁发令牌</li></ol><p>开始测试：</p><p>1、POST请求获取令牌</p><p>&#x2F;oauth&#x2F;token?client_id&#x3D;XcWebApp&amp;client_secret&#x3D;XcWebApp&amp;grant_type&#x3D;password&amp;username&#x3D;shangsan&amp;password&#x3D;123</p><p>参数列表如下：</p><p>•     client_id：客户端准入标识。</p><p>•     client_secret：客户端秘钥。</p><p>•     grant_type：授权类型，填写password表示密码模式</p><p>•     username：资源拥有者用户名。</p><p>•     password：资源拥有者密码。</p><p>2、授权服务器将令牌（access_token）发送给client</p><p>使用httpclient进行测试</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dts">Java<br><span class="hljs-meta">### 密码模式</span><br><span class="hljs-title class_">POST</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>auth_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">/auth/</span>oauth/token?client_<span class="hljs-attr">id</span><span class="hljs-operator">=</span>XcWebApp<span class="hljs-variable">&amp;client_secret</span>=XcWebApp<span class="hljs-variable">&amp;grant_type</span>=password<span class="hljs-variable">&amp;username</span>=zhangsan<span class="hljs-variable">&amp;password</span>=<span class="hljs-number">123</span><br><br></code></pre></td></tr></table></figure><p>返回示例：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226104446104.png" alt="image-20231226104446104"></p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">JSON</span><br>&#123;<br>  <span class="hljs-string">&quot;access_token&quot;</span>: <span class="hljs-string">&quot;368b1ee7-a9ee-4e9a-aae6-0fcab243aad2&quot;</span>,<br>  <span class="hljs-string">&quot;token_type&quot;</span>: <span class="hljs-string">&quot;bearer&quot;</span>,<br>  <span class="hljs-string">&quot;refresh_token&quot;</span>: <span class="hljs-string">&quot;3d56e139-0ee6-4ace-8cbe-1311dfaa991f&quot;</span>,<br>  <span class="hljs-string">&quot;expires_in&quot;</span>: <span class="hljs-number">6806</span>,<br>  <span class="hljs-string">&quot;scope&quot;</span>: <span class="hljs-string">&quot;all&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>这种模式十分简单，但是却意味着直接将<code>用户敏感信息泄漏</code>给了client，因此这就说明这种模式只能用于client是我们自己开发的情况下。</p><h6 id="本项目的应用方式"><a href="#本项目的应用方式" class="headerlink" title="本项目的应用方式"></a>本项目的应用方式</h6><p>通过演示授权码模式和密码模式，授权码模式适合客户端和认证服务非同一个系统的情况，所以本项目使用授权码模式完成微信扫码认证。本项目采用密码模式作为前端请求微服务的认证方式。</p><h4 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h4><h5 id="普通令牌的问题"><a href="#普通令牌的问题" class="headerlink" title="普通令牌的问题"></a>普通令牌的问题</h5><p>客户申请到令牌，接下来客户端携带令牌去访问资源，到资源服务器将会校验令牌合法性</p><p>资源服务器如何校验令牌的合法性？</p><p>我们以OAuth2的密码模式为例进行说明：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226113249085.png" alt="image-20231226113249085" style="zoom:50%;" /><p>从第4步开始说明：</p><ol><li>客户端携带令牌访问资源服务获取资源</li><li>资源服务远程请求认证服务校验令牌合法性</li><li>如果令牌合法资源服务向客户端返回资源</li></ol><p>这里有一个问题：</p><p>校验令牌需要远程请求认证服务，客户端每次访问都会远程校验，执行性能低，如果让资源服务自己校验令牌合法性将省去远程请求认证服务的成本，提高性能</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226113456327.png" alt="image-20231226113456327" style="zoom:50%;" /><p>如何解决上面问题，实现资源服务自行校验令牌</p><p>令牌采用JWT格式即可解决上面问题，用户认证通过后得到一个JWT令牌</p><p>JWT令牌包括用户相关的信息，客户端只需要携带JWT访问资源服务，资源服务根据事先约定的算法自行完成令牌校验，无需每次请求认证服务完成授权</p><h5 id="什么是JWT"><a href="#什么是JWT" class="headerlink" title="什么是JWT"></a>什么是JWT</h5><p>JSON Web Token JWT 是一种使用JSON格式传递网络令牌技术，它是一个开放的行业标准（RFC 7519），它定义了一种简洁的、自包含的协议格式，用于通信双方传递json对象，传递的信息经过数字签名可以被验证和信任，可以使用HMAC算法或使用RSA的公钥&#x2F;私钥来签名，防止内容篡改。</p><p>官网：<a href="https://jwt.io/">https://jwt.io/</a></p><p>使用JWT可以实现无状态认证，什么是无状态认证？</p><p>传统基于session的方式是有状态认证，用户登录成功将<code>用户身份信息存储在服务端</code>，加大了服务端的存储压力，并且这种方式不适合分布式系统应用</p><p>如图，当用户访问应用服务，每个应用服务都会去服务器查看session信息，如果session中没有该用户则说明用户没有登录，此时会重新认证，而解决这个问题的方法是session复制&#x2F;粘贴<br><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226114121004.png" alt="image-20231226114121004" style="zoom:50%;" /></p><p>如果基于令牌技术在分布式系统实现认证则服务端不用存储session，可以将用户信息存在令牌，用户认证通过认证服务颁发令牌，用户将令牌存在客户端，去访问应用服务携带令牌，服务端从jwt解析用户信息，这个过程是无状态认证</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226114240112.png" alt="image-20231226114240112" style="zoom:50%;" /><p>jwt令牌优点：</p><ol><li>基于json，方便解析</li><li>在令牌自定义内容，易于扩展</li><li>通过非对称加密算法及数字签字技术，jwt防止篡改，安全</li><li>资源服务使用jwt可以不依赖认证服务即可完成授权</li></ol><p>缺点：</p><p>１、JWT令牌较长，占存储空间比较大。</p><p>下边是一个JWT令牌的示例：</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Plain</span> <span class="hljs-built_in">Text</span><br><span class="hljs-variable">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><span class="hljs-operator">.</span><span class="hljs-variable">eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQyNTQ2NzIsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijg4OTEyYjJkLTVkMDUtNGMxNC1iYmMzLWZkZTk5NzdmZWJjNiIsImNsaWVudF9pZCI6ImMxIn0</span><span class="hljs-operator">.</span><span class="hljs-variable">wkDBL7roLrvdBG2oGnXeoXq</span><span class="hljs-operator">-</span><span class="hljs-variable">zZRgE9IVV2nxd</span><span class="hljs-operator">-</span><span class="hljs-type">ez_oA</span><br><br></code></pre></td></tr></table></figure><p>jwt令牌由3部分组成，中间使用点分隔， 比如： xxxxx.yyyyy.zzzzz</p><ol><li>Header</li></ol><p>头部包括令牌的类型(jwt)，及哈希算法</p><p>一个例子如下：</p><p> 下边是Header部分的内容</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">JSON<br>   <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;alg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HS256&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;typ&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JWT&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p> 将上边的内容使用Base64Url编码，得到一个字符串就是JWT令牌的第一部分。</p><ol start="2"><li>Payload</li></ol><p>第二部分是负载，内容是一个json对象，是存放有效信息的地方，可以存放jwt提供的信息字段，比如：iss（签发者）exp（过期时间戳）sub（面向的用户）等，可以自定义字段</p><p> 此部分不建议存放敏感信息，因为此部分可以解码还原原始内容。</p><p>最后将第二部分负载使用Base64Url编码，得到一个字符串就是JWT令牌的第二部分。</p><p> 一个例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;sub&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1234567890&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;456&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;admin&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><ol start="3"><li>Signature</li></ol><p> 第三部分是签名，此部分用于防止jwt内容被篡改。</p><p> 这个部分使用base64url将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用header中声明的签名算法进行签名。</p><p> 一个例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JSON">HMACSHA256(<br>  base64UrlEncode(header) + <span class="hljs-string">&quot;.&quot;</span> +<br>  base64UrlEncode(payload)<span class="hljs-punctuation">,</span><br>  secret)<br><br></code></pre></td></tr></table></figure><p>base64UrlEncode(header)：jwt令牌的第一部分。</p><p>base64UrlEncode(payload)：jwt令牌的第二部分。</p><p>secret：签名所使用的密钥。</p><p><code>为什么JWT可以防止篡改？</code></p><p>第三部分使用签名算法对第一部分和第二部分的内容进行签名，常用的签名算法是 HS256，常见的还有md5,sha 等，签名算法需要使用密钥进行签名，密钥不对外公开，并且签名是不可逆的，如果第三方更改了内容那么服务器验证签名就会失败，要想保证验证签名正确必须保证内容、密钥与签名前一致。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226114917649.png" alt="image-20231226114917649" style="zoom:50%;" /><p>从上图可以看出认证服务和资源服务使用相同的密钥，这叫对称加密，对称加密效率高，如果一旦密钥泄露可以伪造jwt令牌。</p><p>JWT还可以使用非对称加密，认证服务自己保留私钥，将公钥下发给受信任的客户端、资源服务，公钥和私钥是配对的，成对的公钥和私钥才可以正常加密和解密，非对称加密效率低但相比对称加密非对称加密更安全一些。</p><h5 id="测试生成JWT令牌"><a href="#测试生成JWT令牌" class="headerlink" title="测试生成JWT令牌"></a>测试生成JWT令牌</h5><p>在认证服务中配置jwt令牌服务，即可实现生成jwt格式的令牌, </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.auth.config;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.AuthorizationServerTokenServices;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultTokenServices;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancerChain;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Administrator</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenConfig</span> &#123;<br><br>    <span class="hljs-comment">// 密钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">SIGNING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mq123&quot;</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    TokenStore tokenStore;<br><br>    <span class="hljs-comment">/*@Bean</span><br><span class="hljs-comment">    public TokenStore tokenStore() &#123;</span><br><span class="hljs-comment">        //使用内存存储令牌（普通令牌）</span><br><span class="hljs-comment">        return new InMemoryTokenStore();</span><br><span class="hljs-comment">    &#125;*/</span><br><br>    <span class="hljs-comment">//Jwt 访问令牌转换器</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JwtAccessTokenConverter accessTokenConverter;<br><br>    <span class="hljs-comment">//令牌商店</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> TokenStore <span class="hljs-title function_">tokenStore</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenStore</span>(accessTokenConverter());<br>    &#125;<br><br>    <span class="hljs-comment">//访问令牌转换器</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title function_">accessTokenConverter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">JwtAccessTokenConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessTokenConverter</span>();<br>        converter.setSigningKey(SIGNING_KEY);<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br><br>    <span class="hljs-comment">//令牌管理服务</span><br>    <span class="hljs-meta">@Bean(name=&quot;authorizationServerTokenServicesCustom&quot;)</span><br>    <span class="hljs-keyword">public</span> AuthorizationServerTokenServices <span class="hljs-title function_">tokenService</span><span class="hljs-params">()</span> &#123;<br>        DefaultTokenServices service=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTokenServices</span>();<br>        service.setSupportRefreshToken(<span class="hljs-literal">true</span>);<span class="hljs-comment">//支持刷新令牌</span><br>        service.setTokenStore(tokenStore);<span class="hljs-comment">//令牌存储策略</span><br><br>        <span class="hljs-type">TokenEnhancerChain</span> <span class="hljs-variable">tokenEnhancerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenEnhancerChain</span>();<br>        tokenEnhancerChain.setTokenEnhancers(Arrays.asList(accessTokenConverter));<br>        service.setTokenEnhancer(tokenEnhancerChain);<br><br>        service.setAccessTokenValiditySeconds(<span class="hljs-number">7200</span>); <span class="hljs-comment">// 令牌默认有效期2小时</span><br>        service.setRefreshTokenValiditySeconds(<span class="hljs-number">259200</span>); <span class="hljs-comment">// 刷新令牌默认有效期3天</span><br>        <span class="hljs-keyword">return</span> service;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226120332267.png" alt="image-20231226120332267"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;access_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE3MDM1NzA1ODAsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6IjZlZTMyNjUzLTlmMzctNGE2My04NTY1LTQ0ODgwNjFlOGZiZCIsImNsaWVudF9pZCI6IlhjV2ViQXBwIn0.2romuPqN8siRBX9B65wgpaZL5bfatPWNSLdfUW3oK6g&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;token_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bearer&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;refresh_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJhdGkiOiI2ZWUzMjY1My05ZjM3LTRhNjMtODU2NS00NDg4MDYxZThmYmQiLCJleHAiOjE3MDM4MjI1ODAsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImM4MmQyNmNkLWQ1MjItNDE1Zi05ZGZmLWMxODI5YjI3YzQwMiIsImNsaWVudF9pZCI6IlhjV2ViQXBwIn0.iKX8dG0EQzM_UoS_1l70XkpjOJoUeav19ln4Q6aWmOU&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;expires_in&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7199</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;scope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;all&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;jti&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;6ee32653-9f37-4a63-8565-4488061e8fbd&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol><li>access_token:  生成的jwt令牌，用户访问资源使用</li><li>token_type, bearer是在RFC6750中定义的一种token类型，在携带jwt访问资源时需要在head中加入bearer jwt令牌内容</li><li>refresh_token，当jwt令牌快过期时使用刷新令牌可以再次生成jwt令牌。</li><li>expires_in：过期时间（秒）</li><li>scope，令牌的<code>权限范围</code>，服务端可以根据令牌的权限范围去<code>对令牌授权。 </code></li><li>jti：令牌的唯一标识。</li></ol><p>我们可以通过check_token接口校验jwt令牌</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">### 校验jwt令牌<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>auth_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJzdHUxIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY2NDM3MTc4MCwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiZjBhM2NkZWItMzk5ZC00OGYwLTg4MDQtZWNhNjM4YWQ4ODU3IiwiY2xpZW50X2lkIjoiYzEifQ.qy46CSCJsH3eXWTHgdcntZhzcSzfRQlBU0dxAjZcsUw<br></code></pre></td></tr></table></figure><p>响应示例如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226120801314.png" alt="image-20231226120801314"></p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs prolog">&#123;<br>  <span class="hljs-string">&quot;aud&quot;</span>: [<br>    <span class="hljs-string">&quot;xuecheng-plus&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;user_name&quot;</span>: <span class="hljs-string">&quot;zhangsan&quot;</span>,<br>  <span class="hljs-string">&quot;scope&quot;</span>: [<br>    <span class="hljs-string">&quot;all&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;active&quot;</span>: true,<br>  <span class="hljs-string">&quot;exp&quot;</span>: <span class="hljs-number">1703570580</span>,<br>  <span class="hljs-string">&quot;authorities&quot;</span>: [<br>    <span class="hljs-string">&quot;p1&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;jti&quot;</span>: <span class="hljs-string">&quot;6ee32653-9f37-4a63-8565-4488061e8fbd&quot;</span>,<br>  <span class="hljs-string">&quot;client_id&quot;</span>: <span class="hljs-string">&quot;XcWebApp&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="测试资源服务校验令牌"><a href="#测试资源服务校验令牌" class="headerlink" title="测试资源服务校验令牌"></a>测试资源服务校验令牌</h5><p>拿到了jwt令牌下一步是携带令牌访问资源服务的资源，本项目各个微服务是资源服务，比如：内容管理服务，客户端申请到jwt令牌，携带jwt去内容管理服务查询课程信息，此时内容管理服务对jwt去校验，只有jwt合法才能继续访问，如图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226122508837.png" alt="image-20231226122508837"></p><p>1、在内容管理服务的content-api工程中添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--认证相关--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>2、在内容管理服务的content-api工程中添加TokenConfig</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.content.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Administrator</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenConfig</span> &#123;<br><br>    <span class="hljs-comment">//jwt签名密钥,与认证服务保持一致</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">SIGNING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mq123&quot;</span>;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> TokenStore <span class="hljs-title function_">tokenStore</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//JWT令牌存储方案</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenStore</span>(accessTokenConverter());<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title function_">accessTokenConverter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">JwtAccessTokenConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessTokenConverter</span>();<br>        converter.setSigningKey(SIGNING_KEY);<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br><br>   <span class="hljs-comment">/* @Bean</span><br><span class="hljs-comment">    public TokenStore tokenStore() &#123;</span><br><span class="hljs-comment">        //使用内存存储令牌（普通令牌）</span><br><span class="hljs-comment">        return new InMemoryTokenStore();</span><br><span class="hljs-comment">    &#125;*/</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>3、添加资源服务配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.config;<br><br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Administrator</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableResourceServer</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResouceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ResourceServerConfigurerAdapter</span> &#123;<br><br><br>    <span class="hljs-comment">//资源服务标识</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RESOURCE_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;xuecheng-plus&quot;</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    TokenStore tokenStore;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ResourceServerSecurityConfigurer resources)</span> &#123;<br>        resources.resourceId(RESOURCE_ID)<span class="hljs-comment">//资源 id</span><br>                .tokenStore(tokenStore)<br>                .stateless(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.csrf().disable()<br>                .authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/r/**&quot;</span>,<span class="hljs-string">&quot;/course/**&quot;</span>).authenticated()<span class="hljs-comment">//所有/r/**的请求必须认证通过</span><br>                .anyRequest().permitAll()<br>        ;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>根据配置可知&#x2F;course&#x2F;**开头的接口需要认证通过。</p><p>重启内容管理服务</p><p>使用httpclient测试：</p><p>1、访问根据课程id查询课程接口</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">GET http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:63040/content/course/2</span><br></code></pre></td></tr></table></figure><p>返回未认证</p><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs smalltalk">&#123;<br>  <span class="hljs-comment">&quot;error&quot;</span>: <span class="hljs-comment">&quot;unauthorized&quot;</span>,<br>  <span class="hljs-comment">&quot;error_description&quot;</span>: <span class="hljs-comment">&quot;Full authentication is required to access this resource&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>从返回信息可知当前没有认证。</p><p>下边携带JWT令牌访问接口：</p><p>1、申请jwt令牌</p><p>采用密码模式申请令牌。</p><p>2、携带jwt令牌访问资源服务地址</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Plain</span> Text<br><span class="hljs-comment">### 携带token访问资源服务</span><br><span class="hljs-attribute">GET</span> http://localhost:<span class="hljs-number">63040</span>/content/course/<span class="hljs-number">2</span><br><span class="hljs-attribute">Authorization</span>: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzMzM0OTgsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6IjhhM2M2OTk1LWU1ZGEtNDQ1Yy05ZDAyLTEwNDFlYzk3NTkwOSIsImNsaWVudF9pZCI6ImMxIn0.<span class="hljs-number">73</span>eNDxTX5ifttGCjwc7xrd-Sbp_mCfcIerI3lGetZto<br><br></code></pre></td></tr></table></figure><p>如果携带jwt令牌且jwt正确则正常访问资源服务的内容。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226154848189.png" alt="image-20231226154848189"></p><p>如果不正确则报令牌无效的错误：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">JSON<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;invalid_token&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;error_description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Cannot convert access token to JSON&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><h5 id="测试获取用户身份"><a href="#测试获取用户身份" class="headerlink" title="测试获取用户身份"></a>测试获取用户身份</h5><p>jwt令牌记录了用户身份信息，当客户端携带jwt访问资源服务，资源服务校验通过后将前两部分内容<code>还原</code>即可取出用户身份信息，将用户身份信息放在SecurityContextHolder上下文，SecurityContext和当前线程绑定，方便获取用户身份</p><p>以查询课程接口为例，进入查询课程接口代码，添加获取用户身份的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;根据课程id查询课程基础信息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/course/&#123;courseId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">getCourseBaseById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;<br>    <span class="hljs-comment">//取出当前用户身份</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication().getPrincipal();<br>    System.out.println(principal);<br>    <span class="hljs-keyword">return</span> courseBaseInfoService.getCourseBaseInfo(courseId);<br>&#125;<br></code></pre></td></tr></table></figure><p>测试时注意：</p><ol><li>在资源服务配置中指定安全拦截机制&#x2F;course&#x2F;开头的请求需要认证，即请求&#x2F;course&#x2F;{courseId}接口需要携带jwt令牌且签证通过</li><li>认证服务生成jwt令牌将用户身份信息写入令牌，认证服务在哪里获取用户身份</li></ol><p>目前是将用户信息硬编码并暂存到内存中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span><br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;zhangsan&quot;</span>).password(<span class="hljs-string">&quot;123&quot;</span>).authorities(<span class="hljs-string">&quot;p1&quot;</span>).build());<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;lisi&quot;</span>).password(<span class="hljs-string">&quot;456&quot;</span>).authorities(<span class="hljs-string">&quot;p2&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> manager;<br>&#125;<br><br></code></pre></td></tr></table></figure><ol start="3"><li>我们使用密码模式生成jwt令牌用的是zhangsan的信息，所以jwt令牌存储了zhangsan的信息，那在资源服务应该可以取出zhangsan的信息</li></ol><p>下面重启内容管理服务，跟踪到用户身份是否正确</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226160736318.png" alt="image-20231226160736318" style="zoom:50%;" /><h4 id="网关认证"><a href="#网关认证" class="headerlink" title="网关认证"></a><strong>网关认证</strong></h4><h5 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a><strong>技术方案</strong></h5><p>到目前为止，测试通过了认证服务颁发jwt令牌，客户端携带jwt访问资源服务，资源服务对jwt的合法性进行验证。如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226161045777.png" alt="image-20231226161045777"></p><p>仔细观察此图，遗漏了本项目架构中非常重要的组件：网关，加上网关并完善后如下图所示：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226161233377.png" alt="image-20231226161233377" style="zoom:67%;" /><p>所有访问微服务的请求经过网关，在网关进行用户<code>身份认证</code>将很多非法的请求拦截到微服务外，这叫做网关认证</p><p>下面需要明确网关的职责：</p><ol><li>网站白名单维护</li></ol><p>针对不用认证的URL全部放行</p><ol start="2"><li>校验jwt的合法性</li></ol><p>除了白名单剩下的是需要认证的请求，网关需要校验jwt的合法性，jwt合法则说明用户身份合法，否则身份不合法则拒绝继续访问</p><p>网关负责授权吗？</p><p>网关不负责授权，对请求的<code>授权</code>操作在各个<code>微服务</code>进行，因为微服务最清楚用户有哪些权限访问哪些接口</p><h5 id="实现网关认证"><a href="#实现网关认证" class="headerlink" title="实现网关认证"></a>实现网关认证</h5><p>下边实现网关认证，实现以下职责：</p><ol><li>网站白名单维护</li></ol><p>针对不用认证的URL放行</p><ol start="2"><li>校验jwt的合法性</li></ol><p>除了白名单剩下的就是需要认证的要求，网关需要验证jwt的合法性，jwt合法则说明用户身份合法，否则说明身份不合法则拒绝继续访问</p><p>1、在网关工程添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- spring security --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2、拷贝课程资料下网关认证配置类到网关工程的config包下。</p><p>3、配置白名单文件security-whitelist.properties</p><p>内容如下（持续补充）</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">/**</span>=<span class="hljs-string">临时全部放行</span><br><span class="hljs-attr">/auth/**</span>=<span class="hljs-string">认证地址</span><br><span class="hljs-attr">/content/open/**</span>=<span class="hljs-string">内容管理公开访问接口</span><br><span class="hljs-attr">/media/open/**</span>=<span class="hljs-string">媒资管理公开访问接口</span><br></code></pre></td></tr></table></figure><p>重启网关工程，进行测试</p><p>1、申请令牌</p><p>2、通过网关访问资源服务</p><p>这里访问内容管理服务</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">### 通过网关访问资源服务<br>GET http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:63010/content/course/2</span><br>Authorization<span class="hljs-punctuation">:</span> Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE3MDM1ODY1NTEsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImRjMzAxZTMxLTNjM2MtNGMzMS05ZWMxLTQxMzcyZjA5MDc4NyIsImNsaWVudF9pZCI6IlhjV2ViQXBwIn0<span class="hljs-number">.1</span>hOMXETZ7xb7jgjbQPnDlTtXUN7JS7y_rjtXRpLRdT8<br></code></pre></td></tr></table></figure><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226162949138.png" alt="image-20231226162949138" style="zoom:50%;" /><p>当token正确时可以正常访问资源服务，token验证失败返回token无效</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">JSON</span><br>&#123;<br>  <span class="hljs-string">&quot;errMessage&quot;</span>: <span class="hljs-string">&quot;认证令牌无效&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>注意：网关鉴权功能调试通过后，由于目前还没有开发认证功能，前端请求网关的URL不在白名单中间时会“没有认证”的错误，暂时在白名单中添加 全部放行配置，待认证功能开发完成再屏蔽全部放行配置，</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226163459122.png" alt="image-20231226163459122" style="zoom:50%;" /><h4 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h4><h5 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h5><p>至此我们了解了使用Spring Security进行认证授权的过程，本节实现<code>用户认证</code>功能。</p><p>目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。</p><p>本项目也要支持多种认证。</p><h5 id="连接用户中心数据库"><a href="#连接用户中心数据库" class="headerlink" title="连接用户中心数据库"></a>连接用户中心数据库</h5><h6 id="连接数据库认证"><a href="#连接数据库认证" class="headerlink" title="连接数据库认证"></a><strong>连接数据库认证</strong></h6><p>基于认证流程在研究Security过程已经测试通过，目前用户认证流程：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226163746443.png" alt="image-20231226163746443"><br>认证需要的用户信息存储在用户中心数据库，现在需要将认证服务连接数据库查询用户信息。</p><p>在研究Security过程将<strong>用户信息硬编码</strong>，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span><br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;zhangsan&quot;</span>).password(<span class="hljs-string">&quot;123&quot;</span>).authorities(<span class="hljs-string">&quot;p1&quot;</span>).build());<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;lisi&quot;</span>).password(<span class="hljs-string">&quot;456&quot;</span>).authorities(<span class="hljs-string">&quot;p2&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> manager;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们要认证服务中连接用户中心数据库查询用户信息：</p><p>如何使用Security连接数据库认证？</p><p>前边学习Spring Security工作原理时有一张执行流程图，如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226170841828.png" alt="image-20231226170841828"></p><p>用户提交账号和密码由DaoAuthenticationProvider调用UserDetailsService的loadUserByUsername方法获取UserDetails用户信息</p><p>查询DaoAuthenticationProvider的源代码如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226170947053.png" alt="image-20231226170947053"></p><p>UserDetailsService是一个接口，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.security.core.userdetails;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br>    UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String var1)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException;<br>&#125;<br></code></pre></td></tr></table></figure><p>UserDetails是用户信息接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br><br>    String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span>;<br><br>    String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>我们实现UserDetailsService接口查询数据库得到用户信息返回UserDetails类型的<code>用户信息</code>即可，框架调用loadUserByUsername()方法拿到用户信息之后如何执行的：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226171541617.png" alt="image-20231226171541617" style="zoom:50%;" /><p>首先屏蔽原来定义的UserDetailsService。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*//配置用户信息服务</span><br><span class="hljs-comment">@Bean</span><br><span class="hljs-comment">public UserDetailsService userDetailsService() &#123;</span><br><span class="hljs-comment">    //这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span><br><span class="hljs-comment">    InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();</span><br><span class="hljs-comment">    manager.createUser(User.withUsername(&quot;zhangsan&quot;).password(&quot;123&quot;).authorities(&quot;p1&quot;).build());</span><br><span class="hljs-comment">    manager.createUser(User.withUsername(&quot;lisi&quot;).password(&quot;456&quot;).authorities(&quot;p2&quot;).build());</span><br><span class="hljs-comment">    return manager;</span><br><span class="hljs-comment">&#125;*/</span><br></code></pre></td></tr></table></figure><p>下边自定义  UserDetailsService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 17:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br><br>    <span class="hljs-comment">//根据账号查询用户信息</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, s));<br>        <span class="hljs-keyword">if</span> (user==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//取出数据库存储的正确密码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-comment">//用户权限，如果不加报错  Cannot pass a null GrantedAuthority collection</span><br>        String[] authorities = &#123;<span class="hljs-string">&quot;test&quot;</span>&#125;; <span class="hljs-comment">//自定义假的权限</span><br>        <span class="hljs-comment">//创建UserDetails对象，权限信息待实现授权功能时再向UserDetail中加入</span><br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> User<br>                .withUsername(user.getUsername())<br>                .password(password)<br>                .authorities(authorities)<br>                .build();<br>        <span class="hljs-keyword">return</span> userDetails;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>数据库的密码加过密的，用户输入的密码是明文，我们需要修改密码格式器PasswordEncoder，原来使用的是NoOpPasswordEncoder，他是通过明文方式比较密码，现在我们修改为BCryptPasswordEncoder，将用户输入的密码编码未BCrypt格式与数据库中密码比对。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">//        //密码为明文方式</span><br><span class="hljs-comment">//        return NoOpPasswordEncoder.getInstance();</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>我们通过测试代码测试BCryptPasswordEncoder，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;111111&quot;</span>;<br>    <span class="hljs-type">PasswordEncoder</span> <span class="hljs-variable">passwordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++) &#123;<br>        <span class="hljs-comment">//每个计算出的Hash值都不一样</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">hashPass</span> <span class="hljs-operator">=</span> passwordEncoder.encode(password);<br>        System.out.println(hashPass);<br>        <span class="hljs-comment">//虽然每次计算的密码Hash值不一样但是校验是通过的</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> passwordEncoder.matches(password, hashPass);<br>        System.out.println(f);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改数据库中的密码为Bcrypt格式，并且记录明文密码，稍后申请令牌时需要。</p><p>由于修改密码编码方式还需要将客户端的密钥更改为Bcrypt格式.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//客户端详情服务</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span><br>            <span class="hljs-keyword">throws</span> Exception &#123;<br>        clients.inMemory()<span class="hljs-comment">// 使用in-memory存储</span><br>                .withClient(<span class="hljs-string">&quot;XcWebApp&quot;</span>)<span class="hljs-comment">// client_id</span><br><span class="hljs-comment">//                .secret(&quot;secret&quot;)//客户端密钥</span><br>                .secret(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>().encode(<span class="hljs-string">&quot;XcWebApp&quot;</span>))<span class="hljs-comment">//客户端密钥</span><br>                .resourceIds(<span class="hljs-string">&quot;xuecheng-plus&quot;</span>)<span class="hljs-comment">//资源列表</span><br>                .authorizedGrantTypes(<span class="hljs-string">&quot;authorization_code&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>,<span class="hljs-string">&quot;client_credentials&quot;</span>,<span class="hljs-string">&quot;implicit&quot;</span>,<span class="hljs-string">&quot;refresh_token&quot;</span>)<span class="hljs-comment">// 该client允许的授权类型authorization_code,password,refresh_token,implicit,client_credentials</span><br>                .scopes(<span class="hljs-string">&quot;all&quot;</span>)<span class="hljs-comment">// 允许的授权范围</span><br>                .autoApprove(<span class="hljs-literal">false</span>)<span class="hljs-comment">//false跳转到授权页面</span><br>                <span class="hljs-comment">//客户端接收授权码的重定向地址</span><br>                .redirectUris(<span class="hljs-string">&quot;http://www.51xuecheng.cn&quot;</span>)<br>        ;<br>    &#125;<br></code></pre></td></tr></table></figure><p>现在重启认证服务。</p><p>下边使用httpclient进行测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java">### 密码模式<br>POST &#123;&#123;auth_host&#125;&#125;/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=stu1&amp;password=<span class="hljs-number">111111</span><br></code></pre></td></tr></table></figure><p>输入正确的账号和密码，申请令牌成功。</p><p>输入错误的密码，报错：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">Java</span><br><span class="hljs-keyword"></span>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;invalid_grant&quot;</span>,<br>  <span class="hljs-string">&quot;error_description&quot;</span>: <span class="hljs-string">&quot;用户名或密码错误&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>输入错误的账号，报错：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">Java</span><br><span class="hljs-keyword"></span>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;unauthorized&quot;</span>,<br>  <span class="hljs-string">&quot;error_description&quot;</span>: <span class="hljs-string">&quot;UserDetailsService returned null, which is an interface contract violation&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h6 id="扩展用户身份信息"><a href="#扩展用户身份信息" class="headerlink" title="扩展用户身份信息"></a>扩展用户身份信息</h6><p>用户表中存储了用户的账号、手机号、email，昵称、qq等信息，UserDetails接口只返回了username、密码等信息，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br><br>    String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span>;<br><br>    String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>我们需要扩展用户身份的信息，在jwt令牌中存储用户昵称，头像，qq等信息。</p><p>如何扩展Spring Security的用户身份信息呢？</p><p>在认证阶段DaoAuthenticationProvider会调用UserDetailService查询用户信息，这里可以获取齐全的用户信息，由于JWT令牌中用户身份信息来源于UserDetails，Userdetails定义了username给用户身份信息，这里两个思路：1.扩展Userdetails，让他包括更多的自定义属性，2.扩展username的内容，比如存入json数据内容作为username的内容，比较而言，方案二更简单，而且不会破坏UserDetails的结构,我们用方案二</p><p>修改UserServiceImpl如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 17:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br><br>    <span class="hljs-comment">//根据账号查询用户信息</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, s));<br>        <span class="hljs-keyword">if</span> (user==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//取出数据库存储的正确密码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-comment">//用户权限，如果不加报错  Cannot pass a null GrantedAuthority collection</span><br>        String[] authorities = &#123;<span class="hljs-string">&quot;p1&quot;</span>&#125;; <span class="hljs-comment">//自定义假的权限</span><br>        <span class="hljs-comment">//为了安全在令牌中不放密码</span><br>        user.setPassword(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//将user对象转json</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userString</span> <span class="hljs-operator">=</span> JSON.toJSONString(user);<br>        <span class="hljs-comment">//创建UserDetails对象，权限信息待实现授权功能时再向UserDetail中加入</span><br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> User<br>                .withUsername(userString)<br>                .password(password)<br>                .authorities(authorities)<br>                .build();<br>        <span class="hljs-keyword">return</span> userDetails;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>重启认证服务，重新生成令牌，生成成功。</p><p>我们可以使用check_token查询jwt的内容</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JSON">###校验jwt令牌<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>auth_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/auth/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJzdHUxIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTcwMzU5OTE4MSwiYXV0aG9yaXRpZXMiOlsidGVzdCJdLCJqdGkiOiJkMjBkZWUzNC02NGY4LTQyZjUtOTRjMC1jNjFkYTUzYWUzMjAiLCJjbGllbnRfaWQiOiJYY1dlYkFwcCJ9.bA-whhHgbZCG-uXBYKAIVzYQ1GB5Xb6A_-sIE5LkM_E<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs json">POST http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:63070/auth/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJzdHUxIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTcwMzU5OTE4MSwiYXV0aG9yaXRpZXMiOlsidGVzdCJdLCJqdGkiOiJkMjBkZWUzNC02NGY4LTQyZjUtOTRjMC1jNjFkYTUzYWUzMjAiLCJjbGllbnRfaWQiOiJYY1dlYkFwcCJ9.bA-whhHgbZCG-uXBYKAIVzYQ1GB5Xb6A_-sIE5LkM_E</span><br><br>HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> <br>Transfer-Encoding<span class="hljs-punctuation">:</span> chunked<br>Cache-Control<span class="hljs-punctuation">:</span> no-cache<span class="hljs-punctuation">,</span> no-store<span class="hljs-punctuation">,</span> max-age=<span class="hljs-number">0</span><span class="hljs-punctuation">,</span> must-revalidate<br>Connection<span class="hljs-punctuation">:</span> keep-alive<br>Content-Type<span class="hljs-punctuation">:</span> application/json<br>Date<span class="hljs-punctuation">:</span> Tue<span class="hljs-punctuation">,</span> <span class="hljs-number">26</span> Dec <span class="hljs-number">2023</span> <span class="hljs-number">11</span><span class="hljs-punctuation">:</span><span class="hljs-number">59</span><span class="hljs-punctuation">:</span><span class="hljs-number">54</span> GMT<br>Expires<span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>Keep-Alive<span class="hljs-punctuation">:</span> timeout=<span class="hljs-number">4</span><br>Pragma<span class="hljs-punctuation">:</span> no-cache<br>Proxy-Connection<span class="hljs-punctuation">:</span> keep-alive<br>X-Content-Type-Options<span class="hljs-punctuation">:</span> nosniff<br>X-Frame-Options<span class="hljs-punctuation">:</span> DENY<br>X-Xss-Protection<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>; mode=block<br><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;aud&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;xuecheng-plus&quot;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;user_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;stu1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;scope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;all&quot;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;active&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;exp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1703599181</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;authorities&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;test&quot;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;jti&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;d20dee34-64f8-42f5-94c0-c61da53ae320&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;client_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;XcWebApp&quot;</span><br><span class="hljs-punctuation">&#125;</span><br>响应文件已保存。<br>&gt; <span class="hljs-number">2023</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span>T195954<span class="hljs-number">.200</span>.json<br><br>Response code<span class="hljs-punctuation">:</span> <span class="hljs-number">200</span>; Time<span class="hljs-punctuation">:</span> <span class="hljs-number">37</span>ms (<span class="hljs-number">37</span> ms); Content length<span class="hljs-punctuation">:</span> <span class="hljs-number">182</span> bytes (<span class="hljs-number">182</span> B)<br><br></code></pre></td></tr></table></figure><p>user_name 存储了用户信息的json格式，在资源服务中可以取出该json格式的内容转为用户对象使用</p><h6 id="资源服务获取用户身份"><a href="#资源服务获取用户身份" class="headerlink" title="资源服务获取用户身份"></a>资源服务获取用户身份</h6><p>下边编写一个工具类在各个微服务中去使用，<code>获取当前登录用户的对象</code>。</p><p>在content-api中定义此类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.xuecheng.util;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 获取当前用户身份工具类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/18 18:02</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityUtil</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> XcUser <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">principalObj</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication().getPrincipal();<br>            <span class="hljs-keyword">if</span> (principalObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>                <span class="hljs-comment">//取出用户身份信息</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> principalObj.toString();<br>                <span class="hljs-comment">//将json转成对象</span><br>                <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> JSON.parseObject(principal, XcUser.class);<br>                <span class="hljs-keyword">return</span> user;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;获取当前登录用户身份出错:&#123;&#125;&quot;</span>, e.getMessage());<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Data</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XcUser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>        <span class="hljs-keyword">private</span> String id;<br><br>        <span class="hljs-keyword">private</span> String username;<br><br>        <span class="hljs-keyword">private</span> String password;<br><br>        <span class="hljs-keyword">private</span> String salt;<br><br>        <span class="hljs-keyword">private</span> String name;<br>        <span class="hljs-keyword">private</span> String nickname;<br>        <span class="hljs-keyword">private</span> String wxUnionid;<br>        <span class="hljs-keyword">private</span> String companyId;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 头像</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> String userpic;<br><br>        <span class="hljs-keyword">private</span> String utype;<br><br>        <span class="hljs-keyword">private</span> LocalDateTime birthday;<br><br>        <span class="hljs-keyword">private</span> String sex;<br><br>        <span class="hljs-keyword">private</span> String email;<br><br>        <span class="hljs-keyword">private</span> String cellphone;<br><br>        <span class="hljs-keyword">private</span> String qq;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 用户状态</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> String status;<br><br>        <span class="hljs-keyword">private</span> LocalDateTime createTime;<br><br>        <span class="hljs-keyword">private</span> LocalDateTime updateTime;<br><br><br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>下边在内容管理服务中测试此工具类，以查询课程信息接口为例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@ApiOperation(&quot;根据课程id查询课程基础信息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/course/&#123;courseId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">getCourseBaseById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;<br>    <span class="hljs-comment">//取出当前用户身份</span><br><span class="hljs-comment">//    Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br>   SecurityUtil.<span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> SecurityUtil.getUser();<br>    System.out.println(user);<br><br>    <span class="hljs-keyword">return</span> courseBaseInfoService.getCourseBaseInfo(courseId);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>重启内容管理服务：</p><p>1、启动认证服务、网关、内容管理服务</p><p>2、生成新的令牌</p><p>3、携带令牌访问内容管理服务的查询课程接口</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226202942941.png" alt="image-20231226202942941"></p><h5 id="支持认证方式多样"><a href="#支持认证方式多样" class="headerlink" title="支持认证方式多样"></a>支持认证方式多样</h5><h6 id="统一认证入口"><a href="#统一认证入口" class="headerlink" title="统一认证入口"></a>统一认证入口</h6><p>目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。基于当前研究的Spring Security认证流程如何支持多样化的认证方式呢？</p><p>1、支持账号和密码认证</p><p>采用OAuth2协议的密码模式即可实现。</p><p>2、支持手机号加验证码认证</p><p>用户认证提交的是手机号和验证码，并不是账号和密码</p><p>3  微信扫码认证</p><p>基于OAuth2协议和微信交互，学成在线网站向微信服务器申请一个令牌，然后携带令牌去微信查询用户信息，查询成功则用户在学成在线项目认证通过</p><p>目前我们测试通过OAuth2的密码模式，用户认证会提交账号和密码，由DaoAuthenticationProvider调用UserDetailsService的loadUserByUsername()方法获取UserDetails用户信息。</p><p>在前边我们自定义了UserDetailsService接口实现类，通过loadUserByUsername()方法根据账号查询用户信息。</p><p>而不同的认证方式提交的数据不一样，比如：手机加验证码方式会提交手机号和验证码，账号密码方式会提交账号、密码、验证码。</p><p>我们可以在loadUserByUsername()方法上作文章，将用户原来提交的<code>账号数据</code>改为提交<code>json数据</code>，json数据可以扩展不同认证方式所提交的各种参数。</p><p>首先创建一个DTO类表示认证的参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.model.dto;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 认证用户请求参数</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/29 10:56</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthParamsDto</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String username; <span class="hljs-comment">//用户名</span><br>    <span class="hljs-keyword">private</span> String password; <span class="hljs-comment">//域  用于扩展</span><br>    <span class="hljs-keyword">private</span> String cellphone;<span class="hljs-comment">//手机号</span><br>    <span class="hljs-keyword">private</span> String checkcode;<span class="hljs-comment">//验证码</span><br>    <span class="hljs-keyword">private</span> String checkcodekey;<span class="hljs-comment">//验证码key</span><br>    <span class="hljs-keyword">private</span> String authType; <span class="hljs-comment">// 认证的类型   password:用户名密码模式类型    sms:短信模式类型</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; payload = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<span class="hljs-comment">//附加数据，作为扩展，不同认证类型可拥有不同的附加数据。如认证类型为短信时包含smsKey : sms:3d21042d054548b08477142bbca95cfa; 所有情况下都包含clientId</span><br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>此时loadUserByUsername()方法可以修改如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 17:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br><br>    <span class="hljs-comment">//根据账号查询用户信息</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">AuthParamsDto</span> <span class="hljs-variable">authParamsDto</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//将认证参数转为AuthParamsDto类型</span><br>            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.info(<span class="hljs-string">&quot;认证请求不符合项目要求：&#123;&#125;&quot;</span>, s);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;认证请求数据格式不对&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//账号</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authParamsDto.getUsername();<br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));<br>        <span class="hljs-keyword">if</span> (user==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//取出数据库存储的正确密码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-comment">//用户权限，如果不加报错  Cannot pass a null GrantedAuthority collection</span><br>        String[] authorities = &#123;<span class="hljs-string">&quot;p1&quot;</span>&#125;; <span class="hljs-comment">//自定义假的权限</span><br>        <span class="hljs-comment">//将user对象转json</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userString</span> <span class="hljs-operator">=</span> JSON.toJSONString(user);<br>        <span class="hljs-comment">//创建UserDetails对象，权限信息待实现授权功能时再向UserDetail中加入</span><br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> User<br>                .withUsername(userString)<br>                .password(password)<br>                .authorities(authorities)<br>                .build();<br>        <span class="hljs-keyword">return</span> userDetails;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>原来的DaoAuthenticationProvider 会进行密码校验，重新定义DaoAuthenticationProviderCustom类，重写类的additionalAuthenticationChecks方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.auth.config;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.dao.DaoAuthenticationProvider;<br><span class="hljs-keyword">import</span> org.springframework.security.core.AuthenticationException;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义 DaoAuthenticationProviderCustom</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 20:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DaoAuthenticationProviderCustom</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DaoAuthenticationProvider</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserDetailsService</span><span class="hljs-params">(UserDetailsService userDetailsService)</span> &#123;<br>        <span class="hljs-built_in">super</span>.setUserDetailsService(userDetailsService);<br>    &#125;<br><br>    <span class="hljs-comment">//屏蔽密码对比</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">additionalAuthenticationChecks</span><span class="hljs-params">(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>修改WebSecurityConfig类指定daoAuthenticationProviderCustom</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Autowired</span><br>DaoAuthenticationProviderCustom daoAuthenticationProviderCustom;<br><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    auth.authenticationProvider(daoAuthenticationProviderCustom);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>此时可以重启认证服务，测试申请令牌接口，传入的账号信息改为json数据，如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">################扩展认证请求参数后######################<br>###密码模式<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>auth_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=<span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;stu1&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;authType&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;password&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;111111&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>经过测试发现loadUserByUsername()方法可以正常接收到认证请求中的json数据。</p><p>有了这些认证参数我们可以定义一个认证Service接口去进行各种方式的认证。</p><p>定义用户信息，为了扩展性让它继承XcUser</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.model.dto;<br><br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 用户扩展信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/30 13:56</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XcUserExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">XcUser</span> &#123;<br>    <span class="hljs-comment">//用户权限</span><br>    List&lt;String&gt; permissions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure><p>定义认证Service 接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.XcUserExt;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 21:02</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 认证方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> authParamsDto 认证参数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.xuecheng.ucenter.model.po.XcUser 用户信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/29 12:11</span><br><span class="hljs-comment">     */</span><br>    XcUserExt <span class="hljs-title function_">execute</span><span class="hljs-params">(AuthParamsDto authParamsDto)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>loadUserByUsername()修改如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    ApplicationContext applicationContext;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 查询用户信息组成用户身份信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> s  AuthParamsDto类型的json数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> org.springframework.security.core.userdetails.UserDetails</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/28 18:30</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br><br>        <span class="hljs-type">AuthParamsDto</span> <span class="hljs-variable">authParamsDto</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//将认证参数转为AuthParamsDto类型</span><br>            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.info(<span class="hljs-string">&quot;认证请求不符合项目要求:&#123;&#125;&quot;</span>,s);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;认证请求数据格式不对&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//开始认证</span><br>        authService.execute(authParamsDto);<br>        .....<br><br></code></pre></td></tr></table></figure><p>到此我们基于Spring Security认证流程修改为如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226210615365.png" alt="image-20231226210615365"></p><h6 id="实现账号密码认证"><a href="#实现账号密码认证" class="headerlink" title="实现账号密码认证"></a><strong>实现账号密码认证</strong></h6><p>上节定义了AuthService认证接口，下边实现该接口实现账号密码认证</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.XcUserExt;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.AuthService;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 账号密码认证</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 21:08</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service(&quot;password_authservice&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PasswordAuthServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthService</span> &#123;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    PasswordEncoder passwordEncoder;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title function_">execute</span><span class="hljs-params">(AuthParamsDto authParamsDto)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authParamsDto.getUsername();<span class="hljs-comment">//账号</span><br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));<br>        <span class="hljs-keyword">if</span> (user==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号不存在&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">XcUserExt</span> <span class="hljs-variable">xcUserExt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XcUserExt</span>();<br>        BeanUtils.copyProperties(user, xcUserExt);<br>        <span class="hljs-comment">// 校验密码</span><br>        <span class="hljs-comment">// 取出数据库存储的正确密码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">passwordDB</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">passwordForm</span> <span class="hljs-operator">=</span> authParamsDto.getPassword();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">matches</span> <span class="hljs-operator">=</span> passwordEncoder.matches(passwordForm, passwordDB);<br>        <span class="hljs-keyword">if</span>(!matches)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号或密码错误&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> xcUserExt;<br>    &#125;<br>    <br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>修改UserServiceImpl类，根据认证方式使用不同的认证bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.XcUserExt;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.AuthService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义UserDetailsService用来对接Spring Security</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 17:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br><span class="hljs-comment">//    @Autowired</span><br><span class="hljs-comment">//    AuthService authService;</span><br><br>    <span class="hljs-meta">@Autowired</span><br>    ApplicationContext applicationContext;<br><br><br>    <span class="hljs-comment">//查询用户信息组成用户身份信息, s: AuthParamsDto类型的json数据</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">AuthParamsDto</span> <span class="hljs-variable">authParamsDto</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//将认证参数转为AuthParamsDto类型</span><br>            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.info(<span class="hljs-string">&quot;认证请求不符合项目要求：&#123;&#125;&quot;</span>, s);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;认证请求数据格式不对&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 认证方法</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">authType</span> <span class="hljs-operator">=</span> authParamsDto.getAuthType();<br>        <span class="hljs-type">AuthService</span> <span class="hljs-variable">authService</span> <span class="hljs-operator">=</span> applicationContext.getBean(authType + <span class="hljs-string">&quot;_authservice&quot;</span>, AuthService.class);<br>        <span class="hljs-type">XcUserExt</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> authService.execute(authParamsDto);<br>        <span class="hljs-keyword">return</span> getUserPrincipal(user);<br><br>    &#125;<br><br>    <span class="hljs-comment">//查询用户信息</span><br>    <span class="hljs-keyword">private</span> UserDetails <span class="hljs-title function_">getUserPrincipal</span><span class="hljs-params">(XcUserExt user)</span> &#123;<br>        <span class="hljs-comment">//用户权限,如果不加报Cannot pass a null GrantedAuthority collection</span><br>        String[] authorities = &#123;<span class="hljs-string">&quot;p1&quot;</span>&#125;;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-comment">//为了安全在令牌中不放密码</span><br>        user.setPassword(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//将user对象转json</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userString</span> <span class="hljs-operator">=</span> JSON.toJSONString(user);<br>        <span class="hljs-comment">//创建UserDetails对象</span><br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> User.withUsername(userString).password(password ).authorities(authorities).build();<br>        <span class="hljs-keyword">return</span> userDetails;<br><br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p>重启认证服务，测试申请令牌接口。</p><p>1、测试账号和密码都正确的情况是否可以申请令牌成功。</p><p>2、测试密码错误的情况。</p><p>3、测试账号不存在情况。</p><h5 id="验证码服务"><a href="#验证码服务" class="headerlink" title="验证码服务"></a><strong>验证码服务</strong></h5><h6 id="创建验证码服务工程"><a href="#创建验证码服务工程" class="headerlink" title="创建验证码服务工程"></a><strong>创建验证码服务工程</strong></h6><p>在认证时一般都需要输入验证码，验证码有什么用？</p><p>验证码可以防止恶性攻击，比如：XSS跨站脚本攻击、CSRF跨站请求伪造攻击，一些比较复杂的图形验证码可以有效的防止恶性攻击。</p><p>为了保护系统的安全在一些比较重要的操作都需要验证码</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226212746628.png" alt="image-20231226212746628" style="zoom:50%;" /><p>验证码的类型也有很多：图片、语音、手机短信验证码等。</p><p>本项目创建单独的验证码服务为各业务提供验证码的生成、校验等服务。</p><p>拷贝课程资料目录xuecheng-plus-checkcode验证码服务工程到自己的工程目录。</p><p>定义nacos配置文件</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">YAML</span><br><span class="hljs-attribute">server</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">servlet</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">context-path</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/checkcode</span><br>  <span class="hljs-attribute">port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">63075</span><br><br></code></pre></td></tr></table></figure><p>注意修改bootstrap.yml中的命名空间为自己定义的命名空间。</p><p>配置redis-dev.yaml，</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span> <br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">10</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">10000</span><br>    <span class="hljs-comment">#redisson:</span><br>      <span class="hljs-comment">#配置文件目录</span><br>      <span class="hljs-comment">#config: classpath:singleServerConfig.yaml</span><br><br></code></pre></td></tr></table></figure><h6 id="验证码接口测试"><a href="#验证码接口测试" class="headerlink" title="验证码接口测试"></a>验证码接口测试</h6><p>验证码服务对外提供的接口有：</p><p>1、生成验证码</p><p>2、校验验证码。</p><p>如下：<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226213250628.png" alt="image-20231226213250628" style="zoom:50%;" /></p><p>验证码服务如何生成并校验验证码？</p><p>拿图片验证码举例：</p><p>1、先生成一个指定位数的验证码，根据需要可能是数字、数字字母组合或文字。</p><p>2、根据生成的验证码生成一个图片并返回给页面</p><p>3、给生成的验证码分配一个<code>key</code>，将key和验证码一同存入缓存。这个key和图片一同返回给页面。</p><p>4、用户输入验证码，连同key一同提交至认证服务。</p><p>5、认证服务拿key和输入的验证码请求验证码服务去校验</p><p>6、验证码服务根据key从缓存取出正确的验证码和用户输入的验证码进行比对，如果相同则校验通过，否则不通过。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226213354276.png" alt="image-20231226213354276"></p><p>根据接口分析，验证码服务接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.checkcode.controller;<br><br><span class="hljs-keyword">import</span> com.xuecheng.checkcode.model.CheckCodeParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.checkcode.model.CheckCodeResultDto;<br><span class="hljs-keyword">import</span> com.xuecheng.checkcode.service.CheckCodeService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiImplicitParam;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiImplicitParams;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 验证码服务接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/29 18:39</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = &quot;验证码服务接口&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CheckCodeController</span> &#123;<br><br>    <span class="hljs-meta">@Resource(name = &quot;PicCheckCodeService&quot;)</span><br>    <span class="hljs-keyword">private</span> CheckCodeService picCheckCodeService;<br><br><br>    <span class="hljs-meta">@ApiOperation(value=&quot;生成验证信息&quot;, notes=&quot;生成验证信息&quot;)</span><br>    <span class="hljs-meta">@PostMapping(value = &quot;/pic&quot;)</span><br>    <span class="hljs-keyword">public</span> CheckCodeResultDto <span class="hljs-title function_">generatePicCheckCode</span><span class="hljs-params">(CheckCodeParamsDto checkCodeParamsDto)</span>&#123;<br>        <span class="hljs-keyword">return</span> picCheckCodeService.generate(checkCodeParamsDto);<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation(value=&quot;校验&quot;, notes=&quot;校验&quot;)</span><br>    <span class="hljs-meta">@ApiImplicitParams(&#123;</span><br><span class="hljs-meta">            @ApiImplicitParam(name = &quot;name&quot;, value = &quot;业务名称&quot;, required = true, dataType = &quot;String&quot;, paramType=&quot;query&quot;),</span><br><span class="hljs-meta">            @ApiImplicitParam(name = &quot;key&quot;, value = &quot;验证key&quot;, required = true, dataType = &quot;String&quot;, paramType=&quot;query&quot;),</span><br><span class="hljs-meta">            @ApiImplicitParam(name = &quot;code&quot;, value = &quot;验证码&quot;, required = true, dataType = &quot;String&quot;, paramType=&quot;query&quot;)</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-meta">@PostMapping(value = &quot;/verify&quot;)</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">verify</span><span class="hljs-params">(String key, String code)</span>&#123;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> picCheckCodeService.verify(key,code);<br>        <span class="hljs-keyword">return</span> isSuccess;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>404   -&gt; 修改网关的nacos配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br><span class="hljs-attr">port:</span> <span class="hljs-number">63010</span> <span class="hljs-comment"># 网关端口</span><br><span class="hljs-attr">spring:</span><br><span class="hljs-attr">cloud:</span><br> <span class="hljs-attr">gateway:</span><br>   <span class="hljs-comment">#      filter:</span><br>   <span class="hljs-comment">#        strip-prefix:</span><br>   <span class="hljs-comment">#          enabled: true</span><br>   <span class="hljs-attr">routes:</span> <span class="hljs-comment"># 网关路由配置</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">content-api</span> <span class="hljs-comment"># 路由id，自定义，只要唯一即可</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://content-api</span> <span class="hljs-comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/content/**</span> <span class="hljs-comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span><br>        <span class="hljs-comment">#          filters:</span><br>        <span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">system-api</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://system-api</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/system/**</span><br>        <span class="hljs-comment">#          filters:</span><br>        <span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">media-api</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://media-api</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/media/**</span><br>        <span class="hljs-comment">#          filters:</span><br>        <span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">checkcode</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://checkcode</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/checkcode/**</span><br>        <span class="hljs-comment">#          filters:</span><br>        <span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">auth-service</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://auth-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/auth/**</span><br>  <span class="hljs-comment">#          filters:</span><br>  <span class="hljs-comment">#            - StripPrefix=1</span><br></code></pre></td></tr></table></figure></blockquote><p>1、生成验证码接口</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">### 申请验证码<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>checkcode_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/checkcode/pic<br></code></pre></td></tr></table></figure><p>2、校验验证码接口</p><p>根据生成验证码返回的key以及日志中输出正确的验证码去测试。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">### 校验验证码<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>checkcode_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/checkcode/verify?key=checkcode<span class="hljs-punctuation">:</span><span class="hljs-number">9</span>c7084e05f4442a3be23ce045f011d6e&amp;code=<span class="hljs-number">9E2</span>Q<br></code></pre></td></tr></table></figure><h5 id="账号密码认证"><a href="#账号密码认证" class="headerlink" title="账号密码认证"></a><strong>账号密码认证</strong></h5><h6 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h6><p>到目前为止账号和密码认证所需要的技术、组件都已开发完毕，下边实现账号密码认证，输出如下图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226214116514.png" alt="image-20231226214116514" style="zoom:50%;" /><p>执行流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226214145555.png" alt="image-20231226214145555"></p><h6 id="账号密码认证开发"><a href="#账号密码认证开发" class="headerlink" title="账号密码认证开发"></a><strong>账号密码认证开发</strong></h6><p>1、在认证服务定义远程调用验证码服务的接口</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.ucenter.feignclient;<br><br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RequestParam;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 搜索服务远程接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/20 20:29</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@FeignClient(value = <span class="hljs-string">&quot;checkcode&quot;</span>,fallbackFactory = CheckCodeClientFactory.class)</span><br> <span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/checkcode&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CheckCodeClient</span> &#123;<br><br> <span class="hljs-meta">@PostMapping(value = <span class="hljs-string">&quot;/verify&quot;</span>)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-built_in">Boolean</span> verify(<span class="hljs-meta">@RequestParam(<span class="hljs-string">&quot;key&quot;</span>)</span> String key,<span class="hljs-meta">@RequestParam(<span class="hljs-string">&quot;code&quot;</span>)</span> String code);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>CheckCodeClientFactory</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CheckCodeClientFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;<span class="hljs-title class_">CheckCodeClient</span>&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CheckCodeClient</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">Throwable throwable</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CheckCodeClient</span>() &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-title class_">Boolean</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key, <span class="hljs-built_in">String</span> code</span>) &#123;<br>                log.<span class="hljs-title function_">debug</span>(<span class="hljs-string">&quot;调用验证码服务熔断异常:&#123;&#125;&quot;</span>, throwable.<span class="hljs-title function_">getMessage</span>());<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>启动类添加：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@EnableFeignClients(basePackages=&#123;<span class="hljs-string">&quot;com.xuecheng.*.feignclient&quot;</span>&#125;)</span><br><br></code></pre></td></tr></table></figure><p>配置文件引入feign-dev.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">Java</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">feign-$&#123;spring.profiles.active&#125;.yaml</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-common</span><br>  <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure><p>2、完善PasswordAuthServiceImpl</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Java<br><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.feignclient.CheckCodeClient;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.AuthService;<br><span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @description 账号密码认证</span><br><span class="hljs-comment"> * @author Mr.M</span><br><span class="hljs-comment"> * @date 2022/9/29 12:12</span><br><span class="hljs-comment"> * @version 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@Service</span>(<span class="hljs-string">&quot;password_authservice&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">PasswordAuthServiceImpl</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">AuthService</span></span> </span>&#123;<br><br> <span class="hljs-meta">@Autowired</span><br> XcUserMapper xcUserMapper;<br><br> <span class="hljs-meta">@Autowired</span><br> PasswordEncoder passwordEncoder;<br> <span class="hljs-meta">@Autowired</span><br> CheckCodeClient checkCodeClient;<br><br> <span class="hljs-meta">@Override</span><br> <span class="hljs-keyword">public</span> XcUser execute(AuthParamsDto authParamsDto) &#123;<br><br>  <span class="hljs-comment">//校验验证码</span><br>  <span class="hljs-keyword">String</span> checkcode = authParamsDto.getCheckcode();<br>  <span class="hljs-keyword">String</span> checkcodekey = authParamsDto.getCheckcodekey();<br><br>  <span class="hljs-keyword">if</span>(StringUtils.isBlank(checkcodekey) || StringUtils.isBlank(checkcode))&#123;<br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">&quot;验证码为空&quot;</span>);<br><br>  &#125;<br>  Boolean verify = checkCodeClient.verify(checkcodekey, checkcode);<br>  <span class="hljs-keyword">if</span>(!verify)&#123;<br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">&quot;验证码输入错误&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">//账号</span><br>  <span class="hljs-keyword">String</span> username = authParamsDto.getUsername();<br>  XcUser user = xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-type">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser:<span class="hljs-type"></span>:getUsername, username));<br>  <span class="hljs-keyword">if</span>(user==<span class="hljs-literal">null</span>)&#123;<br>   <span class="hljs-comment">//返回空表示用户不存在</span><br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">&quot;账号不存在&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">//校验密码</span><br>  <span class="hljs-comment">//取出数据库存储的正确密码</span><br>  <span class="hljs-keyword">String</span> passwordDb  =user.getPassword();<br>  <span class="hljs-keyword">String</span> passwordForm = authParamsDto.getPassword();<br>  boolean matches = passwordEncoder.matches(passwordForm, passwordDb);<br>  <span class="hljs-keyword">if</span>(!matches)&#123;<br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">&quot;账号或密码错误&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> user;<br> &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>小技巧：目前账号密码方式添加了验证码校验，为了后期获取令牌方便可以重新定义一个不需要验证码校验的认证类AuthService ，AuthService 中去掉验证码的校验，方便生成令牌。</p><h6 id="账号密码认证测试"><a href="#账号密码认证测试" class="headerlink" title="账号密码认证测试"></a><strong>账号密码认证测试</strong></h6><p>1、使用浏览器访问 <a href="http://www.51xuecheng.cn/sign.html">http://www.51xuecheng.cn/sign.html</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226223602447.png" alt="image-20231226223602447"></p><p>2、首先测试验证码，分别输入正确的验证码和错误的验证码进行测试</p><p>3、输入正确的账号密码和错误的账号密码进行测试</p><p>登录成功将jwt令牌存储cookie.</p><p>4、测试自动登录</p><p>勾选自动登录cookie生成时间为30天，不勾选自动登录关闭浏览器窗口后自动删除cookie。</p><h4 id="微信扫码登录"><a href="#微信扫码登录" class="headerlink" title="微信扫码登录"></a><strong>微信扫码登录</strong></h4><h5 id="接入规范"><a href="#接入规范" class="headerlink" title="接入规范"></a><strong>接入规范</strong></h5><h6 id="接入流程"><a href="#接入流程" class="headerlink" title="接入流程"></a><strong>接入流程</strong></h6><p>微信扫码登录基于OAuth2协议的授权码模式，</p><p>接口文档：</p><p><a href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</a></p><p>流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226223648221.png" alt="image-20231226223648221"></p><p>第3方应用获取access_token令牌后即可请求微信获取用户信息，成功获取用户信息表示用户第3方应用认证成功</p><h6 id="请求获取授权码"><a href="#请求获取授权码" class="headerlink" title="请求获取授权码"></a>请求获取授权码</h6><p>第三方使用网站应用授权登录前请注意已获取相应网页授权作用域(scope&#x3D;snsapi_login)，则可以通过在PC端打开以下链接：</p><p><a href="https://open.weixin.qq.com/connect/qrconnect?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect">https://open.weixin.qq.com/connect/qrconnect?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect</a> </p><p>若提示“该链接无法访问”，请检查参数是否填写错误，如redirect_url域名与审核时填写的授权域名不一致或scope不为snsapi_login</p><p><strong>参数说明</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226233742308.png" alt="image-20231226233742308"></p><p><strong>返回说明</strong></p><p>用户允许授权后，将会重定向到redirect_uri的网址上，并且带上 code 和state参数</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">redirect_uri?code=CODE&amp;state=STATE<br></code></pre></td></tr></table></figure><p>若用户禁止授权，则不会发生重定向。</p><p>登录一号店网站应用 <a href="https://test.yhd.com/wechat/login.do">https://test.yhd.com/wechat/login.do</a> 打开后，一号店会生成 state 参数，跳转到 <a href="https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&redirect_uri=https://passport.yhd.com/wechat/callback.do&response_type=code&scope=snsapi_login&state=3d6be0a4035d839573b04816624a415e#wechat_redirect">https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&amp;redirect_uri=https%3A%2F%2Fpassport.yhd.com%2Fwechat%2Fcallback.do&amp;response_type=code&amp;scope=snsapi_login&amp;state=3d6be0a4035d839573b04816624a415e#wechat_redirect</a> 微信用户使用微信扫描二维码并且确认登录后，PC端会跳转到 <a href="https://test.yhd.com/wechat/callback.do?code=CODE&state=3d6be0a40sssssxxxxx6624a415e">https://test.yhd.com/wechat/callback.do?code=CODE&amp;state=3d6be0a40sssssxxxxx6624a415e</a> 为了满足网站更定制化的需求，我们还提供了第二种获取 code 的方式，支持网站将微信登录二维码内嵌到自己页面中，用户使用微信扫码授权后通过 JS 将code返回给网站。 JS微信登录主要用途：网站希望用户在网站内就能完成登录，无需跳转到微信域下登录后再返回，提升微信登录的流畅性与成功率。 网站内嵌二维码微信登录 JS 实现办法：</p><p>步骤1：在页面中先引入如下 JS 文件（支持https）：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">http</span>:<span class="hljs-comment">//res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js</span><br></code></pre></td></tr></table></figure><p>步骤2：在需要使用微信登录的地方实例以下 JS 对象：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WxLogin</span>(&#123;<br><span class="hljs-attr">self_redirect</span>:<span class="hljs-literal">true</span>,<br><span class="hljs-attr">id</span>:<span class="hljs-string">&quot;login_container&quot;</span>, <br><span class="hljs-attr">appid</span>: <span class="hljs-string">&quot;&quot;</span>, <br><span class="hljs-attr">scope</span>: <span class="hljs-string">&quot;&quot;</span>, <br><span class="hljs-attr">redirect_uri</span>: <span class="hljs-string">&quot;&quot;</span>,<br> <span class="hljs-attr">state</span>: <span class="hljs-string">&quot;&quot;</span>,<br><span class="hljs-attr">style</span>: <span class="hljs-string">&quot;&quot;</span>,<br><span class="hljs-attr">href</span>: <span class="hljs-string">&quot;&quot;</span><br>&#125;);<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234103548.png" alt="image-20231226234103548"></p><h6 id="通过-code-获取access-token"><a href="#通过-code-获取access-token" class="headerlink" title="通过 code 获取access_token"></a><strong>通过 code 获取access_token</strong></h6><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">https</span>:<span class="hljs-comment">//api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code</span><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234215263.png" alt="image-20231226234215263"></p><p><strong>返回说明</strong></p><p>正确的返回：</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Plain</span> <span class="hljs-built_in">Text</span><br><span class="hljs-punctuation">&#123;</span> <br><span class="hljs-string">&quot;access_token&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;ACCESS_TOKEN&quot;</span><span class="hljs-operator">,</span> <br><span class="hljs-string">&quot;expires_in&quot;</span><span class="hljs-operator">:</span><span class="hljs-number">7200</span><span class="hljs-operator">,</span> <br><span class="hljs-string">&quot;refresh_token&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;REFRESH_TOKEN&quot;</span><span class="hljs-operator">,</span><br><span class="hljs-string">&quot;openid&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;OPENID&quot;</span><span class="hljs-operator">,</span> <br><span class="hljs-string">&quot;scope&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;SCOPE&quot;</span><span class="hljs-operator">,</span><br><span class="hljs-string">&quot;unionid&quot;</span><span class="hljs-operator">:</span> <span class="hljs-string">&quot;o6_bmasdasdsad6_2sgVt7hMZOPfL&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234421292.png" alt="image-20231226234421292" style="zoom:50%;" /><p>错误返回样例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">Plain Text<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;errcode&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">40029</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;errmsg&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;invalid code&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h6 id="通过access-token调用接口"><a href="#通过access-token调用接口" class="headerlink" title="通过access_token调用接口"></a><strong>通过access_token调用接口</strong></h6><p>获取access_token后，进行接口调用，有以下前提</p><p>​</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Plain</span> <span class="hljs-built_in">Text</span><br><span class="hljs-type">access_token</span>有效且未超时；<br>微信用户已授权给第三方应用帐号相应接口作用域（<span class="hljs-variable">scope</span>）。<br><br></code></pre></td></tr></table></figure><p>对于接口作用域（scope），能调用的接口有以下</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234549805.png" alt="image-20231226234549805"></p><p> 其中snsapi_base属于基础接口，若应用已拥有其它 scope 权限，则默认拥有snsapi_base的权限。使用snsapi_base可以让移动端网页授权绕过跳转授权登录页请求用户授权的动作，直接跳转第三方网页带上授权临时票据（code），但会使得用户已授权作用域（scope）仅为snsapi_base，从而导致无法获取到需要用户授权才允许获得的数据和基础功能。 接口调用方法可查阅<a href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html">《微信授权关系接口调用指南》</a></p><p>获取用户信息接口文档：<a href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html</a></p><p>接口地址</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sqf">Plain <span class="hljs-built_in">Text</span><br>http请求方式: <span class="hljs-built_in">GET</span><br>https:<span class="hljs-comment">//api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID</span><br><br></code></pre></td></tr></table></figure><p>如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234710976.png" alt="image-20231226234710976"></p><p>响应</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234719991.png" alt="image-20231226234719991"></p><p>说明如下：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dns">参数            说明<br>openid        普通用户的标识，对当前开发者帐号唯一<br>nickname        普通用户昵称<br>sex            普通用户性别，<span class="hljs-number">1</span>为男性，<span class="hljs-number">2</span>为女性<br>province        普通用户个人资料填写的省份<br>city            普通用户个人资料填写的城市<br>country        国家，如中国为CN<br>headimgurl        用户头像，最后一个数值代表正方形头像大小（有<span class="hljs-number">0、46、64、96</span>、<span class="hljs-number">132</span>数值可选，<span class="hljs-number">0</span>代表<span class="hljs-number">640*640</span>正方形头像），用户没有头像时该项为空<br>privilege        用户特权信息，json数组，如微信沃卡用户为（chinaunicom）<br>unionid          用户统一标识。针对一个微信开放平台帐号下的应用，同一用户的 unionid 是唯一的。<br></code></pre></td></tr></table></figure><h5 id="准备开发环境"><a href="#准备开发环境" class="headerlink" title="准备开发环境"></a><strong>准备开发环境</strong></h5><h6 id="添加应用"><a href="#添加应用" class="headerlink" title="添加应用"></a>添加应用</h6><p>1、注册微信开放平台</p><p><a href="https://open.weixin.qq.com/">https://open.weixin.qq.com/</a></p><p>2、添加应用</p><p>进入网站应用，添加应用</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227105656290.png" alt="image-20231227105656290"></p><p>3、添加应用需要指定一个外网域名作为微信回调域名</p><p>审核通过后，生成app密钥。</p><p>最终获取appID和AppSecret</p><h6 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a><strong>内网穿透</strong></h6><p>我们开发环境在局域网，微信回调指向一个公网域名</p><p>如何让微信回调请求到我们的开发计算机呢？</p><p>使用内网穿透，什么是内网穿透？</p><blockquote><p>内网穿透</p><p>将内网外网通过隧道打通，让内网数据让外网可以获取，比如常用的办公软件等，一般在办公室或家里，通过拨号上网，这样办公软件只有在本地局域网可以访问，那问题来嘞，如果在手机或公司外地上班的员工，如何访问到办公软件？需要内网穿透工具，开启隧道后，内网穿透工具会分配一个专属域名&#x2F;端口，办公软件可以在公网了，在外办公的员工可以在任何地方办公了</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227111010963.png" alt="image-20231227111010963"></p><p>在内网穿透服务器开启隧道，配置外网域名，配置穿透内网的端口即本地电脑上的端口</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227111058273.png" alt="image-20231227111058273"></p><p>这样我们配置认证服务端口，最终实现外网域名访问本地认证服务</p><p>2  在本地安装内网穿透工具，工具配置内网穿透服务器隧道token</p><p>市面上做内网穿透的商家很多，需要时可以查阅资料了解下。</p></blockquote><h5 id="接入微信登录"><a href="#接入微信登录" class="headerlink" title="接入微信登录"></a><strong>接入微信登录</strong></h5><h6 id="接入分析"><a href="#接入分析" class="headerlink" title="接入分析"></a>接入分析</h6><p>根据OAuth2协议授权码流程，结合本项目自身特点，分析接入微信扫码登录的流程如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227111247459.png" alt="image-20231227111247459"></p><p>本项目认证服务需要做哪些事？</p><ol><li>需要定义接口接收微信下发的授权码</li><li>收到授权码调用微信接口申请令牌</li><li>申请到令牌调用微信获取用户信息</li><li>获取用户信息成功将其写入本项目用户中心数据库</li><li>最后重定向到浏览器自动登录</li></ol><h6 id="定义接口"><a href="#定义接口" class="headerlink" title="定义接口"></a><strong>定义接口</strong></h6><p>参考接口规范中请求获取授权码定义接收微信下发的授权码接口</p><p>定义 WxLoginController 类，如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.auth.controller;<br><br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 微信登录</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/27 12:11</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WxLoginController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/wxlogin&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">wxLogin</span><span class="hljs-params">(String code,String state)</span>&#123;<br>        log.debug(<span class="hljs-string">&quot;微信扫码回调,code:&#123;&#125;,state:&#123;&#125;&quot;</span>,code,state);<br>        <span class="hljs-comment">//请求微信申请令牌，拿到令牌查询用户信息，将用户信息写入项目数据库</span><br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">xcUser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XcUser</span>();<br>        <span class="hljs-comment">//暂时硬编码，目的是调试环境</span><br>        xcUser.setUsername(<span class="hljs-string">&quot;t1&quot;</span>);<br>        <span class="hljs-keyword">if</span> (xcUser==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:http://www.51xuecheng.cn/error.html&quot;</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> xcUser.getUsername();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:http://www.51xuecheng.cn/sign.html?username=&quot;</span>+username+<span class="hljs-string">&quot;&amp;authType=wx&quot;</span>;<br>    &#125;<br>    <br>&#125;<br><br></code></pre></td></tr></table></figure><p>定义微信认证的service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.XcUserExt;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.AuthService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 微信扫码认证</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/27 12:16</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service(&quot;wx_authservice&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WxAuthServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthService</span>  &#123;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title function_">execute</span><span class="hljs-params">(AuthParamsDto authParamsDto)</span> &#123;<br>        <span class="hljs-comment">//账号</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authParamsDto.getUsername();<br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号不存在&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">XcUserExt</span> <span class="hljs-variable">xcUserExt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XcUserExt</span>();<br>        BeanUtils.copyProperties(user,xcUserExt);<br>        <span class="hljs-keyword">return</span> xcUserExt;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><h6 id="接口环境测试"><a href="#接口环境测试" class="headerlink" title="接口环境测试"></a><strong>接口环境测试</strong></h6><p>接口定义好下边进行测试下，主要目的是测试接口调度的环境。</p><p>1、启动内网穿透工具</p><p>2、在&#x2F;wxLogin接口中打断点</p><p>3、打开前端微信扫码页面</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227121958289.png" alt="image-20231227121958289"></p><p>点击微信图标打开二维码</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227122010128.png" alt="image-20231227122010128"></p><p>用户扫码，确认授权</p><p>此时正常进入 &#x2F;wxLogin 方法，最后跳转到</p><p><a href="http://www.51xuecheng.cn/sign.html?username=t1&authType=wx">http://www.51xuecheng.cn/sign.html?username=t1&amp;authType=wx</a></p><h6 id="申请令牌"><a href="#申请令牌" class="headerlink" title="申请令牌"></a><strong>申请令牌</strong></h6><p>接下来请求微信申请令牌。</p><p>1、使用restTemplate请求微信，配置RestTemplate bean</p><p>在启动类配置restTemplate</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Bean</span><br>RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">RestTemplate</span> <span class="hljs-variable">restTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttp3ClientHttpRequestFactory</span>());<br>    <span class="hljs-keyword">return</span>  restTemplate;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义与微信认证的service接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 微信认证接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/27 12:22</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WxAuthService</span> &#123;<br>    XcUser <span class="hljs-title function_">wxAuth</span><span class="hljs-params">(String code)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>继续在WxAuthServiceImpl类写WxAuthService 接口的实现，在其中定义申请令牌的私有方法并由wxAuth方法去调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.XcUserExt;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.AuthService;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.WxAuthService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpMethod;<br><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 微信扫码认证</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/27 12:16</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service(&quot;wx_authservice&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WxAuthServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthService</span>, WxAuthService &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;weixin.appid&#125;&quot;)</span><br>    String appid;<br>    <span class="hljs-meta">@Value(&quot;$&#123;weixin.secret&#125;&quot;)</span><br>    String secret;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title function_">execute</span><span class="hljs-params">(AuthParamsDto authParamsDto)</span> &#123;<br>        <span class="hljs-comment">//账号</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authParamsDto.getUsername();<br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号不存在&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">XcUserExt</span> <span class="hljs-variable">xcUserExt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XcUserExt</span>();<br>        BeanUtils.copyProperties(user,xcUserExt);<br>        <span class="hljs-keyword">return</span> xcUserExt;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> XcUser <span class="hljs-title function_">wxAuth</span><span class="hljs-params">(String code)</span> &#123;<br>        <span class="hljs-comment">//收到code调用的微信接口申请access_token</span><br>        Map&lt;String, String&gt; access_token_map = getAccess_token(code);<br>        <span class="hljs-keyword">if</span> (access_token_map==<span class="hljs-literal">null</span>)<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">//获取用户信息</span><br>        <span class="hljs-comment">//添加用户到数据库</span><br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">xcUser</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">return</span> xcUser;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 申请访问令牌,响应示例</span><br><span class="hljs-comment">     &#123;</span><br><span class="hljs-comment">     &quot;access_token&quot;:&quot;ACCESS_TOKEN&quot;,</span><br><span class="hljs-comment">     &quot;expires_in&quot;:7200,</span><br><span class="hljs-comment">     &quot;refresh_token&quot;:&quot;REFRESH_TOKEN&quot;,</span><br><span class="hljs-comment">     &quot;openid&quot;:&quot;OPENID&quot;,</span><br><span class="hljs-comment">     &quot;scope&quot;:&quot;SCOPE&quot;,</span><br><span class="hljs-comment">     &quot;unionid&quot;: &quot;o6_bmasdasdsad6_2sgVt7hMZOPfL&quot;</span><br><span class="hljs-comment">     &#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String,String&gt; <span class="hljs-title function_">getAccess_token</span><span class="hljs-params">(String code)</span> &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">wxUrl_template</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code&quot;</span>;<br>        <span class="hljs-comment">//请求微信地址</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">wxUrl</span> <span class="hljs-operator">=</span> String.format(wxUrl_template, appid, secret, code);<br><br>        log.info(<span class="hljs-string">&quot;调用微信接口申请access_token, url:&#123;&#125;&quot;</span>, wxUrl);<br><br>        ResponseEntity&lt;String&gt; exchange = restTemplate.exchange(wxUrl, HttpMethod.POST, <span class="hljs-literal">null</span>, String.class);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> exchange.getBody();<br>        log.info(<span class="hljs-string">&quot;调用微信接口申请access_token: 返回值:&#123;&#125;&quot;</span>, result);<br>        Map&lt;String,String&gt; resultMap = JSON.parseObject(result, Map.class);<br><br>        <span class="hljs-keyword">return</span> resultMap;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>下边在controller中调用wxAuth接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WxLoginController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    WxAuthService wxAuthService;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/wxLogin&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">wxLogin</span><span class="hljs-params">(String code, String state)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        log.debug(<span class="hljs-string">&quot;微信扫码回调,code:&#123;&#125;,state:&#123;&#125;&quot;</span>,code,state);<br>        <span class="hljs-comment">//请求微信申请令牌，拿到令牌查询用户信息，将用户信息写入本项目数据库</span><br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">xcUser</span> <span class="hljs-operator">=</span> wxAuthService.wxAuth(code);<br>        <span class="hljs-keyword">if</span>(xcUser==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:http://www.51xuecheng.cn/error.html&quot;</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> xcUser.getUsername();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:http://www.51xuecheng.cn/sign.html?username=&quot;</span>+username+<span class="hljs-string">&quot;&amp;authType=wx&quot;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>测试获取用户信息</p><p>1、在wxAuthService中获取用户信息处打断点</p><p>2、进入<a href="http://www.51xuecheng.cn/wxsign.html">http://www.51xuecheng.cn/wxsign.html</a></p><p>3、手机扫码并授权，观察是否成功申请到令牌</p><h6 id="获取用户信息"><a href="#获取用户信息" class="headerlink" title="获取用户信息"></a><strong>获取用户信息</strong></h6><p>在WxAuthServiceImpl类中定义获取用户信息方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**获取用户信息，示例如下：</span><br><span class="hljs-comment"> &#123;</span><br><span class="hljs-comment"> &quot;openid&quot;:&quot;OPENID&quot;,</span><br><span class="hljs-comment"> &quot;nickname&quot;:&quot;NICKNAME&quot;,</span><br><span class="hljs-comment"> &quot;sex&quot;:1,</span><br><span class="hljs-comment"> &quot;province&quot;:&quot;PROVINCE&quot;,</span><br><span class="hljs-comment"> &quot;city&quot;:&quot;CITY&quot;,</span><br><span class="hljs-comment"> &quot;country&quot;:&quot;COUNTRY&quot;,</span><br><span class="hljs-comment"> &quot;headimgurl&quot;: &quot;https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0&quot;,</span><br><span class="hljs-comment"> &quot;privilege&quot;:[</span><br><span class="hljs-comment"> &quot;PRIVILEGE1&quot;,</span><br><span class="hljs-comment"> &quot;PRIVILEGE2&quot;</span><br><span class="hljs-comment"> ],</span><br><span class="hljs-comment"> &quot;unionid&quot;: &quot; o6_bmasdasdsad6_2sgVt7hMZOPfL&quot;</span><br><span class="hljs-comment"> &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> Map&lt;String,String&gt; <span class="hljs-title function_">getUserinfo</span><span class="hljs-params">(String access_token,String openid)</span> &#123;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">wxUrl_template</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s&quot;</span>;<br>    <span class="hljs-comment">//请求微信地址</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">wxUrl</span> <span class="hljs-operator">=</span> String.format(wxUrl_template, access_token,openid);<br><br>    log.info(<span class="hljs-string">&quot;调用微信接口申请access_token, url:&#123;&#125;&quot;</span>, wxUrl);<br><br>    ResponseEntity&lt;String&gt; exchange = restTemplate.exchange(wxUrl, HttpMethod.POST, <span class="hljs-literal">null</span>, String.class);<br><br>    <span class="hljs-comment">//防止乱码进行转码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span>     <span class="hljs-title class_">String</span>(exchange.getBody().getBytes(StandardCharsets.ISO_8859_1), StandardCharsets.UTF_8);<br>    log.info(<span class="hljs-string">&quot;调用微信接口申请access_token: 返回值:&#123;&#125;&quot;</span>, result);<br>    Map&lt;String,String&gt; resultMap = JSON.parseObject(result, Map.class);<br><br>    <span class="hljs-keyword">return</span> resultMap;<br>&#125;<br></code></pre></td></tr></table></figure><p>调用获取用户信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> XcUser <span class="hljs-title function_">wxAuth</span><span class="hljs-params">(String code)</span>&#123;<br><br>        <span class="hljs-comment">//收到code调用微信接口申请access_token</span><br>        Map&lt;String, String&gt; access_token_map = getAccess_token(code);<br>        <span class="hljs-keyword">if</span>(access_token_map==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        System.out.println(access_token_map);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">openid</span> <span class="hljs-operator">=</span> access_token_map.get(<span class="hljs-string">&quot;openid&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">access_token</span> <span class="hljs-operator">=</span> access_token_map.get(<span class="hljs-string">&quot;access_token&quot;</span>);<br>        <span class="hljs-comment">//拿access_token查询用户信息</span><br>        Map&lt;String, String&gt; userinfo = getUserinfo(access_token, openid);<br>        <span class="hljs-keyword">if</span>(userinfo==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//添加用户到数据库</span><br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">xcUser</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">return</span> xcUser;<br>    &#125;<br></code></pre></td></tr></table></figure><p>测试获取用户信息</p><p>1、在获取用户信息处打断点</p><p>2、进入<a href="http://www.51xuecheng.cn/wxsign.html">http://www.51xuecheng.cn/wxsign.html</a></p><p>3、手机扫码授权</p><h6 id="保存用户信息"><a href="#保存用户信息" class="headerlink" title="保存用户信息"></a>保存用户信息</h6><p>向数据库保存用户信息，如果用户不存在将其保存在数据库。</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Java<br><span class="hljs-meta">@Autowired</span><br>XcUserRoleMapper xcUserRoleMapper;<br><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> XcUser addWxUser(Map userInfo_map)&#123;<br>    <span class="hljs-keyword">String</span> unionid = userInfo_map.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;unionid&quot;</span>).toString();<br>    <span class="hljs-comment">//根据unionid查询数据库</span><br>    XcUser xcUser = xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-type">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser:<span class="hljs-type"></span>:getWxUnionid, unionid));<br>    <span class="hljs-keyword">if</span>(xcUser!=<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> xcUser;<br>    &#125;<br>    <span class="hljs-keyword">String</span> userId = UUID.randomUUID().toString();<br>    xcUser = <span class="hljs-keyword">new</span> <span class="hljs-type">XcUser</span>();<br>    xcUser.setId(userId);<br>    xcUser.setWxUnionid(unionid);<br>    <span class="hljs-comment">//记录从微信得到的昵称</span><br>    xcUser.setNickname(userInfo_map.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;nickname&quot;</span>).toString());<br>    xcUser.setUserpic(userInfo_map.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;headimgurl&quot;</span>).toString());<br>    xcUser.setName(userInfo_map.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;nickname&quot;</span>).toString());<br>    xcUser.setUsername(unionid);<br>    xcUser.setPassword(unionid);<br>    xcUser.setUtype(<span class="hljs-string">&quot;101001&quot;</span>);<span class="hljs-comment">//学生类型</span><br>    xcUser.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<span class="hljs-comment">//用户状态</span><br>    xcUser.setCreateTime(LocalDateTime.now());<br>    xcUserMapper.insert(xcUser);<br>    XcUserRole xcUserRole = <span class="hljs-keyword">new</span> <span class="hljs-type">XcUserRole</span>();<br>    xcUserRole.setId(UUID.randomUUID().toString());<br>    xcUserRole.setUserId(userId);<br>    xcUserRole.setRoleId(<span class="hljs-string">&quot;17&quot;</span>);<span class="hljs-comment">//学生角色</span><br>    xcUserRoleMapper.insert(xcUserRole);<br>    <span class="hljs-keyword">return</span> xcUser;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>调用保存用户信息</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-title class_">WxAuthServiceImpl</span> currentProxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title class_">XcUser</span> <span class="hljs-title function_">wxAuth</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> code</span>)&#123;<br><br>    <span class="hljs-comment">//收到code调用微信接口申请access_token</span><br>    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; access_token_map = <span class="hljs-title function_">getAccess_token</span>(code);<br>    <span class="hljs-keyword">if</span>(access_token_map==<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(access_token_map);<br>    <span class="hljs-title class_">String</span> openid = access_token_map.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;openid&quot;</span>);<br>    <span class="hljs-title class_">String</span> access_token = access_token_map.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;access_token&quot;</span>);<br>    <span class="hljs-comment">//拿access_token查询用户信息</span><br>    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; userinfo = <span class="hljs-title function_">getUserinfo</span>(access_token, openid);<br>    <span class="hljs-keyword">if</span>(userinfo==<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">//将用户信息保存到数据库</span><br>    <span class="hljs-title class_">XcUser</span> xcUser = currentProxy.<span class="hljs-title function_">addWxUser</span>(userinfo);<br>    <span class="hljs-keyword">return</span> xcUser;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>测试保存用户信息</p><p>1、在保存用户信息处打断点</p><p>2、进入<a href="http://www.51xuecheng.cn/wxsign.html">http://www.51xuecheng.cn/wxsign.html</a></p><p>3、手机扫码授权</p><p>4、自动跳转到登录页面，提交认证成功。</p><h4 id="用户授权"><a href="#用户授权" class="headerlink" title="用户授权"></a>用户授权</h4><h5 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h5><p>如何实现授权？业界通常基于RBAC实现授权</p><p>RBAC分为两种方式：</p><p>基于角色的访问控制（Role-Based Access Control）</p><p>基于资源的访问控制（Resource-Based Access Control）</p><p>角色的访问控制（Role-Based Access Control）是按角色进行授权，比如：主体的角色为总经理可以查询企业运营报表，查询员工工资信息等，访问控制流程如下：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227123937245.png" alt="image-20231227123937245" style="zoom:70%;" /><p>根据上图的判断逻辑，授权代码可以表示如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(主体.hasRole(<span class="hljs-string">&quot;总经理角色id&quot;</span>))&#123;<br>查询工资<br>&#125;<br></code></pre></td></tr></table></figure><p>如果上图中查询工资所需要的角色变化为总经理和部门经理，此时就需要修改判断逻辑为“判断用户的角色是否是总经理或部门经理”，修改代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(主体.hasRole(<span class="hljs-string">&quot;总经理角色id&quot;</span>) ||  主体.hasRole(<span class="hljs-string">&quot;部门经理角色id&quot;</span>))&#123;<br>    查询工资<br>&#125;<br></code></pre></td></tr></table></figure><p>根据上边的例子发现，当需要修改角色的权限时就需要修改授权的相关代码，系统可扩展性差。</p><p>基于资源的访问控制（Resource-Based Access</p><p>Control）是按资源（或权限）进行授权，比如：用户必须具有查询工资权限才可以查询员工工资信息等，访问控制流程如下：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227124310952.png" alt="image-20231227124310952" style="zoom:80%;" /><p>根据上图中的判断，授权代码可以表示为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-title function_">if</span><span class="hljs-params">(主体.hasPermission(<span class="hljs-string">&quot;查询工资权限标识&quot;</span>)</span>)&#123;<br>    查询工资<br>&#125;<br><br></code></pre></td></tr></table></figure><p>优点：系统设计时定义好查询工资的权限标识，即使查询工资需要的角色变化未总经理和部门经理也不需要修改授权代码，系统可扩展性强</p><h5 id="资源服务授权流程"><a href="#资源服务授权流程" class="headerlink" title="资源服务授权流程"></a><strong>资源服务授权流程</strong></h5><p>本项目在资源服务内部进行授权，基于<code>资源</code>的授权模式，因为接口在资源服务，通过在<code>接口</code>处添加<code>授权注解</code>实现授权</p><p>1、首先配置nginx代理</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">Java</span><br>   http &#123;<br>    <span class="hljs-attribute">server_names_hash_bucket_size</span> <span class="hljs-number">64</span>;<br>    ...<br>   <br>   <span class="hljs-comment">#前端开发服务</span><br>  <span class="hljs-section">upstream</span> uidevserver&#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8601</span> weight=<span class="hljs-number">10</span>;<br>  &#125; <br>   <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  teacher.51xuecheng.cn;<br>        <span class="hljs-comment">#charset koi8-r;</span><br>        <span class="hljs-attribute">ssi</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">ssi_silent_errors</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>        <span class="hljs-comment">#location / &#123;</span><br>         <span class="hljs-comment">#   alias   D:/itcast2022/xc_edu3.0/code_1/dist/;</span><br>         <span class="hljs-comment">#   index  index.html index.htm;</span><br>        <span class="hljs-comment">#&#125;</span><br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">proxy_pass</span>   http://uidevserver;<br>        &#125;<br><br>        <span class="hljs-section">location</span> /api/ &#123;<br>                <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/;<br>        &#125; <br>        <br>        <br>   &#125;<br><br></code></pre></td></tr></table></figure><p>加载nginx 配置</p><p>2、在资源服务集成Spring Security</p><p>在需要授权的接口处使用@PreAuthorize(“hasAuthority(‘权限标识符’)”)进行控制</p><p>下边代码指定&#x2F;course&#x2F;list接口需要拥有xc_teachmanager_course_list 权限。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135247356.png" alt="image-20231227135247356"></p><p>设置了@PreAuthorize表示执行此方法需要授权，如果当前用户请求接口没有权限则抛出异常</p><p>org.springframework.security.access.AccessDeniedException: 不允许访问</p><p>3、在统一异常处理处解析此异常信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@ExceptionHandler(Exception.class)</span><br><span class="hljs-meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span><br><span class="hljs-keyword">public</span> RestErrorResponse <span class="hljs-title function_">exception</span><span class="hljs-params">(Exception e)</span> &#123;<br><br>   log.error(<span class="hljs-string">&quot;【系统异常】&#123;&#125;&quot;</span>,e.getMessage(),e);<br>   e.printStackTrace();<br>   <span class="hljs-keyword">if</span>(e.getMessage().equals(<span class="hljs-string">&quot;不允许访问&quot;</span>))&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestErrorResponse</span>(<span class="hljs-string">&quot;没有操作此功能的权限&quot;</span>);<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestErrorResponse</span>(CommonError.UNKOWN_ERROR.getErrMessage());<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>4、重启资源服务进行测试</p><p>使用教学机构用户登录系统</p><p>这里使用t1用户登录，账号:t1、密码：111111</p><p>登录成功，点击“教学机构”</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135503309.png" alt="image-20231227135503309"></p><p>当用户没有权限时页面提示：没有操作此功能的权限。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135516048.png" alt="image-20231227135516048"></p><h5 id="授权相关的数据模型"><a href="#授权相关的数据模型" class="headerlink" title="授权相关的数据模型"></a><strong>授权相关的数据模型</strong></h5><p>如何给用户分配权限呢？</p><p>首先要学习数据模型，本项目授权相关的数据表如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135538956.png" alt="image-20231227135538956"></p><p>说明如下：</p><p>xc_user：用户表，存储了系统用户信息，用户类型包括：学生、老师、管理员等</p><p>xc_role：角色表，存储了系统的角色信息，学生、老师、教学管理员、系统管理员等。</p><p>xc_user_role：用户角色表，一个用户可拥有多个角色，一个角色可被多个用户所拥有</p><p>xc_menu:模块表，记录了菜单及菜单下的权限</p><p>xc_permission:角色权限表，一个角色可拥有多个权限，一个权限可被多个角色所拥有</p><p>本项目教学阶段不再实现权限定义及用户权限分配的功能，权限分配的界面原型如下图所示：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135552058.png" alt="image-20231227135552058"></p><p>本项目要求掌握基于权限数据模型（5张数据表），要求在数据库中操作完成给用户分配权限、查询用户权限等需求。</p><p>1、查询用户所拥有的权限</p><p>步骤：</p><p>查询用户的id</p><p>查询用户所拥有的角色</p><p>查询用户所拥有的权限</p><p>例子：</p><p>SELECT * FROM xc_menu WHERE id IN(<br>   SELECT menu_id FROM xc_permission WHERE role_id IN(<br>     SELECT role_id FROM xc_user_role WHERE user_id &#x3D; ‘49’<br>   )<br> )</p><p>2、给用户分配权限</p><p>1）添加权限</p><p>查询用户的id</p><p>查询权限的id</p><p>查询用户的角色，如果没有角色需要先给用户指定角色</p><p>向角色权限表添加记录</p><p>2）删除用户权限</p><p>本项目是基于角色分配权限，如果要删除用户的权限可以给用户换角色，那么新角色下的权限就是用户的权限；如果不换用户的角色可以删除角色下的权限即删除角色权限关系表相应记录，这样操作是将角色下的权限删除，属于该角色的用户都将删除此权限。</p><h5 id="查询用户权限"><a href="#查询用户权限" class="headerlink" title="查询用户权限"></a>查询用户权限</h5><p>使用Spring Security进行授权，首先在生成jwt前会查询用户的权限，如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135645831.png" alt="image-20231227135645831"></p><p>接下来需要修改UserServiceImpl和PasswordAuthServiceImpl从数据库查询用户的权限。</p><p>1、定义mapper接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">XcMenuMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;XcMenu&gt; &#123;<br>    <span class="hljs-meta">@Select(&quot;SELECT    * FROM xc_menu WHERE id IN (SELECT menu_id FROM xc_permission WHERE role_id IN ( SELECT role_id FROM xc_user_role WHERE user_id = #&#123;userId&#125; ))&quot;)</span><br>    List&lt;XcMenu&gt; <span class="hljs-title function_">selectPermissionByUserId</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;userId&quot;)</span> String userId)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>2、修改PasswordAuthServiceImpl</p><p>修改UserServiceImpl类的getUserPrincipal方法，查询权限信息</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Java<br>//查询用户身份<br><span class="hljs-built_in">public</span> UserDetails getUserPrincipal(XcUserExt <span class="hljs-keyword">user</span>)&#123;<br>    String <span class="hljs-keyword">password</span> = <span class="hljs-keyword">user</span>.getPassword();<br>    //查询用户权限<br>    List&lt;XcMenu&gt; xcMenus = menuMapper.selectPermissionByUserId(<span class="hljs-keyword">user</span>.getId());<br>    List&lt;String&gt; permissions = <span class="hljs-built_in">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-keyword">if</span>(xcMenus.size()&lt;=<span class="hljs-number">0</span>)&#123;<br>        //用户权限,如果不加则报Cannot pass a <span class="hljs-keyword">null</span> GrantedAuthority collection<br>        permissions.<span class="hljs-keyword">add</span>(&quot;p1&quot;);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        xcMenus.<span class="hljs-keyword">forEach</span>(menu-&gt;&#123;<br>            permissions.<span class="hljs-keyword">add</span>(menu.getCode());<br>        &#125;);<br>    &#125;<br>    //将用户权限放在XcUserExt中<br>    <span class="hljs-keyword">user</span>.setPermissions(permissions);<br><br>    //为了安全在令牌中不放密码<br>    <span class="hljs-keyword">user</span>.setPassword(<span class="hljs-keyword">null</span>);<br>    //将<span class="hljs-keyword">user</span>对象转<span class="hljs-type">json</span><br>    String userString = <span class="hljs-type">JSON</span>.toJSONString(<span class="hljs-keyword">user</span>);<br>    String[] authorities = permissions.toArray(<span class="hljs-built_in">new</span> String[<span class="hljs-number">0</span>]);<br>    UserDetails userDetails = <span class="hljs-keyword">User</span>.withUsername(userString).<span class="hljs-keyword">password</span>(<span class="hljs-keyword">password</span>).authorities(authorities).build();<br>    <span class="hljs-keyword">return</span> userDetails;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h6 id="权限测试"><a href="#权限测试" class="headerlink" title="权限测试"></a><strong>权限测试</strong></h6><p>以上实现了认证时从数据库查询用户的权限，下边进行用户授权测试。</p><p>重启认证服务，使用内容管理课程列表查询为例，代码如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227150001461.png" alt="image-20231227150001461"></p><p>用户拥有xc_teachmanager_course_list权限方可访问课程查询接口。</p><p>以用户stu1为例，当它没有此权限时页面报“没有此操作的权限”错误</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227150055537.png" alt="image-20231227150055537"></p><p>将xc_teachmanager_course_list权限分配给用户。</p><p>1）首先找到当前用户的角色</p><p>2）找到xc_teachmanager_course_list权限的主键</p><p>3）在角色权限关系表中添加记录</p><p>分配完权限需要重新登录</p><p>由于用户分配了xc_teachmanager_course_list权限，用户具有访问课程查询接口的权限。</p><h5 id="细粒度授权"><a href="#细粒度授权" class="headerlink" title="细粒度授权"></a><strong>细粒度授权</strong></h5><h6 id="什么是细粒度授权"><a href="#什么是细粒度授权" class="headerlink" title="什么是细粒度授权"></a><strong>什么是细粒度授权</strong></h6><p>细粒度授权也叫数据范围授权，即不同的用户所拥有的操作权限相同，但是能够操作的数据范围不一样，用户A和用户B都是教学机构的，他们都拥有我的课程权限，但是两个用户所查询的数据不一样的</p><p>本项目有哪些细粒度授权：</p><p>比如：</p><p>我的课程，教学机构只允许查询本教学机构下的课程信息</p><p>我的选课，学生只能查询自己所选课</p><p>如何实现细粒度授权？</p><p>细粒度授权设计不同的业务逻辑，通常在<code>service</code>层实现，根据不同的用户进行校验，根据不同的参数查询不同的数据或操作不同的数据</p><h6 id="教学机构细粒度授权"><a href="#教学机构细粒度授权" class="headerlink" title="教学机构细粒度授权"></a>教学机构细粒度授权</h6><p>教学机构在维护课程时只允许维护本机构的课程，教学机构细粒度授权过程如下：</p><ol><li>获取当前登录的用户身份</li><li>得到用户所属教育机构的id</li><li>查询该教学机构下的课程信息</li></ol><p>最终实现用户只允许查询自己机构的课程信息</p><p>根据公司id查询课程，流程如下：</p><ol><li>教学机构用户登录系统，从用户身份中取出所属机构的id，在用户表中设计了company_id字段存储该用户所属的机构id.</li><li>接口层取出当前登录用户的身份，取出机构id</li><li>将机构id传入service方法。</li><li>service方法将机构id传入Dao方法，最终查询出本机构的课程信息。</li></ol><p>代码实现如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;课程查询接口&quot;</span>)</span><br><span class="hljs-meta">@PreAuthorize(<span class="hljs-string">&quot;hasAuthority(&#x27;xc_teachmanager_course_list&#x27;)&quot;</span>)</span><span class="hljs-comment">//拥有课程列表查询的权限方可访问</span><br><span class="hljs-meta">@PostMapping(<span class="hljs-string">&quot;/course/list&quot;</span>)</span><br><span class="hljs-keyword">public</span> PageResult&lt;CourseBase&gt; list(PageParams pageParams, <span class="hljs-meta">@RequestBody</span> QueryCourseParamsDto queryCourseParams)&#123;<br>    <span class="hljs-comment">//取出用户身份</span><br>    XcUser user = SecurityUtil.getUser();<br>    <span class="hljs-comment">//机构id</span><br>    String companyId = user.getCompanyId();<br>    <span class="hljs-keyword">return</span> courseBaseInfoService.queryCourseBaseList(<span class="hljs-built_in">Long</span>.parseLong(companyId),pageParams,queryCourseParams);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Service方法如下：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs perl">Java<br>@Override<br>public PageResult&lt;CourseBase&gt; queryCourseBaseList(Long companyId,PageParams pageParams, QueryCourseParamsDto queryCourseParamsDto) &#123;<br><br> <span class="hljs-regexp">//</span>构建查询条件对象<br> LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();<br> <span class="hljs-regexp">//</span>机构id<br> queryWrapper.e<span class="hljs-string">q(CourseBase::getCompanyId,companyId)</span>;<br> ....<br><br></code></pre></td></tr></table></figure><h6 id="教学机构细粒度授权测试"><a href="#教学机构细粒度授权测试" class="headerlink" title="教学机构细粒度授权测试"></a>教学机构细粒度授权测试</h6><p>使用一个教学机构的用户登录项目，并且此用户具有查询课程的权限。</p><p>手机修改数据库指定用户归属到一个机构中，涉及以下数据表：</p><p>xc_company为机构表</p><p>xc_company_user为机构用户关系表</p><p>xc_user表中有company_id字段。</p><p>我们准备了t1 用户作为此次测试的用户，使用此用户登录系统：</p><p>提前在查询课程列表接口处打上断点。</p><p>经过测试可以正常取出用户所属的机构id</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155538069.png" alt="image-20231227155538069"></p><p>跟踪持久层日志发现已将机构id传入dao方法，拼装sql语句，查询本机构的课程信息</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155551246.png" alt="image-20231227155551246"></p><h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a><strong>实战</strong></h4><h5 id="找回密码"><a href="#找回密码" class="headerlink" title="找回密码"></a>找回密码</h5><p>需求：忘记密码需要找回，可以通过手机号找回密码，通过邮箱找回密码以及人工通道。</p><p>界面访问地址：<a href="http://www.51xuecheng.cn/findpassword.html">http://www.51xuecheng.cn/findpassword.html</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155646094.png" alt="image-20231227155646094" style="zoom: 30%;" /><p>接口：</p><p>手机验证码：&#x2F;api&#x2F;checkcode&#x2F;phone?param1&#x3D;手机号</p><p>邮箱验证码：&#x2F;api&#x2F;checkcode&#x2F;phone?param1&#x3D;电子邮箱地址</p><p>找回密码：&#x2F;api&#x2F;auth&#x2F;findpassword</p><p>请求：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-type">JSON</span><br>&#123;<br>     cellphone:<span class="hljs-string">&#x27;&#x27;</span>,<br>     email:<span class="hljs-string">&#x27;&#x27;</span>,<br>     checkcodekey:<span class="hljs-string">&#x27;&#x27;</span>,<br>     checkcode:<span class="hljs-string">&#x27;&#x27;</span>,<br>     confirmpwd:<span class="hljs-string">&#x27;&#x27;</span>,<br>     <span class="hljs-keyword">password</span>:<span class="hljs-string">&#x27;&#x27;</span><br> &#125;<br><br></code></pre></td></tr></table></figure><p>响应：</p><p>200: 找回成功</p><p>其它：找回失败，失败原因使用统一异常处理返回的信息格式</p><p>执行流程<br> 1、校验验证码，不一致则抛出异常</p><p>2、判断两次密码是否一致，不一致则抛出异常</p><p>3、根据手机号和邮箱查询用户</p><p>4、如果找到用户更新为新密码</p><h5 id="注册"><a href="#注册" class="headerlink" title="注册"></a><strong>注册</strong></h5><p>需求：为学生提供注册入口，通过此入口注册的用户为学生用户。</p><p>界面访问地址：<a href="http://www.51xuecheng.cn/register.html">http://www.51xuecheng.cn/register.html</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155822920.png" alt="image-20231227155822920" style="zoom:50%;" /><p>接口：</p><p>手机验证码：&#x2F;api&#x2F;checkcode&#x2F;phone?param1&#x3D;手机号</p><p>注册：&#x2F;api&#x2F;auth&#x2F;register</p><p>请求：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-type">JSON</span><br>&#123;<br>   cellphone:<span class="hljs-string">&#x27;&#x27;</span>,<br>   username:<span class="hljs-string">&#x27;&#x27;</span>,<br>   email:<span class="hljs-string">&#x27;&#x27;</span>,<br>   nickname:<span class="hljs-string">&#x27;&#x27;</span>,<br>   <span class="hljs-keyword">password</span>:<span class="hljs-string">&#x27;&#x27;</span>,<br>   confirmpwd:<span class="hljs-string">&#x27;&#x27;</span>,<br>   checkcodekey:<span class="hljs-string">&#x27;&#x27;</span>,<br>   checkcode:<span class="hljs-string">&#x27;&#x27;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>响应：</p><p>200: 注册成功</p><p>其它：注册失败，失败原因使用统一异常处理返回的信息格式</p><p>执行流程：</p><p>1、校验验证码，如果不一致则抛出异常</p><p>2、校验两次密码是否一致，如果不一致则抛出异常</p><p>3、校验用户是否存在，如果存在则抛出异常</p><p>4、向用户表、用户角色关系表添加数据。角色为学生角色。</p>]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
    <tags>
      
      <tag>学成在线</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>开发中遇到的疑难杂症</title>
    <link href="/2023/12/24/%E5%BC%80%E5%8F%91%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/"/>
    <url>/2023/12/24/%E5%BC%80%E5%8F%91%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/</url>
    
    <content type="html"><![CDATA[<blockquote><p>Error:(6, 46) java: 程序包org.springframework.context.annotation不存在</p><p>在cloud项目中导入别人的security模块，导入maven依赖，然后加载提示包不存在，根据报错导航到对应的代码，然后发现已经引进去了，并没有任何报错</p><p>解决：删除.iml文件      <img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224210337446.png" alt="image-20231224210337446" style="zoom: 50%;" /></p></blockquote>]]></content>
    
    
    
    <tags>
      
      <tag>疑难杂症</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>科目一</title>
    <link href="/2023/12/24/%E7%A7%91%E7%9B%AE%E4%B8%80/"/>
    <url>/2023/12/24/%E7%A7%91%E7%9B%AE%E4%B8%80/</url>
    
    <content type="html"><![CDATA[<h1 id="上篇"><a href="#上篇" class="headerlink" title="上篇"></a>上篇</h1><h2 id="扣分"><a href="#扣分" class="headerlink" title="扣分"></a>扣分</h2><p>没有2分，新增9分</p><p>记分：1 3 6 9 12分</p><h3 id="1分关键词"><a href="#1分关键词" class="headerlink" title="1分关键词"></a>1分关键词</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224151933597.png" alt="image-20231224151933597" style="zoom:33%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224152051675.png" alt="image-20231224152051675" style="zoom:33%;" /></p><h3 id="3分关键词"><a href="#3分关键词" class="headerlink" title="3分关键词"></a>3分关键词</h3><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224152428955.png" alt="image-20231224152428955" style="zoom:33%;" /><h3 id="6分关键词"><a href="#6分关键词" class="headerlink" title="6分关键词"></a>6分关键词</h3><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224152730680.png" alt="image-20231224152730680" style="zoom:50%;" /><h3 id="9分关键词"><a href="#9分关键词" class="headerlink" title="9分关键词"></a>9分关键词</h3><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224152930822.png" alt="image-20231224152930822" style="zoom:50%;" /><h3 id="12分关键词"><a href="#12分关键词" class="headerlink" title="12分关键词"></a>12分关键词</h3><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224153301174.png" alt="image-20231224153301174" style="zoom:50%;" /><h3 id="号牌扣分"><a href="#号牌扣分" class="headerlink" title="号牌扣分"></a>号牌扣分</h3><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224153633296.png" alt="image-20231224153633296" style="zoom:50%;" /><h3 id="超速扣分"><a href="#超速扣分" class="headerlink" title="超速扣分"></a>超速扣分</h3><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224153947301.png" alt="image-20231224153947301" style="zoom:40%;" /><p>超员扣分 </p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224155033946.png" alt="image-20231224155033946" style="zoom:50%;" /><h3 id="货车超载"><a href="#货车超载" class="headerlink" title="货车超载"></a>货车超载</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224155425537.png" alt="image-20231224155425537"></p><h2 id="罚款"><a href="#罚款" class="headerlink" title="罚款"></a>罚款</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224155540277.png" alt="image-20231224155540277" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224155847757.png" alt="image-20231224155847757" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224160350193.png" alt="image-20231224160350193" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224160608215.png" alt="image-20231224160608215" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224160906870.png" alt="image-20231224160906870" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224161102993.png" alt="image-20231224161102993" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224161320870.png" alt="image-20231224161320870" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224161441477.png" alt="image-20231224161441477" style="zoom:50%;" /><h2 id="驾驶证"><a href="#驾驶证" class="headerlink" title="驾驶证"></a>驾驶证</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224162011069.png" alt="image-20231224162011069" style="zoom:50%;" /><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224162237102.png" alt="image-20231224162237102"></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224162437961.png" alt="image-20231224162437961" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224162724842.png" alt="image-20231224162724842" style="zoom:50%;" /><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224164817339.png" alt="image-20231224164817339"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224164912146.png" alt="image-20231224164912146"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224165018645.png" alt="image-20231224165018645"></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224165205396.png" alt="image-20231224165205396" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224165318786.png" alt="image-20231224165318786" style="zoom:50%;" /><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224165415763.png" alt="image-20231224165415763"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224165628334.png" alt="image-20231224165628334"></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224165845098.png" alt="image-20231224165845098" style="zoom: 33%;" /><h2 id="责任判定"><a href="#责任判定" class="headerlink" title="责任判定"></a>责任判定</h2><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224170044884.png" alt="image-20231224170044884"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224170300651.png" alt="image-20231224170300651"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224170520250.png" alt="image-20231224170520250"></p><h1 id="下篇"><a href="#下篇" class="headerlink" title="下篇"></a>下篇</h1><h2 id="通行原则-标志标线"><a href="#通行原则-标志标线" class="headerlink" title="通行原则  标志标线"></a>通行原则  标志标线</h2><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227212244965.png" alt="image-20231227212244965"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227212437200.png" alt="image-20231227212437200"></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227212756344.png" alt="image-20231227212756344" style="zoom: 25%;" /><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227212853395.png" alt="image-20231227212853395"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227213123567.png" alt="image-20231227213123567"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227213314678.png" alt="image-20231227213314678"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227213420568.png" alt="image-20231227213420568"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227213529816.png" alt="image-20231227213529816"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227213734868.png" alt="image-20231227213734868"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227213844636.png" alt="image-20231227213844636"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227214103074.png" alt="image-20231227214103074"></p><h2 id="特殊天气"><a href="#特殊天气" class="headerlink" title="特殊天气"></a>特殊天气</h2><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227214258060.png" alt="image-20231227214258060"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227214349822.png" alt="image-20231227214349822"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227214638055.png" alt="image-20231227214638055"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227214832232.png" alt="image-20231227214832232"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227214920005.png" alt="image-20231227214920005"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227215034162.png" alt="image-20231227215034162"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227215214997.png" alt="image-20231227215214997"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227215334888.png" alt="image-20231227215334888"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227215518762.png" alt="image-20231227215518762"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227215758329.png" alt="image-20231227215758329"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227215836536.png" alt="image-20231227215836536"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227215938106.png" alt="image-20231227215938106"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228095132050.png" alt="image-20231228095132050"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228095228347.png" alt="image-20231228095228347"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228095314156.png" alt="image-20231228095314156"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228095407974.png" alt="image-20231228095407974"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228095631616.png" alt="image-20231228095631616"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228100711320.png" alt="image-20231228100711320"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228100851129.png" alt="image-20231228100851129"></p><h2 id="现场急救"><a href="#现场急救" class="headerlink" title="现场急救"></a>现场急救</h2><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228101132059.png" alt="image-20231228101132059"></p><h2 id="信号灯"><a href="#信号灯" class="headerlink" title="信号灯"></a>信号灯</h2><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228101449941.png" alt="image-20231228101449941"></p><h2 id="交警手势"><a href="#交警手势" class="headerlink" title="交警手势"></a>交警手势</h2><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228101802583.png" alt="image-20231228101802583"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228101836029.png" alt="image-20231228101836029"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228101901542.png"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228101927136.png" alt="image-20231228101927136"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228101947293.png" alt="image-20231228101947293"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228102033234.png" alt="image-20231228102033234"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228102051523.png" alt="image-20231228102051523"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228102118256.png" alt="image-20231228102118256"></p><h2 id="标志"><a href="#标志" class="headerlink" title="标志"></a>标志</h2><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228102334312.png" alt="image-20231228102334312"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228102627922.png" alt="image-20231228102627922"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228102636137.png" alt="image-20231228102636137"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228102728321.png" alt="image-20231228102728321"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228102836122.png" alt="image-20231228102836122"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228102911789.png" alt="image-20231228102911789"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103028346.png" alt="image-20231228103028346"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103048018.png" alt="image-20231228103048018"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103232015.png" alt="image-20231228103232015"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103300830.png" alt="image-20231228103300830"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103340248.png" alt="image-20231228103340248"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103353667.png" alt="image-20231228103353667"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103435215.png" alt="image-20231228103435215"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103531058.png" alt="image-20231228103531058"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103640747.png" alt="image-20231228103640747"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103736568.png" alt="image-20231228103736568"></p><h2 id="标线"><a href="#标线" class="headerlink" title="标线"></a>标线</h2><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103846272.png" alt="image-20231228103846272"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228103939190.png" alt="image-20231228103939190"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228104014080.png" alt="image-20231228104014080"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228104058127.png" alt="image-20231228104058127"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228104142808.png" alt="image-20231228104142808"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228104220769.png" alt="image-20231228104220769"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231228104331041.png" alt="image-20231228104331041"></p><h1 id="抢分"><a href="#抢分" class="headerlink" title="抢分"></a>抢分</h1><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203340965.png" alt="image-20231230203340965"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203404993.png" alt="image-20231230203404993"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203446369.png" alt="image-20231230203446369"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203502074.png" alt="image-20231230203502074"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203511435.png" alt="image-20231230203511435"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203542503.png" alt="image-20231230203542503"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203550250.png" alt="image-20231230203550250"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203604865.png" alt="image-20231230203604865"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203617744.png" alt="image-20231230203617744"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203629911.png" alt="image-20231230203629911"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231230203637354.png" alt="image-20231230203637354"></p>]]></content>
    
    
    
    <tags>
      
      <tag>驾照</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学成在线课程发布模块</title>
    <link href="/2023/12/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97/"/>
    <url>/2023/12/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="课程发布模块"><a href="#课程发布模块" class="headerlink" title="课程发布模块"></a>课程发布模块</h2><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>发布课程是一个确认操作，课程发布后学习者在网站搜索课程，查看课程详细信息，选课 支付 在线学习</p><p>课程编辑和发布的整体流程</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221221251630.png" alt="image-20231221221251630"></p><p>审核课程内容，目的是使课程内容不违规，在课程发布之前运营方进行课程审核，<code>审核通过</code>才能发布</p><p>教学机构可以在课程发布前通过课程<code>预览</code>看到课程发布后的效果,哪里的课程信息存在<code>问题</code>, 及时<code>修改</code></p><p>课程预览的效果图</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221221621545.png" alt="image-20231221221621545"></p><p>教学机构确认课程ok, 提交审核, 平台对内容审核, 审核ok后发布课程成功</p><p>课程发布模块包括三个功能:</p><h3 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h3><h4 id="课程预览"><a href="#课程预览" class="headerlink" title="课程预览"></a><code>课程预览</code></h4><p>在课程管理中对机构课程进行预览</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221224432470.png" alt="image-20231221224432470"></p><p>点击预览进入<code>课程详情首页</code></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221224525755.png" alt="image-20231221224525755"></p><p>点击课程目录, 查看课程计划是否ok</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221224638657.png" alt="image-20231221224638657"></p><p>点击目录中的章节,查看视频播放是否ok</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221224715727.png" alt="image-20231221224715727"> </p><h4 id="课程审核"><a href="#课程审核" class="headerlink" title="课程审核"></a>课程审核</h4><p>包括自动审核和人工审核,  程序自动审核内容完整性,  人工通过课程预览进行审核</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221225053333.png" alt="image-20231221225053333" style="zoom:50%;" /><p>1、首先查询待审核的记录。</p><p>2、课程审核</p><p>具体审核的过程与课程预览的过程类似，运营人员查看课程信息、课程视频等内容。</p><p>如果存在问题则审核不通过，并附上审核不通过的原因供教学机构人员查看。</p><p>如果课程内容没有违规信息且课程内容全面则审核通过。</p><p>课程审核通过后教学机构发布课程成功。</p><h4 id="课程发布"><a href="#课程发布" class="headerlink" title="课程发布"></a>课程发布</h4><ol><li>教学机构在课程管理中对审核通过的课程进行<code>发布</code></li></ol><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221225413532.png" alt="image-20231221225413532"></p><ol start="2"><li>课程发布后可通过课程搜索查询到课程信息，并查看课程的详细信息</li></ol><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221225500489.png" alt="image-20231221225500489"></p><ol start="3"><li>点击一个课程,进入课程详情页</li></ol><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221225618999.png" alt="image-20231221225618999"></p><h3 id="课程预览-1"><a href="#课程预览-1" class="headerlink" title="课程预览"></a>课程预览</h3><h4 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h4><p>把课程的相关信息进行整合，在课程详情界面进行展示，通过课程预览页面查看信息是否存在问题</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221225618999.png" alt="image-20231221225618999"></p><p>课程预览的数据来源: 需要查询4张表</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221230039407.png" alt="image-20231221230039407"></p><p>点击”视频播放图片”打开视频播放页面，通过视频播放页面查看课程计划对应的视频是否存在问题</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221230201212.png" alt="image-20231221230201212"></p><p>课程预览的效果与最终课程发布后查看到的效果是一致的，所以课程预览时会通过网站门户域名地址进行预览，下图显示了整个课程预览的<code>流程图</code></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231221230241087.png" alt="image-20231221230241087"></p><p>说明：</p><ol><li>点击课程预览，通过Nginx, 后台服务网关请求内容管理服务进行课程预览</li><li>内容管理服务查询课程信息进行整合,通过模块引擎技术在服务端渲染生成页面,返回给浏览器</li><li>通过课程预览页面点击马上学习打开视频播放页面</li><li>视频播放页面通过Nginx请求后台服务网关,查询课程信息展示课程计划目录,请求媒资服务查询课程计划绑定的视频文件地址,在线浏览播放视频</li></ol><h4 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h4><p>课程预览是把课程相关信息整合, 在课程预览界面展示, 课程预览界面和课程发布课程详情界面一致</p><p>项目采用模板引擎实现课程预览界面</p><p>什么是模板引擎?<br>jsp thymeleaf 都是模板引擎</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222111252295.png" alt="image-20231222111252295"></p><ol><li>浏览器请求web服务器</li><li>服务器渲染页面,渲染过程向jsp填充数据</li><li>服务器将渲染生成的页面返回浏览器</li></ol><p>所以模板引擎就是: 模板+数据&#x3D;输出  jsp页面是模板, 页面嵌入的jsp标签是数据, 两者结合输出html网页</p><p>本项目采用Freemarker作为模板引擎技术</p><p>Freemarker官方地址：<a href="http://freemarker.foofun.cn/">http://freemarker.foofun.cn/</a></p><p>下面在<code>内容管理接口层</code>搭建Freemarker的运行环境并进行测试</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs XML"><span class="hljs-comment">&lt;!-- Spring Boot 对结果视图 Freemarker 集成 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在nacos为内容管理接口层配置freemarker, 公用配置组新加一个freemarker-config-dev.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">freemarker:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span>   <span class="hljs-comment">#关闭模板缓存，方便测试</span><br>    <span class="hljs-attr">settings:</span><br>      <span class="hljs-attr">template_update_delay:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">suffix:</span> <span class="hljs-string">.ftl</span>   <span class="hljs-comment">#页面模板后缀名</span><br>    <span class="hljs-attr">charset:</span> <span class="hljs-string">UTF-8</span><br>    <span class="hljs-attr">template-loader-path:</span> <span class="hljs-string">classpath:/templates/</span>   <span class="hljs-comment">#页面模板位置(默认为 classpath:/templates/)</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-attr">add-mappings:</span> <span class="hljs-literal">false</span>   <span class="hljs-comment">#关闭项目中的静态资源映射(static、resources文件夹下的资源) </span><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222113325862.png" alt="image-20231222113325862"></p><p>本地项目yml加入公用配置</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222113252215.png" alt="image-20231222113252215"></p><p>添加模板, 在resources 下创建 templates 目录, 添加test.ftl模板文件 </p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222112512975.png" alt="image-20231222112512975"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Hello World!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>Hello $&#123;name&#125;!<br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>编写controller方法, 准备模型数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.api;<br><br><span class="hljs-keyword">import</span> org.bouncycastle.math.raw.Mod;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> freemarker测试</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/15 19:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FreemarkerController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/testfreemarker&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">test</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">modelAndView</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>();<br>        <span class="hljs-comment">//设置模型数据</span><br>        modelAndView.addObject(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;小明&quot;</span>);<br>        <span class="hljs-comment">//设置模板名称</span><br>        modelAndView.setViewName(<span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-keyword">return</span> modelAndView;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222112654679.png" alt="image-20231222112654679"></p><p>启动内容管理接口工程，访问<a href="http://localhost:63040/content/testfreemarker">http://localhost:63040/content/testfreemarker</a></p><p>屏幕输出：Hello 小明！</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222113358898.png" alt="image-20231222113358898"></p><p>freemarker提供很多指令用于解析各种类型的数据模型</p><p>参考地址：<a href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></p><h4 id="测试静态页面"><a href="#测试静态页面" class="headerlink" title="测试静态页面"></a>测试静态页面</h4><h5 id="部署网站门户"><a href="#部署网站门户" class="headerlink" title="部署网站门户"></a>部署网站门户</h5><p>在课程预览节目要加载css js 图片等内容, 这里不是nginx来访问这些静态资源</p><p>对于 springboot  服务的静态资源由 Nginx 去代理请求</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222113710927.png" alt="image-20231222113710927" style="zoom:50%;" /><ol><li>在本机安装nginx, 启动</li></ol><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222114301571.png" alt="image-20231222114301571"></p><ol start="2"><li>从课程资料目录获取xc-ui-pc-static-portal.zip 并解压。</li></ol><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222114455577.png" alt="image-20231222114455577" style="zoom:50%;" /><ol start="3"><li><p>修改本机hosts文件，加入127.0.0.1 <a href="http://www.51xuecheng.cn/">www.51xuecheng.cn</a> 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn。</p><p>window10操作系统hosts文件在C:\Windows\System32\drivers\etc下</p><p>Centos7操作系统的hosts文件在&#x2F;etc目录下。</p><p>在hosts文件加入如下配置</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span> www.<span class="hljs-number">51</span>xuecheng.cn <span class="hljs-number">51</span>xuecheng.cn ucenter.<span class="hljs-number">51</span>xuecheng.cn teacher.<span class="hljs-number">51</span>xuecheng.cn file.<span class="hljs-number">51</span>xuecheng.cn<br></code></pre></td></tr></table></figure><p>注意: <code>关闭代理</code></p><p>推荐使用工具   <code>SwitchHosts</code> (管理员权限)</p></li></ol><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222115146493.png" alt="image-20231222115146493" style="zoom:50%;" /><ol start="4"><li>在nginx-1.23.1目录中找到conf目录，配置目录下的nginx.conf文件,  配置内容如下，注意更改xc-ui-pc-static-portal目录的路径：</li></ol><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">server</span> &#123;<br>        <span class="hljs-keyword">listen</span>       <span class="hljs-number">80</span>;<br>        server_name  www<span class="hljs-number">.51</span>xuecheng.cn localhost;<br>        #rewrite ^(.*) https://$server_name$<span class="language-bash">1 permanent;</span><br><span class="language-bash">        <span class="hljs-comment">#charset koi8-r;</span></span><br><span class="language-bash">        ssi on;</span><br><span class="language-bash">        ssi_silent_errors on;</span><br><span class="language-bash">        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span></span><br><span class="language-bash"></span><br><span class="language-bash">        location / &#123;</span><br><span class="language-bash">            <span class="hljs-built_in">alias</span>   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/;</span><br><span class="language-bash">            index  index.html index.htm;</span><br><span class="language-bash">        &#125;</span><br><span class="language-bash">        <span class="hljs-comment">#静态资源</span></span><br><span class="language-bash">        location /static/img/ &#123;  </span><br><span class="language-bash">                <span class="hljs-built_in">alias</span>  D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/img/;</span><br><span class="language-bash">        &#125; </span><br><span class="language-bash">        location /static/css/ &#123;  </span><br><span class="language-bash">                <span class="hljs-built_in">alias</span>   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/css/;</span><br><span class="language-bash">        &#125; </span><br><span class="language-bash">        location /static/js/ &#123;  </span><br><span class="language-bash">                <span class="hljs-built_in">alias</span>   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/js/;</span><br><span class="language-bash">        &#125; </span><br><span class="language-bash">        location /static/plugins/ &#123;  </span><br><span class="language-bash">                <span class="hljs-built_in">alias</span>   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/plugins/;</span><br><span class="language-bash">                add_header Access-Control-Allow-Origin http://ucenter.51xuecheng.cn;  </span><br><span class="language-bash">                add_header Access-Control-Allow-Credentials <span class="hljs-literal">true</span>;  </span><br><span class="language-bash">                add_header Access-Control-Allow-Methods GET;</span><br><span class="language-bash">        &#125; </span><br><span class="language-bash">        location /plugins/ &#123;  </span><br><span class="language-bash">                <span class="hljs-built_in">alias</span>   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/plugins/;</span><br><span class="language-bash">        &#125; </span><br><span class="language-bash"></span><br><span class="language-bash"></span><br><span class="language-bash"></span><br><span class="language-bash">        <span class="hljs-comment">#error_page  404              /404.html;</span></span><br><span class="language-bash"></span><br><span class="language-bash">        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="language-bash">        <span class="hljs-comment">#</span></span><br><span class="language-bash">        error_page   500 502 503 504  /50x.html;</span><br><span class="language-bash">        location = /50x.html &#123;</span><br><span class="language-bash">            root   html;</span><br><span class="language-bash">        &#125;</span><br><span class="language-bash"></span><br><span class="language-bash">        <span class="hljs-comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="language-bash">        <span class="hljs-comment">#</span></span><br><span class="language-bash">        <span class="hljs-comment">#location ~ \.php$ &#123;</span></span><br><span class="language-bash">        <span class="hljs-comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="language-bash">        <span class="hljs-comment">#&#125;</span></span><br><span class="language-bash"></span><br><span class="language-bash">        <span class="hljs-comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="language-bash">        <span class="hljs-comment">#</span></span><br><span class="language-bash">        <span class="hljs-comment">#location ~ \.php$ &#123;</span></span><br><span class="language-bash">        <span class="hljs-comment">#    root           html;</span></span><br><span class="language-bash">        <span class="hljs-comment">#    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="language-bash">        <span class="hljs-comment">#    fastcgi_index  index.php;</span></span><br><span class="language-bash">        <span class="hljs-comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class="language-bash">        <span class="hljs-comment">#    include        fastcgi_params;</span></span><br><span class="language-bash">        <span class="hljs-comment">#&#125;</span></span><br><span class="language-bash"></span><br><span class="language-bash">        <span class="hljs-comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="language-bash">        <span class="hljs-comment"># concurs with nginx&#x27;s one</span></span><br><span class="language-bash">        <span class="hljs-comment">#</span></span><br><span class="language-bash">        <span class="hljs-comment">#location ~ /\.ht &#123;</span></span><br><span class="language-bash">        <span class="hljs-comment">#    deny  all;</span></span><br><span class="language-bash">        <span class="hljs-comment">#&#125;</span></span><br><span class="language-bash">    &#125;</span><br><span class="language-bash"></span><br></code></pre></td></tr></table></figure><p>启动nginx</p><p>任务管理器杀死所有 nginx进程</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222115525584.png" alt="image-20231222115525584" style="zoom: 50%;" /><p>杀死后再次双击nginx.exe。</p><p>启动成功在任务管理器会出现nginx的进程。</p><p>日志文件在nginx安装目录下的logs目录</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222115551832.png" alt="image-20231222115551832" style="zoom:50%;" /><p>启动成功访问<a href="http://www.51xuecheng.cn/">http://www.51xuecheng.cn</a> </p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222121854045.png" alt="image-20231222121854045" style="zoom:50%;" /><h5 id="课程详情页面"><a href="#课程详情页面" class="headerlink" title="课程详情页面"></a>课程详情页面</h5><p>course_template.html是一个静态html页面，里边还没有添加freemarker标签，如果要预览该页面需要借助Nginx进行预览，因为页面需要加载一些css样式表、图片等内容。</p><p>course_template.html文件在xc-ui-pc-static-portal\course目录下</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222121937256.png" alt="image-20231222121937256"></p><p>通过浏览器访问：<a href="http://www.51xuecheng.cn/course/course_template.html">http://www.51xuecheng.cn/course/course_template.html</a></p><p>效果如下:</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222121959011.png" alt="image-20231222121959011" style="zoom:50%;" /><h5 id="文件服务器"><a href="#文件服务器" class="headerlink" title="文件服务器"></a>文件服务器</h5><p>进行课程预览需要展示课程图片, 在线播放课程视频, 音乐, 图片等等在minio中存储, 下面统一由nginx代理, 通过文件服务域名统一访问</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222122116518.png" alt="image-20231222122116518" style="zoom:50%;" /><p>在hosts文件配置如下内容，如果已存在不要重复配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> www.51xuecheng.cn  file.51xuecheng.cn  <br></code></pre></td></tr></table></figure><p>在nginx.conf中配置文件服务器的代理地址</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nginx"> <span class="hljs-comment">#文件服务</span><br><span class="hljs-section">upstream</span> fileserver&#123;<br>  <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.101.65:9000</span> weight=<span class="hljs-number">10</span>;<br>&#125; <br> <span class="hljs-section">server</span> &#123;<br>      <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>      <span class="hljs-attribute">server_name</span>  file.51xuecheng.cn;<br>      <span class="hljs-comment">#charset koi8-r;</span><br>      <span class="hljs-attribute">ssi</span> <span class="hljs-literal">on</span>;<br>      <span class="hljs-attribute">ssi_silent_errors</span> <span class="hljs-literal">on</span>;<br>      <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>      <span class="hljs-section">location</span> /video &#123;<br>          <span class="hljs-attribute">proxy_pass</span>   http://fileserver;<br>      &#125;<br><br>      <span class="hljs-section">location</span> /mediafiles &#123;<br>          <span class="hljs-attribute">proxy_pass</span>   http://fileserver;<br>      &#125;<br> &#125;<br><br></code></pre></td></tr></table></figure><p>配置完毕，重新加载nginx配置文件。</p><p>通过cmd进入nginx.exe所在目录,运行如下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./nginx.exe -s reload<br></code></pre></td></tr></table></figure><p>通过&#96;<a href="http://file.51xuecheng.cn/mediafiles/%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%E5%9C%B0%E5%9D%80">http://file.51xuecheng.cn/mediafiles/图片文件地址</a> 访问图片</p><p>在媒资数据库的文件表中找一个图片的地址进行测试</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222123045642.png" alt="image-20231222123045642" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222123032722.png" alt="image-20231222123032722" style="zoom:50%;" /><h5 id="视频播放界面"><a href="#视频播放界面" class="headerlink" title="视频播放界面"></a>视频播放界面</h5><p>进入课程详情页面，点击马上学习或课程目录下的小节的名称将打开视频播放页面</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222142713872.png" alt="image-20231222142713872"></p><p>在nginx.conf中配置视频播放页面的地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">location /course/preview/learning.html &#123;<br><span class="hljs-built_in">alias</span> D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/course/learning.html;<br>&#125; <br>location /course/search.html &#123;  <br>root   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal;<br>&#125; <br>location /course/learning.html &#123;  <br>root   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal;<br>&#125; <br><br></code></pre></td></tr></table></figure><p>加载nginx配置文件</p><p>点击课程详情页面上的视频播放链接，打开视频播放页面，如下图</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222144054999.png" alt="image-20231222144054999" style="zoom:50%;" /><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222144108331.png" alt="image-20231222144108331"></p><p>下边需要配置learning.html页面的视频播放路径来测试视频播放页面，找到learning.html页面中videoObject对象的定义处，配置视频的播放地址(找一个minio里面存在的视频)</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222144753913.png" alt="image-20231222144753913" style="zoom:50%;" /><p>再次打开</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222144842231.png" alt="image-20231222144842231" style="zoom: 25%;" /><p>注意：此页面会去请求后台接口获取课程计划，这里暂时不处理，稍后在接口开发处进行处理。只要页面可以正常打开，可以播放视频就测试通过了。</p><h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><h5 id="定义课程预览接口"><a href="#定义课程预览接口" class="headerlink" title="定义课程预览接口"></a>定义课程预览接口</h5><p>课程预览接口是将课程信息整合, 在服务端渲染页面后返回给浏览器</p><p>分析课程预览接口:</p><ol><li>请求参数: 传入<code>课程id</code>, 表示要预览哪一门课程</li><li>响应结果: 输出<code>课程详情</code>页面到浏览器</li></ol><p>响应页面到浏览器用freemarker引擎技术实现, 资料获取课程预览页面course_template.html，拷贝至内容管理的接口工程的resources&#x2F;templates下，并将其在本目录复制一份命名为course_template.ftl</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222154648570.png" alt="image-20231222154648570" style="zoom:50%;" /><p>定义接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.api;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 课程预览 发布</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/22 15:38</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoursePublishController</span> &#123;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/coursepreview/&#123;courseId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">preview</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long courseId)</span>&#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">modelAndView</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>();<br>        modelAndView.addObject(<span class="hljs-string">&quot;model&quot;</span>, <span class="hljs-literal">null</span>);<br>        modelAndView.setViewName(<span class="hljs-string">&quot;course_template&quot;</span>);<br>        <span class="hljs-keyword">return</span> modelAndView;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>启动内容管理接口工程 ,访问<a href="http://localhost:63040/content/coursepreview/74">http://localhost:63040/content/coursepreview/74</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222155053498.png" alt="image-20231222155053498"></p><p>只有内容, 没有样式, 样式在nginx</p><h5 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h5><p>课程预览接口虽然可以正常访问，但是页面没有样式，查看浏览器请求记录，发现图片、样式无法正常访问</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222155234179.png" alt="image-20231222155234179" style="zoom:50%;" /><p>这些静态资源全在门户下，我们需要由Nginx反向代理访问课程预览接口，通过门户的URL去访问课程预览</p><p>1、在Nginx下配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#后台网关</span><br><span class="hljs-section">upstream</span> gatewayserver&#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:63010</span> weight=<span class="hljs-number">10</span>;<br>&#125; <br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span>  www.51xuecheng.cn localhost;<br>...<br>    <span class="hljs-comment">#api</span><br>    <span class="hljs-section">location</span> /api/ &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/;<br>    &#125; <br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>2、重新加载Nginx配置文件</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">nginx.exe -s <span class="hljs-keyword">reload</span><br></code></pre></td></tr></table></figure><p>3、启动微服务网关</p><p>4、此时访问新地址： <a href="http://www.51xuecheng.cn/api/content/coursepreview/74">http://www.51xuecheng.cn/api/content/coursepreview/74</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222160402181.png" alt="image-20231222160402181" style="zoom:50%;" /><p>页面虽然正常，但是里边的内容都是静态内容，稍后接口层调用service方式获取模型数据并进行页面渲染。</p><p>目前的方式是通过Nginx访问网关，由网关再将请求转发到微服务，Nginx是整个的项目最前方的代理服务器，如下图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222160425622.png" alt="image-20231222160425622" style="zoom:50%;" /><h4 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a>接口开发</h4><h5 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h5><p>课程预览是将课程基本信息, 营销信息, 课程计划, 师资等相关信息进行整合, 在预览页面进行展示</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222162212477.png" alt="image-20231222162212477" style="zoom:50%;" /><p>使用 freemarker 渲染生成视图需要<code>数据模型</code>, 包括基本信息, 营销信息, 课程计划, 师资等等</p><p>定义一个数据模型类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.model.dto;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.ToString;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 课程预览数据模型</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/16 15:03</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@Data</span><br> <span class="hljs-meta">@ToString</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoursePreviewDto</span> &#123;<br><br>    <span class="hljs-comment">//课程基本信息,课程营销信息</span><br>    CourseBaseInfoDto courseBase;<br><br><br>    <span class="hljs-comment">//课程计划信息</span><br>    List&lt;TeachplanDto&gt; teachplans;<br>    <br>    <span class="hljs-comment">//师资信息暂时不加...</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="service接口"><a href="#service接口" class="headerlink" title="service接口"></a>service接口</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.service.impl;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CourseBaseInfoDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.TeachplanDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CoursePublishService;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.TeachplanService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/22 16:26</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoursePublishServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CoursePublishService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    CourseBaseInfoService courseBaseInfoService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    TeachplanService teachplanService;<br><br>    <span class="hljs-comment">//获取课程预览信息</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> CoursePreviewDto <span class="hljs-title function_">getCoursePreviewInfo</span><span class="hljs-params">(Long courseId)</span> &#123;<br>        <span class="hljs-comment">//课程基本信息，营销信息</span><br>        <span class="hljs-type">CourseBaseInfoDto</span> <span class="hljs-variable">courseBaseInfo</span> <span class="hljs-operator">=</span> courseBaseInfoService.getCourseBaseInfo(courseId);<br>        <span class="hljs-comment">//课程计划信息</span><br>        List&lt;TeachplanDto&gt; teachplanTree = teachplanService.findTeachplanTree(courseId);<br><br>        <span class="hljs-type">CoursePreviewDto</span> <span class="hljs-variable">coursePreviewDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePreviewDto</span>();<br>        coursePreviewDto.setCourseBase(courseBaseInfo);<br>        coursePreviewDto.setTeachplans(teachplanTree);<br>        <br>        <span class="hljs-keyword">return</span> coursePreviewDto;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="完善controller"><a href="#完善controller" class="headerlink" title="完善controller"></a>完善controller</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CoursePublishService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 课程预览 发布</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/22 15:38</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoursePublishController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    CoursePublishService coursePublishService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/coursepreview/&#123;courseId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">preview</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long courseId)</span>&#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">modelAndView</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>();<br>        <span class="hljs-comment">//查询课程的信息作为模型数据</span><br>        <span class="hljs-type">CoursePreviewDto</span> <span class="hljs-variable">coursePreviewInfo</span> <span class="hljs-operator">=</span> coursePublishService.getCoursePreviewInfo(courseId);<br>        <span class="hljs-comment">//指定模型</span><br>        modelAndView.addObject(<span class="hljs-string">&quot;model&quot;</span>, coursePreviewInfo);<br>        <span class="hljs-comment">//指定模板</span><br>        modelAndView.setViewName(<span class="hljs-string">&quot;course_template&quot;</span>);<br>        <span class="hljs-keyword">return</span> modelAndView;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a>前后端联调</h5><p>原来前端直接指向后台网关地址，现在要更改为Nginx的地址，如下</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222164446204.png" alt="image-20231222164446204" style="zoom:50%;" /><p>重启前端工程，进入课程列表点击”预览”按钮，正常打开课程预览页面</p><p><a href="http://www.51xuecheng.cn/api/content/coursepreview/2">http://www.51xuecheng.cn/api/content/coursepreview/2</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222164512645.png" alt="image-20231222164512645"></p><p>-&gt;</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222171902870.png" alt="image-20231222171902870" style="zoom:50%;" /><h5 id="编写模板"><a href="#编写模板" class="headerlink" title="编写模板"></a>编写模板</h5><p>填充数据下一步将模型数据填充到course_template.ftl上, 填充时不要一次填充太多, 一边填充一边刷新调试</p><p>freemarker提供很多指令用于解析各种类型的数据模型，参考地址：</p><p><a href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></p><p>修改模板后需要编译，如下图</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222174434962.png" alt="image-20231222174434962" style="zoom:67%;" /><p>在调试模板时，可以看出哪些信息有缺少，在课程管理处进行补充，比如下图显示课程计划信息不完整，需要进入课程计划界面添加课程计划</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222174527966.png" alt="image-20231222174527966" style="zoom:50%;" /><p>完整的course_template.ftl模板在课程资料目录下，差不多学会了freemarker标签的使用方法，将课程资料下的course_template.ftl覆盖自己的工程下的course_template.ftl。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;zh-CN&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;X-UA-Compatible&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;IE=edge&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;description&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;author&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;icon&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/static/img/asset-favicon.ico&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>学成在线-$&#123;model.courseBase.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/static/plugins/normalize-css/normalize.css&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/static/plugins/bootstrap/dist/css/bootstrap.css&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/static/css/page-learing-article.css&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">data-spy</span>=<span class="hljs-string">&quot;scroll&quot;</span> <span class="hljs-attr">data-target</span>=<span class="hljs-string">&quot;#articleNavbar&quot;</span> <span class="hljs-attr">data-offset</span>=<span class="hljs-string">&quot;150&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 页面头部 --&gt;</span><br><span class="hljs-comment">&lt;!--#include virtual=&quot;/include/header.html&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--页面头部结束sss--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;learningArea&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-banner&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;banner-bg&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;banner-info&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;banner-left&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>$&#123;model.courseBase.mtName&#125;<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>\ $&#123;model.courseBase.stName&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;tit&quot;</span>&gt;</span>$&#123;model.courseBase.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;pic&quot;</span>&gt;</span><br>                &lt;#if model.courseBase.charge==&#x27;201000&#x27;&gt;<br>                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;new-pic&quot;</span>&gt;</span>免费<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                &lt;#else&gt;<br>                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;new-pic&quot;</span>&gt;</span>特惠价格￥$&#123;model.courseBase.price!&#x27;&#x27;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;old-pic&quot;</span>&gt;</span>原价￥$&#123;model.courseBase.originalPrice!&#x27;&#x27;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                &lt;/#if&gt;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span> @<span class="hljs-attr">click.prevent</span>=<span class="hljs-string">&quot;startLearning()&quot;</span>&gt;</span>马上学习<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>难度等级<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><br>                &lt;#if model.courseBase.grade==&#x27;204001&#x27;&gt;<br>                    初级<br>                 &lt;#elseif model.courseBase.grade==&#x27;204002&#x27;&gt;<br>                    中级<br>                &lt;#elseif model.courseBase.grade==&#x27;204003&#x27;&gt;<br>                    高级<br>                &lt;/#if&gt;<br>                <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>课程时长<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span>2小时27分<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>评分<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span>4.7分<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>授课模式<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><br>                 &lt;#if model.courseBase.teachmode==&#x27;200002&#x27;&gt;<br>                     录播<br>                 &lt;#elseif model.courseBase.teachmode==&#x27;200003&#x27;&gt;<br>                     直播<br>                 &lt;/#if&gt;<br>                <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;banner-rit&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://www.51xuecheng.cn/course/preview/learning.html?id=$&#123;model.courseBase.id&#125;&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span><br>                    &lt;#if model.courseBase.pic??&gt;<br>                        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://file.51xuecheng.cn$&#123;model.courseBase.pic&#125;&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;270&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;156&quot;</span>&gt;</span><br>                    &lt;#else&gt;<br>                        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-video.png&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;270&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;156&quot;</span>&gt;</span><br>                    &lt;/#if&gt;<br><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;vid-act&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-heart&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>收藏 23 <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>分享 <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-weixin&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-qq&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-cont&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;tit-list&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:;&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;articleClass&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active&quot;</span>&gt;</span>课程介绍<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:;&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;articleItem&quot;</span>&gt;</span>目录<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:;&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;artcleAsk&quot;</span>&gt;</span>问答<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:;&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;artcleNot&quot;</span>&gt;</span>笔记<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:;&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;artcleCod&quot;</span>&gt;</span>评价<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;div class=&quot;down-fill&quot;&gt;</span><br><span class="hljs-comment">            &lt;span&gt;资料下载&lt;/span&gt;</span><br><span class="hljs-comment">            &lt;ul&gt;</span><br><span class="hljs-comment">                &lt;li&gt;java视频资料&lt;/li&gt;</span><br><span class="hljs-comment">                &lt;li&gt;java视频资料&lt;/li&gt;</span><br><span class="hljs-comment">                &lt;li&gt;java视频资料&lt;/li&gt;</span><br><span class="hljs-comment">            &lt;/ul&gt;</span><br><span class="hljs-comment">        &lt;/div&gt;--&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-box&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;articleClass&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display: block&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--&lt;div class=&quot;rit-title&quot;&gt;评价&lt;/div&gt;--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-cont&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-left-box&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span><br><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content-com suit&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>适用人群<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;cont cktop&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> &gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>$&#123;model.courseBase.users!&quot;&quot;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-comment">&lt;!--&lt;span class=&quot;on-off&quot;&gt;更多 &lt;i class=&quot;i-chevron-bot&quot;&gt;&lt;/i&gt;&lt;/span&gt;--&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content-com course&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>课程制作<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;cont&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;img-box&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;info-box&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;name&quot;</span>&gt;</span>教学方：<span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>XX老师<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-comment">&lt;!-- &lt;p class=&quot;lab&quot;&gt;高级前端开发工程师 10年开发经验&lt;/p&gt;--&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span>JavaEE开发与教学多年，精通JavaEE技术体系，对流行框架JQuery、DWR、Struts1/2，Hibernate，Spring，MyBatis、JBPM、Lucene等有深入研究。授课逻辑严谨，条理清晰，注重学生独立解决问题的能力。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-comment">&lt;!-- &lt;p&gt;&lt;span&gt;难度等级&lt;/span&gt;中级&lt;/p&gt;</span><br><span class="hljs-comment">                                     &lt;p&gt;&lt;span&gt;课程时长&lt;/span&gt;8-16小时/周，共4周&lt;/p&gt;</span><br><span class="hljs-comment">                                     &lt;p&gt;&lt;span&gt;如何通过&lt;/span&gt;通过所有的作业及考核，作业共4份，考核为一次终极考核&lt;/p&gt;</span><br><span class="hljs-comment">                                     &lt;p&gt;&lt;span&gt;用户评分&lt;/span&gt;平均用户评分 &lt;em&gt;4.9&lt;/em&gt; &lt;a href=&quot;#&quot;&gt;查看全部评价&lt;/a&gt;&lt;/p&gt;</span><br><span class="hljs-comment">                                     &lt;p&gt;&lt;span&gt;课程价格&lt;/span&gt;特惠价格&lt;em&gt;￥999&lt;/em&gt; &lt;i&gt; 原价1999 &lt;/i&gt;&lt;/p&gt;--&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content-com about&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>课程介绍<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;cont cktop&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> &gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>$&#123;model.courseBase.description!&quot;&quot;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-comment">&lt;!--&lt;span class=&quot;on-off&quot;&gt;更多 &lt;i class=&quot;i-chevron-bot&quot;&gt;&lt;/i&gt;&lt;/span&gt;--&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content-com prob&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>常见问题<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;cont&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;on-off&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 我什么时候能够访问课程视频与作业？<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>课程安排灵活，课程费用支付提供180天全程准入和资格证书。自定进度课程建议的最后期限，但你不会受到惩罚错过期限，只要你赚你的证书在180天内。以会话为基础的课程可能要求你在截止日期前保持正轨，但如果你落后了，你可以切换到以后的会议，你完成的任何工作将与你转移。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;on-off&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 如何需要额外的时间来完成课程会怎么样？<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>课程安排灵活，课程费用支付提供180天全程准入和资格证书。自定进度课程建议的最后期限，但你不会受到惩罚错过期限，只要你赚你的证书在180天内。以会话为基础的课程可能要求你在截止日期前保持正轨，但如果你落后了，你可以切换到以后的会议，你完成的任何工作将与你转移。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;on-off&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 我支付次课程之后会得到什么？<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>课程安排灵活，课程费用支付提供180天全程准入和资格证书。自定进度课程建议的最后期限，但你不会受到惩罚错过期限，只要你赚你的证书在180天内。以会话为基础的课程可能要求你在截止日期前保持正轨，但如果你落后了，你可以切换到以后的会议，你完成的任何工作将与你转移。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;on-off&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 退款条例是如何规定的？<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>课程安排灵活，课程费用支付提供180天全程准入和资格证书。自定进度课程建议的最后期限，但你不会受到惩罚错过期限，只要你赚你的证书在180天内。以会话为基础的课程可能要求你在截止日期前保持正轨，但如果你落后了，你可以切换到以后的会议，你完成的任何工作将与你转移。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;on-off&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 有助学金？<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>课程安排灵活，课程费用支付提供180天全程准入和资格证书。自定进度课程建议的最后期限，但你不会受到惩罚错过期限，只要你赚你的证书在180天内。以会话为基础的课程可能要求你在截止日期前保持正轨，但如果你落后了，你可以切换到以后的会议，你完成的任何工作将与你转移。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br>                <span class="hljs-comment">&lt;!--侧边栏--&gt;</span><br>                <span class="hljs-comment">&lt;!--#include virtual=&quot;/include/course_detail_side.html&quot;--&gt;</span><br>                <span class="hljs-comment">&lt;!--侧边栏--&gt;</span><br><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;articleItem&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display: none&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-cont-catalog&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-left-box&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span><br>                        &lt;#list model.teachplans as firstNode&gt;<br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title act&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-top&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>$&#123;firstNode.pname&#125;<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>x小时<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;height: 260px;&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;list-box&quot;</span>&gt;</span><br>                                        &lt;#list firstNode.teachPlanTreeNodes as secondNode&gt;<br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://www.51xuecheng.cn/course/preview/learning.html?id=$&#123;model.courseBase.id&#125;&amp;chapter=$&#123;secondNode.teachplanMedia.teachplanId!&#x27;&#x27;&#125;&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span>$&#123;secondNode.pname&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                        &lt;/#list&gt;<br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        &lt;/#list&gt;<br>                       &lt;#-- <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title act&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-top&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>第一阶段 HTTP协议基础详解<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>8小时<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;about&quot;</span>&gt;</span>使用Java消息中间件处理异步消息成为了分布式系统中的必修课，通过本门课程可以深入浅出的学习如何在Java中使用消息中间件并且一步一步打造更优雅的最佳实践方案。<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;height: 260px;&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;list-box&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active&quot;</span>&gt;</span>1.1 阅读：分级政策细节 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>97’33”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.2 视频：为什么分为 A 部分、B 部分、C 部分 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>66’15”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.3 视频：软件安装介绍 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>86’42”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.4 阅读：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>59’00”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.5 作业1：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>93’29”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>阶段测试<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>--&gt;<br><br><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--侧边栏--&gt;</span><br>                <span class="hljs-comment">&lt;!--#include virtual=&quot;/include/course_detail_side.html&quot;--&gt;</span><br>                <span class="hljs-comment">&lt;!--侧边栏--&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        &lt;#--<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;articleItem&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display: none&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-cont-catalog&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-left-box&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title act&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-top&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>第一阶段 HTTP协议基础详解<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>8小时<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;about&quot;</span>&gt;</span>使用Java消息中间件处理异步消息成为了分布式系统中的必修课，通过本门课程可以深入浅出的学习如何在Java中使用消息中间件并且一步一步打造更优雅的最佳实践方案。<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;height: 260px;&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;list-box&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active&quot;</span>&gt;</span>1.1 阅读：分级政策细节 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>97’33”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.2 视频：为什么分为 A 部分、B 部分、C 部分 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>66’15”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.3 视频：软件安装介绍 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>86’42”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.4 阅读：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>59’00”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.5 作业1：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>93’29”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>阶段测试<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>第二阶段 HTTP协议基础详解<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>8小时<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;about&quot;</span>&gt;</span>使用Java消息中间件处理异步消息成为了分布式系统中的必修课，通过本门课程可以深入浅出的学习如何在Java中使用消息中间件并且一步一步打造更优雅的最佳实践方案。<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;list-box&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active&quot;</span>&gt;</span>1.1 阅读：分级政策细节 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>97’33”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.2 视频：为什么分为 A 部分、B 部分、C 部分 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>66’15”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.3 视频：软件安装介绍 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>86’42”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.4 阅读：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>59’00”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.5 作业1：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>93’29”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>阶段测试<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>第三阶段 HTTP协议基础详解<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>3小时<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;about&quot;</span>&gt;</span>使用Java消息中间件处理异步消息成为了分布式系统中的必修课，通过本门课程可以深入浅出的学习如何在Java中使用消息中间件并且一步一步打造更优雅的最佳实践方案。<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;list-box&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active&quot;</span>&gt;</span>1.1 阅读：分级政策细节 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>97’33”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.2 视频：为什么分为 A 部分、B 部分、C 部分 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>66’15”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.3 视频：软件安装介绍 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>86’42”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.4 阅读：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>59’00”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.5 作业1：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>93’29”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>阶段测试<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>第四阶段 HTTP协议基础详解<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>3小时<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;about&quot;</span>&gt;</span>使用Java消息中间件处理异步消息成为了分布式系统中的必修课，通过本门课程可以深入浅出的学习如何在Java中使用消息中间件并且一步一步打造更优雅的最佳实践方案。<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;list-box&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active&quot;</span>&gt;</span>1.1 阅读：分级政策细节 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>97’33”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.2 视频：为什么分为 A 部分、B 部分、C 部分 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>66’15”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.3 视频：软件安装介绍 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>86’42”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.4 阅读：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>59’00”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.5 作业1：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>93’29”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>阶段测试<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>第五阶段 HTTP协议基础详解<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>3小时<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;about&quot;</span>&gt;</span>使用Java消息中间件处理异步消息成为了分布式系统中的必修课，通过本门课程可以深入浅出的学习如何在Java中使用消息中间件并且一步一步打造更优雅的最佳实践方案。<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drop-down&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;list-box&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active&quot;</span>&gt;</span>1.1 阅读：分级政策细节 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>97’33”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.2 视频：为什么分为 A 部分、B 部分、C 部分 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>66’15”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.3 视频：软件安装介绍 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>86’42”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.4 阅读：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>59’00”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1.5 作业1：Emacs安装 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>93’29”<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>阶段测试<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;overwrite&quot;</span>&gt;</span>毕业考核<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--侧边栏&amp;ndash;&amp;gt;</span><br><span class="hljs-comment">                &lt;!--#include virtual=&quot;/include/course_detail_side.html&quot;&amp;ndash;&amp;gt;</span><br><span class="hljs-comment">                &lt;!--侧边栏&amp;ndash;&amp;gt;</span><br><span class="hljs-comment">            &lt;/div&gt;</span><br><span class="hljs-comment">        &lt;/div&gt;--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;artcleAsk&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display: none&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-cont-ask&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-left-box&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content-title&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;all&quot;</span>&gt;</span>全部<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>精选<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>我的<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;all&quot;</span>&gt;</span>全部<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>1.2<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>1.3<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>1.4<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>1.5<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;$&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;more&quot;</span>&gt;</span>更多 <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-right&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>如何用微服务重构应用程序?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>我来回答<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>2017-3-20 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>回答2<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>浏览2<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-right&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>如何用微服务重构应用程序?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>在讨论如何将重构转化为微服务之前，退后一步，仔细观察微服务的内容和时间是很重要的。以下两个要点将会对任何微服务重构策略产生重大影响。 【最新 <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;new&quot;</span>&gt;</span>心跳347890<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 的回答】<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>2017-3-20 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action-box&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-answer&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>回答 2<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-browse&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>浏览 12<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-right&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>如何用微服务重构应用程序?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>在讨论如何将重构转化为微服务之前，退后一步，仔细观察微服务的内容和时间是很重要的。以下两个要点将会对任何微服务重构策略产生重大影响。 【最新 <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;new&quot;</span>&gt;</span>心跳347890<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 的回答】<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>2017-3-20 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action-box&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-answer&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>回答 2<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-browse&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>浏览 12<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-right&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>如何用微服务重构应用程序?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>在讨论如何将重构转化为微服务之前，退后一步，仔细观察微服务的内容和时间是很重要的。以下两个要点将会对任何微服务重构策略产生重大影响。 【最新 <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;new&quot;</span>&gt;</span>心跳347890<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 的回答】<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>2017-3-20 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action-box&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-answer&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>回答 2<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-browse&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>浏览 12<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-right&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>如何用微服务重构应用程序?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>在讨论如何将重构转化为微服务之前，退后一步，仔细观察微服务的内容和时间是很重要的。以下两个要点将会对任何微服务重构策略产生重大影响。 【最新 <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;new&quot;</span>&gt;</span>心跳347890<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 的回答】<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>2017-3-20 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action-box&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-answer&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>回答 2<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-browse&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>浏览 12<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-right&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>如何用微服务重构应用程序?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>在讨论如何将重构转化为微服务之前，退后一步，仔细观察微服务的内容和时间是很重要的。以下两个要点将会对任何微服务重构策略产生重大影响。 【最新 <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;new&quot;</span>&gt;</span>心跳347890<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 的回答】<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>2017-3-20 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action-box&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-answer&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>回答 2<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-browse&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>浏览 12<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;itemlast&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;overwrite&quot;</span>&gt;</span>显示更多问题<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--侧边栏--&gt;</span><br>                <span class="hljs-comment">&lt;!--#include virtual=&quot;/include/course_detail_side.html&quot;--&gt;</span><br>                <span class="hljs-comment">&lt;!--侧边栏--&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;artcleNot&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display: none;&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-cont-note&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-left-box&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content-title&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;all&quot;</span>&gt;</span>全部<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>精选<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>我的<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;all&quot;</span>&gt;</span>全部<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>1.2<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>1.3<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>1.4<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>1.5<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;$&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;more&quot;</span>&gt;</span>更多 <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-chevron-bot&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-right&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;video-time&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-play&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>2`10`<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-demo.png&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;221&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action-box&quot;</span>&gt;</span>4小时前 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active-box&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-coll&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>采集<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-laud&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>赞<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-right&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>在讨论如何将重构转化为微服务之前，退后一步，<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>仔细观察微服务的内容和时间是很重要的。<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>以下两个要点将会对任何微服务重构策略产生重大影响。 <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action-box&quot;</span>&gt;</span>4小时前 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active-box&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-edt&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>编辑<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-del&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-laud&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>赞<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-right&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>在讨论如何将重构转化为微服务之前，退后一步，<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>仔细观察微服务的内容和时间是很重要的。<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>以下两个要点将会对任何微服务重构策略产生重大影响。 <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action-box&quot;</span>&gt;</span>4小时前 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active-box&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-edt&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>编辑<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-del&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-laud&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>赞<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-myImg.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-right&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>在讨论如何将重构转化为微服务之前，退后一步，<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>仔细观察微服务的内容和时间是很重要的。<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>以下两个要点将会对任何微服务重构策略产生重大影响。 <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action-box&quot;</span>&gt;</span>4小时前 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active-box&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-edt&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>编辑<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-del&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;i-laud&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>赞<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--侧边栏--&gt;</span><br>                <span class="hljs-comment">&lt;!--#include virtual=&quot;/include/course_detail_side.html&quot;--&gt;</span><br>                <span class="hljs-comment">&lt;!--侧边栏--&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;artcleCod&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display: none;&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-cont&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;article-left-box&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;comment-box&quot;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;evaluate&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;eva-top&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;tit&quot;</span>&gt;</span>课程评分 <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;score&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-score&quot;</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 分<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;eva-cont&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;tit&quot;</span>&gt;</span>学员评语 <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;text-box&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">rows</span>=<span class="hljs-string">&quot;5&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;扯淡、吐槽、表扬、鼓励......想说啥说啥！&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;text-right&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>发表评论<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;course-evaluate&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;top-tit&quot;</span>&gt;</span>评论<br>                                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;eval&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;radio&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">checked</span> /&gt;</span> 所有学生 <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;eval&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;radio&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> /&gt;</span> 完成者 <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;top-cont&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;cont-top-left&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-scor&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-show&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;score&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;scor&quot;</span>&gt;</span>4.9分<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;all-scor&quot;</span>&gt;</span>总评分：12343<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;cont-top-right&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-grade&quot;</span>&gt;</span>五星<br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;grade&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;grade-percent&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;percent-num&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>95<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>%<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-grade&quot;</span>&gt;</span>四星<br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;grade&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;grade-percent&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;percent-num&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>%<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-grade&quot;</span>&gt;</span>三星<br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;grade&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;grade-percent&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;percent-num&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>%<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-grade&quot;</span>&gt;</span>二星<br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;grade&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;grade-percent&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;percent-num&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>%<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-grade&quot;</span>&gt;</span>一星<br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;grade&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;grade-percent&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;percent-num&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>%<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;comment-item-box&quot;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>评论 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>12453条评论<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-pic.png&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-cent&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>很受用，如果再深入下就更好了。虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>2017-2-43<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-rit&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-show&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;score&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>评分 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>5星<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-pic.png&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-cent&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>很受用，如果再深入下就更好了。虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>2017-2-43<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-rit&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-show&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;score&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>评分 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>5星<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-pic.png&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-cent&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>很受用，如果再深入下就更好了。虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>2017-2-43<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-rit&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-show&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;score&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>评分 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>5星<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-left&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/img/widget-pic.png&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;60px&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>毛老师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-cent&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>很受用，如果再深入下就更好了。虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;time&quot;</span>&gt;</span>2017-2-43<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;item-rit&quot;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;star-show&quot;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;score&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>评分 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>5星<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;get-more&quot;</span>&gt;</span>页面加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--侧边栏--&gt;</span><br>                <span class="hljs-comment">&lt;!--#include virtual=&quot;/include/course_detail_side.html&quot;--&gt;</span><br>                <span class="hljs-comment">&lt;!--侧边栏--&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;popup-course&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;mask&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--欢迎访问课程弹窗- start --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;popup-course-box&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>$&#123;model.courseBase.name&#125; <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;close-popup-course-box&quot;</span>&gt;</span>×<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>欢迎学习本课程，本课程免费您可以立即学习，也可加入我的课程表享受更优质的服务。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span> @<span class="hljs-attr">click.prevent</span>=<span class="hljs-string">&quot;addCourseTable()&quot;</span>&gt;</span>加入我的课程表<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span> @<span class="hljs-attr">click.prevent</span>=<span class="hljs-string">&quot;startLearngin()&quot;</span>&gt;</span>立即学习<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;popup-box&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;mask&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--支付弹窗- start --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;popup-pay-box&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>$&#123;model.courseBase.name&#125; <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;close-popup-pay-box&quot;</span>&gt;</span>×<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">&quot;qrcode&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;200&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;200&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;请点击支付宝支付按钮，并完成扫码支付。&quot;</span>/&gt;</span><br><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;info-tit&quot;</span>&gt;</span>$&#123;model.courseBase.name&#125;<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>课程有效期:$&#123;model.courseBase.validDays&#125;天<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;info-pic&quot;</span>&gt;</span>课程价格 : <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>￥$&#123;model.courseBase.originalPrice!&#x27;&#x27;&#125;元<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;info-new-pic&quot;</span>&gt;</span>优惠价格 : <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>￥$&#123;model.courseBase.price!&#x27;&#x27;&#125;元<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fact-pic&quot;</span>&gt;</span>实际支付: <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>￥$&#123;model.courseBase.price!&#x27;&#x27;&#125;元<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;go-pay&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span> @<span class="hljs-attr">click.prevent</span>=<span class="hljs-string">&quot;wxPay()&quot;</span>&gt;</span>微信支付<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span> @<span class="hljs-attr">click.prevent</span>=<span class="hljs-string">&quot;aliPay()&quot;</span>&gt;</span>支付宝支付<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span> @<span class="hljs-attr">click.prevent</span>=<span class="hljs-string">&quot;querypayresult()&quot;</span>&gt;</span>支付完成<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span> @<span class="hljs-attr">click.prevent</span>=<span class="hljs-string">&quot;startLearngin()&quot;</span>&gt;</span>试学<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--支付弹窗- end --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;popup-comment-box&quot;</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 页面底部 --&gt;</span><br>    <span class="hljs-comment">&lt;!--底部版权--&gt;</span><br>    <span class="hljs-comment">&lt;!--#include virtual=&quot;/include/footer.html&quot;--&gt;</span><br>    <span class="hljs-comment">&lt;!--底部版权--&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"><span class="hljs-keyword">var</span> courseId = <span class="hljs-string">&quot;$&#123;model.courseBase.id&#125;&quot;</span>;<span class="hljs-keyword">var</span> courseCharge = <span class="hljs-string">&quot;$&#123;model.courseBase.charge&#125;&quot;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-comment">&lt;!--#include virtual=&quot;/include/course_detail_dynamic.html&quot;--&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h5 id="视频播放页面接口"><a href="#视频播放页面接口" class="headerlink" title="视频播放页面接口"></a>视频播放页面接口</h5><p>从课程详情页面进入视频播放页面</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222174822888.png" alt="image-20231222174822888" style="zoom:50%;" /><p>在此页面需要从后台获取课程信息, <code>根据课程计划获取对应的视频地址</code>，下边编写这两个接口：</p><p>获取课程信息接口：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/open/</span>content<span class="hljs-regexp">/course/</span>whole/课程id<br><br>响应：同课程预览service接口返回数据<br></code></pre></td></tr></table></figure><p>根据课程计划获取视频地址接口：&#x2F;open&#x2F;media&#x2F;preview&#x2F;{mediaId}</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">/open/media/preview/课程计划<span class="hljs-built_in">id</span><br><br>响应：<br>&#123;<span class="hljs-string">&quot;code&quot;</span>:0,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;success&quot;</span>,<span class="hljs-string">&quot;result&quot;</span>:<span class="hljs-string">&quot;视频的url&quot;</span>,<span class="hljs-string">&quot;successful&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br></code></pre></td></tr></table></figure><p>1、在nginx配置如下地址</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#openapi</span><br><span class="hljs-section">location</span> /open/content/ &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/content/open/;<br>&#125; <br><span class="hljs-section">location</span> /open/media/ &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/media/open/;<br>&#125; <br></code></pre></td></tr></table></figure><p>配置运行nginx.exe -s reload加载nginx的配置文件 </p><p>2、在内容管理接口层定义CourseOpenController类，并定义接口：获取课程信息接口：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CoursePublishService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/22 17:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = &quot;视频公开查询接口&quot;, tags = &quot;课程公开查询接口&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/open&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseOpenController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CourseBaseInfoService courseBaseInfoService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CoursePublishService coursePublishService;<br><br>    <span class="hljs-comment">//获取课程预览信息</span><br>    <span class="hljs-meta">@GetMapping(&quot;/course/whole/&#123;courseId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> CoursePreviewDto <span class="hljs-title function_">getPreviewInfo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;<br>        <span class="hljs-type">CoursePreviewDto</span> <span class="hljs-variable">coursePreviewInfo</span> <span class="hljs-operator">=</span> coursePublishService.getCoursePreviewInfo(courseId);<br>        <span class="hljs-keyword">return</span> coursePreviewInfo;<br>    &#125;<br><br>    <br><br>&#125;<br></code></pre></td></tr></table></figure><p>3、在媒资管理服务media-api工程定义MediaOpenController类，并定义接口&#x2F;open&#x2F;media&#x2F;preview&#x2F;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaFiles;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/22 17:55</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = &quot;媒资文件管理接口&quot;, tags = &quot;媒资文件管理接口&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/open&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaOpenController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileService mediaFileService;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;预览文件&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/preview/&#123;mediaId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;String&gt; <span class="hljs-title function_">getPlayUrlByMediaId</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long mediaId)</span>&#123;<br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFileService.getFileById(mediaId);<br>        <span class="hljs-keyword">if</span> (mediaFiles==<span class="hljs-literal">null</span>|| StringUtils.isEmpty(mediaFiles.getUrl()))&#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;视频没有转码处理&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> RestResponse.success(mediaFiles.getUrl());<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p>5、测试</p><p>定义好后，启动内容管理、媒资管理、后台服务网关服务，测试视频播放页面是否可以正常获取课程计划，点击具体的课程计划是否正常可以播放视频。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222182532558.png" alt="image-20231222182532558" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222182543866.png" alt="image-20231222182543866" style="zoom: 50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222182554000.png" alt="image-20231222182554000" style="zoom: 25%;" /><h3 id="课程审核-1"><a href="#课程审核-1" class="headerlink" title="课程审核"></a>课程审核</h3><h4 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h4><h5 id="业务流程-1"><a href="#业务流程-1" class="headerlink" title="业务流程"></a>业务流程</h5><p>根据模块需求分析, 课程发布前需要先审核,审核通过才能发布, 审核及发布流程图</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222195927107.png" alt="image-20231222195927107" style="zoom:67%;" /><p>为什么课程审核通过才能发布呢?</p><p>防止课程违规暴力涉黄, 影响用户体验, 课程审核起监督作用, 帮助教学机构规范使用平台的手段</p><p>如何控制课程审核通过才能发布课程?</p><p>在课程表  course_base  设置课程审核状态(未提交  已提交{未审核} 审核通过 审核不通过)</p><p>课程状态转化关系</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222200203226.png" alt="image-20231222200203226" style="zoom:67%;" /><p>说明:</p><ol><li>课程新增后审核状态是：未提交，发布状态是：未发布</li><li>课程信息编辑完成，教学机构人员执行：提交审核，此时课程审核状态：已提交</li><li>当课程状态：已提交，运营平台人员对课程进行审核</li><li>运营平台人员审核课程，结果：审核通过，审核不通过</li><li>课程审核后不管状态是通过还是不通过，教学机构可以再次修改课程并提交审核，此时课程状态：已提交，此时运营平台人员再次审核课程</li><li>课程审核通过，教学机构人员可以发布课程，发布成功后课程的发布状态：已发布</li><li>课程发布后通过操作：下架，更改课程发布状态为：下架</li><li>课程下架后通过操作：上架，再次发布课程，上架后课程发布状态：上架</li></ol><h5 id="数据模型-1"><a href="#数据模型-1" class="headerlink" title="数据模型"></a>数据模型</h5><ol><li>课程提交审核后还允许修改课程吗？</li></ol><p>如果不允许修改不合理，因为提交审核后可以继续下一个阶段的课程内容，比如添加课程计划，上传课程视频等</p><p>如果允许修改那课程审核看到的课程内容从哪里来？如果从课程基本信息表，课程营销表，课程计划表查询会有什么问题？</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222200957823.png" alt="image-20231222200957823" style="zoom:50%;" /><p>运营人员审核课程和教学机构编辑课程操作的数据是同一份，此时会导致冲突，例如：运营人员正在审核时教学机构把数据修改了。</p><p>为了解决这个问题，专门设计了<strong>课程预发布表</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222201145071.png" alt="image-20231222201145071"></p><p>提交课程审核，将课程信息汇总写入课程预发布表，课程预发布表记录了教学机构在<strong>某个时间点</strong>要发布的课程信息。</p><p>课程审核人员从预发布表查询信息进行审核。</p><p>课程审核同时可以对课程进行修改，修改的内容不会写入课程预发布表。</p><p>课程审核通过执行<strong>课程发布</strong>，将课程预发布表信息写入课程发布表。</p><ol start="2"><li>提交审核课程后，也修改了课程信息，可以再次提交审核吗？</li></ol><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222201534950.png" alt="image-20231222201534950" style="zoom:67%;" /><p>提交审核课程后，必须等到课程审核完成才能再次提交课程</p><p>课程审核功能设计教学机构提交审核，运营人员进行课程审核。这里只模拟审核结果，课程审核结果通过手动修改数据库来实现。</p><p>提交审核将信息写入<strong>课程预发布表</strong>，结构：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222201934948.png" alt="image-20231222201934948"></p><p>更新课程基本信息表的课程审核状态为：已经提交</p><p>课程审核后更新课程基本信息表的审核状态，课程预发布表的审核状态，并将审核结果写入课程审核记录</p><p>审核记录表结构：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222202110197.png" alt="image-20231222202110197"></p><h4 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 课程审核</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@PostMapping(&quot;/courseaudit/commit/&#123;courseId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commitAudit</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long courseId)</span>&#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br>    coursePublishService.commitAudit(companyId, courseId);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a>接口开发</h4><h5 id="DAO开发"><a href="#DAO开发" class="headerlink" title="DAO开发"></a>DAO开发</h5><ol><li>查询课程基本信息，课程营销信息，课程计划信息等课程相关信息，整合为课程预发布信息</li><li>向课程预发布表course_publish_pre插入一条记录，如果已经存在则更新，审核状态：已提交</li><li>更新课程基本表 course_base 课程审核状态：已提交</li></ol><p>约束:</p><ol><li>对已提交审核的课程不允许提交审核</li><li>本机构只允许提交本机构的课程</li><li>没有上传图片不允许提交审核</li><li>没有添加课程计划不允许提交审核</li></ol><p>使用代码生成器生成课程发布表的PO，mapper，拷贝到响应工程下</p><h5 id="service开发"><a href="#service开发" class="headerlink" title="service开发"></a>service开发</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//课程审核</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commitAudit</span><span class="hljs-params">(Long companyId, Long courseId)</span> &#123;<br>    <span class="hljs-comment">//约束</span><br>    <span class="hljs-type">CourseBase</span> <span class="hljs-variable">courseBase</span> <span class="hljs-operator">=</span> courseBaseMapper.selectById(courseId);<br>    <span class="hljs-comment">//审核状态</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">auditStatus</span> <span class="hljs-operator">=</span> courseBase.getAuditStatus();<br>    <span class="hljs-comment">//当前审核状态为已提交不允许再次提交</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;202003&quot;</span>.equals(auditStatus))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;当前为等待审核状态，审核完成可以再次提交&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//本机构只允许提交本机构的课程</span><br>    <span class="hljs-keyword">if</span> (!Objects.equals(courseBase.getCompanyId(), companyId))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;不允许提交其他机构的课程&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//课程图片是否添加</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(courseBase.getPic()))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;提交失败，请上传课程图片&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//添加课程预发布记录</span><br>    <span class="hljs-type">CoursePublishPre</span> <span class="hljs-variable">coursePublishPre</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePublishPre</span>();<br>    <span class="hljs-comment">//课程预发布记录 = 课程基本信息 + 营销信息 + 课程计划信息</span><br>    <span class="hljs-comment">//1.课程基本信息</span><br>    <span class="hljs-type">CourseBaseInfoDto</span> <span class="hljs-variable">courseBaseInfo</span> <span class="hljs-operator">=</span> courseBaseInfoService.getCourseBaseInfo(courseId);<br>    BeanUtils.copyProperties(courseBaseInfo, coursePublishPre);<br><br>    <span class="hljs-comment">//2.部分营销信息</span><br>    <span class="hljs-type">CourseMarket</span> <span class="hljs-variable">courseMarket</span> <span class="hljs-operator">=</span> courseMarketMapper.selectById(courseId);<br>    <span class="hljs-comment">// bean -&gt; json</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">courseMarketJson</span> <span class="hljs-operator">=</span> JSON.toJSONString(courseMarket);<br>    <span class="hljs-comment">// 将课程营销信息json数据放入课程预发布表</span><br>    coursePublishPre.setMarket(courseMarketJson);<br><br>    <span class="hljs-comment">//3.查询课程计划信息</span><br>    List&lt;TeachplanDto&gt; teachplanTree = teachplanService.findTeachplanTree(courseId);<br>    <span class="hljs-keyword">if</span> (teachplanTree.size() == <span class="hljs-number">0</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;提交失败，没有添加课程计划&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// bean -&gt; json</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">teachplanTreeJson</span> <span class="hljs-operator">=</span> JSON.toJSONString(teachplanTree);<br>    <span class="hljs-comment">// 将课程计划信息json数据放入课程预发布表</span><br>    coursePublishPre.setTeachplan(teachplanTreeJson);<br><br>    <span class="hljs-comment">//设置预发布记录状态，已提交</span><br>    coursePublishPre.setStatus(<span class="hljs-string">&quot;202003&quot;</span>);<br>    <span class="hljs-comment">//教学机构id</span><br>    coursePublishPre.setCompanyId(companyId);<br>    <span class="hljs-comment">//提交时间</span><br>    coursePublishPre.setCreateDate(LocalDateTime.now());<br>    <span class="hljs-type">CoursePublishPre</span> <span class="hljs-variable">coursePublishPreUpdate</span> <span class="hljs-operator">=</span> coursePublishPreMapper.selectById(courseId);<br>    <span class="hljs-comment">//添加课程预发布记录</span><br>    <span class="hljs-keyword">if</span> (coursePublishPreUpdate!=<span class="hljs-literal">null</span>)&#123;<br>        coursePublishPreMapper.insert(coursePublishPre);<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        coursePublishPreMapper.updateById(coursePublishPre);<br>    &#125;<br>    <span class="hljs-comment">//更新课程基本表的审核状态</span><br>    courseBase.setAuditStatus(<span class="hljs-string">&quot;202003&quot;</span>);<br>    courseBaseMapper.updateById(courseBase);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h4><p>使用前端提前课程审核：</p><ol><li>找一门信息不全的课程，测试各约束条件</li><li>正常提交后，观察数据库课程预发布表内容是否完整</li><li>测试审核后再次提交，提交后观察数据库中课程预发布表记录内容是否正确</li></ol><p>审核通过手动修改数据库：</p><ol><li>修改课程预发布表状态为审核通过202004</li><li>修改课程基本表的审核状态为审核通过202004</li></ol><h3 id="课程发布-1"><a href="#课程发布-1" class="headerlink" title="课程发布"></a>课程发布</h3><h4 id="需求分析-3"><a href="#需求分析-3" class="headerlink" title="需求分析"></a>需求分析</h4><p>教学机构审核通过后即可发布课程，课程发布后公开展示在网站供学生查看，选课，学习</p><p>在网站展示课程信息需要解决课程信息显示的性能问题，如果速度慢会影响用户体验</p><p>如何<strong>快速搜索课程</strong>?</p><p>打开课程详情页面仍然查询数据库可行吗？太慢了</p><p>为了提高网站的速度需要将课程信息进行缓存，并将课程信息加入索引库方便搜索，下面展示课程发布后课程信息流转情况：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222212746420.png" alt="image-20231222212746420" style="zoom:67%;" /><ol><li>向内容管理数据库的课程发布表存储课程发布信息，更新课程基本信息表的发布状态为已发布</li><li>向Redis存储课程缓存信息</li><li>向Elasticsearch存储课程索引信息</li><li>请求分布文件系统存储课程静态化页面（minio存html页面），实现快速浏览课程详情页面</li></ol><p>课程发布表的数据来源于课程预发布表，他们的结构基本一样，只是课程发布表中的<strong>状态</strong>是课程发布状态</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222213153997.png" alt="image-20231222213153997"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222213043022.png" alt="image-20231222213043022"></p><p>redis中的课程缓存信息是将课程发布表中的数据转json进行存储</p><p>es 中的课程索引信息是根据课程搜索需要将课程名称，课程介绍等信息进行<strong>索引存储</strong></p><p>minio 中存储了课程的静态化页面文件（html页面），查看课程详情通过文件系统去浏览课程详情页面</p><h4 id="分布式事务技术"><a href="#分布式事务技术" class="headerlink" title="分布式事务技术"></a>分布式事务技术</h4><h5 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h5><p>一次课程发布操作需要向 DB  redis es minio写4份数据， 这里存在分布式事务问题</p><blockquote><p><strong>本地事务</strong></p><p>平常我们在程序中通过spring去控制事务是利用数据库本身的事务特性实现，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，此数据库只属于该应用，所以基于本应用自己的关系型数据库的事务又称为本地事务</p><p>本地事务具有ACID特性，数据库事务在实现时将一次事务涉及的所有操作全部纳入一个不可分割的执行单元，该执行单元所有操作要么成功，要么失败，只要其中任何一个操作失败，将会导致整个事务回滚</p><p><strong>分布式事务</strong></p><p>现在需求是课程发布操作后将数据写入数据库，redis，es，minio 4个地方，这些不限制在一个数据库中，由4个分散的服务去提供，与4个服务去通信需要网络通信，而网络存在不可到达型，这种分布式系统环境下，通过与不同的服务进行网络通信去完成事务称之为 <strong>分布式事务</strong></p><p>在分布式系统中分布式事务的场景很多：</p><p>例如用户注册送积分，银行转账，创建订单减库存，这些都是分布式事务。</p><p>拿转账举例：</p><p>我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务： </p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Java<br>begin transaction； <br><span class="hljs-comment">//1.本地数据库操作：张三减少金额 </span><br><span class="hljs-comment">//2.本地数据库操作：李四增加金额 </span><br>commit transation; <br><br></code></pre></td></tr></table></figure><p>但是在分布式环境下，会变成下边这样：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino">begin transaction； <br><span class="hljs-comment">//1.本地数据库操作：张三减少金额 </span><br><span class="hljs-comment">//2.远程调用：让李四增加金额 </span><br><br>commit transation;<br></code></pre></td></tr></table></figure><p>当远程调用让李四增加金额成功了，由于网络问题远程调用并没有返回，此时本地事务提交失败就回滚了张三减少金额的操作，此时张三和李四的数据就不一致了。 </p><p>因此在分布式架构的基础上，传统数据库事务就无法使用了，张三和李四的账户不在一个数据库中甚至不在一个应 用系统里，实现转账事务需要通过远程调用，由于网络问题就会导致分布式事务问题。 </p><p>下边的场景都会产生分布式事务：</p><p>微服务架构下</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222214407627.png" alt="image-20231222214407627" style="zoom:50%;" /><p>单服务多数据库</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222214431593.png" alt="image-20231222214431593" style="zoom:50%;" /><p>多服务单数据库</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222215148988.png" alt="image-20231222215148988" style="zoom:50%;" /></blockquote><h5 id="CAP-理论"><a href="#CAP-理论" class="headerlink" title="CAP 理论"></a>CAP 理论</h5><p>控制分布式事务首先需要理解CAP理论</p><p>CAP是Consistency、Availability、Partition tolerance三个词语的缩写，分别表示一致性、可用性、分区容忍性。</p><p>使用下边的分布式系统结构 进行说明：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222215910507.png" alt="image-20231222215910507" style="zoom:50%;" /><p>客户端经过网关访问用户服务的两个节点：</p><p>一致性是指用户不管访问哪一个节点拿到的<strong>数据都是最新的</strong>，比如查询小明的信息，不能出现<strong>数据没有改变</strong>的情况两次查询结果不一样</p><p>可用性是指任何时候查询用户信息可以查询到结果，但不保证查询到最新的数据（可以用）</p><p>分区容忍性也叫分区容错型，当系统采用分布式架构时由于网络通信异常导致请求中断，消息丢失，但系统依然对外提供服务</p><p>CAP 理论强调的是分布式系统这三点不可能全部满足，由于是分布式系统就要满足分区容忍性，因为服务之间难免出现网络异常，不能因为局部网络异常导致整个系统不可用</p><p>满足P那么C和A不能同时满足</p><p>比如我们添加一个用户小明的信息，该信息先添加到结点1中，再同步到结点2中，如下图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222220637768.png" alt="image-20231222220637768" style="zoom:50%;" /><p>如果要满足C一致型， 必须等待小明信息同步完成，系统才可用，否则会出现请求到节点2时查不到数据，违反了一致性，在信息同步过程中系统是不可用的，所以满足C的同时无法满足A</p><p>如果要满足A可用性，必须时刻保证系统可用就不用等待信息同步完成，此时系统的一致型无法满足</p><p>所以在分布式系统中进行分布式事务控制，要么保证CP，要么保证AP</p><h5 id="分布式事务控制方案"><a href="#分布式事务控制方案" class="headerlink" title="分布式事务控制方案"></a>分布式事务控制方案</h5><p>学习了CAP理论应如何控制分布式事务？</p><p>在C和A做出取舍，保证一致性就不要保证可用性，保证可用性就不要保证一致，首先你确认是要CP还是AP，具体要根据应用场景进行判断  <strong>CP  or  AP</strong></p><p>CP 的场景： 满足C舍弃A，强调一致性</p><p>跨行转账：一次转账请求要等待双方银行系统都完成整个事务才算完成，只要其中一个失败另一方执行回滚操作。</p><p>开户操作：在业务系统开户同时要在运营商开户，任何一方开户失败该用户都不可使用，所以要满足CP。</p><p>AP的场景：满足A舍弃C，强调可用性</p><p>订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。</p><p>注册送积分，注册成功积分在24分到账。</p><p>支付短信通信，支付成功发短信，短信发送可以有延迟，甚至没有发送成功。</p><p>在实际应用中符合AP的场景较多，其实虽然AP舍弃C一致性，实际上最终数据还是达到了一致，也就满足了最终一致性，所以业界定义了<strong>BASE理论</strong>。</p><blockquote><p>BASE 理论</p><p>Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写</p><p>基本可用：当系统无法满足全部可用是保证核心服务可用即可，比如一个外卖系统，每到中午12点左右系统并发量很高，此时要保证下单流程涉及的服务可用，其它服务暂时不可用。</p><p>软状态：指可以存在中间状态；比如：打印自己的社保统计情况，该操作不会立即出现结果，而是提示你打印中，请在XXX时间后查收。虽然出现了中间状态，但最终状态是正确的。</p><p>最终一致性：退款操作没有及时到账，经过一定时间账户到账，舍弃强一致性，满足最终一致性</p></blockquote><p>分布式事务控制有哪些常用的技术方案？</p><ol><li>实现CP就是实现强一致性：</li></ol><p>使用Seata框架基于AT模式实现</p><p>使用Seata框架基于TCC模式实现</p><ol start="2"><li>实现AP则要保证最终数据一致性:</li></ol><p>使用消息队列通知的方式去实现，通知失败自动重试，达到最大失败次数需要人工处理；</p><p>使用任务调度的方案，启动任务调度将课程信息由数据库同步到elasticsearch、MinIO、redis中。</p><h5 id="课程发布的事务控制方案"><a href="#课程发布的事务控制方案" class="headerlink" title="课程发布的事务控制方案"></a>课程发布的事务控制方案</h5><p>学习了这么多的理论，回到课程发布，执行课程发布操作后要向数据库、redis、elasticsearch、MinIO写四份数据，这个场景用哪种方案？</p><p>满足CP？</p><p>如果要满足CP就表示课程发布操作后向数据库、redis、elasticsearch、MinIO写四份数据，只要有一份写失败其它的全部回滚。</p><p>满足AP？</p><p>课程发布操作后，先更新数据库中的课程发布状态，更新后向redis、elasticsearch、MinIO写课程信息，只要在一定时间内最终向redis、elasticsearch、MinIO写数据成功即可。</p><p>目前我们已经有了<strong>任务调度</strong>的技术积累，这里选用任务调度的方案去实现分布式事务控制，课程发布满足AP即可。</p><p>下图是具体的技术方案：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222225745586.png" alt="image-20231222225745586" style="zoom:67%;" /><ol><li>在内容管理服务的数据库添加一个<strong>消息表</strong>，消息表和课程发布表在同一个数据库</li><li>点击课程发布通过本地事务向课程发布表写入课程发布信息，同时向消息表写入课程发布的消息。通过数据库进行事务控制，只要课程发布表插入成功，则消息表也插入成功，消息表的数据就记录了某门<strong>课程发布的任务</strong></li><li>启动任务调度系统定时调度内容管理服务去定时<strong>扫描消息表的记录</strong></li><li>当扫描到课程发布的消息即开始向redis es minio<strong>同步数据</strong>的操作</li><li>同步数据的任务完成后删除消息表记录</li></ol><p>时序图如下：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222230754215.png" alt="image-20231222230754215" style="zoom: 50%;" /><p>1、执行发布操作，内容管理服务存储课程发布表的同时向消息表添加一条“课程发布任务”。这里使用本地事务保证课程发布信息保存成功，同时消息表也保存成功。</p><p>2、任务调度服务定时调度内容管理服务扫描消息表，由于课程发布操作后向消息表插入一条课程发布任务，此时扫描到一条任务。</p><p>3、拿到任务开始执行任务，分别向redis、elasticsearch及文件系统存储数据。</p><p>4、任务完成后删除消息表记录。</p><h4 id="课程发布接口"><a href="#课程发布接口" class="headerlink" title="课程发布接口"></a>课程发布接口</h4><h5 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a>接口定义</h5><p>根据课程发布的分布式事务控制方案，课程发布操作首先通过本地事务向课程发布表写入课程发布信息并向消息表插入一条消息，这里定义的课程发布接口要实现该功能。</p><p>在内容管理接口工程中定义课程发布接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 课程发布</span><br><span class="hljs-meta">@ApiOperation(&quot;课程发布&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@PostMapping(&quot;/coursepublish/&#123;courseId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">coursepublish</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br>    coursePublishService.publish(companyId, courseId);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="DAO-开发"><a href="#DAO-开发" class="headerlink" title="DAO 开发"></a>DAO 开发</h5><p>课程发布对数据库操作：</p><ol><li>向数据发布表course_publish插入一条记录， 记录来源于课程预发布表，如果存在则更新，发布状态为：已发布</li><li>更新course_base表的课程发布状态为：已发布</li><li>删除课程预发布表的对应记录</li><li>向mq_message消息表插入消息，消息类型: course_publish</li></ol><p>约束：</p><ol><li>课程审核通过方可发布</li><li>本机构只允许发布本机构的课程</li></ol><p>以上功能使用自动生成的mapper接口即可完成</p><p>1、在内容管理数据库创建mq_message消息表及消息历史消息表（历史表存储已经完成的消息）。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222232839207.png" alt="image-20231222232839207" style="zoom:50%;" /><p>消息表记录如下：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231222232921975.png" alt="image-20231222232921975"></p><p>2、生成mq_message消息表、course_publish课程发布表的po和mapper接口</p><p>稍后会开发一个通用的消息处理组件，这里先不生成代码。</p><h5 id="Service开发"><a href="#Service开发" class="headerlink" title="Service开发"></a>Service开发</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//课程发布</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publish</span><span class="hljs-params">(Long companyId, Long courseId)</span> &#123;<br>    <span class="hljs-comment">//约束校验</span><br>    <span class="hljs-comment">//查询课程预发布表</span><br>    <span class="hljs-type">CoursePublishPre</span> <span class="hljs-variable">coursePublishPre</span> <span class="hljs-operator">=</span> coursePublishPreMapper.selectById(courseId);<br>    <span class="hljs-keyword">if</span>(coursePublishPre == <span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//本机构只允许提交本机构的课程</span><br>    <span class="hljs-keyword">if</span>(!coursePublishPre.getCompanyId().equals(companyId))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;不允许提交其它机构的课程。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//课程审核状态</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">auditStatus</span> <span class="hljs-operator">=</span> coursePublishPre.getStatus();<br>    <span class="hljs-comment">//审核通过方可发布</span><br>    <span class="hljs-keyword">if</span>(!<span class="hljs-string">&quot;202004&quot;</span>.equals(auditStatus))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;操作失败，课程审核通过方可发布。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//保存课程发布信息</span><br>    saveCoursePublish(courseId);<br><br>    <span class="hljs-comment">//保存消息表</span><br>    saveCoursePublishMessage(courseId);<br><br>    <span class="hljs-comment">//删除课程预发布表对应记录</span><br>    coursePublishPreMapper.deleteById(courseId);<br>&#125;<br><br><span class="hljs-comment">//保存课程发布信息</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveCoursePublish</span><span class="hljs-params">(Long courseId)</span> &#123;<br>    <span class="hljs-comment">//整合课程发布信息</span><br>    <span class="hljs-comment">//查询课程预发布表</span><br>    <span class="hljs-type">CoursePublishPre</span> <span class="hljs-variable">coursePublishPre</span> <span class="hljs-operator">=</span> coursePublishPreMapper.selectById(courseId);<br>    <span class="hljs-keyword">if</span> (coursePublishPre==<span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;课程预发布数据为空&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePublish</span>();<br>    BeanUtils.copyProperties(coursePublishPre, coursePublish);<br>    coursePublish.setStatus(<span class="hljs-string">&quot;203002&quot;</span>);<br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublishUpdate</span> <span class="hljs-operator">=</span> coursePublishMapper.selectById(courseId);<br>    <span class="hljs-keyword">if</span> (coursePublishUpdate==<span class="hljs-literal">null</span>)&#123;<br>        coursePublishMapper.insert(coursePublish);<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        coursePublishMapper.updateById(coursePublish);<br>    &#125;<br>    <span class="hljs-comment">//更新课程基本表的发布状态</span><br>    <span class="hljs-type">CourseBase</span> <span class="hljs-variable">courseBase</span> <span class="hljs-operator">=</span> courseBaseMapper.selectById(courseId);<br>    courseBase.setStatus(<span class="hljs-string">&quot;203002&quot;</span>);<br>    courseBaseMapper.updateById(courseBase);<br><br>&#125;<br><br><span class="hljs-comment">//保存消息表</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveCoursePublishMessage</span><span class="hljs-params">(Long courseId)</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><p>httpclient测试</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs clean">Java<br>### 课程发布<br>POST &#123;&#123;content_host&#125;&#125;/content/coursepublish/<span class="hljs-number">2</span><br><br></code></pre></td></tr></table></figure><p>先测试约束条件：</p><p>1、在未提交审核时进行课程发布测试。</p><p>2、在课程未审核通过时进行发布。</p><p>正常流程测试：</p><p>1、提交审核课程</p><p>2、手动修改课程预发布表与课程基本信息的审核状态为审核通过。</p><p>3、执行课程发布</p><p>4、观察课程发布表记录是否正常，课程预发布表记录已经删除，课程基本信息表与课程发布表的发布状态为”发布“。</p><p>使用前后端联调方式测试。</p><h4 id="消息处理SDK"><a href="#消息处理SDK" class="headerlink" title="消息处理SDK"></a>消息处理SDK</h4><h5 id="消息处理模块技术方案"><a href="#消息处理模块技术方案" class="headerlink" title="消息处理模块技术方案"></a>消息处理模块技术方案</h5><p>课程发布操作执行后需要扫描消息表的记录，有关消息表处理的有哪些？</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223104855659.png" alt="image-20231223104855659"  /><p>上图中红框都是与消息处理相关的操作</p><ol><li>新增消息表</li><li>扫描消息表</li><li>更新消息表</li><li>删除消息表</li></ol><p>使用<strong>消息表</strong>这种方式实现<strong>最终事务一致性</strong>的地方除了课程发布还有其他业务场景</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223105105645.png" alt="image-20231223105105645" style="zoom:50%;" /><p>如果在每个地方都实现一套针对消息表定时扫描，处理的逻辑基本是重复的，软件的可复用性低，成本太高。</p><p>如何解决这个问题？</p><p>将消息处理相关的逻辑做成一个通用的东西，做成通用的服务还是通用的代码组件？</p><p>通用的服务是完成一个通用的独立功能，并提供独立的网络接口，比如：项目中的文件系统服务，提供文件的分布式存储服务。</p><p>代码组件也是完成一个通用的独立功能，通常提供API方式供外部系统使用，比如：fastjson Apache commons工具包等。</p><p>如果将消息处理做成一个通用的服务，该服务需要连接多个数据库，因为它要扫描微服务数据库下的消息表，并要提供与微服务通信的网络接口，单针对当前需求而言开发成本有点高</p><p>如果将消息处理做成一个SDK工具包相比通用服务不仅可以解决将消息处理通用化的需求，还可以降低成本</p><p>所以，本项目确定将对消息表相关的处理做成一个SDK组件供各微服务使用,如下图</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223105809135.png" alt="image-20231223105809135" style="zoom:50%;" /><p>下边对消息SDK的设计内容进行说明：</p><p><strong>sdk需要提供执行任务逻辑吗？</strong></p><p>拿课程发布任务举例，执行课程发布任务向redis，索引库等同步数据，其他任务的<strong>执行逻辑不同</strong>，所以执行任务在sdk中不用实现任务逻辑，只需要提供一个<strong>抽象方法</strong>由具体的执行任务方法去实现</p><p><strong>如何保证任务的幂等性？</strong></p><p>在视频处理章节介绍的视频处理的幂等性方案，这里可以采用类似方案，任务执行完成后<strong>从消息表删除</strong>，如果<strong>消息的状态是完成或不存在消息表中</strong>则不用执行</p><p><strong>如何保证任务不重复执行？</strong></p><p>采用和视频处理章节一致方案，除了保证任务的幂等性外，任务调度采用分片广播，根据分片参数去获取任务，另外阻塞调度策略为丢弃任务。</p><p>注意：这里是信息同步类任务，即使任务重复执行也没有关系，不再使用抢占任务的方式保证任务不重复执行。</p><p>另外，根据消息表记录是否存在或消息表中任务状态去保证任务的幂等性，如果一个任务由好几个小任务，比如：课程发布任务需要执行三个同步操作：存储课程到redis，存储课程到索引库，存储课程页面到文件系统。如果其中一个小任务已经完成也不应该去重复执行。这里如何设计？</p><p>将小任务作为任务的不同阶段，在消息表中设计阶段状态：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223121811000.png" alt="image-20231223121811000"></p><p>每完成一个阶段在相应的阶段状态字段打上完成标记，即使这个大任务没有完成再重新执行时，如果小阶段任务完成了也不会重复执行某个小阶段的任务</p><p>综上所述，除了消息表的增删改查功能外，消息SDK还具有如下接口功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.messagesdk.service;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> *  服务类</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 2022-09-21</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MqMessageService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;MqMessage&gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 扫描消息表记录，采用与扫描视频处理表相同的思路</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shardIndex 分片序号</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shardTotal 分片总数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> count 扫描记录数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> java.util.List 消息记录</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/21 18:55</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;MqMessage&gt; <span class="hljs-title function_">getMessageList</span><span class="hljs-params">(<span class="hljs-type">int</span> shardIndex, <span class="hljs-type">int</span> shardTotal,  String messageType,<span class="hljs-type">int</span> count)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 完成任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id 消息id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> int 更新成功：1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/21 20:49</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">completed</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 完成阶段任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id 消息id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> int 更新成功：1</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/21 20:49</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">completedStageOne</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">completedStageTwo</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">completedStageThree</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">completedStageFour</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 查询阶段状态</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> int</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/21 20:54</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getStageOne</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getStageTwo</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getStageThree</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getStageFour</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>消息SDK提供消息处理抽象类，此抽象类使用方法继承使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.messagesdk.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 消息处理抽象类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/21 19:44</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageProcessAbstract</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MqMessageService mqMessageService;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mqMessage 执行任务内容</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean true:处理成功，false处理失败</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 任务处理</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/21 19:47</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(MqMessage mqMessage)</span>;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 扫描消息表多线程执行任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shardIndex 分片序号</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shardTotal 分片总数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> messageType  消息类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> count  一次取出任务总数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeout 预估任务执行时间,到此时间如果任务还没有结束则强制结束 单位秒</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/21 20:35</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(<span class="hljs-type">int</span> shardIndex, <span class="hljs-type">int</span> shardTotal,  String messageType,<span class="hljs-type">int</span> count,<span class="hljs-type">long</span> timeout)</span> &#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//扫描消息表获取任务清单</span><br>            List&lt;MqMessage&gt; messageList = mqMessageService.getMessageList(shardIndex, shardTotal,messageType, count);<br>            <span class="hljs-comment">//任务个数</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> messageList.size();<br>            log.debug(<span class="hljs-string">&quot;取出待处理消息&quot;</span>+size+<span class="hljs-string">&quot;条&quot;</span>);<br>            <span class="hljs-keyword">if</span>(size&lt;=<span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-keyword">return</span> ;<br>            &#125;<br><br>            <span class="hljs-comment">//创建线程池</span><br>            <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">threadPool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(size);<br>            <span class="hljs-comment">//计数器</span><br>            <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(size);<br>            messageList.forEach(message -&gt; &#123;<br>                threadPool.execute(() -&gt; &#123;<br>                    log.debug(<span class="hljs-string">&quot;开始任务:&#123;&#125;&quot;</span>,message);<br>                    <span class="hljs-comment">//处理任务</span><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> execute(message);<br>                        <span class="hljs-keyword">if</span>(result)&#123;<br>                            log.debug(<span class="hljs-string">&quot;任务执行成功:&#123;&#125;)&quot;</span>,message);<br>                            <span class="hljs-comment">//更新任务状态,删除消息表记录,添加到历史表</span><br>                            <span class="hljs-type">int</span> <span class="hljs-variable">completed</span> <span class="hljs-operator">=</span> mqMessageService.completed(message.getId());<br>                            <span class="hljs-keyword">if</span> (completed&gt;<span class="hljs-number">0</span>)&#123;<br>                                log.debug(<span class="hljs-string">&quot;任务执行成功:&#123;&#125;&quot;</span>,message);<br>                            &#125;<span class="hljs-keyword">else</span>&#123;<br>                                log.debug(<span class="hljs-string">&quot;任务执行失败:&#123;&#125;&quot;</span>,message);<br>                            &#125;<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                        e.printStackTrace();<br>                        log.debug(<span class="hljs-string">&quot;任务出现异常:&#123;&#125;,任务:&#123;&#125;&quot;</span>,e.getMessage(),message);<br>                    &#125;<br>                    <span class="hljs-comment">//计数</span><br>                    countDownLatch.countDown();<br>                    log.debug(<span class="hljs-string">&quot;结束任务:&#123;&#125;&quot;</span>,message);<br><br>                &#125;);<br>            &#125;);<br><br>            <span class="hljs-comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span><br>            countDownLatch.await(timeout,TimeUnit.SECONDS);<br>            System.out.println(<span class="hljs-string">&quot;结束....&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>           e.printStackTrace();<br><br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="消息模块SDK测试"><a href="#消息模块SDK测试" class="headerlink" title="消息模块SDK测试"></a>消息模块SDK测试</h5><p>1、在内容管理数据库创建消息表和消息历史表</p><p>2、拷贝课程资料中的xuecheng-plus-message-sdk到工程目录，如下图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223133359144.png" alt="image-20231223133359144" style="zoom:50%;" /><p>3、修改test下的bootstrap.yml中的数据库连接</p><p>下边测试消息SDK的接口：</p><p>1、继承MessageProcessAbstract 抽象类编写任务执行方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.messagesdk;<br><br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.service.MessageProcessAbstract;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 消息处理测试类，继承MessageProcessAbstract</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/23 14:25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageProcessClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MessageProcessAbstract</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MqMessageService mqMessageService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(MqMessage mqMessage)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> mqMessage.getId();<br>        log.debug(<span class="hljs-string">&quot;开始执行任务:&#123;&#125;&quot;</span>,id);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">5000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>        <span class="hljs-comment">//取出阶段状态</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">stageOne</span> <span class="hljs-operator">=</span> mqMessageService.getStageOne(id);<br>        <span class="hljs-keyword">if</span>(stageOne&lt;<span class="hljs-number">1</span>)&#123;<br>            log.debug(<span class="hljs-string">&quot;开始执行第一阶段任务&quot;</span>);<br>            System.out.println();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> mqMessageService.completedStageOne(id);<br>            <span class="hljs-keyword">if</span>(i&gt;<span class="hljs-number">0</span>)&#123;<br>                log.debug(<span class="hljs-string">&quot;完成第一阶段任务&quot;</span>);<br>            &#125;<br><br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            log.debug(<span class="hljs-string">&quot;无需执行第一阶段任务&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>2.编写测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.messagesdk;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/23 14:27</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageProcessClassTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    MessageProcessClass messageProcessClass;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        System.out.println(<span class="hljs-string">&quot;开始执行-----》&quot;</span> + LocalDateTime.now());<br>        messageProcessClass.process(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">5</span>, <span class="hljs-number">30</span>);<br>        System.out.println(<span class="hljs-string">&quot;结束执行-----》&quot;</span> + LocalDateTime.now());<br>        Thread.sleep(<span class="hljs-number">9000000</span>);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p>3、准备测试数据，在消息表添加消息类型为”test”的消息</p><p>4、执行MessageProcessClassTest 类中的test()方法，观察控制台任务执行的日志信息。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223143958631.png" alt="image-20231223143958631"></p><p>mq_message表新建数据，执行程序，运行完成</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223144135450.png" alt="image-20231223144135450" style="zoom:50%;" /><p>mq_message_history</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223144251788.png" alt="image-20231223144251788" style="zoom:50%;" /><p>此时mq_message表数据没了</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223144319705.png" alt="image-20231223144319705" style="zoom:50%;" /><h5 id="集成消息SDK"><a href="#集成消息SDK" class="headerlink" title="集成消息SDK"></a>集成消息SDK</h5><h6 id="添加消息"><a href="#添加消息" class="headerlink" title="添加消息"></a>添加消息</h6><p>1、在内容管理数据库创建消息表和消息历史表</p><p>2、拷贝课程资料中的xuecheng-plus-message-sdk到工程目录，如下图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223144537156.png" alt="image-20231223144537156" style="zoom:50%;" /><ol start="3"><li>在content的service模块添加sdk依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-message-sdk<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>4、课程发布操作使用本地事务保存课程发布信息、添加消息表</p><p>回到编写课程发布时的代码(publish方法)，填充saveCoursePublishMessage(courseId)方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//课程发布</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publish</span><span class="hljs-params">(Long companyId, Long courseId)</span> &#123;<br>    <span class="hljs-comment">//约束校验</span><br>    <span class="hljs-comment">//查询课程预发布表</span><br>    <span class="hljs-type">CoursePublishPre</span> <span class="hljs-variable">coursePublishPre</span> <span class="hljs-operator">=</span> coursePublishPreMapper.selectById(courseId);<br>    <span class="hljs-keyword">if</span>(coursePublishPre == <span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//本机构只允许提交本机构的课程</span><br>    <span class="hljs-keyword">if</span>(!coursePublishPre.getCompanyId().equals(companyId))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;不允许提交其它机构的课程。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//课程审核状态</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">auditStatus</span> <span class="hljs-operator">=</span> coursePublishPre.getStatus();<br>    <span class="hljs-comment">//审核通过方可发布</span><br>    <span class="hljs-keyword">if</span>(!<span class="hljs-string">&quot;202004&quot;</span>.equals(auditStatus))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;操作失败，课程审核通过方可发布。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//保存课程发布信息</span><br>    saveCoursePublish(courseId);<br><br>    <span class="hljs-comment">//保存消息表</span><br>    saveCoursePublishMessage(courseId);<br><br>    <span class="hljs-comment">//删除课程预发布表对应记录</span><br>    coursePublishPreMapper.deleteById(courseId);<br>&#125;<br><br><span class="hljs-comment">//保存课程发布信息</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveCoursePublish</span><span class="hljs-params">(Long courseId)</span> &#123;<br>    <span class="hljs-comment">//整合课程发布信息</span><br>    <span class="hljs-comment">//查询课程预发布表</span><br>    <span class="hljs-type">CoursePublishPre</span> <span class="hljs-variable">coursePublishPre</span> <span class="hljs-operator">=</span> coursePublishPreMapper.selectById(courseId);<br>    <span class="hljs-keyword">if</span> (coursePublishPre==<span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;课程预发布数据为空&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePublish</span>();<br>    BeanUtils.copyProperties(coursePublishPre, coursePublish);<br>    coursePublish.setStatus(<span class="hljs-string">&quot;203002&quot;</span>);<br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublishUpdate</span> <span class="hljs-operator">=</span> coursePublishMapper.selectById(courseId);<br>    <span class="hljs-keyword">if</span> (coursePublishUpdate==<span class="hljs-literal">null</span>)&#123;<br>        coursePublishMapper.insert(coursePublish);<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        coursePublishMapper.updateById(coursePublish);<br>    &#125;<br>    <span class="hljs-comment">//更新课程基本表的发布状态</span><br>    <span class="hljs-type">CourseBase</span> <span class="hljs-variable">courseBase</span> <span class="hljs-operator">=</span> courseBaseMapper.selectById(courseId);<br>    courseBase.setStatus(<span class="hljs-string">&quot;203002&quot;</span>);<br>    courseBaseMapper.updateById(courseBase);<br><br>&#125;<br><br><span class="hljs-comment">//保存消息表</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveCoursePublishMessage</span><span class="hljs-params">(Long courseId)</span> &#123;<br>    <span class="hljs-type">MqMessage</span> <span class="hljs-variable">mqMessage</span> <span class="hljs-operator">=</span> mqMessageService<br>            .addMessage(<span class="hljs-string">&quot;course_publish&quot;</span>, String.valueOf(courseId), <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">if</span> (mqMessage==<span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(CommonError.UNKOWN_ERROR);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="课程发布任务处理"><a href="#课程发布任务处理" class="headerlink" title="课程发布任务处理"></a>课程发布任务处理</h6><p>0.0 在内容管理服务添加消息处理sdk的依赖即可使用它，实现sdk中的MessageProcessAbstract类，重写execte方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.service.jobhandler;<br><br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.service.MessageProcessAbstract;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;<br><span class="hljs-keyword">import</span> com.xxl.job.core.context.XxlJobHelper;<br><span class="hljs-keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/23 15:06</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoursePublishTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MessageProcessAbstract</span> &#123;<br><br>    <br>    <span class="hljs-comment">// 课程发布任务处理,如果此方法抛出异常,说明此任务执行失败</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(MqMessage mqMessage)</span> &#123;<br>        <span class="hljs-comment">// 获取消息相关的业务信息 - businessKey1 - courseId课程id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">businessKey1</span> <span class="hljs-operator">=</span> mqMessage.getBusinessKey1();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">courseId</span> <span class="hljs-operator">=</span> Long.parseLong(businessKey1);<br><br>        <span class="hljs-comment">// 课程静态化</span><br>        generateCourseHtml(mqMessage, courseId);<br><br>        <span class="hljs-comment">// 课程索引</span><br>        saveCourseIndex(mqMessage, courseId);<br><br>        <span class="hljs-comment">// 课程缓存</span><br>        saveCourseCache(mqMessage, courseId);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 向 redis 写入课程缓存</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveCourseCache</span><span class="hljs-params">(MqMessage mqMessage, <span class="hljs-type">long</span> courseId)</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-comment">// 向es课程写索引数据</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveCourseIndex</span><span class="hljs-params">(MqMessage mqMessage, <span class="hljs-type">long</span> courseId)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;开始向es课程写索引数据,课程id:&#123;&#125;&quot;</span>, courseId);<br>        <span class="hljs-comment">// 消息id</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> mqMessage.getId();<br>        <span class="hljs-comment">// 消息处理的service</span><br>        <span class="hljs-type">MqMessageService</span> <span class="hljs-variable">mqMessageService</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getMqMessageService();<br>        <span class="hljs-comment">// 消息幂等性处理  -&gt; 阶段1处理状态, 0:初始，1:成功</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">stageTwo</span> <span class="hljs-operator">=</span> mqMessageService.getStageTwo(id);<br>        <span class="hljs-keyword">if</span> (stageTwo &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// 1 成功,不处理</span><br>            log.debug(<span class="hljs-string">&quot;课程索引信息已经写入,无需执行...,课程id:&#123;&#125;&quot;</span>, courseId);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 查询课程信息,调用搜索服务添加索引...</span><br><br>        <span class="hljs-comment">// 保存第2阶段状态(完成)</span><br>        mqMessageService.completedStageTwo(id);<br>        <br>        <br>    &#125;<br><br>    <span class="hljs-comment">// 生成课程静态化页面并上传到文件系统minio</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateCourseHtml</span><span class="hljs-params">(MqMessage mqMessage, <span class="hljs-type">long</span> courseId)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;开始进行课程静态化,课程id:&#123;&#125;&quot;</span>, courseId);<br>        <span class="hljs-comment">// 消息id</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> mqMessage.getId();<br>        <span class="hljs-comment">// 消息处理的service</span><br>        <span class="hljs-type">MqMessageService</span> <span class="hljs-variable">mqMessageService</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getMqMessageService();<br>        <span class="hljs-comment">// 消息幂等性处理  -&gt; 阶段1处理状态, 0:初始，1:成功</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">stageOne</span> <span class="hljs-operator">=</span> mqMessageService.getStageOne(id);<br>        <span class="hljs-keyword">if</span> (stageOne &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// 1 成功,不处理</span><br>            log.debug(<span class="hljs-string">&quot;课程静态化已处理直接返回,课程id:&#123;&#125;&quot;</span>, courseId);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//开始进行课程静态化</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>; <span class="hljs-comment">//制造一个异常表示任务执行有问题</span><br><br>        <span class="hljs-comment">//保存第一阶段状态(完成)</span><br>        mqMessageService.completedStageOne(id);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p>0.5   content-service模块加入xxl-job依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- xxl_job 任务调度 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>1  在nacos中在content-service-dev.yaml中配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs YAML"><span class="hljs-attr">xxl:</span><br>  <span class="hljs-attr">job:</span><br>    <span class="hljs-attr">admin:</span> <br>      <span class="hljs-attr">addresses:</span> <span class="hljs-string">http://192.168.101.65:8088/xxl-job-admin</span><br>    <span class="hljs-attr">executor:</span><br>      <span class="hljs-attr">appname:</span> <span class="hljs-string">coursepublish-job</span><br>      <span class="hljs-attr">address:</span> <br>      <span class="hljs-attr">ip:</span> <br>      <span class="hljs-attr">port:</span> <span class="hljs-number">8999</span><br>      <span class="hljs-attr">logpath:</span> <span class="hljs-string">/data/applogs/xxl-job/jobhandler</span><br>      <span class="hljs-attr">logretentiondays:</span> <span class="hljs-number">30</span><br>    <span class="hljs-attr">accessToken:</span> <span class="hljs-string">default_token</span><br></code></pre></td></tr></table></figure><p>2、从媒资管理服务层工程中拷贝一个XxlJobConfig配置类到内容管理service工程中</p><p>在xxl-job-admin控制台中添加执行器</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223162502680.png" alt="image-20231223162502680"></p><p>3、编写任务调度入口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 任务调度入口</span><br><span class="hljs-meta">@XxlJob(&quot;CoursePublishJobHandler&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">coursePublishJobHandler</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 分片参数</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardIndex();<span class="hljs-comment">//执行器序号 before 0</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">shardTotal</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardTotal();<span class="hljs-comment">//执行器总数</span><br>log.debug(<span class="hljs-string">&quot;shardIndex=&quot;</span>+shardIndex+<span class="hljs-string">&quot;,shardTotal=&quot;</span>+shardTotal);<span class="hljs-comment">//参数:分片序号、分片总数、消息类型、一次最多取到的任务数量、一次任务调度执行的超时时间</span><br><br>    <span class="hljs-comment">// 调用抽象类方法执行任务 - 处理30个, 任务有问题等待60秒</span><br>    process(shardIndex, shardTotal, <span class="hljs-string">&quot;course_publish&quot;</span>, <span class="hljs-number">30</span>, <span class="hljs-number">60</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>4、在xxl-job添加任务</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223162706043.png" alt="image-20231223162706043"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223162719752.png" alt="image-20231223162719752"></p><p>5 .  数据库制造假数据</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223162749215.png" alt="image-20231223162749215"></p><p>执行到课程静态化的除以0异常时，显示日志</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223162857611.png" alt="image-20231223162857611"></p><p>到此SDK开发、集成完成，下一步添加课程发布后<strong>页面静态化、课程缓存、课程索引</strong>等任务。</p><h4 id="页面静态化"><a href="#页面静态化" class="headerlink" title="页面静态化"></a>页面静态化</h4><p>根据课程发布的操作流程，执行课程发布后要将课程详情信息页面<strong>静态化</strong>，生成html页面上传至文件系统</p><blockquote><p><strong>什么是页面静态化？</strong></p><p>课程预览功能通过模板引擎技术在页面模板中填充数据，生成html页面，这个过程是当客户端请求服务器时服务器才开始渲染生成html页面，最后响应给浏览器，服务端渲染的并发能力是有限的</p><p>页面静态化则强调将生成html页面的过程提前，提前使用模板引擎技术生成html页面，当客户端请求时直接请求html页面，由于静态页面可以使用nginx apache等高性能web服务器，并发性能高</p><p><strong>什么时候使用页面静态化技术？</strong></p><p>当数据变化不频繁，一旦生成静态页面很长时间内很少变化，此时可以使用页面静态化，因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面工作量变大</p><p>根据课程发布的业务需求，虽然课程发布后仍可以修改课程信息，但需要经过课程审核，且修改额度不大，所以适合使用页面静态化</p></blockquote><h4 id="静态化测试"><a href="#静态化测试" class="headerlink" title="静态化测试"></a>静态化测试</h4><p>使用freemarker技术对页面静态化生成html页面</p><p>在content-service模块添加freemarker依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">XML<br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>编写测试方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CoursePublishService;<br><span class="hljs-keyword">import</span> freemarker.template.Configuration;<br><span class="hljs-keyword">import</span> freemarker.template.Template;<br><span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.ui.freemarker.FreeMarkerTemplateUtils;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * freemarker测试</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/23 16:58</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FreemarkerTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    CoursePublishService coursePublishService;<br><br>    <span class="hljs-comment">//测试页面静态化</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGenerateHtmlByTemplate</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//配置freemarker</span><br>        <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(Configuration.getVersion());<br><br>        <span class="hljs-comment">//加载模板</span><br>        <span class="hljs-comment">//选指定模板路径,classpath下的templates下</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getResource(<span class="hljs-string">&quot;/&quot;</span>).getPath();<br>        configuration.setDirectoryForTemplateLoading(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(path + <span class="hljs-string">&quot;/templates/&quot;</span>));<br>        <span class="hljs-comment">//设置字符编码</span><br>        configuration.setDefaultEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br><br>        <span class="hljs-comment">//设置模板文件名称</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> configuration.getTemplate(<span class="hljs-string">&quot;course_template.ftl&quot;</span>);<br>        <span class="hljs-comment">//准备数据 from DB</span><br>        <span class="hljs-type">CoursePreviewDto</span> <span class="hljs-variable">coursePreviewInfo</span> <span class="hljs-operator">=</span> coursePublishService.getCoursePreviewInfo(<span class="hljs-number">2L</span>);<br><br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;model&quot;</span>, coursePreviewInfo); <span class="hljs-comment">// 向模板填充数据</span><br><br>        <span class="hljs-comment">//静态化</span><br>        <span class="hljs-comment">//参数1: 模板, 参数2: 数据模型</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> FreeMarkerTemplateUtils.processTemplateIntoString(template, map);<br>        System.out.println(<span class="hljs-string">&quot;静态化内容   ===============   =&gt;&quot;</span>);<br>        System.out.println(content);<br><br>        <span class="hljs-comment">//将静态化内容输出到文件中</span><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> IOUtils.toInputStream(content);<br>        <span class="hljs-comment">//输出流</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;D:\\develop\\test.html&quot;</span>);<br>        IOUtils.copy(inputStream,outputStream);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>目录结构</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223171201518.png" alt="image-20231223171201518" style="zoom:50%;" /><p>执行测试方法，观察D:\develop\test.html 是否成功生成</p><p>生成文件</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223171216094.png" alt="image-20231223171216094" style="zoom:50%;" /><h4 id="上传文件测试"><a href="#上传文件测试" class="headerlink" title="上传文件测试"></a>上传文件测试</h4><h5 id="配置远程调用环境"><a href="#配置远程调用环境" class="headerlink" title="配置远程调用环境"></a>配置远程调用环境</h5><p>静态化生成的文件需要上传至分布式文件系统，根据微服务职责划分，媒资管理服务负责维护文件系统的文件，所以内容管理服务对页面静态化生成html需要调用媒资管理服务的<strong>上传文件接口</strong>， 如图</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223171716839.png" alt="image-20231223171716839"></p><p>微服务之间难免会有远程调用，在springcloud中可以使用feign进行远程调用</p><p>Feign是一个声明式的http客户端  <a href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p><p>作用： 帮我们优雅的实现http请求的发送， 解决上面跨服务调用接口问题</p><ol><li>添加依赖（content-service）</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Feign --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- Spring Cloud 微服务远程调用 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>feign-httpclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--feign支持Multipart格式传参--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.openfeign.form<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>feign-form<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.openfeign.form<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>feign-form-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>注意上面加了这个依赖spring-cloud-starter-alibaba-nacos-discovery, 相应的要在本地bootstrapl.yml更改逻辑</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223201446995.png" alt="image-20231223201446995" style="zoom:50%;" /><p>这里我跟着视频才排出这个错</p><ol start="2"><li>nacos中配置feign-dev.yaml 公用配置文件</li></ol><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223172615572.png" alt="image-20231223172615572"></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">circuitbreaker:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">30000</span>  <span class="hljs-comment">#熔断超时时间</span><br><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">60000</span> <span class="hljs-comment">#连接超时时间</span><br>  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">60000</span> <span class="hljs-comment">#读超时时间</span><br>  <span class="hljs-attr">MaxAutoRetries:</span> <span class="hljs-number">0</span> <span class="hljs-comment">#重试次数</span><br>  <span class="hljs-attr">MaxAutoRetriesNextServer:</span> <span class="hljs-number">1</span> <span class="hljs-comment">#切换实例的重试次数</span><br></code></pre></td></tr></table></figure><ol start="3"><li>在内容管理service工程和内容管理api工程都引入此配置文件</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">shared-configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">feign-$&#123;spring.profiles.active&#125;.yaml</span><br>    <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-common</span><br>    <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><ol start="4"><li>在内容管理service工程配置feign支持Multipart，拷贝课程资料下的MultipartSupportConfig 到content-service工程下的config包下。</li></ol><h5 id="扩充上传文件接口"><a href="#扩充上传文件接口" class="headerlink" title="扩充上传文件接口"></a>扩充上传文件接口</h5><p>将课程静态文件上传到minio，单独存储到course目录，文件objectname是”课程id.html”，原来的盛传文件接口需要增加一个参数 objectname</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223185858797.png" alt="image-20231223185858797"></p><p>修改原有uploadFile方法，判断如果objectName为空则采取年月日样式的路径方式。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223190340405.png" alt="image-20231223190340405"></p><h5 id="远程调用测试"><a href="#远程调用测试" class="headerlink" title="远程调用测试"></a>远程调用测试</h5><ol><li>在content-service下编写feign接口</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 媒资管理服务远程接口</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/23 19:06</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FeignClient(value = &quot;media-api&quot;, configuration = MultipartSupportConfig.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MediaServiceClient</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/media/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span><br>    String <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(<span class="hljs-meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload,</span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(value = &quot;objectName&quot;, required = false)</span> String objectName)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>在启动类添加@EnableFeignClients注解</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(basePackages = &#123;&quot;com.xuecheng.content.feignclient&quot;&#125;)</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ContentApplication.class);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>编写feign测试方法</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.config.MultipartSupportConfig;<br><span class="hljs-keyword">import</span> com.xuecheng.content.feignclient.MediaServiceClient;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/23 19:29</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignUploadTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    MediaServiceClient mediaServiceClient;<br><br>    <span class="hljs-comment">//远程调用,上传文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">MultipartFile</span> <span class="hljs-variable">multipartFile</span> <span class="hljs-operator">=</span> MultipartSupportConfig.getMultipartFile(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;D:\\develop\\test.html&quot;</span>));<br>        mediaServiceClient.uploadFile(multipartFile,  <span class="hljs-string">&quot;course/test.html&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>上传成功</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223201536512.png" alt="image-20231223201536512" style="zoom:50%;" /><p>访问一下，查看是否可以正常访问</p><p><a href="http://192.168.101.65:9000/mediafiles/course/test.html">http://192.168.101.65:9000/mediafiles/course/test.html</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223201732623.png" alt="image-20231223201732623" style="zoom: 33%;" /><h5 id="熔断降级处理"><a href="#熔断降级处理" class="headerlink" title="熔断降级处理"></a>熔断降级处理</h5><h6 id="什么是熔断降级"><a href="#什么是熔断降级" class="headerlink" title="什么是熔断降级"></a>什么是熔断降级</h6><blockquote><p>熔断降级：</p><p>微服务难免存在服务之间的远程调用，当微服务运行不正常时导致无法正常调用微服务，此时会出现以后，如果这种异常不去处理可能会导致雪崩效应</p><p>微服务的雪崩效应表现在服务和服务之间的调用，当一个服务无法提供服务可能导致其他服务死掉，比如：服务B调用服务A，服务A异常导致B响应缓慢，最后B，C服务都不可用，这样由一个服务导致一连串多个服务无法正常运行的情况是微服务的雪崩效应</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223202126690.png" alt="image-20231223202126690" style="zoom:50%;" /><p>如何解决由于微服务异常引起的雪崩效应？</p><p>A：熔断B：降级</p><p>熔断降级相同点是为了解决微服务系统崩溃的问题，但是他们是两个不同的技术，两者由又互相联系</p><p>熔断：</p><p>当下游服务异常而断开与上游服务的交互，相当于保险丝，下游服务异常触发了熔断，从而保证上游服务不收影响</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223202401031.png" alt="image-20231223202401031" style="zoom:50%;" /><p>降级：</p><p>当下游服务异常触发熔断后，上游服务不再去调用异常的微服务而是执行了<strong>降级处理逻辑</strong>（理解成后备隐藏能源），这个降级处理逻辑可以是本地一个单独的方法</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223202518923.png" alt="image-20231223202518923" style="zoom:50%;" /><p>两者都是为了保护系统，熔断是当下游服务异常时一种保护系统的手段，降级是熔断后上游服务处理熔断的方法{<strong>和老婆离婚，和小三结婚</strong>}</p></blockquote><h6 id="熔断降级处理-1"><a href="#熔断降级处理-1" class="headerlink" title="熔断降级处理"></a>熔断降级处理</h6><p>项目使用 Hystrix 框架实现熔断，降级处理，在 feign-dev.yaml中配置</p><ol><li>开启Feign熔断保护</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">circuitbreaker:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure><ol start="2"><li>设置熔断超时时间，为了防止一次处理时间较长触发熔断这里需要设置请求和连接的超时时间</li></ol><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dts">Bash<br><span class="hljs-symbol">hystrix:</span><br><span class="hljs-symbol">  command:</span><br><span class="hljs-symbol">    default:</span><br><span class="hljs-symbol">      execution:</span><br><span class="hljs-symbol">        isolation:</span><br><span class="hljs-symbol">          thread:</span><br><span class="hljs-symbol">            timeoutInMilliseconds:</span> <span class="hljs-number">30000</span>  <span class="hljs-meta">#熔断超时时间</span><br><span class="hljs-symbol">ribbon:</span><br><span class="hljs-symbol">  ConnectTimeout:</span> <span class="hljs-number">60000</span> <span class="hljs-meta">#连接超时时间</span><br><span class="hljs-symbol">  ReadTimeout:</span> <span class="hljs-number">60000</span> <span class="hljs-meta">#读超时时间</span><br><span class="hljs-symbol">  MaxAutoRetries:</span> <span class="hljs-number">0</span> <span class="hljs-meta">#重试次数</span><br><span class="hljs-symbol">  MaxAutoRetriesNextServer:</span> <span class="hljs-number">1</span> <span class="hljs-meta">#切换实例的重试次数</span><br><br></code></pre></td></tr></table></figure><ol start="3"><li>定义熔断逻辑</li></ol><p>两种方式： </p><p>1）fallback</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@FeignClient(value = &quot;media-api&quot;,configuration = MultipartSupportConfig.class,fallback = MediaServiceClientFallback.class)</span><br><span class="hljs-meta">@RequestMapping(&quot;/media&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MediaServiceClient</span>&#123;<br>...<br><br></code></pre></td></tr></table></figure><p>定义一个fallback类MediaServiceClientFallback，此类实现了MediaServiceClient接口。</p><p>第一种方法无法取出熔断所抛出的异常，第二种方法定义MediaServiceClientFallbackFactory 可以解决这个问题</p><p>2）fallbackFactory </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;media-api&quot;, </span><br><span class="hljs-meta">        configuration = MultipartSupportConfig.class,</span><br><span class="hljs-meta">        fallbackFactory = MediaServiceClientFallbackFactory.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MediaServiceClient</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.xuecheng.content.feignclient;<br><br><span class="hljs-keyword">import</span> feign.hystrix.FallbackFactory;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/23 20:36</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaServiceClientFallbackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;MediaServiceClient&gt; &#123;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> MediaServiceClient <span class="hljs-title function_">create</span><span class="hljs-params">(Throwable throwable)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaServiceClient</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(MultipartFile upload, String objectName)</span> &#123;<br>                <span class="hljs-comment">//降级方法</span><br>                log.debug(<span class="hljs-string">&quot;调用媒资管理服务上传文件时发生熔断，异常信息:&#123;&#125;&quot;</span>,throwable.toString(),throwable);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>降级处理逻辑：</p><p>返回一个null对象，上游服务请求接口得到一个null说明执行了降级处理。</p><p>测试：</p><p>停止媒资管理服务或人为制造异常观察是否执行降级逻辑。</p><h5 id="课程静态化开发"><a href="#课程静态化开发" class="headerlink" title="课程静态化开发"></a>课程静态化开发</h5><p>课程页面静态化和静态页面远程上传测试通过，下一步开发课程静态化功能，最终使用消息处理SDK去调度执行。</p><h6 id="静态化实现"><a href="#静态化实现" class="headerlink" title="静态化实现"></a>静态化实现</h6><p>课程静态化包括两部分工作：生成课程静态化页面，上传静态页面到文件系统。</p><p>在课程发布的service编写这两部分内容，最后通过消息去调度执行</p><ol><li>接口定义</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> File <span class="hljs-title function_">generateCourseHtml</span><span class="hljs-params">(Long courseId)</span> &#123;<br>        <span class="hljs-comment">//静态化文件</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">htmlFile</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//配置freemarker</span><br>            <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(Configuration.getVersion());<br><br>            <span class="hljs-comment">//加载模板</span><br>            <span class="hljs-comment">//选指定模板路径,classpath下templates下</span><br>            <span class="hljs-comment">//得到classpath路径</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">classpath</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getResource(<span class="hljs-string">&quot;/&quot;</span>).getPath();<br>            configuration.setDirectoryForTemplateLoading(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(classpath + <span class="hljs-string">&quot;/templates/&quot;</span>));<br>            <span class="hljs-comment">//设置字符编码</span><br>            configuration.setDefaultEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br><br>            <span class="hljs-comment">//指定模板文件名称</span><br>            <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> configuration.getTemplate(<span class="hljs-string">&quot;course_template.ftl&quot;</span>);<br><br>            <span class="hljs-comment">//准备数据</span><br>            <span class="hljs-type">CoursePreviewDto</span> <span class="hljs-variable">coursePreviewInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getCoursePreviewInfo(courseId);<br><br>            Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            map.put(<span class="hljs-string">&quot;model&quot;</span>, coursePreviewInfo);<br><br>            <span class="hljs-comment">//静态化</span><br>            <span class="hljs-comment">//参数1：模板，参数2：数据模型</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> FreeMarkerTemplateUtils.processTemplateIntoString(template, map);<br><span class="hljs-comment">//            System.out.println(content);</span><br>            <span class="hljs-comment">//将静态化内容输出到文件中</span><br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> IOUtils.toInputStream(content);<br>            <span class="hljs-comment">//创建静态化文件</span><br>            htmlFile = File.createTempFile(<span class="hljs-string">&quot;course&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>);<br>            log.debug(<span class="hljs-string">&quot;课程静态化，生成静态文件:&#123;&#125;&quot;</span>,htmlFile.getAbsolutePath());<br>            <span class="hljs-comment">//输出流</span><br>            <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(htmlFile);<br>            IOUtils.copy(inputStream, outputStream);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;课程静态化异常:&#123;&#125;&quot;</span>,e.toString());<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;课程静态化异常&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> htmlFile;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadCourseHtml</span><span class="hljs-params">(Long courseId, File file)</span> &#123;<br>        <span class="hljs-type">MultipartFile</span> <span class="hljs-variable">multipartFile</span> <span class="hljs-operator">=</span> MultipartSupportConfig.getMultipartFile(file);<br>        mediaServiceClient.uploadFile(multipartFile, <span class="hljs-string">&quot;course/&quot;</span> + courseId + <span class="hljs-string">&quot;.html&quot;</span>);<br>        <span class="hljs-keyword">if</span> (courseId==<span class="hljs-literal">null</span>) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;上传静态文件异常&quot;</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>完善课程发布任务CoursePublishTask类的代码：</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 生成课程静态化页面并上传到文件系统minio</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateCourseHtml</span><span class="hljs-params">(MqMessage mqMessage, <span class="hljs-type">long</span> courseId)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;开始进行课程静态化,课程id:&#123;&#125;&quot;</span>, courseId);<br>    <span class="hljs-comment">// 消息id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> mqMessage.getId();<br>    <span class="hljs-comment">// 消息处理的service</span><br>    <span class="hljs-type">MqMessageService</span> <span class="hljs-variable">mqMessageService</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getMqMessageService();<br>    <span class="hljs-comment">// 消息幂等性处理  -&gt; 阶段1处理状态, 0:初始，1:成功</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">stageOne</span> <span class="hljs-operator">=</span> mqMessageService.getStageOne(id);<br>    <span class="hljs-keyword">if</span> (stageOne &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// 1 成功,不处理</span><br>        log.debug(<span class="hljs-string">&quot;课程静态化已处理直接返回,课程id:&#123;&#125;&quot;</span>, courseId);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//开始进行课程静态化</span><br>    <span class="hljs-comment">//1.生成静态化页面</span><br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> coursePublishService.generateCourseHtml(courseId);<br>    <span class="hljs-comment">//2.上传静态化页面</span><br>    <span class="hljs-keyword">if</span> (file!=<span class="hljs-literal">null</span>)&#123;<br>        coursePublishService.uploadCourseHtml(courseId, file);<br>    &#125;<br>    <br>    <span class="hljs-comment">//保存第一阶段状态(完成)</span><br>    mqMessageService.completedStageOne(id);<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h6><p>1、启动网关、媒资管理服务工程。</p><p>2、在内容管理api工程的启动类上配置FeignClient</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@EnableFeignClients(basePackages=&#123;<span class="hljs-string">&quot;com.xuecheng.content.feignclient&quot;</span>&#125;)</span><br></code></pre></td></tr></table></figure><p>在bootstrap.yml引用feign-dev.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">feign-$&#123;spring.profiles.active&#125;.yaml</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-common</span><br>  <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment">#profiles默认为dev</span><br><br></code></pre></td></tr></table></figure><p>启动内容管理接口工程。</p><p>在CoursePublishTask类的execute方法中打上断点</p><p>3、发布一门课程，保存消息表存在未处理的处理。</p><p>4、启动xxl-job调度中心、启动课程发布任务，等待定时调度。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223205424732.png" alt="image-20231223205424732" style="zoom:50%;" /><p>5、观察任务调度日志，观察任务是否可以正常处理。</p><p>6、处理完成进入文件系统，查询mediafiles桶内是否存在以课程id命名的html文件</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223205446338.png" alt="image-20231223205446338" style="zoom:50%;" /><p>如果不存在说明课程静态化存在问题，再仔细查看执行日志，排查问题。</p><p>如果存在则说明课程静态化并上传到minio成功。</p><h6 id="浏览详细页面"><a href="#浏览详细页面" class="headerlink" title="浏览详细页面"></a>浏览详细页面</h6><p>课程静态化成功后可以用浏览器访问html文件是否可以正常浏览，下图表示可以正常浏览。</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223205549946.png" alt="image-20231223205549946" style="zoom:50%;" /><p>页面还没有样式，需要在nginx配置虚拟目录，在<a href="http://www.51xuecheng.cn下配置：">www.51xuecheng.cn下配置：</a></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /course/ &#123;  <br>        <span class="hljs-attribute">proxy_pass</span> http://fileserver/mediafiles/course/;<br>&#125; <br><br></code></pre></td></tr></table></figure><p>加载nginx配置文件</p><p>访问：<a href="http://www.51xuecheng.cn/course/2.html">http://www.51xuecheng.cn/course/2.html</a></p><p>2.html为以课程id命名的html文件。</p><h3 id="视频搜索"><a href="#视频搜索" class="headerlink" title="视频搜索"></a>视频搜索</h3><h4 id="需求分析-4"><a href="#需求分析-4" class="headerlink" title="需求分析"></a>需求分析</h4><h5 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h5><p>搜索功能是一个系统的重要功能，是信息查询的方式。课程搜索是课程展示的渠道，用户通过课程搜索找到课程信息，进一步去查看课程的详细信息，进行选课、支付、学习。</p><p>本项目的课程搜索支持全文检索技术</p><p>什么是全文检索？</p><p><a href="https://baike.baidu.com/item/%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2/8028630?fromModule=lemma_inlink">全文检索</a>是指计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。</p><p>全文检索可以简单理解为通过<strong>索引</strong>搜索文章</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223220342249.png" alt="image-20231223220342249" style="zoom:50%;" /><p>全文检索的速度非常快，早期应用在搜索引擎技术中，比如：百度、google等，现在通常一些大型网站的搜索功能都是采用全文检索技术</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223220451365.png" alt="image-20231223220451365"></p><p>课程搜索也要将课程信息建立索引，在课程发布时建立课程索引，索引建立好用户可通过搜索网页去查询课程信息</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223220540803.png" alt="image-20231223220540803" style="zoom:50%;" /><p>所以，课程搜索模块包括两部分：课程索引、课程搜索。</p><p>课程索引是将课程信息建立索引。</p><p>课程搜索是通过前端网页，通过关键字等条件去搜索课程。</p><h5 id="业务流程-2"><a href="#业务流程-2" class="headerlink" title="业务流程"></a>业务流程</h5><p>根据模块介绍的内容，课程搜索模块包括课程索引、课程搜索两部分。</p><p>1、课程索引</p><p>在课程发布操作执行后通过<strong>消息处理</strong>方式创建课程索引，如下图</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223220635687.png" alt="image-20231223220635687"></p><p>本项目使用elasticsearch作为索引及搜索服务。</p><p>2、课程搜索</p><p>课程索引创建完成，用户才可以通过前端搜索课程信息。</p><p>课程搜索可以从首页进入搜索页面</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223220721183.png" alt="image-20231223220721183"></p><p>下图是搜索界面，可以通过课程分类、课程难度等级等条件进行搜索。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223220743738.png" alt="image-20231223220743738"></p><h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h4><h5 id="搭建elasticsearch"><a href="#搭建elasticsearch" class="headerlink" title="搭建elasticsearch"></a>搭建elasticsearch</h5><p>在课前下发的虚拟中已经在docker容器中安装了elasticsearch和kibana。</p><p>kibana 是 ELK（Elasticsearch , Logstash, Kibana ）之一，kibana 一款开源的数据分析和可视化平台，通过可视化界面访问elasticsearch的索引库，并可以生成一个数据报表。</p><p>开发中主要使用kibana通过api对elasticsearch进行索引和搜索操作</p><p>通过浏览器访问 <a href="http://192.168.101.65:5601/app/dev_tools#/console%E8%BF%9B%E5%85%A5kibana%E7%9A%84%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%95%8C%E9%9D%A2%E3%80%82">http://192.168.101.65:5601/app/dev_tools#/console进入kibana的开发工具界面。</a></p><p>修改虚拟机中的启动脚本restart.sh添加</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223221152059.png" alt="image-20231223221152059" style="zoom:50%;" /><p><a href="https://blog.csdn.net/weixin_52477733/article/details/129847700?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170334156716800227452169%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=170334156716800227452169&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-129847700-null-null.142%5Ev96%5Epc_search_result_base2&utm_term=%E8%A7%A3%E5%86%B3%E9%BB%91%E9%A9%AC%E9%A1%B9%E7%9B%AE%E3%80%8A%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E3%80%8B%E7%9A%84p106%E4%B8%AD%E7%9A%84kibana%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E5%90%AF%E5%8A%A8&spm=1018.2226.3001.4187">kibana启动失败:server is not ready yet 解决办法</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223224918738.png" alt="image-20231223224918738" style="zoom: 33%;" /><p>可通过命令：GET &#x2F;_cat&#x2F;indices?v 查看所有的索引，通过此命令判断kibana是否正常连接elasticsearch</p><p>索引相当于MySQL中的表，Elasticsearch与MySQL之间概念的对应关系见下表：</p><table><thead><tr><th>MySQL</th><th>ElasticSearch</th><th>说明</th></tr></thead><tbody><tr><td>Table</td><td>Index</td><td>索引，是文档的集合，类似数据库的表</td></tr><tr><td>Row</td><td>Document</td><td>文档，就是一条条数据，类似数据库的行，文档是JSON格式</td></tr><tr><td>Column</td><td>Field</td><td>字段，是JSON文档中的字段，类似数据库的列</td></tr><tr><td>Schema</td><td>Mapping</td><td>映射，是索引中文档的约束，例如字段类型约束，类似数据库的表结构</td></tr><tr><td>SQL</td><td>DSL</td><td>DSL是es提供的JSON风格的请求语句，用来操作es，实现CRUD</td></tr></tbody></table><p>要使用elasticsearch需要建立索引，Mapping相当于表结构，Mapping创建后其字段不能删除，如果要删除需要删除整个索引，下边介绍创建索引、查询索引、删除索引的方法：</p><p>1、创建索引，并指定Mapping</p><p>PUT &#x2F;course-publish</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;number_of_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;number_of_replicas&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;companyId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;companyName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_max_word&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;search_analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_smart&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_max_word&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;search_analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_smart&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;users&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;tags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_max_word&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;search_analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_smart&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;mt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;mtName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;st&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;stName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;grade&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;teachmode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;pic&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_max_word&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;search_analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_smart&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;createDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;format&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;date&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;remark&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;charge&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;scaled_float&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;scaling_factor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;originalPrice&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;scaled_float&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;scaling_factor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;validDays&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;integer&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br><br></code></pre></td></tr></table></figure><p>2、查询索引</p><p>通过 GET &#x2F;_cat&#x2F;indices?v 查询所有的索引，查找course-publish是否创建成功。</p><p>通过GET &#x2F;course-publish&#x2F;_mapping 查询course-publish的索引结构</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs ada">&#123;<br>  <span class="hljs-string">&quot;course-publish&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;charge&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : &quot;<span class="hljs-type">keyword</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>companyId<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>keyword<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>companyName<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>text<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>analyzer<span class="hljs-string">&quot; : &quot;</span>ik_max_word<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>search_analyzer<span class="hljs-string">&quot; : &quot;</span>ik_smart<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>createDate<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>date<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>format<span class="hljs-string">&quot; : &quot;</span>yyyy-MM-dd HH:mm:ss<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>description<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>text<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>analyzer<span class="hljs-string">&quot; : &quot;</span>ik_max_word<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>search_analyzer<span class="hljs-string">&quot; : &quot;</span>ik_smart<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>grade<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>keyword<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>id<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>keyword<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>mt<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>keyword<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>mtName<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>keyword<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>name<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>text<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>analyzer<span class="hljs-string">&quot; : &quot;</span>ik_max_word<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>search_analyzer<span class="hljs-string">&quot; : &quot;</span>ik_smart<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>originalPrice<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>scaled_float<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>scaling_factor<span class="hljs-string">&quot; : 100.0</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>pic<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>text<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>index<span class="hljs-string">&quot; : false</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>price<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>scaled_float<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>scaling_factor<span class="hljs-string">&quot; : 100.0</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>remark<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>text<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>index<span class="hljs-string">&quot; : false</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>st<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>keyword<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>stName<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>keyword<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>status<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>keyword<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>tags<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>text<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>analyzer<span class="hljs-string">&quot; : &quot;</span>ik_max_word<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>search_analyzer<span class="hljs-string">&quot; : &quot;</span>ik_smart<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>teachmode<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>keyword<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>users<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>text<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>index<span class="hljs-string">&quot; : false</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>validDays<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot; : &quot;</span>integer<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><p>3、删除索引</p><p>如果发现创建的course-publish不正确可以删除重新创建。</p><p>删除索引后当中的文档数据也同时删除，一定要谨慎操作！</p><p>删除索引命令：DELETE &#x2F;course-publish</p><h5 id="部署搜索工程"><a href="#部署搜索工程" class="headerlink" title="部署搜索工程"></a>部署搜索工程</h5><p>拷贝课程资料中的xuecheng-plus-search搜索工程到自己的工程目录</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223231154129.png" alt="image-20231223231154129" style="zoom:50%;" /><p>修改bootstrap.xml中nacos的namespace为自己的命名空间。</p><p>启动网关、搜索服务。</p><p>部署完成通过httpclient进行测试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash">Java<br><span class="hljs-comment">### 添加课程索引</span><br>POST &#123;&#123;search_host&#125;&#125;/search/index/course<br>Content-Type: application/json<br><br>&#123;<br>  <span class="hljs-string">&quot;charge&quot;</span> : <span class="hljs-string">&quot;201000&quot;</span>,<br>  <span class="hljs-string">&quot;companyId&quot;</span> : 100000,<br>  <span class="hljs-string">&quot;companyName&quot;</span> : <span class="hljs-string">&quot;北京黑马程序&quot;</span>,<br>  <span class="hljs-string">&quot;createDate&quot;</span> : <span class="hljs-string">&quot;2022-09-25 09:36:11&quot;</span>,<br>  <span class="hljs-string">&quot;description&quot;</span> : <span class="hljs-string">&quot;《Spring编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作&quot;</span>,<br>  <span class="hljs-string">&quot;grade&quot;</span> : <span class="hljs-string">&quot;204001&quot;</span>,<br>  <span class="hljs-string">&quot;id&quot;</span> : 102,<br>  <span class="hljs-string">&quot;mt&quot;</span> : <span class="hljs-string">&quot;1-3&quot;</span>,<br>  <span class="hljs-string">&quot;mtName&quot;</span> : <span class="hljs-string">&quot;编程开发&quot;</span>,<br>  <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Spring编程思想&quot;</span>,<br>  <span class="hljs-string">&quot;originalPrice&quot;</span> : 200.0,<br>  <span class="hljs-string">&quot;pic&quot;</span> : <span class="hljs-string">&quot;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&quot;</span>,<br>  <span class="hljs-string">&quot;price&quot;</span> : 100.0,<br>  <span class="hljs-string">&quot;remark&quot;</span> : <span class="hljs-string">&quot;没有备注&quot;</span>,<br>  <span class="hljs-string">&quot;st&quot;</span> : <span class="hljs-string">&quot;1-3-2&quot;</span>,<br>  <span class="hljs-string">&quot;stName&quot;</span> : <span class="hljs-string">&quot;Java语言&quot;</span>,<br>  <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;203002&quot;</span>,<br>  <span class="hljs-string">&quot;tags&quot;</span> : <span class="hljs-string">&quot;没有标签&quot;</span>,<br>  <span class="hljs-string">&quot;teachmode&quot;</span> : <span class="hljs-string">&quot;200002&quot;</span>,<br>  <span class="hljs-string">&quot;validDays&quot;</span> : 222<br>&#125;<br><br><br><br><span class="hljs-comment">### 搜索课程</span><br>GET &#123;&#123;search_host&#125;&#125;/search/course/list?pageNo=1&amp;keywords=spring<br>Content-Type: application/json<br><br><br><br></code></pre></td></tr></table></figure><p>进入前端搜索界面<a href="http://www.51xuecheng.cn/course/search.html">http://www.51xuecheng.cn/course/search.html</a></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231223231240118.png" alt="image-20231223231240118" style="zoom:50%;" /><h4 id="索引管理"><a href="#索引管理" class="headerlink" title="索引管理"></a>索引管理</h4><h5 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h5><h6 id="添加文档"><a href="#添加文档" class="headerlink" title="添加文档"></a>添加文档</h6><p>索引创建好就可以向其中添加文档，此时elasticsearch会根据索引的mapping配置对有些字段进行分词。</p><p>这里我们要向course_publish中添加课程信息。</p><p>使用rest api进行测试，如下：</p><p>使用post请求，&#x2F;course-publish&#x2F;_doc&#x2F;103 第一部分为索引名称，_doc固定，103为文档的主键id，这里为课程id。</p><p>课程内容使用json表示。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json">POST /course-publish/_doc/<span class="hljs-number">103</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;charge&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;201001&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;companyId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">100000</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;companyName&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;北京黑马程序&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;createDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2022-09-25 09:36:11&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;description&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HTML/CSS&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;grade&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;204001&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">102</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;mt&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;mtName&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;前端开发&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Html参考大全&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;originalPrice&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">200.0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;pic&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/mediafiles/2022/09/20/e726b71ba99c70e8c9d2850c2a7019d7.jpg&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">100.0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;remark&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;没有备注&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;st&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;stName&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HTML/CSS&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;status&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;203002&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;tags&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;没有标签&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;teachmode&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;200002&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;validDays&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">222</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>如果要修改文档的内容可以使用上边相同的方法，如果没有则添加，如果存在则更新（局部更新）</p><h6 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h6><p>添加文档成功后可以通过主键id查询该文档的信息。</p><p>语法如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JSON">GET /<span class="hljs-punctuation">&#123;</span>索引库名称<span class="hljs-punctuation">&#125;</span>/_doc/<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h6 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h6><p>更新文档分为全量更新和局部更新。</p><p>全量更新是指先删除再更新，语法如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JSON">PUT /<span class="hljs-punctuation">&#123;</span>索引库名<span class="hljs-punctuation">&#125;</span>/_doc/文档id<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;字段1&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;值1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;字段2&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;值2&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment">// ... 略</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>局部更新语法如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JSON">POST /<span class="hljs-punctuation">&#123;</span>索引库名<span class="hljs-punctuation">&#125;</span>/_update/文档id<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;doc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;字段名&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;新的值&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h6 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h6><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">DELETE /<span class="hljs-punctuation">&#123;</span>索引库名<span class="hljs-punctuation">&#125;</span>/_doc/id值<br></code></pre></td></tr></table></figure><h5 id="接口定义-3"><a href="#接口定义-3" class="headerlink" title="接口定义"></a>接口定义</h5><p>当课程发布时请求添加课程到索引，当课程下架时请求删除课程接口从索引中删除课程信息，这里现实现添加课程接口</p><p>根据课程索引的mapping结构创建po类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.search.po;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.annotation.JSONField;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 课程索引信息</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itcast</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseIndex</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 机构ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long companyId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 公司名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String companyName;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 课程名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 适用人群</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String users;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 标签</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String tags;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 大分类</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String mt;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 大分类名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String mtName;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 小分类</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String st;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 小分类名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String stName;<br><br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 课程等级</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String grade;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 教育模式</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String teachmode;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 课程图片</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String pic;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 课程介绍</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String description;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发布时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@JSONField(format=&quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-keyword">private</span> LocalDateTime createDate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 状态</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String status;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 备注</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String remark;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 收费规则，对应数据字典--203</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String charge;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 现价</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Float price;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 原价</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Float originalPrice;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 课程有效期天数</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer validDays;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="接口开发-2"><a href="#接口开发-2" class="headerlink" title="接口开发"></a>接口开发</h5><p>定义service接口，请求elasticsearch添加课程信息。</p><p>注意：为了适应其它文档信息，将添加文档定义为通用的添加文档接口，此接口不仅适应添加课程还适应添加其它信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.search.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.search.po.CourseIndex;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 课程索引service</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/24 22:40</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IndexService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> indexName 索引名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id 主键</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> object 索引对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Boolean true表示成功,false失败</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 添加索引</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/24 22:57</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">addCourseIndex</span><span class="hljs-params">(String indexName,String id,Object object)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>接口实现如下</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Java<br>package com.xuecheng.<span class="hljs-keyword">search</span>.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.<span class="hljs-keyword">search</span>.po.CourseIndex;<br><span class="hljs-keyword">import</span> com.xuecheng.<span class="hljs-keyword">search</span>.service.IndexService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.DocWriteResponse;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.<span class="hljs-keyword">delete</span>.DeleteRequest;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.<span class="hljs-keyword">delete</span>.DeleteResponse;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.<span class="hljs-keyword">index</span>.IndexRequest;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.<span class="hljs-keyword">index</span>.IndexResponse;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.<span class="hljs-keyword">update</span>.UpdateRequest;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.<span class="hljs-keyword">update</span>.UpdateResponse;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RequestOptions;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RestHighLevelClient;<br><span class="hljs-keyword">import</span> org.elasticsearch.common.xcontent.XContentType;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.<span class="hljs-keyword">Value</span>;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @description 课程索引管理接口实现</span><br><span class="hljs-comment"> * @author Mr.M</span><br><span class="hljs-comment"> * @date 2022/9/25 7:23</span><br><span class="hljs-comment"> * @version 1.0</span><br><span class="hljs-comment"> */</span><br>@Slf4j<br>@Service<br><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> IndexServiceImpl implements IndexService &#123;<br><br><br><br> @Autowired<br> RestHighLevelClient client;<br><br> @Override<br> <span class="hljs-built_in">public</span> <span class="hljs-type">Boolean</span> addCourseIndex(String indexName,String id,<span class="hljs-keyword">Object</span> <span class="hljs-keyword">object</span>) &#123;<br>  String jsonString = <span class="hljs-type">JSON</span>.toJSONString(<span class="hljs-keyword">object</span>);<br>  IndexRequest indexRequest = <span class="hljs-built_in">new</span> IndexRequest(indexName).id(id);<br>  //指定索引文档内容<br>  indexRequest.source(jsonString,XContentType.JSON);<br>  //索引响应对象<br>  IndexResponse indexResponse = <span class="hljs-keyword">null</span>;<br>  try &#123;<br>   indexResponse = client.<span class="hljs-keyword">index</span>(indexRequest, RequestOptions.<span class="hljs-keyword">DEFAULT</span>);<br>  &#125; catch (IOException e) &#123;<br>   <span class="hljs-keyword">log</span>.error(&quot;添加索引出错:&#123;&#125;&quot;,e.getMessage());<br>   e.printStackTrace();<br>   XueChengPlusException.cast(&quot;添加索引出错&quot;);<br>  &#125;<br>  String <span class="hljs-type">name</span> = indexResponse.getResult().name();<br>  <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(<span class="hljs-type">name</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-type">name</span>.equalsIgnoreCase(&quot;created&quot;) || <span class="hljs-type">name</span>.equalsIgnoreCase(&quot;updated&quot;);<br><br> &#125;<br><br> <br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="接口完善"><a href="#接口完善" class="headerlink" title="接口完善"></a>接口完善</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.search.controller;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.search.po.CourseIndex;<br><span class="hljs-keyword">import</span> com.xuecheng.search.service.IndexService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Value;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 课程索引接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/24 22:31</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = <span class="hljs-string">&quot;课程信息索引接口&quot;</span>, tags = <span class="hljs-string">&quot;课程信息索引接口&quot;</span>)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/index&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseIndexController</span> &#123;<br><br>    <span class="hljs-meta">@Value(<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;elasticsearch.course.index&#125;</span>&quot;</span>)</span><br>    <span class="hljs-keyword">private</span> String courseIndexStore;<br><br>    <span class="hljs-meta">@Autowired</span><br>    IndexService indexService;<br><br>    <span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;添加课程索引&quot;</span>)</span><br>    <span class="hljs-meta">@PostMapping(<span class="hljs-string">&quot;course&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">Boolean</span> add(<span class="hljs-meta">@RequestBody</span> CourseIndex courseIndex) &#123;<br>    <br>        <span class="hljs-built_in">Long</span> id = courseIndex.getId();<br>        <span class="hljs-keyword">if</span>(id==<span class="hljs-literal">null</span>)&#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;课程id为空&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">Boolean</span> result = indexService.addCourseIndex(courseIndexStore, String.valueOf(id), courseIndex);<br>        <span class="hljs-keyword">if</span>(!result)&#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;添加课程索引失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    <br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a>接口测试</h5><p>使用httpclient进行测试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">JSON<br><span class="hljs-comment">### 添加课程索引</span><br>POST &#123;&#123;search_host&#125;&#125;/search/index/course<br>Content-Type: application/json<br><br>&#123;<br>  <span class="hljs-string">&quot;charge&quot;</span> : <span class="hljs-string">&quot;201000&quot;</span>,<br>  <span class="hljs-string">&quot;companyId&quot;</span> : 100000,<br>  <span class="hljs-string">&quot;companyName&quot;</span> : <span class="hljs-string">&quot;北京黑马程序员&quot;</span>,<br>  <span class="hljs-string">&quot;createDate&quot;</span> : <span class="hljs-string">&quot;2022-09-25 09:36:11&quot;</span>,<br>  <span class="hljs-string">&quot;description&quot;</span> : <span class="hljs-string">&quot;《Java编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作&quot;</span>,<br>  <span class="hljs-string">&quot;grade&quot;</span> : <span class="hljs-string">&quot;204001&quot;</span>,<br>  <span class="hljs-string">&quot;id&quot;</span> : 102,<br>  <span class="hljs-string">&quot;mt&quot;</span> : <span class="hljs-string">&quot;1-3&quot;</span>,<br>  <span class="hljs-string">&quot;mtName&quot;</span> : <span class="hljs-string">&quot;编程开发&quot;</span>,<br>  <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;Java编程思想&quot;</span>,<br>  <span class="hljs-string">&quot;originalPrice&quot;</span> : 200.0,<br>  <span class="hljs-string">&quot;pic&quot;</span> : <span class="hljs-string">&quot;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&quot;</span>,<br>  <span class="hljs-string">&quot;price&quot;</span> : 100.0,<br>  <span class="hljs-string">&quot;remark&quot;</span> : <span class="hljs-string">&quot;没有备注&quot;</span>,<br>  <span class="hljs-string">&quot;st&quot;</span> : <span class="hljs-string">&quot;1-3-2&quot;</span>,<br>  <span class="hljs-string">&quot;stName&quot;</span> : <span class="hljs-string">&quot;Java语言&quot;</span>,<br>  <span class="hljs-string">&quot;status&quot;</span> : <span class="hljs-string">&quot;203002&quot;</span>,<br>  <span class="hljs-string">&quot;tags&quot;</span> : <span class="hljs-string">&quot;没有标签&quot;</span>,<br>  <span class="hljs-string">&quot;teachmode&quot;</span> : <span class="hljs-string">&quot;200002&quot;</span>,<br>  <span class="hljs-string">&quot;validDays&quot;</span> : 222<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h4><h5 id="需求分析-5"><a href="#需求分析-5" class="headerlink" title="需求分析"></a>需求分析</h5><p>索引信息维护完成下一步定义搜索接口搜索课程信息，首先需要搞清楚搜索功能的需求。</p><p>进入搜索界面，如下图</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224131504339.png" alt="image-20231224131504339" style="zoom:70%;" /><p>根据搜索界面可知需求如下：</p><p>1、根据一级分类、二级分类搜索课程信息。</p><p>2、根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、 课程内容。</p><p>3、根据难度等级搜索课程。</p><p>4、搜索结点分页显示。</p><p>技术点：</p><p>1、整体采用布尔查询。</p><p>2、根据关键字搜索，采用MultiMatchQuery，搜索name、description字段。</p><p>3、根据分类、课程等级搜索采用过滤器实现。</p><p>4、分页查询。</p><p>5、高亮显示。</p><p>为什么课程分类、课程等级等查询使用过滤器方式？</p><p>使用关键字查询需要计算相关度得分，根据课程分类、课程等级去查询不需要计算相关度得分，使用过滤器实现根据课程分类、课程等级查询的过程不会计算相关度得分，效率更高。</p><h5 id="接口定义-4"><a href="#接口定义-4" class="headerlink" title="接口定义"></a>接口定义</h5><p>1、定义搜索条件DTO类</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br>package com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">search</span>.<span class="hljs-property">dto</span>;<br><br><span class="hljs-keyword">import</span> lombok.<span class="hljs-property">Data</span>;<br><span class="hljs-keyword">import</span> lombok.<span class="hljs-property">ToString</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 搜索课程参数dtl</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/24 22:36</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@Data</span><br> <span class="hljs-meta">@ToString</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchCourseParamDto</span> &#123;<br><br>  <span class="hljs-comment">//关键字</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> keywords;<br><br>  <span class="hljs-comment">//大分类</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> mt;<br><br>  <span class="hljs-comment">//小分类</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> st;<br>  <span class="hljs-comment">//难度等级</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> grade;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>2、为了适应后期的扩展，定义搜索结果类，让它继承PageResult</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.search.dto;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.ToString;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/25 17:51</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchPageResultDto</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PageResult</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SearchPageResultDto</span><span class="hljs-params">(List&lt;T&gt; items, <span class="hljs-type">long</span> counts, <span class="hljs-type">long</span> page, <span class="hljs-type">long</span> pageSize)</span> &#123;<br>        <span class="hljs-built_in">super</span>(items, counts, page, pageSize);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>接口定义如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.search.controller;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageParams;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.search.dto.SearchCourseParamDto;<br><span class="hljs-keyword">import</span> com.xuecheng.search.po.CourseIndex;<br><span class="hljs-keyword">import</span> com.xuecheng.search.service.CourseSearchService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 课程搜索接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/24 22:31</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = <span class="hljs-string">&quot;课程搜索接口&quot;</span>,tags = <span class="hljs-string">&quot;课程搜索接口&quot;</span>)</span><br> <span class="hljs-meta">@RestController</span><br> <span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/course&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseSearchController</span> &#123;<br><br><br><br> <span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;课程搜索列表&quot;</span>)</span><br>  <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/list&quot;</span>)</span><br> <span class="hljs-keyword">public</span> PageResult&lt;CourseIndex&gt; list(PageParams pageParams, SearchCourseParamDto searchCourseParamDto)&#123;<br><br>    <br>   <br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="基本功能实现"><a href="#基本功能实现" class="headerlink" title="基本功能实现"></a>基本功能实现</h5><p>定义service接口，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.search.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageParams;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.search.dto.SearchCourseParamDto;<br><span class="hljs-keyword">import</span> com.xuecheng.search.dto.SearchPageResultDto;<br><span class="hljs-keyword">import</span> com.xuecheng.search.po.CourseIndex;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 课程搜索service</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/24 22:40</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CourseSearchService</span> &#123;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 搜索课程列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageParams 分页参数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> searchCourseParamDto 搜索条件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.xuecheng.base.model.PageResult&lt;com.xuecheng.search.po.CourseIndex&gt; 课程列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/24 22:45</span><br><span class="hljs-comment">    */</span><br>    SearchPageResultDto&lt;CourseIndex&gt; <span class="hljs-title function_">queryCoursePubIndex</span><span class="hljs-params">(PageParams pageParams, SearchCourseParamDto searchCourseParamDto)</span>;<br><br> &#125;<br><br></code></pre></td></tr></table></figure><h5 id="基本功能测试"><a href="#基本功能测试" class="headerlink" title="基本功能测试"></a><strong>基本功能测试</strong></h5><p>当输入查询条件时会查询全部课程信息并支持分页查询。</p><p>1、准备测试</p><p>启动nginx、网关、搜索服务。</p><p>使用kibana通过rest api向索引库添加课程信息，或通过httpclient添加课程信息，至少添加两条信息。</p><p>2、进入搜索界面</p><p>默认查询出刚才添加的课程信息。</p><p>3、修改分页参数测试分页</p><p>打开course&#x2F; search.html页面 ，找到如下图所示位置</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224131757064.png" alt="image-20231224131757064"></p><p>修改pageSize为1,即一页显示一条记录。</p><p>刷新搜索界面，每页显示一条记录，如下图：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224132427572.png" alt="image-20231224132427572" style="zoom:80%;" /><h5 id="根据条件搜索"><a href="#根据条件搜索" class="headerlink" title="根据条件搜索"></a><strong>根据条件搜索</strong></h5><p>下边实现根据关键、一级分类、二级分类、难度等级搜索。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="hljs-title function_">queryCoursePubIndex</span><span class="hljs-params">(PageParams pageParams, SearchCourseParamDto courseSearchParam)</span> &#123;<br><br>    <span class="hljs-comment">//设置索引</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(courseIndexStore);<br><br>    <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>    <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">boolQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery();<br>    <span class="hljs-comment">//source源字段过虑</span><br>    String[] sourceFieldsArray = sourceFields.split(<span class="hljs-string">&quot;,&quot;</span>);<br>    searchSourceBuilder.fetchSource(sourceFieldsArray, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;&#125;);<br>    <span class="hljs-keyword">if</span>(courseSearchParam==<span class="hljs-literal">null</span>)&#123;<br>        courseSearchParam = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchCourseParamDto</span>();<br>    &#125;<br>    <span class="hljs-comment">//关键字</span><br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getKeywords()))&#123;<br>        <span class="hljs-comment">//匹配关键字</span><br>        <span class="hljs-type">MultiMatchQueryBuilder</span> <span class="hljs-variable">multiMatchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.multiMatchQuery(courseSearchParam.getKeywords(), <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>);<br>        <span class="hljs-comment">//设置匹配占比</span><br>        multiMatchQueryBuilder.minimumShouldMatch(<span class="hljs-string">&quot;70%&quot;</span>);<br>        <span class="hljs-comment">//提升另个字段的Boost值</span><br>        multiMatchQueryBuilder.field(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-number">10</span>);<br>        boolQueryBuilder.must(multiMatchQueryBuilder);<br>    &#125;<br>    <span class="hljs-comment">//过虑</span><br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;<br>        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;mtName&quot;</span>,courseSearchParam.getMt()));<br>    &#125;<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;<br>        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;stName&quot;</span>,courseSearchParam.getSt()));<br>    &#125;<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;<br>        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;grade&quot;</span>,courseSearchParam.getGrade()));<br>    &#125;<br>    <span class="hljs-comment">//分页</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">pageNo</span> <span class="hljs-operator">=</span> pageParams.getPageNo();<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> pageParams.getPageSize();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) ((pageNo-<span class="hljs-number">1</span>)*pageSize);<br>    searchSourceBuilder.from(start);<br>    searchSourceBuilder.size(Math.toIntExact(pageSize));<br>    <span class="hljs-comment">//布尔查询</span><br>    searchSourceBuilder.query(boolQueryBuilder);<br>    <br>    <span class="hljs-comment">//请求搜索</span><br>    searchRequest.source(searchSourceBuilder);<br>   <br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>        log.error(<span class="hljs-string">&quot;课程搜索异常：&#123;&#125;&quot;</span>,e.getMessage());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchPageResultDto</span>&lt;CourseIndex&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(),<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//结果集处理</span><br>    <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br>    SearchHit[] searchHits = hits.getHits();<br>    <span class="hljs-comment">//记录总数</span><br>    <span class="hljs-type">TotalHits</span> <span class="hljs-variable">totalHits</span> <span class="hljs-operator">=</span> hits.getTotalHits();<br>    <span class="hljs-comment">//数据列表</span><br>    List&lt;CourseIndex&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sourceAsString</span> <span class="hljs-operator">=</span> hit.getSourceAsString();<br>        <span class="hljs-type">CourseIndex</span> <span class="hljs-variable">courseIndex</span> <span class="hljs-operator">=</span> JSON.parseObject(sourceAsString, CourseIndex.class);<br><br>        <br>        list.add(courseIndex);<br><br>    &#125;<br>    SearchPageResultDto&lt;CourseIndex&gt; pageResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchPageResultDto</span>&lt;&gt;(list, totalHits.value,pageNo,pageSize);<br><br>    <br><br>    <span class="hljs-keyword">return</span> pageResult;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="条件搜索测试"><a href="#条件搜索测试" class="headerlink" title="条件搜索测试"></a><strong>条件搜索测试</strong></h5><p>进入搜索界面，输入关键字进行测试。</p><p>一级分类、二级分类在下边的聚合搜索中测试。</p><h5 id="聚合搜索"><a href="#聚合搜索" class="headerlink" title="聚合搜索"></a><strong>聚合搜索</strong></h5><p>搜索界面上显示的一级分类、二级分类来源于搜索结果，使用聚合搜索实现找到搜索结果中的一级分类、二级分类。</p><p>1、首先在搜索结构DTO中添加一级分类、二级分类列表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.search.dto;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.ToString;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/25 17:51</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchPageResultDto</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PageResult</span> &#123;<br><br>    <span class="hljs-comment">//大分类列表</span><br>    List&lt;String&gt; mtList;<br>    <span class="hljs-comment">//小分类列表</span><br>    List&lt;String&gt; stList;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SearchPageResultDto</span><span class="hljs-params">(List&lt;T&gt; items, <span class="hljs-type">long</span> counts, <span class="hljs-type">long</span> page, <span class="hljs-type">long</span> pageSize)</span> &#123;<br>        <span class="hljs-built_in">super</span>(items, counts, page, pageSize);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>2、搜索方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="hljs-title function_">queryCoursePubIndex</span><span class="hljs-params">(PageParams pageParams, SearchCourseParamDto courseSearchParam)</span> &#123;<br><br>    <span class="hljs-comment">//设置索引</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(courseIndexStore);<br><br>    <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>    <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">boolQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery();<br>    <span class="hljs-comment">//source源字段过虑</span><br>    String[] sourceFieldsArray = sourceFields.split(<span class="hljs-string">&quot;,&quot;</span>);<br>    searchSourceBuilder.fetchSource(sourceFieldsArray, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;&#125;);<br>    <span class="hljs-keyword">if</span>(courseSearchParam==<span class="hljs-literal">null</span>)&#123;<br>        courseSearchParam = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchCourseParamDto</span>();<br>    &#125;<br>    <span class="hljs-comment">//关键字</span><br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getKeywords()))&#123;<br>        <span class="hljs-comment">//匹配关键字</span><br>        <span class="hljs-type">MultiMatchQueryBuilder</span> <span class="hljs-variable">multiMatchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.multiMatchQuery(courseSearchParam.getKeywords(), <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>);<br>        <span class="hljs-comment">//设置匹配占比</span><br>        multiMatchQueryBuilder.minimumShouldMatch(<span class="hljs-string">&quot;70%&quot;</span>);<br>        <span class="hljs-comment">//提升另个字段的Boost值</span><br>        multiMatchQueryBuilder.field(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-number">10</span>);<br>        boolQueryBuilder.must(multiMatchQueryBuilder);<br>    &#125;<br>    <span class="hljs-comment">//过虑</span><br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;<br>        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;mtName&quot;</span>,courseSearchParam.getMt()));<br>    &#125;<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;<br>        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;stName&quot;</span>,courseSearchParam.getSt()));<br>    &#125;<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;<br>        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;grade&quot;</span>,courseSearchParam.getGrade()));<br>    &#125;<br>    <span class="hljs-comment">//分页</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">pageNo</span> <span class="hljs-operator">=</span> pageParams.getPageNo();<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> pageParams.getPageSize();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) ((pageNo-<span class="hljs-number">1</span>)*pageSize);<br>    searchSourceBuilder.from(start);<br>    searchSourceBuilder.size(Math.toIntExact(pageSize));<br>    <span class="hljs-comment">//布尔查询</span><br>    searchSourceBuilder.query(boolQueryBuilder);<br>   <br>   <br>    <span class="hljs-comment">//请求搜索</span><br>    searchRequest.source(searchSourceBuilder);<br>    <span class="hljs-comment">//聚合设置</span><br>    buildAggregation(searchRequest);<br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>        log.error(<span class="hljs-string">&quot;课程搜索异常：&#123;&#125;&quot;</span>,e.getMessage());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchPageResultDto</span>&lt;CourseIndex&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(),<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//结果集处理</span><br>    <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br>    SearchHit[] searchHits = hits.getHits();<br>    <span class="hljs-comment">//记录总数</span><br>    <span class="hljs-type">TotalHits</span> <span class="hljs-variable">totalHits</span> <span class="hljs-operator">=</span> hits.getTotalHits();<br>    <span class="hljs-comment">//数据列表</span><br>    List&lt;CourseIndex&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sourceAsString</span> <span class="hljs-operator">=</span> hit.getSourceAsString();<br>        <span class="hljs-type">CourseIndex</span> <span class="hljs-variable">courseIndex</span> <span class="hljs-operator">=</span> JSON.parseObject(sourceAsString, CourseIndex.class);<br><br>        <br><br>        list.add(courseIndex);<br><br>    &#125;<br>    SearchPageResultDto&lt;CourseIndex&gt; pageResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchPageResultDto</span>&lt;&gt;(list, totalHits.value,pageNo,pageSize);<br><br>    <span class="hljs-comment">//获取聚合结果</span><br>    List&lt;String&gt; mtList= getAggregation(searchResponse.getAggregations(), <span class="hljs-string">&quot;mtAgg&quot;</span>);<br>    List&lt;String&gt; stList = getAggregation(searchResponse.getAggregations(), <span class="hljs-string">&quot;stAgg&quot;</span>);<br><br>    pageResult.setMtList(mtList);<br>    pageResult.setStList(stList);<br><br>    <span class="hljs-keyword">return</span> pageResult;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="聚合搜索测试"><a href="#聚合搜索测试" class="headerlink" title="聚合搜索测试"></a><strong>聚合搜索测试</strong></h5><p>进入搜索界面，观察搜索请求的响应内容中是否存在mtList和stList.</p><p>观察页面一级分类、二级分类是否有分类信息。</p><p>注意：当选中一个一级分类时才会显示二级分类。</p><h5 id="高亮设置"><a href="#高亮设置" class="headerlink" title="高亮设置"></a><strong>高亮设置</strong></h5><p>最后实现关键词在课程名称中高亮显示。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="hljs-title function_">queryCoursePubIndex</span><span class="hljs-params">(PageParams pageParams, SearchCourseParamDto courseSearchParam)</span> &#123;<br><br>    <span class="hljs-comment">//设置索引</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(courseIndexStore);<br><br>    <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>    <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">boolQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery();<br>    <span class="hljs-comment">//source源字段过虑</span><br>    String[] sourceFieldsArray = sourceFields.split(<span class="hljs-string">&quot;,&quot;</span>);<br>    searchSourceBuilder.fetchSource(sourceFieldsArray, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;&#125;);<br>    <span class="hljs-keyword">if</span>(courseSearchParam==<span class="hljs-literal">null</span>)&#123;<br>        courseSearchParam = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchCourseParamDto</span>();<br>    &#125;<br>    <span class="hljs-comment">//关键字</span><br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getKeywords()))&#123;<br>        <span class="hljs-comment">//匹配关键字</span><br>        <span class="hljs-type">MultiMatchQueryBuilder</span> <span class="hljs-variable">multiMatchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.multiMatchQuery(courseSearchParam.getKeywords(), <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>);<br>        <span class="hljs-comment">//设置匹配占比</span><br>        multiMatchQueryBuilder.minimumShouldMatch(<span class="hljs-string">&quot;70%&quot;</span>);<br>        <span class="hljs-comment">//提升另个字段的Boost值</span><br>        multiMatchQueryBuilder.field(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-number">10</span>);<br>        boolQueryBuilder.must(multiMatchQueryBuilder);<br>    &#125;<br>    <span class="hljs-comment">//过虑</span><br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;<br>        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;mtName&quot;</span>,courseSearchParam.getMt()));<br>    &#125;<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;<br>        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;stName&quot;</span>,courseSearchParam.getSt()));<br>    &#125;<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;<br>        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;grade&quot;</span>,courseSearchParam.getGrade()));<br>    &#125;<br>    <span class="hljs-comment">//分页</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">pageNo</span> <span class="hljs-operator">=</span> pageParams.getPageNo();<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> pageParams.getPageSize();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) ((pageNo-<span class="hljs-number">1</span>)*pageSize);<br>    searchSourceBuilder.from(start);<br>    searchSourceBuilder.size(Math.toIntExact(pageSize));<br>    <span class="hljs-comment">//布尔查询</span><br>    searchSourceBuilder.query(boolQueryBuilder);<br>    <span class="hljs-comment">//高亮设置</span><br>    <span class="hljs-type">HighlightBuilder</span> <span class="hljs-variable">highlightBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightBuilder</span>();<br>    highlightBuilder.preTags(<span class="hljs-string">&quot;&lt;font class=&#x27;eslight&#x27;&gt;&quot;</span>);<br>    highlightBuilder.postTags(<span class="hljs-string">&quot;&lt;/font&gt;&quot;</span>);<br>    <span class="hljs-comment">//设置高亮字段</span><br>    highlightBuilder.fields().add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightBuilder</span>.Field(<span class="hljs-string">&quot;name&quot;</span>));<br>    searchSourceBuilder.highlighter(highlightBuilder);<br>    <span class="hljs-comment">//请求搜索</span><br>    searchRequest.source(searchSourceBuilder);<br>    <span class="hljs-comment">//聚合设置</span><br>    buildAggregation(searchRequest);<br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>        log.error(<span class="hljs-string">&quot;课程搜索异常：&#123;&#125;&quot;</span>,e.getMessage());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchPageResultDto</span>&lt;CourseIndex&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(),<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//结果集处理</span><br>    <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br>    SearchHit[] searchHits = hits.getHits();<br>    <span class="hljs-comment">//记录总数</span><br>    <span class="hljs-type">TotalHits</span> <span class="hljs-variable">totalHits</span> <span class="hljs-operator">=</span> hits.getTotalHits();<br>    <span class="hljs-comment">//数据列表</span><br>    List&lt;CourseIndex&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sourceAsString</span> <span class="hljs-operator">=</span> hit.getSourceAsString();<br>        <span class="hljs-type">CourseIndex</span> <span class="hljs-variable">courseIndex</span> <span class="hljs-operator">=</span> JSON.parseObject(sourceAsString, CourseIndex.class);<br><br>        <span class="hljs-comment">//取出source</span><br>        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();<br><br>        <span class="hljs-comment">//课程id</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> courseIndex.getId();<br>        <span class="hljs-comment">//取出名称</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> courseIndex.getName();<br>        <span class="hljs-comment">//取出高亮字段内容</span><br>        Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();<br>        <span class="hljs-keyword">if</span>(highlightFields!=<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-type">HighlightField</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> highlightFields.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-keyword">if</span>(nameField!=<span class="hljs-literal">null</span>)&#123;<br>                Text[] fragments = nameField.getFragments();<br>                <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">stringBuffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>                <span class="hljs-keyword">for</span> (Text str : fragments) &#123;<br>                    stringBuffer.append(str.string());<br>                &#125;<br>                name = stringBuffer.toString();<br><br>            &#125;<br>        &#125;<br>        courseIndex.setId(id);<br>        courseIndex.setName(name);<br><br>        list.add(courseIndex);<br><br>    &#125;<br>    SearchPageResultDto&lt;CourseIndex&gt; pageResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchPageResultDto</span>&lt;&gt;(list, totalHits.value,pageNo,pageSize);<br><br>    <span class="hljs-comment">//获取聚合结果</span><br>    List&lt;String&gt; mtList= getAggregation(searchResponse.getAggregations(), <span class="hljs-string">&quot;mtAgg&quot;</span>);<br>    List&lt;String&gt; stList = getAggregation(searchResponse.getAggregations(), <span class="hljs-string">&quot;stAgg&quot;</span>);<br><br>    pageResult.setMtList(mtList);<br>    pageResult.setStList(stList);<br><br>    <span class="hljs-keyword">return</span> pageResult;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="高亮设置测试"><a href="#高亮设置测试" class="headerlink" title="高亮设置测试"></a><strong>高亮设置测试</strong></h5><p>输入关键字，观察搜索结果，标题中是否对关键字信息进行高亮显示。</p><h4 id="课程信息索引同步"><a href="#课程信息索引同步" class="headerlink" title="课程信息索引同步"></a><strong>课程信息索引同步</strong></h4><h5 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a><strong>技术方案</strong></h5><p>通过向索引中添加课程信息最终实现了课程的搜索，我们发现课程信息是先保存在关系数据库中，而后再写入索引，这个过程是将关系数据中的数据同步到elasticsearch索引中的过程，可以简单成为索引同步。</p><p>通常项目中使用elasticsearch需要完成索引同步，索引同步的方法很多：</p><p>1、针对实时性非常高的场景需要满足数据的及时同步，可以同步调用，或使用Canal去实现。</p><p>1）同步调用即在向MySQL写数据后远程调用搜索服务的接口写入索引，此方法简单但是耦合代码太高。</p><p>2）可以使用一个中间的软件canal解决耦合性的问题，但存在学习与维护成本。</p><p>canal主要用途是基于 MySQL 数据库增量日志解析，并能提供增量数据订阅和消费，实现将MySQL的数据同步到消息队列、Elasticsearch、其它数据库等，应用场景十分丰富。 </p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224133743094.png" alt="image-20231224133743094" style="zoom:75%;" /><p>它的地址：</p><p>github地址：<a href="https://github.com/alibaba/canal">https://github.com/alibaba/canal</a> </p><p>版本下载地址：<a href="https://github.com/alibaba/canal/releases">https://github.com/alibaba/canal/releases</a></p><p>文档地址：<a href="https://github.com/alibaba/canal/wiki/Docker-QuickStart">https://github.com/alibaba/canal/wiki/Docker-QuickStart</a></p><p>Canal基于mysql的binlog技术实现数据同步，什么是binlog，它是一个文件，二进制格式，记录了对数据库更新的SQL语句，向数据库写数据的同时向binlog文件里记录对应的sql语句。当数据库服务器发生了故障就可以使用binlog文件对数据库进行恢复。</p><p>所以，使用canal是需要开启mysql的binlog写入功能，Canal工作原理如下：</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224133815260.png" alt="image-20231224133815260" style="zoom:67%;" /><p>1、canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送dump </p><p>协议 </p><p>2、MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal ) </p><p>3、canal 解析 binary log 对象(原始为 byte 流)</p><p>详细使用Canal进行索引同步的步骤参考：Canal实现索引同步.pdf</p><p>2、当索引同步的实时性要求不高时可用的技术比较多，比如：MQ、Logstash、任务调度等。</p><p>MQ：向mysql写数据的时候向mq写入消息，搜索服务监听MQ，收到消息后写入索引。使用MQ的优势是代码解耦，但是需要处理消息可靠性的问题有一定的技术成本，做到消息可靠性需要做到生产者投递成功、消息持久化以及消费者消费成功三个方面，另外还要做好消息幂等性问题。</p><p>Logstash： 开源实时日志分析平台 ELK包括Elasticsearch、Kibana、Logstash，Logstash负责收集、解析和转换日志信息，可以实现MySQL与Elasticsearch之间的数据同步。也可以实现解耦合并且是官方推荐，但需要增加学习与维护成本。</p><p>任务调度：向mysql写数据的时候记录修改记录，开启一个定时任务根据修改记录将数据同步到Elasticsearch。</p><p>根据本项目的需求，课程发布后信息同步的实时性要求不高，从提交审核到发布成功一般两个工作日完成。综合比较以上技术方案本项目的索引同步技术使用任务调度的方法。</p><p>如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224133839643.png" alt="image-20231224133839643"></p><p>1、课程发布向消息表插入记录。</p><p>2、由任务调度程序通过消息处理SDK对消息记录进行处理。</p><p>3、向elasticsearch索引中保存课程信息。</p><p>如何向向elasticsearch索引中保存课程信息？</p><p>执行流程如下：</p><p>由内容管理服务远程调用搜索服务添加课程信息索引，搜索服务再请求elasticsearch向课程索引中添加文档。</p><h5 id="课程索引任务开发"><a href="#课程索引任务开发" class="headerlink" title="课程索引任务开发"></a><strong>课程索引任务开发</strong></h5><p>1、拷贝CourseIndex 模型类到内容管理model 工程的dto包下。</p><p>2、在内容管理服务中添加FeignClient</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">package</span> com.xuecheng.content.feignclient;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CourseIndex;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RequestBody;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 搜索服务远程接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/24 13:41</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FeignClient(value = <span class="hljs-string">&quot;search&quot;</span>,fallbackFactory = SearchServiceClientFallbackFactory.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SearchServiceClient</span> &#123;<br>    <span class="hljs-meta">@PostMapping(<span class="hljs-string">&quot;/search/index/course&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">Boolean</span> add(<span class="hljs-meta">@RequestBody</span> CourseIndex courseIndex);<br><br>&#125;<br></code></pre></td></tr></table></figure><p>定义SearchServiceClientFallbackFactory ：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> com.xuecheng.content.feignclient;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @author 付广建 2023/12/24 13:42</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CourseIndex;<br><span class="hljs-keyword">import</span> feign.hystrix.FallbackFactory;<br><span class="hljs-keyword">import</span> lombok.<span class="hljs-keyword">extern</span>.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">SearchServiceClientFallbackFactory</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">FallbackFactory</span></span>&lt;<span class="hljs-title">SearchServiceClient</span>&gt; </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> SearchServiceClient create(Throwable throwable) &#123;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">SearchServiceClient</span>() &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Boolean add(CourseIndex courseIndex) &#123;<br>                throwable.printStackTrace();<br>                log.debug(<span class="hljs-string">&quot;调用搜索发生熔断走降级方法,熔断异常:&quot;</span>, throwable.getMessage());<br><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>3、编写课程索引任务执行方法</p><p>完善CoursePublishTask类中的saveCourseIndex方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 向es课程写索引数据</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveCourseIndex</span><span class="hljs-params">(MqMessage mqMessage, <span class="hljs-type">long</span> courseId)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;开始向es课程写索引数据,课程id:&#123;&#125;&quot;</span>, courseId);<br>    <span class="hljs-comment">// 消息id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> mqMessage.getId();<br>    <span class="hljs-comment">// 消息处理的service</span><br>    <span class="hljs-type">MqMessageService</span> <span class="hljs-variable">mqMessageService</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getMqMessageService();<br>    <span class="hljs-comment">// 消息幂等性处理  -&gt; 阶段1处理状态, 0:初始，1:成功</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">stageTwo</span> <span class="hljs-operator">=</span> mqMessageService.getStageTwo(id);<br>    <span class="hljs-keyword">if</span> (stageTwo &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// 1 成功,不处理</span><br>        log.debug(<span class="hljs-string">&quot;课程索引信息已经写入,无需执行...,课程id:&#123;&#125;&quot;</span>, courseId);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// 查询课程信息,调用搜索服务添加索引...</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> saveCourseIndex(courseId);<br><br>    <span class="hljs-comment">// 保存第2阶段状态(完成)</span><br>    mqMessageService.completedStageTwo(id);<br>&#125;<br><br><span class="hljs-keyword">private</span> Boolean <span class="hljs-title function_">saveCourseIndex</span><span class="hljs-params">(Long courseId)</span> &#123;<br>    <span class="hljs-comment">//取出课程发布信息</span><br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> coursePublishMapper.selectById(courseId);<br>    <span class="hljs-comment">//拷贝至课程索引对象</span><br>    <span class="hljs-type">CourseIndex</span> <span class="hljs-variable">courseIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseIndex</span>();<br>    BeanUtils.copyProperties(coursePublish, courseIndex);<br>    <span class="hljs-comment">//远程调用搜索服务api添加搜索信息到索引</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">add</span> <span class="hljs-operator">=</span> searchServiceClient.add(courseIndex);<br>    <span class="hljs-keyword">if</span> (!add)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;添加索引失败&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> add;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a><strong>测试</strong></h5><p>测试流程如下：</p><p>1、启动elasticsearch、kibana。</p><p>2、启动网关、内容管理、搜索服务、nginx。</p><p>3、启动xxl-job调度中心。</p><p>4、在任务调度中心开始课程发布任务。</p><p>5、发布一门课程，页面提示操作成功，查看发布课程任务是否写到任务表。</p><p>6、经过任务调度将课程信息写入索引。</p><p>7、通过门户进入搜索页面，查看课程信息是否展示</p>]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
    <tags>
      
      <tag>学成在线</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学成在线媒资管理模块</title>
    <link href="/2023/12/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/"/>
    <url>/2023/12/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="媒资管理模块"><a href="#媒资管理模块" class="headerlink" title="媒资管理模块"></a>媒资管理模块</h2><h3 id="模块需求分析"><a href="#模块需求分析" class="headerlink" title="模块需求分析"></a>模块需求分析</h3><p>每个教学机构在媒资系统管理自己的教学资源, 包括视频,图片,文档等文件; 包括媒资文件的查询, 文件上传, 视频处理等</p><p>媒资查询：教学机构查询自己所拥有的媒资信息。</p><p>文件上传：包括上传图片、上传文档、上传视频。</p><p>视频处理：视频上传成功，系统自动对视频进行编码处理。</p><p>文件删除：教学机构删除自己上传的媒资文件。</p><p>媒资管理整体流程:</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215110626923.png" alt="image-20231215110626923"></p><h3 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h3><p>上传图片</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111304183.png" alt="image-20231215111304183"></p><p>上传视频</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111317043.png" alt="image-20231215111317043"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111324980.png" alt="image-20231215111324980"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111337503.png" alt="image-20231215111337503"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111734104.png" alt="image-20231215111734104"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111814289.png" alt="image-20231215111814289"></p><p>处理视频</p><p>对需要转码的视频系统自动对其处理, 处理后生成视频的URL, 处理视频没有界面, 后台自动执行</p><p>审核媒资</p><p>通过鉴黄接口<code>自动审核</code>视频, 对有异议的视频进行<code>人工审核</code></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112017556.png" alt="image-20231215112017556"></p><p>点击预览视频, 可以预览, 若是视频可以播放</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112146890.png" alt="image-20231215112146890"></p><p>点击审核, 完成媒资审核过程</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112213461.png" alt="image-20231215112213461"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112223642.png" alt="image-20231215112223642"></p><p>绑定媒资</p><p>课程计划创建完成后绑定媒资, 如果课程计划绑定了视频, 进入课程在线学习界面播放视频</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112440191.png" alt="image-20231215112440191"></p><p>如何将课程计划绑定媒资?</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112900190.png" alt="image-20231215112900190"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112915290.png" alt="image-20231215112915290"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112924360.png" alt="image-20231215112924360"></p><p>关联后</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112946150.png" alt="image-20231215112946150"></p><h3 id="搭建模块环境"><a href="#搭建模块环境" class="headerlink" title="搭建模块环境"></a>搭建模块环境</h3><p>目前有3个微服务: 内容管理, 系统管理, 媒资管理</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113114569.png" alt="image-20231215113114569"></p><p>后期会有更多微服务, 这种由前端直接请求微服务的方式有弊端, 如果前端对每个请求地址都配置绝对路径, 不利于系统维护<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113229701.png" alt="image-20231215113229701"></p><p>系统上线后需要改公网域名, 这种地址非常多则非常麻烦, 采用<code>网关</code>来解决</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113326453.png"></p><p>在前端代码只需要指定每个接口的相对路径即可</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113402863.png" alt="image-20231215113402863"></p><p>在前端一个固定的地方在接口地址前统一加网关地址, 每个请求统一到网关, 由网关将请求转发到具体的微服务</p><p>为什么所有请求先到网关? 有了网关可以对请求进行路由, 路由到具体的微服务, 减少外界对微服务的成本, 比如: 400电话, 根据请求路径进行路由, 根据host地址进行路由等</p><p>当多个微服务实例可以通过<code>负载均衡</code>算法进行路由</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113810903.png" alt="image-20231215113810903"></p><p>另外, 网关还可以实现权限控制, 限流等功能</p><p>项目用 Spring Cloud Gateway 作为网关, 网关在请求路由需要知道每个微服务实例的地址, 项目使用Nacos作为服务发现中心和配置中心, 整体架构图:  </p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113946841.png" alt="image-20231215113946841"></p><p>流程: </p><ol><li>微服务启动, 将自己注册到Nacos, Nacos记录各微服务实例地址</li><li>网关从Nacos读取服务列表, 包括服务名称, 服务地址</li><li>请求到达网关, 网关将请求路由到具体的微服务</li></ol><blockquote><p>Nacos两个作用:</p><ol><li>服务发现中心: 微服务将自身注册到Nacos, 网关从Nacos获取微服务列表</li><li>配置中心:  微服务配置信息非常复杂, 提供系统可维护性, <code>微服务配置信息</code>统一在Nacos配置</li></ol></blockquote><h4 id="搭建Nacos"><a href="#搭建Nacos" class="headerlink" title="搭建Nacos"></a>搭建Nacos</h4><p>Spring Cloud 是一套规范, Spring Cloud alibaba nacos服务注册中心, 根据网关架构图, 使用网关搭建Nacos</p><p>对于Nacos, 应该搞清两个概念, namespace和group</p><p>namespace: 用于区分环境, 比如: 开发环境, 测试环境, 生产环境</p><p>group: 用于区分项目: 比如 xuecheng-plus项目, xuecheng2.0项目</p><p>首先在nacos配置namespace</p><p>登录centos , 启动nacos,  sh &#x2F;data&#x2F;soft&#x2F;restart.sh自动启动nacos</p><blockquote><p>访问：<a href="http://192.168.101.65:8848/nacos/">http://192.168.101.65:8848/nacos/</a></p><p>账号密码：nacos&#x2F;nacos</p></blockquote><p>找到命名空间</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215123004526.png" alt="image-20231215123004526"></p><p>新建一个新的命名空间</p><p>在system和content两个模块中加入依赖和yml配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- nacos 发现服务 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>content</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">content-api</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br></code></pre></td></tr></table></figure><p>system</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">system-api</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br></code></pre></td></tr></table></figure><p>启动</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215125329824.png" alt="image-20231215125329824"></p><h4 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h4><p>搭建Nacos配置中心，目的是通过Nacos管理项目所有配置</p><p>将项目中的配置文件分分类：</p><ol><li>每个项目<code>特有</code>的配置</li></ol><p>该配置只在有些项目中需要配置， 或该配置在每个项目中配置的值不同</p><p>比如: spring.application.name 每个项目都需要配置但值不一样, 有些项目需要连数据库, 有些项目需要连消息队列</p><ol start="2"><li>项目中<code>共有</code>的配置</li></ol><p>在项目中配置内容相同的配置, 比如redis的配置, 很多项目用同一套redis配置</p><ol start="3"><li><code>扩展</code>的来自别的模块的配置</li></ol><blockquote><p>nacos如何定位一个具体的配置文件 ?</p><ol><li><p>namespace; group 来找到具体的环境和具体项目</p></li><li><p>dataid 找到具体的配置文件, dataid有三部分组成: contetnt - service - dev . yaml  三部分</p><p>content-service: 第一部分,   application.yml配置的应用名, 即spring.application.name 的值</p><p>dev:  第二部分, 环境名, 通过spring.profiles.active指定</p><p>yaml: 第三部分, 配置文件的后缀</p></li></ol><p>所以, 如果我们要配置content-service工程的配置文件,</p><p>在开发环境中配置content-service-dev.yaml</p><p>在测试环境中配置content-service-test.yaml</p><p>在生产环境中配置content-service-prod.yaml</p><p>我们启动项目传入spring.profiles.active参数决定引用哪个环境的配置文件, 例如: 传入<code>spring.profiles.active=dev</code> 则使用dev环境的配置文件即 <code>content-service-dev.yaml</code></p></blockquote><h5 id="配置content-api"><a href="#配置content-api" class="headerlink" title="配置content-api"></a>配置content-api</h5><p>检查依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- nacos 发现服务 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- nacos 配置服务 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>修改bootstrap.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#server:</span><br><span class="hljs-comment">#  servlet:</span><br><span class="hljs-comment">#    context-path: /content # 所有接口根路径</span><br><span class="hljs-comment">#  port: 63040</span><br><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">content-api</span> <span class="hljs-comment"># 服务名</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 环境名</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span> <span class="hljs-comment"># 服务注册相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>      <span class="hljs-attr">config:</span> <span class="hljs-comment"># 配置文件相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span><br><span class="hljs-comment">#  datasource:</span><br><span class="hljs-comment">#    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="hljs-comment">#    url: jdbc:mysql://192.168.101.65:3306/xc402_content?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br><span class="hljs-comment">#    username: root</span><br><span class="hljs-comment">#    password: mysql</span><br><br><br><span class="hljs-comment"># 日志文件配置路径</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">config:</span> <span class="hljs-string">classpath:log4j2-dev.xml</span><br><br><span class="hljs-comment"># swagger 文档配置</span><br><span class="hljs-comment">#swagger:</span><br><span class="hljs-comment">#  title: &quot;学成在线内容管理系统&quot;</span><br><span class="hljs-comment">#  description: &quot;内容系统管理系统对课程相关信息进行管理&quot;</span><br><span class="hljs-comment">#  base-package: com.xuecheng.content</span><br><span class="hljs-comment">#  enabled: true</span><br><span class="hljs-comment">#  version: 1.0.0</span><br><br></code></pre></td></tr></table></figure><p>编写nacos配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/content</span> <span class="hljs-comment"># 所有接口根路径</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">63040</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.101.65:3306/xc402_content?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">mysql</span><br><span class="hljs-attr">swagger:</span><br>  <span class="hljs-attr">title:</span> <span class="hljs-string">&quot;学成在线内容管理系统&quot;</span><br>  <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;内容系统管理系统对课程相关信息进行管理&quot;</span><br>  <span class="hljs-attr">base-package:</span> <span class="hljs-string">com.xuecheng.content</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><br></code></pre></td></tr></table></figure><blockquote><p>为什么不在nacos配置spring.application.name?</p><p>nacos客户端根据这个发现服务&amp;确定nacos配置文件名称, 要在<code>工程本地</code>配置</p></blockquote><h5 id="配置-content-service"><a href="#配置-content-service" class="headerlink" title="配置 content-service"></a>配置 content-service</h5><p>目标: service云端配mysql; api云端配所有接口根路径; api本地配拓展云端配置; api&amp;service本地配共用配置</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182334467.png" alt="image-20231215182334467"></p><p>api云端</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182354671.png" alt="image-20231215182354671"></p><p>service云端</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182410899.png" alt="image-20231215182410899"></p><p>swagger共用</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182427946.png" alt="image-20231215182427946"></p><p>日志共用</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182447578.png" alt="image-20231215182447578"></p><p>api本地</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">content-api</span> <span class="hljs-comment"># 服务名</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 环境名</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span> <span class="hljs-comment"># 服务注册相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>      <span class="hljs-attr">config:</span> <span class="hljs-comment"># 配置文件相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-comment"># 引入nacos的 content-service-dev.yaml 的数据库相关依赖</span><br>        <span class="hljs-attr">extension-configs:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">content-service-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">shared-configs:</span> <span class="hljs-comment"># 共用共享配置</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">swagger-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">logging-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>service本地</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">content-service</span> <span class="hljs-comment"># 服务名</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 环境名</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">config:</span> <span class="hljs-comment"># 配置文件相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">shared-configs:</span> <span class="hljs-comment"># 共用共享配置</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">swagger-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">logging-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h5 id="配置优先级"><a href="#配置优先级" class="headerlink" title="配置优先级"></a>配置优先级</h5><p>所有微服务配置统一由nacos配置, 用到的配置文件有本地配置文件bootstrap.yaml 和 nacos 的配置文件, SpringBoot 读取配置文件的顺序如下:</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220047655.png" alt="image-20231215220047655"></p><p>引入云配置的形式有:</p><ol><li>以项目应用名方式引入</li><li>以扩展配置文件方式引入</li><li>以共享配置文件方式引入</li><li>本地配置文件</li></ol><p>各配置文件优先级: <code>项目应用名配置文件&gt;扩展配置文件&gt;共享配置文件&gt;本地配置文件</code></p><p>有时我们测试程序在本地加一个配置进行测试</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220357445.png" alt="image-20231215220357445"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220413980.png" alt="image-20231215220413980"></p><p>启动, 发现没有生效, 因为云端配的63040, 优先级更高</p><p>如果想要本地优先, 在nacos配置文件加入配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#配置本地优先</span><br><span class="hljs-attr">spring:</span><br> <span class="hljs-attr">cloud:</span><br>  <span class="hljs-attr">config:</span><br>    <span class="hljs-attr">override-none:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220757178.png" alt="image-20231215220757178"></p><p>导入配置文件</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215221521134.png" alt="image-20231215221521134"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215221529910.png" alt="image-20231215221529910"></p><p>作业: 配置system模块</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#server:</span><br><span class="hljs-comment">#  servlet:</span><br><span class="hljs-comment">#    context-path: /system</span><br><span class="hljs-comment">#  port: 63110</span><br><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">system-api</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span> <span class="hljs-comment"># 服务注册相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>      <span class="hljs-attr">config:</span> <span class="hljs-comment"># 配置文件相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-comment"># 引入nacos的 system-service-dev.yaml 的数据库相关依赖</span><br>        <span class="hljs-attr">extension-configs:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">system-service-$&#123;spring.profiles.active&#125;.yaml</span><br>              <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>              <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">shared-configs:</span> <span class="hljs-comment"># 共用共享配置</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">swagger-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">logging-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br><span class="hljs-comment">#  datasource:</span><br><span class="hljs-comment">#    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="hljs-comment">#    url: jdbc:mysql://192.168.101.65:3306/xcplus_system?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br><span class="hljs-comment">#    username: root</span><br><span class="hljs-comment">#    password: mysql</span><br><span class="hljs-comment">## 日志文件配置路径</span><br><span class="hljs-comment">#logging:</span><br><span class="hljs-comment">#  config: classpath:log4j2-dev.xml</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">## swagger 文档配置</span><br><span class="hljs-comment">#swagger:</span><br><span class="hljs-comment">#  title: &quot;学成在线系统管理&quot;</span><br><span class="hljs-comment">#  description: &quot;系统管理接口&quot;</span><br><span class="hljs-comment">#  base-package: com.xuecheng.system</span><br><span class="hljs-comment">#  enabled: true</span><br><span class="hljs-comment">#  version: 1.0.0</span><br></code></pre></td></tr></table></figure><hr><h4 id="搭建-Gateway"><a href="#搭建-Gateway" class="headerlink" title="搭建 Gateway"></a>搭建 Gateway</h4><blockquote><p>前端开启网关</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217161648811.png" alt="image-20231217161648811"></p></blockquote><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215225149429.png" alt="image-20231215225149429"></p><p>pom.xml 导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!--网关--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!--服务发现中心--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>bootstrap.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">shared-configs:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">logging-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-common</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>云端配置</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215233423589.png" alt="image-20231215233423589"></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">63010</span> <span class="hljs-comment"># 网关端口</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br><span class="hljs-comment">#      filter:</span><br><span class="hljs-comment">#        strip-prefix:</span><br><span class="hljs-comment">#          enabled: true</span><br>      <span class="hljs-attr">routes:</span> <span class="hljs-comment"># 网关路由配置</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">content-api</span> <span class="hljs-comment"># 路由id，自定义，只要唯一即可</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://content-api</span> <span class="hljs-comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/content/**</span> <span class="hljs-comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span><br><span class="hljs-comment">#          filters:</span><br><span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">system-api</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://system-api</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/system/**</span><br><span class="hljs-comment">#          filters:</span><br><span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">media-api</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://media-api</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/media/**</span><br><span class="hljs-comment">#          filters:</span><br><span class="hljs-comment">#            - StripPrefix=1</span><br><br></code></pre></td></tr></table></figure><p>httpclient测试</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215233529684.png" alt="image-20231215233529684"></p><p>swagger测试</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215233646868.png" alt="image-20231215233646868"></p><h4 id="搭建媒资工程"><a href="#搭建媒资工程" class="headerlink" title="搭建媒资工程"></a>搭建媒资工程</h4><p>导入资料</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215235010632.png" alt="image-20231215235010632"></p><p>导入数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- MySQL dump 10.13  Distrib 8.0.31, for Win64 (x86_64)</span><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Host: 192.168.101.65    Database: xc148_media</span><br><span class="hljs-comment">-- ------------------------------------------------------</span><br><span class="hljs-comment">-- Server version8.0.26</span><br><br><span class="hljs-comment">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */</span>;<br><span class="hljs-comment">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */</span>;<br><span class="hljs-comment">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */</span>;<br><span class="hljs-comment">/*!50503 SET NAMES utf8mb4 */</span>;<br><span class="hljs-comment">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */</span>;<br><span class="hljs-comment">/*!40103 SET TIME_ZONE=&#x27;+00:00&#x27; */</span>;<br><span class="hljs-comment">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */</span>;<br><span class="hljs-comment">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span>;<br><span class="hljs-comment">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#x27;NO_AUTO_VALUE_ON_ZERO&#x27; */</span>;<br><span class="hljs-comment">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span>;<br><br><br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Table structure for table `media_files`</span><br><span class="hljs-comment">--</span><br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `media_files`;<br><span class="hljs-comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;<br><span class="hljs-comment">/*!50503 SET character_set_client = utf8mb4 */</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `media_files` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件id,md5值&#x27;</span>,<br>  `company_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;机构ID&#x27;</span>,<br>  `company_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;机构名称&#x27;</span>,<br>  `filename` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件名称&#x27;</span>,<br>  `file_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件类型（图片、文档，视频）&#x27;</span>,<br>  `tags` <span class="hljs-type">varchar</span>(<span class="hljs-number">120</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;标签&#x27;</span>,<br>  `bucket` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;存储目录&#x27;</span>,<br>  `file_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;存储路径&#x27;</span>,<br>  `file_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件id&#x27;</span>,<br>  `url` <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;媒资文件访问地址&#x27;</span>,<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">60</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;上传人&#x27;</span>,<br>  `create_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;上传时间&#x27;</span>,<br>  `change_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;修改时间&#x27;</span>,<br>  `status` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;状态,1:正常，0:不展示&#x27;</span>,<br>  `remark` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;备注&#x27;</span>,<br>  `audit_status` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;审核状态&#x27;</span>,<br>  `audit_mind` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;审核意见&#x27;</span>,<br>  `file_size` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件大小&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE,<br>  <span class="hljs-keyword">UNIQUE</span> KEY `unique_fileid` (`file_id`) <span class="hljs-keyword">USING</span> BTREE COMMENT <span class="hljs-string">&#x27;文件id唯一索引 &#x27;</span><br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span> COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;媒资信息&#x27;</span>;<br><span class="hljs-comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Dumping data for table `media_files`</span><br><span class="hljs-comment">--</span><br><br>LOCK TABLES `media_files` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_files` DISABLE KEYS */</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `media_files` (`id`, `company_id`, `company_name`, `filename`, `file_type`, `tags`, `bucket`, `file_path`, `file_id`, `url`, `username`, `create_date`, `change_date`, `status`, `remark`, `audit_status`, `audit_mind`, `file_size`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;1137f04b2f44d1b2c37bcb73608864da&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;course29943168382846755.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/18.html&#x27;</span>,<span class="hljs-string">&#x27;1137f04b2f44d1b2c37bcb73608864da&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-18 12:21:32&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">34210</span>),(<span class="hljs-string">&#x27;1580180577525002241&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.jpg&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;8383a8c2c1d098fcc07da7d6e79ae31e&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/10/12/8383a8c2c1d098fcc07da7d6e79ae31e.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-12 20:56:23&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">5767</span>),(<span class="hljs-string">&#x27;18f919e23bedab97a78762c4875addc4&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;垂直分库-插入和查询测试.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;1/8/18f919e23bedab97a78762c4875addc4/18f919e23bedab97a78762c4875addc4.avi&#x27;</span>,<span class="hljs-string">&#x27;18f919e23bedab97a78762c4875addc4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-15 09:45:18&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">16305152</span>),(<span class="hljs-string">&#x27;1d0f0e6ed8a0c4a89bfd304b84599d9c&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;asset-icoGather.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&#x27;</span>,<span class="hljs-string">&#x27;1d0f0e6ed8a0c4a89bfd304b84599d9c&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:21:28&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">8059</span>),(<span class="hljs-string">&#x27;1f229319d6fed3431d2f9d06193a433b&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;01-分布式事务专题课程介绍.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;1/f/1f229319d6fed3431d2f9d06193a433b/1f229319d6fed3431d2f9d06193a433b.avi&#x27;</span>,<span class="hljs-string">&#x27;1f229319d6fed3431d2f9d06193a433b&#x27;</span>,<span class="hljs-string">&#x27;/video/1/f/1f229319d6fed3431d2f9d06193a433b/1f229319d6fed3431d2f9d06193a433b.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:30:02&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">14705152</span>),(<span class="hljs-string">&#x27;23f83ae728bd1269eee7ea2236e79644&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;16-Nacos配置管理-课程总结.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;2/3/23f83ae728bd1269eee7ea2236e79644/23f83ae728bd1269eee7ea2236e79644.avi&#x27;</span>,<span class="hljs-string">&#x27;23f83ae728bd1269eee7ea2236e79644&#x27;</span>,<span class="hljs-string">&#x27;/video/2/3/23f83ae728bd1269eee7ea2236e79644/23f83ae728bd1269eee7ea2236e79644.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:21:44&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">26053632</span>),(<span class="hljs-string">&#x27;287cdd91c5d444e0752b626cbd95b41c&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;nacos01.mp4&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;2/8/287cdd91c5d444e0752b626cbd95b41c/287cdd91c5d444e0752b626cbd95b41c.mp4&#x27;</span>,<span class="hljs-string">&#x27;287cdd91c5d444e0752b626cbd95b41c&#x27;</span>,<span class="hljs-string">&#x27;/video/2/8/287cdd91c5d444e0752b626cbd95b41c/287cdd91c5d444e0752b626cbd95b41c.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:28:43&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">25953447</span>),(<span class="hljs-string">&#x27;33c643206bb7c08e2cb99b622d7a1b63&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/10/07/33c643206bb7c08e2cb99b622d7a1b63.png&#x27;</span>,<span class="hljs-string">&#x27;33c643206bb7c08e2cb99b622d7a1b63&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/10/07/33c643206bb7c08e2cb99b622d7a1b63.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-07 06:20:05&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">169788</span>),(<span class="hljs-string">&#x27;345db593849aada5675ed1e438650eeb&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/10/07/345db593849aada5675ed1e438650eeb.png&#x27;</span>,<span class="hljs-string">&#x27;345db593849aada5675ed1e438650eeb&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/10/07/345db593849aada5675ed1e438650eeb.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-07 09:31:46&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">70171</span>),(<span class="hljs-string">&#x27;3a5a861d1c745d05166132c47b44f9e4&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;01-Nacos配置管理-内容介绍.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;3/a/3a5a861d1c745d05166132c47b44f9e4/3a5a861d1c745d05166132c47b44f9e4.avi&#x27;</span>,<span class="hljs-string">&#x27;3a5a861d1c745d05166132c47b44f9e4&#x27;</span>,<span class="hljs-string">&#x27;/video/3/a/3a5a861d1c745d05166132c47b44f9e4/3a5a861d1c745d05166132c47b44f9e4.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:19:24&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">23839232</span>),(<span class="hljs-string">&#x27;3fb1d9a565cb92f395f384bd62ef24cd&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1614759607876_0.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-string">&#x27;课程图片&#x27;</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/3fb1d9a565cb92f395f384bd62ef24cd.png&#x27;</span>,<span class="hljs-string">&#x27;3fb1d9a565cb92f395f384bd62ef24cd&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/3fb1d9a565cb92f395f384bd62ef24cd.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:06:11&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">58873</span>),(<span class="hljs-string">&#x27;500598cae139f77c1bb54459909e0443&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;course8561649859933456434.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/119.html&#x27;</span>,<span class="hljs-string">&#x27;500598cae139f77c1bb54459909e0443&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/course/119.html&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-07 09:39:49&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">35652</span>),(<span class="hljs-string">&#x27;538bd3d652593b8df70d84e643b12842&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;course6941513291436463735.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/121.html&#x27;</span>,<span class="hljs-string">&#x27;538bd3d652593b8df70d84e643b12842&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2023-02-09 11:33:18&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">36292</span>),(<span class="hljs-string">&#x27;5878a684ee9a36daae5d0741aaca0747&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;Spring Security集成测试&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;5/8/5878a684ee9a36daae5d0741aaca0747/5878a684ee9a36daae5d0741aaca0747.avi&#x27;</span>,<span class="hljs-string">&#x27;5878a684ee9a36daae5d0741aaca0747&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-16 15:30:17&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>),(<span class="hljs-string">&#x27;6ad24a762f67c18f61966c1b8c55abe6&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;07-分布式事务基础理论-BASE理论.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;6/a/6ad24a762f67c18f61966c1b8c55abe6/6ad24a762f67c18f61966c1b8c55abe6.avi&#x27;</span>,<span class="hljs-string">&#x27;6ad24a762f67c18f61966c1b8c55abe6&#x27;</span>,<span class="hljs-string">&#x27;/video/6/a/6ad24a762f67c18f61966c1b8c55abe6/6ad24a762f67c18f61966c1b8c55abe6.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:30:16&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">13189632</span>),(<span class="hljs-string">&#x27;70a98b4a2fffc89e50b101f959cc33ca&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;22-Hmily实现TCC事务-开发bank2的confirm方法.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;7/0/70a98b4a2fffc89e50b101f959cc33ca/70a98b4a2fffc89e50b101f959cc33ca.avi&#x27;</span>,<span class="hljs-string">&#x27;70a98b4a2fffc89e50b101f959cc33ca&#x27;</span>,<span class="hljs-string">&#x27;/video/7/0/70a98b4a2fffc89e50b101f959cc33ca/70a98b4a2fffc89e50b101f959cc33ca.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:30:52&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">18444288</span>),(<span class="hljs-string">&#x27;74b386417bb9f3764009dc94068a5e44&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;test2.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/74b386417bb9f3764009dc94068a5e44.html&#x27;</span>,<span class="hljs-string">&#x27;74b386417bb9f3764009dc94068a5e44&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:56:02&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">40124</span>),(<span class="hljs-string">&#x27;757891eae4473e7ba78827656b1ccacf&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;studyuser.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;757891eae4473e7ba78827656b1ccacf&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/10/13/757891eae4473e7ba78827656b1ccacf.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-13 19:57:01&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">4922</span>),(<span class="hljs-string">&#x27;8026f17cf7b8697eccec2c8406d0c96c&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;nacos.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/10/04/8026f17cf7b8697eccec2c8406d0c96c.png&#x27;</span>,<span class="hljs-string">&#x27;8026f17cf7b8697eccec2c8406d0c96c&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/10/04/8026f17cf7b8697eccec2c8406d0c96c.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-04 18:55:01&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">128051</span>),(<span class="hljs-string">&#x27;809694a6a974c35e3a36f36850837d7c&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;809694a6a974c35e3a36f36850837d7c&#x27;</span>,<span class="hljs-string">&#x27;/video/8/0/809694a6a974c35e3a36f36850837d7c/809694a6a974c35e3a36f36850837d7c.avi&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-13 21:27:14&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>),(<span class="hljs-string">&#x27;81d7ed5153316f5774885d3b4c07d8bc&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;Spring Security快速上手-创建工程.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;8/1/81d7ed5153316f5774885d3b4c07d8bc/81d7ed5153316f5774885d3b4c07d8bc.avi&#x27;</span>,<span class="hljs-string">&#x27;81d7ed5153316f5774885d3b4c07d8bc&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-15 09:41:50&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">19945472</span>),(<span class="hljs-string">&#x27;9b0a355a0a954fdb3671998b4b016474&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;test.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/test.html&#x27;</span>,<span class="hljs-string">&#x27;9b0a355a0a954fdb3671998b4b016474&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-17 17:04:40&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">34174</span>),(<span class="hljs-string">&#x27;a16da7a132559daf9e1193166b3e7f52&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.jpg&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/a16da7a132559daf9e1193166b3e7f52.jpg&#x27;</span>,<span class="hljs-string">&#x27;a16da7a132559daf9e1193166b3e7f52&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/a16da7a132559daf9e1193166b3e7f52.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:26:08&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">248329</span>),(<span class="hljs-string">&#x27;a61805e1360ab946def5471aaefc0a98&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;teacherpic.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/12/18/a61805e1360ab946def5471aaefc0a98.jpg&#x27;</span>,<span class="hljs-string">&#x27;a61805e1360ab946def5471aaefc0a98&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/12/18/a61805e1360ab946def5471aaefc0a98.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-18 12:10:52&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">11600</span>),(<span class="hljs-string">&#x27;a6fb4fc7faf1d3d0831819969529b888&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.项目背景.mp4&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;a6fb4fc7faf1d3d0831819969529b888&#x27;</span>,<span class="hljs-string">&#x27;/video/a/6/a6fb4fc7faf1d3d0831819969529b888/a6fb4fc7faf1d3d0831819969529b888.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-13 21:30:17&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>),(<span class="hljs-string">&#x27;b2deb4a098bb12653c57bbaa0099697a&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;course3448922126748441722.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/117.html&#x27;</span>,<span class="hljs-string">&#x27;b2deb4a098bb12653c57bbaa0099697a&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/course/117.html&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-04 19:20:01&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">37705</span>),(<span class="hljs-string">&#x27;c051fe97e672dd399902a90f4ac67962&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;widget-3.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/12/18/c051fe97e672dd399902a90f4ac67962.jpg&#x27;</span>,<span class="hljs-string">&#x27;c051fe97e672dd399902a90f4ac67962&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/12/18/c051fe97e672dd399902a90f4ac67962.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-18 12:02:29&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">62469</span>),(<span class="hljs-string">&#x27;ca1d75b0a37b85fafd5f2e443f6f3f01&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;course2996275631019924973.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/118.html&#x27;</span>,<span class="hljs-string">&#x27;ca1d75b0a37b85fafd5f2e443f6f3f01&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/course/118.html&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-07 06:40:51&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">35905</span>),(<span class="hljs-string">&#x27;d4af959873182feb0fdb91dc6c1958b5&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;widget-5.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-string">&#x27;课程图片&#x27;</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/18/d4af959873182feb0fdb91dc6c1958b5.png&#x27;</span>,<span class="hljs-string">&#x27;d4af959873182feb0fdb91dc6c1958b5&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/18/d4af959873182feb0fdb91dc6c1958b5.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-18 21:49:55&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">17799</span>),(<span class="hljs-string">&#x27;db4e24f27d78ccac14401b7479b35c26&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;nonepic.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/23/db4e24f27d78ccac14401b7479b35c26.jpg&#x27;</span>,<span class="hljs-string">&#x27;db4e24f27d78ccac14401b7479b35c26&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/23/db4e24f27d78ccac14401b7479b35c26.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-23 18:27:26&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">6919</span>),(<span class="hljs-string">&#x27;df39983fcad83a6ceef14bfeeb1bc523&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;add.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/df39983fcad83a6ceef14bfeeb1bc523.jpg&#x27;</span>,<span class="hljs-string">&#x27;df39983fcad83a6ceef14bfeeb1bc523&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/df39983fcad83a6ceef14bfeeb1bc523.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:13:59&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">10487</span>),(<span class="hljs-string">&#x27;e00ce88f53cc391d9ffd51a81834d2af&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;widget-1.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-string">&#x27;课程图片&#x27;</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/18/e00ce88f53cc391d9ffd51a81834d2af.jpg&#x27;</span>,<span class="hljs-string">&#x27;e00ce88f53cc391d9ffd51a81834d2af&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/18/e00ce88f53cc391d9ffd51a81834d2af.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-18 21:48:50&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">71386</span>),(<span class="hljs-string">&#x27;e726b71ba99c70e8c9d2850c2a7019d7&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;asset-login_img.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/e726b71ba99c70e8c9d2850c2a7019d7.jpg&#x27;</span>,<span class="hljs-string">&#x27;e726b71ba99c70e8c9d2850c2a7019d7&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/e726b71ba99c70e8c9d2850c2a7019d7.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:44:50&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">22620</span>),(<span class="hljs-string">&#x27;ef29eb93515e32f2d897956d5d914db7&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;Snipaste_2023-02-09_11-06-52.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2023/02/09/ef29eb93515e32f2d897956d5d914db7.png&#x27;</span>,<span class="hljs-string">&#x27;ef29eb93515e32f2d897956d5d914db7&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2023/02/09/ef29eb93515e32f2d897956d5d914db7.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2023-02-09 11:07:02&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">327814</span>),(<span class="hljs-string">&#x27;efd2eacc4485946fc27feb0caef7506c&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;读写分离-理解读写分离.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;e/f/efd2eacc4485946fc27feb0caef7506c/efd2eacc4485946fc27feb0caef7506c.avi&#x27;</span>,<span class="hljs-string">&#x27;efd2eacc4485946fc27feb0caef7506c&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-15 09:45:19&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">14879232</span>),(<span class="hljs-string">&#x27;fbb57de7001cccf1e28fbe34c7506ddc&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;asset-logo.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/fbb57de7001cccf1e28fbe34c7506ddc.png&#x27;</span>,<span class="hljs-string">&#x27;fbb57de7001cccf1e28fbe34c7506ddc&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/fbb57de7001cccf1e28fbe34c7506ddc.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:55:25&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">4355</span>);<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_files` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Table structure for table `media_process`</span><br><span class="hljs-comment">--</span><br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `media_process`;<br><span class="hljs-comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;<br><span class="hljs-comment">/*!50503 SET character_set_client = utf8mb4 */</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `media_process` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `file_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">120</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件标识&#x27;</span>,<br>  `filename` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件名称&#x27;</span>,<br>  `bucket` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;存储桶&#x27;</span>,<br>  `file_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;存储路径&#x27;</span>,<br>  `status` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;状态,1:未处理，2：处理成功  3处理失败&#x27;</span>,<br>  `create_date` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;上传时间&#x27;</span>,<br>  `finish_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;完成时间&#x27;</span>,<br>  `fail_count` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;失败次数&#x27;</span>,<br>  `url` <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;媒资文件访问地址&#x27;</span>,<br>  `errormsg` <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;失败原因&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE,<br>  <span class="hljs-keyword">UNIQUE</span> KEY `unique_fileid` (`file_id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span>;<br><span class="hljs-comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Dumping data for table `media_process`</span><br><span class="hljs-comment">--</span><br><br>LOCK TABLES `media_process` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_process` DISABLE KEYS */</span>;<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_process` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Table structure for table `media_process_history`</span><br><span class="hljs-comment">--</span><br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `media_process_history`;<br><span class="hljs-comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;<br><span class="hljs-comment">/*!50503 SET character_set_client = utf8mb4 */</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `media_process_history` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `file_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">120</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件标识&#x27;</span>,<br>  `filename` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件名称&#x27;</span>,<br>  `bucket` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;存储源&#x27;</span>,<br>  `status` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;状态,1:未处理，2：处理成功  3处理失败&#x27;</span>,<br>  `create_date` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;上传时间&#x27;</span>,<br>  `finish_date` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;完成时间&#x27;</span>,<br>  `url` <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;媒资文件访问地址&#x27;</span>,<br>  `fail_count` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;失败次数&#x27;</span>,<br>  `file_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件路径&#x27;</span>,<br>  `errormsg` <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;失败原因&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span>;<br><span class="hljs-comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Dumping data for table `media_process_history`</span><br><span class="hljs-comment">--</span><br><br>LOCK TABLES `media_process_history` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_process_history` DISABLE KEYS */</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `media_process_history` (`id`, `file_id`, `filename`, `bucket`, `status`, `create_date`, `finish_date`, `url`, `file_path`, `errormsg`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;81d7ed5153316f5774885d3b4c07d8bc&#x27;</span>,<span class="hljs-string">&#x27;Spring Security快速上手-创建工程.avi&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 09:41:50&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 10:30:26&#x27;</span>,<span class="hljs-string">&#x27;/video/8/1/81d7ed5153316f5774885d3b4c07d8bc/81d7ed5153316f5774885d3b4c07d8bc.mp4&#x27;</span>,<span class="hljs-string">&#x27;8/1/81d7ed5153316f5774885d3b4c07d8bc/81d7ed5153316f5774885d3b4c07d8bc.avi&#x27;</span>,<span class="hljs-keyword">NULL</span>),(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;18f919e23bedab97a78762c4875addc4&#x27;</span>,<span class="hljs-string">&#x27;垂直分库-插入和查询测试.avi&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 09:45:18&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 10:30:11&#x27;</span>,<span class="hljs-string">&#x27;/video/1/8/18f919e23bedab97a78762c4875addc4/18f919e23bedab97a78762c4875addc4.mp4&#x27;</span>,<span class="hljs-string">&#x27;1/8/18f919e23bedab97a78762c4875addc4/18f919e23bedab97a78762c4875addc4.avi&#x27;</span>,<span class="hljs-keyword">NULL</span>),(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;efd2eacc4485946fc27feb0caef7506c&#x27;</span>,<span class="hljs-string">&#x27;读写分离-理解读写分离.avi&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 09:45:19&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 10:31:04&#x27;</span>,<span class="hljs-string">&#x27;/video/e/f/efd2eacc4485946fc27feb0caef7506c/efd2eacc4485946fc27feb0caef7506c.mp4&#x27;</span>,<span class="hljs-string">&#x27;e/f/efd2eacc4485946fc27feb0caef7506c/efd2eacc4485946fc27feb0caef7506c.avi&#x27;</span>,<span class="hljs-keyword">NULL</span>);<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_process_history` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Table structure for table `mq_message`</span><br><span class="hljs-comment">--</span><br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `mq_message`;<br><span class="hljs-comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;<br><span class="hljs-comment">/*!50503 SET character_set_client = utf8mb4 */</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mq_message` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息id&#x27;</span>,<br>  `message_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息类型代码&#x27;</span>,<br>  `business_key1` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `business_key2` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `business_key3` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `mq_host` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列主机&#x27;</span>,<br>  `mq_port` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列端口&#x27;</span>,<br>  `mq_virtualhost` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列虚拟主机&#x27;</span>,<br>  `mq_queue` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;队列名称&#x27;</span>,<br>  `inform_num` <span class="hljs-type">int</span> unsigned <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;通知次数&#x27;</span>,<br>  `state` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;处理状态，0:初始，1:成功&#x27;</span>,<br>  `returnfailure_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复失败时间&#x27;</span>,<br>  `returnsuccess_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复成功时间&#x27;</span>,<br>  `returnfailure_msg` <span class="hljs-type">varchar</span>(<span class="hljs-number">2048</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复失败内容&#x27;</span>,<br>  `inform_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;最近通知时间&#x27;</span>,<br>  `stage_state1` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;阶段1处理状态, 0:初始，1:成功&#x27;</span>,<br>  `stage_state2` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;阶段2处理状态, 0:初始，1:成功&#x27;</span>,<br>  `stage_state3` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;阶段3处理状态, 0:初始，1:成功&#x27;</span>,<br>  `stage_state4` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;阶段4处理状态, 0:初始，1:成功&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span>;<br><span class="hljs-comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Dumping data for table `mq_message`</span><br><span class="hljs-comment">--</span><br><br>LOCK TABLES `mq_message` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `mq_message` DISABLE KEYS */</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `mq_message` (`id`, `message_type`, `business_key1`, `business_key2`, `business_key3`, `mq_host`, `mq_port`, `mq_virtualhost`, `mq_queue`, `inform_num`, `state`, `returnfailure_date`, `returnsuccess_date`, `returnfailure_msg`, `inform_date`, `stage_state1`, `stage_state2`, `stage_state3`, `stage_state4`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;f29a3149-7429-40be-8a4e-9909f32003b0&#x27;</span>,<span class="hljs-string">&#x27;xc.mq.msgsync.coursepub&#x27;</span>,<span class="hljs-string">&#x27;111&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">5607</span>,<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;xc.course.publish.queue&#x27;</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;0&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>);<br><span class="hljs-comment">/*!40000 ALTER TABLE `mq_message` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Table structure for table `mq_message_history`</span><br><span class="hljs-comment">--</span><br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `mq_message_history`;<br><span class="hljs-comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;<br><span class="hljs-comment">/*!50503 SET character_set_client = utf8mb4 */</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mq_message_history` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息id&#x27;</span>,<br>  `message_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息类型代码&#x27;</span>,<br>  `business_key1` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `business_key2` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `business_key3` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `mq_host` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列主机&#x27;</span>,<br>  `mq_port` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列端口&#x27;</span>,<br>  `mq_virtualhost` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列虚拟主机&#x27;</span>,<br>  `mq_queue` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;队列名称&#x27;</span>,<br>  `inform_num` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) unsigned zerofill <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;通知次数&#x27;</span>,<br>  `state` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) unsigned zerofill <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;处理状态，0:初始，1:成功，2:失败&#x27;</span>,<br>  `returnfailure_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复失败时间&#x27;</span>,<br>  `returnsuccess_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复成功时间&#x27;</span>,<br>  `returnfailure_msg` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复失败内容&#x27;</span>,<br>  `inform_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;最近通知时间&#x27;</span>,<br>  `stage_state1` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `stage_state2` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `stage_state3` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `stage_state4` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span>;<br><span class="hljs-comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Dumping data for table `mq_message_history`</span><br><span class="hljs-comment">--</span><br><br>LOCK TABLES `mq_message_history` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `mq_message_history` DISABLE KEYS */</span>;<br><span class="hljs-comment">/*!40000 ALTER TABLE `mq_message_history` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br><span class="hljs-comment">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */</span>;<br><br><span class="hljs-comment">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */</span>;<br><span class="hljs-comment">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */</span>;<br><span class="hljs-comment">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */</span>;<br><span class="hljs-comment">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */</span>;<br><span class="hljs-comment">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */</span>;<br><span class="hljs-comment">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */</span>;<br><span class="hljs-comment">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */</span>;<br><br><span class="hljs-comment">-- Dump completed on 2023-02-09 16:51:35</span><br><br></code></pre></td></tr></table></figure><p>修改云端数据库名对应    xc402_media</p><h3 id="分布式文件系统"><a href="#分布式文件系统" class="headerlink" title="分布式文件系统"></a>分布式文件系统</h3><blockquote><p><code>文件系统</code>是负责管理和存储文件的系统软件, 操作系统通过<code>文件系统</code>提供的接口<code>存储文件</code>, 用户通过<code>操作系统访问磁盘文件</code></p></blockquote><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216194353457.png" alt="image-20231216194353457"></p><p>短视频平台的海量视频和图片, 应该怎么存储? 满足海量用户的浏览</p><blockquote><p><code>分布式文件系统</code>:  <code>一个</code>计算机无法存储海量文件, 通过网络将<code>若干</code>计算机组织<code>共同存储</code>海量文件, 接收用户请求, 这些组织起来的计算机通过<code>网络通信</code></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216194714379.png" alt="image-20231216194714379"></p><p>优点:</p><ol><li>一台计算机文件系统处理<code>能力扩充</code>到多台计算机同时处理</li><li>一台计算机挂了还有另外<code>副本</code>计算机提供数据</li><li>每台计算机可以放到不同的地域, 用户可以<code>就近访问</code>, 提高访问速度</li></ol></blockquote><p>有一些分布式文件系统方案:  NFS   GFS  HDFS  云计算·厂家</p><p>本项目使用  <code>MinIO</code></p><h4 id="MinIO"><a href="#MinIO" class="headerlink" title="MinIO"></a>MinIO</h4><p>轻量的构建分布式文件系统的微服务, 和其他应用结合使用, 适合存储大容量非结构化数据, 可以和其他应用结合使用, 适合存储大容量非结构化数据, 例如图片, 视频, 日志, 备份数据, 容器&#x2F;虚拟机镜像等</p><p>官网：<a href="https://min.io/">https://min.io</a></p><p>中文：<a href="https://www.minio.org.cn/%EF%BC%8Chttp://docs.minio.org.cn/docs/">https://www.minio.org.cn/，http://docs.minio.org.cn/docs/</a></p><p>MinIO 集群采用<code>去中心化</code>共享架构, 每个节点对等关系, 通过Nginx对MinIO进行负载均衡访问</p><p>去中心化好处?</p><p>大数据中, 设计理念是无中心和分布式, Minio 分布式模式搭建一个高可用的对象存储服务, 使用这些存储设备, 不用考虑真实物理位置</p><p>将分布在不同服务器的多块硬盘组成一个对象存储服务, 由于硬盘分布在<code>不同的节点</code>, 分布式MinIO避免<code>单点故障</code></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216195914542.png" alt="image-20231216195914542"></p><p>使用<code>纠删码技术</code>保护数据, 是一种恢复丢失和损坏数据的数字算法, 将数据分块冗余的分散存储在各个节点的磁盘, 所有可用磁盘组成一个集合, 上传一个文件时通过纠删码算法对文件分块存储, 将文件本身分成4个数据块, 4个校验块, 数据块和校验块分散存储在8块硬盘上</p><p>使用纠删码好处是即便丢失一半数量的硬盘, 也可以恢复数据, 不影响盛传和下载, 多于一半则无法恢复</p><p>下载minio，下载地址在<a href="https://dl.min.io/server/minio/release/%EF%BC%8C%E5%8F%AF%E4%BB%8E%E8%AF%BE%E7%A8%8B%E8%B5%84%E6%96%99%E6%89%BE%E5%88%B0MinIO%E7%9A%84%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6minio.zip%E8%A7%A3%E5%8E%8B%E5%8D%B3%E5%8F%AF%E4%BD%BF%E7%94%A8%EF%BC%8CCMD%E8%BF%9B%E5%85%A5%E6%9C%89minio.exe%E7%9A%84%E7%9B%AE%E5%BD%95%EF%BC%8C%E8%BF%90%E8%A1%8C%E4%B8%8B%E8%BE%B9%E7%9A%84%E5%91%BD%E4%BB%A4%EF%BC%9A">https://dl.min.io/server/minio/release/，可从课程资料找到MinIO的安装文件minio.zip解压即可使用，CMD进入有minio.exe的目录，运行下边的命令：</a></p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livescript">.<span class="hljs-string">\minio.exe</span> server D:<span class="hljs-string">\develop\minio_data\data1</span>  D:<span class="hljs-string">\develop\minio_data\data2</span>  D:<span class="hljs-string">\develop\minio_data\data3</span>  D:<span class="hljs-string">\develop\minio_data\data4</span><br></code></pre></td></tr></table></figure><p>下边输入<a href="http://localhost:9000进行登录，账号和密码为：minioadmin/minioadmin">http://localhost:9000进行登录，账号和密码为：minioadmin/minioadmin</a></p><p>登录成功</p><p>创建存储桶并存入几个文件</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202614936.png" alt="image-20231216202614936"></p><p>可以发现文件被同时存入4个文件夹</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202646182.png" alt="image-20231216202646182"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202658155.png" alt="image-20231216202658155"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202707768.png" alt="image-20231216202707768"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202716547.png" alt="image-20231216202716547"></p><p>删除1个data目录, 文件不影响, 过一会恢复为4个目录</p><p>删除2个data目录, 文件不影响, 过一会恢复为4个目录</p><p>删除3个data目录, 由于 集合中共有4块硬盘，有大于一半的硬盘损坏数据无法恢复。此时报错：We encountered an internal error, please try again. (Read failed. Insufficient number of drives online)在线驱动器数量不足。</p><p>Docker中测试 minio</p><p>资料中的虚拟机已经部署好了  minio</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sh /data/soft /restart.sh<br></code></pre></td></tr></table></figure><p>访问<a href="http://192.168.101.65:9000/">http://192.168.101.65:9000</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216203051482.png" alt="image-20231216203051482"></p><p>本项目创建两个buckets：</p><p>mediafiles： 普通文件</p><p>video：视频文件</p><h4 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h4><p>MinIO 提供多个语言版本的SDK支持</p><p>文档地址：<a href="https://docs.min.io/docs/java-client-quickstart-guide.html">https://docs.min.io/docs/java-client-quickstart-guide.html</a></p><p>xuecheng-plus-media-service 导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">cxxxxxxxxxx11 1<span class="hljs-comment">&lt;!-- minio 分布式文件系统 --&gt;</span>2<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>3    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.minio<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>4    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>minio<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>5    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>6<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>7<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>8    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>9    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>10    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>参数说明: </p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>Endpoint</td><td>对象存储服务的URL</td></tr><tr><td>Access Key</td><td>Access key就像用户ID，可以唯一标识你的账户</td></tr><tr><td>Secret Key</td><td>Secret key是你账户的密码</td></tr></tbody></table><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media;<br><br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfo;<br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfoUtil;<br><span class="hljs-keyword">import</span> io.minio.GetObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.MinioClient;<br><span class="hljs-keyword">import</span> io.minio.RemoveObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.UploadObjectArgs;<br><span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.FilterInputStream;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/16 20:44</span><br><span class="hljs-comment"> * 测试 MinIO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinioTest</span> &#123;<br><br>    <span class="hljs-comment">// 准备minio客户端</span><br>    <span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span> MinioClient.builder()<br>            .endpoint(<span class="hljs-string">&quot;http://192.168.101.65:9000&quot;</span>)<br>            .credentials(<span class="hljs-string">&quot;minioadmin&quot;</span>, <span class="hljs-string">&quot;minioadmin&quot;</span>)<br>            .build();<br><br><br>    <span class="hljs-comment">// 上传文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">upload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">// 通过扩展名取出mimeType</span><br>        <span class="hljs-type">ContentInfo</span> <span class="hljs-variable">extensionMatch</span> <span class="hljs-operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="hljs-string">&quot;.mp4&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE; <span class="hljs-comment">// 通用mimeType, 字节流</span><br>        <span class="hljs-keyword">if</span> (extensionMatch != <span class="hljs-literal">null</span>) &#123;<br>            mimeType = extensionMatch.getMimeType();<br>        &#125;<br><br>        <span class="hljs-comment">// 上传文件的参数信息</span><br>        <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>) <span class="hljs-comment">//桶</span><br>                .filename(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>) <span class="hljs-comment">//本地文件路径</span><br>                <span class="hljs-comment">// .object(&quot;lqx.mp4&quot;) //对象名</span><br>                .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                .contentType(mimeType)<br>                .build();<br><br>        <span class="hljs-comment">// 上传文件</span><br>        minioClient.uploadObject(uploadObjectArgs);<br><br>    &#125;<br><br>    <span class="hljs-comment">// 删除文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">RemoveObjectArgs</span> <span class="hljs-variable">removeObjectArgs</span> <span class="hljs-operator">=</span> RemoveObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>)<br>                .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                .build();<br>        minioClient.removeObject(removeObjectArgs);<br>    &#125;<br><br><br>    <span class="hljs-comment">// 查询文件: 从minio下载文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">get</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">GetObjectArgs</span> <span class="hljs-variable">getObjectArgs</span> <span class="hljs-operator">=</span> GetObjectArgs.builder()<br>                            .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>)<br>                            .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                            .build();<br>        <span class="hljs-comment">// GetObjectResponse extends FilterInputStream</span><br>        <span class="hljs-comment">// 查询远程服务获取一个流对象</span><br>        <span class="hljs-type">FilterInputStream</span> <span class="hljs-variable">filterInputStream</span> <span class="hljs-operator">=</span> minioClient.getObject(getObjectArgs);<br>        <span class="hljs-comment">// 指定输出流</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\output\\lqx.mp4&quot;</span>);<br>        <span class="hljs-comment">// 拷贝流</span><br>        IOUtils.copy(filterInputStream, outputStream);<br><br><br>        <span class="hljs-comment">// 校验文件完整性, 对文件的内容进行md5校验(上传和下载过程出现网络丢包, 所以需要进行md5校验)</span><br>        <span class="hljs-comment">// 这里source_md5不能用filterInputStream, 网络文件的md5不稳定, 要用原始文件(传之前硬盘文件)的md5</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">source_md5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">local_md5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\output\\lqx.mp4&quot;</span>));<br>        <span class="hljs-keyword">if</span> (source_md5.equals(local_md5)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;下载成功&quot;</span>);<br>        &#125;<br>    &#125;<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216214756277.png" alt="image-20231216214756277"></p><hr><h3 id="上传图片"><a href="#上传图片" class="headerlink" title="上传图片"></a>上传图片</h3><h4 id="业务流程-1"><a href="#业务流程-1" class="headerlink" title="业务流程"></a>业务流程</h4><p>课程图片是宣传课程的信息, 在新增课程界面上传课程图片, 可以修改课程图片</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216214926087.png" alt="image-20231216214926087"></p><p>上传课程图片总体上包括两部分：</p><p>1、上传课程图片前端请求媒资管理服务将文件上传至分布式文件系统，并且在<code>媒资管理数据库</code>保存文件信息。</p><p>2、上传图片成功保存图片地址到<code>课程基本信息表</code>中</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215027914.png" alt="image-20231216215027914"></p><p>1、前端进入上传图片界面</p><p>2、上传图片，请求媒资管理服务。</p><p>3、媒资管理服务将图片文件存储在MinIO。</p><p>4、媒资管理记录文件信息到数据库。</p><p>5、前端请求内容管理服务<code>保存课程信息</code>，在内容管理数据库保存图片地址。</p><h4 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h4><p>设计的表: course_base(课程信息表中的图片字段)   之前的</p><p>media_files(媒资数据库的文件表)</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215449458.png" alt="image-20231216215449458"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215459908.png" alt="image-20231216215459908"></p><h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h4><p>创建存储桶 mediafiles(public)</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215804186.png" alt="image-20231216215804186"></p><p>nacos配置</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215749771.png" alt="image-20231216215749771"></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">YAML</span><br><span class="hljs-attr">minio:</span><br>  <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://192.168.101.65:9000</span><br>  <span class="hljs-attr">accessKey:</span> <span class="hljs-string">minioadmin</span><br>  <span class="hljs-attr">secretKey:</span> <span class="hljs-string">minioadmin</span><br>  <span class="hljs-attr">bucket:</span><br>    <span class="hljs-attr">files:</span> <span class="hljs-string">mediafiles</span><br>    <span class="hljs-attr">videofiles:</span> <span class="hljs-string">video</span><br></code></pre></td></tr></table></figure><p>media-service 工程 minio 配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.config;<br><br><span class="hljs-keyword">import</span> io.minio.MinioClient;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> minio配置</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/12 19:32</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinioConfig</span> &#123;<br><br><br> <span class="hljs-meta">@Value(&quot;$&#123;minio.endpoint&#125;&quot;)</span><br> <span class="hljs-keyword">private</span> String endpoint;<br> <span class="hljs-meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span><br> <span class="hljs-keyword">private</span> String accessKey;<br> <span class="hljs-meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span><br> <span class="hljs-keyword">private</span> String secretKey;<br><br> <span class="hljs-meta">@Bean</span><br> <span class="hljs-keyword">public</span> MinioClient <span class="hljs-title function_">minioClient</span><span class="hljs-params">()</span> &#123;<br><br>  <span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span><br>          MinioClient.builder()<br>                  .endpoint(endpoint)<br>                  .credentials(accessKey, secretKey)<br>                  .build();<br>  <span class="hljs-keyword">return</span> minioClient;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><p>此接口定义为一个通用的上传文件接口， 可以上传图片或其他文件</p><p>请求路径: &#x2F;media&#x2F;upload&#x2F;coursefile</p><p>请求内容:Content-Type：multipart&#x2F;form-data</p><p>form-data: name&#x3D;”filedata”; filename&#x3D;”具体的文件名称”</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json">JSON<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;companyId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1232141425</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;companyName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;filename&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.jpg&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;fileType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;001001&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;tags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;bucket&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;fileId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;timelength&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;createDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2022-09-12T21:57:18&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;changeDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;remark&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;auditStatus&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;auditMind&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;fileSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">248329</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;上传图片&quot;)</span> <span class="hljs-comment">// 服务器是消费者, 消费类型: multipart/form-data</span><br>    <span class="hljs-meta">@PostMapping(value = &quot;/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span><br>    <span class="hljs-keyword">public</span> UploadFileResultDto <span class="hljs-title function_">upload</span><span class="hljs-params">(<span class="hljs-meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile filedata)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">// 接收到文件了, 这时文件作为临时文件存在 tomcat 但是获取不到路径</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br><br>        <span class="hljs-type">UploadFileParamsDto</span> <span class="hljs-variable">uploadFileParamsDto</span> <span class="hljs-operator">=</span> UploadFileParamsDto.builder()<br>                .filename(filedata.getOriginalFilename()) <span class="hljs-comment">// 原始文件名称</span><br>                .fileSize(filedata.getSize()) <span class="hljs-comment">// 文件大小</span><br>                .fileType(<span class="hljs-string">&quot;001001&quot;</span>) <span class="hljs-comment">//文件类型</span><br>                .build();<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">tempFile</span> <span class="hljs-operator">=</span> File.createTempFile(<span class="hljs-string">&quot;minio&quot;</span>, <span class="hljs-string">&quot;.temp&quot;</span>);<span class="hljs-comment">//创建临时文件</span><br>        filedata.transferTo(tempFile);<span class="hljs-comment">//文件转换</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">localFilePath</span> <span class="hljs-operator">=</span> tempFile.getAbsolutePath();<span class="hljs-comment">//获取绝对路径 此时文件在tomcat</span><br><br>        <span class="hljs-comment">// 调用service上传图片</span><br>        mediaFileService.uploadFile(companyId, uploadFileParamsDto, localFilePath);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>service</p><pre><code class=" mermaid">graph LRuploadFile --&gt; getMimeTypeuploadFile --&gt; getMd5ByFilenameuploadFile --&gt; getDefaultFolderPathuploadFile --&gt; addMediaFilesToMinIOuploadFile --&gt; addMediaFilesToDB</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> UploadFileResultDto <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span> &#123;<br>        <span class="hljs-comment">// 将文件上传minio</span><br>        <span class="hljs-comment">// 根据文件名得到扩展名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> uploadFileParamsDto.getFilename();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> getMimeType(extension);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> getMd5ByFilename(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(localFilePath));<br>        <span class="hljs-comment">// 约定objectName怎么存 -&gt; /年/月/日/md5.后缀</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> getDefaultFolderPath() + md5 + extension;<br>        <span class="hljs-comment">// 将文件上传到minio</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isUploadMinIO</span> <span class="hljs-operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_mediafiles, objectName);<br>        <span class="hljs-keyword">if</span> (!isUploadMinIO)&#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;上传文件到MinIO失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 将文件信息保存到DB</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> addMediaFilesToDB(companyId, uploadFileParamsDto, md5, bucket_mediafiles, objectName);<br>        <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;文件上传后保存信息失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 准备返回的对象</span><br>        <span class="hljs-type">UploadFileResultDto</span> <span class="hljs-variable">uploadFileResultDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadFileResultDto</span>();<br>        BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);<br>        <span class="hljs-keyword">return</span> uploadFileResultDto;<br>    &#125;<br> <br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将文件信息保存到DB</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> companyId           机构id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> uploadFileParamsDto 上传文件的信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> md5                   md5</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bucket                桶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> objectName         对象名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">addMediaFilesToDB</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String md5, String bucket, String objectName)</span> &#123;<br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(md5);<br>        <span class="hljs-keyword">if</span> (mediaFiles==<span class="hljs-literal">null</span>)&#123;<br>            mediaFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFiles</span>();<br>            BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);<br>            <span class="hljs-comment">// 文件id</span><br>            mediaFiles.setId(md5);<br>            <span class="hljs-comment">// 机构id</span><br>            mediaFiles.setCompanyId(companyId);<br>            <span class="hljs-comment">// 桶</span><br>            mediaFiles.setBucket(bucket);<br>            <span class="hljs-comment">// 对象名称</span><br>            mediaFiles.setFilePath(objectName);<br>            <span class="hljs-comment">// file_id</span><br>            mediaFiles.setFileId(md5);<br>            <span class="hljs-comment">// url 完整访问地址</span><br>            mediaFiles.setUrl(<span class="hljs-string">&quot;/&quot;</span>+bucket+<span class="hljs-string">&quot;/&quot;</span>+objectName);<br>            <span class="hljs-comment">// 上传时间</span><br>            mediaFiles.setCreateDate(LocalDateTime.now());<br>            <span class="hljs-comment">// 状态</span><br>            mediaFiles.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>            <span class="hljs-comment">// 审核状态</span><br>            mediaFiles.setAuditStatus(<span class="hljs-string">&quot;002003&quot;</span>);<br>            <span class="hljs-comment">// 插入数据库</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> mediaFilesMapper.insert(mediaFiles);<br>            <span class="hljs-keyword">if</span> (insert&lt;=<span class="hljs-number">0</span>)&#123;<br>                log.debug(<span class="hljs-string">&quot;向数据库保存文件信息失败, bucket:&#123;&#125;, objectName: &#123;&#125;&quot;</span>, bucket, objectName);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> mediaFiles;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取文件默认存储目录路径     年/月/日/   2023-12-19 -&gt; 2023/12/19/</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getDefaultFolderPath</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">folder</span> <span class="hljs-operator">=</span> sdf.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>) + <span class="hljs-string">&quot;/&quot;</span>;<br>        <span class="hljs-keyword">return</span> folder;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取文件md5</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMd5ByFilename</span><span class="hljs-params">(File file)</span>&#123;<br>        <span class="hljs-keyword">try</span>(<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file))&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileMd5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(fileInputStream);<br>            <span class="hljs-keyword">return</span> fileMd5;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">// 通过扩展名取出mimeType      .mp4 -&gt; video/mp4</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMimeType</span><span class="hljs-params">(String extension)</span> &#123;<br>        <span class="hljs-keyword">if</span> (extension == <span class="hljs-literal">null</span>) &#123;<br>            extension = <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        <span class="hljs-type">ContentInfo</span> <span class="hljs-variable">extensionMatch</span> <span class="hljs-operator">=</span> ContentInfoUtil.findExtensionMatch(extension);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE; <span class="hljs-comment">// 通用mimeType, 字节流</span><br>        <span class="hljs-keyword">if</span> (extensionMatch != <span class="hljs-literal">null</span>) &#123;<br>            mimeType = extensionMatch.getMimeType();<br>        &#125;<br>        <span class="hljs-keyword">return</span> mimeType;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将文件上传到minio</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> localFilePath 本地文件路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mimeType      媒体类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bucket        桶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> objectName    对象名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addMediaFilesToMinIO</span><span class="hljs-params">(String localFilePath, String mimeType, String bucket, String objectName)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 准备上传文件的参数信息</span><br>            <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>                    .bucket(bucket) <span class="hljs-comment">//桶</span><br>                    .filename(localFilePath) <span class="hljs-comment">//本地文件路径</span><br>                    .object(objectName) <span class="hljs-comment">// 对象名</span><br>                    .contentType(mimeType)<br>                    .build();<br>            minioClient.uploadObject(uploadObjectArgs); <span class="hljs-comment">// 上传</span><br>            log.debug(<span class="hljs-string">&quot;上传文件到minio成功, bucket:&#123;&#125;, objectName:&#123;&#125;&quot;</span>, bucket, objectName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            log.error(<span class="hljs-string">&quot;上传文件到minio出错, bucket:&#123;&#125;, objectName:&#123;&#125;, 错误信息:&#123;&#125;&quot;</span>, bucket, objectName, e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="事务优化"><a href="#事务优化" class="headerlink" title="事务优化"></a>事务优化</h4><p>给uploadFile方法加@Transactional注解, 代理对象执行此方法前会开启事务</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219200451925.png" alt="image-20231219200451925"></p><p>如果没有加@Transactional注解, 代理对象执行方法前不进行事务控制</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219200554329.png" alt="image-20231219200554329"></p><p><code>事务失效</code></p><p>由于uploadFile方法包括网络操作(addMediaFilesToMinIO耗时长), 占用数据库资源, 在addMediaFilesToDB加@Transactional(去掉uploadFile的注解), 根据上面分析, 这样丧失了事务的作用</p><p><code>解决</code></p><p>在service类中注入一个当前类的代理对象currentProxy  , addMediaFilesToDB提到service接口层, 利用注入的方式调用</p><p>addMediaFilesToDB</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 注入MediaFileService代理对象</span><br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileService currentProxy;<br></code></pre></td></tr></table></figure><p>接口层</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">MediaFiles <span class="hljs-title function_">addMediaFilesToDB</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String objectName, String fileMD5, String bucket)</span>;<br></code></pre></td></tr></table></figure><p>实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> UploadFileResultDto <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span> &#123;<br>    <span class="hljs-comment">// 将文件上传minio</span><br>    <span class="hljs-comment">// 根据文件名得到扩展名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> uploadFileParamsDto.getFilename();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> getMimeType(extension);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> getMd5ByFilename(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(localFilePath));<br>    <span class="hljs-comment">// 约定objectName怎么存 -&gt; /年/月/日/md5.后缀</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> getDefaultFolderPath() + md5 + extension;<br>    <span class="hljs-comment">// 将文件上传到minio</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isUploadMinIO</span> <span class="hljs-operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_mediafiles, objectName);<br>    <span class="hljs-keyword">if</span> (!isUploadMinIO)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;上传文件到MinIO失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 将文件信息保存到DB</span><br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> currentProxy.addMediaFilesToDB(companyId, uploadFileParamsDto, md5, bucket_mediafiles, objectName);<br>    <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;文件上传后保存信息失败&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 准备返回的对象</span><br>    <span class="hljs-type">UploadFileResultDto</span> <span class="hljs-variable">uploadFileResultDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadFileResultDto</span>();<br>    BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);<br>    <span class="hljs-keyword">return</span> uploadFileResultDto;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 将文件信息保存到DB</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> companyId           机构id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> uploadFileParamsDto 上传文件的信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> md5                   md5</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> bucket                桶</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> objectName         对象名称</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">addMediaFilesToDB</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String md5, String bucket, String objectName)</span> &#123;<br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(md5);<br>    <span class="hljs-keyword">if</span> (mediaFiles==<span class="hljs-literal">null</span>)&#123;<br>        mediaFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFiles</span>();<br>        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);<br>        <span class="hljs-comment">// 文件id</span><br>        mediaFiles.setId(md5);<br>        <span class="hljs-comment">// 机构id</span><br>        mediaFiles.setCompanyId(companyId);<br>        <span class="hljs-comment">// 桶</span><br>        mediaFiles.setBucket(bucket);<br>        <span class="hljs-comment">// 对象名称</span><br>        mediaFiles.setFilePath(objectName);<br>        <span class="hljs-comment">// file_id</span><br>        mediaFiles.setFileId(md5);<br>        <span class="hljs-comment">// url 完整访问地址</span><br>        mediaFiles.setUrl(<span class="hljs-string">&quot;/&quot;</span>+bucket+<span class="hljs-string">&quot;/&quot;</span>+objectName);<br>        <span class="hljs-comment">// 上传时间</span><br>        mediaFiles.setCreateDate(LocalDateTime.now());<br>        <span class="hljs-comment">// 状态</span><br>        mediaFiles.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        <span class="hljs-comment">// 审核状态</span><br>        mediaFiles.setAuditStatus(<span class="hljs-string">&quot;002003&quot;</span>);<br>        <span class="hljs-comment">// 插入数据库</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> mediaFilesMapper.insert(mediaFiles);<br>        <span class="hljs-keyword">if</span> (insert&lt;=<span class="hljs-number">0</span>)&#123;<br>            log.debug(<span class="hljs-string">&quot;向数据库保存文件信息失败, bucket:&#123;&#125;, objectName: &#123;&#125;&quot;</span>, bucket, objectName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> mediaFiles;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>在updateFile添加@Transactional 调用updateFile方法开启数据库事务, 如果上传文件时间较长(上传超大的视频), 数据库事务持续时间变长, 数据库连接释放变慢, 导致数据库连接不够用</p><p>由于spring的动态代理机制, 不能只在 addMediaFilesToDB 加@Transactional即可</p><p>判断方法能否被事务控制?</p><ol><li>是不是通过代理对象调用的方法</li><li>该方法是否添加了@Transactional 注解</li></ol><p>我们需要通过代理对象去调用addMediaFilesToDB方法</p><p>非事务方法调用事务方法的解决:</p><p>在service类中注入当前类的代理对象, 将事务方法提到接口层,利用代理对象调用非事务方法</p></blockquote><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">### 上传文件<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>media_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/media/upload/coursefile<br>Content-Type<span class="hljs-punctuation">:</span> multipart/form-data; boundary=WebAppBoundary<br><br>--WebAppBoundary<br>Content-Disposition<span class="hljs-punctuation">:</span> form-data; name=<span class="hljs-string">&quot;filedata&quot;</span>; filename=<span class="hljs-string">&quot;1.jpg&quot;</span><br>Content-Type<span class="hljs-punctuation">:</span> application/octet-stream<br><br>&lt; d<span class="hljs-punctuation">:</span>/develop/upload/<span class="hljs-number">1.</span>jpg<br></code></pre></td></tr></table></figure><h4 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a>前后端联调</h4><blockquote><p>别忘了前端开启网关, 不然这里 404</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217161648811.png" alt="image-20231217161648811"></p></blockquote><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217161939939.png" alt="image-20231217161939939"></p><h4 id="bug修复"><a href="#bug修复" class="headerlink" title="bug修复"></a>bug修复</h4><p>媒资列表可以查看到上传的图片信息, 条件查询不起作用</p><p>缺少查询条件</p><p>修改MediaFileServiceImpl中的queryMediaFiles方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PageResult&lt;MediaFiles&gt; <span class="hljs-title function_">queryMediaFiles</span><span class="hljs-params">(Long companyId, PageParams pageParams, QueryMediaParamsDto queryMediaParamsDto)</span> &#123;<br><br>        <span class="hljs-comment">//构建查询条件对象</span><br>        LambdaQueryWrapper&lt;MediaFiles&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>+       queryWrapper.like(!StringUtils.isEmpty(queryMediaParamsDto.getFilename()), MediaFiles::getFilename, queryMediaParamsDto.getFilename());<br>+       queryWrapper.eq(!StringUtils.isEmpty(queryMediaParamsDto.getFileType()), MediaFiles::getFileType, queryMediaParamsDto.getFileType());<br>        <span class="hljs-comment">//分页对象</span><br>        Page&lt;MediaFiles&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());<br>        <span class="hljs-comment">// 查询数据内容获得结果</span><br>        Page&lt;MediaFiles&gt; pageResult = mediaFilesMapper.selectPage(page, queryWrapper);<br>        <span class="hljs-comment">// 获取数据列表</span><br>        List&lt;MediaFiles&gt; list = pageResult.getRecords();<br>        <span class="hljs-comment">// 获取数据总数</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> pageResult.getTotal();<br>        <span class="hljs-comment">// 构建结果集</span><br>        PageResult&lt;MediaFiles&gt; mediaListResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());<br>        <span class="hljs-keyword">return</span> mediaListResult;<br><br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="上传视频"><a href="#上传视频" class="headerlink" title="上传视频"></a>上传视频</h3><h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217145801454.png" alt="image-20231217145801454"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217145813948.png" alt="image-20231217145813948"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162114895.png" alt="image-20231217162114895"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162124359.png" alt="image-20231217162124359"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162132320.png" alt="image-20231217162132320"></p><h4 id="断点续传技术"><a href="#断点续传技术" class="headerlink" title="断点续传技术"></a>断点续传技术</h4><blockquote><p>通常视频比较大, 对于媒资系统需求要满足大文件上传要求, http协议对上传文件没有限制, 但是客户的网络环境质量, 电脑配置如果较差, 大文件快传完了突然断网了, 需要重新上传, 用户体验差, 所以对于大文件需要支持<code>断点续传</code></p><p>什么是 断点续传?</p><p>在下载或上传时, 将下载和上传任务人为的<code>划分成几个部分</code>, 每<code>一个部分</code>采用<code>一个线程</code>进行上传或下载, 如果网络故障, 可以从上传或下载的部分可是继续上传下载未完成的部分, 不用从头开始上传下载, 节省操作时间, 提高用户体验</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162624649.png" alt="image-20231217162624649"></p><ol><li>前端上传前把文件分成块</li><li>一块一块的上传, 上传中断后重新上传, 已上传分块不用再上传</li><li>各分块上传完成最后在服务端合并</li></ol></blockquote><h5 id="测试本地分块上传-合并和清理"><a href="#测试本地分块上传-合并和清理" class="headerlink" title="测试本地分块上传,合并和清理"></a>测试<code>本地</code>分块上传,合并和清理</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media;<br><br><span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.RandomAccessFile;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 大文件测试</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/17 16:33</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigFileTest</span> &#123;<br><br>    <span class="hljs-comment">// 文件分块</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testChunk</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">sourceFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>); <span class="hljs-comment">// 源文件</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">chunkSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1</span>; <span class="hljs-comment">//分块大小1MB</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">chunkNum</span> <span class="hljs-operator">=</span> (<span class="hljs-type">long</span>) Math.ceil(sourceFile.length() * <span class="hljs-number">1.0</span> / chunkSize); <span class="hljs-comment">//分块数量</span><br>        System.out.println(<span class="hljs-string">&quot;分块数量: &quot;</span> + chunkNum);<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">//缓冲区</span><br>        <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(sourceFile, <span class="hljs-string">&quot;r&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; chunkNum; i++) &#123;<br>            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\chunk\\&quot;</span> + i);<br>            <span class="hljs-keyword">if</span> (file.createNewFile()) &#123;<br>                <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">rw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(file, <span class="hljs-string">&quot;rw&quot;</span>);<br>                rw.seek(<span class="hljs-number">0</span>); <span class="hljs-comment">//指针指向文件顶端</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">while</span> ((len = r.read(buffer)) != -<span class="hljs-number">1</span>) &#123; <span class="hljs-comment">//len=1024</span><br>                    rw.write(buffer, <span class="hljs-number">0</span>, len); <span class="hljs-comment">//向这个分块写入数据</span><br>                    <span class="hljs-keyword">if</span> (file.length() &gt;= chunkSize) <span class="hljs-keyword">break</span>; <span class="hljs-comment">//写满1024</span><br>                &#125;<br>                rw.close();<br>                System.out.println(<span class="hljs-string">&quot;分块&quot;</span> + i + <span class="hljs-string">&quot;写入完成&quot;</span>);<br>            &#125;<br>        &#125;<br>        r.close();<br>        System.out.println(<span class="hljs-string">&quot;所有分块写入完成&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-comment">// 块文件合并</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMerge</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">sourceFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">chunkFolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\chunk\\&quot;</span>);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">mergeFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx2.mp4&quot;</span>);<br>        <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">rw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(mergeFile, <span class="hljs-string">&quot;rw&quot;</span>);<br>        rw.seek(<span class="hljs-number">0</span>);<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        List&lt;File&gt; chunkList = Arrays.asList(chunkFolder.listFiles());<br>        chunkList.sort(Comparator.comparing(o -&gt; Integer.parseInt(o.getName()))); <span class="hljs-comment">//从小到大排序</span><br><br>        <span class="hljs-keyword">for</span> (File chunkFile : chunkList) &#123;<br>            <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(chunkFile, <span class="hljs-string">&quot;r&quot;</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span> ((len = r.read(buffer)) != -<span class="hljs-number">1</span>) &#123;<br>                rw.write(buffer, <span class="hljs-number">0</span>, len);<br>            &#125;<br>            r.close();<br>        &#125;<br>        rw.close();<br>        <span class="hljs-comment">//校验文件</span><br>        <span class="hljs-keyword">try</span> (<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(sourceFile);<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">mergeFileStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(mergeFile);<br>        ) &#123;<br>            <span class="hljs-comment">//取出原始文件的md5</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">originalMd5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(fileInputStream);<br>            <span class="hljs-comment">//取出合并文件的md5进行比较</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">mergeFileMd5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(mergeFileStream);<br>            <span class="hljs-keyword">if</span> (originalMd5.equals(mergeFileMd5)) &#123;<br>                System.out.println(<span class="hljs-string">&quot;合并文件成功&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;合并文件失败&quot;</span>);<br>            &#125;<br><br>        &#125;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="测试minio上传-合并和清理"><a href="#测试minio上传-合并和清理" class="headerlink" title="测试minio上传,合并和清理"></a>测试<code>minio</code>上传,合并和清理</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media;<br><br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfo;<br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfoUtil;<br><span class="hljs-keyword">import</span> io.minio.*;<br><span class="hljs-keyword">import</span> io.minio.messages.DeleteError;<br><span class="hljs-keyword">import</span> io.minio.messages.DeleteObject;<br><span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.FilterInputStream;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><span class="hljs-keyword">import</span> java.util.stream.Stream;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/16 20:44</span><br><span class="hljs-comment"> * 测试 MinIO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinioTest</span> &#123;<br><br>    <span class="hljs-comment">// 准备minio客户端</span><br>    <span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span> MinioClient.builder()<br>            .endpoint(<span class="hljs-string">&quot;http://192.168.101.65:9000&quot;</span>)<br>            .credentials(<span class="hljs-string">&quot;minioadmin&quot;</span>, <span class="hljs-string">&quot;minioadmin&quot;</span>)<br>            .build();<br><br><br>    <span class="hljs-comment">// 上传文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">upload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">// 通过扩展名取出mimeType</span><br>        <span class="hljs-type">ContentInfo</span> <span class="hljs-variable">extensionMatch</span> <span class="hljs-operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="hljs-string">&quot;.mp4&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE; <span class="hljs-comment">// 通用mimeType, 字节流</span><br>        <span class="hljs-keyword">if</span> (extensionMatch != <span class="hljs-literal">null</span>) &#123;<br>            mimeType = extensionMatch.getMimeType();<br>        &#125;<br><br>        <span class="hljs-comment">// 上传文件的参数信息</span><br>        <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>) <span class="hljs-comment">//桶</span><br>                .filename(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>) <span class="hljs-comment">//本地文件路径</span><br>                <span class="hljs-comment">// .object(&quot;lqx.mp4&quot;) //对象名</span><br>                .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                .contentType(mimeType)<br>                .build();<br><br>        <span class="hljs-comment">// 上传文件</span><br>        minioClient.uploadObject(uploadObjectArgs);<br><br>    &#125;<br><br>    <span class="hljs-comment">// 删除文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">RemoveObjectArgs</span> <span class="hljs-variable">removeObjectArgs</span> <span class="hljs-operator">=</span> RemoveObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>)<br>                .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                .build();<br>        minioClient.removeObject(removeObjectArgs);<br>    &#125;<br><br><br>    <span class="hljs-comment">// 查询文件: 从minio下载文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">get</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">GetObjectArgs</span> <span class="hljs-variable">getObjectArgs</span> <span class="hljs-operator">=</span> GetObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>)<br>                .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                .build();<br>        <span class="hljs-comment">// GetObjectResponse extends FilterInputStream</span><br>        <span class="hljs-comment">// 查询远程服务获取一个流对象</span><br>        <span class="hljs-type">FilterInputStream</span> <span class="hljs-variable">filterInputStream</span> <span class="hljs-operator">=</span> minioClient.getObject(getObjectArgs);<br>        <span class="hljs-comment">// 指定输出流</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\output\\lqx.mp4&quot;</span>);<br>        <span class="hljs-comment">// 拷贝流</span><br>        IOUtils.copy(filterInputStream, outputStream);<br><br><br>        <span class="hljs-comment">// 校验文件完整性, 对文件的内容进行md5校验(上传和下载过程出现网络丢包, 所以需要进行md5校验)</span><br>        <span class="hljs-comment">// 这里source_md5不能用filterInputStream, 网络文件的md5不稳定, 要用原始文件(传之前硬盘文件)的md5</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">source_md5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">local_md5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\output\\lqx.mp4&quot;</span>));<br>        <span class="hljs-keyword">if</span> (source_md5.equals(local_md5)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;下载成功&quot;</span>);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">// 分块文件上传到minio</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">chunkUpload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; i++) &#123;<br>            <span class="hljs-comment">// 上传文件的参数信息</span><br>            <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>                    .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>) <span class="hljs-comment">//桶</span><br>                    .filename(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\chunk\\&quot;</span> + i) <span class="hljs-comment">//本地文件路径</span><br>                    .object(<span class="hljs-string">&quot;chunk/&quot;</span> + i)<br>                    .build();<br><br>            <span class="hljs-comment">// 上传文件</span><br>            minioClient.uploadObject(uploadObjectArgs);<br>            System.out.println(<span class="hljs-string">&quot;上传分块&quot;</span> + i + <span class="hljs-string">&quot;成功&quot;</span>);<br>        &#125;<br><br><br>    &#125;<br><br>    <span class="hljs-comment">// 调用minio接口合并分块</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">merge</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">/*List&lt;ComposeSource&gt; sources = new ArrayList&lt;&gt;();</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        for (int i = 0; i &lt; 6; i++) &#123;</span><br><span class="hljs-comment">            ComposeSource composeSource = ComposeSource.builder()</span><br><span class="hljs-comment">                    .bucket(&quot;testbucket&quot;)</span><br><span class="hljs-comment">                    .object(&quot;chunk/&quot; + i)</span><br><span class="hljs-comment">                    .build();</span><br><span class="hljs-comment">            sources.add(composeSource);</span><br><span class="hljs-comment">        &#125;*/</span><br><br>        List&lt;ComposeSource&gt; sources = Stream.iterate(<span class="hljs-number">0</span>, i -&gt; ++i).limit(<span class="hljs-number">6</span>)<br>                .map(i -&gt; ComposeSource.builder().bucket(<span class="hljs-string">&quot;testbucket&quot;</span>).object(<span class="hljs-string">&quot;chunk/&quot;</span> + i).build())<br>                .collect(Collectors.toList());<br><br><br>        <span class="hljs-type">ComposeObjectArgs</span> <span class="hljs-variable">composeObjectArgs</span> <span class="hljs-operator">=</span> ComposeObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>)<br>                .sources(sources)<br>                .object(<span class="hljs-string">&quot;mergeLqx.mp4&quot;</span>)<br>                .build();<br>        minioClient.composeObject(composeObjectArgs);<br>        System.out.println(<span class="hljs-string">&quot;合并成功&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-comment">// 清理分块</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeChunk</span><span class="hljs-params">()</span> &#123;<br><br>        List&lt;DeleteObject&gt; deleteObjects = Stream.iterate(<span class="hljs-number">0</span>, i -&gt; ++i).limit(<span class="hljs-number">6</span>)<br>                .map(i -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteObject</span>(<span class="hljs-string">&quot;chunk/&quot;</span> + i)).collect(Collectors.toList());<br><br><br>        <span class="hljs-type">RemoveObjectsArgs</span> <span class="hljs-variable">removeObjectsArgs</span> <span class="hljs-operator">=</span> RemoveObjectsArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>).objects(deleteObjects).build();<br>        minioClient.removeObjects(removeObjectsArgs);<br>        Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);<br>        results.forEach(r-&gt;&#123;<br>            <span class="hljs-type">DeleteError</span> <span class="hljs-variable">deleteError</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                deleteError = r.get();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;);<br><br>    &#125;<br><br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="上传视频流程"><a href="#上传视频流程" class="headerlink" title="上传视频流程"></a>上传视频流程</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217173010850.png" alt="image-20231217173010850"></p><ol><li>前端上传文件前, 请求媒资接口层检查文件是否存在<ol><li>若存在,则不再上传</li><li>若不存在, 则开始上传, 首先对视频文件进行分块</li></ol></li><li>前端分块进行上传, 上传前首先检查分块是否已经存在<ol><li>若分块已存在, 则不再上传</li><li>若分块不存在, 则开始上传分块</li></ol></li><li>前端请求媒资管理接口层, 请求上传分块</li><li>接口层请求服务层上传分块</li><li>服务端将分块信息上传到minio</li><li>前端将分块上传完毕, 请求接口层合并分块</li><li>接口层请求服务层合并分块</li><li>服务层根据文件信息找到minio中的分块文件, 下载到本地临时目录, 将所有分块下载完毕后开始合并</li><li>合并完成后, 将合并后的文件上传到minio</li></ol><h4 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h4><p>操作成功返回</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>操作失败返回</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.dto.UploadFileParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 上传视频</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/17 18:04</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = &quot;大文件上传接口&quot;, tags = &quot;大文件上传接口&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigFilesController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileService mediaFileService;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;文件上传前检查文件&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/upload/checkfile&quot;)</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkfile</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5)</span>&#123;<br>        <span class="hljs-keyword">return</span> mediaFileService.checkfile(fileMd5);<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;文件上传前检查分块&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkchunk</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span>String fileMd5,</span><br><span class="hljs-params">                                            <span class="hljs-meta">@RequestParam(&quot;chunk&quot;)</span><span class="hljs-type">int</span> chunk)</span>&#123;<br>        <span class="hljs-keyword">return</span> mediaFileService.checkchunk(fileMd5, chunk);<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;上传分块文件&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span><br>    <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">uploadchunk</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span><br><span class="hljs-params">                                             <span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span>String fileMd5,</span><br><span class="hljs-params">                                             <span class="hljs-meta">@RequestParam(&quot;chunk&quot;)</span><span class="hljs-type">int</span> chunk)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">tempFile</span> <span class="hljs-operator">=</span> File.createTempFile(<span class="hljs-string">&quot;minio&quot;</span>, <span class="hljs-string">&quot;.temp&quot;</span>);<span class="hljs-comment">//创建临时文件</span><br>        file.transferTo(tempFile);<span class="hljs-comment">//文件转换</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">localFilePath</span> <span class="hljs-operator">=</span> tempFile.getAbsolutePath();<span class="hljs-comment">//获取绝对路径 此时文件在tomcat</span><br>        <span class="hljs-keyword">return</span> mediaFileService.uploadchunk(fileMd5, chunk, localFilePath);<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;合并分块文件&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span><br>    <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">mergechunks</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span>String fileMd5,</span><br><span class="hljs-params">                                             <span class="hljs-meta">@RequestParam(&quot;fileName&quot;)</span>String fileName,</span><br><span class="hljs-params">                                             <span class="hljs-meta">@RequestParam(&quot;chunkTotal&quot;)</span><span class="hljs-type">int</span> chunkTotal)</span>&#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br>        <span class="hljs-type">UploadFileParamsDto</span> <span class="hljs-variable">uploadFileParamsDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadFileParamsDto</span>();<br>        uploadFileParamsDto.setFilename(fileName);<br>        uploadFileParamsDto.setTags(<span class="hljs-string">&quot;视频文件&quot;</span>);<br>        uploadFileParamsDto.setFileType(<span class="hljs-string">&quot;001002&quot;</span>);<br>        <span class="hljs-keyword">return</span> mediaFileService.mergechunk(companyId, fileMd5, chunkTotal, uploadFileParamsDto);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p>service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;<br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfo;<br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfoUtil;<br><span class="hljs-keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PagesParams;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.media.mapper.MediaFilesMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.media.mapper.MediaProcessHistoryMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.media.mapper.MediaProcessMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.dto.QueryMediaParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.dto.UploadFileParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.dto.UploadFileResultDto;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaFiles;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaProcess;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaProcessHistory;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileService;<br><span class="hljs-keyword">import</span> io.minio.*;<br><span class="hljs-keyword">import</span> io.minio.messages.DeleteError;<br><span class="hljs-keyword">import</span> io.minio.messages.DeleteObject;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><span class="hljs-keyword">import</span> java.util.stream.Stream;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/10 8:58</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaFileServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MediaFileService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaFilesMapper mediaFilesMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaProcessMapper mediaProcessMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaProcessHistoryMapper mediaProcessHistoryMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MinioClient minioClient;<br><br>    <span class="hljs-comment">// 注入MediaFileService代理对象</span><br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileService currentProxy;<br><br><br>    <span class="hljs-comment">// 从配置文件获取bucket</span><br>    <span class="hljs-comment">// 存储普通文件</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;minio.bucket.files&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String bucket_mediafiles;<br>    <span class="hljs-comment">// 存储视频</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;minio.bucket.videofiles&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String bucket_video;<br><br>    <span class="hljs-comment">// 查询媒体信息</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PageResult&lt;MediaFiles&gt; <span class="hljs-title function_">queryMediaFiels</span><span class="hljs-params">(Long companyId, PagesParams pageParams,</span><br><span class="hljs-params">                                                  QueryMediaParamsDto queryMediaParamsDto)</span> &#123;<br><br>        <span class="hljs-comment">//构建查询条件对象</span><br>        LambdaQueryWrapper&lt;MediaFiles&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        queryWrapper.like(!StringUtils.isEmpty(queryMediaParamsDto.getFilename()), MediaFiles::getFilename, queryMediaParamsDto.getFilename());<br>        queryWrapper.eq(!StringUtils.isEmpty(queryMediaParamsDto.getFileType()), MediaFiles::getFileType, queryMediaParamsDto.getFileType());<br>        <span class="hljs-comment">//分页对象</span><br>        Page&lt;MediaFiles&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());<br>        <span class="hljs-comment">// 查询数据内容获得结果</span><br>        Page&lt;MediaFiles&gt; pageResult = mediaFilesMapper.selectPage(page, queryWrapper);<br>        <span class="hljs-comment">// 获取数据列表</span><br>        List&lt;MediaFiles&gt; list = pageResult.getRecords();<br>        <span class="hljs-comment">// 获取数据总数</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> pageResult.getTotal();<br>        <span class="hljs-comment">// 构建结果集</span><br>        PageResult&lt;MediaFiles&gt; mediaListResult =<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());<br>        <span class="hljs-keyword">return</span> mediaListResult;<br><br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自动生成目录</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> year  是否包含年</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> month 是否包含月</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> day   是否包含天</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> stringBuffer</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getFilder</span><span class="hljs-params">(<span class="hljs-type">boolean</span> year, <span class="hljs-type">boolean</span> month, <span class="hljs-type">boolean</span> day)</span> &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">stringBuffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">dateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dateString</span> <span class="hljs-operator">=</span> dateFormat.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        String[] split = dateString.split(<span class="hljs-string">&quot;-&quot;</span>);<br>        <span class="hljs-keyword">if</span> (year) &#123;<br>            stringBuffer.append(split[<span class="hljs-number">0</span>]).append(<span class="hljs-string">&quot;/&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (month) &#123;<br>            stringBuffer.append(split[<span class="hljs-number">1</span>]).append(<span class="hljs-string">&quot;/&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (day) &#123;<br>            stringBuffer.append(split[<span class="hljs-number">2</span>]).append(<span class="hljs-string">&quot;/&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> stringBuffer.toString();<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">getPlayUrlByMediaId</span><span class="hljs-params">(String mediaId)</span> &#123;<br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(mediaId);<br>        <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span> || StringUtils.isEmpty(mediaFiles.getUrl())) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;视频没有转码处理&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> mediaFiles;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startTask</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> mediaProcessMapper.startTask(id);<br>        <span class="hljs-keyword">return</span> result &lt;= <span class="hljs-number">0</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 保存进程完成状态</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveProcessFinishStatus</span><span class="hljs-params">(Long taskId, String status, String fileId, String url, String errorMsg)</span> &#123;<br>        <span class="hljs-comment">// 查出任务, 如果不存在则直接返回</span><br>        <span class="hljs-type">MediaProcess</span> <span class="hljs-variable">mediaProcess</span> <span class="hljs-operator">=</span> mediaProcessMapper.selectById(taskId);<br>        <span class="hljs-keyword">if</span> (mediaProcess == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 处理失败, 更新任务处理结果</span><br>        LambdaQueryWrapper&lt;MediaProcess&gt; queryWrapperById = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;MediaProcess&gt;()<br>                .eq(MediaProcess::getId, taskId);<br>        <span class="hljs-comment">// 处理失败</span><br>        <span class="hljs-keyword">if</span> (status.equals(<span class="hljs-string">&quot;3&quot;</span>)) &#123;<br>            <span class="hljs-type">MediaProcess</span> <span class="hljs-variable">mediaProcess_u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaProcess</span>();<br>            mediaProcess_u.setStatus(<span class="hljs-string">&quot;3&quot;</span>);<br>            mediaProcess_u.setErrormsg(errorMsg);<br>            mediaProcess_u.setFailCount(mediaProcess.getFailCount() + <span class="hljs-number">1</span>);<br>            mediaProcessMapper.update(mediaProcess_u, queryWrapperById);<br>            log.debug(<span class="hljs-string">&quot;更新任务处理状态为失败, 任务信息:&#123;&#125;&quot;</span>, mediaProcess_u);<br>        &#125;<br>        <span class="hljs-comment">// 任务处理成功</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(fileId);<br>        <span class="hljs-keyword">if</span> (mediaFiles != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 更新媒资文件里的url</span><br>            mediaFiles.setUrl(url);<br>            mediaFilesMapper.updateById(mediaFiles);<br>        &#125;<br>        <span class="hljs-comment">// 处理成功, 更新url和状态</span><br>        mediaProcess.setUrl(url);<br>        mediaProcess.setStatus(<span class="hljs-string">&quot;2&quot;</span>);<br>        mediaProcess.setFinishDate(LocalDateTime.now());<br>        mediaProcessMapper.updateById(mediaProcess);<br><br>        <span class="hljs-comment">// 添加历史记录</span><br>        <span class="hljs-type">MediaProcessHistory</span> <span class="hljs-variable">mediaProcessHistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaProcessHistory</span>();<br>        BeanUtils.copyProperties(mediaProcess, mediaProcessHistory);<br>        mediaProcessHistoryMapper.insert(mediaProcessHistory);<br>        <span class="hljs-comment">// 删除mediaProcess</span><br>        mediaProcessMapper.deleteById(mediaProcess.getId());<br><br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UploadFileResultDto <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span> &#123;<br>        <span class="hljs-comment">// 将文件上传minio</span><br>        <span class="hljs-comment">// 根据文件名得到扩展名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> uploadFileParamsDto.getFilename();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> getMimeType(extension);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> getMd5ByFilename(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(localFilePath));<br>        <span class="hljs-comment">// 约定objectName怎么存 -&gt; /年/月/日/md5.后缀</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> getDefaultFolderPath() + md5 + extension;<br>        <span class="hljs-comment">// 将文件上传到minio</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isUploadMinIO</span> <span class="hljs-operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_mediafiles, objectName);<br>        <span class="hljs-keyword">if</span> (!isUploadMinIO) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;上传文件到MinIO失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 将文件信息保存到DB</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> currentProxy.addMediaFilesToDB(companyId, uploadFileParamsDto, md5, bucket_mediafiles, objectName);<br>        <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;文件上传后保存信息失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 准备返回的对象</span><br>        <span class="hljs-type">UploadFileResultDto</span> <span class="hljs-variable">uploadFileResultDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadFileResultDto</span>();<br>        BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);<br>        <span class="hljs-keyword">return</span> uploadFileResultDto;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将文件信息保存到DB</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> companyId           机构id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> uploadFileParamsDto 上传文件的信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> md5                 md5</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bucket              桶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> objectName          对象名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">addMediaFilesToDB</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String md5, String bucket, String objectName)</span> &#123;<br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(md5);<br>        <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>            mediaFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFiles</span>();<br>            BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);<br>            <span class="hljs-comment">// 文件id</span><br>            mediaFiles.setId(md5);<br>            <span class="hljs-comment">// 机构id</span><br>            mediaFiles.setCompanyId(companyId);<br>            <span class="hljs-comment">// 桶</span><br>            mediaFiles.setBucket(bucket);<br>            <span class="hljs-comment">// 对象名称</span><br>            mediaFiles.setFilePath(objectName);<br>            <span class="hljs-comment">// file_id</span><br>            mediaFiles.setFileId(md5);<br>            <span class="hljs-comment">// url 完整访问地址</span><br>            mediaFiles.setUrl(<span class="hljs-string">&quot;/&quot;</span> + bucket + <span class="hljs-string">&quot;/&quot;</span> + objectName);<br>            <span class="hljs-comment">// 上传时间</span><br>            mediaFiles.setCreateDate(LocalDateTime.now());<br>            <span class="hljs-comment">// 状态</span><br>            mediaFiles.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>            <span class="hljs-comment">// 审核状态</span><br>            mediaFiles.setAuditStatus(<span class="hljs-string">&quot;002003&quot;</span>);<br>            <span class="hljs-comment">// 插入数据库</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> mediaFilesMapper.insert(mediaFiles);<br>            <span class="hljs-keyword">if</span> (insert &lt;= <span class="hljs-number">0</span>) &#123;<br>                log.debug(<span class="hljs-string">&quot;向数据库保存文件信息失败, bucket:&#123;&#125;, objectName: &#123;&#125;&quot;</span>, bucket, objectName);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> mediaFiles;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取文件默认存储目录路径     年/月/日/   2023-12-19 -&gt; 2023/12/19/</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getDefaultFolderPath</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">folder</span> <span class="hljs-operator">=</span> sdf.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>) + <span class="hljs-string">&quot;/&quot;</span>;<br>        <span class="hljs-keyword">return</span> folder;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取文件md5</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMd5ByFilename</span><span class="hljs-params">(File file)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileMd5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(fileInputStream);<br>            <span class="hljs-keyword">return</span> fileMd5;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">// 通过扩展名取出mimeType      .mp4 -&gt; video/mp4</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMimeType</span><span class="hljs-params">(String extension)</span> &#123;<br>        <span class="hljs-keyword">if</span> (extension == <span class="hljs-literal">null</span>) &#123;<br>            extension = <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        <span class="hljs-type">ContentInfo</span> <span class="hljs-variable">extensionMatch</span> <span class="hljs-operator">=</span> ContentInfoUtil.findExtensionMatch(extension);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE; <span class="hljs-comment">// 通用mimeType, 字节流</span><br>        <span class="hljs-keyword">if</span> (extensionMatch != <span class="hljs-literal">null</span>) &#123;<br>            mimeType = extensionMatch.getMimeType();<br>        &#125;<br>        <span class="hljs-keyword">return</span> mimeType;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将文件上传到minio</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> localFilePath 本地文件路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mimeType      媒体类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bucket        桶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> objectName    对象名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addMediaFilesToMinIO</span><span class="hljs-params">(String localFilePath, String mimeType, String bucket, String objectName)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 准备上传文件的参数信息</span><br>            <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>                    .bucket(bucket) <span class="hljs-comment">//桶</span><br>                    .filename(localFilePath) <span class="hljs-comment">//本地文件路径</span><br>                    .object(objectName) <span class="hljs-comment">// 对象名</span><br>                    .contentType(mimeType)<br>                    .build();<br>            minioClient.uploadObject(uploadObjectArgs); <span class="hljs-comment">// 上传</span><br>            log.debug(<span class="hljs-string">&quot;上传文件到minio成功, bucket:&#123;&#125;, objectName:&#123;&#125;&quot;</span>, bucket, objectName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            log.error(<span class="hljs-string">&quot;上传文件到minio出错, bucket:&#123;&#125;, objectName:&#123;&#125;, 错误信息:&#123;&#125;&quot;</span>, bucket, objectName, e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkfile</span><span class="hljs-params">(String fileMd5)</span> &#123;<br>        <span class="hljs-comment">// 先查询数据库</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(fileMd5);<br>        <span class="hljs-keyword">if</span> (mediaFiles != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 如果数据库存在则查询minio</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">bucket</span> <span class="hljs-operator">=</span> mediaFiles.getBucket();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> mediaFiles.getFilePath();<br>            <span class="hljs-type">GetObjectArgs</span> <span class="hljs-variable">getObjectArgs</span> <span class="hljs-operator">=</span> GetObjectArgs.builder()<br>                    .bucket(bucket)<br>                    .object(filePath)<br>                    .build();<br>            <span class="hljs-comment">// 查询远程服务获取一个流对象</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">FilterInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> minioClient.getObject(getObjectArgs);<br>                <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">// 文件在DB和minio都有，不用干活了</span><br>                    <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkchunk</span><span class="hljs-params">(String fileMd5, <span class="hljs-type">int</span> chunkIndex)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">chunkFileFolderPath</span> <span class="hljs-operator">=</span> getChunkFileFolderPath(fileMd5);<br><br>        <span class="hljs-type">GetObjectArgs</span> <span class="hljs-variable">getObjectArgs</span> <span class="hljs-operator">=</span> GetObjectArgs.builder()<br>                .bucket(bucket_video)<br>                .object(chunkFileFolderPath + chunkIndex)<br>                .build();<br>        <span class="hljs-comment">// 查询远程服务获取一个流对象</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FilterInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> minioClient.getObject(getObjectArgs);<br>            <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 分块在minio都有，不用干活了</span><br>                <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>        &#125;<br>        <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 得到分块文件目录</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getFilePathByMd5</span><span class="hljs-params">(String fileMd5,String fileExt)</span> &#123;<br>        <span class="hljs-keyword">return</span> fileMd5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5.substring(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + fileExt;<br>    &#125;<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getChunkFileFolderPath</span><span class="hljs-params">(String fileMd5)</span> &#123;<br>        <span class="hljs-keyword">return</span> fileMd5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5.substring(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + <span class="hljs-string">&quot;/&quot;</span> + <span class="hljs-string">&quot;chunk&quot;</span> + <span class="hljs-string">&quot;/&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">uploadchunk</span><span class="hljs-params">(String fileMd5, <span class="hljs-type">int</span> chunk, String localChunkFilePath)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">chunkFilePath</span> <span class="hljs-operator">=</span> getChunkFileFolderPath(fileMd5) + chunk;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> getMimeType(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// 将分块上传到minio</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isUpload</span> <span class="hljs-operator">=</span> addMediaFilesToMinIO(localChunkFilePath, mimeType, bucket_video, chunkFilePath);<br>        <span class="hljs-keyword">if</span> (!isUpload) &#123;<br>            <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;上传文件失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">mergechunk</span><span class="hljs-params">(Long companyId, String fileMd5, <span class="hljs-type">int</span> chunkTotal, UploadFileParamsDto uploadFileParamsDto)</span> &#123;<br>        <span class="hljs-comment">// 合并-&gt;校验-&gt;入库-&gt;清理</span><br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">chunkFileFolderPath</span> <span class="hljs-operator">=</span> getChunkFileFolderPath(fileMd5);<br>        <span class="hljs-comment">//找到所有的分块文件调用minio的sdk进行文件合并</span><br>        List&lt;ComposeSource&gt; sources = Stream.iterate(<span class="hljs-number">0</span>, i -&gt; ++i).limit(chunkTotal)<br>                .map(i -&gt; ComposeSource.builder().bucket(bucket_video).object(chunkFileFolderPath + i).build())<br>                .collect(Collectors.toList());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> uploadFileParamsDto.getFilename();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileExt</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> getFilePathByMd5(fileMd5, fileExt);<br>        <span class="hljs-type">ComposeObjectArgs</span> <span class="hljs-variable">composeObjectArgs</span> <span class="hljs-operator">=</span> ComposeObjectArgs.builder()<br>                .bucket(bucket_video)<br>                .sources(sources)<br>                .object(objectName)<span class="hljs-comment">//合并后文件objectName</span><br>                .build();<br>        <span class="hljs-keyword">try</span> &#123;<br>            minioClient.composeObject(composeObjectArgs);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            log.error(<span class="hljs-string">&quot;合并文件出错,bucket:&#123;&#125;,objectName:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>,bucket_video,objectName,e.getMessage());<br>            <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;合并文件异常&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//校验合并的文件和源文件是否一致，视频上传才成功</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> downloadFileFromMinIO(bucket_video, objectName);<br>        <span class="hljs-comment">//文件大小</span><br>        uploadFileParamsDto.setFileSize(file.length());<br><br><br><br>        <span class="hljs-comment">//计算合并后文件md5</span><br>        <span class="hljs-keyword">try</span>(<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">mergeFile_md5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(fileInputStream);<br>            <span class="hljs-comment">//比较原始md5和合并后文件md5</span><br>            <span class="hljs-keyword">if</span> (!fileMd5.equals(mergeFile_md5))&#123;<br>                log.error(<span class="hljs-string">&quot;校验合并文件的md5值不一致,原始md5：&#123;&#125;,合并md5:&#123;&#125;&quot;</span>,fileMd5, mergeFile_md5);<br>                <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;文件校验失败&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;文件校验失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//将文件信息入库</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> currentProxy.addMediaFilesToDB(companyId, uploadFileParamsDto, fileMd5, bucket_video, objectName);<br>        <span class="hljs-keyword">if</span>(mediaFiles==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;文件入库失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//清理分块文件</span><br>        clearChunkFiles(chunkFileFolderPath, chunkTotal);<br><br>        <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//从minio下载文件</span><br>    <span class="hljs-keyword">public</span> File <span class="hljs-title function_">downloadFileFromMinIO</span><span class="hljs-params">(String bucket, String objectName)</span>&#123;<br>        <span class="hljs-comment">// 临时文件</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">minioFile</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> minioClient.getObject(GetObjectArgs.builder().bucket(bucket).object(objectName).build());<br>            <span class="hljs-comment">// 创建临时文件</span><br>            minioFile = File.createTempFile(<span class="hljs-string">&quot;minio&quot;</span>, <span class="hljs-string">&quot;.merge&quot;</span>);<br>            outputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(minioFile);<br>            IOUtils.copy(stream, outputStream);<br>            <span class="hljs-keyword">return</span> minioFile;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (outputStream!=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    outputStream.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//清理分块文件</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearChunkFiles</span><span class="hljs-params">(String chunkFileFolderPath, <span class="hljs-type">int</span> chunkTotal)</span>&#123;<br>        List&lt;DeleteObject&gt; deleteObjects = Stream.iterate(<span class="hljs-number">0</span>, i -&gt; ++i).limit(chunkTotal)<br>                .map(i -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteObject</span>(chunkFileFolderPath+i)).collect(Collectors.toList());<br>        <span class="hljs-type">RemoveObjectsArgs</span> <span class="hljs-variable">removeObjectsArgs</span> <span class="hljs-operator">=</span> RemoveObjectsArgs.builder().bucket(bucket_video).objects(deleteObjects).build();<br>        Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);<br>        <span class="hljs-comment">// 还没删, 需要遍历一下</span><br>        <span class="hljs-keyword">for</span> (Result&lt;DeleteError&gt; result : results) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">DeleteError</span> <span class="hljs-variable">deleteError</span> <span class="hljs-operator">=</span> result.get();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>视频上传大小限制, 默认1MB</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">multipart:</span><br>      <span class="hljs-attr">max-file-size:</span> <span class="hljs-string">50MB</span><br>      <span class="hljs-attr">max-request-size:</span> <span class="hljs-string">50MB</span><br></code></pre></td></tr></table></figure><h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220155342270.png" alt="image-20231220155342270"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217215739463.png" alt="image-20231217215739463"></p><h3 id="文件预览"><a href="#文件预览" class="headerlink" title="文件预览"></a>文件预览</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(value = &quot;预览文件&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/preview/&#123;mediaId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> RestResponse&lt;String&gt; <span class="hljs-title function_">getPlayUrlByMediaId</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String mediaId)</span> &#123;<br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFileService.getPlayUrlByMediaId(mediaId);<br>    <span class="hljs-keyword">return</span> RestResponse.success(mediaFiles.getUrl());<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">getPlayUrlByMediaId</span><span class="hljs-params">(String mediaId)</span> &#123;<br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(mediaId);<br>    <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span> || StringUtils.isEmpty(mediaFiles.getUrl()))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;视频没有转码处理&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> mediaFiles;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><strong>面试</strong></p><ol><li><p>什么情况Spring事务失效?</p><ol><li>方法中捕获异常没有抛出</li><li>非事务方法调用事务方法</li><li>事务内部调用事务方法</li><li>@Transactional 标记的方法不是public</li><li>抛出的异常与rollbackFor指定的异常不匹配, 默认rollbackFor指定的异常为RuntimeException</li><li>数据库表不支持事务, 比如MySQL的MyISAM</li><li>Spring的传播行为导致事务失效, 比如: PROPAGATION_NEVER PROPAGTION_NOT_SUPPORTED</li></ol><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220190016041.png" alt="image-20231220190016041"></p><ol start="2"><li><p>断点续传是怎么做的?</p><p>我们基于分块上传的模式实现断点续传需求,当文件上传一部分断网后已经上传过的不再上传</p><ol><li><p>前端对文件分块</p></li><li><p>前端使用多线程一块块上传,上传前给服务端发一个消息校验该分块是否上传,如果已上传则不再上传</p></li><li><p>等所有分块上传完毕,服务端合并所有分块,校验文件的完整性</p><p>因为分块全部上传到了服务器,服务器将所有分块按顺序合并,就是写每个分块文件内容按顺序依次写入一个文件中， 使用字节流去读写文件</p></li><li><p>前端给服务传入一个md5值,服务端合并文件后计算合并后文件的md5是否和前端传的一样, 如果一样则说文件完整,如果不一样则由于网络丢包导致文件不完整,这是上传失败需要重新上传</p></li></ol></li><li><p>分块文件清理问题?</p><p>上传一个文件进行分块上传,上传一半不传了,之前上传到minio分块文件要清理吗?怎么清理?</p><ol><li>在数据库有一张文件表记录minio中存储的文件信息</li><li>文件开始上传时会写入文件表,状态为上传中,上传完成会更新状态为上传完成</li><li>当一个文件传了一半不再上传了说明该文件没有上传完成,会有定时任务去查询文件表的记录,如果文件未上传完成则删除minio中没有上传成功的文件目录</li></ol></li></ol></li></ol></blockquote><h3 id="XXL-JOB"><a href="#XXL-JOB" class="headerlink" title="XXL-JOB"></a>XXL-JOB</h3><h4 id="分布式任务处理"><a href="#分布式任务处理" class="headerlink" title="分布式任务处理"></a>分布式任务处理</h4><blockquote><p><code>分布式任务调度</code></p><p>视频上传成功需要对视频格式处理, 如果用java程序对视频处理有一个关键的需求是视频比较多时, 如何高效的处理. </p><p>如何高效处理任务? </p><ol><li>多线程: 充分利用单机的资源</li><li>分布式 + 多线程: 充分利用多台计算机, 每台计算机使用多线程处理</li></ol><p>方案二可扩展性更强, 是一种常见的分布式任务调度的处理方案</p><p>任务调度: 对任务的调度, 系统为了完成特定业务, 基于给定的<code>时间点</code>, 给定<code>时间间隔</code>或给定<code>执行次数</code> <code>自动执行任务</code></p></blockquote><p>多线程实现任务调度</p><p>开启一个线程,每sleep一段时间,  执行任务调度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-comment">// 任务执行时间间隔</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">timeInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;<br>    <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> something</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(timeInterval);<br>                &#125; <span class="hljs-keyword">catch</span>(InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(runnable);<br>    thread.start();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>JDK提供相关支持, Timer ScheduledExecutor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">Timer</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timer</span>();<br>    timer.schedule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> something</span><br>        &#125;<br>    &#125;, <span class="hljs-number">1000</span>, <span class="hljs-number">2000</span>); <span class="hljs-comment">// 1秒后开始调度，每2秒执行一次</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>Timer的优点在于简单易用，每个Timer对应一个线程，因此可以同时启动多个Timer并行执行多个任务，同一个Timer中的任务是串行执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">10</span>);<br>    service.scheduleAtFixedRate(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> something</span><br>                System.out.println(<span class="hljs-string">&quot;todo something&quot;</span>);<br>            &#125;<br>        &#125;, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, TimeUnit.SECONDS);<br>&#125;<br></code></pre></td></tr></table></figure><p>ScheduledExecutor，其设计思想是，每一个被调度的任务都会由线程池中的一个线程去执行，因此任务是并发执行的，相互之间不会受到干扰</p><p>Timer和ScheduledExecutor都仅能提供基于开始时间与重复间隔的任务调度，不能胜任更加复杂的调度需求。比如，设置每个月第一天凌晨1点执行任务、复杂调度任务的管理、任务键传递数据等等</p><p>Quartz</p><blockquote><p>任务调度框架, 满足复杂的调度需求</p><p>Job 定义需要执行的任务, Trigger 设置调度策略, Scheduler 将二者组装, 并触发任务开始执行</p><p>支持时间间隔调度, 按日历调度, 设置 CronTrigger 表达式(包括秒, 分, 时, 日, 月, 周, 年) 进行任务调度,</p><p>第三方Quartz 方式实现任务调度</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String [] agrs)</span> <span class="hljs-keyword">throws</span> SchedulerException &#123;<br>    <span class="hljs-comment">//创建一个Scheduler</span><br>    <span class="hljs-type">SchedulerFactory</span> <span class="hljs-variable">schedulerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StdSchedulerFactory</span>();<br>    <span class="hljs-type">Scheduler</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> schedulerFactory.getScheduler();<br>    <span class="hljs-comment">//创建JobDetail</span><br>    <span class="hljs-type">JobBuilder</span> <span class="hljs-variable">jobDetailBuilder</span> <span class="hljs-operator">=</span> JobBuilder.newJob(MyJob.class);<br>    jobDetailBuilder.withIdentity(<span class="hljs-string">&quot;jobName&quot;</span>,<span class="hljs-string">&quot;jobGroupName&quot;</span>);<br>    <span class="hljs-type">JobDetail</span> <span class="hljs-variable">jobDetail</span> <span class="hljs-operator">=</span> jobDetailBuilder.build();<br>    <span class="hljs-comment">//创建触发的CronTrigger 支持按日历调度</span><br>    <span class="hljs-type">CronTrigger</span> <span class="hljs-variable">trigger</span> <span class="hljs-operator">=</span> TriggerBuilder.newTrigger()<br>            .withIdentity(<span class="hljs-string">&quot;triggerName&quot;</span>, <span class="hljs-string">&quot;triggerGroupName&quot;</span>)<br>            .startNow()<br>            .withSchedule(CronScheduleBuilder.cronSchedule(<span class="hljs-string">&quot;0/2 * * * * ?&quot;</span>))<br>            .build();<br>    <span class="hljs-comment">//创建触发的SimpleTrigger 简单的间隔调度</span><br>    <span class="hljs-comment">/*SimpleTrigger trigger = TriggerBuilder.newTrigger()</span><br><span class="hljs-comment">            .withIdentity(&quot;triggerName&quot;,&quot;triggerGroupName&quot;)</span><br><span class="hljs-comment">            .startNow()</span><br><span class="hljs-comment">            .withSchedule(SimpleScheduleBuilder</span><br><span class="hljs-comment">                    .simpleSchedule()</span><br><span class="hljs-comment">                    .withIntervalInSeconds(2)</span><br><span class="hljs-comment">                    .repeatForever())</span><br><span class="hljs-comment">            .build();*/</span><br>    scheduler.scheduleJob(jobDetail,trigger);<br>    scheduler.start();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Job</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(JobExecutionContext jobExecutionContext)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;todo something&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>分布式任务调度</code></p><p>通常集成在应用中, 如优惠券服务汇总包括了定时发布优惠券调度程序; 结算服务包括定期生成报表的任务调度程序</p><p>由于采用分布式架构, 一个服务通常部署在多个冗余示例运行我们的业务, 在这种分布式环境运行任务调度, 称之为分布式业务调度</p></blockquote><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218121841727.png" alt="image-20231218121841727"></p><p>分布式调度目标: </p><ol><li>并行任务调度</li><li>高可用</li><li>弹性扩容</li><li>任务管理与检测</li><li>避免任务重复执行</li></ol><h4 id="XXL-JOB-1"><a href="#XXL-JOB-1" class="headerlink" title="XXL-JOB"></a>XXL-JOB</h4><blockquote><p>一个轻量的分布式任务调度平台</p><p>官网：<a href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p></blockquote><p>由<code>调度中心, 执行器, 任务</code>组成, 分布式执行的是<code>执行器</code></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218155456382.png" alt="image-20231218155456382"></p><ul><li>调度中心</li></ul><p>管理调度信息， 按照调度配置<code>发出调度请求</code>， 自身不承担业务代码</p><p>主要职责是执行器管理， 任务管理，监控运维，日志管理等</p><ul><li>任务执行器</li></ul><p>负责<code>接收调度请求</code>并<code>执行任务逻辑</code></p><p>主要职责是注册服务, 任务执行服务(接收任务放入线程池的任务队列), 执行结果上报, 日志服务等</p><ul><li>任务</li></ul><p>负责<code>执行</code>具体的<code>业务逻辑</code></p><p>调度中心和执行器之间的工作流程</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218161624892.png" alt="image-20231218161624892"></p><ol><li>任务执行器根据配置的调度中心的地址, 自动<code>注册</code>到调度中心</li><li>达到任务<code>触发条件</code>, 调度中心<code>下发任务</code></li><li>执行器基于线程池执行任务, 把执行结果放入内存<code>队列</code>, 把执行日志写入<code>日志</code>文件</li><li>执行器消费内存队列中的执行<code>结果</code>, 主动上报给调度中心</li><li>当用户在调度中心查看任务日志, 调度中心请求任务执行器, 任务执行器读取任务日志文件并返回<code>日志</code>详情</li></ol><h4 id="搭建-XXL-JOB"><a href="#搭建-XXL-JOB" class="headerlink" title="搭建 XXL-JOB"></a>搭建 XXL-JOB</h4><p>首先下载XXL-JOB</p><ul><li>GitHub：<a href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></li><li>GitEE：<a href="https://gitee.com/xuxueli0323/xxl-job">https://gitee.com/xuxueli0323/xxl-job</a></li><li>项目使用2.3.1版本： <a href="https://github.com/xuxueli/xxl-job/releases/tag/2.3.1">https://github.com/xuxueli/xxl-job/releases/tag/2.3.1</a></li></ul><p>使用IDEA打开项目</p><ul><li>xxl-job-admin：调度中心</li><li>xxl-job-core：公共依赖</li><li>xxj-job-executor-samples：执行器Sample示例<ul><li>xxl-job-executor-sample-springboot：SpringBoot版本，通过SpringBoot管理执行器</li><li>xxl-job-executor-sample-frameless：无框架版本</li></ul></li></ul><h5 id="调度中心"><a href="#调度中心" class="headerlink" title="调度中心"></a>调度中心</h5><p>根据数据库脚本创建数据库，修改数据库连接信息和端口，启动xxl-job-admin</p><blockquote><p>其实虚拟机已经有<code>调度中心</code>了,  xxl-job-* 项目只是做参考</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220215437187.png" alt="image-20231220215437187"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218171732665.png" alt="image-20231218171732665"></p><p>访问：<a href="http://192.168.101.65:8088/xxl-job-admin/">http://192.168.101.65:8088/xxl-job-admin/</a></p><p>账号和密码：admin&#x2F;123456</p></blockquote><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218165848288.png" alt="image-20231218165848288"></p><h5 id="执行器"><a href="#执行器" class="headerlink" title="执行器"></a>执行器</h5><p>执行器负责和调度中心通信, 接收调度中心发起的任务调度请求</p><ol start="0"><li>新建执行器</li></ol><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220215956789.png" alt="image-20231220215956789"></p><ol><li>media service 模块依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>nacos media-service-dev.yaml   配置   xxl-job</li></ol><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">xxl:</span><br><span class="hljs-symbol">  job:</span><br><span class="hljs-symbol">    admin:</span> <br><span class="hljs-symbol">      addresses:</span> http:<span class="hljs-comment">//192.168.101.65:8088/xxl-job-admin</span><br><span class="hljs-symbol">    executor:</span><br><span class="hljs-symbol">      appname:</span> testHandler<br><span class="hljs-symbol">      address:</span> <br><span class="hljs-symbol">      ip:</span> <br><span class="hljs-symbol">      port:</span> <span class="hljs-number">9999</span><br><span class="hljs-symbol">      logpath:</span> <span class="hljs-keyword">/data/</span>applogs<span class="hljs-keyword">/xxl-job/</span>jobhandler<br><span class="hljs-symbol">      logretentiondays:</span> <span class="hljs-number">30</span><br><span class="hljs-symbol">    accessToken:</span> default_token<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220220247185.png" alt="image-20231220220247185"></p><ol start="3"><li>配置执行器</li></ol><p>在media-service导入示例项目中的XxlJobConfig</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218172612877.png" alt="image-20231218172612877" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218172625994.png" alt="image-20231218172625994" style="zoom:50%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.config;<br><br><span class="hljs-keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * xxl-job config</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> xuxueli 2017-04-28</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XxlJobConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String adminAddresses;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String accessToken;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String appname;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String ip;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String logPath;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> logRetentionDays;<br><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> XxlJobSpringExecutor <span class="hljs-title function_">xxlJobExecutor</span><span class="hljs-params">()</span> &#123;<br>        logger.info(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);<br>        <span class="hljs-type">XxlJobSpringExecutor</span> <span class="hljs-variable">xxlJobSpringExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XxlJobSpringExecutor</span>();<br>        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);<br>        xxlJobSpringExecutor.setAppname(appname);<br>        xxlJobSpringExecutor.setAddress(address);<br>        xxlJobSpringExecutor.setIp(ip);<br>        xxlJobSpringExecutor.setPort(port);<br>        xxlJobSpringExecutor.setAccessToken(accessToken);<br>        xxlJobSpringExecutor.setLogPath(logPath);<br>        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);<br><br>        <span class="hljs-keyword">return</span> xxlJobSpringExecutor;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 针对多网卡、容器内部署等情况，可借助 &quot;spring-cloud-commons&quot; 提供的 &quot;InetUtils&quot; 组件灵活定制注册IP；</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     *      1、引入依赖：</span><br><span class="hljs-comment">     *          &lt;dependency&gt;</span><br><span class="hljs-comment">     *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="hljs-comment">     *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;</span><br><span class="hljs-comment">     *             &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="hljs-comment">     *         &lt;/dependency&gt;</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     *      2、配置文件，或者容器启动变量</span><br><span class="hljs-comment">     *          spring.cloud.inetutils.preferred-networks: &#x27;xxx.xxx.xxx.&#x27;</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     *      3、获取IP</span><br><span class="hljs-comment">     *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();</span><br><span class="hljs-comment">     */</span><br><br><br><br></code></pre></td></tr></table></figure><p>启动media模块,可以看到执行器关联了机器地址</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220221201255.png" alt="image-20231220221201255"></p><h5 id="执行任务"><a href="#执行任务" class="headerlink" title="执行任务"></a>执行任务</h5><p>参考xxljob的方法</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218173130560.png" alt="image-20231218173130560"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.service.jobhandler;<br><br><span class="hljs-keyword">import</span> com.xxl.job.core.context.XxlJobHelper;<br><span class="hljs-keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * XxlJob开发示例（Bean模式）</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 开发步骤：</span><br><span class="hljs-comment"> *      1、任务开发：在Spring Bean实例中，开发Job方法；</span><br><span class="hljs-comment"> *      2、注解配置：为Job方法添加注解 &quot;<span class="hljs-doctag">@XxlJob</span>(value=&quot;自定义jobhandler名称&quot;, init = &quot;JobHandler初始化方法&quot;, destroy = &quot;JobHandler销毁方法&quot;)&quot;，注解value值对应的是调度中心新建任务的JobHandler属性的值。</span><br><span class="hljs-comment"> *      3、执行日志：需要通过 &quot;XxlJobHelper.log&quot; 打印执行日志；</span><br><span class="hljs-comment"> *      4、任务结果：默认任务结果为 &quot;成功&quot; 状态，不需要主动设置；如有诉求，比如设置任务结果为失败，可以通过 &quot;XxlJobHelper.handleFail/handleSuccess&quot; 自主设置任务结果；</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> xuxueli 2019-12-11 21:52:51</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleXxlJob</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(SampleXxlJob.class);<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 1、简单任务示例（Bean模式）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@XxlJob(&quot;demoJobHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demoJobHandler</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        XxlJobHelper.log(<span class="hljs-string">&quot;处理视频&quot;</span>);<br><br>        <span class="hljs-comment">// default success</span><br><br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218174301374.png" alt="image-20231218174301374"></p><p>新增任务管理(我们希望5s打印一次    “处理视频”)</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220222154365.png" alt="image-20231220222154365"></p><blockquote><p><code>标红必填部分的解释</code></p><p>调度类型：</p><p>固定速度指按固定的间隔定时调度。</p><p>Cron，通过Cron表达式实现更丰富的定时调度策略。</p><p>Cron表达式是一个字符串，通过它可以定义调度策略，格式如下：</p><p>{秒数} {分钟} {小时} {日期} {月份} {星期} {年份(可为空)}</p><p>xxl-job提供图形界面去配置：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218174617845.png" alt="image-20231218174617845"></p><p>一些例子如下：</p><p>30 10 1 * * ? 每天1点10分30秒触发</p><p>0&#x2F;30 * * * * ? 每30秒触发一次</p><p>* 0&#x2F;10 * * * ? 每10分钟触发一次</p><p>运行模式有BEAN和GLUE</p><ul><li><p>bean模式较常用是在项目工程编写执行器任务代码</p></li><li><p>glue将任务代码编写在调度中心</p></li></ul><p>JobHandler即任务方法名，填写任务方法上边@XxlJob注解中的名称</p><p>路由策略: 当执行器集群部署, 调度中心向哪个执行器发任务, 这里选择第一个表示只向第一个执行器发任务, 路由策略其他选项后面的分片广播章节解释</p><p>高级配置其他设置后面的分片广播章节解释</p></blockquote><p>因为这里关了media工程, 日志显示失败</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218175345239.png" alt="image-20231218175345239"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218175426198.png" alt="image-20231218175426198"></p><p>启动media工程</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218180248106.png" alt="image-20231218180248106"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218180304964.png" alt="image-20231218180304964"></p><h4 id="分片广播"><a href="#分片广播" class="headerlink" title="分片广播"></a>分片广播</h4><p>如何进行分布式任务处理? 启动多个执行器组成一个集群, 去执行任务</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218202929546.png" alt="image-20231218202929546"></p><p>执行器在集群部署下调度中心有哪些路由策略?</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs markdown">SQL<br>高级配置：<br><span class="hljs-bullet">    -</span> 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；<br><span class="hljs-code">        FIRST（第一个）：固定选择第一个机器；</span><br><span class="hljs-code">        LAST（最后一个）：固定选择最后一个机器；</span><br><span class="hljs-code">        ROUND（轮询）：；</span><br><span class="hljs-code">        RANDOM（随机）：随机选择在线的机器；</span><br><span class="hljs-code">        CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。</span><br><span class="hljs-code">        LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；</span><br><span class="hljs-code">        LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；</span><br><span class="hljs-code">        FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；</span><br><span class="hljs-code">        BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</span><br><span class="hljs-code">        SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">    -</span> 子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度，通过子任务可以实现一个任务执行完成去执行另一个任务。<br><span class="hljs-bullet">    -</span> 调度过期策略：<br><span class="hljs-bullet">        -</span> 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；<br><span class="hljs-bullet">        -</span> 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；<br><span class="hljs-bullet">    -</span> 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；<br><span class="hljs-code">        单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</span><br><span class="hljs-code">        丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</span><br><span class="hljs-code">        覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</span><br><span class="hljs-code">    - 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；</span><br><span class="hljs-code">    - 失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</span><br><span class="hljs-code"></span><br></code></pre></td></tr></table></figure><p>分片是指调度中心以执行器为维度进行分片, 将集群执行器标上序号: 0,1,2,3等, 广播是指每次调度向集群的所有执行器发送任务调度, 请求中携带分片参数:</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218203153029.png" alt="image-20231218203153029"></p><p>每个执行器收到调度请求同时接收分片参数:</p><p>xxl-job 支持动态扩容执行器集群从而动态增加分片数量, 当<code>任务量增加</code>可以部署<code>更多的执行器</code>到集群, 调度中心会动态修改<code>分片的数量</code></p><p>作业分片适用哪些场景?</p><ul><li>分片任务场景: 10个执行器的集群处理10w条数据, 每台机器处理1w条数据, 耗时降低10倍</li><li>广播任务场景: 广播执行器同时运行<code>shell脚本</code>, 广播集群节点进行缓存更新等</li></ul><p>​所以, 广播分片方式不仅可以发挥每个执行器的能力, 并根据分片参数可以控制任务是否执行, 最终灵活控制执行器集群分布式处理任务</p><p>使用说明: 分片广播和普通任务开发流程一致, 不同是可以获取<code>分片参数</code>进行分片业务处理</p><p><strong>任务方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 2、分片广播任务</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@XxlJob(&quot;shardingJobHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shardingJobHandler</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//分片参数</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardIndex(); <span class="hljs-comment">//执行器序号</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardTotal</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardTotal(); <span class="hljs-comment">//执行器总数</span><br><br>        System.out.println(<span class="hljs-string">&quot;shardIndex: &quot;</span> + shardIndex + <span class="hljs-string">&quot; shardTotal: &quot;</span> + shardTotal);<br><br><br>    &#125;<br></code></pre></td></tr></table></figure><p>添加任务</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235250912.png" alt="image-20231220235250912"></p><p>复制一个mediaapplication实例</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218204829676.png" alt="image-20231218204829676"></p><p>启动两个media模块服务</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235520938.png" alt="image-20231220235520938"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235431373.png" alt="image-20231220235431373"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235333054.png" alt="image-20231220235333054"></p><p>当一次分片广播到来, 各执行器如何根据分片参数去分布式执行任务, 保证执行器之间执行的任务不重复呢?</p><h3 id="视频处理"><a href="#视频处理" class="headerlink" title="视频处理"></a>视频处理</h3><h4 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h4><h5 id="作业分片方案"><a href="#作业分片方案" class="headerlink" title="作业分片方案"></a>作业分片方案</h5><p>任务添加成功后, 对要处理的任务, 添加到待处理的任务表中, 现在启动多个执行器示例去查询这些待处理任务, 此时如何保证多个执行器不会重复执行任务?</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218205201099.png"></p><p>在上一节测试中, 每个执行器收到广播任务有两个参数, <code>分片序号</code>和<code>分片总数</code></p><ul><li><p>每个执行器从数据表取任务时, 可以用<code>任务id</code>对<code>分片总数</code>取余, 如果等于该执行器的<code>分片序号</code>, 则执行此任务</p></li><li><p><code>任务ID  %  分片总数  =  分片序号</code></p></li><li><p>1 % 2 &#x3D; 1，执行器2执行</p><p>2 % 2 &#x3D; 0，执行器1执行</p><p>3 % 2 &#x3D; 1，执行器2执行</p><p>4 % 2 &#x3D; 1，执行器1执行</p></li><li><p>以此类推</p></li></ul><h5 id="保证任务不重复执行"><a href="#保证任务不重复执行" class="headerlink" title="保证任务不重复执行"></a>保证任务不重复执行</h5><p>通过作业分片方案保证执行器之间分配的任务不重复执行</p><p>但是如果同一个执行器, 处理一个视频, 没有处理完, 此时调度中心来了一个请求调度, 为了不重复处理同一个视频, 怎么办?</p><blockquote><p>配置调度过期策略</p><p>忽略: 调度过期后, <code>忽略过期的任务</code>, 从当前时间开始重新计算下次触发时间</p><p>立即执行一次:  调度过期后, 立即执行一次, 从当前时间开始重新计算下次触发时间</p></blockquote><p>这里我们选择<code>忽略</code>，如果立即执行一次，可能会重复调度</p><p>其次，我们在看阻塞处理策略。</p><p>阻塞处理策略就是当前执行器正在执行任务还没有结束时，调度中心又请求调度，此时该如何处理</p><blockquote><p>阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</p><ul><li>单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</li><li>丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</li><li>覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务</li></ul></blockquote><p>这里选择<code>丢弃后续调度</code>，避免重复调度</p><p>最后，也就是要注意保证任务处理的<code>幂等性</code>，什么是<code>任务的幂等性</code>？</p><blockquote><p>任务的幂等性: 对于数据的操作不论多少次, 操作的结果一致的</p></blockquote><p>执行器接收调度请求去执行任务, 要有办法去<code>判断任务是否处理完成</code>, 如果处理完则不再处理, 即使重复调度处理相同的任务也不能重复处理相同的视频</p><blockquote><p>幂等性: 描述了一次或多次请求某一个资源, 对于资源本身应该具有相同的结果</p></blockquote><p>幂等性是为了解决重复提交问题: 比如: 恶意刷单, 重复支付等等</p><p>解决幂等性方案:</p><ol><li>数据库约束, 例如: 唯一索引, 主键</li><li>乐观锁, 长用户数据库, 更新数据时根据乐观锁状态去更新</li><li>唯一序列号, 操作传递一个唯一序列号, 操作时判断与该序列号相等, 则执行</li></ol><p>这里我们在数据库视频处理表中添加<code>状态处理</code>字段, 视频处理完成更新状态为完成, 执行视频前判断<code>是否完成</code>, 如果已经完成则不再处理</p><h5 id="业务流程-2"><a href="#业务流程-2" class="headerlink" title="业务流程"></a>业务流程</h5><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218212704684.png" alt="image-20231218212704684"></p><p>详细流程</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218212809395.png" alt="image-20231218212809395"></p><ol><li>任务调度中心广播作业分片</li><li>执行器收到广播作业分片, 从数据库读取待处理任务</li><li>执行器根据任务内容minio下载要处理的文件</li><li>执行器启动多线程处理任务</li><li>任务处理完成后, 上传处理后的视频到minio</li><li>将更新任务处理结果, 如果视频处理完成, 除了更新任务处理结果之外, 将文件的访问地址更新到任务处理表及文件, 最后将任务完成记录写入历史表</li></ol><p>待处理任务表</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218213124845.png" alt="image-20231218213124845"></p><h4 id="查询待处理任务"><a href="#查询待处理任务" class="headerlink" title="查询待处理任务"></a>查询待处理任务</h4><h5 id="添加待处理任务"><a href="#添加待处理任务" class="headerlink" title="添加待处理任务"></a>添加待处理任务</h5><p>上传视频成功, 向视频处理待处理表添加记录, 暂时只添加.avi类型视频的处理记录</p><p>根据Mime Type 去判断, 是否为avi视频, 下面列出部分mime type</p><table><thead><tr><th align="center">Video Type</th><th align="center">Extension</th><th align="center">MIME Type</th></tr></thead><tbody><tr><td align="center">Flash</td><td align="center">fl</td><td align="center">video&#x2F;x-flv</td></tr><tr><td align="center">MPEG-4</td><td align="center">.mp4</td><td align="center">video&#x2F;mp4</td></tr><tr><td align="center">iPhone Index</td><td align="center">.m3u8</td><td align="center">application&#x2F;x-mpegURL</td></tr><tr><td align="center">iPhone Segment</td><td align="center">.ts</td><td align="center">video&#x2F;MP2T</td></tr><tr><td align="center">3GP Mobile</td><td align="center">.3gp</td><td align="center">video&#x2F;3gpp</td></tr><tr><td align="center">QuickTime</td><td align="center">.mov</td><td align="center">video&#x2F;quicktime</td></tr><tr><td align="center">A&#x2F;V Interleave</td><td align="center">.avi</td><td align="center">video&#x2F;x-msvideo</td></tr><tr><td align="center">Windows Media</td><td align="center">.wmv</td><td align="center">video&#x2F;x-ms-wmv</td></tr></tbody></table><p>avi视频的mine type是<code>video/x-msvideo</code></p><p>修改addMediaFilesToDB方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">addMediaFilesToDB</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto,</span><br><span class="hljs-params">                                    String objectName, String fileMD5, String bucket_files)</span> &#123;<br>    <span class="hljs-comment">// 保存到数据库</span><br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(fileMD5);<br>    <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>        mediaFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFiles</span>();<br>        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);<br>        mediaFiles.setId(fileMD5);<br>        mediaFiles.setFileId(fileMD5);<br>        mediaFiles.setCompanyId(companyId);<br>        mediaFiles.setBucket(bucket_files);<br>        mediaFiles.setCreateDate(LocalDateTime.now());<br>        mediaFiles.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        mediaFiles.setFilePath(objectName);<br>        <span class="hljs-comment">// 获取源文件名的contentType</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">contentType</span> <span class="hljs-operator">=</span> MyFileUtils.getContentType(objectName);<br>        <span class="hljs-comment">// 如果是图片格式或者mp4格式，则设置URL属性，否则不设置</span><br>        <span class="hljs-keyword">if</span> (contentType.contains(<span class="hljs-string">&quot;image&quot;</span>) || contentType.contains(<span class="hljs-string">&quot;mp4&quot;</span>)) &#123;<br>            mediaFiles.setUrl(<span class="hljs-string">&quot;/&quot;</span> + bucket_files + <span class="hljs-string">&quot;/&quot;</span> + objectName);<br>        &#125;<br>        <span class="hljs-comment">// 查阅数据字典，002003表示审核通过</span><br>        mediaFiles.setAuditStatus(<span class="hljs-string">&quot;002003&quot;</span>);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> mediaFilesMapper.insert(mediaFiles);<br>        <span class="hljs-keyword">if</span> (insert &lt;= <span class="hljs-number">0</span>) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;保存文件信息失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 添加待处理任务</span><br>        addWaitingTask(mediaFiles);<br><span class="hljs-keyword">return</span> mediaFiles;<br>    &#125;<br>    <span class="hljs-keyword">return</span> mediaFiles;<br>&#125;<br><br><span class="hljs-comment">// 添加待处理任务</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addWaitingTask</span><span class="hljs-params">(MediaFiles mediaFiles)</span>&#123;<br>    <span class="hljs-comment">// 获取文件mimeType</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> mediaFiles.getFilename();<br>    <span class="hljs-comment">// 文件扩展名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> getMimeType(extension);<br>    <span class="hljs-comment">// 通过mimeType判断如果是avi视频,再写入待处理任务</span><br>    <span class="hljs-keyword">if</span> (mimeType.equals(<span class="hljs-string">&quot;video/x-msvideo&quot;</span>))&#123;<br>        <span class="hljs-type">MediaProcess</span> <span class="hljs-variable">mediaProcess</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaProcess</span>();<br>        BeanUtils.copyProperties(mediaFiles, mediaProcess);<br>        mediaProcess.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<span class="hljs-comment">// 状态是未处理</span><br>        mediaProcess.setCreateDate(LocalDateTime.now());<br>        mediaProcess.setFailCount(<span class="hljs-number">0</span>);<span class="hljs-comment">//失败默认值为0</span><br>        mediaProcess.setUrl(<span class="hljs-literal">null</span>);<span class="hljs-comment">//最终互联网播放url</span><br>        <span class="hljs-comment">// 向mediaProcess插入记录</span><br>        mediaProcessMapper.insert(mediaProcess);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="查询待处理任务-1"><a href="#查询待处理任务-1" class="headerlink" title="查询待处理任务"></a>查询待处理任务</h5><p>如何保证查询到的待处理视频记录不重复? 用任务id对分片总数取模, 如果等于该执行器的分片序号, 则执行, 同时为了避免同一个任务被执行两次, 我们需要额外指定任务状态为未处理</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> media_process <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">%</span> #&#123;shareTotal&#125; <span class="hljs-operator">=</span> #&#123;shareIndex&#125; <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1&#x27;</span> LIMIT #&#123;count&#125;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据分片参数获取待处理任务</span><br><span class="hljs-comment">     * @param shardTotal    分片总数</span><br><span class="hljs-comment">     * @param shardIndex    分片序号</span><br><span class="hljs-comment">     * @param count         任务数</span><br><span class="hljs-comment">     * @return</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `media_process` t <span class="hljs-keyword">where</span> t.id <span class="hljs-operator">%</span> <span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> (t.`status`<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">or</span> t.`status`<span class="hljs-operator">=</span><span class="hljs-number">3</span>) <span class="hljs-keyword">AND</span> t.fail_count<span class="hljs-operator">&lt;</span><span class="hljs-number">3</span> limit <span class="hljs-number">2</span><br>    <span class="hljs-variable">@Select</span>(&quot;SELECT * FROM media_process WHERE id % #&#123;shardTotal&#125; = #&#123;shardIndex&#125; AND (status = &#x27;1&#x27; or status = &#x27;3&#x27;) and fail_count&lt;3 LIMIT #&#123;count&#125;&quot;)<br>    List<span class="hljs-operator">&lt;</span>MediaProcess<span class="hljs-operator">&gt;</span> selectListByShardIndex(<span class="hljs-variable">@Param</span>(&quot;shardTotal&quot;) <span class="hljs-type">int</span> shardTotal, <span class="hljs-variable">@Param</span>(&quot;shardIndex&quot;) <span class="hljs-type">int</span> shardIndex, <span class="hljs-variable">@Param</span>(&quot;count&quot;) <span class="hljs-type">int</span> count);<br><br></code></pre></td></tr></table></figure><p>把mapper封装到接口MediaFileProcessService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.service.impl;<br><br><span class="hljs-keyword">import</span> com.xuecheng.media.mapper.MediaProcessMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaProcess;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;<br><span class="hljs-keyword">import</span> groovy.util.logging.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/18 21:44</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaFileProcessServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MediaFileProcessService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaProcessMapper mediaProcessMapper;<br><br>    <span class="hljs-comment">// 查询待处理任务</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;MediaProcess&gt; <span class="hljs-title function_">getMediaProcessList</span><span class="hljs-params">(<span class="hljs-type">int</span> shardIndex, <span class="hljs-type">int</span> shardTotal, <span class="hljs-type">int</span> count)</span> &#123;<br>        <span class="hljs-keyword">return</span> mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="开始执行任务"><a href="#开始执行任务" class="headerlink" title="开始执行任务"></a>开始执行任务</h4><h5 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h5><p>为了避免多线程争夺同一个任务使用synchronized同步锁去解决</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-title function_">synchronized</span><span class="hljs-params">(锁对象)</span>&#123;<br>   执行任务...<br>&#125;<br></code></pre></td></tr></table></figure><p>synchronized 只能保证同一个虚拟机中多个线程去争抢锁</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218215322204.png" alt="image-20231218215322204"></p><p>如果多个执行器分布式部署, 不能保证同一个视频只有一个执行器处理</p><p>现在实现分布式环境所有虚拟机中的线程同步执行就需要让多个虚拟机共用一个锁, 虚拟机可以分布式部署, 锁也可以分布式部署</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218215443345.png" alt="image-20231218215443345"></p><p>虚拟机去抢占同一个锁, 锁是一个单独的程序提供加锁, 解锁服务; 该锁不属于某个虚拟机, 而是分布式部署, 由多个虚拟机共享, 这种锁叫分布式锁</p><p>实现分布式锁方案很多: </p><ol><li>基于数据库实现分布式锁</li><li>基于redis实现分布式锁</li><li>使用zookeeper实现</li></ol><h5 id="开启任务"><a href="#开启任务" class="headerlink" title="开启任务"></a>开启任务</h5><p>基于数据库实现一下, 开始执行任务将任务状态更新为4表示任务执行中</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> media_process m <span class="hljs-keyword">set</span> m.status<span class="hljs-operator">=</span><span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-keyword">where</span>  m.id<span class="hljs-operator">=</span>?<br></code></pre></td></tr></table></figure><p>如果多个线程执行该sql将会执行成功, 需求是只能有一个线程抢到锁, 所以sql无法满足需求</p><p>下面使用乐观锁实现更新操作</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> media_process m <span class="hljs-keyword">set</span> m.status<span class="hljs-operator">=</span><span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-keyword">where</span> (m.status<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">or</span> m.status<span class="hljs-operator">=</span><span class="hljs-string">&#x27;3&#x27;</span>) <span class="hljs-keyword">and</span> m.fail_count<span class="hljs-operator">&lt;</span><span class="hljs-number">3</span> <span class="hljs-keyword">and</span> m.id<span class="hljs-operator">=</span>?<br></code></pre></td></tr></table></figure><p>多个线程同时执行上面的sql只会有一个线程执行成功</p><p>什么是乐观锁, 悲观锁?</p><p>synchronized是一种悲观锁，在执行被synchronized包裹的代码时需要首先获取锁，没有拿到锁则无法执行，是总悲观的认为别的线程会去抢，所以要悲观锁。</p><p>乐观锁的思想是它不认为会有线程去争抢，尽管去执行，如果没有执行成功就再去重试。</p><p>mapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 开启一个任务</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id 任务id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 更新记录数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Update(&quot;update media_process m set m.status=&#x27;4&#x27; where (m.status=&#x27;1&#x27; or m.status=&#x27;3&#x27;) and m.fail_count&lt;3 and m.id=#&#123;id&#125;&quot;)</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">startTask</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;id&quot;)</span> <span class="hljs-type">long</span> id)</span>;<br></code></pre></td></tr></table></figure><p>service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startTask</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> mediaProcessMapper.startTask(id);<br>    <span class="hljs-keyword">return</span> result&lt;=<span class="hljs-number">0</span>?<span class="hljs-literal">false</span>:<span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="更新任务状态"><a href="#更新任务状态" class="headerlink" title="更新任务状态"></a>更新任务状态</h4><p>任务处理完成后需要更新任务处理结果， 任务执行成功更新视频的url, 任务处理结果, 将待处理任务记录删除, 同时向历史任务表添加记录</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveProcessFinishStatus</span><span class="hljs-params">(Long taskId, String status, String fileId, String url, String errorMsg)</span> &#123;<br>        <span class="hljs-comment">//要更新的任务</span><br>        <span class="hljs-type">MediaProcess</span> <span class="hljs-variable">mediaProcess</span> <span class="hljs-operator">=</span> mediaProcessMapper.selectById(taskId);<br>        <span class="hljs-keyword">if</span> (mediaProcess == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//如果任务执行失败</span><br>        <span class="hljs-keyword">if</span> (status.equals(<span class="hljs-string">&quot;3&quot;</span>))&#123;<br>            <span class="hljs-comment">//更新mediaProcess表的状态</span><br>            mediaProcess.setStatus(<span class="hljs-string">&quot;3&quot;</span>);<br>            mediaProcess.setFailCount(mediaProcess.getFailCount()+<span class="hljs-number">1</span>);<span class="hljs-comment">//失败次数+1</span><br>            mediaProcess.setErrormsg(errorMsg);<br>            mediaProcessMapper.updateById(mediaProcess);<br>            <span class="hljs-comment">//todo 更高效的更新方式</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//如果任务执行成功</span><br>        <span class="hljs-comment">//文件表记录</span><br>        <span class="hljs-comment">//更新media_file表中的url</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(fileId);<br>        mediaFiles.setUrl(url);<br>        mediaFilesMapper.updateById(mediaFiles);<br><br>        <span class="hljs-comment">//更新mediaProcess表的状态</span><br>        mediaProcess.setStatus(<span class="hljs-string">&quot;2&quot;</span>);<br>        mediaProcess.setFinishDate(LocalDateTime.now());<br>        mediaProcess.setUrl(url);<br>        mediaProcessMapper.updateById(mediaProcess);<br><br>        <span class="hljs-comment">//将mediaProcess记录插入到mediaProcessHistory表</span><br>        <span class="hljs-type">MediaProcessHistory</span> <span class="hljs-variable">mediaProcessHistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaProcessHistory</span>();<br>        BeanUtils.copyProperties(mediaProcess, mediaProcessHistory);<br>        mediaProcessHistoryMapper.insert(mediaProcessHistory);<br><br>        <span class="hljs-comment">//删除mediaProcess表状态</span><br>        mediaProcessMapper.deleteById(mediaFiles);<br><br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="视频处理-1"><a href="#视频处理-1" class="headerlink" title="视频处理"></a>视频处理</h4><p>视频采用并发处理，每个视频使用一个线程去处理，每次处理的视频数量不要超过cpu核心数</p><p>所有视频处理完成结束本次执行，为防止代码异常出现无限期等待则添加超时设置，到达超时时间还没有处理完成仍结束任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.service.jobhandler;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.utils.Mp4VideoUtil;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaProcess;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileService;<br><span class="hljs-keyword">import</span> com.xxl.job.core.context.XxlJobHelper;<br><span class="hljs-keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * XxlJob开发示例（Bean模式）</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 开发步骤：</span><br><span class="hljs-comment"> * 1、任务开发：在Spring Bean实例中，开发Job方法；</span><br><span class="hljs-comment"> * 2、注解配置：为Job方法添加注解 &quot;<span class="hljs-doctag">@XxlJob</span>(value=&quot;自定义jobhandler名称&quot;, init = &quot;JobHandler初始化方法&quot;, destroy = &quot;JobHandler销毁方法&quot;)&quot;，注解value值对应的是调度中心新建任务的JobHandler属性的值。</span><br><span class="hljs-comment"> * 3、执行日志：需要通过 &quot;XxlJobHelper.log&quot; 打印执行日志；</span><br><span class="hljs-comment"> * 4、任务结果：默认任务结果为 &quot;成功&quot; 状态，不需要主动设置；如有诉求，比如设置任务结果为失败，可以通过 &quot;XxlJobHelper.handleFail/handleSuccess&quot; 自主设置任务结果；</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> xuxueli 2019-12-11 21:52:51</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoTask</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileProcessService mediaFileProcessService;<br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileService mediaFileService;<br><br>    <span class="hljs-comment">//ffmpeg的路径</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;videoprocess.ffmpegpath&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String ffmpegpath;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 视频处理任务</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@XxlJob(&quot;videoJobHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">videoJobHandler</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//分片参数</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardIndex(); <span class="hljs-comment">//执行器序号</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardTotal</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardTotal(); <span class="hljs-comment">//执行器总数</span><br><br>        <span class="hljs-comment">//确定cpu核心数</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">processors</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();<br><br><br>        <span class="hljs-comment">//查询待处理任务</span><br>        List&lt;MediaProcess&gt; mediaProcessList = mediaFileProcessService.getMediaProcessList(shardIndex, shardTotal, processors);<br>        <span class="hljs-comment">//任务数量</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> mediaProcessList.size();<br>        log.debug(<span class="hljs-string">&quot;取到的视频任务数:&#123;&#125;&quot;</span>, size);<br>        <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//工具类创建一个线程池,线程数 &lt;= CPU数, 上面的mediaProcessList不一定是满的</span><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(size);<br>        <span class="hljs-comment">//使用计数器</span><br>        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(size);<br><br>        mediaProcessList.forEach(mediaProcess -&gt; &#123;<br><br>            <span class="hljs-comment">//将任务加入线程池</span><br>            executorService.execute(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//任务执行逻辑</span><br>                    <span class="hljs-comment">//1.争抢任务(开启任务)</span><br>                    <span class="hljs-type">Long</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> mediaProcess.getId();<br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> mediaFileProcessService.startTask(taskId);<br>                    <span class="hljs-keyword">if</span> (!isLock) &#123;<br>                        log.error(<span class="hljs-string">&quot;抢占任务失败, 任务id:&#123;&#125;&quot;</span>, taskId);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br><br>                    <span class="hljs-comment">//2.执行视频转码</span><br>                    <span class="hljs-comment">//下载minio视频到本地</span><br>                    <span class="hljs-comment">//桶</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">bucket</span> <span class="hljs-operator">=</span> mediaProcess.getBucket();<br>                    <span class="hljs-comment">//objectName</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> mediaProcess.getFilePath();<br>                    <span class="hljs-comment">//md5</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> mediaProcess.getFileId();<br><br><br>                    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> mediaFileService.downloadFileFromMinIO(bucket, filePath);<br>                    <span class="hljs-keyword">if</span> (file == <span class="hljs-literal">null</span>) &#123;<br>                        log.error(<span class="hljs-string">&quot;下载视频错误, 任务id:&#123;&#125;,bucket:&#123;&#125;,filePath:&#123;&#125;&quot;</span>, taskId, bucket, filePath);<br>                        <span class="hljs-comment">//保存任务状态为失败</span><br>                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="hljs-string">&quot;3&quot;</span>, md5, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;下载视频到本地失败&quot;</span>);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br><br>                    <span class="hljs-comment">//源avi视频的路径</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">video_path</span> <span class="hljs-operator">=</span> file.getAbsolutePath();<br>                    <span class="hljs-comment">//转换后mp4文件的名称</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">mp4_name</span> <span class="hljs-operator">=</span> md5 + <span class="hljs-string">&quot;.mp4&quot;</span>;<br>                    <span class="hljs-comment">//转换后mp4文件的路径</span><br>                    <span class="hljs-comment">//先创建临时文件,这个文件作为转换后的文件</span><br>                    <span class="hljs-type">File</span> <span class="hljs-variable">mp4File</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        mp4File = File.createTempFile(<span class="hljs-string">&quot;minio&quot;</span>, <span class="hljs-string">&quot;.mp4&quot;</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                        log.debug(<span class="hljs-string">&quot;创建临时文件异常,&#123;&#125;&quot;</span>, e.getMessage());<br>                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="hljs-string">&quot;3&quot;</span>, md5, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;创建临时文件异常&quot;</span>);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">mp4_path</span> <span class="hljs-operator">=</span> mp4File.getAbsolutePath();<br>                    <span class="hljs-comment">//创建工具类对象</span><br>                    <span class="hljs-type">Mp4VideoUtil</span> <span class="hljs-variable">videoUtil</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mp4VideoUtil</span>(ffmpegpath, video_path, mp4_name, mp4_path);<br>                    <span class="hljs-comment">//开始视频转换，成功将返回success</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> videoUtil.generateMp4();<br><br>                    <span class="hljs-comment">//视频转码失败</span><br>                    <span class="hljs-keyword">if</span> (!result.equals(<span class="hljs-string">&quot;success&quot;</span>)) &#123;<br>                        log.debug(<span class="hljs-string">&quot;视频转码失败,原因:&#123;&#125;,bucket:&#123;&#125;,objectName:&#123;&#125;&quot;</span>, result, bucket, filePath);<br>                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="hljs-string">&quot;3&quot;</span>, md5, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;视频转码失败: &quot;</span> + result);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br><br>                    <span class="hljs-comment">// mp4文件的url</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> getFilePathByMd5(md5, <span class="hljs-string">&quot;.mp4&quot;</span>);<br><br>                    <span class="hljs-comment">//视频转码成功</span><br>                    <span class="hljs-comment">//3.上传minio</span><br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">addMediaFilesToMinIO</span> <span class="hljs-operator">=</span> mediaFileService.addMediaFilesToMinIO(mp4_path, <span class="hljs-string">&quot;video/mp4&quot;</span>, bucket, url);<br>                    <span class="hljs-keyword">if</span> (!addMediaFilesToMinIO) &#123;<br>                        log.debug(<span class="hljs-string">&quot;上传mp4到minio失败,taskid:&#123;&#125;&quot;</span>, taskId);<br>                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="hljs-string">&quot;3&quot;</span>, md5, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;上传mp4到minio失败&quot;</span>);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br><br>                    <span class="hljs-comment">//4.保存任务状态为成功</span><br>                    mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="hljs-string">&quot;2&quot;</span>, md5, url, <span class="hljs-string">&quot;下载视频到本地失败&quot;</span>);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-comment">//计数器-1</span><br>                    countDownLatch.countDown();<br>                &#125;<br>            &#125;);<br><br>        &#125;);<br><br>        <span class="hljs-comment">//阻塞,等大家完成任务,整个方法才完成; 指定一个最大限度的等待时间,阻塞最多等待一定时间解除阻塞</span><br>        countDownLatch.await(<span class="hljs-number">30</span>, TimeUnit.MINUTES);<br><br><br>    &#125;<br><br>    <span class="hljs-comment">// 得到分块文件目录</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getFilePathByMd5</span><span class="hljs-params">(String fileMd5, String fileExt)</span> &#123;<br>        <span class="hljs-keyword">return</span> fileMd5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5.substring(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + fileExt;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><h5 id="基本测试"><a href="#基本测试" class="headerlink" title="基本测试"></a>基本测试</h5><p>进入xxl-job调度中心添加执行器和视频处理任务</p><p>在xxl-job配置任务调度策略：</p><p>1）配置阻塞处理策略为：丢弃后续调度。</p><p>2）配置视频处理调度时间间隔不用根据视频处理时间去确定，可以配置的小一些，如：5分钟，即使到达调度时间如果视频没有处理完会丢弃调度请求。</p><p>配置完成开始测试视频处理：</p><p>1、首先上传至少4个视频，非mp4格式。</p><p>2、在xxl-job启动视频处理任务</p><p>3、观察媒资管理服务后台日志</p><h5 id="失败测试"><a href="#失败测试" class="headerlink" title="失败测试"></a>失败测试</h5><p>1、先停止调度中心的视频处理任务。</p><p>2、上传视频，手动修改待处理任务表中file_path字段为一个不存在的文件地址</p><p>3、启动任务</p><p>观察任务处理失败后是否会重试，并记录失败次数。</p><h5 id="抢占任务测试"><a href="#抢占任务测试" class="headerlink" title="抢占任务测试"></a>抢占任务测试</h5><p>1、修改调度中心中视频处理任务的阻塞处理策略为“覆盖之间的调度”</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103203263.png" alt="image-20231219103203263"></p><p>2、在抢占任务代码处打断点并选择支持多线程方式</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103221247.png" alt="image-20231219103221247"></p><p>3、在抢占任务代码处的下边两行代码分别打上断点，避免观察时代码继续执行。</p><p>4、启动任务</p><p>此时多个线程执行都停留在断点处</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103236246.png" alt="image-20231219103236246"></p><p>依次放行，观察同一个任务只会被一个线程抢占成功。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103249414.png" alt="image-20231219103249414"></p><h4 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h4><h5 id="任务补偿机制"><a href="#任务补偿机制" class="headerlink" title="任务补偿机制"></a>任务补偿机制</h5><p>如果有线程抢占了某个视频的处理任务，如果<code>线程处理过程中挂掉了</code>，该视频的状态将会一直是处理中，其它线程将无法处理，这个问题需要用补偿机制。</p><p>单独启动一个任务找到待处理任务表中超过执行期限但仍在处理中的任务，将任务的状态改为执行失败。</p><p>任务执行期限是处理一个视频的最大时间，比如定为30分钟，通过任务的启动时间去判断任务是否超过执行期限。</p><p>大家思考这个sql该如何实现？</p><p>大家尝试自己实现此任务补偿机制。</p><h5 id="达到最大失败次数"><a href="#达到最大失败次数" class="headerlink" title="达到最大失败次数"></a>达到最大失败次数</h5><p>当任务达到<code>最大失败次数</code>时一般就说明程序处理此视频存在问题，这种情况就需要人工处理，在页面上会提示失败的信息，人工可手动执行该视频进行处理，或通过其它转码工具进行视频转码，转码后直接上传mp4视频。</p><h5 id="分块文件清理问题"><a href="#分块文件清理问题" class="headerlink" title="分块文件清理问题"></a>分块文件清理问题</h5><p>上传一个文件进行分块上传，上传一半不传了，之前上传到minio的分块文件要清理吗？怎么做的？</p><p>1、在数据库中有一张文件表记录minio中存储的文件信息。</p><p>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。</p><p>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除minio中没有上传成功的文件目录。</p><blockquote><p>面试</p><ol><li>xxl-job的原理是什么? xxl-job是什么?</li></ol><p>xxl-job分布式任务调度服务由调度中心和执行器组成, 调度中心负责按任务调度策略向执行器下发任务, 执行器负责接收任务, 执行任务</p><ul><li>首先部署并启动xxl-job调度中心（一个java工程，打成jar包可以放到虚拟机上运行）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">nohup</span> java -jar xxl-job-admin...  &amp; <br></code></pre></td></tr></table></figure><ul><li>在微服务中添加xxl-job依赖, 在微服务配置执行器</li></ul><p>依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>yml配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">xxl:</span><br>  <span class="hljs-attr">job:</span><br>    <span class="hljs-attr">admin:</span> <br>      <span class="hljs-attr">addresses:</span> <span class="hljs-string">http://192.168.101.128:18088/xxl-job-admin/</span><br>    <span class="hljs-attr">executor:</span><br>      <span class="hljs-attr">appname:</span> <span class="hljs-string">media-process-service</span><br>      <span class="hljs-attr">address:</span><br>      <span class="hljs-attr">ip:</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span><br>      <span class="hljs-attr">logpath:</span> <span class="hljs-string">/data/applogs/xxl-job-jobhandler</span><br>      <span class="hljs-attr">logretentiondays:</span> <span class="hljs-number">30</span><br>    <span class="hljs-attr">accessToken:</span> <span class="hljs-string">default_token</span><br></code></pre></td></tr></table></figure><p>配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* xxl-job config</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* <span class="hljs-doctag">@author</span> xuxueli 2017-04-28</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XxlJobConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String adminAddresses;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String accessToken;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String appname;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String ip;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String logPath;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> logRetentionDays;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> XxlJobSpringExecutor <span class="hljs-title function_">xxlJobExecutor</span><span class="hljs-params">()</span> &#123;<br>        logger.info(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);<br>        <span class="hljs-type">XxlJobSpringExecutor</span> <span class="hljs-variable">xxlJobSpringExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XxlJobSpringExecutor</span>();<br>        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);<br>        xxlJobSpringExecutor.setAppname(appname);<br>        xxlJobSpringExecutor.setAddress(address);<br>        xxlJobSpringExecutor.setIp(ip);<br>        xxlJobSpringExecutor.setPort(port);<br>        xxlJobSpringExecutor.setAccessToken(accessToken);<br>        xxlJobSpringExecutor.setLogPath(logPath);<br>        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);<br>        <span class="hljs-keyword">return</span> xxlJobSpringExecutor;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 针对多网卡、容器内部署等情况，可借助 &quot;spring-cloud-commons&quot; 提供的 &quot;InetUtils&quot; 组件灵活定制注册IP；</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *      1、引入依赖：</span><br><span class="hljs-comment">    *          &lt;dependency&gt;</span><br><span class="hljs-comment">    *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="hljs-comment">    *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;</span><br><span class="hljs-comment">    *             &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="hljs-comment">    *         &lt;/dependency&gt;</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *      2、配置文件，或者容器启动变量</span><br><span class="hljs-comment">    *          spring.cloud.inetutils.preferred-networks: &#x27;xxx.xxx.xxx.&#x27;</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *      3、获取IP</span><br><span class="hljs-comment">    *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();</span><br><span class="hljs-comment">    */</span><br><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>启动微服务, 执行器向调度中心上报自己</li><li>在微服务写一个任务方法, 用xxl-job的注解去标记执行任务的方法名称</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@XxlJob(&quot;testJob&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testJob</span><span class="hljs-params">()</span> &#123;<br>    log.debug(<span class="hljs-string">&quot;开始执行.......&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>在微服务写一个任务方法, 用xxl-job注解标记执行任务的方法名称</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@XxlJob(&quot;testJob&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testJob</span><span class="hljs-params">()</span> &#123;<br>    log.debug(<span class="hljs-string">&quot;开始执行.......&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>在调度中心配置任务调度策略, 调度策略是每个多长时间执行, 或者每天&#x2F;每月固定时间去执行</li><li>在调度中心启动任务</li><li>调度中心根据任务调度策略, 到达时间开始下发任务给执行器</li><li>执行器收到任务开始执行任务</li></ul><ol start="2"><li>如何保证任务不重复执行?<ol><li>调度中心按分片广播方式下发任务</li><li>执行器收到作业分片广播的参数：分片总数(shardTotal)和分片序号(shardIndex)，计算<code>任务id % 分片总数</code>(taskId % shardTotal)，如果结果等于分片序号，就去执行这个任务(taskId % shardTotal &#x3D; shardIndex)。这样就可以保证不同的执行器执行不同的任务</li><li>配置调度过期策略为忽略, 避免同一个执行器多次重复执行同一个任务</li><li>配置任务阻塞处理策略为丢弃后续调度, 注意: 丢弃也没事, 下一次调度还可以执行</li><li>另外还要保证任务处理的幂等性，执行过的任务可以打一个状态标记已完成（上面的代码设置status&#x3D;2即为完成），下次再次调度该任务时，判断该任务已完成，就不再执行</li></ol></li><li>任务幂等性如何保证?<ul><li>幂等性描述的是一次和多次请求某一个资源，对于资源本身，应该返回同样的结果</li><li>幂等性是为了解决重复提交问题，例如：恶意刷单，重复支付等</li><li>解决幂等性的常用方案<ol><li>数据库约束，例如：唯一索引、主键</li><li>乐观锁：常用于数据库，更新数据时，根据乐观锁的状态去更新</li><li>唯一序列号，请求前生成的唯一序列号，携带序列号去请求，执行时在redis记录该序列号，用于表示该序列号请求已经执行过了，如果相同的序列号再次来执行，则说明是重复执行。这里的解决方式是在数据库中添加状态处理字段，视频处理完成，则更新该字段为已完成，执行视频处理之前判断状态是否为已完成，若已完成则不处理</li></ol></li></ul></li></ol></blockquote><h3 id="绑定媒资"><a href="#绑定媒资" class="headerlink" title="绑定媒资"></a>绑定媒资</h3><h4 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h4><p>到目前为止，媒资管理已完成文件上传、视频处理、我的媒资功能等基本功能，其它模块可以使用媒资文件，本节要讲解课程计划绑定媒资文件。</p><p>如何将课程计划绑定媒资呢？</p><p>首先进入课程计划界面，然后选择要绑定的视频进行绑定即可。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105332918.png" alt="image-20231219105332918"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105340899.png" alt="image-20231219105340899"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105349404.png" alt="image-20231219105349404"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105356913.png" alt="image-20231219105356913"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105405675.png" alt="image-20231219105405675"></p><h4 id="数据模型-1"><a href="#数据模型-1" class="headerlink" title="数据模型"></a>数据模型</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105434515.png" alt="image-20231219105434515"></p><h4 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a>接口定义</h4><p>根据业务流程，用户进入课程计划列表，首先确定向哪个课程计划添加视频，点击”添加视频“后用户选择视频，选择视频，点击提交，前端以json格式请求以下参数：</p><p>提交媒资文件id、文件名称、教学计划id</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">JSON</span><br>&#123;<br>  <span class="hljs-string">&quot;mediaId&quot;</span>: <span class="hljs-string">&quot;70a98b4a2fffc89e50b101f959cc33ca&quot;</span>,<br>  <span class="hljs-string">&quot;fileName&quot;</span>: <span class="hljs-string">&quot;22-Hmily实现TCC事务-开发bank2的confirm方法.avi&quot;</span>,<br>  <span class="hljs-string">&quot;teachplanId&quot;</span>: <span class="hljs-number">257</span><br>&#125;<br></code></pre></td></tr></table></figure><p>此接口在内容管理模块提供。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(value = &quot;课程计划和媒资信息绑定&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/teachplan/association/media&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">associationMedia</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> BindTeachplanMediaDto bindTeachplanMediaDto)</span>&#123;<br>    teachplanService.associationMedia(bindTeachplanMediaDto);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 教学计划绑定媒资</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> TeachplanMedia <span class="hljs-title function_">associationMedia</span><span class="hljs-params">(BindTeachplanMediaDto bindTeachplanMediaDto)</span> &#123;<br>    <span class="hljs-comment">//教学计划id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">teachplanId</span> <span class="hljs-operator">=</span> bindTeachplanMediaDto.getTeachplanId();<br>    <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplan</span> <span class="hljs-operator">=</span> teachplanMapper.selectById(teachplanId);<br>    <span class="hljs-keyword">if</span>(teachplan==<span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;教学计划不存在&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">grade</span> <span class="hljs-operator">=</span> teachplan.getGrade();<br>    <span class="hljs-keyword">if</span>(grade!=<span class="hljs-number">2</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;只允许第二级教学计划绑定媒资文件&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//课程id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">courseId</span> <span class="hljs-operator">=</span> teachplan.getCourseId();<br><br>    <span class="hljs-comment">//先删除原来该教学计划绑定的媒资</span><br>    teachplanMediaMapper.delete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;TeachplanMedia&gt;().eq(TeachplanMedia::getTeachplanId,teachplanId));<br><br>    <span class="hljs-comment">//再添加教学计划与媒资的绑定关系</span><br>    <span class="hljs-type">TeachplanMedia</span> <span class="hljs-variable">teachplanMedia</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TeachplanMedia</span>();<br>    teachplanMedia.setCourseId(courseId);<br>    teachplanMedia.setTeachplanId(teachplanId);<br>    teachplanMedia.setMediaFilename(bindTeachplanMediaDto.getFileName());<br>    teachplanMedia.setMediaId(bindTeachplanMediaDto.getMediaId());<br>    teachplanMedia.setCreateDate(LocalDateTime.now());<br>    teachplanMediaMapper.insert(teachplanMedia);<br>    <span class="hljs-keyword">return</span> teachplanMedia;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dts">Plain Text<br><span class="hljs-meta">### 课程计划绑定视频</span><br><span class="hljs-title class_">POST</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>media_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">/media/</span>teachplan<span class="hljs-keyword">/association/</span>media<br>Content-Type: application/json<br><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-string">&quot;mediaId&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;fileName&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;teachplanId&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br><br></code></pre></td></tr></table></figure><h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>解除课程计划和媒资信息绑定</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(value = &quot;解除课程计划和媒资信息绑定&quot;)</span><br><span class="hljs-meta">@DeleteMapping(&quot;/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">liftAssociationMedia</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long mediaId, <span class="hljs-meta">@PathVariable</span> Long teachPlanId)</span>&#123;<br>    teachplanService.liftAssociationMedia(mediaId, teachPlanId);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">liftAssociationMedia</span><span class="hljs-params">(Long mediaId, Long teachPlanId)</span> &#123;<br>    LambdaQueryWrapper&lt;TeachplanMedia&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>    queryWrapper.eq(TeachplanMedia::getTeachplanId, teachPlanId)<br>            .eq(TeachplanMedia::getMediaId, mediaId);<br>    teachplanMediaMapper.delete(queryWrapper);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">Java<br><br><span class="hljs-comment">### 课程计划接触视频绑定</span><br>DELETE &#123;&#123;media_host&#125;&#125;<span class="hljs-regexp">/media/</span>teachplan<span class="hljs-regexp">/association/m</span>edia<span class="hljs-regexp">/&#123;teachPlanId&#125;/</span>&#123;mediaId&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
    <tags>
      
      <tag>学成在线</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学成在线内容管理模块</title>
    <link href="/2023/12/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/"/>
    <url>/2023/12/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="内容管理模块"><a href="#内容管理模块" class="headerlink" title="内容管理模块"></a>内容管理模块</h2><h3 id="模块需求分析"><a href="#模块需求分析" class="headerlink" title="模块需求分析"></a>模块需求分析</h3><p>开发人员经过分析, 理解用户和项目的<code>功能,性能,可靠性</code>等要求, 搞清楚<code>问题域</code></p><ol><li>确认用户需求</li><li>确认关键问题</li><li>梳理业务流程</li><li>数据建模</li><li>编写需求规格说明书</li></ol><table><thead><tr><th>项目</th><th>添加课程</th></tr></thead><tbody><tr><td>功能名称</td><td>添加课程</td></tr><tr><td>功能描述</td><td>添加课程基本信息</td></tr><tr><td>参与者</td><td>教学机构管理员</td></tr><tr><td>前置条件</td><td>教学机构管理只允许向自己机构添加课程 拥有添加课程的权限</td></tr><tr><td>基本事件流程</td><td>1、登录教学机构平台  2、进入课程列表页面  3、点击添加课程按钮进入添加课程界面  4、填写课程基本信息  5、点击提交。</td></tr><tr><td>可选事件流程</td><td>成功：提示添加成功，跳转到课程营销信息添加界面 失败：提示具体的失败信息，用户根据失败信息进行修改。</td></tr><tr><td>数据描述</td><td>课程基本信息：课程id、课程名称、课程介绍、课程大分类、课程小分类、课程等级、课程图片、所属机构、课程创建时间、课程修改时间、课程状态</td></tr><tr><td>后置条件</td><td>向课程基本信息插入一条记录</td></tr><tr><td>补充说明</td><td></td></tr></tbody></table><p>本项目作为一个大型在线教育平台, <code>内容管理模块</code>主要<code>对课程和相关内容进行管理</code></p><p>本模块所有表</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212101711553.png" alt="image-20231212101711553"></p><hr><h3 id="创建模块工程"><a href="#创建模块工程" class="headerlink" title="创建模块工程"></a>创建模块工程</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212102711295.png" alt="image-20231212102711295"></p><p><strong>前后端交互交互流程图</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212102805059.png" alt="image-20231212102805059"></p><p><strong>内容管理所有模块结构</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212102837723.png" alt="image-20231212102837723"></p><ul><li>xuecheng-plus-content：内容管理模块工程，负责聚合xuecheng-plus-content-api、xuecheng-plus-content-service、xuecheng-plus-content-model。</li><li>xuecheng-plus-content-api：接口工程，为前端提供接口。</li><li>xuecheng-plus-content-service: 业务工程，为接口工程提供业务支撑。</li><li>xuecheng-plus-content-model: 数据模型工程，存储数据模型类、数据传输类型等。</li></ul><p><strong>结合 父工程 和 基础工程流程图</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212102937547.png" alt="image-20231212102937547"></p><hr><p>在IDEA创建这样的模块结构</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212105034210.png" alt="image-20231212105034210"></p><p>4个pom.xml初始内容, 从上向下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-content<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-content-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-content-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-content<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-content-model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-base<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-content<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-content-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-content-model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-content<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>xuecheng-plus-content<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>xuecheng-plus-content<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>xuecheng-plus-content-model<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>xuecheng-plus-content-service<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>xuecheng-plus-content-api<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="课程查询"><a href="#课程查询" class="headerlink" title="课程查询"></a>课程查询</h3><h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212105831280.png" alt="image-20231212105831280"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212105841097.png" alt="image-20231212105841097"></p><p><strong>数据模型</strong></p><p>查询条件: </p><ol><li>课程名称 : 模糊搜索</li><li>课程审核状态 : 未提交, 已提交, 审核通过, 审核未通过</li><li>课程发布状态 : 未发布, 已发布, 已下线</li><li>分页查询: 页码, 每页显示记录数</li></ol><p>查询结果:</p><p>课程id,  课程名称, 创建时间，审核状态, 操作</p><p>任务数: 该课程包含的课程计划数, 即课程章节数</p><p>是否付费: 免费, 收费</p><p>类型: 录播, 直播</p><p>分页查询: 页码, 每页显示记录数</p><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a><strong>创建数据库</strong></h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211223829806.png" alt="image-20231211223829806"></p><blockquote><p>面试</p><ol><li>MySQL 常见存储引擎及区别?</li></ol><p>InnoDB : 支持<code>事务</code>, 使用锁粒度默认为<code>行级锁</code>, 支持更高并发, 支持<code>表锁</code>;  支持<code>外键</code>约束, 降低表的查询速度, 增加表之间的耦合, 降低表的独立性;  </p><p>MyISAM : 不支持<code>事务</code>, 只支持<code>表级锁</code>, 不支持<code>外键</code></p><p>memory: 数据存储在<code>内存</code></p><p>总结: </p><ul><li>MyISAM 管理非事务表, 提供高速<code>存储</code>和<code>检索</code>以及全文<code>搜索</code>能力, 如果在应用执行大量<code>select</code> , 应该选择MyISAM</li><li>InnoDB  用于<code>事务处理</code>, 具有<code>ACID</code> 事务支持等特性, 如果应用中执行大量<code>insert </code>和 <code>update</code> 操作, 应该选择InnoDB</li></ul><ol start="2"><li><p>MySQL 建表需要注意什么?</p></li><li><p>注意选择存储引擎, 支持事务要选InnoDB</p></li><li><p>注意字段类型选择， 日期类型如果要记录分秒时使用datetime , 只记录年月日使用date类型, 对于字符类型的选择,固定长度选择char, 不固定长度选择varchar ,  varchar比char节省空间但速度慢, 对于内容介绍类的长广文本字段使用text或longtext ,  如果存储图片等二进制数据使用blob 或 longblob  , 对于金额字段建议使用decimal , 对于数值类型在取值范围足够的前提尽量使用占用空间小的</p></li><li><p>主键尽量使用自然主键, 不要有业务意义, 使用int unsigned类型, 特殊可以bigint</p></li><li><p>如果要存储text blob 字段建议单独一张表, 使用外键关联</p></li><li><p>尽量不定义外键, 保证表的独立性, 可以存在外键意义的字段</p></li><li><p>设置字段默认值, 比如: 状态, 创建时间等</p></li><li><p>每个字段注释写明白</p></li><li><p>注意字段约束, 非空, 唯一, 主键等</p></li></ol></blockquote><p><strong>生成PO类</strong></p><p>PO是持久层对象, 由一组属性和属性get和set方法组成, PO对应于数据库的表, 在开发持久层代码需要根据数据表编写PO类, 在实际开发通常使用代码生成器(工具)生成PO类的代码</p><p>由于在需求分析阶段对数据模型分析, PO类对应于数据模型, 所以在需求分析阶段即可使用工具生成PO类</p><p>本项目使用 MP 生成PO类 Mapper接口 Mapper的xml文件</p><p><a href="https://github.com/baomidou/generator">https://github.com/baomidou/generator</a></p><p>导入资料中的xuecheng-plus-generator</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212112002588.png" alt="image-20231212112002588"></p><p>这个内容管理模块的PO类, Mapper接口和Mapper的xml文件, 我们这里只用PO</p><p>ContentCoderGenerator.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.generator;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.AutoGenerator;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.config.*;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableFill;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.generator.engine.FreemarkerTemplateEngine;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * MyBatis-Plus 代码生成类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentCodeGenerator</span> &#123;<br><br>    <span class="hljs-comment">// TODO 修改服务名以及数据表名</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SERVICE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;content&quot;</span>;<br><br>    <span class="hljs-comment">//数据库账号</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_SOURCE_USER_NAME</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;root&quot;</span>;<br>    <span class="hljs-comment">//数据库密码</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_SOURCE_PASSWORD</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mysql&quot;</span>;<br>    <span class="hljs-comment">//生成的表</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] TABLE_NAMES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<br><span class="hljs-comment">//        &quot;mq_message&quot;,</span><br><span class="hljs-comment">//        &quot;mq_message_history&quot;</span><br>           <span class="hljs-string">&quot;course_base&quot;</span>,<br>           <span class="hljs-string">&quot;course_market&quot;</span>,<br>           <span class="hljs-string">&quot;teachplan&quot;</span>,<br>           <span class="hljs-string">&quot;teachplan_media&quot;</span>,<br>           <span class="hljs-string">&quot;course_teacher&quot;</span>,<br>          <span class="hljs-string">&quot;course_category&quot;</span>,<br>           <span class="hljs-string">&quot;course_publish&quot;</span>,<br>           <span class="hljs-string">&quot;course_publish_pre&quot;</span><br><br>    &#125;;<br><br>    <span class="hljs-comment">// TODO 默认生成entity，需要生成DTO修改此变量</span><br>    <span class="hljs-comment">// 一般情况下要先生成 DTO类 然后修改此参数再生成 PO 类。</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Boolean</span> <span class="hljs-variable">IS_DTO</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>       <span class="hljs-comment">// 代码生成器</span><br>       <span class="hljs-type">AutoGenerator</span> <span class="hljs-variable">mpg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutoGenerator</span>();<br>       <span class="hljs-comment">// 选择 freemarker 引擎，默认 Velocity</span><br>       mpg.setTemplateEngine(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FreemarkerTemplateEngine</span>());<br>       <span class="hljs-comment">// 全局配置</span><br>       <span class="hljs-type">GlobalConfig</span> <span class="hljs-variable">gc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalConfig</span>();<br>       gc.setFileOverride(<span class="hljs-literal">true</span>);<br>       <span class="hljs-comment">//生成路径</span><br>       gc.setOutputDir(System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;/xuecheng-plus-generator/src/main/java&quot;</span>);<br>       gc.setAuthor(<span class="hljs-string">&quot;itcast&quot;</span>);<br>       gc.setOpen(<span class="hljs-literal">false</span>);<br>       gc.setSwagger2(<span class="hljs-literal">false</span>);<br>       gc.setServiceName(<span class="hljs-string">&quot;%sService&quot;</span>);<br>        gc.setBaseResultMap(<span class="hljs-literal">true</span>);<br>        gc.setBaseColumnList(<span class="hljs-literal">true</span>);<br><br>       <span class="hljs-keyword">if</span> (IS_DTO) &#123;<br>          gc.setSwagger2(<span class="hljs-literal">true</span>);<br>          gc.setEntityName(<span class="hljs-string">&quot;%sDTO&quot;</span>);<br>       &#125;<br>       mpg.setGlobalConfig(gc);<br><br>       <span class="hljs-comment">// 数据库配置</span><br>       <span class="hljs-type">DataSourceConfig</span> <span class="hljs-variable">dsc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceConfig</span>();<br>       dsc.setDbType(DbType.MYSQL);<br>       dsc.setUrl(<span class="hljs-string">&quot;jdbc:mysql://192.168.101.65:3306/xc402_&quot;</span> + SERVICE_NAME<br>             + <span class="hljs-string">&quot;?serverTimezone=UTC&amp;useUnicode=true&amp;useSSL=false&amp;characterEncoding=utf8&quot;</span>);<br><span class="hljs-comment">//     dsc.setDriverName(&quot;com.mysql.jdbc.Driver&quot;);</span><br>       dsc.setDriverName(<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);<br>       dsc.setUsername(DATA_SOURCE_USER_NAME);<br>       dsc.setPassword(DATA_SOURCE_PASSWORD);<br>       mpg.setDataSource(dsc);<br><br>       <span class="hljs-comment">// 包配置</span><br>       <span class="hljs-type">PackageConfig</span> <span class="hljs-variable">pc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PackageConfig</span>();<br>       pc.setModuleName(SERVICE_NAME);<br>       pc.setParent(<span class="hljs-string">&quot;com.xuecheng&quot;</span>);<br><br>       pc.setServiceImpl(<span class="hljs-string">&quot;service.impl&quot;</span>);<br>       pc.setXml(<span class="hljs-string">&quot;mapper&quot;</span>);<br>       pc.setEntity(<span class="hljs-string">&quot;model.po&quot;</span>);<br>       mpg.setPackageInfo(pc);<br><br><br>       <span class="hljs-comment">// 设置模板</span><br>       <span class="hljs-type">TemplateConfig</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateConfig</span>();<br>       mpg.setTemplate(tc);<br><br>       <span class="hljs-comment">// 策略配置</span><br>       <span class="hljs-type">StrategyConfig</span> <span class="hljs-variable">strategy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrategyConfig</span>();<br>       strategy.setNaming(NamingStrategy.underline_to_camel);<br>       strategy.setColumnNaming(NamingStrategy.underline_to_camel);<br>       strategy.setEntityLombokModel(<span class="hljs-literal">true</span>);<br>       strategy.setRestControllerStyle(<span class="hljs-literal">true</span>);<br>       strategy.setInclude(TABLE_NAMES);<br>       strategy.setControllerMappingHyphenStyle(<span class="hljs-literal">true</span>);<br>       strategy.setTablePrefix(pc.getModuleName() + <span class="hljs-string">&quot;_&quot;</span>);<br>       <span class="hljs-comment">// Boolean类型字段是否移除is前缀处理</span><br>       strategy.setEntityBooleanColumnRemoveIsPrefix(<span class="hljs-literal">true</span>);<br>       strategy.setRestControllerStyle(<span class="hljs-literal">true</span>);<br><br>       <span class="hljs-comment">// 自动填充字段配置</span><br>       strategy.setTableFillList(Arrays.asList(<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">TableFill</span>(<span class="hljs-string">&quot;create_date&quot;</span>, FieldFill.INSERT),<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">TableFill</span>(<span class="hljs-string">&quot;change_date&quot;</span>, FieldFill.INSERT_UPDATE),<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">TableFill</span>(<span class="hljs-string">&quot;modify_date&quot;</span>, FieldFill.UPDATE)<br>       ));<br>       mpg.setStrategy(strategy);<br><br>       mpg.execute();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212112214740.png" alt="image-20231212112214740"></p><p>拷贝到model模块</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212112250372.png" alt="image-20231212112250372"></p><p>model模块下的pom.xml添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-base<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-annotation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mybatis-plus-boot-starter.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mybatis-plus-boot-starter.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="设计接口"><a href="#设计接口" class="headerlink" title="设计接口"></a><strong>设计接口</strong></h4><p>接口设计分析包括下面几个方面:</p><ol><li>协议: 一般是HTTP, 查询类接口get或post, 查询条件较少的使用get, 较多的使用post, 本接口使用http post, 还要确定content-type, 参数以什么数据格式响应, 一般json</li><li>分析请求参数: 根据对数据模型的分析, 请求参数: 课程名称, 课程审核状态, 当前页码, 每页显示记录数, 根据分析的请求参数定义模型类</li><li>分析响应结果: 根据前边对数据模型的分析, 响应结果为数据列表加一些分页信息(总记录数, 当前页, 每页显示记录数), 数据列表(课程id, 课程名称, 任务数, 创建时间, 审核状态, 类型);  根据分析的响应结果定义模型类</li></ol><blockquote><p>注意: 查询结果中审核状态为数据字典中的代码字段, 前端会根据审核状态代码, 找到对应的名称显示</p></blockquote><ol start="4"><li>分析完成, 使用SpringBoot注解开发一个Http接口</li><li>使用接口文档工具查看接口内容</li><li>接口中调用service方法完成业务处理</li><li>接口调用service方法完成业务处理</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs json">POST /content/course/list?pageNo=<span class="hljs-number">2</span>&amp;pageSize=<span class="hljs-number">1</span><br>Content-Type<span class="hljs-punctuation">:</span> application/json<br><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;auditStatus&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;202002&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;courseName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;publishStatus&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br>###成功响应结果<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;items&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">26</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;companyId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1232141425</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;companyName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;spring cloud实战&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;users&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;所有人&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;tags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;mt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-3&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;mtName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;st&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-3-2&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;stName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;grade&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;200003&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;teachmode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;201001&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;pic&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;createDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2019-09-04 09:56:19&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;changeDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2021-12-26 22:10:38&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;createPeople&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;changePeople&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;auditStatus&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;202002&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;auditMind&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;auditNums&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;auditDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;auditPeople&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;coursePubId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;coursePubDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;counts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">23</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;page&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;pageSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p><strong>定义模型类</strong></p><p>根据接口分析需要定义模型类接收请求的参数, 定义模型类用于响应结果</p><ol><li>分页查询模型类</li></ol><p>由于分页查询接口在项目中较多, 针对<code>分页查询参数</code>(当前页码, 每页显示记录数) 单独在xuecheng-plus-base工程定义</p><p>PageParams.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.base.model;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 分页查询通用参数</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 11:50</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PagesParams</span> &#123;<br><br>    <span class="hljs-comment">// 当前页码</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> <span class="hljs-variable">pageNo</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">// 每页记录数默认值</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10L</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>查询条件模型类</li></ol><p>除了分页查询参数, 还有<code>课程查询参数</code>, 在model工程定义课程查询参数模型类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.model.dto;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 课程查询参数Dto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 11:53</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryCourseParamsDto</span> &#123;<br><br>    <span class="hljs-comment">// 审核状态</span><br>    <span class="hljs-keyword">private</span> String auditStatus;<br>    <span class="hljs-comment">// 课程名称</span><br>    <span class="hljs-keyword">private</span> String courseName;<br>    <span class="hljs-comment">// 发布状态</span><br>    <span class="hljs-keyword">private</span> String publishStatus;<br><br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>响应模型类</li></ol><p>根据接口分析, 定义响应结果模型类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.base.model;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 分页查询结果模型类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 11:56</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PageResult</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123; <span class="hljs-comment">// 泛型类实现Serializable, 保持对象一致性和稳定性</span><br><br>    <span class="hljs-comment">// 数据列表: 存放数据列表, 支持泛型, 课程查询接口的返回类型可以是此模型类型</span><br>    <span class="hljs-keyword">private</span> List&lt;T&gt; items;<br>    <span class="hljs-comment">// 总记录数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> counts;<br>    <span class="hljs-comment">// 当前页码</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> page;<br>    <span class="hljs-comment">// 每页记录数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> pageSize;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>List中的数据类型, 根据需求分析使用生成的PO类, 课程查询接口返回结果类型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 泛型中填写CourseBase类</span><br>PageResult&lt;CourseBase&gt;<br></code></pre></td></tr></table></figure><ol start="4"><li>定义接口(api模块)</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PagesParams;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CourseBase;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 课程信息编辑接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 12:10</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseBaseInfoController</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/course/list&quot;)</span>  <span class="hljs-comment">// 测试不用post</span><br>    <span class="hljs-keyword">public</span> PageResult&lt;CourseBase&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(PagesParams pagesParams,</span><br><span class="hljs-params">                                       <span class="hljs-meta">@RequestBody(required = false)</span> QueryCourseParamsDto queryCourseParams)</span>&#123; <span class="hljs-comment">// 接口接收两部分参数, 一部分是分页参数, 通过url 传递k-v , 另一部分是业务查询条件, 通过http body 传入 json 内容, 服务端使用RequestBody 接收json 内容, 我们在测试并没有传递json内容这里会报错</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>启动类(api模块)</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> xxx</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 12:17</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ContentApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="6"><li>添加配置文件</li></ol><p>bootstrap.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/content</span> <span class="hljs-comment"># 所有接口根路径</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">63040</span><br><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">content-api</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.101.65:3306/xc402_content148?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">mysql</span><br><span class="hljs-comment"># 日志文件配置路径</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">config:</span> <span class="hljs-string">classpath:log4j2-dev.xml</span><br></code></pre></td></tr></table></figure><p>log4j2-dev.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Configuration</span> <span class="hljs-attr">monitorInterval</span>=<span class="hljs-string">&quot;180&quot;</span> <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;logdir&quot;</span>&gt;</span>logs<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;PATTERN&quot;</span>&gt;</span>%date&#123;YYYY-MM-dd HH:mm:ss,SSS&#125; %level [%thread][%file:%line] - %msg%n%throwable<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Appenders</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Console</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Console&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;SYSTEM_OUT&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;$&#123;PATTERN&#125;&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">Console</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">RollingFile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ErrorAppender&quot;</span> <span class="hljs-attr">fileName</span>=<span class="hljs-string">&quot;$&#123;logdir&#125;/error.log&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">filePattern</span>=<span class="hljs-string">&quot;$&#123;logdir&#125;/$$&#123;date:yyyy-MM-dd&#125;/error.%d&#123;yyyy-MM-dd-HH&#125;.log&quot;</span> <span class="hljs-attr">append</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;$&#123;PATTERN&#125;&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">ThresholdFilter</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;ERROR&quot;</span> <span class="hljs-attr">onMatch</span>=<span class="hljs-string">&quot;ACCEPT&quot;</span> <span class="hljs-attr">onMismatch</span>=<span class="hljs-string">&quot;DENY&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">Policies</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">TimeBasedTriggeringPolicy</span> <span class="hljs-attr">interval</span>=<span class="hljs-string">&quot;1&quot;</span> <span class="hljs-attr">modulate</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">Policies</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">RollingFile</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">RollingFile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;DebugAppender&quot;</span> <span class="hljs-attr">fileName</span>=<span class="hljs-string">&quot;$&#123;logdir&#125;/info.log&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">filePattern</span>=<span class="hljs-string">&quot;$&#123;logdir&#125;/$$&#123;date:yyyy-MM-dd&#125;/info.%d&#123;yyyy-MM-dd-HH&#125;.log&quot;</span> <span class="hljs-attr">append</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;$&#123;PATTERN&#125;&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">ThresholdFilter</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;DEBUG&quot;</span> <span class="hljs-attr">onMatch</span>=<span class="hljs-string">&quot;ACCEPT&quot;</span> <span class="hljs-attr">onMismatch</span>=<span class="hljs-string">&quot;DENY&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">Policies</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">TimeBasedTriggeringPolicy</span> <span class="hljs-attr">interval</span>=<span class="hljs-string">&quot;1&quot;</span> <span class="hljs-attr">modulate</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">Policies</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">RollingFile</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!--异步appender--&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">Async</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;AsyncAppender&quot;</span> <span class="hljs-attr">includeLocation</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;ErrorAppender&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;DebugAppender&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">Async</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Appenders</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">Loggers</span>&gt;</span><br>         <span class="hljs-comment">&lt;!--过滤掉spring和mybatis的一些无用的debug信息</span><br><span class="hljs-comment">        &lt;logger name=&quot;org.springframework&quot; level=&quot;INFO&quot;&gt;</span><br><span class="hljs-comment">        &lt;/logger&gt;</span><br><span class="hljs-comment">        &lt;logger name=&quot;org.mybatis&quot; level=&quot;INFO&quot;&gt;</span><br><span class="hljs-comment">        &lt;/logger&gt;--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cn.itcast.wanxinp2p.consumer.mapper&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;DEBUG&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;springfox&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;INFO&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;org.apache.http&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;INFO&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.netflix.discovery&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;INFO&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>        <br>        <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;RocketmqCommon&quot;</span>  <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;INFO&quot;</span> &gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>       <br>       <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;RocketmqRemoting&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;INFO&quot;</span>  &gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>       <br>       <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;RocketmqClient&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;WARN&quot;</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;org.dromara.hmily&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;WARN&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;org.dromara.hmily.lottery&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;WARN&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;org.dromara.hmily.bonuspoint&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;WARN&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>       <br>        <span class="hljs-comment">&lt;!--OFF   0--&gt;</span><br>        <span class="hljs-comment">&lt;!--FATAL   100--&gt;</span><br>        <span class="hljs-comment">&lt;!--ERROR   200--&gt;</span><br>        <span class="hljs-comment">&lt;!--WARN   300--&gt;</span><br>        <span class="hljs-comment">&lt;!--INFO   400--&gt;</span><br>        <span class="hljs-comment">&lt;!--DEBUG   500--&gt;</span><br>        <span class="hljs-comment">&lt;!--TRACE   600--&gt;</span><br>        <span class="hljs-comment">&lt;!--ALL   Integer.MAX_VALUE--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;DEBUG&quot;</span> <span class="hljs-attr">includeLocation</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;AsyncAppender&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;Console&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;DebugAppender&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">Root</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Loggers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="7"><li>启动</li></ol><p><a href="http://localhost:63040/content/course/list">http://localhost:63040/content/course/list</a></p><p>400错误: 访问页面域名不存在或输入语法错误</p><p><strong>模型类的作用</strong></p><p>DTO数据传输对象, PO持久化对象, DTO接口层向业务层之间传输数据, PO用于业务层和持久层之间传输数据, 有些项目会设置VO对象, VO对象用在前端和接口层之间传输数据</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212152835665.png" alt="image-20231212152835665"></p><p>当前端有多个平台且接口有差异需要设置VO对象用于前端和接口层传输数据</p><p>比如：</p><p>课程列表查询接口，根据需求用户在手机端也要查询课程信息，此时课程查询接口是否需要编写手机端和PC端两个接口呢？如果用户要求通过手机和PC的查询条件或查询结果不一样，此时就需要定义两个Controller课程查询接口，每个接口定义VO对象与前端传输数据。</p><p>手机查询：根据课程状态查询，查询结果只有课程名称和课程状态。</p><p>PC查询：可以根据课程名称、课程状态、课程审核状态等条件查询，查询结果也比手机查询结果内容多。</p><p>此时，Service业务层尽量提供一个业务接口，即使两个前端接口需要的数据不一样，Service可以提供一个最全查询结果，由Controller进行数据整合</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212153130979.png" alt="image-20231212153130979"></p><p>如果前端接口没有多样性且比较固定, 可以取消VO, 只用DTO即可</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212153226561.png" alt="image-20231212153226561"></p><h4 id="生成接口文档"><a href="#生成接口文档" class="headerlink" title="生成接口文档"></a><strong>生成接口文档</strong></h4><p>在前后端分离开发中通常由后端程序员设计接口，完成后需要编写接口文档，最后将文档交给前端工程师，前端工程师参考文档进行开发。</p><p>可以通过一些工具快速生成接口文档 ，本项目通过Swagger生成接口在线文档 。</p><blockquote><p>什么是Swagger？</p><p>​    OpenAPI规范（OpenAPI Specification 简称OAS）是Linux基金会的一个项目，试图通过定义一种用来描述API格式或API定义的语言，来规范RESTful服务开发过程，目前版本是V3.0，并且已经发布并开源在github上。</p><p>（<a href="https://github.com/OAI/OpenAPI-Specification%EF%BC%89">https://github.com/OAI/OpenAPI-Specification）</a></p><p>​    Swagger是全球最大的OpenAPI规范（OAS）API开发工具框架，Swagger是一个在线接口文档的生成工具，前后端开发人员依据接口文档进行开发。 (<a href="https://swagger.io/">https://swagger.io/</a>)</p><p>Spring Boot 可以集成Swagger，Swaager根据Controller类中的注解生成接口文档 ，只要添加Swagger的依赖和配置信息即可使用它。</p></blockquote><ol><li>api工程添加依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Spring Boot 集成 swagger --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.spring4all<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>swagger-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>yml配置</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">swagger:</span><br>  <span class="hljs-attr">title:</span> <span class="hljs-string">&quot;学成在线内容管理系统&quot;</span><br>  <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;内容系统管理系统对课程相关信息进行管理&quot;</span><br>  <span class="hljs-attr">base-package:</span> <span class="hljs-string">com.xuecheng.content</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><br></code></pre></td></tr></table></figure><ol start="3"><li>启动类加 @EnableSwagger2Doc</li></ol><p>再次启动服务，工程启动起来，访问<a href="http://localhost:63040/content/swagger-ui.html%E6%9F%A5%E7%9C%8B%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF">http://localhost:63040/content/swagger-ui.html查看接口信息</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212155347584.png" alt="image-20231212155347584"></p><p><strong>加一些接口说明注解</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api(value = &quot;课程信息编辑接口&quot;,tags = &quot;课程信息编辑接口&quot;)</span><br> <span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseBaseInfoController</span> &#123;<br><br>  <span class="hljs-meta">@ApiOperation(&quot;课程查询接口&quot;)</span><br> <span class="hljs-meta">@PostMapping(&quot;/course/list&quot;)</span><br>  <span class="hljs-keyword">public</span> PageResult&lt;CourseBase&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(PageParams pageParams, <span class="hljs-meta">@RequestBody(required=false)</span> QueryCourseParamsDto queryCourseParams)</span>&#123;<br><br>     <span class="hljs-comment">//....</span><br><br>  &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.base.model;<br><br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 分页查询通用参数</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 11:50</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PagesParams</span> &#123;<br><br>    <span class="hljs-comment">// 当前页码</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;当前页码&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> <span class="hljs-variable">pageNo</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">// 每页记录数默认值</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;每页记录数默认值&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10L</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.model.dto;<br><br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 课程查询参数Dto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 11:53</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryCourseParamsDto</span> &#123;<br><br>    <span class="hljs-comment">// 审核状态</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;审核状态&quot;)</span><br>    <span class="hljs-keyword">private</span> String auditStatus;<br>    <span class="hljs-comment">// 课程名称</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;课程名称&quot;)</span><br>    <span class="hljs-keyword">private</span> String courseName;<br>    <span class="hljs-comment">// 发布状态</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;发布状态&quot;)</span><br>    <span class="hljs-keyword">private</span> String publishStatus;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Swagger常用注解</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api</span>：修饰整个类，描述Controller的作用    <br><span class="hljs-meta">@ApiOperation</span>：描述一个类的一个方法，或者说一个接口    <br><span class="hljs-meta">@ApiParam</span>：单个参数描述    <br><span class="hljs-meta">@ApiModel</span>：用对象来接收参数    <br><span class="hljs-meta">@ApiModelProperty</span>：用对象接收参数时，描述对象的一个字段    <br><span class="hljs-meta">@ApiResponse</span>：HTTP响应其中<span class="hljs-number">1</span>个描述    <br><span class="hljs-meta">@ApiResponses</span>：HTTP响应整体描述    <br><span class="hljs-meta">@ApiIgnore</span>：使用该注解忽略这个API    <br><span class="hljs-meta">@ApiError</span> ：发生错误返回的信息    <br><span class="hljs-meta">@ApiImplicitParam</span>：一个请求参数    <br><span class="hljs-meta">@ApiImplicitParams</span>：多个请求参数  <br></code></pre></td></tr></table></figure><p>@ApiImplicitParam属性如下：</p><table><thead><tr><th>属性</th><th>取值</th><th>作用</th></tr></thead><tbody><tr><td>paramType</td><td></td><td>查询参数类型</td></tr><tr><td></td><td>path</td><td>以地址的形式提交数据</td></tr><tr><td></td><td>query</td><td>直接跟参数完成自动映射赋值</td></tr><tr><td></td><td>body</td><td>以流的形式提交 仅支持POST</td></tr><tr><td></td><td>header</td><td>参数在request  headers 里边提交</td></tr><tr><td></td><td>form</td><td>以form表单的形式提交 仅支持POST</td></tr><tr><td>dataType</td><td></td><td>参数的数据类型 只作为标志说明，并没有实际验证</td></tr><tr><td></td><td>Long</td><td></td></tr><tr><td></td><td>String</td><td></td></tr><tr><td>name</td><td></td><td>接收参数名</td></tr><tr><td>value</td><td></td><td>接收参数的意义描述</td></tr><tr><td>required</td><td></td><td>参数是否必填</td></tr><tr><td></td><td>true</td><td>必填</td></tr><tr><td></td><td>false</td><td>非必填</td></tr><tr><td>defaultValue</td><td></td><td>默认值</td></tr></tbody></table><p>给接口添加假数据, 改为POST测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.api;<br><br><span class="hljs-keyword">import</span> com.spring4all.swagger.EnableSwagger2Doc;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PagesParams;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CourseBase;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 课程信息编辑接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 12:10</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@EnableSwagger2Doc</span><br><span class="hljs-meta">@Api(tags = &quot;课程信息编辑接口&quot;, value = &quot;课程信息编辑接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseBaseInfoController</span> &#123;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;课程查询接口&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/course/list&quot;)</span><br>    <span class="hljs-keyword">public</span> PageResult&lt;CourseBase&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(PagesParams pagesParams,</span><br><span class="hljs-params">                                       <span class="hljs-meta">@RequestBody(required = false)</span> QueryCourseParamsDto queryCourseParams)</span>&#123;<br>        <span class="hljs-type">CourseBase</span> <span class="hljs-variable">courseBase</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseBase</span>();<br>        courseBase.setName(<span class="hljs-string">&quot;测试名称&quot;</span>);<br>        courseBase.setCreateDate(LocalDateTime.now());<br>        List&lt;CourseBase&gt; courseBases = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        courseBases.add(courseBase);<br>        PageResult&lt;CourseBase&gt; pageResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>&lt;&gt;(courseBases, <span class="hljs-number">10</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>);<br>        <span class="hljs-keyword">return</span> pageResult;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212155724678.png" alt="image-20231212155724161"></p><p>这里日期的数据转了json返回给前台, 需要回到 <code>年月日时分秒</code></p><p><strong>修改日期格式</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212155804817.png" alt="image-20231212155804817"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.base.config;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.jackson.Jackson2ObjectMapperBuilderCustomizer;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalDateTimeConfig</span> &#123;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 序列化内容</span><br><span class="hljs-comment">     *   LocalDateTime -&gt; String</span><br><span class="hljs-comment">     * 服务端返回给客户端内容</span><br><span class="hljs-comment">     * */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> LocalDateTimeSerializer <span class="hljs-title function_">localDateTimeSerializer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalDateTimeSerializer</span>(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 反序列化内容</span><br><span class="hljs-comment">     *   String -&gt; LocalDateTime</span><br><span class="hljs-comment">     * 客户端传入服务端数据</span><br><span class="hljs-comment">     * */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> LocalDateTimeDeserializer <span class="hljs-title function_">localDateTimeDeserializer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalDateTimeDeserializer</span>(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));<br>    &#125;<br><br><br>    <span class="hljs-comment">// 配置</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Jackson2ObjectMapperBuilderCustomizer <span class="hljs-title function_">jackson2ObjectMapperBuilderCustomizer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> builder -&gt; &#123;<br>            builder.serializerByType(LocalDateTime.class, localDateTimeSerializer());<br>            builder.deserializerByType(LocalDateTime.class, localDateTimeDeserializer());<br>        &#125;;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>面试: </p><ol><li>springboot 接口开发常用注解有哪些?</li></ol><p>@Controller 标记此类是控制器, 可以返回视图解析器指定的<code>html页面</code>, 通过@ResponseBody可以将结果返回json xml数据, </p><p>@RestController 相当于 @ResponseBody 加 @Controller, 实现rest接口开发, 返回<code>json数据</code>, 不能返回html页面.</p><p>@RequestMapping 定义接口地址, 可以标注在<code>类</code>上也可以标注在<code>方法</code>上, 支持http的post get put等方法</p><p>@PostMapping 定义post接口, 只能标记在<code>方法</code>上, 用于添加记录, 复杂条件的查询接口</p><p>@GetMapping 定义get接口, 只能标记在方法上, 用于查询接口的定义</p><p>@PutMapping 定义 put接口, 只能标记在方法上， 用于修改接口的定义</p><p>@DeleteMapping定义delete接口, 只能标记在方法上, 用于删除接口的定义</p><p>@RequestBody 定义在方法上， 用于将<code>json串转换成java对象</code></p><p>@PathVarible 接收请求路径中占位符的值</p><p>@ApiOperation swagger注解, 对接口方法进行说明</p><p>@Api swagger注解, 对接口类进行说明</p><p>@Autowired 基于类型注入</p><p>@Resource 基于名称注入, 如果基于名称注入失败转为基于类型注入</p><ol start="2"><li><p>项目开发流程是什么?</p></li><li><p>产品人员设计<code>产品原型</code></p></li><li><p>讨论<code>需求</code></p></li><li><p>分模块<code>设计接口</code></p></li><li><p>出<code>接口文档</code></p></li><li><p>将<code>接口文档给前端人员</code>, 前后端分离开发</p></li><li><p>开发完毕进行<code>测试</code></p></li><li><p>测试完毕发布项目, 由<code>运维人员</code>进行部署安装</p></li></ol></blockquote><h4 id="开发持久层"><a href="#开发持久层" class="headerlink" title="开发持久层"></a>开发持久层</h4><p><strong>生成mapper</strong></p><p>将genenator生成的mapper文件导入</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212175600088.png" alt="image-20231212175600088"></p><p>mapper扫描配置和分页插件配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.config;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;<br><span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> Mybatis-Plus 配置</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 17:01</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@MapperScan(&quot;com.xuecheng.content.mapper&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定义分页拦截器</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();<br>        interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));<br>        <span class="hljs-keyword">return</span> interceptor;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>分页插件的原理: </p><ol><li>分页参数放到ThreadLocal 中, 拦截执行的sql, 根据数据库类型添加对应的分页语句重写sql ( select count(*) from table where a )  -&gt; (  select * from table where a limit   x,y    )</li><li>计算total总条数, records当前页数据</li></ol></blockquote><p>把yml和application文件复制到test</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212181131393.png" alt="image-20231212181131393"></p><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PagesParams;<br><span class="hljs-keyword">import</span> com.xuecheng.content.mapper.CourseBaseMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CourseBase;<br><span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Assertions;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> xxx</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 17:04</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseBaseMapperTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    CourseBaseMapper courseBaseMapper;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCourseBaseMapper</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">CourseBase</span> <span class="hljs-variable">courseBase</span> <span class="hljs-operator">=</span> courseBaseMapper.selectById(<span class="hljs-number">18</span>);<br>        Assertions.assertNotNull(courseBase); <span class="hljs-comment">// 用断言方式确定数据是否为空</span><br><br>        <span class="hljs-comment">// 详细进行分页查询的单元测试</span><br>        <span class="hljs-comment">// 查询条件</span><br>        <span class="hljs-type">QueryCourseParamsDto</span> <span class="hljs-variable">courseParamsDto</span> <span class="hljs-operator">=</span> QueryCourseParamsDto.builder()<br>                .courseName(<span class="hljs-string">&quot;java&quot;</span>)<br>                .auditStatus(<span class="hljs-string">&quot;202004&quot;</span>)<br>                .publishStatus(<span class="hljs-string">&quot;203001&quot;</span>)<br>                .build();<br><br>        <span class="hljs-comment">// 拼装查询条件</span><br>        LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        <span class="hljs-comment">// 根据名称模糊查询 name like &#x27;%名称%&#x27;</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">courseParamsDtoNotEmpty</span> <span class="hljs-operator">=</span> StringUtils.isNotEmpty(courseParamsDto.getCourseName());<br>        queryWrapper.like(courseParamsDtoNotEmpty, CourseBase::getName, courseParamsDto.getCourseName());<br><br>        <span class="hljs-comment">// 根据课程审核状态</span><br>        queryWrapper.eq(StringUtils.isNotEmpty(courseParamsDto.getAuditStatus()), CourseBase::getAuditStatus,<br>                courseParamsDto.getAuditStatus());<br><br>        <span class="hljs-comment">// 根据课程发布状态</span><br>        queryWrapper.eq(StringUtils.isNotEmpty(courseParamsDto.getPublishStatus()), CourseBase::getStatus,<br>                courseParamsDto.getPublishStatus());<br><br>        <span class="hljs-comment">// 创建page分页参数对象</span><br>        <span class="hljs-type">PagesParams</span> <span class="hljs-variable">pagesParams</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PagesParams</span>();<br>        pagesParams.setPageNo(<span class="hljs-number">1L</span>); <span class="hljs-comment">// 页码</span><br>        pagesParams.setPageSize(<span class="hljs-number">2L</span>); <span class="hljs-comment">// 每页记录数</span><br>        Page&lt;CourseBase&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(pagesParams.getPageNo(), pagesParams.getPageSize());<br><br>        <span class="hljs-comment">// 分页查询 E page 分页参数, @Param(&quot;ew&quot;) Wrapper&lt;T&gt; queryWrapper 查询条件</span><br>        Page&lt;CourseBase&gt; pageResult = courseBaseMapper.selectPage(page, queryWrapper);<br><br>        <span class="hljs-comment">// 数据</span><br>        List&lt;CourseBase&gt; items = pageResult.getRecords();<br>        <span class="hljs-comment">// 总记录数</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> pageResult.getTotal();<br>        <span class="hljs-comment">// 准备返回数据 List&lt;T&gt; items, long counts, long page, long pageSize</span><br>        PageResult&lt;CourseBase&gt; courseBasePageResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>&lt;&gt;(items, total, pagesParams.getPageNo(),<br>                pagesParams.getPageSize());<br><br>        System.out.println(JSON.toJSONString(courseBasePageResult));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="开发业务层"><a href="#开发业务层" class="headerlink" title="开发业务层"></a>开发业务层</h4><p>创建数据字典表, 课程基本信息查询的主要数据来源是课程基本信息表,</p><p><strong>创建数据字典表</strong></p><p>课程基本信息查询主要数据来源是<code>课程基本信息表</code>, 这里有一个点, 课程的<code>审查状态</code>, <code>发布状态</code></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212210013694.png" alt="image-20231212210013694"></p><p>这里状态存的是数字, 然后我们有一个字典表, 对应不同的状态</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212210110700.png" alt="image-20231212210110700"></p><blockquote><p>所以为什么不存字符串, 而是加一个中间code;  如果客户需要改desc的内容, 我们不能修改内容表, 而是修改字典表, 这样避免修改用户数据的风险</p></blockquote><p>编写service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PagesParams;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CourseBase;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 课程信息管理接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/12 20:08</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CourseBaseInfoService</span> &#123;<br>    <span class="hljs-comment">// 课程分页查询</span><br>    PageResult&lt;CourseBase&gt; <span class="hljs-title function_">queryCourseBaseList</span><span class="hljs-params">(PagesParams pagesParams, QueryCourseParamsDto courseParamsDto)</span>;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PagesParams;<br><span class="hljs-keyword">import</span> com.xuecheng.content.mapper.CourseBaseMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CourseBase;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/12 20:11</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseBaseInfoServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CourseBaseInfoService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    CourseBaseMapper courseBaseMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PageResult&lt;CourseBase&gt; <span class="hljs-title function_">queryCourseBaseList</span><span class="hljs-params">(PagesParams pagesParams, QueryCourseParamsDto courseParamsDto)</span> &#123;<br><br>        <span class="hljs-comment">// 拼装查询条件</span><br>        LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        <span class="hljs-comment">// 根据名称模糊查询 name like &#x27;%名称%&#x27;</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">courseParamsDtoNotEmpty</span> <span class="hljs-operator">=</span> StringUtils.isNotEmpty(courseParamsDto.getCourseName());<br>        queryWrapper.like(courseParamsDtoNotEmpty, CourseBase::getName, courseParamsDto.getCourseName());<br><br>        <span class="hljs-comment">// 根据课程审核状态</span><br>        queryWrapper.eq(StringUtils.isNotEmpty(courseParamsDto.getAuditStatus()), CourseBase::getAuditStatus,<br>                courseParamsDto.getAuditStatus());<br><br>        <span class="hljs-comment">// 根据课程发布状态</span><br>        queryWrapper.eq(StringUtils.isNotEmpty(courseParamsDto.getPublishStatus()), CourseBase::getStatus,<br>                courseParamsDto.getPublishStatus());<br><br>        Page&lt;CourseBase&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(pagesParams.getPageNo(), pagesParams.getPageSize());<br><br>        <span class="hljs-comment">// 分页查询 E page 分页参数, @Param(&quot;ew&quot;) Wrapper&lt;T&gt; queryWrapper 查询条件</span><br>        Page&lt;CourseBase&gt; pageResult = courseBaseMapper.selectPage(page, queryWrapper);<br><br>        <span class="hljs-comment">// 数据</span><br>        List&lt;CourseBase&gt; items = pageResult.getRecords();<br>        <span class="hljs-comment">// 总记录数</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> pageResult.getTotal();<br>        <span class="hljs-comment">// 准备返回数据 List&lt;T&gt; items, long counts, long page, long pageSize</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>&lt;&gt;(items, total, pagesParams.getPageNo(),<br>                pagesParams.getPageSize());<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>对service进行单元测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PagesParams;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CourseBase;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> xxx</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 17:04</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseBaseInfoServiceTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    CourseBaseInfoService courseBaseInfoService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCourseBaseInfoService</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// 详细进行分页查询的单元测试</span><br>        <span class="hljs-comment">// 查询条件</span><br>        <span class="hljs-type">QueryCourseParamsDto</span> <span class="hljs-variable">courseParamsDto</span> <span class="hljs-operator">=</span> QueryCourseParamsDto.builder()<br>                .courseName(<span class="hljs-string">&quot;java&quot;</span>)<br>                .auditStatus(<span class="hljs-string">&quot;202004&quot;</span>)<br>                .publishStatus(<span class="hljs-string">&quot;203001&quot;</span>)<br>                .build();<br>        <span class="hljs-comment">// 创建page分页参数对象</span><br>        <span class="hljs-type">PagesParams</span> <span class="hljs-variable">pagesParams</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PagesParams</span>();<br>        pagesParams.setPageNo(<span class="hljs-number">1L</span>); <span class="hljs-comment">// 页码</span><br>        pagesParams.setPageSize(<span class="hljs-number">2L</span>); <span class="hljs-comment">// 每页记录数</span><br>        PageResult&lt;CourseBase&gt; courseBasePageResult =<br>                courseBaseInfoService.queryCourseBaseList(pagesParams, courseParamsDto);<br>        System.out.println(courseBasePageResult);<br>    &#125;<br><br><br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h4><p>编写controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.api;<br><br><span class="hljs-keyword">import</span> com.spring4all.swagger.EnableSwagger2Doc;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PagesParams;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CourseBase;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 课程信息编辑接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/12/12 12:10</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@EnableSwagger2Doc</span><br><span class="hljs-meta">@Api(tags = &quot;课程信息编辑接口&quot;, value = &quot;课程信息编辑接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseBaseInfoController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    CourseBaseInfoService courseBaseInfoService;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;课程查询接口&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/course/list&quot;)</span><br>    <span class="hljs-keyword">public</span> PageResult&lt;CourseBase&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(PagesParams pagesParams,</span><br><span class="hljs-params">                                       <span class="hljs-meta">@RequestBody</span> QueryCourseParamsDto queryCourseParams)</span>&#123;<br>        <span class="hljs-keyword">return</span> courseBaseInfoService.queryCourseBaseList(pagesParams, queryCourseParams);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>swagger测试</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212210652261.png" alt="image-20231212210652261"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212210658181.png" alt="image-20231212210658181"></p><p>httpclient测试</p><p>将.http文件按模块和主机地址配置文件单独存放</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212210916532.png" alt="image-20231212210916532"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;dev&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;access_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;gateway_host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost:63010&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;content_host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost:63040&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;system_host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost:63110&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;media_host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost:63050&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;search_host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost:63080&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;auth_host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost:63070&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;checkcode_host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost:63075&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;learning_host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost:63020&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">### 课程查询列表<br>POST &#123;&#123;content_host&#125;&#125;/content/course/list?pageParams=1&amp;pageSize=2<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><br>&#123;<br>  &quot;auditStatus&quot;: &quot;&quot;,<br>  &quot;courseName&quot;: &quot;java&quot;,<br>  &quot;publishStatus&quot;: &quot;&quot;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a>前后端联调</h4><blockquote><p>后端编写文档, 文档给前端, 前后端并行开发, 前端mock假数据, 后端接口联调, 前端将mock数据改为请求后端的接口, 前端请求后端测试接口是否正常</p></blockquote><p>用IDEA打开vue工程, 出错</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">npm install -g cnpm <span class="hljs-attribute">--registry</span>=https://registry.npm.taobao.org<br>cnpm i<br>npm <span class="hljs-built_in">run</span> serve<br></code></pre></td></tr></table></figure><p>后端开启跨域(关于跨域问题, 总结在单独的文章)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.system.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.cors.CorsConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;<br><span class="hljs-keyword">import</span> org.springframework.web.filter.CorsFilter;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 跨域过虑器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/7 11:04</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@Configuration</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalCorsConfig</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 允许跨域调用的过滤器</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> CorsFilter <span class="hljs-title function_">corsFilter</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-type">CorsConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsConfiguration</span>();<br>   <span class="hljs-comment">//允许白名单域名进行跨域调用</span><br>   config.addAllowedOrigin(<span class="hljs-string">&quot;*&quot;</span>);<br>   <span class="hljs-comment">//允许跨越发送cookie</span><br>   config.setAllowCredentials(<span class="hljs-literal">true</span>);<br>   <span class="hljs-comment">//放行全部原始头信息</span><br>   config.addAllowedHeader(<span class="hljs-string">&quot;*&quot;</span>);<br>   <span class="hljs-comment">//允许所有请求方法跨域调用</span><br>   config.addAllowedMethod(<span class="hljs-string">&quot;*&quot;</span>);<br>   <span class="hljs-type">UrlBasedCorsConfigurationSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBasedCorsConfigurationSource</span>();<br>   source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, config);<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsFilter</span>(source);<br>  &#125;<br> &#125;<br><br></code></pre></td></tr></table></figure><p><a href="http://localhost:63110/system/dictionary/all">http://localhost:63110/system/dictionary/all</a></p><p><a href="http://localhost:8601/">http://localhost:8601</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212221419802.png" alt="image-20231212221419802"></p><h3 id="课程分类查询"><a href="#课程分类查询" class="headerlink" title="课程分类查询"></a>课程分类查询</h3><h4 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213154939950.png" alt="image-20231213154939950"></p><p>这3个课程等级和课程类型来源于数据字典表, 在系统管理服务读取, 而课程分类信息单独一张课程分类表, 存储在内容管理数据库中</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213155131812.png" alt="image-20231213155131812"></p><p>这张表是一个树形表, 通过父节点id将各元素组成一个树</p><p>需求: 在内容管理服务中编写一个接口读取课程分类表的数据, 组成一个<code>树形结构</code>给前端</p><p>这个树形结构数据: </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><code class="hljs json">JSON<br> <span class="hljs-punctuation">[</span><br>         <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-1&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HTML/CSS&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HTML/CSS&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-2&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JavaScript&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JavaScript&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-3&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jQuery&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jQuery&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-4&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ExtJS&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ExtJS&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-5&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AngularJS&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AngularJS&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-6&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ReactJS&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ReactJS&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-7&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Bootstrap&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Bootstrap&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-8&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Node.js&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Node.js&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-9&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Vue&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Vue&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-10&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;其它&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;其它&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;前端开发&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;前端开发&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><br>         <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2-1&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;微信开发&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;微信开发&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2-2&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;iOS&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;iOS&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2-3&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;手游开发&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;手游开发&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2-4&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Swift&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Swift&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2-5&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Android&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Android&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2-6&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ReactNative&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ReactNative&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2-7&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Cordova&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Cordova&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;childrenTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2-8&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;其它&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;其它&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-2&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;isLeaf&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;isShow&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;label&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;移动开发&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;移动开发&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><br>         <span class="hljs-punctuation">&#125;</span><br>   <span class="hljs-punctuation">]</span><br><br></code></pre></td></tr></table></figure><h4 id="DTO"><a href="#DTO" class="headerlink" title="DTO"></a>DTO</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.model.dto;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CourseCategory;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Serializable 将来网络传输需要序列化</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/13 10:21</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseCategoryTreeDto</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CourseCategory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    List&lt;CourseCategoryTreeDto&gt;  childrenTreeNodes;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CourseCategoryTreeDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CourseCategoryService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 数据字典， 前端控制器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/13 10:50</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseCategoryController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    CourseCategoryService courseCategoryService;<br><br>    <span class="hljs-comment">// 树级节点问题</span><br>    <span class="hljs-meta">@GetMapping(&quot;/course-category/tree-nodes&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="hljs-title function_">queryTreeNodes</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> courseCategoryService.queryTreeNodes(<span class="hljs-string">&quot;1&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="service-注意逻辑"><a href="#service-注意逻辑" class="headerlink" title="service(注意逻辑)"></a>service(注意逻辑)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.service.impl;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.mapper.CourseCategoryMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CourseCategoryTreeDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CourseCategoryService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/13 11:47</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseCategoryServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CourseCategoryService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    CourseCategoryMapper courseCategoryMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="hljs-title function_">queryTreeNodes</span><span class="hljs-params">(String id)</span> &#123;<br>        <span class="hljs-comment">// 调用mapper递归查询分类信息</span><br>        List&lt;CourseCategoryTreeDto&gt; courseCategoryTreeDtos = courseCategoryMapper.selectTreeNodes(id);<br><br>        <span class="hljs-comment">// 找到每个节点的子节点, 最终封装成List&lt;CourseCategoryTreeDto&gt;</span><br>        <span class="hljs-comment">// 将List转Map, key是节点的id, value是CourseCategoryTreeDto对象, 目的是为了方便从map获取节点</span><br>        Map&lt;String, CourseCategoryTreeDto&gt; mapTemp = courseCategoryTreeDtos.stream()<br>                <span class="hljs-comment">// filter排除根节点(id = 1)</span><br>                .filter(item-&gt;!id.equals(item.getId()))<br>                <span class="hljs-comment">//  key是list中元素的id, value不变, 如果key1和key2在遍历时发生重复, 我们用后面的key2</span><br>                .collect(Collectors.toMap(key -&gt; key.getId(), value -&gt; value, (key1, key2) -&gt; key2));<br><br>        <span class="hljs-comment">// 定义一个list, 用于最终返回</span><br>        List&lt;CourseCategoryTreeDto&gt; courseCategoryList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-comment">// 从头遍历list,filter排除根节点(id = 1), 一边遍历一边找子节点放在父节点的childrenTreeNodes</span><br>        courseCategoryTreeDtos.stream()<br>                .filter(item-&gt;!id.equals(item.getId()))<br>                .forEach(item-&gt;&#123;<br>                    <span class="hljs-comment">// 结论: 假设 listTree 共三级, 一级被过滤, 如果二级则走第一个if分支, 如果三级则走第二个if分支</span><br><br>                    <span class="hljs-comment">// 放入根节点的子节点作为 返回listTree的 `一级节点`</span><br>                    <span class="hljs-keyword">if</span> (item.getParentid().equals(id))&#123;<br>                        courseCategoryList.add(item);<br>                    &#125;<br><br>                    <span class="hljs-comment">// 找到当前节点的父节点</span><br>                    <span class="hljs-type">CourseCategoryTreeDto</span> <span class="hljs-variable">courseCategoryTreeDto</span> <span class="hljs-operator">=</span> mapTemp.get(item.getParentid());<br>                    <span class="hljs-comment">// 如果map中过滤了id=1, 不为空表示这里 item 不是二级节点(id=1-1), 应该至多三级(id=1-1-1),</span><br>                    <span class="hljs-comment">// 而这个courseCategoryTreeDto就至多二级(id=1-1), 这里的Dto是已经走过第一个if分支的item,</span><br>                    <span class="hljs-comment">// 所以下面add不往courseCategoryList, 而是 Dto</span><br>                    <span class="hljs-keyword">if</span> (courseCategoryTreeDto != <span class="hljs-literal">null</span>)&#123;<br>                        <span class="hljs-keyword">if</span> (courseCategoryTreeDto.getChildrenTreeNodes() == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// 二级节点的ChildrenTreeNodes属性为null, 我们new</span><br>                            courseCategoryTreeDto.setChildrenTreeNodes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;CourseCategoryTreeDto&gt;());<br>                        &#125;<br>                        <span class="hljs-comment">// 往ChildrenTreeNodes属性中放子节点</span><br>                        courseCategoryTreeDto.getChildrenTreeNodes().add(item);<br>                    &#125;<br>                &#125;);<br><br>        <span class="hljs-keyword">return</span> courseCategoryList;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="mapper"><a href="#mapper" class="headerlink" title="mapper"></a>mapper</h4><blockquote><p>这里mapper查法有inner join自连接, 和recursive递归两种方案, 递归更加<code>通用</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br>one.id one_id,<br>one.label one_label,<br>two.id two_id,<br>two.label two_label <br><span class="hljs-keyword">FROM</span><br>`course_category` <span class="hljs-keyword">one</span><br><span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> course_category two <span class="hljs-keyword">ON</span> two.parentid <span class="hljs-operator">=</span> one.id <br><span class="hljs-keyword">WHERE</span><br>one.parentid <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <br><span class="hljs-keyword">AND</span> one.is_show <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <br><span class="hljs-keyword">AND</span> two.is_show <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>one.orderby,<br>two.orderby<br><br><span class="hljs-keyword">with</span> <span class="hljs-keyword">RECURSIVE</span> t1  <span class="hljs-keyword">AS</span><br>(<br>  <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> n<br>  <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><br>  <span class="hljs-keyword">SELECT</span> n <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> t1 <span class="hljs-keyword">WHERE</span> n <span class="hljs-operator">&lt;</span> <span class="hljs-number">5</span><br>)<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t1;<br><br># 向下递归<br><span class="hljs-keyword">with</span> <span class="hljs-keyword">recursive</span> t1 <span class="hljs-keyword">as</span> (<br> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>  course_category p <span class="hljs-keyword">where</span>  id<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1&#x27;</span><br> <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span><br> <span class="hljs-keyword">select</span> t.<span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> course_category t <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> t1 <span class="hljs-keyword">on</span> t1.id <span class="hljs-operator">=</span> t.parentid<br>)<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span>  <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> t1.id, t1.orderby<br><br># 向上递归<br><span class="hljs-keyword">with</span> <span class="hljs-keyword">recursive</span> t1 <span class="hljs-keyword">as</span> (<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>  course_category p <span class="hljs-keyword">where</span>  id<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1-1-1&#x27;</span><br><span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span><br> <span class="hljs-keyword">select</span> t.<span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> course_category t <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> t1 <span class="hljs-keyword">on</span> t1.parentid <span class="hljs-operator">=</span> t.id<br>)<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span>  <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> t1.id, t1.orderby<br></code></pre></td></tr></table></figure><p>我们采用<code>递归</code>方式</p><p>mysql避免无限递归默认递归次数1000, 通过参数增加递归深度, 限制递归时间</p><p>相当于存储过程执行若干sql语句, java与数据库建立一次链接执行递归操作, 只要控制好递归深度, 性能没有问题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CourseCategoryTreeDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CourseCategory;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 课程分类 Mapper 接口</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itcast</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CourseCategoryMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;CourseCategory&gt; &#123;<br>    List&lt;CourseCategoryTreeDto&gt; <span class="hljs-title function_">selectTreeNodes</span><span class="hljs-params">(String id)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectTreeNodes&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.xuecheng.content.model.dto.CourseCategoryTreeDto&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>&gt;</span><br>    with recursive t1 as (<br>        select * from  course_category p where  id= #&#123;id&#125;<br>        union all<br>        select t.* from course_category t inner join t1 on t1.id = t.parentid<br>    )<br>    select *  from t1 order by t1.id, t1.orderby<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="测试service"><a href="#测试service" class="headerlink" title="测试service"></a>测试service</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.CourseCategoryTreeDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.CourseCategoryService;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/13 16:00</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseCategoryServiceTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    CourseCategoryService courseCategoryService;<br><br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span>&#123;<br>        List&lt;CourseCategoryTreeDto&gt; courseCategoryTreeDtos = courseCategoryService.queryTreeNodes(<span class="hljs-string">&quot;1&quot;</span>);<br>        System.out.println(JSON.toJSONString(courseCategoryTreeDtos));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="测试接口"><a href="#测试接口" class="headerlink" title="测试接口"></a>测试接口</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213165458999.png" alt="image-20231213165458999"></p><h4 id="前后端联调-1"><a href="#前后端联调-1" class="headerlink" title="前后端联调"></a>前后端联调</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213165734568.png" alt="image-20231213165734568"></p><h3 id="新增课程"><a href="#新增课程" class="headerlink" title="新增课程"></a>新增课程</h3><h4 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213165812252.png" alt="image-20231213165812252"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213165825088.png" alt="image-20231213165825088"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213165907293.png" alt="image-20231213165907293"></p><p>在表单填入课程基本信息, 下一步</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213170043851.png" alt="image-20231213170043851"></p><p>添加章节, 上传视频,下一步</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213170138973.png" alt="image-20231213170138973"></p><p>维护老师, 可以添加老师</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213170214715.png" alt="image-20231213170214715"></p><p>完成</p><h4 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h4><p>新增课程按钮, 向课程基本信息, 课程营销信息添加记录(course_base   course_market)</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213170510366.png" alt="image-20231213170510366"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213170517609.png" alt="image-20231213170517609"></p><h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs json">Java<br>### 创建课程<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>content_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/content/course<br>Content-Type<span class="hljs-punctuation">:</span> application/json<br><br><span class="hljs-punctuation">&#123;</span><br><br>  <span class="hljs-attr">&quot;mt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;st&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;pic&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;teachmode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;200002&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;users&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;初级人员&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;tags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;grade&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;204001&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;charge&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;201000&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;originalPrice&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;qq&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;wechat&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;phone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;validDays&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">365</span><br><span class="hljs-punctuation">&#125;</span><br><br>###响应结果如下<br>#成功响应结果如下<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">109</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;companyId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;companyName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;测试课程103&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;users&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;初级人员&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;tags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;mt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;mtName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;st&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1-1-1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;stName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;grade&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;204001&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;teachmode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;200002&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;pic&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;createDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2022-09-08 07:35:16&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;changeDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;createPeople&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;changePeople&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;auditStatus&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;202002&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;coursePubId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;coursePubDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;charge&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;201000&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;originalPrice&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;qq&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;wechat&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;phone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;validDays&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">365</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><h4 id="controller-1"><a href="#controller-1" class="headerlink" title="controller"></a>controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/course&quot;)</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">createCourseBase</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddCourseDto addCourseDto)</span>&#123;<br>    <span class="hljs-comment">// 机构id, 由于认证系统没有上限暂时硬编码</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br>    <span class="hljs-keyword">return</span> courseBaseInfoService.createCourseBase(companyId, addCourseDto);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="service"><a href="#service" class="headerlink" title="service"></a>service</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增课程基础信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> companyId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">createCourseBase</span><span class="hljs-params">(Long companyId, AddCourseDto dto)</span> &#123;<br>    <span class="hljs-comment">// 合法性校验</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getName())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;课程名称为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getMt())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;课程分类为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getSt())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;课程名称为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getGrade())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;课程等级为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getTeachmode())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;教育模式为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getUsers())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;适应人群为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getCharge())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;收费规则为空&quot;</span>);<br><br>    <span class="hljs-comment">// 新增对象</span><br>    <span class="hljs-type">CourseBase</span> <span class="hljs-variable">courseBaseNew</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseBase</span>();<br>    <span class="hljs-comment">// 将课程信息赋值给新增对象</span><br>    BeanUtils.copyProperties(dto, courseBaseNew);<br>    <span class="hljs-comment">// 设置审核状态</span><br>    courseBaseNew.setAuditStatus(<span class="hljs-string">&quot;202002&quot;</span>);<br>    <span class="hljs-comment">// 设置发布状态</span><br>    courseBaseNew.setStatus(<span class="hljs-string">&quot;203001&quot;</span>);<br>    <span class="hljs-comment">// 机构id</span><br>    courseBaseNew.setCompanyId(companyId);<br>    <span class="hljs-comment">// 添加时间</span><br>    courseBaseNew.setCreateDate(LocalDateTime.now());<br>    <span class="hljs-comment">// 插入课程基本信息表</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> courseBaseMapper.insert(courseBaseNew);<br>    <span class="hljs-keyword">if</span> (insert &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;新增课程基本信息失败&quot;</span>);<br><br>    <span class="hljs-comment">// 向课程营销表保存课程营销信息</span><br>    <span class="hljs-type">CourseMarket</span> <span class="hljs-variable">courseMarketNew</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseMarket</span>();<br>    BeanUtils.copyProperties(dto, courseMarketNew);<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">courseId</span> <span class="hljs-operator">=</span> courseBaseNew.getId();<br>    courseMarketNew.setId(courseId);<br>    <span class="hljs-comment">// 向课程营销表插入数据或更新数据</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> saveCourseMarket(courseMarketNew);<br>    <span class="hljs-keyword">if</span> (i&lt;=<span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;保存课程营销信息失败&quot;</span>);<br><br>    <span class="hljs-comment">// 查询课程基本信息及营销信息并返回</span><br>    <span class="hljs-keyword">return</span> getCourseBaseInfo(courseId);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询课程基本信息及营销信息并返回</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> CourseBaseInfoDto <span class="hljs-title function_">getCourseBaseInfo</span><span class="hljs-params">(Long courseId)</span> &#123;<br>    <span class="hljs-type">CourseBase</span> <span class="hljs-variable">courseBase</span> <span class="hljs-operator">=</span> courseBaseMapper.selectById(courseId);<br>    <span class="hljs-keyword">if</span> (courseBase==<span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">CourseMarket</span> <span class="hljs-variable">courseMarket</span> <span class="hljs-operator">=</span> courseMarketMapper.selectById(courseId);<br>    <span class="hljs-type">CourseBaseInfoDto</span> <span class="hljs-variable">courseBaseInfoDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseBaseInfoDto</span>();<br>    BeanUtils.copyProperties(courseBase, courseBaseInfoDto);<br>    <span class="hljs-keyword">if</span> (courseMarket != <span class="hljs-literal">null</span>)<br>        BeanUtils.copyProperties(courseMarket, courseBaseInfoDto);<br>    <span class="hljs-comment">// 查询分类名称</span><br>    <span class="hljs-type">CourseCategory</span> <span class="hljs-variable">courseCategoryBySt</span> <span class="hljs-operator">=</span> courseCategoryMapper.selectById(courseBase.getSt());<br>    courseBaseInfoDto.setStName(courseCategoryBySt.getName());<br>    <span class="hljs-type">CourseCategory</span> <span class="hljs-variable">courseCategoryByMt</span> <span class="hljs-operator">=</span> courseCategoryMapper.selectById(courseBase.getMt());<br>    courseBaseInfoDto.setMtName(courseCategoryByMt.getName());<br><br>    <span class="hljs-keyword">return</span> courseBaseInfoDto;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 向课程营销表插入数据或更新数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseMarketNew</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">saveCourseMarket</span><span class="hljs-params">(CourseMarket courseMarketNew)</span> &#123;<br>    <span class="hljs-comment">// 收费规则</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">charge</span> <span class="hljs-operator">=</span> courseMarketNew.getCharge();<br>    <span class="hljs-type">Float</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> courseMarketNew.getPrice();<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(charge)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;收费规则没有选择&quot;</span>);<br>    <span class="hljs-comment">// 收费规则为收费</span><br>    <span class="hljs-keyword">if</span> (charge.equals(<span class="hljs-string">&quot;201001&quot;</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (price == <span class="hljs-literal">null</span> || price &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;课程为收费价格不能为空且必须大于0&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 根据id从课程营销表查询</span><br>    <span class="hljs-type">CourseMarket</span> <span class="hljs-variable">courseMarketObj</span> <span class="hljs-operator">=</span> courseMarketMapper.selectById(courseMarketNew.getId());<br>    <span class="hljs-keyword">if</span> (courseMarketObj == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> courseMarketMapper.insert(courseMarketNew);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        BeanUtils.copyProperties(courseMarketNew, courseMarketObj);<br>        courseMarketObj.setId(courseMarketNew.getId());<br>        <span class="hljs-keyword">return</span> courseMarketMapper.updateById(courseMarketObj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a>接口测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">### 创建课程</span><br>POST &#123;&#123;content_host&#125;&#125;/content/course<br>Content-Type: application/json<br><br>&#123;<br><br>  <span class="hljs-string">&quot;mt&quot;</span>: <span class="hljs-string">&quot;1-1&quot;</span>,<br>  <span class="hljs-string">&quot;st&quot;</span>: <span class="hljs-string">&quot;1-1-1&quot;</span>,<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;java&quot;</span>,<br>  <span class="hljs-string">&quot;pic&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;teachmode&quot;</span>: <span class="hljs-string">&quot;200002&quot;</span>,<br>  <span class="hljs-string">&quot;users&quot;</span>: <span class="hljs-string">&quot;初级人员&quot;</span>,<br>  <span class="hljs-string">&quot;tags&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;grade&quot;</span>: <span class="hljs-string">&quot;204001&quot;</span>,<br>  <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;charge&quot;</span>: <span class="hljs-string">&quot;201000&quot;</span>,<br>  <span class="hljs-string">&quot;price&quot;</span>: 0,<br>  <span class="hljs-string">&quot;originalPrice&quot;</span>:0,<br>  <span class="hljs-string">&quot;qq&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;wechat&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;validDays&quot;</span>: 365<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213182004016.png" alt="image-20231213182004016"></p><h4 id="前后端联调-2"><a href="#前后端联调-2" class="headerlink" title="前后端联调"></a>前后端联调</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213182458219.png" alt="image-20231213182458219"></p><h4 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h4><p><strong>问题分析</strong></p><p>我们上一步把name填成空</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213182803776.png" alt="image-20231213182803776"></p><p>按照合法性校验, 应该返回错误信息  <code>课程名称为空</code>, 这里返回 <code>Internal Server Error</code> 不友好</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">if (<span class="hljs-name">StringUtils</span>.isBlank(<span class="hljs-name">dto</span>.getName())) throw new RuntimeException(<span class="hljs-string">&quot;课程名称为空&quot;</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>没有输出我们抛出异常指定的异常信息，我们的需求是当正常操作按接口要求返回数据，当非正常流程要获取异常信息进行记录，并提示给用户</p><p>异常处理除了输出日志, 还要提示给用户, 前端和后端做一些约定</p><ol><li>错误提示信息统一<code>json</code>格式返回前端</li><li>以HTTP状态码决定是否出错, 非200为操作异常</li></ol><p>规范异常信息?</p><p>代码统一抛出的是自定义异常, 需要统一<code>捕获</code>,  规范了异常类型就可以获取异常信息</p><p>捕获后非项目自定义异常类型统一向用户提示<code>执行过程异常, 请重试</code> 错误信息</p><p>如何捕获异常?</p><p>try&#x2F;catch 比较臃肿, 通过MVC 控制器增强类统一有一个类完成异常捕获</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213194604949.png" alt="image-20231213194604949"></p><p><strong>统一异常实现</strong></p><p><strong>通用的异常信息</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.base.execption;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 通用错误信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/6 11:29</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">CommonError</span> &#123;<br><br>    UNKOWN_ERROR(<span class="hljs-string">&quot;执行过程异常，请重试。&quot;</span>),<br>    PARAMS_ERROR(<span class="hljs-string">&quot;非法参数&quot;</span>),<br>    OBJECT_NULL(<span class="hljs-string">&quot;对象为空&quot;</span>),<br>    QUERY_NULL(<span class="hljs-string">&quot;查询结果为空&quot;</span>),<br>    REQUEST_NULL(<span class="hljs-string">&quot;请求参数为空&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> String errMessage;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getErrMessage</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-keyword">return</span> errMessage;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">CommonError</span><span class="hljs-params">( String errMessage)</span> &#123;<br>       <span class="hljs-built_in">this</span>.errMessage = errMessage;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>自定义异常类型</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.base.execption;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 学成在线项目异常类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/13 19:50</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XueChengPlusException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span>&#123;<br>    <span class="hljs-keyword">private</span> String errMessage;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">XueChengPlusException</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">XueChengPlusException</span><span class="hljs-params">(String errMessage)</span> &#123;<br>        <span class="hljs-built_in">super</span>(errMessage);<br>        <span class="hljs-built_in">this</span>.errMessage = errMessage;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getErrMessage</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> errMessage;<br>    &#125;<br><br>    <span class="hljs-comment">// 抛出通用信息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cast</span><span class="hljs-params">(CommonError commonError)</span>&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(commonError.getErrMessage());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cast</span><span class="hljs-params">(String errMessage)</span>&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(errMessage);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>响应用户的统一类型</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.base.execption;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 响应用户的统一类型</span><br><span class="hljs-comment"> * 和前端约定返回的异常信息模型</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/13 19:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestErrorResponse</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> String errMessage;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RestErrorResponse</span><span class="hljs-params">(String errMessage)</span> &#123;<br>        <span class="hljs-built_in">this</span>.errMessage = errMessage;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">RestErrorResponse</span><span class="hljs-params">(String errMessage)</span> &#123;<br>        <span class="hljs-built_in">this</span>.errMessage = errMessage;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getErrMessage</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> errMessage;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>全局异常处理器</strong></p><blockquote><p><code>@ExceptionHandler</code>  标识于方法或类的注解, 用来表名方法的处理异常类型</p><p><code>@ControllerAdvice</code> 控制器增强, 对@Controller的增强, 和@ExceptionHandler结合使用, 处理MVC的异常信息</p><p><code>@ResponseStatus</code>  是状态代码或返回的原因标记方法或异常类, 标识方法是对某一个<code>错误状态码</code>进行处理</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.base.execption;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.xuecheng.base.execption.CommonError.UNKOWN_ERROR;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.springframework.http.HttpStatus.INTERNAL_SERVER_ERROR;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 全局异常处理器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/13 19:55</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@ControllerAdvice</span> <span class="hljs-comment">// 增强类, 基于AOP捕获异常</span><br><span class="hljs-comment">//@RestControllerAdvice = @ControllerAdvice + @ResponseBody</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> &#123;<br><br>    <span class="hljs-comment">// 对项目自定义异常进行处理 &#x27;internal_server_error&#x27; -&gt; &#x27;自定义异常语句&#x27;</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@ExceptionHandler(XueChengPlusException.class)</span><br>    <span class="hljs-meta">@ResponseStatus(INTERNAL_SERVER_ERROR)</span><br>    <span class="hljs-keyword">public</span> RestErrorResponse <span class="hljs-title function_">customException</span><span class="hljs-params">(XueChengPlusException e)</span>&#123;<br>        <span class="hljs-comment">// 记录异常</span><br>        log.error(<span class="hljs-string">&quot;系统异常: &#123;&#125;&quot;</span>, e.getErrMessage(), e);<br>        <span class="hljs-comment">// 解析出异常信息</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestErrorResponse</span>(e.getErrMessage());<br>    &#125;<br><br>    <span class="hljs-comment">// 不是项目自定义异常 &#x27;internal_server_error&#x27; -&gt; &#x27;执行过程异常，请重试。&#x27;</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span><br>    <span class="hljs-meta">@ResponseStatus(INTERNAL_SERVER_ERROR)</span><br>    <span class="hljs-keyword">public</span> RestErrorResponse <span class="hljs-title function_">exception</span><span class="hljs-params">(Exception e)</span> &#123;<br>        log.error(<span class="hljs-string">&quot;系统异常: &#123;&#125;&quot;</span>,e.getMessage(),e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestErrorResponse</span>(UNKOWN_ERROR.getErrMessage()); <span class="hljs-comment">// 默认异常</span><br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>修改service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">createCourseBase</span><span class="hljs-params">(Long companyId, AddCourseDto dto)</span> &#123;<br>    <span class="hljs-comment">// 合法性校验</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getName())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(<span class="hljs-string">&quot;课程名称为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getMt())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(<span class="hljs-string">&quot;课程分类为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getSt())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(<span class="hljs-string">&quot;课程名称为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getGrade())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(<span class="hljs-string">&quot;课程等级为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getTeachmode())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(<span class="hljs-string">&quot;教育模式为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getUsers())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(<span class="hljs-string">&quot;适应人群为空&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(dto.getCharge())) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(<span class="hljs-string">&quot;收费规则为空&quot;</span>);<br><br>    <span class="hljs-comment">// 新增对象</span><br>    <span class="hljs-type">CourseBase</span> <span class="hljs-variable">courseBaseNew</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseBase</span>();<br>    <span class="hljs-comment">// 将课程信息赋值给新增对象</span><br>    BeanUtils.copyProperties(dto, courseBaseNew);<br>    <span class="hljs-comment">// 设置审核状态</span><br>    courseBaseNew.setAuditStatus(<span class="hljs-string">&quot;202002&quot;</span>);<br>    <span class="hljs-comment">// 设置发布状态</span><br>    courseBaseNew.setStatus(<span class="hljs-string">&quot;203001&quot;</span>);<br>    <span class="hljs-comment">// 机构id</span><br>    courseBaseNew.setCompanyId(companyId);<br>    <span class="hljs-comment">// 添加时间</span><br>    courseBaseNew.setCreateDate(LocalDateTime.now());<br>    <span class="hljs-comment">// 插入课程基本信息表</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> courseBaseMapper.insert(courseBaseNew);<br>    <span class="hljs-keyword">if</span> (insert &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(<span class="hljs-string">&quot;新增课程基本信息失败&quot;</span>);<br><br>    <span class="hljs-comment">// 向课程营销表保存课程营销信息</span><br>    <span class="hljs-type">CourseMarket</span> <span class="hljs-variable">courseMarketNew</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseMarket</span>();<br>    BeanUtils.copyProperties(dto, courseMarketNew);<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">courseId</span> <span class="hljs-operator">=</span> courseBaseNew.getId();<br>    courseMarketNew.setId(courseId);<br>    <span class="hljs-comment">// 向课程营销表插入数据或更新数据</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> saveCourseMarket(courseMarketNew);<br>    <span class="hljs-keyword">if</span> (i&lt;=<span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XueChengPlusException</span>(<span class="hljs-string">&quot;保存课程营销信息失败&quot;</span>);<br><br>    <span class="hljs-comment">// 查询课程基本信息及营销信息并返回</span><br>    <span class="hljs-keyword">return</span> getCourseBaseInfo(courseId);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>测试</strong></p><p>故意将必填项课程名称设置为空</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213203014473.png" alt="image-20231213203014473"></p><p>联调: 收费且费用填0</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213203142283.png" alt="image-20231213203142283"></p><h4 id="JSR303-校验"><a href="#JSR303-校验" class="headerlink" title="JSR303 校验"></a>JSR303 校验</h4><blockquote><p>前端请求后端接口传输参数, controller和 service 都要<code>校验</code></p><p>controller 中校验请求参数的合法性, 包括必填项校验, 数据格式校验(是否符合日期格式等)</p><p>service  校验业务规则相关的内容, 比如: 课程已经审核通过所以提交失败</p><p>Service中根据业务规则去校验不方便写成通用代码，Controller中则可以将校验的代码写成通用代码</p></blockquote><p>直接使用提供的注解校验即可</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213203712220.png" alt="image-20231213203712220"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213203753785.png" alt="image-20231213203753785"></p><p>改造新增课程业务, 在dto类添加注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.model.dto;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.execption.ValidationGroups;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> javax.validation.constraints.NotEmpty;<br><span class="hljs-keyword">import</span> javax.validation.constraints.Size;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 添加课程dto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/7 17:40</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(value = &quot;AddCourseDto&quot;, description = &quot;新增课程基本信息&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddCourseDto</span> &#123;<br><br>    <span class="hljs-meta">@NotEmpty(groups = &#123;ValidationGroups.Insert.class&#125;,message = &quot;添加课程名称不能为空&quot;)</span><br>    <span class="hljs-meta">@NotEmpty(groups = &#123;ValidationGroups.Update.class&#125;,message = &quot;修改课程名称不能为空&quot;)</span><br><span class="hljs-comment">//    @NotEmpty(message = &quot;课程名称不能为空&quot;)</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;课程名称&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">// 校验报错, 抛出异常 MethodArgumentNotValidException</span><br>    <span class="hljs-comment">// @NotEmpty 表示属性不能为空</span><br>    <span class="hljs-meta">@NotEmpty(message = &quot;适用人群不能为空&quot;)</span><br>    <span class="hljs-comment">// @Size表示限制属性内容的长短</span><br>    <span class="hljs-meta">@Size(message = &quot;适用人群内容过少&quot;, min = 10)</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;适用人群&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String users;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;课程标签&quot;)</span><br>    <span class="hljs-keyword">private</span> String tags;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;课程分类不能为空&quot;)</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;大分类&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String mt;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;课程分类不能为空&quot;)</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;小分类&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String st;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;课程等级不能为空&quot;)</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;课程等级&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String grade;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;教学模式（普通，录播，直播等）&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String teachmode;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;课程介绍&quot;)</span><br>    <span class="hljs-keyword">private</span> String description;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;课程图片&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String pic;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;收费规则不能为空&quot;)</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;收费规则，对应数据字典&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String charge;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;价格&quot;)</span><br>    <span class="hljs-keyword">private</span> Float price;<br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;原价&quot;)</span><br>    <span class="hljs-keyword">private</span> Float originalPrice;<br><br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;qq&quot;)</span><br>    <span class="hljs-keyword">private</span> String qq;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;微信&quot;)</span><br>    <span class="hljs-keyword">private</span> String wechat;<br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;电话&quot;)</span><br>    <span class="hljs-keyword">private</span> String phone;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;有效期&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer validDays;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>有时候在同一个属性上设置一个校验规则不能满足要求，比如：订单编号由系统生成，在添加订单时要求订单编号为空，在更新 订单时要求订单编写不能为空。此时就用到了分组校验，同一个属性定义多个校验规则属于不同的分组，比如：添加订单定义@NULL规则属于insert分组，更新订单定义@NotEmpty规则属于update分组，insert和update是分组的名称，是可以修改的</p></blockquote><p><strong>定义校验组合类</strong></p><blockquote><p>分组后注意 如果规定了某一组, <code>其他组</code>&amp;&amp;<code>没有加入任何组</code>的校验注解不会生效</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.base.execption;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 校验分组</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/13 20:48</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationGroups</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Insert</span>&#123;&#125;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Update</span>&#123;&#125;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Delete</span>&#123;&#125;;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>controller开启校验</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/course&quot;)</span> <span class="hljs-comment">// @Validated 开启校验</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">createCourseBase</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Validated(&#123;ValidationGroups.Insert.class&#125;)</span> AddCourseDto addCourseDto)</span>&#123;<br>    <span class="hljs-comment">// 机构id, 由于认证系统没有上限暂时硬编码</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br>    <span class="hljs-keyword">return</span> courseBaseInfoService.createCourseBase(companyId, addCourseDto);<br>&#125;<br></code></pre></td></tr></table></figure><p>校验失败, 则抛出异常 MethodArgumentNotValidException, 在全局异常捕获他</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 校验异常 MethodArgumentNotValidException, 把报错信息放入集合收集为字符串返回</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span><br><span class="hljs-meta">@ResponseStatus(INTERNAL_SERVER_ERROR)</span><br><span class="hljs-keyword">public</span> RestErrorResponse <span class="hljs-title function_">exception</span><span class="hljs-params">(MethodArgumentNotValidException e)</span> &#123;<br>    <span class="hljs-type">BindingResult</span> <span class="hljs-variable">bindingResult</span> <span class="hljs-operator">=</span> e.getBindingResult();<br>    <span class="hljs-comment">// 将错误信息放在 msgList</span><br>    List&lt;String&gt; msgList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    bindingResult.getFieldErrors().forEach(item-&gt;msgList.add(item.getDefaultMessage()));<br>    <span class="hljs-comment">// 拼接错误信息为字符串</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> StringUtils.join(msgList, <span class="hljs-string">&quot;,&quot;</span>);<br>    log.error(<span class="hljs-string">&quot;系统异常: &#123;&#125;&quot;</span>, msg);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestErrorResponse</span>(msg);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>测试</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213210424490.png" alt="image-20231213210424490"></p><p>如果@注解 校验无法满足要求, 其他方案</p><ol><li>手写校验代码</li><li>自定义校验规则注解</li></ol><blockquote><p>面试: </p><ol><li>系统如何处理异常?</li></ol><p>自定义一个统一的异常处理器捕获并处理异常</p><p>使用控制器增强注解@ControllerAdvice和异常处理注解@ExceptinoHandler来实现</p><p>​a. 处理自定义异常:    根据校验结果主动抛出自定义异常类对象, 抛出异常指定详细的异常信息,  异常处理器捕获异常信息记录异常日志并响应给用户</p><p>​b. 处理未知异常: 接口执行过程中一些<code>运行时异常</code>也会由异常处理器统一捕获, 记录异常日志, 统一响应用户500错误,  在异常处理器可以针对<code>某个异常类型</code>进行单独处理</p><ol start="2"><li>请求参数的合法性校验如何做?</li></ol><p>使用基于JSR303校验框架实现, SpringBoot提供JSR303的支持, 是spring-boot-starter-validation 包括很多校验规则, 只需要在<code>模型类</code>通过<code>注解</code>指定校验<code>规则</code>, 在<code>controller</code>方法开启校验</p></blockquote><h3 id="修改课程"><a href="#修改课程" class="headerlink" title="修改课程"></a>修改课程</h3><h4 id="需求分析-3"><a href="#需求分析-3" class="headerlink" title="需求分析"></a>需求分析</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213214404537.png" alt="image-20231213214404537"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213214452277.png" alt="image-20231213214452277"></p><p>进入编辑界面显示当前课程的信息, 修改成功自动进入<code>课程计划编辑页面</code></p><h4 id="数据模型-1"><a href="#数据模型-1" class="headerlink" title="数据模型"></a>数据模型</h4><p>包括2张表, 课程基本信息表, 课程营销信息表</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213214637577.png" alt="image-20231213214637577"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213214645689.png" alt="image-20231213214645689"></p><ol><li>课程编辑界面, 显示课程信息, 根据课程id查询课程基本和课程营销信息, 显示在表单上</li><li>编辑, 提交, 修改课程提交的数据比新增课程多了一项<code>课程id</code>, 因为修改课程需要<code>针对某个课程进行修改</code></li><li>保存数据, 编辑完成保存<code>课程基础信息</code>和<code>课程营销信息</code>, 更新课程基本信息表的<code>修改人, 修改时间</code></li></ol><h4 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h4><p>controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;修改课程基础信息&quot;)</span><br><span class="hljs-meta">@PutMapping(&quot;/course&quot;)</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">modifyCourseBase</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Validated</span> EditCourseDto editCourseDto)</span>&#123;<br>    <span class="hljs-comment">// 机构id, 由于认证系统没有上线暂时硬编码</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br>    <span class="hljs-keyword">return</span> courseBaseInfoService.updateCourseBase(companyId, editCourseDto);<br>&#125;<br></code></pre></td></tr></table></figure><p>service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改课程基础信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> editCourseDto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">updateCourseBase</span><span class="hljs-params">(Long companyId, EditCourseDto editCourseDto)</span> &#123;<br>    <span class="hljs-comment">// 课程id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">courseId</span> <span class="hljs-operator">=</span> editCourseDto.getId();<br>    <span class="hljs-type">CourseBase</span> <span class="hljs-variable">courseBaseDB</span> <span class="hljs-operator">=</span> courseBaseMapper.selectById(courseId);<br>    <span class="hljs-keyword">if</span> (courseBaseDB == <span class="hljs-literal">null</span>)<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;课程不存在&quot;</span>);<br><br>    <span class="hljs-comment">// 校验本机构只能修改本机构的课程</span><br>    <span class="hljs-keyword">if</span> (!courseBaseDB.getCompanyId().equals(companyId))<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;本机构只能修改本机构的课程&quot;</span>);<br><br>    <span class="hljs-comment">// 需要修改两个表 --&gt; 课程表 和 营销表</span><br><br>    <span class="hljs-comment">// 修改课程表</span><br>    BeanUtils.copyProperties(editCourseDto, courseBaseDB);<br>    courseBaseDB.setChangeDate(LocalDateTime.now());<br>    courseBaseMapper.updateById(courseBaseDB);<br><br>    <span class="hljs-comment">// 修改营销表</span><br>    <span class="hljs-type">CourseMarket</span> <span class="hljs-variable">courseMarket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseMarket</span>();<br>    BeanUtils.copyProperties(editCourseDto, courseMarket);<br>    <span class="hljs-built_in">this</span>.saveCourseMarket(courseMarket);<br><br>    <span class="hljs-comment">// 查询课程信息</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getCourseBaseInfo(courseId);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">### 修改课程信息</span><br>PUT &#123;&#123;content_host&#125;&#125;/content/course<br>Content-Type: application/json<br><br>&#123;<br>  <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;132&quot;</span>,<br>  <span class="hljs-string">&quot;mt&quot;</span>: <span class="hljs-string">&quot;1-1&quot;</span>,<br>  <span class="hljs-string">&quot;st&quot;</span>: <span class="hljs-string">&quot;1-1-1&quot;</span>,<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;java&quot;</span>,<br>  <span class="hljs-string">&quot;pic&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;teachmode&quot;</span>: <span class="hljs-string">&quot;200002&quot;</span>,<br>  <span class="hljs-string">&quot;users&quot;</span>: <span class="hljs-string">&quot;初级人员12331564869&quot;</span>,<br>  <span class="hljs-string">&quot;tags&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;grade&quot;</span>: <span class="hljs-string">&quot;204001&quot;</span>,<br>  <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;charge&quot;</span>: <span class="hljs-string">&quot;201000&quot;</span>,<br>  <span class="hljs-string">&quot;price&quot;</span>: 0,<br>  <span class="hljs-string">&quot;originalPrice&quot;</span>:0,<br>  <span class="hljs-string">&quot;qq&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;wechat&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;phone&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;validDays&quot;</span>: 365<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231213232628012.png" alt="image-20231213232628012"></p><h3 id="查询课程计划"><a href="#查询课程计划" class="headerlink" title="查询课程计划"></a>查询课程计划</h3><h4 id="需求分析-4"><a href="#需求分析-4" class="headerlink" title="需求分析"></a>需求分析</h4><p>课程基本信息添加或修改成功后将自动进入课程计划编辑器</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214105555310.png" alt="image-20231214105555310"></p><p>课程计划即课程大纲目录，课程计划分为两级： <code>大章节</code>和<code>小章节</code></p><h4 id="数据模型-2"><a href="#数据模型-2" class="headerlink" title="数据模型"></a>数据模型</h4><p>课程计划表 teachplan </p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214105757191.png" alt="image-20231214105757191"></p><p>每个课程计划有所属的课程有两个级别, 第一级为大章节, grade为1, 第二级为小章节, grade为2</p><p>第二级的pid是第一级的id, 第一级的pid是0</p><p>课程计划列表还有课程计划关联的视频信息  , teachplan_midia表</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214110323538.png" alt="image-20231214110323538"></p><p>两张表是一对一关系, 每一个课程只能在 teachplan_midia表存在一个视频</p><h4 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs json">Java<br>GET /teachplan/<span class="hljs-number">22</span>/tree-nodes<br><br> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;changeDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;courseId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">74</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;cousePubId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;createDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;endTime&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;grade&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;isPreview&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;mediaType&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">112</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;pname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;第1章基础知识&quot;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;startTime&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;status&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">113</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;teachPlanTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>               <span class="hljs-attr">&quot;changeDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;courseId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">74</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;cousePubId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;createDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;endTime&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;grade&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;isPreview&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;mediaType&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;001002&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">113</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;pname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;第1节项目概述&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;startTime&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;status&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">115</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;teachPlanTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;teachplanMedia&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;courseId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">74</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;coursePubId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;mediaFilename&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.avi&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;mediaId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">41</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;teachplanId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">115</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><br>               <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>         <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;teachplanMedia&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;changeDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;courseId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">74</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;cousePubId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;createDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;endTime&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;grade&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;isPreview&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;mediaType&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">112</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;pname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;第2章快速入门&quot;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;startTime&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;status&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">242</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;teachPlanTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>               <span class="hljs-attr">&quot;changeDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;courseId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">74</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;cousePubId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;createDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;endTime&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;grade&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;isPreview&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;mediaType&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;001002&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">242</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;pname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;第1节搭建环境&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;startTime&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;status&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">244</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;teachPlanTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;teachplanMedia&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;courseId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">74</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;coursePubId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;mediaFilename&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3.avi&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;mediaId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">42</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;teachplanId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">244</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><br>               <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>               <span class="hljs-attr">&quot;changeDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;courseId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">74</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;cousePubId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;createDate&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;endTime&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;grade&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;isPreview&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;mediaType&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;001002&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;orderby&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;parentid&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">242</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;pname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;第2节项目概述&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;startTime&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;status&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">245</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;teachPlanTreeNodes&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;teachplanMedia&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;courseId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">74</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;coursePubId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;mediaFilename&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1a.avi&quot;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;mediaId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">39</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;teachplanId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">245</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-attr">&quot;id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><br>               <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>         <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;teachplanMedia&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><br>      <span class="hljs-punctuation">&#125;</span><br>   <span class="hljs-punctuation">]</span><br><br></code></pre></td></tr></table></figure><blockquote><p><strong>树形结构解决的两种思路:</strong> </p><ol><li>在java逻辑中解决(之前新增分类)</li><li>在mapper逻辑中解决(这个接口)</li></ol></blockquote><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.TeachplanDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.TeachplanService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiImplicitParam;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * TeachplanController</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/14 11:13</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = &quot;课程计划编辑接口&quot;,tags = &quot;课程计划编辑接口&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TeachplanController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    TeachplanService teachplanService;<br><br><br>    <span class="hljs-meta">@ApiOperation(&quot;查询课程计划树形结构&quot;)</span><br>    <span class="hljs-meta">@ApiImplicitParam()</span><br>    <span class="hljs-meta">@GetMapping(&quot;/teachplan/&#123;courseId&#125;/tree-nodes&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;TeachplanDto&gt; <span class="hljs-title function_">getTreeNodes</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long courseId)</span>&#123;<br>        <span class="hljs-keyword">return</span> teachplanService.findTeachplanTree(courseId);<br>    &#125;<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.service.impl;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.mapper.TeachplanMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.TeachplanDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.service.TeachplanService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/14 11:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TeachplanServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TeachplanService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    TeachplanMapper teachplanMapper;<br><br>    <span class="hljs-comment">// 查询课程计划树形结构</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;TeachplanDto&gt; <span class="hljs-title function_">findTeachplanTree</span><span class="hljs-params">(Long courseId)</span> &#123;<br>        <span class="hljs-keyword">return</span> teachplanMapper.selectTreeNodes(courseId);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.content.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.dto.TeachplanDto;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.Teachplan;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 课程计划 Mapper 接口</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itcast</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TeachplanMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Teachplan&gt; &#123;<br><br>    <span class="hljs-comment">// 查询课程计划树形结构</span><br>    List&lt;TeachplanDto&gt; <span class="hljs-title function_">selectTreeNodes</span><span class="hljs-params">(Long courseId)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>重点是xml文件, 利用resultMap对查询结果进行组装, 之前是利用stream流在service中进行组装, 思想是一样的</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.xuecheng.content.mapper.TeachplanMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 通用查询映射结果 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;BaseResultMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;com.xuecheng.content.model.po.Teachplan&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;pname&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;pname&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;parentid&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;parentid&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;grade&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;grade&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;media_type&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;mediaType&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;start_time&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;startTime&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;end_time&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;endTime&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;description&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;description&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;timelength&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;timelength&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;orderby&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;orderby&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;course_id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;courseId&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;course_pub_id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;coursePubId&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;status&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;status&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;is_preview&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;isPreview&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;create_date&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;createDate&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;change_date&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;changeDate&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 通用查询结果列 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Base_Column_List&quot;</span>&gt;</span><br>        id, pname, parentid, grade, media_type, start_time, end_time, description, timelength, orderby, course_id, course_pub_id, status, is_preview, create_date, change_date<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 课程分类树型结构查询映射结果 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;treeNodeResultMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;com.xuecheng.content.model.dto.TeachplanDto&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 一级数据映射 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;one_id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;one_pname&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;pname&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;one_parentid&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;parentid&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;media_type&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;mediaType&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;start_time&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;startTime&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;end_time&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;endTime&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;one_orderby&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;orderby&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;one_courseId&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;courseId&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;one_coursePubId&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;coursePubId&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!-- 一级中包含多个二级数据 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;teachPlanTreeNodes&quot;</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">&quot;com.xuecheng.content.model.dto.TeachplanDto&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 二级数据映射 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>     <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_id&quot;</span>        <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_pname&quot;</span>      <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;pname&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_parentid&quot;</span>     <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;parentid&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_grade&quot;</span>  <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;grade&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_mediaType&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;mediaType&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_stratTime&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;startTime&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_endTime&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;endTime&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_orderby&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;orderby&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_courseId&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;courseId&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_coursePubId&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;coursePubId&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">association</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;teachplanMedia&quot;</span> <span class="hljs-attr">javaType</span>=<span class="hljs-string">&quot;com.xuecheng.content.model.po.TeachplanMedia&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;teachplanMeidaId&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span> /&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;mediaFilename&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;mediaFilename&quot;</span> /&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;mediaId&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;mediaId&quot;</span> /&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_id&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;teachplanId&quot;</span> /&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_courseId&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;courseId&quot;</span> /&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;two_coursePubId&quot;</span>   <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;coursePubId&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">association</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectTreeNodes&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;treeNodeResultMap&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.lang.Long&quot;</span>&gt;</span><br>        SELECT one.id            one_id,<br>               one.pname         one_pname,<br>               one.parentid      one_parentid,<br>               one.grade         one_grade,<br>               one.media_type    one_mediaType,<br>               one.start_time    one_stratTime,<br>               one.end_time      one_endTime,<br>               one.orderby       one_orderby,<br>               one.course_id     one_courseId,<br>               one.course_pub_id one_coursePubId,<br>               two.id            two_id,<br>               two.pname         two_pname,<br>               two.parentid      two_parentid,<br>               two.grade         two_grade,<br>               two.media_type    two_mediaType,<br>               two.start_time    two_startTime,<br>               two.end_time      two_endTime,<br>               two.orderby       two_orderby,<br>               two.course_id     two_courseId,<br>               two.course_pub_id two_coursePubId,<br>               m1.media_fileName mediaFilename,<br>               m1.id             teachplanMeidaId,<br>               m1.media_id       mediaId<br><br>        FROM `teachplan` one<br>                 INNER JOIN teachplan two ON two.parentid = one.id<br>                 LEFT JOIN teachplan_media m1 on two.id = m1.teachplan_id<br>        WHERE one.parentid = 0<br>          and one.course_id = #&#123;courseId&#125;<br>        order by one.orderby, two.orderby<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a><strong>测试</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">### 查询课程计划树形结构<br>GET &#123;&#123;content_host&#125;&#125;/content/teachplan/<span class="hljs-number">117</span>/tree-nodes<br><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214121739423.png" alt="image-20231214121739423"></p><h3 id="新增-修改计划"><a href="#新增-修改计划" class="headerlink" title="新增&#x2F;修改计划"></a>新增&#x2F;修改计划</h3><h4 id="需求分析-5"><a href="#需求分析-5" class="headerlink" title="需求分析"></a>需求分析</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214145130166.png" alt="image-20231214145130166"></p><p>添加章 添加小节 新增成功自动刷新课程计划列表, 新增的课程自动排序到最后, 点击章 节 名称, 修改名称 选择是否免费</p><h4 id="数据模型-3"><a href="#数据模型-3" class="headerlink" title="数据模型"></a>数据模型</h4><p>1、新增第一级课程计划</p><p>名称默认为：新章名称 [点击修改]</p><p>grade：1</p><p>orderby: 所属课程中同级别下排在最后</p><p>2、新增第二级课程计划</p><p>名称默认为：新小节名称 [点击修改]</p><p>grade：2</p><p>orderby: 所属课程计划中排在最后</p><p>3、修改第一级、第二级课程计划的名称，修改第二级课程计划是否免费</p><h4 id="接口定义-3"><a href="#接口定义-3" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json">### 新增课程计划--章<span class="hljs-punctuation">,</span>当grade为<span class="hljs-number">1</span>时parentid为<span class="hljs-number">0</span><br>POST /teachplan<br>Content-Type<span class="hljs-punctuation">:</span> application/json<br><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;courseId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">74</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;parentid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;grade&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;pname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;新章名称 [点击修改]&quot;</span><br><span class="hljs-punctuation">&#125;</span><br>### 新增课程计划--节<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>content_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/content/teachplan<br>Content-Type<span class="hljs-punctuation">:</span> application/json<br><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;courseId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">74</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;parentid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">247</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;grade&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;pname&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;小节名称 [点击修改]&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>同一个接口接收新增和修改两个业务, 以是否传递<code>课程计划id</code>判断是新增还是修改</p><p>如果传递了课程计划id, 说明要<code>修改</code>课程计划, 否则是<code>新增</code>课程计划</p><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;课程计划创建或修改&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/teachplan&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveTeachplan</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SaveTeachplanDto teachplanDto)</span>&#123;<br>    teachplanService.saveTeachplan(teachplanDto);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 课程计划创建或修改</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveTeachplan</span><span class="hljs-params">(SaveTeachplanDto teachplanDto)</span> &#123;<br>    <span class="hljs-comment">// 课程计划id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> teachplanDto.getId();<br>    <span class="hljs-comment">// 修改课程计划</span><br>    <span class="hljs-keyword">if</span> (id!=<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplan</span> <span class="hljs-operator">=</span> teachplanMapper.selectById(id);<br>        BeanUtils.copyProperties(teachplanDto, teachplan);<br>        teachplanMapper.updateById(teachplan);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 取出同父同级别的课程计划数量</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> getTeachplanCount(teachplanDto.getCourseId(), teachplanDto.getParentid());<br>        <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplanNew</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Teachplan</span>();<br>        BeanUtils.copyProperties(teachplanDto, teachplanNew);<br>        teachplanNew.setOrderby(count+<span class="hljs-number">1</span>);<br>        teachplanMapper.insert(teachplanNew);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 获取最新的排序号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId  课程id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> parentId  父课程计划id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> int 最新排序号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/9 13:43</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getTeachplanCount</span><span class="hljs-params">(Long courseId, Long parentId)</span> &#123;<br>    LambdaQueryWrapper&lt;Teachplan&gt; lqw = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>    lqw.eq(Teachplan::getCourseId, courseId);<br>    lqw.eq(Teachplan::getParentid, parentId);<br>    <span class="hljs-keyword">return</span> teachplanMapper.selectCount(lqw);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>测试</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214164531094.png" alt="image-20231214164531094"></p><blockquote><p>Bug 修改 : 前端页面添加的大章节无法显示</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214171959494.png" alt="image-20231214171959494"></p><p>TeachplanMapper.xml</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214171916310.png" alt="image-20231214171916310"></p></blockquote><h3 id="实战环境"><a href="#实战环境" class="headerlink" title="实战环境"></a>实战环境</h3><p>流程:</p><ol><li>组长将实战的初始代码提交到git仓库</li><li>组员从此仓库clone项目</li><li>组内讨论实战功能需求和接口</li><li>根据组的情况分工, 每人至少写一个接口并测试通过, 提交到仓库</li></ol><blockquote><p>注意:  每人开发接口创建自己的service controller 接口和类, 不要出现多人共用一个文件的情况</p></blockquote><ol start="5"><li>功能开发完毕组成员拉下所有代码, 交叉测试, 测出来的bug记录在word文档给组长汇总</li><li>根据bug记录进行修复自己接口的bug, 修复完成并测试没问题提交git</li></ol><h3 id="删除课程计划"><a href="#删除课程计划" class="headerlink" title="删除课程计划"></a>删除课程计划</h3><h4 id="需求分析-6"><a href="#需求分析-6" class="headerlink" title="需求分析"></a>需求分析</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214172750117.png" alt="image-20231214172750117"></p><p>删除一级大章节要求大章节下面<code>没有小章节</code>方可删除</p><p>删除二级小章节同时需要将<code>teachplan_media</code>表关联的信息(视频)删除</p><h4 id="接口定义-4"><a href="#接口定义-4" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">Java<br>Request URL<span class="hljs-punctuation">:</span> /content/teachplan/<span class="hljs-number">246</span><br>Request Method<span class="hljs-punctuation">:</span> DELETE<br><br>如果失败返回：<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;errCode&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;120409&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;errMessage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;课程计划信息还有子级信息，无法操作&quot;</span><span class="hljs-punctuation">&#125;</span><br><br>如果成功：状态码<span class="hljs-number">200</span>，不返回信息<br><br></code></pre></td></tr></table></figure><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;删除课程计划信息&quot;)</span><br><span class="hljs-meta">@DeleteMapping(&quot;/teachplan/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeTeachplan</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br>    teachplanService.deleteTeachplan(id);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 删除课程计划信息</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteTeachplan</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 0.首先看他是大是小</span><br>    <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplan</span> <span class="hljs-operator">=</span> teachplanMapper.selectById(id);<br>    <span class="hljs-keyword">if</span>(teachplan.getGrade()==<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-comment">// 1.删除大章节, 如果大章节下面有小章节, 则不能删除</span><br>        <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplanSmall</span> <span class="hljs-operator">=</span> teachplanMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;Teachplan&gt;().eq(Teachplan::getParentid, id));<br>        <span class="hljs-keyword">if</span> (teachplanSmall != <span class="hljs-literal">null</span>) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;关联了小的章节, 不能删除&quot;</span>);<br>        &#125;<br>        teachplanMapper.deleteById(teachplan);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 2.删除小章节, ok</span><br>        teachplanMapper.deleteById(teachplan);<br>        <span class="hljs-comment">// 3.删除对应的 teachplan_media 表</span><br>        teachplanMediaMapper.delete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;TeachplanMedia&gt;().eq(TeachplanMedia::getTeachplanId, id));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>测试</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214175223100.png" alt="image-20231214175223100"></p><h3 id="课程计划排序"><a href="#课程计划排序" class="headerlink" title="课程计划排序"></a>课程计划排序</h3><h4 id="需求分析-7"><a href="#需求分析-7" class="headerlink" title="需求分析"></a>需求分析</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@ApiOperation</span>(<span class="hljs-string">&quot;课程计划排序&quot;</span>)<br><span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">&quot;/teachplan/&#123;moveType&#125;/&#123;id&#125;&quot;</span>)<br>public void <span class="hljs-built_in">moveCourse</span>(<span class="hljs-variable">@PathVariable</span> Long id, <span class="hljs-variable">@PathVariable</span> String moveType)&#123;<br>    <span class="hljs-selector-tag">teachplanService</span><span class="hljs-selector-class">.moveCourse</span>(id, moveType);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214175317252.png" alt="image-20231214175317252"></p><p>上移表示将课程计划向上移动。</p><p>下移表示将课程计划向下移动。</p><p>向上移动后和上边同级的课程计划交换位置，可以将两个课程计划的<code>排序字段值进行交换</code>。</p><p>向下移动后和下边同级的课程计划交换位置，可以将两个课程计划的排序字段值进行交换。</p><h4 id="接口定义-5"><a href="#接口定义-5" class="headerlink" title="接口定义"></a>接口定义</h4><p>向下移动</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">Request URL<span class="hljs-punctuation">:</span> http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:8601/api/content/teachplan/movedown/43</span><br>Request Method<span class="hljs-punctuation">:</span> POST<br><br></code></pre></td></tr></table></figure><p>向上移动</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">Java<br>Request URL<span class="hljs-punctuation">:</span> http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:8601/api/content/teachplan/moveup/43</span><br>Request Method<span class="hljs-punctuation">:</span> POST<br><br></code></pre></td></tr></table></figure><p>每次移动传递两个参数：</p><p>1、移动类型: movedown和moveup</p><p>2、课程计划id</p><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;课程计划排序&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/teachplan/&#123;moveType&#125;/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">moveCourse</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@PathVariable</span> String moveType)</span>&#123;<br>    teachplanService.moveCourse(id, moveType);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 课程计划排序</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">moveCourse</span><span class="hljs-params">(Long id, String moveType)</span> &#123;<br>    <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplan</span> <span class="hljs-operator">=</span> teachplanMapper.selectById(id);<br>    <span class="hljs-comment">// 获取和层级和orderby, 章节和小节移动不同</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">grade</span> <span class="hljs-operator">=</span> teachplan.getGrade();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">orderby</span> <span class="hljs-operator">=</span> teachplan.getOrderby();<br>    <span class="hljs-comment">// 章节移动是比较同一课程id下的orderby</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">courseId</span> <span class="hljs-operator">=</span> teachplan.getCourseId();<br>    <span class="hljs-comment">// 小节移动是比较同一章节id下的orderby</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">parentid</span> <span class="hljs-operator">=</span> teachplan.getParentid();<br><br>    <span class="hljs-comment">// 上移</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;moveup&quot;</span>.equals(moveType)) &#123;<br>        <span class="hljs-comment">// 章节移动</span><br>        <span class="hljs-keyword">if</span> (grade == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-comment">// select * from teachplan where grade = 1 and course_id = 26 and orderby &lt; 4 order by orderby desc limit 1</span><br>            LambdaQueryWrapper&lt;Teachplan&gt; lqw = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>            lqw.eq(Teachplan::getGrade, <span class="hljs-number">1</span>)<br>                    .eq(Teachplan::getCourseId, courseId)<br>                    .lt(Teachplan::getOrderby, orderby)<br>                    .orderByDesc(Teachplan::getOrderby)<br>                    .last(<span class="hljs-string">&quot;LIMIT 1&quot;</span>);<br>            <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplanDB</span> <span class="hljs-operator">=</span> teachplanMapper.selectOne(lqw);<br><br>            changeOrder(teachplanDB, teachplan);<br><br>        &#125;<br>        <span class="hljs-comment">// 小节移动</span><br>        <span class="hljs-keyword">if</span> (grade == <span class="hljs-number">2</span>) &#123;<br>            <span class="hljs-comment">// select * from teachplan where grade = 2 and parent_id = 26 and orderby &lt; 4 order by orderby desc limit 1</span><br>            LambdaQueryWrapper&lt;Teachplan&gt; lqw = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>            lqw.eq(Teachplan::getGrade, <span class="hljs-number">2</span>)<br>                    .eq(Teachplan::getParentid, parentid)<br>                    .lt(Teachplan::getOrderby, orderby)<br>                    .orderByDesc(Teachplan::getOrderby)<br>                    .last(<span class="hljs-string">&quot;LIMIT 1&quot;</span>);<br>            <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplanDB</span> <span class="hljs-operator">=</span> teachplanMapper.selectOne(lqw);<br>            changeOrder(teachplanDB, teachplan);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 下移</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;movedown&quot;</span>.equals(moveType)) &#123;<br>        <span class="hljs-comment">// 章节移动</span><br>        <span class="hljs-keyword">if</span> (grade == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-comment">// select * from teachplan where grade = 1 and course_id = 26 and orderby &gt; 1 order by orderby limit 1</span><br>            LambdaQueryWrapper&lt;Teachplan&gt; lqw = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>            lqw.eq(Teachplan::getGrade, <span class="hljs-number">1</span>)<br>                    .eq(Teachplan::getCourseId, courseId)<br>                    .gt(Teachplan::getOrderby, orderby)<br>                    .orderByAsc(Teachplan::getOrderby)<br>                    .last(<span class="hljs-string">&quot;LIMIT 1&quot;</span>);<br>            <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplanDB</span> <span class="hljs-operator">=</span> teachplanMapper.selectOne(lqw);<br><br>            changeOrder(teachplanDB, teachplan);<br><br>        &#125;<br>        <span class="hljs-comment">// 小节移动</span><br>        <span class="hljs-keyword">if</span> (grade == <span class="hljs-number">2</span>) &#123;<br>            <span class="hljs-comment">// select * from teachplan where grade = 2 and parent_id = 26 and orderby &lt; 4 order by orderby limit 1</span><br>            LambdaQueryWrapper&lt;Teachplan&gt; lqw = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>            lqw.eq(Teachplan::getGrade, <span class="hljs-number">2</span>)<br>                    .eq(Teachplan::getParentid, parentid)<br>                    .gt(Teachplan::getOrderby, orderby)<br>                    .orderByAsc(Teachplan::getOrderby)<br>                    .last(<span class="hljs-string">&quot;LIMIT 1&quot;</span>);<br>            <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplanDB</span> <span class="hljs-operator">=</span> teachplanMapper.selectOne(lqw);<br>            changeOrder(teachplanDB, teachplan);<br>        &#125;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">// 调换位置 orderby</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeOrder</span><span class="hljs-params">(Teachplan teachplanDB, Teachplan teachplan)</span> &#123;<br>    <span class="hljs-keyword">if</span> (teachplanDB == <span class="hljs-literal">null</span>) XueChengPlusException.cast(<span class="hljs-string">&quot;移到头啦, 不能再移动啦&quot;</span>);<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">orderby1</span> <span class="hljs-operator">=</span> teachplan.getOrderby();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">orderby2</span> <span class="hljs-operator">=</span> teachplanDB.getOrderby();<br>    teachplan.setOrderby(orderby2);<br>    teachplanDB.setOrderby(orderby1);<br>    teachplanMapper.updateById(teachplan);<br>    teachplanMapper.updateById(teachplanDB);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="师资管理"><a href="#师资管理" class="headerlink" title="师资管理"></a>师资管理</h3><h4 id="需求分析-8"><a href="#需求分析-8" class="headerlink" title="需求分析"></a>需求分析</h4><p>下一步</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214214329437.png" alt="image-20231214214329437"></p><p>添加</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214214351329.png" alt="image-20231214214351329"></p><p>添加成功</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214214407963.png" alt="image-20231214214407963"></p><p>删除老师, 修改老师</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214214445298.png" alt="image-20231214214445298"></p><blockquote><p>注意:</p><p>只允许向机构自己的课程添加老师, 删除老师</p><p>机构id统一用 1232141425L</p></blockquote><h4 id="接口定义-6"><a href="#接口定义-6" class="headerlink" title="接口定义"></a>接口定义</h4><p>查询老师</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">Java<br>get /courseTeacher/list/<span class="hljs-number">75</span><br><span class="hljs-number">75</span>为课程id，请求参数为课程id<br><br>响应结果<br><span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">23</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;courseId&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">75</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;teacherName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;张老师&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;讲师&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;introduction&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;张老师教师简介张老师教师简介张老师教师简介张老师教师简介&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;photograph&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;createDate&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br><br></code></pre></td></tr></table></figure><p>添加老师</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">Java<br>post  /courseTeacher<br><br>请求参数：<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;courseId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">75</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;teacherName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;王老师&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;教师职位&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;introduction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;教师简介&quot;</span><br><span class="hljs-punctuation">&#125;</span><br>响应结果：<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">24</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;courseId&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">75</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;teacherName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;王老师&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;教师职位&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;introduction&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;教师简介&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;photograph&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;createDate&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>修改老师</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json">Java<br>put /courseTeacher<br>请求参数：<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">24</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;courseId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">75</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;teacherName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;王老师&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;教师职位&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;introduction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;教师简介&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;photograph&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;createDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><br><span class="hljs-punctuation">&#125;</span><br>响应：<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">24</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;courseId&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">75</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;teacherName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;王老师&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;教师职位&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;introduction&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;教师简介&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;photograph&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;createDate&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>删除老师</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">Java<br>delete /ourseTeacher/course/<span class="hljs-number">75</span>/<span class="hljs-number">26</span><br><br><span class="hljs-number">75</span><span class="hljs-punctuation">:</span>课程id<br><span class="hljs-number">26</span><span class="hljs-punctuation">:</span>教师id，即course_teacher表的主键<br>请求参数：课程id、教师id<br><br>响应：状态码<span class="hljs-number">200</span>，不返回信息<br><br></code></pre></td></tr></table></figure><h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231214232831531.png" alt="image-20231214232831531"></p><h3 id="删除课程"><a href="#删除课程" class="headerlink" title="删除课程"></a>删除课程</h3><h4 id="需求分析-9"><a href="#需求分析-9" class="headerlink" title="需求分析"></a>需求分析</h4><p>课程的审核状态为<code>未提交</code>时方可删除。</p><p>删除课程需要<code>删除课程相关的基本信息</code>、<code>营销信息</code>、<code>课程计划</code>、<code>课程教师信息</code></p><h4 id="接口定义-7"><a href="#接口定义-7" class="headerlink" title="接口定义"></a>接口定义</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;删除课程&quot;)</span><br><span class="hljs-meta">@DeleteMapping(&quot;/course/&#123;courseId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteCourse</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long courseId)</span>&#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br>    courseTeacherService.deleteCourse(companyId, courseId);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 删除课程</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteCourse</span><span class="hljs-params">(Long companyId, Long courseId)</span> &#123;<br>    <span class="hljs-type">CourseBase</span> <span class="hljs-variable">courseBase</span> <span class="hljs-operator">=</span> courseBaseMapper.selectById(courseId);<br>    <span class="hljs-comment">// 只能删除本机构的课程</span><br>    <span class="hljs-keyword">if</span> (companyId != courseBase.getCompanyId())<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;只有自己公司的课程允许删除&quot;</span>);<br>    <span class="hljs-comment">// 课程的审核状态为未提交时方可删除</span><br>    <span class="hljs-keyword">if</span>(! (<span class="hljs-string">&quot;202002&quot;</span>.equals(courseBase.getStatus())) )<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;不能删除&quot;</span>);<br>    <span class="hljs-comment">// 删除课程需要删除课程相关的基本信息、营销信息、课程计划、课程教师信息</span><br>    courseBaseMapper.deleteById(courseId);<br>    courseMarketMapper.deleteById(courseId);<br>    teachplanMapper.delete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;Teachplan&gt;().eq(Teachplan::getCourseId, courseId));<br>    courseTeacherMapper.delete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;CourseTeacher&gt;().eq(CourseTeacher::getCourseId, courseId));<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
    <tags>
      
      <tag>学成在线</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学成在线准备</title>
    <link href="/2023/12/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E5%87%86%E5%A4%87/"/>
    <url>/2023/12/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E5%87%86%E5%A4%87/</url>
    
    <content type="html"><![CDATA[<h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><h3 id="业务框架"><a href="#业务框架" class="headerlink" title="业务框架"></a>业务框架</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211165048877.png" alt="image-20231211165048877"></p><p>课程编辑和发布流程</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211165221781.png" alt="image-20231211165221781"></p><p>学生选课流程</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211165313310.png" alt="image-20231211165313310"></p><blockquote><p>B2B2C: 是一种电子商务类型的网络购物商业模式, B (Business) C(Consumer) 第一个B指的是商品或服务的供应商, 第二个B是从事电子商务的企业, C是消费者</p><p>B2B: 企业和企业之间的电子商务运作方式</p><p>B2C: 企业和消费者之间的电子商务运作方式</p></blockquote><p><strong>面试怎么说</strong></p><ol><li><p>项目背景</p></li><li><p>项目业务流程</p></li><li><p>项目功能模块</p></li><li><p>项目技术架构</p></li><li><p>个人工作职责</p></li><li><p>个人负责模块的详细说明, 包括模块的设计, 用到的技术, 技术的实现方案等</p></li></ol><p>一个例子：</p><p>我最近参与的项目是我们公司自研的专门针对成人职业技能教育的网络课堂系统，网站提供了成人职业技能培训的相关课程，如：软件开发培训、职业资格证书培训、成人学历教育培训等课程。项目基于B2B2C的业务模式，培训机构可以在平台入驻、发布课程，我们公司作为运营方由专门的人员对发布的课程进行审核，审核通过后课程才可以发布成功，课程包括免费和收费两种形式，对于免费课程普通用户可以直接选课学习，对于收费课程在选课后需要支付成功才可以继续学习。</p><p>本项目包括用户端、机构端、运营端三个端。</p><p>核心模块包括：内容管理、媒资管理、课程搜索、订单支付、选课管理、认证授权等。</p><p>本项目采用前后端分离架构，后端采用SpringBoot、SpringCloud技术栈开发，数据库使用了MySQL，还使用的Redis、消息队列、分布式文件系统、Elasticsearch等中间件系统。</p><p>划分的微服务包括：内容管理服务、媒资管理服务、搜索服务、订单支付服务、 学习中心服务、系统管理服务、认证授权服务、网关服务、注册中心服务、配置中心服务等。</p><p>我在这个项目中负责了内容管理、媒资管理、订单支付模块的设计与开发。</p><p>内容管理模块，是对平台上的课程进行管理，课程的相关信息比较多这里在数据库设计了课程基本信息表、课程营销表、课程计划、课程师资表进行存储 ，培训机构要发布一门课程需要填写课程基本信息、课程营销信息、课程计划信息、课程师资信息，填写完毕后需要提交审核，由运营人员进行课程信息的审核，整个审核过程是程序自动审核加人工确认的方式，通常24小时审核完成。课程审核通过即可发布课程，课程的相关信息会聚合到课程发布表中，这里不仅要将课程信息写到课程发布表还要将课程信息写到索引库、分布式文件系统中，所以这里存在分布式事务的问题，项目使用本地消息表加任务调度的方式去解决这里的分布式事务，保存数据的最终一致性。</p><h3 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211171902759.png" alt="image-20231211171902759"></p><table><thead><tr><th>名称</th><th>功能描述</th></tr></thead><tbody><tr><td>用户层</td><td>用户层描述了本系统所支持的用户类型包括：pc用户、app用户、h5用户。pc用户通过浏览器访问系统、app用户通过android、ios手机访问系统，H5用户通过h5页面访问系统。</td></tr><tr><td>CDN</td><td>CDN全称Content  Delivery Network，即内容分发网络，本系统所有静态资源全部通过CDN加速来提高访问速度。系统静态资源包括：html页面、js文件、css文件、image图片、pdf和ppt及doc教学文档、video视频等。</td></tr><tr><td>负载均衡</td><td>系统的CDN层、UI层、服务层及数据层均设置了负载均衡服务，上图仅在UI层前边标注了负载均衡。 每一层的负载均衡会根据系统的需求来确定负载均衡器的类型，系统支持4层负载均衡+7层负载均衡结合的方式，4层负载均衡是指在网络传输层进行流程转发，根据IP和端口进行转发，7层负载均衡完成HTTP协议负载均衡及反向代理的功能，根据url进行请求转发。</td></tr><tr><td>UI层</td><td>UI层描述了系统向pc用户、app用户、h5用户提供的产品界面。根据系统功能模块特点确定了UI层包括如下产品界面类型：  1）面向pc用户的门户系统、学习中心系统、教学管理系统、系统管理中心。  2）面向h5用户的门户系统、学习中心系统。  3）面向app用户的门户系统、学习中心系统。</td></tr><tr><td>微服务层</td><td>微服务层将系统服务分类三类：业务服务、基础服务、第三方代理服务。 业务服务：主要为学成在线核心业务提供服务，并与数据层进行交互获得数据。 基础服务：主要管理学成在线系统运行所需的配置、日志、任务调度、短信等系统级别的服务。 第三方代理服务：系统接入第三方服务完成业务的对接，例如认证、支付、视频点播&#x2F;直播、用户认证和授权。</td></tr><tr><td>数据层</td><td>数据层描述了系统的数据存储的内容类型，关系性数据库：持久化的业务数据使用MySQL。 消息队列：存储系统服务间通信的消息，本身提供消息存取服务，与微服务层的系统服务连接。 索引库：存储课程信息的索引信息，本身提供索引维护及搜索的服务，与微服务层的系统服务连接。 缓存：作为系统的缓存服务，作为微服务的缓存数据便于查询。 文件存储：提供系统静态资源文件的分布式存储服务，文件存储服务器作为CDN服务器的数据来源，CDN上的静态资源将最终在文件存储服务器上保存多份。</td></tr></tbody></table><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="Maven环境"><a href="#Maven环境" class="headerlink" title="Maven环境"></a>Maven环境</h3><p>搜索 apache-maven-3.8.6-bin.zip , 解压到英文目录</p><p>解压资料repository.zip到d:&#x2F;</p><p>配置Maven目录&#x2F;conf&#x2F;setting.xml</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211210245116.png" alt="image-20231211210245116"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211210302863.png" alt="image-20231211210302863"></p><p>修改idea的maven仓库路径</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211210415241.png" alt="image-20231211210415241"></p><blockquote><p><strong>面试</strong></p><p>maven的常用命令?</p><p>mvn clean  &#x2F;&#x2F; 清除target目录中的生成结果</p><p>mvn compile &#x2F;&#x2F; 编译源代码</p><p>mvn test &#x2F;&#x2F; 执行单元测试</p><p>mvn package &#x2F;&#x2F; 打包</p><p>mvn install &#x2F;&#x2F; 打包并把打好的包上传到本地仓库</p><p>mvn deploy &#x2F;&#x2F; 打包并把打好的包上传到远程仓库</p></blockquote><h3 id="虚拟机设置"><a href="#虚拟机设置" class="headerlink" title="虚拟机设置"></a>虚拟机设置</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211210514674.png" alt="image-20231211210514674"></p><p>设置子网IP：192.168.101.0，子网掩码：255.255.255.0</p><p>导入老师提供的虚拟机文件</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211210549233.png" alt="image-20231211210549233"></p><p>IP地址：192.168.101.65</p><p>账号与密码为：root&#x2F;centos</p><p>执行 systemctl start docker 启动docker。</p><p>运行： sh &#x2F;data&#x2F;soft&#x2F;restart.sh </p><p>查询docker容器：docker ps</p><p>其中mysql的用户名密码 root&#x2F;mysql</p><h3 id="Gogs"><a href="#Gogs" class="headerlink" title="Gogs"></a>Gogs</h3><p>在虚拟机docker安装Gogs服务, 类似Github</p><p>进入Gogs：<a href="http://192.168.101.65:10880/gogs/xuecheng-plus">http://192.168.101.65:10880</a> </p><p>账号&#x2F;密码：gogs&#x2F;gogs</p><p>创建组织  -&gt; 创建团队 -&gt; 创建仓库</p><p>仓库设置 -&gt; 管理协作者 -&gt; 可写权限</p><h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><p>IDEA从远程拉取代码vsc方式打开</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211211830488.png" alt="image-20231211211830488"></p><p>在根目录添加.gitignore文件<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211211928520.png" alt="image-20231211211928520"></p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">HELP.md<br>target/<br>!<span class="hljs-string">.mvn/wrapper/maven-wrapper.jar</span><br>!**<span class="hljs-string">/src/main/</span>**<br>!**<span class="hljs-string">/src/test/</span>**<br><br><span class="hljs-comment">### STS ###</span><br><span class="hljs-string">.apt_generated</span><br><span class="hljs-string">.classpath</span><br><span class="hljs-string">.factorypath</span><br><span class="hljs-string">.project</span><br><span class="hljs-string">.settings</span><br><span class="hljs-string">.springBeans</span><br><span class="hljs-string">.sts4-cache</span><br><br><span class="hljs-comment">### IntelliJ IDEA ###</span><br><span class="hljs-string">.idea</span><br>*<span class="hljs-string">.iws</span><br>*<span class="hljs-string">.iml</span><br>*<span class="hljs-string">.ipr</span><br><br><span class="hljs-comment">### NetBeans ###</span><br><span class="hljs-string">/nbproject/private/</span><br><span class="hljs-string">/nbbuild/</span><br><span class="hljs-string">/dist/</span><br><span class="hljs-string">/nbdist/</span><br><span class="hljs-string">/.nb-gradle/</span><br>build/<br>logs/<br><br><span class="hljs-comment">### VS Code ###</span><br><span class="hljs-string">.vscode/</span><br><br></code></pre></td></tr></table></figure><p>提交推送, 第一次输入 gogs&#x2F;gogs</p><blockquote><p>推送报错, Push failed  401  (账号&#x2F;密码错误)  403(没有权限,联系经理开写入权限)</p><p>忘记密码,   搜索 -&gt; windows 凭据 -&gt; 找到远程仓库记录,改密</p><p>或IDEA<code>修改密码文件名</code>或<code>不记录密码</code></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211212352433.png" alt="image-20231211212352433"></p><p>创建开发分支, 一般是dev, 我们每天创建一个分支, 这里创建dev01分支</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211212721802.png" alt="image-20231211212721802"></p><p>这里push远程分支也会多出一个dev01</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211212802809.png" alt="image-20231211212802809"></p></blockquote><blockquote><p><strong>面试</strong></p><p>Git 代码冲突怎么处理?</p><p>出现冲突的原因是本地文件和目标分支中文件的版本不一致时当存在同一行的内容不同时在进行合并会出现冲突</p><p>代码冲突一般发生的情况:</p><ul><li>多个分支向主分支合并时</li><li>同一个分支下pull 或push操作时</li></ul><p>发生冲突需要手动合并代码, 选择最终的版本</p><p>可以通过图形界面操作</p><p>也可以  &gt;&gt;&gt;HEAD  &lt;&lt;&lt;&lt;  这样的内容进行手动修改, 然后添加提交推送</p></blockquote><h2 id="工程结构"><a href="#工程结构" class="headerlink" title="工程结构"></a>工程结构</h2><blockquote><p>这里先创建<code>父工程</code>和<code>基础工程</code>, 不创建<code>模块工程</code></p></blockquote><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211201347831.png" alt="image-20231211201347831"></p><p>父工程: 对依赖包进行管理;  本身为Pom工程, 对子工程进行聚合管理.</p><p>基础工程: 继承父类工程; 提供基础类库; 提供工具类库</p><p>微服务工程:  对业务,技术划分模块, 每个模块构建一个微服务; 每个微服务工程依赖基础工程, 间接继承父工程;  </p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211213403979.png" alt="image-20231211213403979"></p><h3 id="pom-xml-parent"><a href="#pom-xml-parent" class="headerlink" title="pom.xml(parent)"></a>pom.xml(parent)</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">org.mapstruct.version</span>&gt;</span>1.3.1.Final<span class="hljs-tag">&lt;/<span class="hljs-name">org.mapstruct.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud-alibaba.version</span>&gt;</span>2.2.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud-alibaba.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">org.projectlombok.version</span>&gt;</span>1.18.8<span class="hljs-tag">&lt;/<span class="hljs-name">org.projectlombok.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javax.servlet-api.version</span>&gt;</span>4.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">javax.servlet-api.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">fastjson.version</span>&gt;</span>1.2.83<span class="hljs-tag">&lt;/<span class="hljs-name">fastjson.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">druid-spring-boot-starter.version</span>&gt;</span>1.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">druid-spring-boot-starter.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mysql-connector-java.version</span>&gt;</span>8.0.30<span class="hljs-tag">&lt;/<span class="hljs-name">mysql-connector-java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mybatis-plus-boot-starter.version</span>&gt;</span>3.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">mybatis-plus-boot-starter.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">commons-lang.version</span>&gt;</span>2.6<span class="hljs-tag">&lt;/<span class="hljs-name">commons-lang.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">minio.version</span>&gt;</span>8.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">minio.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xxl-job-core.version</span>&gt;</span>2.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">xxl-job-core.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">swagger-annotations.version</span>&gt;</span>1.5.20<span class="hljs-tag">&lt;/<span class="hljs-name">swagger-annotations.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">commons-lang3.version</span>&gt;</span>3.10<span class="hljs-tag">&lt;/<span class="hljs-name">commons-lang3.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">okhttp.version</span>&gt;</span>4.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">okhttp.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">swagger-spring-boot-starter.version</span>&gt;</span>1.9.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">swagger-spring-boot-starter.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">elasticsearch.version</span>&gt;</span>7.12.1<span class="hljs-tag">&lt;/<span class="hljs-name">elasticsearch.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- lombok，简化类的构建--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.projectlombok.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- mapstruct 代码生成器，简化java bean之间的映射 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mapstruct<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mapstruct-jdk8<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.mapstruct.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mapstruct<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mapstruct-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.mapstruct.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.swagger<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>swagger-annotations<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;swagger-annotations.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- Servlet 容器管理 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.servlet-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;javax.servlet-api.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- fastjson ，json解析工具 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;fastjson.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- druid 连接池管理 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;druid-spring-boot-starter.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>            <span class="hljs-comment">&lt;!-- mySQL数据库驱动包管理 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mysql-connector-java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- mybatis plus 集成Spring Boot启动器 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mybatis-plus-boot-starter.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>            <span class="hljs-comment">&lt;!-- mybatis plus 代码生成器 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mybatis-plus-boot-starter.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>            <span class="hljs-comment">&lt;!-- 工具类管理 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-lang<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;commons-lang.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 分布式文件系统 minIO的客户端API包 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.minio<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>minio<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;minio.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--google推荐的一套工具类库--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>25.0-jre<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--分布式任务调度--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;xxl-job-core.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--Spring boot单元测试--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;okhttp.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;commons-lang3.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.spring4all<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>swagger-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;swagger-spring-boot-starter.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;elasticsearch.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;elasticsearch.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>$&#123;project.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--编译打包过虑配置--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!--指定项目源码jdk的版本--&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!--指定项目编译后的jdk的版本--&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!--配置注解预编译--&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">annotationProcessorPaths</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">path</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;org.projectlombok.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">path</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">annotationProcessorPaths</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br><br>            <span class="hljs-comment">&lt;!--责处理项目资源文件并拷贝到输出目录，如果有额外的资源文件目录则需要配置--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-resources-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>utf-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!--使用默认分隔符，resource中可以使用分割符定义过虑的路径--&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">useDefaultDelimiters</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">useDefaultDelimiters</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="pom-xml-base"><a href="#pom-xml-base" class="headerlink" title="pom.xml(base)"></a>pom.xml(base)</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--基于当前pom.xml找到父工程--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-base<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- fast Json --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- servlet Api 依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.servlet-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 通用组件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-lang<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-codec<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-codec<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.swagger<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>swagger-annotations<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--根据扩展名取mimetype--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.j256.simplemagic<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>simplemagic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.zxing<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.zxing<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javase<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.module<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-module-parameter-names<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-datatype-jdk8<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
    <tags>
      
      <tag>学成在线</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>跨域</title>
    <link href="/2023/12/12/%E8%B7%A8%E5%9F%9F/"/>
    <url>/2023/12/12/%E8%B7%A8%E5%9F%9F/</url>
    
    <content type="html"><![CDATA[<h2 id="记录的原因是搞清楚跨域"><a href="#记录的原因是搞清楚跨域" class="headerlink" title="记录的原因是搞清楚跨域"></a>记录的原因是搞清楚跨域</h2><p>chrome浏览器报错如下：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Access</span> <span class="hljs-keyword">to</span> XMLHttpRequest at  <span class="hljs-string">&#x27;http://localhost:63110/system/dictionary/all&#x27;</span> <span class="hljs-keyword">from</span> origin  <span class="hljs-string">&#x27;http://localhost:8601&#x27;</span> has been blocked <span class="hljs-keyword">by</span> CORS <span class="hljs-keyword">policy</span>: <span class="hljs-keyword">No</span> <span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>  <span class="hljs-keyword">header</span> <span class="hljs-keyword">is</span> present <span class="hljs-keyword">on</span> the requested resource.  <br></code></pre></td></tr></table></figure><p>firefox浏览器报错如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Bash</span>   已拦截跨源请求：同源策略禁止读取位于 http://localhost:<span class="hljs-number">63110</span>/system/dictionary/<span class="hljs-literal">all</span> 的远程资源。（原因：CORS  头缺少 &#x27;Access-Control-<span class="hljs-literal">Allow</span>-Origin&#x27;）。状态码：<span class="hljs-number">200</span>。  <br></code></pre></td></tr></table></figure><p>从 <a href="http://localhost:8601/">http://localhost:8601</a> 访问 <a href="http://localhost:63110/system/dictionary/all">http://localhost:63110/system/dictionary/all</a> 被CORS policy 阻止,因为没有 Access-Origin-Allow-Origin 响应头信息, CORS全称为 cross origin resource share 表示<code>跨域资源共享</code></p><p>这个提示的原因是浏览器<code>同源策略</code>, 判断是否跨域请求, 同源策略是浏览器一种安全机制, 从一个地址请求另一个地址, </p><p>如果 协议 主机 端口 全部一致则不属于跨域</p><p><a href="http://localhost:8601/">http://localhost:8601</a>  -&gt; <a href="http://localhost:8602/">http://localhost:8602</a>  端口不同, 跨域</p><p><a href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> -&gt; <a href="http://192.168.101.11:8601/">http://192.168.101.11:8601</a> 主机不同, 跨域</p><p><a href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> -&gt; <a href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> 协议不同,跨域</p><p>服务器之间不存在跨域, 浏览器判断跨域请求头添加<code>origin</code> , 表示这个请求来源哪里</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://localhost:8601<br></code></pre></td></tr></table></figure><p>服务器收到请求判断这个Origin是否允许跨域，如果允许则在<code>响应头</code>中说明允许该来源的跨域请求</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Access</span>-Control-<span class="hljs-literal">Allow</span>-Origin：http://localhost:<span class="hljs-number">8601</span><br></code></pre></td></tr></table></figure><p>允许<code>任何</code>域名来的跨域请求, 则响应如下</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-keyword">Access</span>-Control-Allow-Origin：*<br></code></pre></td></tr></table></figure><h2 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h2><h3 id="1、JSONP"><a href="#1、JSONP" class="headerlink" title="1、JSONP"></a>1、JSONP</h3><p>通过script标签的src属性进行跨域请求，如果服务端要响应内容则首先读取请求参数callback的值，callback是一个回调函数的名称，服务端读取callback的值后将响应内容通过调用callback函数的方式告诉请求方。如下图：</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212224701755.png" alt="image-20231212224701755"></p><h3 id="2、添加响应头"><a href="#2、添加响应头" class="headerlink" title="2、添加响应头"></a>2、添加响应头</h3><p>服务端在响应头添加 Access-Control-Allow-Origin：*</p><h3 id="3、通过nginx代理跨域"><a href="#3、通过nginx代理跨域" class="headerlink" title="3、通过nginx代理跨域"></a>3、通过nginx代理跨域</h3><p>由于服务端之间没有跨域，浏览器通过nginx去访问跨域地址。</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231212224934038.png" alt="image-20231212224934038"></p><p>1）浏览器先访问<a href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> nginx提供的地址，进入页面</p><p>2）此页面要跨域访问<a href="http://192.168.101.11:8601/">http://192.168.101.11:8601</a> ，不能直接跨域访问<a href="http://www.baidu.com:8601/">http://www.baidu.com:8601</a> ，而是访问nginx的一个同源地址，比如：<a href="http://192.168.101.11:8601/api">http://192.168.101.11:8601/api</a> ，通过<a href="http://192.168.101.11:8601/api">http://192.168.101.11:8601/api</a> 的代理去访问<a href="http://www.baidu.com:8601。">http://www.baidu.com:8601。</a></p><p>这样就实现了跨域访问。</p><p>浏览器到<a href="http://192.168.101.11:8601/api">http://192.168.101.11:8601/api</a> 没有跨域</p><p>nginx到<a href="http://www.baidu.com:8601通过服务端通信，没有跨域。">http://www.baidu.com:8601通过服务端通信，没有跨域。</a></p><hr><h3 id="方案2代码示例"><a href="#方案2代码示例" class="headerlink" title="方案2代码示例"></a>方案2代码示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.system.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.cors.CorsConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;<br><span class="hljs-keyword">import</span> org.springframework.web.filter.CorsFilter;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 跨域过虑器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/7 11:04</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@Configuration</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalCorsConfig</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 允许跨域调用的过滤器</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-keyword">public</span> CorsFilter <span class="hljs-title function_">corsFilter</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-type">CorsConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsConfiguration</span>();<br>   <span class="hljs-comment">//允许白名单域名进行跨域调用</span><br>   config.addAllowedOrigin(<span class="hljs-string">&quot;*&quot;</span>);<br>   <span class="hljs-comment">//允许跨越发送cookie</span><br>   config.setAllowCredentials(<span class="hljs-literal">true</span>);<br>   <span class="hljs-comment">//放行全部原始头信息</span><br>   config.addAllowedHeader(<span class="hljs-string">&quot;*&quot;</span>);<br>   <span class="hljs-comment">//允许所有请求方法跨域调用</span><br>   config.addAllowedMethod(<span class="hljs-string">&quot;*&quot;</span>);<br>   <span class="hljs-type">UrlBasedCorsConfigurationSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBasedCorsConfigurationSource</span>();<br>   source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, config);<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorsFilter</span>(source);<br>  &#125;<br> &#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>后端</category>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>跨域</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker入门</title>
    <link href="/2023/12/11/docker%E5%85%A5%E9%97%A8/"/>
    <url>/2023/12/11/docker%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="docker入门"><a href="#docker入门" class="headerlink" title="docker入门"></a>docker入门</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol><li>卸载旧版</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum remove docker \<br>    docker-client \<br>    docker-client-latest \<br>    docker-common \<br>    docker-latest \<br>    docker-latest-logrotate \<br>    docker-logrotate \<br>    docker-engine<br></code></pre></td></tr></table></figure><ol start="2"><li>配置Docker的yum库</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 安装一个yum工具</span><br>yum install -y yum-utils<br><span class="hljs-comment"># 配置Docker的yum源</span><br>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo<br></code></pre></td></tr></table></figure><ol start="3"><li>安装</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin<br></code></pre></td></tr></table></figure><ol start="4"><li>启动和校验</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 启动Docker</span><br>systemctl start docker<br><br><span class="hljs-comment"># 停止Docker</span><br>systemctl stop docker<br><br><span class="hljs-comment"># 重启</span><br>systemctl restart docker<br><br><span class="hljs-comment"># 设置开机自启</span><br>systemctl <span class="hljs-built_in">enable</span> docker<br><br><span class="hljs-comment"># 执行docker ps命令，如果不报错，说明安装启动成功</span><br>docker ps<br></code></pre></td></tr></table></figure><ol start="5"><li>配置镜像加速</li></ol><p><a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211110046985.png" alt="image-20231211110046985"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo <span class="hljs-built_in">mkdir</span> -p /etc/docker<br>sudo <span class="hljs-built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="hljs-string">&#x27;EOF&#x27;</span><br>&#123;<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://uupvlouh.mirror.aliyuncs.com&quot;</span>]<br>&#125;<br>EOF<br>sudo systemctl daemon-reload<br>sudo systemctl restart docker<br></code></pre></td></tr></table></figure><h2 id="部署MySQL"><a href="#部署MySQL" class="headerlink" title="部署MySQL"></a>部署MySQL</h2><p>最简单的命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d \<br>  --name mysql \<br>  -p 3306:3306 \<br>  -e TZ=Asia/Shanghai \<br>  -e MYSQL_ROOT_PASSWORD=123 \<br>  mysql<br></code></pre></td></tr></table></figure><p><code>镜像</code>包含<code>MySQL</code>和运行所需的<code>环境</code>,<code>配置</code>,<code>系统级函数库</code>, 运行的镜像叫做<code>容器</code></p><p>镜像 image   容器 container</p><p>Docker安装软件的过程，就是自动搜索下载镜像，然后创建并运行容器的过程</p><p>从哪里下载镜像?</p><p><a href="https://hub.docker.com/">https://hub.docker.com/</a></p><p>这种存储镜像的服务器, 叫 <code>DockerRegistry(镜像仓库)</code>, 可以是官方的, 可以是阿里云第三方的, 可以是私有的, 就像Github  Gitee  Gitlab  </p><p>daemon - 守护进程</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211110923697.png" alt="image-20231211110923697"></p><p>回到命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d \<br>  --name mysql \<br>  -p 3306:3306 \<br>  -e TZ=Asia/Shanghai \<br>  -e MYSQL_ROOT_PASSWORD=123 \<br>  mysql<br>  <br><span class="hljs-comment"># -d 让容器在后台运行</span><br><span class="hljs-comment"># --name 命名</span><br><span class="hljs-comment"># -p 3306:3306  端口映射 -&gt;   -p 宿主端口:容器端口(容器端口&#123;进程默认端口&#125;,宿主端口不能冲突)</span><br><span class="hljs-comment"># -e TZ=Asia/Shanghai  配置容器内进程运行的一些参数, -e k=v</span><br><span class="hljs-comment"># mysql 镜像名称 -&gt; Docker根据名字搜索下载镜像, 格式: 镜像名:版本号(默认latest)</span><br></code></pre></td></tr></table></figure><h2 id="常见命令"><a href="#常见命令" class="headerlink" title="常见命令"></a>常见命令</h2><table><thead><tr><th align="left">docker push</th><th align="left">推送镜像</th></tr></thead><tbody><tr><td align="left">docker images</td><td align="left">查看镜像</td></tr><tr><td align="left">docker rmi</td><td align="left">删除镜像</td></tr><tr><td align="left">docker run</td><td align="left">创建并运行镜像</td></tr><tr><td align="left">docker stop</td><td align="left">停止容器</td></tr><tr><td align="left">docker start</td><td align="left">启动容器</td></tr><tr><td align="left">docker restart</td><td align="left">重启容器</td></tr><tr><td align="left">docker rm</td><td align="left">删除指定容器</td></tr><tr><td align="left">docker ps</td><td align="left">查看容器</td></tr><tr><td align="left">docker logs</td><td align="left">查看容器日志</td></tr><tr><td align="left">docker exec</td><td align="left">进入容器</td></tr><tr><td align="left">docker save</td><td align="left">保存镜像到本地文件</td></tr><tr><td align="left">docker load</td><td align="left">加载本地文件到镜像</td></tr><tr><td align="left">docker inspect</td><td align="left">查看容器详细信息</td></tr><tr><td align="left">docker update –restart&#x3D;always  [id&#x2F;容器名]</td><td align="left">容器开机自启</td></tr></tbody></table><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211115636411.png" alt="image-20231211115636411"></p><p>示例: Nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 第1步，去DockerHub查看nginx镜像仓库及相关信息</span><br><br><span class="hljs-comment"># 第2步，拉取Nginx镜像</span><br>docker pull nginx<br><br><span class="hljs-comment"># 第3步，查看镜像</span><br>docker images<br><span class="hljs-comment"># 结果如下：</span><br>REPOSITORY   TAG       IMAGE ID       CREATED         SIZE<br>nginx        latest    605c77e624dd   16 months ago   141MB<br>mysql        latest    3218b38490ce   17 months ago   516MB<br><br><span class="hljs-comment"># 第4步，创建并允许Nginx容器</span><br>docker run -d --name nginx -p 80:80 nginx<br><br><span class="hljs-comment"># 第5步，查看运行中容器</span><br>docker ps<br><span class="hljs-comment"># 也可以加格式化方式访问，格式会更加清爽</span><br>docker ps --format <span class="hljs-string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span><br><br><span class="hljs-comment"># 第6步，访问网页，地址：http://虚拟机地址</span><br><br><span class="hljs-comment"># 第7步，停止容器</span><br>docker stop nginx<br><br><span class="hljs-comment"># 第8步，查看所有容器</span><br>docker ps -a --format <span class="hljs-string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span><br><br><span class="hljs-comment"># 第9步，再次启动nginx容器</span><br>docker start nginx<br><br><span class="hljs-comment"># 第10步，再次查看容器</span><br>docker ps --format <span class="hljs-string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span><br><br><span class="hljs-comment"># 第11步，查看容器详细信息</span><br>docker inspect nginx<br><br><span class="hljs-comment"># 第12步，进入容器,查看容器内目录</span><br>docker <span class="hljs-built_in">exec</span> -it nginx bash<br><span class="hljs-comment"># 或者，可以进入MySQL</span><br>docker <span class="hljs-built_in">exec</span> -it mysql mysql -uroot -p<br><br><span class="hljs-comment"># 第13步，删除容器</span><br>docker <span class="hljs-built_in">rm</span> nginx<br><span class="hljs-comment"># 发现无法删除，因为容器运行中，强制删除容器</span><br>docker <span class="hljs-built_in">rm</span> -f nginx<br></code></pre></td></tr></table></figure><h2 id="命令别名"><a href="#命令别名" class="headerlink" title="命令别名"></a>命令别名</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 修改/root/.bashrc文件</span><br>vi /root/.bashrc<br>内容如下：<br><span class="hljs-comment"># .bashrc</span><br><br><span class="hljs-comment"># User specific aliases and functions</span><br><br><span class="hljs-built_in">alias</span> <span class="hljs-built_in">rm</span>=<span class="hljs-string">&#x27;rm -i&#x27;</span><br><span class="hljs-built_in">alias</span> <span class="hljs-built_in">cp</span>=<span class="hljs-string">&#x27;cp -i&#x27;</span><br><span class="hljs-built_in">alias</span> <span class="hljs-built_in">mv</span>=<span class="hljs-string">&#x27;mv -i&#x27;</span><br><span class="hljs-built_in">alias</span> dps=<span class="hljs-string">&#x27;docker ps --format &quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;&#x27;</span><br><span class="hljs-built_in">alias</span> dis=<span class="hljs-string">&#x27;docker images&#x27;</span><br><br><span class="hljs-comment"># Source global definitions</span><br><span class="hljs-keyword">if</span> [ -f /etc/bashrc ]; <span class="hljs-keyword">then</span><br>        . /etc/bashrc<br><span class="hljs-keyword">fi</span><br>--------------------------------------------------<br><br><span class="hljs-comment"># 使别名生效</span><br><span class="hljs-built_in">source</span> /root/.bashrc<br></code></pre></td></tr></table></figure><h2 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h2><blockquote><p>读写容器内的文件不方便, 程序运行产生的<code>数据</code>, 程序运行依赖的<code>配置</code>应该与容器<code>解耦</code></p></blockquote><p>数据卷是一个虚拟目录, 是容器内目录和宿主机目录映射的桥梁</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211120425446.png" alt="image-20231211120425446"></p><p>容器的conf 和 html与宿主conf 和html 目录关联, 称为<code>挂载</code></p><p>容器内 conf 和 html 目录指向 &#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;conf&#x2F;_data 和 &#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;html&#x2F;_data, 我们修改主机对应目录就能实现对容器内对应目录的修改</p><p><strong>直接挂载宿主机目录</strong></p><p>由于数据卷目录太深， 不好找， 我们允许让容器直接挂载到主机目录</p><p><strong>命令</strong></p><table><thead><tr><th align="left">docker volume create</th><th align="left">创建数据卷</th></tr></thead><tbody><tr><td align="left">docker volume ls</td><td align="left">查看所有数据卷</td></tr><tr><td align="left">docker volume rm</td><td align="left">删除指定数据卷</td></tr><tr><td align="left">docker volume inspect</td><td align="left">查看某个数据卷详情</td></tr><tr><td align="left">docker volume prune</td><td align="left">清除数据卷</td></tr></tbody></table><blockquote><p>容器和数据卷的挂载要在<code>创建容器时</code>配置, 已经创建好的容器, 不能再设置数据卷</p></blockquote><p>示例: nginx</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs PowerShell"><span class="hljs-comment"># 1.首先创建容器并指定数据卷，注意通过 -v 参数来指定数据卷</span><br>docker run <span class="hljs-literal">-d</span> <span class="hljs-literal">--name</span> nginx <span class="hljs-literal">-p</span> <span class="hljs-number">80</span>:<span class="hljs-number">80</span> <span class="hljs-literal">-v</span> html:/usr/share/nginx/html nginx<br><br><span class="hljs-comment"># 2.然后查看数据卷</span><br>docker volume <span class="hljs-built_in">ls</span><br><span class="hljs-comment"># 结果</span><br>DRIVER    VOLUME NAME<br>local     <span class="hljs-number">29524</span>ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f<br>local     html<br><br><span class="hljs-comment"># 3.查看数据卷详情</span><br>docker volume inspect html<br><span class="hljs-comment"># 结果</span><br>[<br>    &#123;<br>        <span class="hljs-string">&quot;CreatedAt&quot;</span>: <span class="hljs-string">&quot;2024-05-17T19:57:08+08:00&quot;</span>,<br>        <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>        <span class="hljs-string">&quot;Labels&quot;</span>: <span class="hljs-type">null</span>,<br>        <span class="hljs-string">&quot;Mountpoint&quot;</span>: <span class="hljs-string">&quot;/var/lib/docker/volumes/html/_data&quot;</span>,<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;html&quot;</span>,<br>        <span class="hljs-string">&quot;Options&quot;</span>: <span class="hljs-type">null</span>,<br>        <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span><br>    &#125;<br>]<br><br><span class="hljs-comment"># 4.查看/var/lib/docker/volumes/html/_data目录</span><br>ll /var/lib/docker/volumes/html/_data<br><span class="hljs-comment"># 可以看到与nginx的html目录内容一样，结果如下：</span><br>总用量 <span class="hljs-number">8</span><br><span class="hljs-literal">-rw-r--r--</span>. <span class="hljs-number">1</span> root root <span class="hljs-number">497</span> <span class="hljs-number">12</span>月 <span class="hljs-number">28</span> <span class="hljs-number">2021</span> <span class="hljs-number">50</span>x.html<br><span class="hljs-literal">-rw-r--r--</span>. <span class="hljs-number">1</span> root root <span class="hljs-number">615</span> <span class="hljs-number">12</span>月 <span class="hljs-number">28</span> <span class="hljs-number">2021</span> index.html<br><br><span class="hljs-comment"># 5.进入该目录，并随意修改index.html内容</span><br><span class="hljs-built_in">cd</span> /var/lib/docker/volumes/html/_data<br>vi index.html<br><br><span class="hljs-comment"># 6.打开页面，查看效果</span><br><br><span class="hljs-comment"># 7.进入容器内部，查看/usr/share/nginx/html目录内的文件是否变化</span><br>docker exec <span class="hljs-literal">-it</span> nginx bash<br></code></pre></td></tr></table></figure><p>演示一下MySQL的<code>匿名数据卷(默认存在的数据卷)</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker inspect mysql  <span class="hljs-comment"># 查看MySQL容器的详细信息</span><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211150259683.png" alt="image-20231211150259683"></p><p>这个容器声明了一个本地目录, 需要挂载数据卷, 数据卷未定义</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211150414005.png" alt="image-20231211150414005"></p><p>Name: 数据卷名称, 匿名卷自动生成一串hash值</p><p>Source: 宿主机目录</p><p>Destination: 容器内目录</p><blockquote><p>以上, 将容器内的&#x2F;var&#x2F;lib&#x2F;mysql目录, 和数据卷3706a717d3de91e57b259edc4e69c3d91a38a1bf12baf53c7c1c89b38e6da8c1挂载, 在宿主机有了&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;3706a717d3de91e57b259edc4e69c3d91a38a1bf12baf53c7c1c89b38e6da8c1&#x2F;_data这个目录, 这就是匿名数据卷对应的目录, 使用和普通数据卷没有差别</p></blockquote><p>看一下这个数据卷目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -l /var/lib/docker/volumes/3706a717d3de91e57b259edc4e69c3d91a38a1bf12baf53c7c1c89b38e6da8c1/_data<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211150745341.png" alt="image-20231211150745341"></p><h2 id="挂载本地目录"><a href="#挂载本地目录" class="headerlink" title="挂载本地目录"></a>挂载本地目录</h2><p>同样在创建时进行挂载操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Bash">-v mysql:/var/lib/mysql <span class="hljs-comment"># 会被识别为一个数据卷叫mysql，运行时会自动创建这个数据卷</span><br>-v ./mysql:/var/lib/mysql <span class="hljs-comment"># 会被识别为当前目录下的mysql目录，运行时如果不存在会创建目录</span><br></code></pre></td></tr></table></figure><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs gherkin"><span class="hljs-comment"># 1.删除原来的MySQL容器</span><br>docker rm -f mysql<br><br><span class="hljs-comment"># 2.进入root目录</span><br>cd ~<br><br><span class="hljs-comment"># 3.创建并运行新mysql容器，挂载本地目录</span><br>docker run -d \<br>  --name mysql \<br>  -p 3306:3306 \<br>  -e TZ=Asia/Shanghai \<br>  -e MYSQL_ROOT_PASSWORD=123 \<br>  -v ./mysql/data:/var/lib/mysql \<br>  -v ./mysql/conf:/etc/mysql/conf.d \<br>  -v ./mysql/init:/docker-entrypoint-initdb.d \<br>  mysql<br><br><span class="hljs-comment"># 4.查看root目录，可以发现~/mysql/data目录已经自动创建好了</span><br>ls -l mysql<br><span class="hljs-comment"># 结果：</span><br>总用量 4<br>drwxr-xr-x. 2 root    root   20 5月  19 15:11 conf<br>drwxr-xr-x. 7 polkitd root 4096 5月  19 15:11 data<br>drwxr-xr-x. 2 root    root   23 5月  19 15:11 init<br><br><span class="hljs-comment"># 查看data目录，会发现里面有大量数据库数据，说明数据库完成了初始化</span><br>ls -l data<br><br><span class="hljs-comment"># 5.查看MySQL容器内数据</span><br><span class="hljs-comment"># 5.1.进入MySQL</span><br>docker exec -it mysql mysql -uroot -p123<br><span class="hljs-comment"># 5.2.查看编码表</span><br>show variables like <span class="hljs-string">&quot;%char%&quot;</span>;<br><span class="hljs-comment"># 5.3.结果，发现编码是utf8mb4没有问题</span><br>+--------------------------+--------------------------------+<br>|<span class="hljs-string"> Variable_name            </span>|<span class="hljs-string"> Value                          </span>|<br>+--------------------------+--------------------------------+<br>|<span class="hljs-string"> character_set_client     </span>|<span class="hljs-string"> utf8mb4                        </span>|<br>|<span class="hljs-string"> character_set_connection </span>|<span class="hljs-string"> utf8mb4                        </span>|<br>|<span class="hljs-string"> character_set_database   </span>|<span class="hljs-string"> utf8mb4                        </span>|<br>|<span class="hljs-string"> character_set_filesystem </span>|<span class="hljs-string"> binary                         </span>|<br>|<span class="hljs-string"> character_set_results    </span>|<span class="hljs-string"> utf8mb4                        </span>|<br>|<span class="hljs-string"> character_set_server     </span>|<span class="hljs-string"> utf8mb4                        </span>|<br>|<span class="hljs-string"> character_set_system     </span>|<span class="hljs-string"> utf8mb3                        </span>|<br>|<span class="hljs-string"> character_sets_dir       </span>|<span class="hljs-string"> /usr/share/mysql-8.0/charsets/ </span>|<br>+--------------------------+--------------------------------+<br><br><span class="hljs-comment"># 6.查看数据</span><br><span class="hljs-comment"># 6.1.查看数据库</span><br>show databases;<br><span class="hljs-comment"># 结果，hmall是黑马商城数据库</span><br>+--------------------+<br>|<span class="hljs-string"> Database           </span>|<br>+--------------------+<br>|<span class="hljs-string"> hmall              </span>|<br>|<span class="hljs-string"> information_schema </span>|<br>|<span class="hljs-string"> mysql              </span>|<br>|<span class="hljs-string"> performance_schema </span>|<br>|<span class="hljs-string"> sys                </span>|<br>+--------------------+<br>5 rows in set (0.00 sec)<br><span class="hljs-comment"># 6.2.切换到hmall数据库</span><br>use hmall;<br><span class="hljs-comment"># 6.3.查看表</span><br>show tables;<br><span class="hljs-comment"># 结果：</span><br>+-----------------+<br>|<span class="hljs-string"> Tables_in_hmall </span>|<br>+-----------------+<br>|<span class="hljs-string"> address         </span>|<br>|<span class="hljs-string"> cart            </span>|<br>|<span class="hljs-string"> item            </span>|<br>|<span class="hljs-string"> order           </span>|<br>|<span class="hljs-string"> order_detail    </span>|<br>|<span class="hljs-string"> order_logistics </span>|<br>|<span class="hljs-string"> pay_order       </span>|<br>|<span class="hljs-string"> user            </span>|<br>+-----------------+<br><span class="hljs-comment"># 6.4.查看address表数据</span><br>+----+---------+----------+--------+----------+-------------+---------------+-----------+------------+-------+<br>|<span class="hljs-string"> id </span>|<span class="hljs-string"> user_id </span>|<span class="hljs-string"> province </span>|<span class="hljs-string"> city   </span>|<span class="hljs-string"> town     </span>|<span class="hljs-string"> mobile      </span>|<span class="hljs-string"> street        </span>|<span class="hljs-string"> contact   </span>|<span class="hljs-string"> is_default </span>|<span class="hljs-string"> notes </span>|<br>+----+---------+----------+--------+----------+-------------+---------------+-----------+------------+-------+<br>|<span class="hljs-string"> 59 </span>|<span class="hljs-string">       1 </span>|<span class="hljs-string"> 北京     </span>|<span class="hljs-string"> 北京   </span>|<span class="hljs-string"> 朝阳区    </span>|<span class="hljs-string"> 13900112222 </span>|<span class="hljs-string"> 金燕龙办公楼   </span>|<span class="hljs-string"> 李佳诚    </span>|<span class="hljs-string"> 0          </span>|<span class="hljs-string"> NULL  </span>|<br>|<span class="hljs-string"> 60 </span>|<span class="hljs-string">       1 </span>|<span class="hljs-string"> 北京     </span>|<span class="hljs-string"> 北京   </span>|<span class="hljs-string"> 朝阳区    </span>|<span class="hljs-string"> 13700221122 </span>|<span class="hljs-string"> 修正大厦       </span>|<span class="hljs-string"> 李佳红    </span>|<span class="hljs-string"> 0          </span>|<span class="hljs-string"> NULL  </span>|<br>|<span class="hljs-string"> 61 </span>|<span class="hljs-string">       1 </span>|<span class="hljs-string"> 上海     </span>|<span class="hljs-string"> 上海   </span>|<span class="hljs-string"> 浦东新区  </span>|<span class="hljs-string"> 13301212233 </span>|<span class="hljs-string"> 航头镇航头路   </span>|<span class="hljs-string"> 李佳星    </span>|<span class="hljs-string"> 1          </span>|<span class="hljs-string"> NULL  </span>|<br>|<span class="hljs-string"> 63 </span>|<span class="hljs-string">       1 </span>|<span class="hljs-string"> 广东     </span>|<span class="hljs-string"> 佛山   </span>|<span class="hljs-string"> 永春      </span>|<span class="hljs-string"> 13301212233 </span>|<span class="hljs-string"> 永春武馆       </span>|<span class="hljs-string"> 李晓龙    </span>|<span class="hljs-string"> 0          </span>|<span class="hljs-string"> NULL  </span>|<br>+----+---------+----------+--------+----------+-------------+---------------+-----------+------------+-------+<br>4 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure><h2 id="镜像结构"><a href="#镜像结构" class="headerlink" title="镜像结构"></a>镜像结构</h2><blockquote><p>我们自己部署一个java项目把他打包成镜像</p><ul><li>准备Linux运行环境（java项目并不需要完整的操作系统，仅仅是基础运行环境即可）</li><li>安装并配置JDK</li><li>拷贝jar包</li><li>配置启动脚本</li></ul></blockquote><p>镜像文件不是随意对方的, 按照操作步骤分层叠放, 我们构建的某些层其他人已经制作过, <code>直接拷贝</code>这些层, 不用<code>重复制作</code></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211151447851.png" alt="image-20231211151447851"></p><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>制作镜像过程需要逐层处理和打包, 所以Docker提供自动打包镜像功能, 只需要将打包过程每一层需要做的事写成一个文件, 全交给Docker一键打包即可</p><table><thead><tr><th align="left"><strong>指令</strong></th><th align="left"><strong>说明</strong></th><th align="left"><strong>示例</strong></th></tr></thead><tbody><tr><td align="left"><strong>FROM</strong></td><td align="left">指定基础镜像</td><td align="left"><code>FROM centos:6</code></td></tr><tr><td align="left"><strong>ENV</strong></td><td align="left">设置环境变量，可在后面指令使用</td><td align="left"><code>ENV key value</code></td></tr><tr><td align="left"><strong>COPY</strong></td><td align="left">拷贝本地文件到镜像的指定目录</td><td align="left"><code>COPY ./xx.jar /tmp/app.jar</code></td></tr><tr><td align="left"><strong>RUN</strong></td><td align="left">执行Linux的shell命令，一般是安装过程的命令</td><td align="left"><code>RUN yum install gcc</code></td></tr><tr><td align="left"><strong>EXPOSE</strong></td><td align="left">指定容器运行时监听的端口，是给镜像使用者看的</td><td align="left">EXPOSE 8080</td></tr><tr><td align="left"><strong>ENTRYPOINT</strong></td><td align="left">镜像中应用的启动命令，容器运行时调用</td><td align="left">ENTRYPOINT java -jar xx.jar</td></tr></tbody></table><p>示例: 基于Ubuntu 构建一个Java应用</p><p>Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># 指定基础镜像</span><br><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">16.04</span><br><span class="hljs-comment"># 配置环境变量，JDK的安装目录、容器内时区</span><br><span class="hljs-keyword">ENV</span> JAVA_DIR=/usr/local<br><span class="hljs-keyword">ENV</span> TZ=Asia/Shanghai<br><span class="hljs-comment"># 拷贝jdk和java项目的包</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./jdk8.tar.gz <span class="hljs-variable">$JAVA_DIR</span>/</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./docker-demo.jar /tmp/app.jar</span><br><span class="hljs-comment"># 设定时区</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TZ</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TZ</span> &gt; /etc/timezone</span><br><span class="hljs-comment"># 安装JDK</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> <span class="hljs-variable">$JAVA_DIR</span> \</span><br><span class="language-bash"> &amp;&amp; tar -xf ./jdk8.tar.gz \</span><br><span class="language-bash"> &amp;&amp; <span class="hljs-built_in">mv</span> ./jdk1.8.0_144 ./java8</span><br><span class="hljs-comment"># 配置环境变量</span><br><span class="hljs-keyword">ENV</span> JAVA_HOME=$JAVA_DIR/java8<br><span class="hljs-keyword">ENV</span> PATH=$PATH:$JAVA_HOME/bin<br><span class="hljs-comment"># 指定项目监听的端口</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><span class="hljs-comment"># 入口，java项目的启动命令</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/app.jar&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>这很麻烦, 有基础的系统+JDK环境, 我们在这两个基础上制作java镜像</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># 基础镜像</span><br><span class="hljs-keyword">FROM</span> openjdk:<span class="hljs-number">11.0</span>-jre-buster<br><span class="hljs-comment"># 设定时区</span><br><span class="hljs-keyword">ENV</span> TZ=Asia/Shanghai<br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TZ</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TZ</span> &gt; /etc/timezone</span><br><span class="hljs-comment"># 拷贝jar包</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> docker-demo.jar /app.jar</span><br><span class="hljs-comment"># 入口</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/app.jar&quot;</span>]</span><br></code></pre></td></tr></table></figure><h2 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h2><p>准备好项目和dockerfile</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211160519182.png" alt="image-20231211160519182"></p><p>构建镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 进入镜像目录</span><br><span class="hljs-built_in">cd</span> /root/demo<br><span class="hljs-comment"># 开始构建</span><br>docker build -t docker-demo:1.0 .<br></code></pre></td></tr></table></figure><ul><li>-t docker-demo:1.0  指定镜像名称(名称:版本号)</li><li>.     Dockerfile所在路径, .是当前目录</li></ul><p>也可以指定目录, 不用.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 直接指定Dockerfile目录</span><br>docker build -t docker-demo:1.0 /root/demo<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231211160750978.png" alt="image-20231211160750978"></p><p>尝试运行他</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1.创建并运行容器</span><br>docker run -d --name <span class="hljs-built_in">dd</span> -p 8080:8080 docker-demo:1.0<br><span class="hljs-comment"># 2.查看容器</span><br>dps<br><span class="hljs-comment"># 结果</span><br>CONTAINER ID   IMAGE             PORTS                                                  STATUS         NAMES<br>78a000447b49   docker-demo:1.0   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp              Up 2 seconds   <span class="hljs-built_in">dd</span><br>f63cfead8502   mysql             0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp   Up 2 hours     mysql<br><br><span class="hljs-comment"># 3.访问</span><br>curl localhost:8080/hello/count<br><span class="hljs-comment"># 结果：</span><br>&lt;h5&gt;欢迎访问黑马商城, 这是您第1次访问&lt;h5&gt;<br></code></pre></td></tr></table></figure><h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><blockquote><p>我们的容器之间互相访问, 需要在同一个网络</p></blockquote><p>之前的MySQL容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1.用基本命令，寻找Networks.bridge.IPAddress属性</span><br>docker inspect mysql<br><span class="hljs-comment"># 也可以使用format过滤结果</span><br>docker inspect --format=<span class="hljs-string">&#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;println .IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span> mysql<br><span class="hljs-comment"># 得到IP地址如下：</span><br>172.17.0.2<br><br><span class="hljs-comment"># 2.然后通过命令进入dd容器</span><br>docker <span class="hljs-built_in">exec</span> -it <span class="hljs-built_in">dd</span> bash<br><br><span class="hljs-comment"># 3.在容器内，通过ping命令测试网络</span><br>ping 172.17.0.2<br><span class="hljs-comment"># 结果</span><br>PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.<br>64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.053 ms<br>64 bytes from 172.17.0.2: icmp_seq=2 ttl=64 time=0.059 ms<br>64 bytes from 172.17.0.2: icmp_seq=3 ttl=64 time=0.058 ms<br></code></pre></td></tr></table></figure><p>可以互联, 没有问题. 但是容器网络IP是虚拟的IP, 不是固定值</p><table><thead><tr><th align="left"><strong>命令</strong></th><th align="left"><strong>说明</strong></th><th align="left"><strong>文档地址</strong></th></tr></thead><tbody><tr><td align="left">docker network create</td><td align="left">创建一个网络</td><td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_create/">docker network create</a></td></tr><tr><td align="left">docker network ls</td><td align="left">查看所有网络</td><td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_ls/">docs.docker.com</a></td></tr><tr><td align="left">docker network rm</td><td align="left">删除指定网络</td><td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_rm/">docs.docker.com</a></td></tr><tr><td align="left">docker network prune</td><td align="left">清除未使用的网络</td><td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_prune/">docs.docker.com</a></td></tr><tr><td align="left">docker network connect</td><td align="left">使指定容器连接加入某网络</td><td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_connect/">docs.docker.com</a></td></tr><tr><td align="left">docker network disconnect</td><td align="left">使指定容器连接离开某网络</td><td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_disconnect/">docker network disconnect</a></td></tr><tr><td align="left">docker network inspect</td><td align="left">查看网络详细信息</td><td align="left"><a href="https://docs.docker.com/engine/reference/commandline/network_inspect/">docker network inspect</a></td></tr></tbody></table><p><strong>示例:自定义网络</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1.首先通过命令创建一个网络</span><br>docker network create hmall<br><br><span class="hljs-comment"># 2.然后查看网络</span><br>docker network <span class="hljs-built_in">ls</span><br><span class="hljs-comment"># 结果：</span><br>NETWORK ID     NAME      DRIVER    SCOPE<br>639bc44d0a87   bridge    bridge    <span class="hljs-built_in">local</span><br>403f16ec62a2   hmall     bridge    <span class="hljs-built_in">local</span><br>0dc0f72a0fbb   host      host      <span class="hljs-built_in">local</span><br>cd8d3e8df47b   none      null      <span class="hljs-built_in">local</span><br><span class="hljs-comment"># 其中，除了hmall以外，其它都是默认的网络</span><br><br><span class="hljs-comment"># 3.让dd和mysql都加入该网络，注意，在加入网络时可以通过--alias给容器起别名</span><br><span class="hljs-comment"># 这样该网络内的其它容器可以用别名互相访问！</span><br><span class="hljs-comment"># 3.1.mysql容器，指定别名为db，另外每一个容器都有一个别名是容器名</span><br>docker network connect hmall mysql --<span class="hljs-built_in">alias</span> db<br><span class="hljs-comment"># 3.2.db容器，也就是我们的java项目</span><br>docker network connect hmall <span class="hljs-built_in">dd</span><br><br><span class="hljs-comment"># 4.进入dd容器，尝试利用别名访问db</span><br><span class="hljs-comment"># 4.1.进入容器</span><br>docker <span class="hljs-built_in">exec</span> -it <span class="hljs-built_in">dd</span> bash<br><span class="hljs-comment"># 4.2.用db别名访问</span><br>ping db<br><span class="hljs-comment"># 结果</span><br>PING db (172.18.0.2) 56(84) bytes of data.<br>64 bytes from mysql.hmall (172.18.0.2): icmp_seq=1 ttl=64 time=0.070 ms<br>64 bytes from mysql.hmall (172.18.0.2): icmp_seq=2 ttl=64 time=0.056 ms<br><span class="hljs-comment"># 4.3.用容器名访问</span><br>ping mysql<br><span class="hljs-comment"># 结果：</span><br>PING mysql (172.18.0.2) 56(84) bytes of data.<br>64 bytes from mysql.hmall (172.18.0.2): icmp_seq=1 ttl=64 time=0.044 ms<br>64 bytes from mysql.hmall (172.18.0.2): icmp_seq=2 ttl=64 time=0.054 ms<br></code></pre></td></tr></table></figure><p>无需IP地址, 直接用名称或别名即可实现容器互联了</p><h2 id="DockerCompose"><a href="#DockerCompose" class="headerlink" title="DockerCompose"></a>DockerCompose</h2><p>我们部署一个java项目, 需要用MySQL Nginx Java项目3个容器, 比较麻烦</p><p>DockerCompose 帮我们实现<code>多个互联的Docker容器快速部署</code>, 通过一个 docker-compose.yml 模板文件 定义一组相关联的应用容器</p><p>之前MySQL的部署命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d \<br>  --name mysql \<br>  -p 3306:3306 \<br>  -e TZ=Asia/Shanghai \<br>  -e MYSQL_ROOT_PASSWORD=123 \<br>  -v ./mysql/data:/var/lib/mysql \<br>  -v ./mysql/conf:/etc/mysql/conf.d \<br>  -v ./mysql/init:/docker-entrypoint-initdb.d \<br>  --network hmall<br>  mysql<br></code></pre></td></tr></table></figure><p>转换成 docker-compose.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3.8&quot;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">mysql:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3306:3306&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-number">123</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql/conf:/etc/mysql/conf.d&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql/data:/var/lib/mysql&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">new</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">new:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">hmall</span><br></code></pre></td></tr></table></figure><table><thead><tr><th align="left"><strong>docker run 参数</strong></th><th align="left"><strong>docker compose 指令</strong></th><th align="left"><strong>说明</strong></th></tr></thead><tbody><tr><td align="left">–name</td><td align="left">container_name</td><td align="left">容器名称</td></tr><tr><td align="left">-p</td><td align="left">ports</td><td align="left">端口映射</td></tr><tr><td align="left">-e</td><td align="left">environment</td><td align="left">环境变量</td></tr><tr><td align="left">-v</td><td align="left">volumes</td><td align="left">数据卷配置</td></tr><tr><td align="left">–network</td><td align="left">networks</td><td align="left">网络</td></tr></tbody></table><p><strong>包括Mysql nginx java项目 3个容器的docker-compose.yml 示例</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3.8&quot;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">mysql:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3306:3306&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-number">123</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql/conf:/etc/mysql/conf.d&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql/data:/var/lib/mysql&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql/init:/docker-entrypoint-initdb.d&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">hm-net</span><br>  <span class="hljs-attr">hmall:</span><br>    <span class="hljs-attr">build:</span> <br>      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">hmall</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8080:8080&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">hm-net</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br>  <span class="hljs-attr">nginx:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;18080:18080&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;18081:18081&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./nginx/nginx.conf:/etc/nginx/nginx.conf&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./nginx/html:/usr/share/nginx/html&quot;</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">hmall</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">hm-net</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">hm-net:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">hmall</span><br></code></pre></td></tr></table></figure><p>文件准备ok, 然后部署</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker compose [OPTIONS] [COMMAND]<br></code></pre></td></tr></table></figure><table><thead><tr><th align="left"><strong>类型</strong></th><th align="left"><strong>参数或指令</strong></th><th align="left"><strong>说明</strong></th></tr></thead><tbody><tr><td align="left">Options</td><td align="left">-f</td><td align="left">指定compose文件的路径和名称</td></tr><tr><td align="left">-p</td><td align="left">指定project名称。project就是当前compose文件中设置的多个service的集合，是逻辑概念</td><td align="left"></td></tr><tr><td align="left">Commands</td><td align="left">up</td><td align="left">创建并启动所有service容器</td></tr><tr><td align="left">down</td><td align="left">停止并移除所有容器、网络</td><td align="left"></td></tr><tr><td align="left">ps</td><td align="left">列出所有启动的容器</td><td align="left"></td></tr><tr><td align="left">logs</td><td align="left">查看指定容器的日志</td><td align="left"></td></tr><tr><td align="left">stop</td><td align="left">停止容器</td><td align="left"></td></tr><tr><td align="left">start</td><td align="left">启动容器</td><td align="left"></td></tr><tr><td align="left">restart</td><td align="left">重启容器</td><td align="left"></td></tr><tr><td align="left">top</td><td align="left">查看运行的进程</td><td align="left"></td></tr><tr><td align="left">exec</td><td align="left">在指定的运行中容器中执行命令</td><td align="left"></td></tr></tbody></table><p>示例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># 1.进入root目录</span><br><span class="hljs-built_in">cd</span> /root<br><br><span class="hljs-comment"># 2.删除旧容器</span><br>docker <span class="hljs-built_in">rm</span> -f $(docker ps -qa)<br><br><span class="hljs-comment"># 3.删除hmall镜像</span><br>docker rmi hmall<br><br><span class="hljs-comment"># 4.清空MySQL数据</span><br><span class="hljs-built_in">rm</span> -rf mysql/data<br><br><span class="hljs-comment"># 5.启动所有, -d 参数是后台启动</span><br>docker compose up -d<br><span class="hljs-comment"># 结果：</span><br>[+] Building 15.5s (8/8) FINISHED<br> =&gt; [internal] load build definition from Dockerfile                                    0.0s<br> =&gt; =&gt; transferring dockerfile: 358B                                                    0.0s<br> =&gt; [internal] load .dockerignore                                                       0.0s<br> =&gt; =&gt; transferring context: 2B                                                         0.0s<br> =&gt; [internal] load metadata <span class="hljs-keyword">for</span> docker.io/library/openjdk:11.0-jre-buster             15.4s<br> =&gt; [1/3] FROM docker.io/library/openjdk:11.0-jre-buster@sha256:3546a17e6fb4ff4fa681c3  0.0s<br> =&gt; [internal] load build context                                                       0.0s<br> =&gt; =&gt; transferring context: 98B                                                        0.0s<br> =&gt; CACHED [2/3] RUN <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span>   0.0s<br> =&gt; CACHED [3/3] COPY hm-service.jar /app.jar                                           0.0s<br> =&gt; exporting to image                                                                  0.0s<br> =&gt; =&gt; exporting layers                                                                 0.0s<br> =&gt; =&gt; writing image sha256:32eebee16acde22550232f2eb80c69d2ce813ed099640e4cfed2193f71  0.0s<br> =&gt; =&gt; naming to docker.io/library/root-hmall                                           0.0s<br>[+] Running 4/4<br> ✔ Network hmall    Created                                                             0.2s<br> ✔ Container mysql  Started                                                             0.5s<br> ✔ Container hmall  Started                                                             0.9s<br> ✔ Container nginx  Started                                                             1.5s<br><br><span class="hljs-comment"># 6.查看镜像</span><br>docker compose images<br><span class="hljs-comment"># 结果</span><br>CONTAINER           REPOSITORY          TAG                 IMAGE ID            SIZE<br>hmall               root-hmall          latest              32eebee16acd        362MB<br>mysql               mysql               latest              3218b38490ce        516MB<br>nginx               nginx               latest              605c77e624dd        141MB<br><br><span class="hljs-comment"># 7.查看容器</span><br>docker compose ps<br><span class="hljs-comment"># 结果</span><br>NAME                IMAGE               COMMAND                  SERVICE             CREATED             STATUS              PORTS<br>hmall               root-hmall          <span class="hljs-string">&quot;java -jar /app.jar&quot;</span>     hmall               54 seconds ago      Up 52 seconds       0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp<br>mysql               mysql               <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   mysql               54 seconds ago      Up 53 seconds       0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp<br>nginx               nginx               <span class="hljs-string">&quot;/docker-entrypoint.…&quot;</span>   nginx               54 seconds ago      Up 52 seconds       80/tcp, 0.0.0.0:18080-18081-&gt;18080-18081/tcp, :::18080-18081-&gt;18080-18081/tcp<br></code></pre></td></tr></table></figure><p>打开浏览器，访问：<a href="http://yourip:8080/">http://yourIp:8080</a></p>]]></content>
    
    
    <categories>
      
      <category>后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux常用命令</title>
    <link href="/2023/12/10/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2023/12/10/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="Linux常用命令"><a href="#Linux常用命令" class="headerlink" title="Linux常用命令"></a>Linux常用命令</h1><p><a href="https://www.runoob.com/w3cnote/linux-common-command-2.html">https://www.runoob.com/w3cnote/linux-common-command-2.html</a></p><h2 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h2><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-keyword">ls</span> -a 列出目录所有文件，包含以.开始的隐藏文件<br><span class="hljs-keyword">ls</span> -A 列出除.及<span class="hljs-string">..</span>的其它文件<br><span class="hljs-keyword">ls</span> -r 反序排列<br><span class="hljs-keyword">ls</span> -t 以文件修改时间排序<br><span class="hljs-keyword">ls</span> -S 以文件大小排序<br><span class="hljs-keyword">ls</span> -h 以易读大小显示<br><span class="hljs-keyword">ls</span> -l 除了文件名之外，还将文件的权限、所有者、文件大小等信息详细列出来<br></code></pre></td></tr></table></figure><h2 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h2><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs excel">mkdir <span class="hljs-built_in">t</span>  当前工作目录创建名为<span class="hljs-built_in">t</span>的文件夹<br></code></pre></td></tr></table></figure><h2 id="rm"><a href="#rm" class="headerlink" title="rm"></a>rm</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -i *.<span class="hljs-built_in">log</span> 删除任何 .<span class="hljs-built_in">log</span> 文件，删除前逐一询问确认<br><span class="hljs-built_in">rm</span> -rf <span class="hljs-built_in">test</span> 删除 <span class="hljs-built_in">test</span> 子目录及子目录中所有档案删除，并且不用确认<br></code></pre></td></tr></table></figure><h2 id="rmdir"><a href="#rmdir" class="headerlink" title="rmdir"></a>rmdir</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">rmdir -p parent 不能删除非空目录<br></code></pre></td></tr></table></figure><h2 id="mv"><a href="#mv" class="headerlink" title="mv"></a>mv</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stata">mv <span class="hljs-keyword">test</span>.<span class="hljs-keyword">log</span> <span class="hljs-keyword">test</span>.txt  重命名<span class="hljs-keyword">test</span>.<span class="hljs-keyword">log</span>-&gt;<span class="hljs-keyword">test</span>.txt<br>mv a.txt b.txt c.txt /test1 将3个文件移动到/test1目录中<br>mv * ../ 移动当前文件夹所有文件到上一级目录<br></code></pre></td></tr></table></figure><h2 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h2><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-i 提示</span><br><span class="hljs-deletion">-r 复制目录及目录内所有项目</span><br><span class="hljs-deletion">-a 复制的文件与原文件时间一样</span><br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">cp -ai <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.txt</span> test  复制 <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.txt</span> 到 test 目录下，保持原文件时间，如果原文件存在提示是否覆盖<br>cp -s <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.txt</span> link_a<span class="hljs-selector-class">.txt</span>  为 <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.txt</span> 建立一个链接（快捷方式）<br></code></pre></td></tr></table></figure><h2 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> filename  一次显示整个文件<br><span class="hljs-built_in">cat</span> &gt; filename  从键盘创建一个文件<br></code></pre></td></tr></table></figure><h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">ps -aux | <span class="hljs-keyword">less</span> -N    ps 查看进程信息并通过 <span class="hljs-keyword">less</span> 分页显示<br></code></pre></td></tr></table></figure><h2 id="head"><a href="#head" class="headerlink" title="head"></a>head</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">head</span> <span class="hljs-number">1</span>.log -n <span class="hljs-number">20</span>     显示 <span class="hljs-number">1</span>.log 文件中前 <span class="hljs-number">20</span> 行<br><span class="hljs-attribute">head</span> <span class="hljs-number">1</span>.log -n -<span class="hljs-number">10</span>    显示 <span class="hljs-number">1</span>.log最后 <span class="hljs-number">10</span> 行<br></code></pre></td></tr></table></figure><h2 id="查找文件"><a href="#查找文件" class="headerlink" title="查找文件"></a>查找文件</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">which       查看可执行文件的位置。<br>whereis     查看文件的位置。<br>locate      配合数据库查看文件位置。<br><span class="hljs-built_in">find</span>        实际搜寻硬盘查询文件名称。<br></code></pre></td></tr></table></figure><h2 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h2><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">chmod <span class="hljs-number">751</span> t.<span class="hljs-built_in">log</span> -c   给<span class="hljs-built_in">file</span>的属主分配读、写、执行权限<br></code></pre></td></tr></table></figure><h2 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">tar</span> -cvf <span class="hljs-regexp">log.*</span>   将文件全部打包成 tar 包<br></code></pre></td></tr></table></figure><h2 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">ps</span> <span class="hljs-literal">-ef</span>     显示当前所有进程环境变量及进程间关系<br><span class="hljs-built_in">ps</span> <span class="hljs-literal">-A</span>      显示当前所有进程<br><br></code></pre></td></tr></table></figure><h2 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">kill</span> <span class="hljs-literal">-9</span> <span class="hljs-variable">$</span>(<span class="hljs-built_in">ps</span> <span class="hljs-literal">-ef</span> | grep pro1)  先使用<span class="hljs-built_in">ps</span>查找进程pro1，然后用<span class="hljs-built_in">kill</span>杀掉<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>命令</tag>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatisplus</title>
    <link href="/2023/12/10/mybatisplus/"/>
    <url>/2023/12/10/mybatisplus/</url>
    
    <content type="html"><![CDATA[<h3 id="初始sql文件"><a href="#初始sql文件" class="headerlink" title="初始sql文件"></a>初始sql文件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> Navicat Premium Data Transfer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Source Server         : 1</span><br><span class="hljs-comment"> Source Server Type    : MySQL</span><br><span class="hljs-comment"> Source Server Version : 50726 (5.7.26)</span><br><span class="hljs-comment"> Source Host           : localhost:3306</span><br><span class="hljs-comment"> Source Schema         : mp</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Target Server Type    : MySQL</span><br><span class="hljs-comment"> Target Server Version : 50726 (5.7.26)</span><br><span class="hljs-comment"> File Encoding         : 65001</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Date: 10/12/2023 22:07:14</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">SET</span> NAMES utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for address</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `address`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `address`  (<br>  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `user_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户ID&#x27;</span>,<br>  `province` <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;省&#x27;</span>,<br>  `city` <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;市&#x27;</span>,<br>  `town` <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;县/区&#x27;</span>,<br>  `mobile` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;手机&#x27;</span>,<br>  `street` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;详细地址&#x27;</span>,<br>  `contact` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;联系人&#x27;</span>,<br>  `is_default` bit(<span class="hljs-number">1</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> b<span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;是否是默认 1默认 0否&#x27;</span>,<br>  `notes` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;备注&#x27;</span>,<br>  `deleted` bit(<span class="hljs-number">1</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> b<span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;逻辑删除&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE,<br>  INDEX `user_id`(`user_id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE <span class="hljs-operator">=</span> InnoDB AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">71</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8_general_ci ROW_FORMAT <span class="hljs-operator">=</span> COMPACT;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of address</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">59</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;北京&#x27;</span>, <span class="hljs-string">&#x27;北京&#x27;</span>, <span class="hljs-string">&#x27;朝阳区&#x27;</span>, <span class="hljs-string">&#x27;13900112222&#x27;</span>, <span class="hljs-string">&#x27;金燕龙办公楼&#x27;</span>, <span class="hljs-string">&#x27;Rose&#x27;</span>, b<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">60</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;北京&#x27;</span>, <span class="hljs-string">&#x27;北京&#x27;</span>, <span class="hljs-string">&#x27;朝阳区&#x27;</span>, <span class="hljs-string">&#x27;13700221122&#x27;</span>, <span class="hljs-string">&#x27;修正大厦&#x27;</span>, <span class="hljs-string">&#x27;Jack&#x27;</span>, b<span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">61</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;上海&#x27;</span>, <span class="hljs-string">&#x27;上海&#x27;</span>, <span class="hljs-string">&#x27;浦东新区&#x27;</span>, <span class="hljs-string">&#x27;13301212233&#x27;</span>, <span class="hljs-string">&#x27;航头镇航头路&#x27;</span>, <span class="hljs-string">&#x27;Jack&#x27;</span>, b<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">63</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;广东&#x27;</span>, <span class="hljs-string">&#x27;佛山&#x27;</span>, <span class="hljs-string">&#x27;永春&#x27;</span>, <span class="hljs-string">&#x27;13301212233&#x27;</span>, <span class="hljs-string">&#x27;永春武馆&#x27;</span>, <span class="hljs-string">&#x27;Rose&#x27;</span>, b<span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">64</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;浙江&#x27;</span>, <span class="hljs-string">&#x27;杭州&#x27;</span>, <span class="hljs-string">&#x27;拱墅区&#x27;</span>, <span class="hljs-string">&#x27;13567809102&#x27;</span>, <span class="hljs-string">&#x27;浙江大学&#x27;</span>, <span class="hljs-string">&#x27;Hope&#x27;</span>, b<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">65</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;浙江&#x27;</span>, <span class="hljs-string">&#x27;杭州&#x27;</span>, <span class="hljs-string">&#x27;拱墅区&#x27;</span>, <span class="hljs-string">&#x27;13967589201&#x27;</span>, <span class="hljs-string">&#x27;左岸花园&#x27;</span>, <span class="hljs-string">&#x27;Hope&#x27;</span>, b<span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">66</span>, <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;湖北&#x27;</span>, <span class="hljs-string">&#x27;武汉&#x27;</span>, <span class="hljs-string">&#x27;汉口&#x27;</span>, <span class="hljs-string">&#x27;13967519202&#x27;</span>, <span class="hljs-string">&#x27;天天花园&#x27;</span>, <span class="hljs-string">&#x27;Thomas&#x27;</span>, b<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">67</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;浙江&#x27;</span>, <span class="hljs-string">&#x27;杭州&#x27;</span>, <span class="hljs-string">&#x27;拱墅区&#x27;</span>, <span class="hljs-string">&#x27;13967589201&#x27;</span>, <span class="hljs-string">&#x27;左岸花园&#x27;</span>, <span class="hljs-string">&#x27;Hopey&#x27;</span>, b<span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">68</span>, <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;湖北&#x27;</span>, <span class="hljs-string">&#x27;武汉&#x27;</span>, <span class="hljs-string">&#x27;汉口&#x27;</span>, <span class="hljs-string">&#x27;13967519202&#x27;</span>, <span class="hljs-string">&#x27;天天花园&#x27;</span>, <span class="hljs-string">&#x27;Thomas&#x27;</span>, b<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">69</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;浙江&#x27;</span>, <span class="hljs-string">&#x27;杭州&#x27;</span>, <span class="hljs-string">&#x27;拱墅区&#x27;</span>, <span class="hljs-string">&#x27;13967589201&#x27;</span>, <span class="hljs-string">&#x27;左岸花园&#x27;</span>, <span class="hljs-string">&#x27;Hopey&#x27;</span>, b<span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `address` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">70</span>, <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;湖北&#x27;</span>, <span class="hljs-string">&#x27;武汉&#x27;</span>, <span class="hljs-string">&#x27;汉口&#x27;</span>, <span class="hljs-string">&#x27;13967519202&#x27;</span>, <span class="hljs-string">&#x27;天天花园&#x27;</span>, <span class="hljs-string">&#x27;Thomas&#x27;</span>, b<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-keyword">NULL</span>, b<span class="hljs-string">&#x27;0&#x27;</span>);<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for user</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `<span class="hljs-keyword">user</span>`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>`  (<br>  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">19</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;用户id&#x27;</span>,<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户名&#x27;</span>,<br>  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;密码&#x27;</span>,<br>  `phone` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;注册手机号&#x27;</span>,<br>  `info` json <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;详细信息&#x27;</span>,<br>  `status` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span> COMMENT <span class="hljs-string">&#x27;使用状态（1正常 2冻结）&#x27;</span>,<br>  `balance` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;账户余额&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  `update_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">&#x27;更新时间&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE,<br>  <span class="hljs-keyword">UNIQUE</span> INDEX `username`(`username`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE <span class="hljs-operator">=</span> InnoDB AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">105</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8_general_ci COMMENT <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;用户表&#x27;</span> ROW_FORMAT <span class="hljs-operator">=</span> COMPACT;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of user</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;Jack&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13900112224&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 20, \&quot;intro\&quot;: \&quot;佛系青年\&quot;, \&quot;gender\&quot;: \&quot;male\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-05-19 20:50:21&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:49:35&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;Rose&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13900112223&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 19, \&quot;intro\&quot;: \&quot;青涩少女\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">797</span>, <span class="hljs-string">&#x27;2023-05-19 21:00:23&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 17:01:21&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;Hope&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13900112222&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 25, \&quot;intro\&quot;: \&quot;上进青年\&quot;, \&quot;gender\&quot;: \&quot;male\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">594</span>, <span class="hljs-string">&#x27;2023-06-19 22:37:44&#x27;</span>, <span class="hljs-string">&#x27;2023-10-13 21:11:31&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;Thomas&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;17701265258&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 29, \&quot;intro\&quot;: \&quot;伏地魔\&quot;, \&quot;gender\&quot;: \&quot;male\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">191</span>, <span class="hljs-string">&#x27;2023-06-19 23:44:45&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 17:01:21&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;user_1&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">6</span>, <span class="hljs-string">&#x27;user_2&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">7</span>, <span class="hljs-string">&#x27;user_3&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;user_4&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">9</span>, <span class="hljs-string">&#x27;user_5&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;user_6&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">11</span>, <span class="hljs-string">&#x27;user_7&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">12</span>, <span class="hljs-string">&#x27;user_8&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">13</span>, <span class="hljs-string">&#x27;user_9&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">14</span>, <span class="hljs-string">&#x27;user_10&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">15</span>, <span class="hljs-string">&#x27;user_11&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">16</span>, <span class="hljs-string">&#x27;user_12&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">17</span>, <span class="hljs-string">&#x27;user_13&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">18</span>, <span class="hljs-string">&#x27;user_14&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">19</span>, <span class="hljs-string">&#x27;user_15&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">20</span>, <span class="hljs-string">&#x27;user_16&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">21</span>, <span class="hljs-string">&#x27;user_17&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">22</span>, <span class="hljs-string">&#x27;user_18&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">23</span>, <span class="hljs-string">&#x27;user_19&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">24</span>, <span class="hljs-string">&#x27;user_20&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">25</span>, <span class="hljs-string">&#x27;user_21&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">26</span>, <span class="hljs-string">&#x27;user_22&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">27</span>, <span class="hljs-string">&#x27;user_23&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">28</span>, <span class="hljs-string">&#x27;user_24&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">29</span>, <span class="hljs-string">&#x27;user_25&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">30</span>, <span class="hljs-string">&#x27;user_26&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">31</span>, <span class="hljs-string">&#x27;user_27&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">32</span>, <span class="hljs-string">&#x27;user_28&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">33</span>, <span class="hljs-string">&#x27;user_29&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">34</span>, <span class="hljs-string">&#x27;user_30&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">35</span>, <span class="hljs-string">&#x27;user_31&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">36</span>, <span class="hljs-string">&#x27;user_32&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">37</span>, <span class="hljs-string">&#x27;user_33&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">38</span>, <span class="hljs-string">&#x27;user_34&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">39</span>, <span class="hljs-string">&#x27;user_35&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">40</span>, <span class="hljs-string">&#x27;user_36&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">41</span>, <span class="hljs-string">&#x27;user_37&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">42</span>, <span class="hljs-string">&#x27;user_38&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">43</span>, <span class="hljs-string">&#x27;user_39&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">44</span>, <span class="hljs-string">&#x27;user_40&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">45</span>, <span class="hljs-string">&#x27;user_41&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">46</span>, <span class="hljs-string">&#x27;user_42&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">47</span>, <span class="hljs-string">&#x27;user_43&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">48</span>, <span class="hljs-string">&#x27;user_44&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">49</span>, <span class="hljs-string">&#x27;user_45&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">50</span>, <span class="hljs-string">&#x27;user_46&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">51</span>, <span class="hljs-string">&#x27;user_47&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">52</span>, <span class="hljs-string">&#x27;user_48&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">53</span>, <span class="hljs-string">&#x27;user_49&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">54</span>, <span class="hljs-string">&#x27;user_50&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">55</span>, <span class="hljs-string">&#x27;user_51&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">56</span>, <span class="hljs-string">&#x27;user_52&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">57</span>, <span class="hljs-string">&#x27;user_53&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">58</span>, <span class="hljs-string">&#x27;user_54&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">59</span>, <span class="hljs-string">&#x27;user_55&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">60</span>, <span class="hljs-string">&#x27;user_56&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">61</span>, <span class="hljs-string">&#x27;user_57&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">62</span>, <span class="hljs-string">&#x27;user_58&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">63</span>, <span class="hljs-string">&#x27;user_59&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">64</span>, <span class="hljs-string">&#x27;user_60&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">65</span>, <span class="hljs-string">&#x27;user_61&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">66</span>, <span class="hljs-string">&#x27;user_62&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">67</span>, <span class="hljs-string">&#x27;user_63&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">68</span>, <span class="hljs-string">&#x27;user_64&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">69</span>, <span class="hljs-string">&#x27;user_65&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">70</span>, <span class="hljs-string">&#x27;user_66&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">71</span>, <span class="hljs-string">&#x27;user_67&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">72</span>, <span class="hljs-string">&#x27;user_68&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">73</span>, <span class="hljs-string">&#x27;user_69&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">74</span>, <span class="hljs-string">&#x27;user_70&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">75</span>, <span class="hljs-string">&#x27;user_71&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">76</span>, <span class="hljs-string">&#x27;user_72&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">77</span>, <span class="hljs-string">&#x27;user_73&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">78</span>, <span class="hljs-string">&#x27;user_74&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">79</span>, <span class="hljs-string">&#x27;user_75&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">80</span>, <span class="hljs-string">&#x27;user_76&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">81</span>, <span class="hljs-string">&#x27;user_77&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">82</span>, <span class="hljs-string">&#x27;user_78&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">83</span>, <span class="hljs-string">&#x27;user_79&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">84</span>, <span class="hljs-string">&#x27;user_80&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">85</span>, <span class="hljs-string">&#x27;user_81&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">86</span>, <span class="hljs-string">&#x27;user_82&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">87</span>, <span class="hljs-string">&#x27;user_83&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">88</span>, <span class="hljs-string">&#x27;user_84&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">89</span>, <span class="hljs-string">&#x27;user_85&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">90</span>, <span class="hljs-string">&#x27;user_86&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">91</span>, <span class="hljs-string">&#x27;user_87&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">92</span>, <span class="hljs-string">&#x27;user_88&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">93</span>, <span class="hljs-string">&#x27;user_89&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">94</span>, <span class="hljs-string">&#x27;user_90&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">95</span>, <span class="hljs-string">&#x27;user_91&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">96</span>, <span class="hljs-string">&#x27;user_92&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">97</span>, <span class="hljs-string">&#x27;user_93&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">98</span>, <span class="hljs-string">&#x27;user_94&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">99</span>, <span class="hljs-string">&#x27;user_95&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">100</span>, <span class="hljs-string">&#x27;user_96&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">101</span>, <span class="hljs-string">&#x27;user_97&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">102</span>, <span class="hljs-string">&#x27;user_98&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">103</span>, <span class="hljs-string">&#x27;user_99&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">104</span>, <span class="hljs-string">&#x27;user_100&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;13583916321&#x27;</span>, <span class="hljs-string">&#x27;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>, <span class="hljs-string">&#x27;2023-10-14 21:22:08&#x27;</span>);<br><br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br></code></pre></td></tr></table></figure><h3 id="引入MP依赖"><a href="#引入MP依赖" class="headerlink" title="引入MP依赖"></a>引入MP依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>mapper接口继承BaseMapper接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;User&gt; &#123;<br></code></pre></td></tr></table></figure><h3 id="测试CRUD功能"><a href="#测试CRUD功能" class="headerlink" title="测试CRUD功能"></a>测试CRUD功能</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MpDemoApplicationTests</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-comment">// C</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testC</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setId(<span class="hljs-number">5L</span>);<br>        user.setUsername(<span class="hljs-string">&quot;Tom&quot;</span>);<br>        user.setPassword(<span class="hljs-string">&quot;123&quot;</span>);<br>        user.setPhone(<span class="hljs-string">&quot;13583961238&quot;</span>);<br>        user.setInfo(<span class="hljs-string">&quot;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&quot;</span>);<br>        user.setStatus(<span class="hljs-number">1</span>);<br>        user.setBalance(<span class="hljs-number">994</span>);<br>        user.setCreateTime(LocalDateTime.now());<br>        user.setUpdateTime(LocalDateTime.now());<br>        userMapper.insert(user);<br>    &#125;<br><br>    <span class="hljs-comment">// R</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testR</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">5L</span>);<br>        System.out.println(user);<br>    &#125;<br><br>    <span class="hljs-comment">// Rs</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRs</span><span class="hljs-params">()</span> &#123;<br>        List&lt;User&gt; users = userMapper.selectBatchIds(List.of(<span class="hljs-string">&quot;1L&quot;</span>, <span class="hljs-string">&quot;2L&quot;</span>, <span class="hljs-string">&quot;3L&quot;</span>, <span class="hljs-string">&quot;4L&quot;</span>, <span class="hljs-string">&quot;5L&quot;</span>));<br>        users.forEach(System.out::println);<br>    &#125;<br><br>    <span class="hljs-comment">// U</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testU</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setId(<span class="hljs-number">5L</span>).setPhone(<span class="hljs-string">&quot;110&quot;</span>);<br>        userMapper.updateById(user);<br>    &#125;<br><br>    <span class="hljs-comment">// D</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testD</span><span class="hljs-params">()</span> &#123;<br>        userMapper.deleteById(<span class="hljs-number">5L</span>);<br>    &#125;<br><br>    <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="原理探究"><a href="#原理探究" class="headerlink" title="原理探究"></a>原理探究</h3><p>MP怎么知道我们要查哪张表， 表中有哪些字段？</p><p>userMapper继承BaseMapper<User> ，这里的泛型里的User是与数据库对应的PO，MP根据PO推断表的信息，从而生成SQL。</p><p>这里MP有一些默认的配置：</p><ol><li>把PO实体的类名<strong>驼峰转下划线</strong>作为表名 </li><li>把PO实体的所有变量名<strong>驼峰转下划线</strong>作为表的字段名，根据变量类型推断字段类型</li><li>把名为id的字段作为主键</li></ol><p>我们可以根据实际情况自定义：</p><p>@TableName，标明实体类对应的表名</p><p>@TableId, 标明实体类的主键字段，可以指定主键类型，AUTO（自增长），INPUT（手动生成），ASSIGN_ID（雪花算法）</p><p>@TableField，普通字段注解，指定变量名保证和数据库一致，这种情况并不多，多数是因为成员变量是以<code>isXXX</code>命名导致被MP识别并去除is，或变量名使用了数据库的关键字</p><h3 id="MP的yml配置"><a href="#MP的yml配置" class="headerlink" title="MP的yml配置"></a>MP的yml配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/*.xml</span>       <span class="hljs-comment"># mapper xml位置， 这个是默认值</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.itheima.mp.domain.po</span>  <span class="hljs-comment"># 实体类的别名扫描包</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">db-config:</span><br>      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>   <span class="hljs-comment"># 全局id类型自增</span><br></code></pre></td></tr></table></figure><p>关于xml</p><p>我们在指定位置和Mybatis一样的套路写好xml即可运行</p><h3 id="条件构造器"><a href="#条件构造器" class="headerlink" title="条件构造器"></a>条件构造器</h3><p>BaseMapper里默认的查询条件只有id，其他条件需要我们去构造，用到条件构造器 Wrapper</p><h3 id="QueryWrapper"><a href="#QueryWrapper" class="headerlink" title="QueryWrapper"></a>QueryWrapper</h3><p>可以为修改 删除 查询构造条件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 查询出名字中带o的，存款大于等于1000元的人</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testQueryWrapper</span><span class="hljs-params">()</span> &#123;<br>    QueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;User&gt;()<br>            .like(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;o&quot;</span>)<br>            .ge(<span class="hljs-string">&quot;balance&quot;</span>, <span class="hljs-number">1000</span>);<br>    userMapper.selectList(wrapper).forEach(System.out::println);<br>&#125;<br><br><span class="hljs-comment">// 更新用户名为jack的用户的余额为2000</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testQeruyWrapper1</span><span class="hljs-params">()</span> &#123;<br>    QueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;User&gt;()<br>            .eq(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;jack&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>().setBalance(<span class="hljs-number">2000</span>);<br>    userMapper.update(user, wrapper);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="UpdateWrapper"><a href="#UpdateWrapper" class="headerlink" title="UpdateWrapper"></a><strong>UpdateWrapper</strong></h3><p>提供setSql方法用于改变字段现有值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 更新id为1,2,4的用户的余额，扣200</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdateWrapper</span><span class="hljs-params">()</span> &#123;<br>    UpdateWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateWrapper</span>&lt;User&gt;()<br>            .setSql(<span class="hljs-string">&quot;balance = balance - 1&quot;</span>)<br>            .in(<span class="hljs-string">&quot;id&quot;</span>, List.of(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">4L</span>));<br>    userMapper.update(<span class="hljs-literal">null</span>, wrapper);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="LambdaQueryWrapper"><a href="#LambdaQueryWrapper" class="headerlink" title="LambdaQueryWrapper"></a><strong>LambdaQueryWrapper</strong></h3><p>避免Wrapper在构造条件的时候都需要写死字段名称</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 构建条件 WHERE username LIKE &quot;%o%&quot; AND balance &gt;= 1000</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testLambdaQueryWrapper</span><span class="hljs-params">()</span> &#123;<br>    LambdaQueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;User&gt;()<br>            .like(User::getUsername, <span class="hljs-string">&quot;o&quot;</span>)<br>            .ge(User::getBalance, <span class="hljs-number">1000</span>);<br>    userMapper.selectList(wrapper).forEach(System.out::println);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="自定义SQL"><a href="#自定义SQL" class="headerlink" title="自定义SQL"></a>自定义SQL</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">UpdateWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateWrapper</span>&lt;User&gt;()<br>            .setSql(<span class="hljs-string">&quot;balance = balance - 1&quot;</span>)<br>            .in(<span class="hljs-string">&quot;id&quot;</span>, List.of(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">4L</span>));<br></code></pre></td></tr></table></figure><p>这里的setSql不利于维护，可以结合SQL语句来写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testCustomWrapper</span><span class="hljs-params">()</span> &#123;<br>    UpdateWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateWrapper</span>&lt;User&gt;()<br>            .in(<span class="hljs-string">&quot;id&quot;</span>, List.of(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">4L</span>));<br>    userMapper.deductBalanceByIds(<span class="hljs-number">200</span>, wrapper);<br>&#125;<br></code></pre></td></tr></table></figure><p>注意符号和关键字拼写错误</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Select(&quot;Update user set balance = balance - #&#123;money&#125; $&#123;ew.customSqlSegment&#125;&quot;)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">deductBalanceByIds</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;money&quot;)</span> <span class="hljs-type">int</span> i, <span class="hljs-meta">@Param(&quot;ew&quot;)</span> UpdateWrapper&lt;User&gt; wrapper)</span>;<br></code></pre></td></tr></table></figure><h3 id="多表关联构造条件"><a href="#多表关联构造条件" class="headerlink" title="多表关联构造条件"></a>多表关联构造条件</h3><p>Mybatis中需要用动态SQL实现</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs XML"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;queryUserByIdAndAddr&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.itheima.mp.domain.po.User&quot;</span>&gt;</span><br>      SELECT *<br>      FROM user u<br>      INNER JOIN address a ON u.id = a.user_id<br>      WHERE u.id<br>      <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;ids&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">open</span>=<span class="hljs-string">&quot;IN (&quot;</span> <span class="hljs-attr">close</span>=<span class="hljs-string">&quot;)&quot;</span>&gt;</span><br>          #&#123;id&#125;<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br>      AND a.city = #&#123;city&#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><p>我们可以手动构造foreach中的条件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// SELECT * FROM user u INNER JOIN address a ON u.id = a.user_id</span><br><span class="hljs-comment">// WHERE u.id in (1, 2, 3, 4) AND a.city =</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testJoin</span><span class="hljs-params">()</span> &#123;<br>    QueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;User&gt;()<br>            .in(<span class="hljs-string">&quot;u.id&quot;</span>, List.of(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">3L</span>, <span class="hljs-number">4L</span>))<br>            .eq(<span class="hljs-string">&quot;a.city&quot;</span>, <span class="hljs-string">&quot;北京&quot;</span>);<br>    List&lt;User&gt; list = userMapper.selectByUserAndAddress(wrapper);<br>    list.forEach(System.out::println);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Select(&quot;select * from user u INNER JOIN address a ON u.id = a.user_id $&#123;ew.customSqlSegment&#125;&quot;)</span>  <span class="hljs-comment">// 这里的报错忽略不计</span><br>List&lt;User&gt; <span class="hljs-title function_">selectByUserAndAddress</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;ew&quot;)</span> QueryWrapper&lt;User&gt; wrapper)</span>;<br></code></pre></td></tr></table></figure><h3 id="Service接口"><a href="#Service接口" class="headerlink" title="Service接口"></a>Service接口</h3><p>格式： 接口继承IService&lt;po类&gt;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;User&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>接口实现类继承ServiceImpl&lt;mapper接口, po类&gt; 实现 IUserService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserService</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th align="center"><strong>编号</strong></th><th align="center"><strong>接口</strong></th><th align="center"><strong>请求方式</strong></th><th align="center"><strong>请求路径</strong></th><th align="center"><strong>请求参数</strong></th><th align="center"><strong>返回值</strong></th></tr></thead><tbody><tr><td align="center">1</td><td align="center">新增用户</td><td align="center">POST</td><td align="center">&#x2F;users</td><td align="center">用户表单实体</td><td align="center">无</td></tr><tr><td align="center">2</td><td align="center">删除用户</td><td align="center">DELETE</td><td align="center">&#x2F;users&#x2F;{id}</td><td align="center">用户id</td><td align="center">无</td></tr><tr><td align="center">3</td><td align="center">根据id查询用户</td><td align="center">GET</td><td align="center">&#x2F;users&#x2F;{id}</td><td align="center">用户id</td><td align="center">用户VO</td></tr><tr><td align="center">4</td><td align="center">根据id批量查询</td><td align="center">GET</td><td align="center">&#x2F;users</td><td align="center">用户id集合</td><td align="center">用户VO集合</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping</span><br><span class="hljs-meta">@ApiOperation(&quot;新增用户&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">newUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserVO userFormDTO)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(userFormDTO, User.class);<br>    userService.save(user);<br>&#125;<br><br><span class="hljs-meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@ApiModelProperty(&quot;删除用户&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> &#123;<br>    userService.removeById(id);<br>&#125;<br><br><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@ApiModelProperty(&quot;根据id查找用户&quot;)</span><br><span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getById(id);<br>    <span class="hljs-keyword">return</span> BeanUtil.copyProperties(user, UserVO.class);<br>&#125;<br><br><span class="hljs-meta">@GetMapping</span><br><span class="hljs-meta">@ApiModelProperty(&quot;根据id集合查找用户&quot;)</span><br><span class="hljs-keyword">public</span> List&lt;UserVO&gt; <span class="hljs-title function_">getUserByIds</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> List&lt;String&gt; ids)</span> &#123;<br>    <span class="hljs-comment">// 1.ids查到所有用户</span><br>    List&lt;User&gt; userList = userService.listByIds(ids);<br>    <span class="hljs-comment">// 2. 把用户转为VO, 返回</span><br>    <span class="hljs-keyword">return</span> BeanUtil.copyToList(userList, UserVO.class);<br>&#125;<br></code></pre></td></tr></table></figure><p>简单的业务可以在controller直接实现, 复杂的业务还是要在service实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PutMapping(&quot;/&#123;id&#125;/deduction/&#123;money&#125;&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;扣减用户余额&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deductionOfUserBalance</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id, <span class="hljs-meta">@PathVariable</span> String money)</span> &#123;<br>    userService.deductionOfUserBalance(id, money);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deductionOfUserBalance</span><span class="hljs-params">(String id, String money)</span> &#123;<br>    <span class="hljs-comment">// 1.查询用户</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-comment">// 2.判断用户状态</span><br>    <span class="hljs-keyword">if</span> (ObjectUtil.isEmpty(user) || user.getStatus() == <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;用户不存在或者用户被冻结&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.判断用户余额</span><br>    <span class="hljs-keyword">if</span> (user.getBalance() &lt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;用户余额不足&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 4.扣减余额</span><br>    <span class="hljs-comment">// update user set balance = balance - 2 where id = 1;</span><br>    UpdateChainWrapper&lt;User&gt; wrapper = <span class="hljs-built_in">this</span>.update()<br>            .setSql(<span class="hljs-string">&quot;balance = balance - &quot;</span> + money)<br>            .eq(<span class="hljs-string">&quot;id&quot;</span>, id);<br>    wrapper.update();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h3><p>避免query手写wrapper的表字段, 使用反射的::getXxx方法引用</p><p>定义一个查询条件实体, 方便接收数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.itheima.mp.domain.query;<br><br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(description = &quot;用户查询条件实体&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserQuery</span> &#123;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;用户名关键字&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;用户状态：1-正常，2-冻结&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer status;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;余额最小值&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer minBalance;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;余额最大值&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer maxBalance;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;根据id集合查询用户&quot;)</span><br><span class="hljs-keyword">public</span> List&lt;UserVO&gt; <span class="hljs-title function_">queryUsers</span><span class="hljs-params">(UserQuery query)</span>&#123;<br>    <span class="hljs-comment">// 1.组织条件</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> query.getName();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> query.getStatus();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">minBalance</span> <span class="hljs-operator">=</span> query.getMinBalance();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">maxBalance</span> <span class="hljs-operator">=</span> query.getMaxBalance();<br>    LambdaQueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;User&gt;().lambda()<br>            .like(username != <span class="hljs-literal">null</span>, User::getUsername, username)<br>            .eq(status != <span class="hljs-literal">null</span>, User::getStatus, status)<br>            .ge(minBalance != <span class="hljs-literal">null</span>, User::getBalance, minBalance)<br>            .le(maxBalance != <span class="hljs-literal">null</span>, User::getBalance, maxBalance);<br>    <span class="hljs-comment">// 2.查询用户</span><br>    List&lt;User&gt; users = userService.list(wrapper);<br>    <span class="hljs-comment">// 3.处理vo</span><br>    <span class="hljs-keyword">return</span> BeanUtil.copyToList(users, UserVO.class);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;根据id集合查询用户&quot;)</span><br><span class="hljs-keyword">public</span> List&lt;UserVO&gt; <span class="hljs-title function_">queryUsers</span><span class="hljs-params">(UserQuery query)</span>&#123;<br>    <span class="hljs-comment">// 1.组织条件</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> query.getName();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> query.getStatus();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">minBalance</span> <span class="hljs-operator">=</span> query.getMinBalance();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">maxBalance</span> <span class="hljs-operator">=</span> query.getMaxBalance();<br>    <span class="hljs-comment">// 2.查询用户</span><br>    List&lt;User&gt; users = userService.lambdaQuery()<br>            .like(username != <span class="hljs-literal">null</span>, User::getUsername, username)<br>            .eq(status != <span class="hljs-literal">null</span>, User::getStatus, status)<br>            .ge(minBalance != <span class="hljs-literal">null</span>, User::getBalance, minBalance)<br>            .le(maxBalance != <span class="hljs-literal">null</span>, User::getBalance, maxBalance)<br>            .list();<br>    <span class="hljs-comment">// 3.处理vo</span><br>    <span class="hljs-keyword">return</span> BeanUtil.copyToList(users, UserVO.class);<br>&#125;<br></code></pre></td></tr></table></figure><p>改造根据id修改用户余额的接口，要求如下</p><ul><li>如果扣减后余额为0，则将用户status修改为冻结状态（2）</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deductBalance</span><span class="hljs-params">(Long id, Integer money)</span> &#123;<br>    <span class="hljs-comment">// 1.查询用户</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-comment">// 2.校验用户状态</span><br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.getStatus() == <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;用户状态异常！&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.校验余额是否充足</span><br>    <span class="hljs-keyword">if</span> (user.getBalance() &lt; money) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;用户余额不足！&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 4.扣减余额 update tb_user set balance = balance - ?</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">remainBalance</span> <span class="hljs-operator">=</span> user.getBalance() - money;<br>    lambdaUpdate()<br>            .set(User::getBalance, remainBalance) <span class="hljs-comment">// 更新余额</span><br>            .set(remainBalance == <span class="hljs-number">0</span>, User::getStatus, <span class="hljs-number">2</span>) <span class="hljs-comment">// 动态判断，是否更新status</span><br>            .eq(User::getId, id)<br>            .eq(User::getBalance, user.getBalance()) <span class="hljs-comment">// 乐观锁</span><br>            .update();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="批量新增"><a href="#批量新增" class="headerlink" title="批量新增"></a>批量新增</h3><p>MP的批量新增是逐条的性能10倍</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testSaveOneByOne</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) &#123;<br>        userService.save(buildUser(i));<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> User <span class="hljs-title function_">buildUser</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user.setUsername(<span class="hljs-string">&quot;user_&quot;</span> + i)<br>            .setPassword(<span class="hljs-string">&quot;123&quot;</span>)<br>            .setPhone(<span class="hljs-string">&quot;13583916321&quot;</span>)<br>            .setBalance(<span class="hljs-number">2000</span>)<br>            .setInfo(<span class="hljs-string">&quot;&#123;\&quot;age\&quot;: 24, \&quot;intro\&quot;: \&quot;英文老师\&quot;, \&quot;gender\&quot;: \&quot;female\&quot;&#125;&quot;</span>)<br>            .setCreateTime(LocalDateTime.now())<br>            .setUpdateTime(LocalDateTime.now());<br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testSaveBatch</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 准备数据</span><br>    List&lt;User&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">100</span>; i++) &#123;<br>        list.add(buildUser(i));<br>    &#125;<br>    userService.saveBatch(list);<br>    <span class="hljs-type">long</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;耗时：&quot;</span> + (e - b));<br>&#125;<br></code></pre></td></tr></table></figure><p>我们想要实现最佳性能, 允许MP修改SQL代码(把多条SQL语句合并)</p><p>更改yml</p><p>在jdbc的url后面添加参数<code>&amp;rewriteBatchedStatements=true</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/mp?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai&amp;rewriteBatchedStatements=true</span><br></code></pre></td></tr></table></figure><h3 id="代码生成器"><a href="#代码生成器" class="headerlink" title="代码生成器"></a>代码生成器</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231014212956040.png" alt="image-20231014212956040"></p><h3 id="静态工具-Db"><a href="#静态工具-Db" class="headerlink" title="静态工具 Db"></a>静态工具 Db</h3><p>避免service互相调用导致<strong>循环依赖</strong>问题 MP提供了Db静态工具类, 用它也可以实现CRUD功能</p><p>循环依赖, 在service里注入另一个service是不可取的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Db简单查询</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testDbGet</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> Db.getById(<span class="hljs-number">1</span>, User.class);<br>    System.out.println(user);<br>&#125;<br><br><span class="hljs-comment">// Db复杂查询</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testDbList</span><span class="hljs-params">()</span> &#123;<br>    Db.lambdaQuery(User.class)<br>            .like(User::getUsername, <span class="hljs-string">&quot;o&quot;</span>)<br>            .eq(User::getBalance, <span class="hljs-number">797</span>)<br>            .list().forEach(System.out::println);<br>&#125;<br><br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testDbUpdate</span><span class="hljs-params">()</span> &#123;<br>    Db.lambdaUpdate(User.class)<br>            .set(User::getBalance, <span class="hljs-number">2000</span>)<br>            .eq(User::getId, <span class="hljs-number">1</span>)<br>            .update();<br>&#125;<br></code></pre></td></tr></table></figure><p>改造根据id用户查询的接口，查询用户的同时返回用户收货地址列表</p><p>添加一个收货地址的VO对象,用于合并到UserVO里一起返回</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.itheima.mp.domain.vo;<br><br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(description = &quot;收货地址VO&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddressVO</span>&#123;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;用户ID&quot;)</span><br>    <span class="hljs-keyword">private</span> Long userId;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;省&quot;)</span><br>    <span class="hljs-keyword">private</span> String province;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;市&quot;)</span><br>    <span class="hljs-keyword">private</span> String city;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;县/区&quot;)</span><br>    <span class="hljs-keyword">private</span> String town;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;手机&quot;)</span><br>    <span class="hljs-keyword">private</span> String mobile;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;详细地址&quot;)</span><br>    <span class="hljs-keyword">private</span> String street;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;联系人&quot;)</span><br>    <span class="hljs-keyword">private</span> String contact;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;是否是默认 1默认 0否&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isDefault;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;备注&quot;)</span><br>    <span class="hljs-keyword">private</span> String notes;<br>&#125;<br></code></pre></td></tr></table></figure><p>在UserVO里面加addresses</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(description = &quot;用户VO实体&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserVO</span> &#123;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;用户id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;用户名&quot;)</span><br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;详细信息&quot;)</span><br>    <span class="hljs-keyword">private</span> String info;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;使用状态（1正常 2冻结）&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer status;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;账户余额&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer balance;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;收货地址列表&quot;)</span><br>    <span class="hljs-keyword">private</span> List&lt;AddressVO&gt; addresses;<br>&#125;<br></code></pre></td></tr></table></figure><p>在查询地址时，我们采用了Db的静态方法，因此避免了注入AddressService，减少了循环依赖的风险。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">queryUserAndAddressById</span><span class="hljs-params">(Long userId)</span> &#123;<br>    <span class="hljs-comment">// 1.查询用户</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getById(userId);<br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 2.查询收货地址</span><br>    List&lt;Address&gt; addresses = Db.lambdaQuery(Address.class)<br>            .eq(Address::getUserId, userId)<br>            .list();<br>    <span class="hljs-comment">// 3.处理vo</span><br>    <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(user, UserVO.class);<br>    userVO.setAddresses(BeanUtil.copyToList(addresses, AddressVO.class));<br>    <span class="hljs-keyword">return</span> userVO;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="逻辑删除"><a href="#逻辑删除" class="headerlink" title="逻辑删除"></a>逻辑删除</h3><p>一些数据我们不能删除, 放到库里面备份, 逻辑删除不是真正的删除, 而是不会查到</p><p><strong>注意</strong>，只有MybatisPlus生成的SQL语句才支持自动的逻辑删除，自定义SQL需要自己手动处理逻辑删除。</p><p>数据库加逻辑删除字段 deleted {0:存在, 1:删除}</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> address <span class="hljs-keyword">add</span> deleted bit <span class="hljs-keyword">default</span> b<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;逻辑删除&#x27;</span>;<br></code></pre></td></tr></table></figure><p>Address实体类加逻辑删除字段</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 逻辑删除</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> Boolean deleted;<br></code></pre></td></tr></table></figure><p>配置yml逻辑删除</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs YAML"><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">db-config:</span><br>      <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">deleted</span> <span class="hljs-comment"># 全局逻辑删除的实体字段名(since 3.3.0,配置后可以忽略不配置步骤2)</span><br>      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 逻辑已删除值(默认为 1)</span><br>      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span> <span class="hljs-comment"># 逻辑未删除值(默认为 0)</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 逻辑删除</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testLogicDelete</span><span class="hljs-params">()</span> &#123;<br>    Db.removeById(<span class="hljs-number">59</span>, Address.class);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="通用枚举"><a href="#通用枚举" class="headerlink" title="通用枚举"></a>通用枚举</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 使用状态（1正常 2冻结）</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> Integer status;<br></code></pre></td></tr></table></figure><p>像这种绝对的值, 我们定义一个枚举用于业务判断比较方便, MP可以方便的转换数据库类型和枚举类型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Getter</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">UserStatus</span> &#123;<br>    NORMAL(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;正常&quot;</span>), FREEZE(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;冻结&quot;</span>);<br>    <span class="hljs-meta">@EnumValue</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> value;<br>    <span class="hljs-meta">@JsonValue</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改User po类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 使用状态（1正常 2冻结）</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> UserStatus status;<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs YAML"><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">default-enum-type-handler:</span> <span class="hljs-string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testService</span><span class="hljs-params">()</span> &#123;<br>    List&lt;User&gt; list = userService.list();<br>    list.forEach(System.out::println);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231014222555980.png" alt="image-20231014222555980"></p><hr><h3 id="分页插件"><a href="#分页插件" class="headerlink" title="分页插件"></a>分页插件</h3><p>定义config</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 初始化核心插件</span><br>        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();<br>        <span class="hljs-comment">// 添加分页插件</span><br>        interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));<br>        <span class="hljs-keyword">return</span> interceptor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 分页</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testPageQuery</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.分页查询,new Page()的两个参数: 页码, 每页大小</span><br>    Page&lt;User&gt; page = userService.page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>));<br>    <span class="hljs-comment">// 2.总条数</span><br>    System.out.println(<span class="hljs-string">&quot;总条数: &quot;</span> + page.getTotal());<br>    <span class="hljs-comment">// 3.总页数</span><br>    System.out.println(<span class="hljs-string">&quot;总页数: &quot;</span> + page.getPages());<br>    <span class="hljs-comment">// 4.数据</span><br>    page.getRecords().forEach(System.out::println);<br>&#125;<br><br><span class="hljs-comment">// 自定义分页参数</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">customPagingParameters</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 按照balance升序</span><br>    Page&lt;User&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;User&gt;(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>).addOrder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(<span class="hljs-string">&quot;balance&quot;</span>, <span class="hljs-literal">true</span>));<br>    userService.page(page);<br>    page.getRecords().forEach(System.out::println);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="通用分页实体"><a href="#通用分页实体" class="headerlink" title="通用分页实体"></a>通用分页实体</h3><p>实现一个用户分页查询的接口</p><table><thead><tr><th><strong>参数</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>请求方式</td><td>GET</td></tr><tr><td>请求路径</td><td>&#x2F;users&#x2F;page</td></tr><tr><td>请求参数</td><td><code>&#123;    &quot;pageNo&quot;: 1,    &quot;pageSize&quot;: 5,    &quot;sortBy&quot;: &quot;balance&quot;,    &quot;isAsc&quot;: false,    &quot;name&quot;: &quot;o&quot;,    &quot;status&quot;: 1 &#125;</code></td></tr><tr><td>返回值</td><td><code>&#123;    &quot;total&quot;: 100006,    &quot;pages&quot;: 50003,    &quot;list&quot;: [        &#123;            &quot;id&quot;: 1685100878975279298,            &quot;username&quot;: &quot;user_9****&quot;,            &quot;info&quot;: &#123;                &quot;age&quot;: 24,                &quot;intro&quot;: &quot;英文老师&quot;,                &quot;gender&quot;: &quot;female&quot;            &#125;,            &quot;status&quot;: &quot;正常&quot;,            &quot;balance&quot;: 2000        &#125;    ] &#125;</code></td></tr><tr><td>特殊说明</td><td>如果排序字段为空，默认按照更新时间排序排序字段不为空，则按照排序字段排序</td></tr></tbody></table><ul><li><p><code>UserQuery</code>：分页查询条件的实体，包含分页、排序参数、过滤条件</p></li><li><p><code>PageDTO</code>：分页结果实体，包含总条数、总页数、当前页数据</p></li><li><p><code>UserVO</code>：用户页面视图实体</p></li><li><p><code>pageQuery</code>: 前端提交的查询参数</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(description = &quot;分页查询实体&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PageQuery</span> &#123;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;页码&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer pageNo;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;页码&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer pageSize;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;排序字段&quot;)</span><br>    <span class="hljs-keyword">private</span> String sortBy;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;是否升序&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isAsc;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserQuery</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PageQuery</span> &#123;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(description = &quot;分页结果&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PageDTO</span>&lt;T&gt; &#123;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;总条数&quot;)</span><br>    <span class="hljs-keyword">private</span> Long total;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;总页数&quot;)</span><br>    <span class="hljs-keyword">private</span> Long pages;<br>    <span class="hljs-meta">@ApiModelProperty(&quot;集合&quot;)</span><br>    <span class="hljs-keyword">private</span> List&lt;T&gt; list;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PageDTO&lt;UserVO&gt; <span class="hljs-title function_">queryUsersPage</span><span class="hljs-params">(PageQuery query)</span> &#123;<br>    <span class="hljs-comment">// 1.构建条件</span><br>    <span class="hljs-comment">// 1.1.分页条件</span><br>    Page&lt;User&gt; page = Page.of(query.getPageNo(), query.getPageSize());<br>    <span class="hljs-comment">// 1.2.排序条件</span><br>    <span class="hljs-keyword">if</span> (query.getSortBy() != <span class="hljs-literal">null</span>) &#123;<br>        page.addOrder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(query.getSortBy(), query.getIsAsc()));<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-comment">// 默认按照更新时间排序</span><br>        page.addOrder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(<span class="hljs-string">&quot;update_time&quot;</span>, <span class="hljs-literal">false</span>));<br>    &#125;<br>    <span class="hljs-comment">// 2.查询</span><br>    page(page);<br>    <span class="hljs-comment">// 3.数据非空校验</span><br>    List&lt;User&gt; records = page.getRecords();<br>    <span class="hljs-keyword">if</span> (records == <span class="hljs-literal">null</span> || records.size() &lt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// 无数据，返回空结果</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageDTO</span>&lt;&gt;(page.getTotal(), page.getPages(), Collections.emptyList());<br>    &#125;<br>    <span class="hljs-comment">// 4.有数据，转换</span><br>    List&lt;UserVO&gt; list = BeanUtil.copyToList(records, UserVO.class);<br>    <span class="hljs-comment">// 5.封装返回</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageDTO</span>&lt;UserVO&gt;(page.getTotal(), page.getPages(), list);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="添加个进阶玩法"><a href="#添加个进阶玩法" class="headerlink" title="添加个进阶玩法"></a>添加个进阶玩法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 根据用户id查询用户</span><br>List&lt;UserDTO&gt; userDTOS = userService.query()<br>        .in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;ORDER BY FIELD(id, &quot;</span> + idStr + <span class="hljs-string">&quot;)&quot;</span>).list()<br>        .stream()<br>        .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))<br>        .collect(Collectors.toList());<br></code></pre></td></tr></table></figure><p>使用userService.query()方法创建了一个查询条件，其中ids是一个用户ID的集合，idStr是一个用户ID的字符串，用于拼接IN查询条件。last(“ORDER BY FIELD(id, “ + idStr + “)”)表示在查询结果中按照用户ID进行排序。</p><hr><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">SELECT * FROM <span class="hljs-keyword">user</span> <span class="hljs-title">WHERE</span> id <span class="hljs-keyword">IN</span> (ids) <span class="hljs-keyword">ORDER</span> <span class="hljs-title">BY</span> FIELD(id, idStr);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mp</tag>
      
      <tag>mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>动态sql</title>
    <link href="/2023/12/10/%E5%8A%A8%E6%80%81sql/"/>
    <url>/2023/12/10/%E5%8A%A8%E6%80%81sql/</url>
    
    <content type="html"><![CDATA[<blockquote><p>根据不同条件拼接SQL语句</p></blockquote><h2 id="if"><a href="#if" class="headerlink" title="if"></a>if</h2><p><code>注意: test是if的条件, and, 不用跟逗号</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;select id=<span class="hljs-string">&quot;list&quot;</span> parameterType=<span class="hljs-string">&quot;com.sky.entity.AddressBook&quot;</span> resultType=<span class="hljs-string">&quot;com.sky.entity.AddressBook&quot;</span>&gt;<br>        select * from address_book<br>        &lt;where&gt;<br>            &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">&quot;userId != null&quot;</span>&gt;<br>                <span class="hljs-type">and</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> #&#123;userId&#125;<br>            &lt;/<span class="hljs-keyword">if</span>&gt;<br>            &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">&quot;phone != null&quot;</span>&gt;<br>                <span class="hljs-type">and</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> #&#123;phone&#125;<br>            &lt;/<span class="hljs-keyword">if</span>&gt;<br>            &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">&quot;isDefault != null&quot;</span>&gt;<br>                <span class="hljs-type">and</span> <span class="hljs-variable">is_default</span> <span class="hljs-operator">=</span> #&#123;isDefault&#125;<br>            &lt;/<span class="hljs-keyword">if</span>&gt;<br>        &lt;/where&gt;<br>    &lt;/select&gt;<br></code></pre></td></tr></table></figure><p><code>跟逗号 不要漏了最后的 where 条件</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.entity.AddressBook&quot;</span>&gt;</span><br>        update address_book<br>        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;consignee != null&quot;</span>&gt;</span><br>                consignee = #&#123;consignee&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;sex != null&quot;</span>&gt;</span><br>                sex = #&#123;sex&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phone != null&quot;</span>&gt;</span><br>                phone = #&#123;phone&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;detail != null&quot;</span>&gt;</span><br>                detail = #&#123;detail&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;label != null&quot;</span>&gt;</span><br>                label = #&#123;label&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;isDefault != null&quot;</span>&gt;</span><br>                is_default = #&#123;isDefault&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>        where id = #&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="like"><a href="#like" class="headerlink" title="like"></a>like</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pageQuery&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.sky.entity.Category&quot;</span>&gt;</span><br>        select * from category<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span><br>                and name like concat(&#x27;%&#x27;,#&#123;name&#125;,&#x27;%&#x27;)<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;type != null&quot;</span>&gt;</span><br>                and type = #&#123;type&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>        order by sort asc , create_time desc<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h2><p><code>collection是mapper方法的条件, item是条件的遍历个体(类似vue的for), separator=&quot;,&quot;是分隔符,  中间有逗号,最后一个没逗号; </code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertBatch&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.util.List&quot;</span>&gt;</span><br>        insert into dish_flavor(dish_id, name, value) values<br>            <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;flavors&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;flavor&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span>&gt;</span><br>                (#&#123;flavor.dishId&#125;, #&#123;flavor.name&#125;, #&#123;flavor.value&#125;)<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>这个上一个的区别是: 1.括号写在&lt;foreach&gt;标签内 2.collection不是对象集合, item不是对象, #&#123;&#125;内部不用xx.yy,直接yy</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;removeBatch&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.util.List&quot;</span>&gt;</span><br>        delete from setmeal where<br>            <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;ids&quot;</span></span><br><span class="hljs-tag">                     <span class="hljs-attr">open</span>=<span class="hljs-string">&quot;id in (&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span> <span class="hljs-attr">close</span>=<span class="hljs-string">&quot;)&quot;</span>&gt;</span><br>                #&#123;id&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL</tag>
      
      <tag>动态sql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringCache入门</title>
    <link href="/2023/12/08/SpringCache%E5%85%A5%E9%97%A8/"/>
    <url>/2023/12/08/SpringCache%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Spring-Cache"><a href="#Spring-Cache" class="headerlink" title="Spring Cache"></a>Spring Cache</h1><blockquote><p><code>Spring Cache</code>实现基于注解的缓存功能, 加一个注解实现缓存功能</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></blockquote><h2 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a><strong>常用注解</strong></h2><table><thead><tr><th><strong>注解</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>@EnableCaching</td><td>开启缓存注解功能，通常加在启动类上</td></tr><tr><td>@Cacheable</td><td>在方法执行前先查询缓存中是否有数据，如果有数据，则直接返回缓存数据；如果没有缓存数据，调用方法并将方法返回值放到缓存中</td></tr><tr><td>@CachePut</td><td>将方法的返回值放到缓存中</td></tr><tr><td>@CacheEvict</td><td>将一条或多条数据从缓存中删除</td></tr></tbody></table><h2 id="CachePut"><a href="#CachePut" class="headerlink" title="@CachePut"></a><strong>@CachePut</strong></h2><p><strong>说明：</strong>key的写法如下</p><p>#user.id : #user指的是方法形参的名称, id指的是user的id属性 , 也就是使用user的id属性作为key ;</p><p>#result.id : #result代表方法返回值，该表达式 代表以返回对象的id属性作为key ；</p><p>#p0.id：#p0指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数的id属性作为key ;</p><p>#a0.id：#a0指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数的id属性作为key ;</p><p>#root.args[0].id:#root.args[0]指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数</p><p>的id属性作为key ;</p><p><strong>启动服务,通过swagger接口文档测试，访问UserController的save()方法</strong></p><p>因为id是自增，所以不需要设置id属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* CachePut：将方法返回值放入缓存</span><br><span class="hljs-comment">* value：缓存的名称，每个缓存名称下面可以有多个key</span><br><span class="hljs-comment">* key：缓存的key</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@PostMapping</span><br>   <span class="hljs-meta">@CachePut(value = &quot;userCache&quot;, key = &quot;#user.id&quot;)</span><span class="hljs-comment">//key的生成：userCache::1</span><br>   <span class="hljs-keyword">public</span> User <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span>&#123;<br>       userMapper.insert(user);<br>       <span class="hljs-keyword">return</span> user;<br>   &#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231208211035613.png" alt="image-20231208211035613"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231208211047188.png" alt="image-20231208211047188"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231208211103050.png" alt="image-20231208211103050"></p><h2 id="Cacheable"><a href="#Cacheable" class="headerlink" title="@Cacheable"></a><strong>@Cacheable</strong></h2><blockquote><p>放入缓存之前, 先进行查找, 如果有缓存就停止</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Cacheable(cacheNames = &quot;userCache&quot;, key = &quot;#id&quot;)</span><br><span class="hljs-meta">@GetMapping</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>&#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.getById(id);<br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="CacheEvict"><a href="#CacheEvict" class="headerlink" title="@CacheEvict"></a><strong>@CacheEvict</strong></h2><blockquote><p>清理指定缓存</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CacheEvict(cacheNames = &quot;userCache&quot;, key = &quot;#id&quot;)</span> <span class="hljs-comment">// 删除userCache下指定缓存</span><br>   <span class="hljs-meta">@DeleteMapping</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span>&#123;<br>       userMapper.deleteById(id);<br>   &#125;<br><br>   <span class="hljs-meta">@CacheEvict(cacheNames = &quot;userCache&quot;, allEntries = true)</span><span class="hljs-comment">// 删除userCache下所有缓存</span><br><span class="hljs-meta">@DeleteMapping(&quot;/delAll&quot;)</span> <br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteAll</span><span class="hljs-params">()</span>&#123;<br>       userMapper.deleteAll();<br>   &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SpringCache</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis入门操作</title>
    <link href="/2023/12/08/redis%E5%85%A5%E9%97%A8%E6%93%8D%E4%BD%9C/"/>
    <url>/2023/12/08/redis%E5%85%A5%E9%97%A8%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="Redis入门操作"><a href="#Redis入门操作" class="headerlink" title="Redis入门操作"></a>Redis入门操作</h1><blockquote><p>基于内存的key-value结构数据库, 用途广泛的存储中间件</p><p>NoSQL, 非关系型数据库, 是对关系型数据库的补充</p></blockquote><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><blockquote><p>Redis是 k-v 结构数据,  key是String, value有5种数据类型</p></blockquote><table><thead><tr><th align="left">字符串</th><th align="left">String</th><th></th></tr></thead><tbody><tr><td align="left">哈希</td><td align="left">hash</td><td>又名散列,    类似HashMap</td></tr><tr><td align="left">列表</td><td align="left">list</td><td>按照插入顺序排序, 可以重复元素, 类似LinkedList</td></tr><tr><td align="left">集合</td><td align="left">set</td><td>无序集合, 没有重复, 类似HashSet</td></tr><tr><td align="left">有序集合</td><td align="left">sorted    set&#x2F;zset</td><td>集合每个元素关联一个分数, 根据分数升序排序, 没用重复</td></tr></tbody></table><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221130190150749.png" alt="image-20221130190150749" style="zoom:50%;" /><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p><strong>字符串</strong></p><table><thead><tr><th align="left"><strong>GET</strong> key</th><th align="left">获取a的值</th></tr></thead><tbody><tr><td align="left"><strong>SET</strong> key value</td><td align="left">设置a的值</td></tr><tr><td align="left"><strong>SETEX</strong> key seconds value</td><td align="left">设置a的值, 设置过期时间(s)</td></tr></tbody></table><p><strong>hash</strong></p><table><thead><tr><th align="left"><strong>HGET</strong> key field</th><th align="left">获取key的field</th></tr></thead><tbody><tr><td align="left"><strong>HSET</strong> key field value</td><td align="left">设置key的field 和 value</td></tr><tr><td align="left"><strong>HDEL</strong> key field</td><td align="left">删除key的field</td></tr><tr><td align="left"><strong>HKEYS</strong> key</td><td align="left">获取key的所有field</td></tr><tr><td align="left"><strong>HVALS</strong> key</td><td align="left">获取key的所有value</td></tr></tbody></table><p><strong>list</strong></p><table><thead><tr><th align="left"><strong>LPUSH</strong> key value1 [value2]</th><th align="left">插入k-v</th></tr></thead><tbody><tr><td align="left"><strong>LRANGE</strong> key start stop</td><td align="left">获取指定下标范围的value</td></tr><tr><td align="left"><strong>RPOP</strong> key</td><td align="left">移除并获取列表最后一个value</td></tr><tr><td align="left"><strong>LLEN</strong> key</td><td align="left">获取列表长度</td></tr><tr><td align="left"><strong>BRPOP</strong> key1 [key2 ] timeout</td><td align="left">移出并获取列表的最后一个元素， 如果列表没有元素会阻塞列表直到等待超 时或发现可弹出元素为止</td></tr></tbody></table><p><strong>set</strong></p><table><thead><tr><th align="left"><strong>SADD</strong> key member1 [member2]</th><th align="left">向集合添加一个或多个成员</th></tr></thead><tbody><tr><td align="left"><strong>SMEMBERS</strong> key</td><td align="left">返回集合中的所有成员</td></tr><tr><td align="left"><strong>SCARD</strong> key</td><td align="left">获取集合的成员数</td></tr><tr><td align="left"><strong>SINTER</strong> key1 [key2]</td><td align="left">返回给定所有集合的交集</td></tr><tr><td align="left"><strong>SUNION</strong> key1 [key2]</td><td align="left">返回所有给定集合的并集</td></tr><tr><td align="left"><strong>SREM</strong> key member1 [member2]</td><td align="left">移除集合中一个或多个成员</td></tr></tbody></table><p><strong>zset</strong></p><table><thead><tr><th align="left"><strong>ZADD</strong> key score1 member1 [score2 member2]</th><th align="left">向有序集合添加一个或多个成员</th></tr></thead><tbody><tr><td align="left"><strong>ZRANGE</strong> key start stop [WITHSCORES]</td><td align="left">通过索引区间返回有序集合中指定区间内的成员</td></tr><tr><td align="left"><strong>ZINCRBY</strong> key increment member</td><td align="left">有序集合中对指定成员的分数加上增量 increment</td></tr><tr><td align="left"><strong>ZREM</strong> key member [member …]</td><td align="left">移除有序集合中的一个或多个成员</td></tr></tbody></table><p><strong>通用</strong></p><table><thead><tr><th align="left">KEYS pattern</th><th align="left">查找所有符合给定模式( pattern)的 key</th></tr></thead><tbody><tr><td align="left">EXISTS key</td><td align="left">检查给定 key 是否存在</td></tr><tr><td align="left">TYPE key</td><td align="left">返回 key 所储存的值的类型</td></tr><tr><td align="left">DEL key</td><td align="left">删除 key</td></tr></tbody></table><h2 id="Spring-Data-Redis"><a href="#Spring-Data-Redis" class="headerlink" title="Spring Data Redis"></a>Spring Data Redis</h2><blockquote><p>Spring中通过简单的配置访问Redis服务, 简化Redis操作</p></blockquote><p><strong>导入Spring Data Redis的maven坐标</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>配置Redis数据源</strong></p><blockquote><p> 如果是本地的redis且没有密码则不用配置, 用默认的</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">$&#123;sky.redis.host&#125;</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;sky.redis.port&#125;</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">$&#123;sky.redis.password&#125;</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-string">$&#123;sky.redis.database&#125;</span><br></code></pre></td></tr></table></figure><p><strong>string</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 操作字符串类型的数据</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testString</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// set get setex setnx</span><br>    redisTemplate.opsForValue().set(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;小明&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">city</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(<span class="hljs-string">&quot;name&quot;</span>);<br>    System.out.println(city);<br>    redisTemplate.opsForValue().set(<span class="hljs-string">&quot;code&quot;</span>,<span class="hljs-string">&quot;1234&quot;</span>,<span class="hljs-number">3</span>, TimeUnit.MINUTES);<br>    redisTemplate.opsForValue().setIfAbsent(<span class="hljs-string">&quot;lock&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>);<br>    redisTemplate.opsForValue().setIfAbsent(<span class="hljs-string">&quot;lock&quot;</span>,<span class="hljs-string">&quot;2&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>hash</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 操作哈希类型的数据</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testHash</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">//hset hget hdel hkeys hvals</span><br>    <span class="hljs-type">HashOperations</span> <span class="hljs-variable">hashOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForHash();<br><br>    hashOperations.put(<span class="hljs-string">&quot;100&quot;</span>,<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;tom&quot;</span>);<br>    hashOperations.put(<span class="hljs-string">&quot;100&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>,<span class="hljs-string">&quot;20&quot;</span>);<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) hashOperations.get(<span class="hljs-string">&quot;100&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);<br>    System.out.println(name);<br><br>    <span class="hljs-type">Set</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> hashOperations.keys(<span class="hljs-string">&quot;100&quot;</span>);<br>    System.out.println(keys);<br><br>    <span class="hljs-type">List</span> <span class="hljs-variable">values</span> <span class="hljs-operator">=</span> hashOperations.values(<span class="hljs-string">&quot;100&quot;</span>);<br>    System.out.println(values);<br><br>    hashOperations.delete(<span class="hljs-string">&quot;100&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>list</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 操作列表类型的数据</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testList</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">//lpush lrange rpop llen</span><br>    <span class="hljs-type">ListOperations</span> <span class="hljs-variable">listOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForList();<br><br>    listOperations.leftPushAll(<span class="hljs-string">&quot;mylist&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>);<br>    listOperations.leftPush(<span class="hljs-string">&quot;mylist&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>);<br><br>    <span class="hljs-type">List</span> <span class="hljs-variable">mylist</span> <span class="hljs-operator">=</span> listOperations.range(<span class="hljs-string">&quot;mylist&quot;</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);<br>    System.out.println(mylist);<br><br>    listOperations.rightPop(<span class="hljs-string">&quot;mylist&quot;</span>);<br><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> listOperations.size(<span class="hljs-string">&quot;mylist&quot;</span>);<br>    System.out.println(size);<br>&#125;<br></code></pre></td></tr></table></figure><p>set</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 操作集合类型的数据</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSet</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">//sadd smembers scard sinter sunion srem</span><br>    <span class="hljs-type">SetOperations</span> <span class="hljs-variable">setOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForSet();<br><br>    setOperations.add(<span class="hljs-string">&quot;set1&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>);<br>    setOperations.add(<span class="hljs-string">&quot;set2&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;x&quot;</span>,<span class="hljs-string">&quot;y&quot;</span>);<br><br>    <span class="hljs-type">Set</span> <span class="hljs-variable">members</span> <span class="hljs-operator">=</span> setOperations.members(<span class="hljs-string">&quot;set1&quot;</span>);<br>    System.out.println(members);<br><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> setOperations.size(<span class="hljs-string">&quot;set1&quot;</span>);<br>    System.out.println(size);<br><br>    <span class="hljs-type">Set</span> <span class="hljs-variable">intersect</span> <span class="hljs-operator">=</span> setOperations.intersect(<span class="hljs-string">&quot;set1&quot;</span>, <span class="hljs-string">&quot;set2&quot;</span>);<br>    System.out.println(intersect);<br><br>    <span class="hljs-type">Set</span> <span class="hljs-variable">union</span> <span class="hljs-operator">=</span> setOperations.union(<span class="hljs-string">&quot;set1&quot;</span>, <span class="hljs-string">&quot;set2&quot;</span>);<br>    System.out.println(union);<br><br>    setOperations.remove(<span class="hljs-string">&quot;set1&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>zset</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 操作有序集合类型的数据</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testZset</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">//zadd zrange zincrby zrem</span><br>    <span class="hljs-type">ZSetOperations</span> <span class="hljs-variable">zSetOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForZSet();<br><br>    zSetOperations.add(<span class="hljs-string">&quot;zset1&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-number">10</span>);<br>    zSetOperations.add(<span class="hljs-string">&quot;zset1&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-number">12</span>);<br>    zSetOperations.add(<span class="hljs-string">&quot;zset1&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-number">9</span>);<br><br>    <span class="hljs-type">Set</span> <span class="hljs-variable">zset1</span> <span class="hljs-operator">=</span> zSetOperations.range(<span class="hljs-string">&quot;zset1&quot;</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);<br>    System.out.println(zset1);<br><br>    zSetOperations.incrementScore(<span class="hljs-string">&quot;zset1&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-number">10</span>);<br><br>    zSetOperations.remove(<span class="hljs-string">&quot;zset1&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>通用</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 通用命令操作</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCommon</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">//keys exists type del</span><br>    <span class="hljs-type">Set</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> redisTemplate.keys(<span class="hljs-string">&quot;*&quot;</span>);<br>    System.out.println(keys);<br><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(<span class="hljs-string">&quot;name&quot;</span>);<br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">set1</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(<span class="hljs-string">&quot;set1&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (Object key : keys) &#123;<br>        <span class="hljs-type">DataType</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> redisTemplate.type(key);<br>        System.out.println(type.name());<br>    &#125;<br><br>    redisTemplate.delete(<span class="hljs-string">&quot;mylist&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><blockquote><p>店铺打烊和营业存入redis</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.admin;<br><br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 15:44</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController(&quot;adminShopController&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/shop&quot;)</span><br><span class="hljs-meta">@Api(tags = &quot;店铺相关操作&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShopController</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate srt;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SHOP_STATUS&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取营业状态</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;获取营业状态&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/status&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;Integer&gt; <span class="hljs-title function_">getStatus</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> srt.opsForValue().get(KEY);<br>        <span class="hljs-keyword">if</span> (status != <span class="hljs-literal">null</span>) &#123;<br>            log.info(<span class="hljs-string">&quot;店铺状态: &#123;&#125;&quot;</span>, status.equals(<span class="hljs-string">&quot;1&quot;</span>) ? <span class="hljs-string">&quot;营业中&quot;</span> : <span class="hljs-string">&quot;打烊中&quot;</span>);<br>            <span class="hljs-keyword">return</span> Result.success(Integer.valueOf(status));<br>        &#125;<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置营业状态</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PutMapping(&quot;/&#123;status&#125;&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;设置营业状态&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">setStatus</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer status)</span>&#123;<br>        srt.opsForValue().set(KEY, status.toString());<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="额外的配置"><a href="#额外的配置" class="headerlink" title="额外的配置"></a>额外的配置</h2><blockquote><p>这个配置类不是必须的，因为 Spring Boot 框架会自动装配 RedisTemplate 对象，但是默认的key序列化器为</p><p>JdkSerializationRedisSerializer，导致我们存到Redis中后的数据和原始数据有差别，故设置为</p><p>StringRedisSerializer序列化器。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.config;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfiguration</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;开始创建redis模板对象...&quot;</span>);<br>        <span class="hljs-type">RedisTemplate</span> <span class="hljs-variable">redisTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>();<br>        <span class="hljs-comment">//设置redis的连接工厂对象</span><br>        redisTemplate.setConnectionFactory(redisConnectionFactory);<br>        <span class="hljs-comment">//设置redis key的序列化器</span><br>        redisTemplate.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>注解基本使用</title>
    <link href="/2023/12/07/%E6%B3%A8%E8%A7%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/12/07/%E6%B3%A8%E8%A7%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Java注解"><a href="#Java注解" class="headerlink" title="Java注解"></a>Java注解</h1><p>通过<code>反射</code>获取标注的内容,   这个内容可以是类, 方法, 变量, 参数, 包等等</p><h2 id="内置注解"><a href="#内置注解" class="headerlink" title="内置注解"></a>内置注解</h2><p>@Override       检查该方法是否是重写方法</p><p>@Deprecated    标记过时方法</p><p>@SuppressWarnings   编译器忽略警告</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">deprecation  <span class="hljs-comment">-- 使用了不赞成使用的类或方法时的警告</span><br>unchecked    <span class="hljs-comment">-- 执行了未检查的转换时的警告，例如当使用集合时没有用泛型 (Generics) 来指定集合保存的类型。</span><br>fallthrough  <span class="hljs-comment">-- 当 Switch 程序块直接通往下一种情况而没有 Break 时的警告。</span><br><span class="hljs-type">path</span>         <span class="hljs-comment">-- 在类路径、源文件路径等中有不存在的路径时的警告。</span><br><span class="hljs-type">serial</span>       <span class="hljs-comment">-- 当在可序列化的类上缺少 serialVersionUID 定义时的警告。</span><br>finally      <span class="hljs-comment">-- 任何 finally 子句不能正常完成时的警告。</span><br><span class="hljs-keyword">all</span>          <span class="hljs-comment">-- 关于以上所有情况的警告。</span><br></code></pre></td></tr></table></figure><p><strong>元注解:    注解的注解</strong></p><p>@Retention  标识这个注解怎么保存，是只在代码中，还是编入class文件中，或者是在运行时可以通过反射访问</p><p>@Documented   标记这些注解是否包含在用户文档</p><p>@Target  标记这个注解应该是哪种 Java 成员</p><p>@Inherited  标记这个注解是继承于哪个注解</p><h2 id="组成部分"><a href="#组成部分" class="headerlink" title="组成部分"></a>组成部分</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.annotation;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Annotation</span> &#123;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object obj)</span>;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span>;<br><br>    String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span>;<br><br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; annotationType();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.annotation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ElementType</span> &#123;<br>    TYPE,               <span class="hljs-comment">/* 类、接口（包括注释类型）或枚举声明  */</span><br><br>    FIELD,              <span class="hljs-comment">/* 字段声明（包括枚举常量）  */</span><br><br>    METHOD,             <span class="hljs-comment">/* 方法声明  */</span><br><br>    PARAMETER,          <span class="hljs-comment">/* 参数声明  */</span><br><br>    CONSTRUCTOR,        <span class="hljs-comment">/* 构造方法声明  */</span><br><br>    LOCAL_VARIABLE,     <span class="hljs-comment">/* 局部变量声明  */</span><br><br>    ANNOTATION_TYPE,    <span class="hljs-comment">/* 注释类型声明  */</span><br><br>    PACKAGE             <span class="hljs-comment">/* 包声明  */</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.annotation;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">RetentionPolicy</span> &#123;<br>    SOURCE,            <span class="hljs-comment">/* Annotation信息仅存在于编译器处理期间，编译器处理完之后就没有该Annotation信息了  */</span><br><br>    CLASS,             <span class="hljs-comment">/* 编译器将Annotation存储于类对应的.class文件中。默认行为  */</span><br><br>    RUNTIME            <span class="hljs-comment">/* 编译器将Annotation存储于class文件中，并且可由JVM读入 */</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="通用定义"><a href="#通用定义" class="headerlink" title="通用定义"></a>通用定义</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MyAnnotation1 &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>@interface</strong></p><p>实现 java.lang.annotation.Annotation  接口, 该注解是一个Annotation</p><p><strong>@Documented</strong></p><p>类和方法可以出现在javadoc中</p><p><strong>@Target(ElementType.TYPE)</strong></p><p>Annotation 作用范围, 如果没有则作用范围随意</p><ul><li>TYPE 意味着，它能标注”类、接口（包括注释类型）或枚举声明”。</li><li>FIELD 意味着，它能标注”字段声明”。</li><li>METHOD 意味着，它能标注”方法”。</li><li>PARAMETER 意味着，它能标注”参数”。</li><li>CONSTRUCTOR 意味着，它能标注”构造方法”。</li><li>LOCAL_VARIABLE 意味着，它能标注”局部变量”。</li></ul><p><strong>@Retention(RetentionPolicy.RUNTIME)</strong></p><p>指定Annotation的策略, 后接RetentionPolicy.RUNTIME，编译器会将该 Annotation 信息保留在 .class 文件中，并且能被虚拟机读取</p><h2 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Deprecated</span>  -- <span class="hljs-meta">@Deprecated</span> 所标注内容，不再被建议使用。<br><span class="hljs-meta">@Override</span>    -- <span class="hljs-meta">@Override</span> 只能标注方法，表示该方法覆盖父类中的方法。<br><span class="hljs-meta">@Documented</span>  -- <span class="hljs-meta">@Documented</span> 所标注内容，可以出现在javadoc中。<br><span class="hljs-meta">@Inherited</span>   -- <span class="hljs-meta">@Inherited</span>只能被用来标注注解，它所标注的注解具有继承性。<br><span class="hljs-meta">@Retention</span>   -- <span class="hljs-meta">@Retention</span>只能被用来标注注解，而且它被用来指定注解的RetentionPolicy属性。<br><span class="hljs-meta">@Target</span>      -- <span class="hljs-meta">@Target</span>只能被用来标注注解，而且它被用来指定注解的ElementType属性。<br><span class="hljs-meta">@SuppressWarnings</span> -- <span class="hljs-meta">@SuppressWarnings</span> 所标注内容产生的警告，编译器会对这些警告保持静默。<br></code></pre></td></tr></table></figure><h2 id="公共字段填充"><a href="#公共字段填充" class="headerlink" title="公共字段填充"></a>公共字段填充</h2><p><strong>自定义注解</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.METHOD)</span> <span class="hljs-comment">// 作用范围:方法</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span> <span class="hljs-comment">// 信息保留在.class文件</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> AutoFill &#123;<br>    <span class="hljs-comment">//数据库操作类型enum : INSERT UPDATE</span><br>    OperationType <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OperationType</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新操作</span><br><span class="hljs-comment">     */</span><br>    UPDATE,<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 插入操作</span><br><span class="hljs-comment">     */</span><br>    INSERT<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>自定义切面，实现公共字段自动填充处理逻辑</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoFillAspect</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 切入点</span><br><span class="hljs-comment">     * 在mapper包且有<span class="hljs-doctag">@AutoFill</span>条件切入</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Pointcut(&quot;execution(* com.sky.mapper.*.*(..)) &amp;&amp; @annotation(com.sky.annotation.AutoFill)&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoFillPointCut</span><span class="hljs-params">()</span>&#123;&#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 前置通知,在通知中进行公共字段的赋值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> joinPoint</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Before(&quot;autoFillPointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoFill</span><span class="hljs-params">(JoinPoint joinPoint)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;开始进行公共字段自动填充...&quot;</span>);<br>        <span class="hljs-comment">// 获取被拦截方法的数据库操作类型</span><br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<span class="hljs-comment">// 方法签名对象</span><br>        <span class="hljs-type">AutoFill</span> <span class="hljs-variable">autoFill</span> <span class="hljs-operator">=</span> signature.getMethod().getAnnotation(AutoFill.class);<span class="hljs-comment">// 方法注解对象</span><br>        <span class="hljs-type">OperationType</span> <span class="hljs-variable">operationType</span> <span class="hljs-operator">=</span> autoFill.value();<span class="hljs-comment">// 获得数据库操作类型</span><br>        <span class="hljs-comment">// 获取当前被拦截的方法的参数 -- 实体对象</span><br>        Object[] args = joinPoint.getArgs();<br>        <span class="hljs-keyword">if</span> (args==<span class="hljs-literal">null</span> || args.length==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 获得sql方法的第一个参数, 这里只有一个参数: 实体类</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">0</span>];<br>        <span class="hljs-comment">// 准备赋值数据</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br>        <span class="hljs-comment">// 根据不同的操作类型, 为对应属性通过反射来赋值</span><br>        <span class="hljs-keyword">if</span> (operationType == INSERT)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 4个字段赋值</span><br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setCreateTime</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_CREATE_TIME, LocalDateTime.class);<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setUpdateTime</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_UPDATE_TIME, LocalDateTime.class);<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setCreateUser</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_CREATE_USER, Long.class);<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setUpdateUser</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_UPDATE_USER, Long.class);<br>                <span class="hljs-comment">// 通过反射为对象属性赋值</span><br>                setCreateTime.invoke(entity, now);<br>                setUpdateTime.invoke(entity, now);<br>                setCreateUser.invoke(entity, empId);<br>                setUpdateUser.invoke(entity, empId);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operationType == OperationType.UPDATE) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 2个字段赋值</span><br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setUpdateTime</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_UPDATE_TIME, LocalDateTime.class);<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setUpdateUser</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_UPDATE_USER, Long.class);<br>                <span class="hljs-comment">// 通过反射为对象属性赋值</span><br>                setUpdateTime.invoke(entity, now);<br>                setUpdateUser.invoke(entity, empId);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 编辑员工</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> employee</span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@AutoFill(UPDATE)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Employee employee)</span>;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增员工</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> employee</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@AutoFill(INSERT)</span><br>    <span class="hljs-meta">@Insert(&quot;insert into employee(username, name, phone, sex, id_number, password, status, create_time, update_time, create_user, update_user) values (#&#123;username&#125;, #&#123;name&#125;, #&#123;phone&#125;, #&#123;sex&#125;, #&#123;idNumber&#125;, #&#123;password&#125;, #&#123;status&#125;, #&#123;createTime&#125;, #&#123;updateTime&#125;, #&#123;createUser&#125;, #&#123;updateUser&#125;)&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Employee employee)</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>注解</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>苍穹外卖</title>
    <link href="/2023/12/06/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/"/>
    <url>/2023/12/06/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/</url>
    
    <content type="html"><![CDATA[<p>仓库地址  <a href="https://github.com/fuguangjian0/cangqiong-takeaway">https://github.com/fuguangjian0/cangqiong-takeaway</a></p><h1 id="day01"><a href="#day01" class="headerlink" title="day01"></a>day01</h1><h2 id="软件开发介绍"><a href="#软件开发介绍" class="headerlink" title="软件开发介绍"></a>软件开发介绍</h2><p><code>软件开发流程</code></p><pre><code class=" mermaid">graph LR需求分析 --&gt; 设计 --&gt; 编码 --&gt;  测试 --&gt; 上线运维</code></pre><p><code>软件环境</code></p><ol><li>开发环境(dev),开发阶段使用的环境,外部人员无法访问</li><li>测试环境(test),项目功能模块开发完毕,单元测试后,把项目部署到服务器,让测试人员对项目进行测试,这台测试服务器是测试环境,外部人员无法访问</li><li>生产环境(pro),项目开发完毕, 由测试人员测试通过, 可以上线项目, 将项目部署到线上环境, 外部人员可以访问</li></ol><h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><p>包括<code>系统管理后台</code>和<code>小程序端前台</code>两部分, 系统管理后台提供给内部员工使用, 对餐厅的分类,菜品,套餐,订单,员工等进行管理维护,对餐厅各类数据统计, 可以进行语音播报功能;  小程序端提供给消费者使用, 浏览菜品, 添加购物车, 下单, 支付, 催单等.</p><p><code>后台功能</code></p><table><thead><tr><th>模块</th><th>描述</th></tr></thead><tbody><tr><td>登录&#x2F;退出</td><td>内部员工必须登录后,才可以访问系统管理后台</td></tr><tr><td>员工管理</td><td>管理员可以在系统后台对员工信息进行管理，包含查询、新增、编辑、禁用等功能</td></tr><tr><td>分类管理</td><td>主要对当前餐厅经营的 菜品分类 或 套餐分类 进行管理维护， 包含查询、新增、修改、删除等功能</td></tr><tr><td>菜品管理</td><td>主要维护各个分类下的菜品信息，包含查询、新增、修改、删除、启售、停售等功能</td></tr><tr><td>套餐管理</td><td>主要维护当前餐厅中的套餐信息，包含查询、新增、修改、删除、启售、停售等功能</td></tr><tr><td>订单管理</td><td>主要维护用户在移动端下的订单信息，包含查询、取消、派送、完成，以及订单报表下载等功能</td></tr><tr><td>数据统计</td><td>主要完成对餐厅的各类数据统计，如营业额、用户数量、订单等</td></tr></tbody></table><p><code>前台功能</code></p><table><thead><tr><th>模块</th><th>描述</th></tr></thead><tbody><tr><td>登录&#x2F;退出</td><td>用户需要通过微信授权后登录使用小程序进行点餐</td></tr><tr><td>点餐-菜单</td><td>在点餐界面需要展示出菜品分类&#x2F;套餐分类, 并根据当前选择的分类加载其中的菜品信息, 供用户查询选择</td></tr><tr><td>点餐-购物车</td><td>用户选中的菜品就会加入用户的购物车, 主要包含 查询购物车、加入购物车、删除购物车、清空购物车等功能</td></tr><tr><td>订单支付</td><td>用户选完菜品&#x2F;套餐后, 可以对购物车菜品进行结算支付, 这时就需要进行订单的支付</td></tr><tr><td>个人信息</td><td>在个人中心页面中会展示当前用户的基本信息, 用户可以管理收货地址, 也可以查询历史订单数据</td></tr></tbody></table><p><code>原型图</code></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221106195259858.png" alt="image-20221106195259858" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221106195354556.png" alt="image-20221106195354556" style="zoom:50%;" /><p><code>技术</code></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221106185646994.png" alt="image-20221106185646994"></p><h2 id="开发环境搭建"><a href="#开发环境搭建" class="headerlink" title="开发环境搭建"></a>开发环境搭建</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221106200821282.png" alt="image-20221106200821282" style="zoom: 67%;" /><p><code>前端环境搭建</code></p><p>将nginx文件夹移动到非中文目录, 启动exe文件, 访问</p><p><a href="http://localhost/">http://localhost</a></p><p><code>后端环境搭建</code></p><p>IDEA打开工程, 项目由三个模块</p><table><thead><tr><th><strong>序号</strong></th><th><strong>名称</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>1</td><td>sky-take-out</td><td>maven父工程，统一管理依赖版本，聚合其他子模块</td></tr><tr><td>2</td><td>sky-common</td><td>子模块，存放公共类，例如：工具类、常量类、异常类等</td></tr><tr><td>3</td><td>sky-pojo</td><td>子模块，存放实体类、VO、DTO等</td></tr><tr><td>4</td><td>sky-server</td><td>子模块，后端服务，存放配置文件、Controller、Service、Mapper等</td></tr></tbody></table><p><code>sky-common</code></p><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>constant</td><td>存放相关常量类</td></tr><tr><td>context</td><td>存放上下文类</td></tr><tr><td>enumeration</td><td>项目的枚举类存储</td></tr><tr><td>exception</td><td>存放自定义异常类</td></tr><tr><td>json</td><td>处理json转换的类</td></tr><tr><td>properties</td><td>存放SpringBoot相关的配置属性类</td></tr><tr><td>result</td><td>返回结果类的封装</td></tr><tr><td>utils</td><td>常用工具类</td></tr></tbody></table><p><code>sky-pojo</code></p><table><thead><tr><th><strong>名称</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>Entity</td><td>实体，通常和数据库中的表对应</td></tr><tr><td>DTO</td><td>数据传输对象，通常用于程序中各层之间传递数据</td></tr><tr><td>VO</td><td>视图对象，为前端展示数据提供的对象</td></tr><tr><td>POJO</td><td>普通Java对象，只有属性和对应的getter和setter</td></tr></tbody></table><p><code>sky-server</code></p><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>config</td><td>存放配置类</td></tr><tr><td>controller</td><td>存放controller类</td></tr><tr><td>interceptor</td><td>存放拦截器类</td></tr><tr><td>mapper</td><td>存放mapper接口</td></tr><tr><td>service</td><td>存放service类</td></tr><tr><td>SkyApplication</td><td>启动类</td></tr></tbody></table><p><code>SQL</code></p><p><code>表描述</code></p><table><thead><tr><th><strong>序号</strong></th><th><strong>表名</strong></th><th><strong>中文名</strong></th></tr></thead><tbody><tr><td>1</td><td>employee</td><td>员工表</td></tr><tr><td>2</td><td>category</td><td>分类表</td></tr><tr><td>3</td><td>dish</td><td>菜品表</td></tr><tr><td>4</td><td>dish_flavor</td><td>菜品口味表</td></tr><tr><td>5</td><td>setmeal</td><td>套餐表</td></tr><tr><td>6</td><td>setmeal_dish</td><td>套餐菜品关系表</td></tr><tr><td>7</td><td>user</td><td>用户表</td></tr><tr><td>8</td><td>address_book</td><td>地址表</td></tr><tr><td>9</td><td>shopping_cart</td><td>购物车表</td></tr><tr><td>10</td><td>orders</td><td>订单表</td></tr><tr><td>11</td><td>order_detail</td><td>订单明细表</td></tr></tbody></table><p><code>sql文件</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DATABASE  IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `sky_take_out` ;<br>USE `sky_take_out`;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `address_book`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `address_book` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `user_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户id&#x27;</span>,<br>  `consignee` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人&#x27;</span>,<br>  `sex` <span class="hljs-type">varchar</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;性别&#x27;</span>,<br>  `phone` <span class="hljs-type">varchar</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;手机号&#x27;</span>,<br>  `province_code` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;省级区划编号&#x27;</span>,<br>  `province_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;省级名称&#x27;</span>,<br>  `city_code` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;市级区划编号&#x27;</span>,<br>  `city_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;市级名称&#x27;</span>,<br>  `district_code` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;区级区划编号&#x27;</span>,<br>  `district_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;区级名称&#x27;</span>,<br>  `detail` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;详细地址&#x27;</span>,<br>  `label` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;标签&#x27;</span>,<br>  `is_default` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;默认 0 否 1是&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">2</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;地址簿&#x27;</span>;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `category`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `category` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `type` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;类型   1 菜品分类 2 套餐分类&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;分类名称&#x27;</span>,<br>  `sort` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;顺序&#x27;</span>,<br>  `status` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;分类状态 0:禁用，1:启用&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  `update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;更新时间&#x27;</span>,<br>  `create_user` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建人&#x27;</span>,<br>  `update_user` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;修改人&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  <span class="hljs-keyword">UNIQUE</span> KEY `idx_category_name` (`name`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">23</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;菜品及套餐分类&#x27;</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `category` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">11</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;酒水饮料&#x27;</span>,<span class="hljs-number">10</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-09 22:09:18&#x27;</span>,<span class="hljs-string">&#x27;2022-06-09 22:09:18&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `category` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">12</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;传统主食&#x27;</span>,<span class="hljs-number">9</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-09 22:09:32&#x27;</span>,<span class="hljs-string">&#x27;2022-06-09 22:18:53&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `category` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">13</span>,<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;人气套餐&#x27;</span>,<span class="hljs-number">12</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-09 22:11:38&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 11:04:40&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `category` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">15</span>,<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;商务套餐&#x27;</span>,<span class="hljs-number">13</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-09 22:14:10&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 11:04:48&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `category` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">16</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;蜀味烤鱼&#x27;</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-09 22:15:37&#x27;</span>,<span class="hljs-string">&#x27;2022-08-31 14:27:25&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `category` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">17</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;蜀味牛蛙&#x27;</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-09 22:16:14&#x27;</span>,<span class="hljs-string">&#x27;2022-08-31 14:39:44&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `category` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">18</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;特色蒸菜&#x27;</span>,<span class="hljs-number">6</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-09 22:17:42&#x27;</span>,<span class="hljs-string">&#x27;2022-06-09 22:17:42&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `category` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">19</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;新鲜时蔬&#x27;</span>,<span class="hljs-number">7</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-09 22:18:12&#x27;</span>,<span class="hljs-string">&#x27;2022-06-09 22:18:28&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `category` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">20</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;水煮鱼&#x27;</span>,<span class="hljs-number">8</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-09 22:22:29&#x27;</span>,<span class="hljs-string">&#x27;2022-06-09 22:23:45&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `category` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">21</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;汤类&#x27;</span>,<span class="hljs-number">11</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:51:47&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:51:47&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `dish`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `dish` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品名称&#x27;</span>,<br>  `category_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品分类id&#x27;</span>,<br>  `price` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品价格&#x27;</span>,<br>  `image` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;图片&#x27;</span>,<br>  `description` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;描述信息&#x27;</span>,<br>  `status` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;0 停售 1 起售&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  `update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;更新时间&#x27;</span>,<br>  `create_user` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建人&#x27;</span>,<br>  `update_user` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;修改人&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  <span class="hljs-keyword">UNIQUE</span> KEY `idx_dish_name` (`name`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">70</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;菜品&#x27;</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">46</span>,<span class="hljs-string">&#x27;王老吉&#x27;</span>,<span class="hljs-number">11</span>,<span class="hljs-number">6.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-09 22:40:47&#x27;</span>,<span class="hljs-string">&#x27;2022-06-09 22:40:47&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">47</span>,<span class="hljs-string">&#x27;北冰洋&#x27;</span>,<span class="hljs-number">11</span>,<span class="hljs-number">4.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/4451d4be-89a2-4939-9c69-3a87151cb979.png&#x27;</span>,<span class="hljs-string">&#x27;还是小时候的味道&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:18:49&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:18:49&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">48</span>,<span class="hljs-string">&#x27;雪花啤酒&#x27;</span>,<span class="hljs-number">11</span>,<span class="hljs-number">4.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/bf8cbfc1-04d2-40e8-9826-061ee41ab87c.png&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:22:54&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:22:54&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">49</span>,<span class="hljs-string">&#x27;米饭&#x27;</span>,<span class="hljs-number">12</span>,<span class="hljs-number">2.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/76752350-2121-44d2-b477-10791c23a8ec.png&#x27;</span>,<span class="hljs-string">&#x27;精选五常大米&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:30:17&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:30:17&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">50</span>,<span class="hljs-string">&#x27;馒头&#x27;</span>,<span class="hljs-number">12</span>,<span class="hljs-number">1.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/475cc599-8661-4899-8f9e-121dd8ef7d02.png&#x27;</span>,<span class="hljs-string">&#x27;优质面粉&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:34:28&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:34:28&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">51</span>,<span class="hljs-string">&#x27;老坛酸菜鱼&#x27;</span>,<span class="hljs-number">20</span>,<span class="hljs-number">56.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/4a9cefba-6a74-467e-9fde-6e687ea725d7.png&#x27;</span>,<span class="hljs-string">&#x27;原料：汤，草鱼，酸菜&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:40:51&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:40:51&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">52</span>,<span class="hljs-string">&#x27;经典酸菜鮰鱼&#x27;</span>,<span class="hljs-number">20</span>,<span class="hljs-number">66.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/5260ff39-986c-4a97-8850-2ec8c7583efc.png&#x27;</span>,<span class="hljs-string">&#x27;原料：酸菜，江团，鮰鱼&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:46:02&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:46:02&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">53</span>,<span class="hljs-string">&#x27;蜀味水煮草鱼&#x27;</span>,<span class="hljs-number">20</span>,<span class="hljs-number">38.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/a6953d5a-4c18-4b30-9319-4926ee77261f.png&#x27;</span>,<span class="hljs-string">&#x27;原料：草鱼，汤&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:48:37&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:48:37&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">54</span>,<span class="hljs-string">&#x27;清炒小油菜&#x27;</span>,<span class="hljs-number">19</span>,<span class="hljs-number">18.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/3613d38e-5614-41c2-90ed-ff175bf50716.png&#x27;</span>,<span class="hljs-string">&#x27;原料：小油菜&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:51:46&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:51:46&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">55</span>,<span class="hljs-string">&#x27;蒜蓉娃娃菜&#x27;</span>,<span class="hljs-number">19</span>,<span class="hljs-number">18.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/4879ed66-3860-4b28-ba14-306ac025fdec.png&#x27;</span>,<span class="hljs-string">&#x27;原料：蒜，娃娃菜&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:53:37&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:53:37&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">56</span>,<span class="hljs-string">&#x27;清炒西兰花&#x27;</span>,<span class="hljs-number">19</span>,<span class="hljs-number">18.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/e9ec4ba4-4b22-4fc8-9be0-4946e6aeb937.png&#x27;</span>,<span class="hljs-string">&#x27;原料：西兰花&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:55:44&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:55:44&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">57</span>,<span class="hljs-string">&#x27;炝炒圆白菜&#x27;</span>,<span class="hljs-number">19</span>,<span class="hljs-number">18.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/22f59feb-0d44-430e-a6cd-6a49f27453ca.png&#x27;</span>,<span class="hljs-string">&#x27;原料：圆白菜&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 09:58:35&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 09:58:35&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">58</span>,<span class="hljs-string">&#x27;清蒸鲈鱼&#x27;</span>,<span class="hljs-number">18</span>,<span class="hljs-number">98.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/c18b5c67-3b71-466c-a75a-e63c6449f21c.png&#x27;</span>,<span class="hljs-string">&#x27;原料：鲈鱼&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:12:28&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:12:28&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">59</span>,<span class="hljs-string">&#x27;东坡肘子&#x27;</span>,<span class="hljs-number">18</span>,<span class="hljs-number">138.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/a80a4b8c-c93e-4f43-ac8a-856b0d5cc451.png&#x27;</span>,<span class="hljs-string">&#x27;原料：猪肘棒&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:24:03&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:24:03&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">60</span>,<span class="hljs-string">&#x27;梅菜扣肉&#x27;</span>,<span class="hljs-number">18</span>,<span class="hljs-number">58.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/6080b118-e30a-4577-aab4-45042e3f88be.png&#x27;</span>,<span class="hljs-string">&#x27;原料：猪肉，梅菜&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:26:03&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:26:03&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">61</span>,<span class="hljs-string">&#x27;剁椒鱼头&#x27;</span>,<span class="hljs-number">18</span>,<span class="hljs-number">66.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/13da832f-ef2c-484d-8370-5934a1045a06.png&#x27;</span>,<span class="hljs-string">&#x27;原料：鲢鱼，剁椒&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:28:54&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:28:54&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">62</span>,<span class="hljs-string">&#x27;金汤酸菜牛蛙&#x27;</span>,<span class="hljs-number">17</span>,<span class="hljs-number">88.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/7694a5d8-7938-4e9d-8b9e-2075983a2e38.png&#x27;</span>,<span class="hljs-string">&#x27;原料：鲜活牛蛙，酸菜&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:33:05&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:33:05&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">63</span>,<span class="hljs-string">&#x27;香锅牛蛙&#x27;</span>,<span class="hljs-number">17</span>,<span class="hljs-number">88.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/f5ac8455-4793-450c-97ba-173795c34626.png&#x27;</span>,<span class="hljs-string">&#x27;配料：鲜活牛蛙，莲藕，青笋&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:35:40&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:35:40&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">64</span>,<span class="hljs-string">&#x27;馋嘴牛蛙&#x27;</span>,<span class="hljs-number">17</span>,<span class="hljs-number">88.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/7a55b845-1f2b-41fa-9486-76d187ee9ee1.png&#x27;</span>,<span class="hljs-string">&#x27;配料：鲜活牛蛙，丝瓜，黄豆芽&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:37:52&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:37:52&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">65</span>,<span class="hljs-string">&#x27;草鱼2斤&#x27;</span>,<span class="hljs-number">16</span>,<span class="hljs-number">68.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/b544d3ba-a1ae-4d20-a860-81cb5dec9e03.png&#x27;</span>,<span class="hljs-string">&#x27;原料：草鱼，黄豆芽，莲藕&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:41:08&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:41:08&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">66</span>,<span class="hljs-string">&#x27;江团鱼2斤&#x27;</span>,<span class="hljs-number">16</span>,<span class="hljs-number">119.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/a101a1e9-8f8b-47b2-afa4-1abd47ea0a87.png&#x27;</span>,<span class="hljs-string">&#x27;配料：江团鱼，黄豆芽，莲藕&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:42:42&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:42:42&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">67</span>,<span class="hljs-string">&#x27;鮰鱼2斤&#x27;</span>,<span class="hljs-number">16</span>,<span class="hljs-number">72.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/8cfcc576-4b66-4a09-ac68-ad5b273c2590.png&#x27;</span>,<span class="hljs-string">&#x27;原料：鮰鱼，黄豆芽，莲藕&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:43:56&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:43:56&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">68</span>,<span class="hljs-string">&#x27;鸡蛋汤&#x27;</span>,<span class="hljs-number">21</span>,<span class="hljs-number">4.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/c09a0ee8-9d19-428d-81b9-746221824113.png&#x27;</span>,<span class="hljs-string">&#x27;配料：鸡蛋，紫菜&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:54:25&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:54:25&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">69</span>,<span class="hljs-string">&#x27;平菇豆腐汤&#x27;</span>,<span class="hljs-number">21</span>,<span class="hljs-number">6.00</span>,<span class="hljs-string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/16d0a3d6-2253-4cfc-9b49-bf7bd9eb2ad2.png&#x27;</span>,<span class="hljs-string">&#x27;配料：豆腐，平菇&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-06-10 10:55:02&#x27;</span>,<span class="hljs-string">&#x27;2022-06-10 10:55:02&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `dish_flavor`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `dish_flavor` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `dish_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;口味名称&#x27;</span>,<br>  `<span class="hljs-keyword">value</span>` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;口味数据list&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">104</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;菜品口味关系表&#x27;</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">40</span>,<span class="hljs-number">10</span>,<span class="hljs-string">&#x27;甜味&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;无糖\&quot;,\&quot;少糖\&quot;,\&quot;半糖\&quot;,\&quot;多糖\&quot;,\&quot;全糖\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">41</span>,<span class="hljs-number">7</span>,<span class="hljs-string">&#x27;忌口&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">42</span>,<span class="hljs-number">7</span>,<span class="hljs-string">&#x27;温度&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;热饮\&quot;,\&quot;常温\&quot;,\&quot;去冰\&quot;,\&quot;少冰\&quot;,\&quot;多冰\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">45</span>,<span class="hljs-number">6</span>,<span class="hljs-string">&#x27;忌口&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">46</span>,<span class="hljs-number">6</span>,<span class="hljs-string">&#x27;辣度&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">47</span>,<span class="hljs-number">5</span>,<span class="hljs-string">&#x27;辣度&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">48</span>,<span class="hljs-number">5</span>,<span class="hljs-string">&#x27;甜味&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;无糖\&quot;,\&quot;少糖\&quot;,\&quot;半糖\&quot;,\&quot;多糖\&quot;,\&quot;全糖\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">49</span>,<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;甜味&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;无糖\&quot;,\&quot;少糖\&quot;,\&quot;半糖\&quot;,\&quot;多糖\&quot;,\&quot;全糖\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">50</span>,<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;甜味&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;无糖\&quot;,\&quot;少糖\&quot;,\&quot;半糖\&quot;,\&quot;多糖\&quot;,\&quot;全糖\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">51</span>,<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;甜味&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;无糖\&quot;,\&quot;少糖\&quot;,\&quot;半糖\&quot;,\&quot;多糖\&quot;,\&quot;全糖\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">52</span>,<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;忌口&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">86</span>,<span class="hljs-number">52</span>,<span class="hljs-string">&#x27;忌口&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">87</span>,<span class="hljs-number">52</span>,<span class="hljs-string">&#x27;辣度&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">88</span>,<span class="hljs-number">51</span>,<span class="hljs-string">&#x27;忌口&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">89</span>,<span class="hljs-number">51</span>,<span class="hljs-string">&#x27;辣度&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">92</span>,<span class="hljs-number">53</span>,<span class="hljs-string">&#x27;忌口&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">93</span>,<span class="hljs-number">53</span>,<span class="hljs-string">&#x27;辣度&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">94</span>,<span class="hljs-number">54</span>,<span class="hljs-string">&#x27;忌口&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">95</span>,<span class="hljs-number">56</span>,<span class="hljs-string">&#x27;忌口&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">96</span>,<span class="hljs-number">57</span>,<span class="hljs-string">&#x27;忌口&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">97</span>,<span class="hljs-number">60</span>,<span class="hljs-string">&#x27;忌口&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">101</span>,<span class="hljs-number">66</span>,<span class="hljs-string">&#x27;辣度&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">102</span>,<span class="hljs-number">67</span>,<span class="hljs-string">&#x27;辣度&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `dish_flavor` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">103</span>,<span class="hljs-number">65</span>,<span class="hljs-string">&#x27;辣度&#x27;</span>,<span class="hljs-string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `employee`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `employee` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;姓名&#x27;</span>,<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户名&#x27;</span>,<br>  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;密码&#x27;</span>,<br>  `phone` <span class="hljs-type">varchar</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;手机号&#x27;</span>,<br>  `sex` <span class="hljs-type">varchar</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;性别&#x27;</span>,<br>  `id_number` <span class="hljs-type">varchar</span>(<span class="hljs-number">18</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;身份证号&#x27;</span>,<br>  `status` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;状态 0:禁用，1:启用&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  `update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;更新时间&#x27;</span>,<br>  `create_user` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建人&#x27;</span>,<br>  `update_user` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;修改人&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  <span class="hljs-keyword">UNIQUE</span> KEY `idx_username` (`username`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">2</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;员工信息&#x27;</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `employee` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;管理员&#x27;</span>,<span class="hljs-string">&#x27;admin&#x27;</span>,<span class="hljs-string">&#x27;123456&#x27;</span>,<span class="hljs-string">&#x27;13812312312&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;110101199001010047&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2022-02-15 15:51:20&#x27;</span>,<span class="hljs-string">&#x27;2022-02-17 09:16:20&#x27;</span>,<span class="hljs-number">10</span>,<span class="hljs-number">1</span>);<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `order_detail`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `order_detail` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;名字&#x27;</span>,<br>  `image` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;图片&#x27;</span>,<br>  `order_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单id&#x27;</span>,<br>  `dish_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品id&#x27;</span>,<br>  `setmeal_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;套餐id&#x27;</span>,<br>  `dish_flavor` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;口味&#x27;</span>,<br>  `number` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;数量&#x27;</span>,<br>  `amount` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;金额&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;订单明细表&#x27;</span>;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `orders`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `orders` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `number` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单号&#x27;</span>,<br>  `status` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消 7退款&#x27;</span>,<br>  `user_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;下单用户&#x27;</span>,<br>  `address_book_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;地址id&#x27;</span>,<br>  `order_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;下单时间&#x27;</span>,<br>  `checkout_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;结账时间&#x27;</span>,<br>  `pay_method` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;支付方式 1微信,2支付宝&#x27;</span>,<br>  `pay_status` tinyint <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;支付状态 0未支付 1已支付 2退款&#x27;</span>,<br>  `amount` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;实收金额&#x27;</span>,<br>  `remark` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;备注&#x27;</span>,<br>  `phone` <span class="hljs-type">varchar</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;手机号&#x27;</span>,<br>  `address` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;地址&#x27;</span>,<br>  `user_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户名称&#x27;</span>,<br>  `consignee` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人&#x27;</span>,<br>  `cancel_reason` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单取消原因&#x27;</span>,<br>  `rejection_reason` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单拒绝原因&#x27;</span>,<br>  `cancel_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单取消时间&#x27;</span>,<br>  `estimated_delivery_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;预计送达时间&#x27;</span>,<br>  `delivery_status` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;配送状态  1立即送出  0选择具体时间&#x27;</span>,<br>  `delivery_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;送达时间&#x27;</span>,<br>  `pack_amount` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;打包费&#x27;</span>,<br>  `tableware_number` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;餐具数量&#x27;</span>,<br>  `tableware_status` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;餐具数量状态  1按餐量提供  0选择具体数量&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;订单表&#x27;</span>;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `setmeal`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `setmeal` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `category_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品分类id&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;套餐名称&#x27;</span>,<br>  `price` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;套餐价格&#x27;</span>,<br>  `status` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;售卖状态 0:停售 1:起售&#x27;</span>,<br>  `description` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;描述信息&#x27;</span>,<br>  `image` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;图片&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  `update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;更新时间&#x27;</span>,<br>  `create_user` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建人&#x27;</span>,<br>  `update_user` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;修改人&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  <span class="hljs-keyword">UNIQUE</span> KEY `idx_setmeal_name` (`name`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">32</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;套餐&#x27;</span>;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `setmeal_dish`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `setmeal_dish` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `setmeal_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;套餐id&#x27;</span>,<br>  `dish_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品id&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品名称 （冗余字段）&#x27;</span>,<br>  `price` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品单价（冗余字段）&#x27;</span>,<br>  `copies` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品份数&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">47</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;套餐菜品关系&#x27;</span>;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `shopping_cart`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `shopping_cart` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品名称&#x27;</span>,<br>  `image` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;图片&#x27;</span>,<br>  `user_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `dish_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;菜品id&#x27;</span>,<br>  `setmeal_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;套餐id&#x27;</span>,<br>  `dish_flavor` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;口味&#x27;</span>,<br>  `number` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;数量&#x27;</span>,<br>  `amount` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;金额&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">9</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;购物车&#x27;</span>;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `<span class="hljs-keyword">user</span>`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>  `openid` <span class="hljs-type">varchar</span>(<span class="hljs-number">45</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;微信用户唯一标识&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;姓名&#x27;</span>,<br>  `phone` <span class="hljs-type">varchar</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;手机号&#x27;</span>,<br>  `sex` <span class="hljs-type">varchar</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;性别&#x27;</span>,<br>  `id_number` <span class="hljs-type">varchar</span>(<span class="hljs-number">18</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;身份证号&#x27;</span>,<br>  `avatar` <span class="hljs-type">varchar</span>(<span class="hljs-number">500</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;头像&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;用户信息&#x27;</span>;<br></code></pre></td></tr></table></figure><p><code>前后端联调</code></p><p>通过断点调试跟踪后端程序的执行过程</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221107110539832.png" alt="image-20221107110539832" style="zoom:67%;" /><p><code>nginx反向代理和负载均衡</code></p><p>前端发送的请求,如何请求到后端服务?</p><p>前端请求地址：<a href="http://localhost/api/employee/login">http://localhost/api/employee/login</a></p><p>后端接口地址：<a href="http://localhost:8080/admin/employee/login">http://localhost:8080/admin/employee/login</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221107152041371.png" alt="image-20221107152041371"></p><p><code>nginx反向代理</code></p><p>将前端发送的动态请求由nginx转发到后端服务器, 提供访问速度(走nginx缓存), 负载均衡(集群服务器),保证后端服务安全(隐藏后端服务地址)</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221107153808368.png" alt="image-20221107153808368" style="zoom:67%;" /><p><code>反向代理</code></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx">server&#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> localhost;<br>    <br>    <span class="hljs-section">location</span> /api/&#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://localhost:8080/admin/; <span class="hljs-comment">#反向代理</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>proxy_pass:  设置代理服务器地址; 当访问  <a href="http://localhost/api/xxx">http://localhost/api/xxx</a>,  反向代理到 <a href="http://localhost:8080/admin/xxx">http://localhost:8080/admin/xxx</a></p><p><code>负载均衡</code></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> webservers&#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.128:8080</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.129:8080</span>;<br>&#125;<br>server&#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> localhost;<br>    <br>    <span class="hljs-section">location</span> /api/&#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://webservers/admin;<span class="hljs-comment">#负载均衡</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>当访问  <a href="http://localhost/api/xxx">http://localhost/api/xxx</a>,  反向代理到 <a href="http://webservers/admin/xxx">http://webservers/admin/xxx</a>, 然后根据webservers寻找一台服务器, 根据负载均衡策略最终代理到 <a href="http://192.168.100.128:8080/admin/xxx">http://192.168.100.128:8080/admin/xxx</a> 或 <a href="http://192.168.100.129:8080/admin/xxx">http://192.168.100.129:8080/admin/xxx</a></p><blockquote><p>这里不一定非是 webservers, 保持一致即可</p></blockquote><p><code>负载均衡策略</code></p><table><thead><tr><th><strong>名称</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>轮询</td><td>默认方式</td></tr><tr><td>weight</td><td>权重方式，默认为1，权重越高，被分配的客户端请求就越多</td></tr><tr><td>ip_hash</td><td>依据ip分配方式，这样每个访客可以固定访问一个后端服务</td></tr><tr><td>least_conn</td><td>依据最少连接方式，把请求优先分配给连接数少的后端服务</td></tr><tr><td>url_hash</td><td>依据url分配方式，这样相同的url会被分配到同一个后端服务</td></tr><tr><td>fair</td><td>依据响应时间方式，响应时间短的服务将会被优先分配</td></tr></tbody></table><p><code>示例</code></p><p><strong>默认轮询</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> webservers&#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.128:8080</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.129:8080</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>weight</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> webservers&#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.128:8080</span> weight=<span class="hljs-number">90</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.129:8080</span> weight=<span class="hljs-number">10</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ip_hash</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> webservers&#123;<br>    ip_hash;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.128:8080</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.129:8080</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>least_conn</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> webservers&#123;<br>    least_conn;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.128:8080</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.129:8080</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>url_hash</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> webservers&#123;<br>    <span class="hljs-attribute">hash</span> &amp;request_uri;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.128:8080</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.129:8080</span>;<br>&#125;c<br></code></pre></td></tr></table></figure><p><strong>fair</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> webservers&#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.128:8080</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.100.129:8080</span>;<br>    fair;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>完善登录功能</code></p><blockquote><p>使用md5对密码加密存储</p></blockquote><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221107160739680.png" alt="image-20221107160739680" style="zoom: 80%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Employee <span class="hljs-title function_">login</span><span class="hljs-params">(EmployeeLoginDTO employeeLoginDTO)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> employeeLoginDTO.getUsername();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> employeeLoginDTO.getPassword();<br><br>        <span class="hljs-comment">//1、根据用户名查询数据库中的数据</span><br>        <span class="hljs-type">Employee</span> <span class="hljs-variable">employee</span> <span class="hljs-operator">=</span> employeeMapper.getByUsername(username);<br><br>        <span class="hljs-comment">//2、处理各种异常情况（用户名不存在、密码不对、账号被锁定）</span><br>        <span class="hljs-keyword">if</span> (employee == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//账号不存在</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountNotFoundException</span>(MessageConstant.ACCOUNT_NOT_FOUND);<br>        &#125;<br><br>        <span class="hljs-comment">// 进行md5加密，然后再进行比对</span><br>        password = DigestUtils.md5DigestAsHex(password.getBytes());<br><br>        <span class="hljs-keyword">if</span> (!password.equals(employee.getPassword())) &#123;<br>            <span class="hljs-comment">//密码错误</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PasswordErrorException</span>(MessageConstant.PASSWORD_ERROR);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (employee.getStatus() == StatusConstant.DISABLE) &#123;<br>            <span class="hljs-comment">//账号被锁定</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountLockedException</span>(MessageConstant.ACCOUNT_LOCKED);<br>        &#125;<br><br>        <span class="hljs-comment">//3、返回实体对象</span><br>        <span class="hljs-keyword">return</span> employee;<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="导入接口文档"><a href="#导入接口文档" class="headerlink" title="导入接口文档"></a>导入接口文档</h2><p><code>前后端开发流程</code></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221107181446913.png" alt="image-20221107181446913" style="zoom:67%;" /><ol><li>定义接口, 确定接口的路径, 请求方式, 传入参数, 返回参数</li><li>前端和后端一起开发, 同时, 也可以自行测试</li><li>提交给测试人员做最终测试</li></ol><p><code>YApi</code></p><p><a href="http://yapi.smart-xwork.cn/">http://yapi.smart-xwork.cn/</a></p><p>导入JSON接口, 后面根据接口文档开发</p><h2 id="Swagger"><a href="#Swagger" class="headerlink" title="Swagger"></a>Swagger</h2><p>生成可视化Restful风格的Web服务 <a href="https://swagger.io/">https://swagger.io/</a></p><ol><li>前后端分离开发更加方便</li><li>接口文档在线自动生成</li></ol><p>Knife4j 是 swagger 的加强版</p><ol><li>导入依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>配置类</li></ol><p>WebMvcConfiguration.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过knife4j生成接口文档</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">docket</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ApiInfo</span> <span class="hljs-variable">apiInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()<br>                .title(<span class="hljs-string">&quot;苍穹外卖项目接口文档&quot;</span>)<br>                .version(<span class="hljs-string">&quot;2.0&quot;</span>)<br>                .description(<span class="hljs-string">&quot;苍穹外卖项目接口文档&quot;</span>)<br>                .build();<br>        <span class="hljs-type">Docket</span> <span class="hljs-variable">docket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(apiInfo)<br>                .select()<br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.sky.controller&quot;</span>))<br>                .paths(PathSelectors.any())<br>                .build();<br>        <span class="hljs-keyword">return</span> docket;<br>    &#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>静态资源映射</li></ol><p>WebMvcConfiguration.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 设置静态资源映射</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> registry</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addResourceHandlers</span><span class="hljs-params">(ResourceHandlerRegistry registry)</span> &#123;<br>       registry.addResourceHandler(<span class="hljs-string">&quot;/doc.html&quot;</span>).addResourceLocations(<span class="hljs-string">&quot;classpath:/META-INF/resources/&quot;</span>);<br>       registry.addResourceHandler(<span class="hljs-string">&quot;/webjars/**&quot;</span>).addResourceLocations(<span class="hljs-string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>访问</li></ol><p>接口文档访问路径为: <a href="http://ip:port/doc.html">http://ip:port/doc.html</a>  -&gt;   <a href="http://localhost:8080/doc.html">http://localhost:8080/doc.html</a></p><p><code>Yapi 和 Swagger的区别</code></p><ol><li>Yapi是设计阶段的工具, 用来管理和维护接口</li><li>Swagger是开发阶段使用的框架, 帮助后端做后端的接口测试</li></ol><p><code>Swagger注解</code></p><table><thead><tr><th><strong>注解</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>@Api</td><td>用在类上，例如<code>Controller</code>，表示对类的说明</td></tr><tr><td>@ApiModel</td><td>用在类上，例如<code>entity、DTO、VO</code></td></tr><tr><td>@ApiModelProperty</td><td>用在<code>属性</code>上，描述属性信息</td></tr><tr><td>@ApiOperation</td><td>用在<code>方法</code>上，例如Controller的方法，说明方法的用途、作用</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(description = &quot;员工登录时传递的数据模型&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeeLoginDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;用户名&quot;)</span><br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;密码&quot;)</span><br>    <span class="hljs-keyword">private</span> String password;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@ApiModel(description = &quot;员工登录返回的数据格式&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeeLoginVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;主键值&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;用户名&quot;)</span><br>    <span class="hljs-keyword">private</span> String userName;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;姓名&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;jwt令牌&quot;)</span><br>    <span class="hljs-keyword">private</span> String token;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@ApiModel(description = &quot;员工登录返回的数据格式&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeeLoginVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;主键值&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;用户名&quot;)</span><br>    <span class="hljs-keyword">private</span> String userName;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;姓名&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;jwt令牌&quot;)</span><br>    <span class="hljs-keyword">private</span> String token;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="day02"><a href="#day02" class="headerlink" title="day02"></a>day02</h1><h2 id="新增员工"><a href="#新增员工" class="headerlink" title="新增员工"></a>新增员工</h2><blockquote><p>当前端提交的数据和实体类对应属性差别比较大时, 建议使用<strong>DTO</strong>来封装数据</p></blockquote><p><strong>EmployeeDTO</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.dto;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeeDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">private</span> String phone;<br><br>    <span class="hljs-keyword">private</span> String sex;<br><br>    <span class="hljs-keyword">private</span> String idNumber;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Controller 层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增员工</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;新增员工&quot;)</span><br><span class="hljs-meta">@PostMapping</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> EmployeeDTO employeeDTO)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;新增员工：&#123;&#125;&quot;</span>, employeeDTO);<br>    employeeService.save(employeeDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Service层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增员工</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employeeDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(EmployeeDTO employeeDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增员工</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employeeDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(EmployeeDTO employeeDTO)</span> &#123;<br>    <span class="hljs-comment">// 1.数据拷贝 EmployeeDTO -&gt; Employee</span><br>    <span class="hljs-type">Employee</span> <span class="hljs-variable">employee</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>();<br>    BeanUtils.copyProperties(employeeDTO, employee);<br>    <span class="hljs-comment">// 2.补全 Employee 数据</span><br>    <span class="hljs-comment">// 2.1.默认密码123456</span><br>    employee.setPassword(DigestUtils.md5DigestAsHex(DEFAULT_PASSWORD.getBytes()));<br>    <span class="hljs-comment">// 2.2.默认状态 开启(1)</span><br>    employee.setStatus(ENABLE);<br>    <span class="hljs-comment">// 2.3.默认时间now, 默认user - admin(id)</span><br>    employee.setCreateTime(LocalDateTime.now());<br>    employee.setUpdateTime(LocalDateTime.now());<br>    employee.setCreateUser(<span class="hljs-number">1L</span>);<br>    employee.setUpdateUser(<span class="hljs-number">1L</span>);<br>    <span class="hljs-comment">// 3.插入数据库数据</span><br>    employeeMapper.insert(employee);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Mapper层</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增员工</span><br><span class="hljs-comment"> * @param employee</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">@Insert</span>(&quot;insert into employee(username, name, phone, sex, id_number, password, status, create_time, update_time, create_user, update_user) values (#&#123;username&#125;, #&#123;name&#125;, #&#123;phone&#125;, #&#123;sex&#125;, #&#123;idNumber&#125;, #&#123;password&#125;, #&#123;status&#125;, #&#123;createTime&#125;, #&#123;updateTime&#125;, #&#123;createUser&#125;, #&#123;updateUser&#125;)&quot;)<br>void <span class="hljs-keyword">insert</span>(Employee employee);<br></code></pre></td></tr></table></figure><blockquote><ol><li>注意: 使用swagger调试时, 应该在登录获得一个全局参数添加到文档管理-&gt;全局参数设置</li></ol><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231206210155964.png" alt="image-20231206210155964"></p><ol start="2"><li>重复插入username(唯一约束)相同的数据,  报错:</li></ol><p><code>java.sql.SQLIntegrityConstraintViolationException: Duplicate entry &#39;小智&#39; for key &#39;idx_username&#39;</code></p><p>解决: 定义全局异常处理器来处理</p><p>GlobalExceptionHandler.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 处理SQL异常</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ex</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ExceptionHandler</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">exceptionHandler</span><span class="hljs-params">(SQLIntegrityConstraintViolationException ex)</span>&#123;<br>    <span class="hljs-comment">//message =&gt; Duplicate entry &#x27;小智&#x27; for key &#x27;idx_username</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> ex.getMessage();<br>    <span class="hljs-keyword">if</span> (message.contains(<span class="hljs-string">&quot;Duplicate entry&quot;</span>))&#123;<br>        <span class="hljs-comment">// 空格切割</span><br>        String[] split = message.split(<span class="hljs-string">&quot; &quot;</span>);<br>        <span class="hljs-comment">// 取出 &#x27;小智&#x27;</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> split[<span class="hljs-number">2</span>];<br>        <span class="hljs-comment">// &#x27;小智&#x27;已存在</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> username + ALREADY_EXISTS;<br>        <span class="hljs-keyword">return</span> Result.error(msg);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 未知错误</span><br>        <span class="hljs-keyword">return</span> Result.error(UNKNOWN_ERROR);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>employee.setCreateUser(1L);employee.setUpdateUser(1L);    id不能是固定值</li></ol><p><code>在JwtTokenAdminInterceptor中获取当前  empId</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    log.info(<span class="hljs-string">&quot;jwt校验:&#123;&#125;&quot;</span>, token);<br>    <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());<br>    log.info(<span class="hljs-string">&quot;当前员工id：&quot;</span>, empId);  &lt;------------------- id  通过ThreadLocal进行传递<br>    <span class="hljs-comment">//3、通过，放行</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>    <span class="hljs-comment">//4、不通过，响应401状态码</span><br>    response.setStatus(<span class="hljs-number">401</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ThreadLocal</strong></p><p>Thread的局部变量, 为<code>每个线程</code>提供单独一份<code>存储空间</code>, 具有<code>线程隔离</code>效果, 只有同一个线程才能获取对应的值, 线程外不能访问</p><p>方法API</p><ul><li>public void set(T value) 设置当前线程的线程局部变量的值</li><li>public T get() 返回当前线程所对应的线程局部变量的值</li><li>public void remove()        移除当前线程的线程局部变量</li></ul><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221111212349365.png" alt="image-20221111212349365" style="zoom:67%;" /><p><strong>ThreadLocal工具类</strong></p><p>sky-common</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.context;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseContext</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Long&gt; threadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCurrentId</span><span class="hljs-params">(Long id)</span> &#123;<br>        threadLocal.set(id);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Long <span class="hljs-title function_">getCurrentId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> threadLocal.get();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeCurrentId</span><span class="hljs-params">()</span> &#123;<br>        threadLocal.remove();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>修改JwtTokenAdminInterceptor逻辑</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//2、校验令牌</span><br><span class="hljs-keyword">try</span> &#123;<br>    log.info(<span class="hljs-string">&quot;jwt校验:&#123;&#125;&quot;</span>, token);<br>    <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());<br>    log.info(<span class="hljs-string">&quot;当前员工id：&quot;</span>, empId);<br><br>    <span class="hljs-comment">//3.将用户id存储到ThreadLocal</span><br>    BaseContext.setCurrentId(empId);<br><br>    <span class="hljs-comment">//4、通过，放行</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>    <span class="hljs-comment">//5、不通过，响应401状态码</span><br>    response.setStatus(<span class="hljs-number">401</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>EmployeeServiceImpl</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增员工</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employeeDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(EmployeeDTO employeeDTO)</span> &#123;<br>    <span class="hljs-comment">// 1.数据拷贝 EmployeeDTO -&gt; Employee</span><br>    <span class="hljs-type">Employee</span> <span class="hljs-variable">employee</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>();<br>    BeanUtils.copyProperties(employeeDTO, employee);<br>    <span class="hljs-comment">// 2.补全 Employee 数据</span><br>    <span class="hljs-comment">// 2.1.默认密码123456</span><br>    employee.setPassword(DigestUtils.md5DigestAsHex(DEFAULT_PASSWORD.getBytes()));<br>    <span class="hljs-comment">// 2.2.默认状态 开启(1)</span><br>    employee.setStatus(ENABLE);<br>    <span class="hljs-comment">// 2.3.默认时间now, 默认user - admin(id)</span><br>    employee.setCreateTime(LocalDateTime.now());<br>    employee.setUpdateTime(LocalDateTime.now());<br>    <span class="hljs-comment">/*employee.setCreateUser(1L);</span><br><span class="hljs-comment">    employee.setUpdateUser(1L);*/</span><br>    employee.setCreateUser(BaseContext.getCurrentId());<br>    employee.setUpdateUser(BaseContext.getCurrentId());<br>    <span class="hljs-comment">// 3.插入数据库数据</span><br>    employeeMapper.insert(employee);<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h2 id="退出登录"><a href="#退出登录" class="headerlink" title="退出登录"></a>退出登录</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 退出</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(&quot;/logout&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;退出登录&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">logout</span><span class="hljs-params">()</span> &#123;<br>    log.info(<span class="hljs-string">&quot;退出登录&quot;</span>);<br>    BaseContext.removeCurrentId();<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="员工分页查询"><a href="#员工分页查询" class="headerlink" title="员工分页查询"></a>员工分页查询</h2><p><strong>EmployeePageQueryDTO</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.dto;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeePageQueryDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//员工姓名</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">//页码</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> page;<br><br>    <span class="hljs-comment">//每页显示记录数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> pageSize;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>PageResult</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.result;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 封装分页查询结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PageResult</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> total; <span class="hljs-comment">//总记录数</span><br><br>    <span class="hljs-keyword">private</span> List records; <span class="hljs-comment">//当前页数据集合</span><br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>controller层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 员工分页查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employeePageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;员工分页查询&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/page&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;PageResult&gt; <span class="hljs-title function_">page</span><span class="hljs-params">(EmployeePageQueryDTO employeePageQueryDTO)</span>&#123;<br>    <span class="hljs-type">PageResult</span> <span class="hljs-variable">pageResult</span> <span class="hljs-operator">=</span> employeeService.pageQuery(employeePageQueryDTO);<br>    <span class="hljs-keyword">return</span> Result.success(pageResult);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 员工分页查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employeePageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>PageResult <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(EmployeePageQueryDTO employeePageQueryDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 员工分页查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employeePageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PageResult <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(EmployeePageQueryDTO employeePageQueryDTO)</span> &#123;<br>    <span class="hljs-comment">// 开始分页查询  xxx.(pageNum  pageSize)</span><br>    PageHelper.startPage(employeePageQueryDTO.getPage(), employeePageQueryDTO.getPageSize());<br>    <span class="hljs-comment">// mapper : select * from employee (where name = #&#123;name&#125;) 需要动态SQL</span><br>    Page&lt;Employee&gt; page = employeeMapper.pageQuery(employeePageQueryDTO);<br>    <span class="hljs-comment">// 获得 total(总条数) records(数据)</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> page.getTotal();<br>    List&lt;Employee&gt; records = page.getResult();<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>(total, records);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 员工分页查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employeePageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Page&lt;Employee&gt; <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(EmployeePageQueryDTO employeePageQueryDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.sky.mapper.EmployeeMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pageQuery&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.sky.entity.Employee&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.dto.EmployeePageQueryDTO&quot;</span>&gt;</span><br>        select * from employee<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--判断要全面, 空字符串也不行--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span><br>                name like concat(&#x27;%&#x27;, #&#123;name&#125;, &#x27;%&#x27;)<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>时间格式问题</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231206215622845.png" alt="image-20231206215622845"></p><ol><li><p>在对应属性加注解(麻烦)</p><p>Employee.java</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="hljs-keyword">private</span> LocalDateTime createTime;<br><br><span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="hljs-keyword">private</span> LocalDateTime updateTime;<br></code></pre></td></tr></table></figure><ol start="2"><li>扩展消息转换器, 统一对日期类型进行格式处理</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 扩展Spring MVC框架的消息转换器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> converters</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">extendMessageConverters</span><span class="hljs-params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;扩展消息转换器&quot;</span>);<br>    <span class="hljs-comment">// 1.创建消息转换器对象</span><br>    <span class="hljs-type">MappingJackson2HttpMessageConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MappingJackson2HttpMessageConverter</span>();<br>    <span class="hljs-comment">// 2.为消息转换器对象设置一个对象转换器, 对象转换器可以将java对象序列化成json数据</span><br>    converter.setObjectMapper(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JacksonObjectMapper</span>());<br>    <span class="hljs-comment">// 3.将自己的消息转换器加入容器</span><br>    converters.add(<span class="hljs-number">0</span>, converter);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>定义序列化器</strong></p><p>sky-common</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.json;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.DeserializationFeature;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.<span class="hljs-keyword">module</span>.SimpleModule;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateDeserializer;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalTimeDeserializer;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateSerializer;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalTimeSerializer;<br><br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.LocalTime;<br><span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 对象映射器:基于jackson将Java对象转为json，或者将json转为Java对象</span><br><span class="hljs-comment"> * 将JSON解析为Java对象的过程称为 [从JSON反序列化Java对象]</span><br><span class="hljs-comment"> * 从Java对象生成JSON的过程称为 [序列化Java对象到JSON]</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JacksonObjectMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectMapper</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_DATE_FORMAT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>;<br>    <span class="hljs-comment">//public static final String DEFAULT_DATE_TIME_FORMAT = &quot;yyyy-MM-dd HH:mm:ss&quot;;</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_DATE_TIME_FORMAT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yyyy-MM-dd HH:mm&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_TIME_FORMAT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HH:mm:ss&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JacksonObjectMapper</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-comment">//收到未知属性时不报异常</span><br>        <span class="hljs-built_in">this</span>.configure(FAIL_ON_UNKNOWN_PROPERTIES, <span class="hljs-literal">false</span>);<br><br>        <span class="hljs-comment">//反序列化时，属性不存在的兼容处理</span><br>        <span class="hljs-built_in">this</span>.getDeserializationConfig().withoutFeatures(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);<br><br>        <span class="hljs-type">SimpleModule</span> <span class="hljs-variable">simpleModule</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleModule</span>()<br>                .addDeserializer(LocalDateTime.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalDateTimeDeserializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)))<br>                .addDeserializer(LocalDate.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalDateDeserializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)))<br>                .addDeserializer(LocalTime.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalTimeDeserializer</span>(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)))<br>                .addSerializer(LocalDateTime.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalDateTimeSerializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)))<br>                .addSerializer(LocalDate.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalDateSerializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)))<br>                .addSerializer(LocalTime.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalTimeSerializer</span>(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));<br><br>        <span class="hljs-comment">//注册功能模块 例如，可以添加自定义序列化器和反序列化器</span><br>        <span class="hljs-built_in">this</span>.registerModule(simpleModule);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="启用禁用员工"><a href="#启用禁用员工" class="headerlink" title="启用禁用员工"></a>启用禁用员工</h2><p><strong>controller层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 启用、禁用员工账号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;启用、禁用员工账号&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer status, Long id)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;启用、禁用员工账号=&gt; status:&#123;&#125;, id:&#123;&#125;&quot;</span>, status, id);<br>    employeeService.startOrStop(status, id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 启用、禁用员工账号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(Integer status, Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 启用、禁用员工账号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(Integer status, Long id)</span> &#123;<br>    <span class="hljs-type">Employee</span> <span class="hljs-variable">employee</span> <span class="hljs-operator">=</span> Employee.builder().status(status).id(id).build();<br>    employeeMapper.update(employee);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 编辑员工</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employee</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Employee employee)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.entity.Employee&quot;</span>&gt;</span><br>        update employee<br>            <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;username != null&quot;</span>&gt;</span>username=#&#123;username&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;password != null&quot;</span>&gt;</span>password=#&#123;password&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;name != null&quot;</span>&gt;</span>name=#&#123;name&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phone != null&quot;</span>&gt;</span>phone=#&#123;phone&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;sex != null&quot;</span>&gt;</span>sex=#&#123;sex&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;idNumber != null&quot;</span>&gt;</span>id_Number=#&#123;idNumber&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span>status=#&#123;status&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateTime != null&quot;</span>&gt;</span>update_Time=#&#123;updateTime&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateUser != null&quot;</span>&gt;</span>update_User=#&#123;updateUser&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>        where id=#&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="编辑员工"><a href="#编辑员工" class="headerlink" title="编辑员工"></a>编辑员工</h2><p><strong>controller层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 编辑员工信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employeeDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;编辑员工信息&quot;)</span><br><span class="hljs-meta">@PutMapping</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> EmployeeDTO employeeDTO)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;编辑员工信息:&#123;&#125;&quot;</span>, employeeDTO);<br>    employeeService.update(employeeDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 编辑员工信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employeeDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(EmployeeDTO employeeDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 编辑员工信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employeeDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(EmployeeDTO employeeDTO)</span> &#123;<br>    <span class="hljs-type">Employee</span> <span class="hljs-variable">employee</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>();<br>    BeanUtils.copyProperties(employeeDTO, employee);<br>    employee.setUpdateUser(BaseContext.getCurrentId());<br>    employee.setUpdateTime(LocalDateTime.now());<br>    employeeMapper.update(employee);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper层</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 编辑员工</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employee</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Employee employee)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.entity.Employee&quot;</span>&gt;</span><br>    update employee<br>        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;username != null&quot;</span>&gt;</span>username=#&#123;username&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;password != null&quot;</span>&gt;</span>password=#&#123;password&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;name != null&quot;</span>&gt;</span>name=#&#123;name&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phone != null&quot;</span>&gt;</span>phone=#&#123;phone&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;sex != null&quot;</span>&gt;</span>sex=#&#123;sex&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;idNumber != null&quot;</span>&gt;</span>id_Number=#&#123;idNumber&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span>status=#&#123;status&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateTime != null&quot;</span>&gt;</span>update_Time=#&#123;updateTime&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateUser != null&quot;</span>&gt;</span>update_User=#&#123;updateUser&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>    where id=#&#123;id&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="导入分类模块代码"><a href="#导入分类模块代码" class="headerlink" title="导入分类模块代码"></a>导入分类模块代码</h2><p><strong>业务规则</strong></p><ol><li>分类名称唯一</li><li>分类有两个分支:  菜品分类和套餐分类</li><li>新添加的分类默认为  禁用</li></ol><p><strong>接口设计</strong></p><ol><li>新增分类</li><li>分类分页查询</li><li>根据id删除分类</li><li>修改分类</li><li>启用禁用分类</li><li>根据类型查询分类</li></ol><p><strong>表设计</strong></p><table><thead><tr><th><strong>字段名</strong></th><th><strong>数据类型</strong></th><th><strong>说明</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td>id</td><td>bigint</td><td>主键</td><td>自增</td></tr><tr><td>name</td><td>varchar(32)</td><td>分类名称</td><td>唯一</td></tr><tr><td>type</td><td>int</td><td>分类类型</td><td>1菜品分类 2套餐分类</td></tr><tr><td>sort</td><td>int</td><td>排序字段</td><td>用于分类数据的排序</td></tr><tr><td>status</td><td>int</td><td>状态</td><td>1启用 0禁用</td></tr><tr><td>create_time</td><td>datetime</td><td>创建时间</td><td></td></tr><tr><td>update_time</td><td>datetime</td><td>最后修改时间</td><td></td></tr><tr><td>create_user</td><td>bigint</td><td>创建人id</td><td></td></tr><tr><td>update_user</td><td>bigint</td><td>最后修改人id</td><td></td></tr></tbody></table><p><strong>代码导入</strong></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221112164259732.png" alt="image-20221112164259732"/><h1 id="day03"><a href="#day03" class="headerlink" title="day03"></a>day03</h1><h2 id="公共字段填充"><a href="#公共字段填充" class="headerlink" title="公共字段填充"></a>公共字段填充</h2><p>在service逻辑中需要手动设置时间和用户id, 这些逻辑是固定的: </p><ol><li><p>在新增数据时, 将createTime、updateTime 设置为当前时间, createUser、updateUser设置为当前登录用户ID。</p></li><li><p>在更新数据时, 将updateTime 设置为当前时间, updateUser设置为当前登录用户ID。</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">employee.setCreateTime(LocalDateTime.now());<br>employee.setUpdateTime(LocalDateTime.now());<br>employee.setCreateUser(BaseContext.getCurrentId());<br>employee.setUpdateUser(BaseContext.getCurrentId());<br></code></pre></td></tr></table></figure><blockquote><p>用AOP切面编程,完成公共字段的自动填充</p></blockquote><p><strong>步骤</strong></p><ol><li><p>自定义<code>注解</code>, 标识需要aop的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义注解, 用于标识某个方法需要进行字段`自动填充`处理</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Target(ElementType.METHOD)</span> <span class="hljs-comment">// 作用范围:方法</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span> <span class="hljs-comment">// 信息保留在.class文件</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> AutoFill &#123;<br>    <span class="hljs-comment">//数据库操作类型enum : INSERT UPDATE</span><br>    OperationType <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 数据库操作类型</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OperationType</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新操作</span><br><span class="hljs-comment">     */</span><br>    UPDATE,<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 插入操作</span><br><span class="hljs-comment">     */</span><br>    INSERT<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>自定义<code>切面</code>, 统一拦截标识的<code>方法</code>, 通过<code>反射</code>填充公共字段</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义切面，实现公共字段自动填充处理逻辑</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/7 14:53</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoFillAspect</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 切入点</span><br><span class="hljs-comment">     * 在mapper包且有<span class="hljs-doctag">@AutoFill</span>条件切入</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Pointcut(&quot;execution(* com.sky.mapper.*.*(..)) &amp;&amp; @annotation(com.sky.annotation.AutoFill)&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoFillPointCut</span><span class="hljs-params">()</span>&#123;&#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 前置通知,在通知中进行公共字段的赋值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> joinPoint</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Before(&quot;autoFillPointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoFill</span><span class="hljs-params">(JoinPoint joinPoint)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;开始进行公共字段自动填充...&quot;</span>);<br>        <span class="hljs-comment">// 获取被拦截方法的数据库操作类型</span><br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<span class="hljs-comment">// 方法签名对象</span><br>        <span class="hljs-type">AutoFill</span> <span class="hljs-variable">autoFill</span> <span class="hljs-operator">=</span> signature.getMethod().getAnnotation(AutoFill.class);<span class="hljs-comment">// 方法注解对象</span><br>        <span class="hljs-type">OperationType</span> <span class="hljs-variable">operationType</span> <span class="hljs-operator">=</span> autoFill.value();<span class="hljs-comment">// 获得数据库操作类型</span><br>        <span class="hljs-comment">// 获取当前被拦截的方法的参数 -- 实体对象</span><br>        Object[] args = joinPoint.getArgs();<br>        <span class="hljs-keyword">if</span> (args==<span class="hljs-literal">null</span> || args.length==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 获得sql方法的第一个参数, 这里只有一个参数: 实体类</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">0</span>];<br>        <span class="hljs-comment">// 准备赋值数据</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br>        <span class="hljs-comment">// 根据不同的操作类型, 为对应属性通过反射来赋值</span><br>        <span class="hljs-keyword">if</span> (operationType == INSERT)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 4个字段赋值</span><br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setCreateTime</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_CREATE_TIME, LocalDateTime.class);<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setUpdateTime</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_UPDATE_TIME, LocalDateTime.class);<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setCreateUser</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_CREATE_USER, Long.class);<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setUpdateUser</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_UPDATE_USER, Long.class);<br>                <span class="hljs-comment">// 通过反射为对象属性赋值</span><br>                setCreateTime.invoke(entity, now);<br>                setUpdateTime.invoke(entity, now);<br>                setCreateUser.invoke(entity, empId);<br>                setUpdateUser.invoke(entity, empId);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operationType == OperationType.UPDATE) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 2个字段赋值</span><br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setUpdateTime</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_UPDATE_TIME, LocalDateTime.class);<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">setUpdateUser</span> <span class="hljs-operator">=</span> entity.getClass().getDeclaredMethod(SET_UPDATE_USER, Long.class);<br>                <span class="hljs-comment">// 通过反射为对象属性赋值</span><br>                setUpdateTime.invoke(entity, now);<br>                setUpdateUser.invoke(entity, empId);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在mapper中对应方法加入<code>注解</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增员工</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> employee</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@AutoFill(INSERT)</span><br><span class="hljs-meta">@Insert(&quot;insert into employee(username, name, phone, sex, id_number, password, status, create_time, update_time, create_user, update_user) values (#&#123;username&#125;, #&#123;name&#125;, #&#123;phone&#125;, #&#123;sex&#125;, #&#123;idNumber&#125;, #&#123;password&#125;, #&#123;status&#125;, #&#123;createTime&#125;, #&#123;updateTime&#125;, #&#123;createUser&#125;, #&#123;updateUser&#125;)&quot;)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Employee employee)</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 编辑员工</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> employee</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@AutoFill(UPDATE)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Employee employee)</span>;<br></code></pre></td></tr></table></figure></li></ol><p>技术: 枚举, 注解, aop, 反射</p><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><blockquote><p>新增菜品需要上传菜品对应的图片, 需要实现通用文件上传接口</p><p>使用OSS服务进行文件存储</p></blockquote><ol><li>定义OSS配置</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">alioss:</span><br>  <span class="hljs-attr">endpoint:</span> <span class="hljs-string">oss-cn-beijing.aliyuncs.com</span><br>  <span class="hljs-attr">access-key-id:</span> <span class="hljs-string">LTAI5tS29pxXXphPTxRg3EDo</span><br>  <span class="hljs-attr">access-key-secret:</span> <span class="hljs-string">J58e7LZSAEb63cajvwRlQmjJYEJNiH</span><br>  <span class="hljs-attr">bucket-name:</span> <span class="hljs-string">fgj2</span><br></code></pre></td></tr></table></figure><ol start="2"><li>接收oss参数</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(&quot;sky.alioss&quot;)</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AliOssProperties</span> &#123;<br>    <span class="hljs-keyword">private</span> String endpoint;<br>    <span class="hljs-keyword">private</span> String accessKeyId;<br>    <span class="hljs-keyword">private</span> String accessKeySecret;<br>    <span class="hljs-keyword">private</span> String bucketName;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>文件上传工具类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OssConfiguration</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean</span> <span class="hljs-comment">// 这个bean初始化依赖于另一个bean(AliOssProperties)</span><br>    <span class="hljs-keyword">public</span> AliOssUtil <span class="hljs-title function_">aliOssUtil</span><span class="hljs-params">(AliOssProperties aliOssProperties)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;开始创建阿里云文件上传工具类对象&#123;&#125;&quot;</span>, aliOssProperties);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AliOssUtil</span>(aliOssProperties.getEndpoint(),<br>                aliOssProperties.getAccessKeyId(),<br>                aliOssProperties.getAccessKeySecret(),<br>                aliOssProperties.getBucketName());<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AliOssUtil</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String endpoint;<br>    <span class="hljs-keyword">private</span> String accessKeyId;<br>    <span class="hljs-keyword">private</span> String accessKeySecret;<br>    <span class="hljs-keyword">private</span> String bucketName;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文件上传</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bytes</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> objectName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes, String objectName)</span> &#123;<br><br>        <span class="hljs-comment">// 创建OSSClient实例。</span><br>        <span class="hljs-type">OSS</span> <span class="hljs-variable">ossClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 创建PutObject请求。</span><br>            ossClient.putObject(bucketName, objectName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes));<br>        &#125; <span class="hljs-keyword">catch</span> (OSSException oe) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Caught an OSSException, which means your request made it to OSS, &quot;</span><br>                    + <span class="hljs-string">&quot;but was rejected with an error response for some reason.&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;Error Message:&quot;</span> + oe.getErrorMessage());<br>            System.out.println(<span class="hljs-string">&quot;Error Code:&quot;</span> + oe.getErrorCode());<br>            System.out.println(<span class="hljs-string">&quot;Request ID:&quot;</span> + oe.getRequestId());<br>            System.out.println(<span class="hljs-string">&quot;Host ID:&quot;</span> + oe.getHostId());<br>        &#125; <span class="hljs-keyword">catch</span> (ClientException ce) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Caught an ClientException, which means the client encountered &quot;</span><br>                    + <span class="hljs-string">&quot;a serious internal problem while trying to communicate with OSS, &quot;</span><br>                    + <span class="hljs-string">&quot;such as not being able to access the network.&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;Error Message:&quot;</span> + ce.getMessage());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (ossClient != <span class="hljs-literal">null</span>) &#123;<br>                ossClient.shutdown();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//文件访问路径规则 https://BucketName.Endpoint/ObjectName</span><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;https://&quot;</span>);<br>        stringBuilder<br>                .append(bucketName)<br>                .append(<span class="hljs-string">&quot;.&quot;</span>)<br>                .append(endpoint)<br>                .append(<span class="hljs-string">&quot;/&quot;</span>)<br>                .append(objectName);<br><br>        log.info(<span class="hljs-string">&quot;文件上传到:&#123;&#125;&quot;</span>, stringBuilder.toString());<br><br>        <span class="hljs-keyword">return</span> stringBuilder.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>接口定义</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/common&quot;)</span><br><span class="hljs-meta">@Api(&quot;通用接口&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AliOssUtil aliOssUtil;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/upload&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;文件上传&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">upload</span><span class="hljs-params">(MultipartFile file)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;文件上传:&#123;&#125;&quot;</span>, file);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 原始文件名</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br>            <span class="hljs-comment">// 截取后缀</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>            <span class="hljs-comment">// 构造新文件名字</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString() + extension;<br>            <span class="hljs-comment">// 文件请求路径</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> aliOssUtil.upload(file.getBytes(), objectName);<br>            <span class="hljs-keyword">return</span> Result.success(filePath);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(<span class="hljs-string">&quot;文件上传失败:&#123;&#125;&quot;</span>, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> Result.error(UPLOAD_FAILED);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="新增菜品"><a href="#新增菜品" class="headerlink" title="新增菜品"></a>新增菜品</h2><p>新增菜品, 添加菜品和口味, 需要操作两张表</p><table><thead><tr><th>表名</th><th>说明</th></tr></thead><tbody><tr><td>dish</td><td>菜品表</td></tr><tr><td>dish_flavor</td><td>菜品口味表</td></tr></tbody></table><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/7 15:26</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/dish&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;菜品相关接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DishController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DishService dishService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增菜品</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dishDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-meta">@ApiOperation(&quot;新增菜品&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> DishDTO dishDTO)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;新增菜品:&#123;&#125;&quot;</span>, dishDTO);<br>        dishService.saveWithFlavor(dishDTO);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/7 16:21</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DishService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增菜品</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dishDTO</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveWithFlavor</span><span class="hljs-params">(DishDTO dishDTO)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DishServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DishService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> DishMapper dishMapper;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> DishFlavorMapper dishFlavorMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增菜品和对应的口味</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dishDTO</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveWithFlavor</span><span class="hljs-params">(DishDTO dishDTO)</span> &#123;<br>        <span class="hljs-comment">// 1.新增菜品</span><br>        <span class="hljs-type">Dish</span> <span class="hljs-variable">dish</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dish</span>();<br>        BeanUtils.copyProperties(dishDTO, dish);<br>        dishMapper.insert(dish);<br><br>        <span class="hljs-comment">// dishId 为null, 只能到数据库查了</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">dishId</span> <span class="hljs-operator">=</span> dishMapper.getDishId(dish.getImage());<br><br>        <span class="hljs-comment">// 2.新增口味</span><br>        List&lt;DishFlavor&gt; flavors = dishDTO.getFlavors();<br>        <span class="hljs-keyword">if</span> (flavors!=<span class="hljs-literal">null</span> &amp;&amp; flavors.size()&gt;<span class="hljs-number">0</span>) &#123;<br>            flavors.forEach(flavor -&gt; flavor.setDishId(dishId));<br>        &#125;<br>        dishFlavorMapper.insertBatch(flavors);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.mapper;<br><br><span class="hljs-keyword">import</span> com.sky.annotation.AutoFill;<br><span class="hljs-keyword">import</span> com.sky.entity.Dish;<br><span class="hljs-keyword">import</span> com.sky.enumeration.OperationType;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Insert;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Select;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.sky.enumeration.OperationType.INSERT;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DishMapper</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据分类id查询菜品数量</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> categoryId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Select(&quot;select count(id) from dish where category_id = #&#123;categoryId&#125;&quot;)</span><br>    Integer <span class="hljs-title function_">countByCategoryId</span><span class="hljs-params">(Long categoryId)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增菜品</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dish</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@AutoFill(INSERT)</span><br>    <span class="hljs-meta">@Insert(&quot;insert into dish(name, category_id, price, image, description, create_time, update_time, create_user, update_user, status) values  (#&#123;name&#125;, #&#123;categoryId&#125;, #&#123;price&#125;, #&#123;image&#125;, #&#123;description&#125;, #&#123;createTime&#125;, #&#123;updateTime&#125;, #&#123;createUser&#125;, #&#123;updateUser&#125;, #&#123;status&#125;)&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Dish dish)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查找菜品Id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> image</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Select(&quot;select id from dish where image=#&#123;image&#125;&quot;)</span><br>    Long <span class="hljs-title function_">getDishId</span><span class="hljs-params">(String image)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.mapper;<br><br><span class="hljs-keyword">import</span> com.sky.entity.DishFlavor;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/7 16:24</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DishFlavorMapper</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 批量插入口味数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> flavors</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertBatch</span><span class="hljs-params">(List&lt;DishFlavor&gt; flavors)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="菜品分页查询"><a href="#菜品分页查询" class="headerlink" title="菜品分页查询"></a>菜品分页查询</h2><p><strong>DTO</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.dto;<br><br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(&quot;菜品分页时传递的数据模型&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DishPageQueryDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;页码&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> page;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;每页条数&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> pageSize;<br><br>    <span class="hljs-meta">@ApiModelProperty(&quot;菜品名称&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">//分类id</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;分类id&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer categoryId;<br><br>    <span class="hljs-comment">//状态 0表示禁用 1表示启用</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;状态 0表示禁用 1表示启用&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer status;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>VO</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> com.sky.entity.DishFlavor;<br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DishVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-comment">//菜品名称</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-comment">//菜品分类id</span><br>    <span class="hljs-keyword">private</span> Long categoryId;<br>    <span class="hljs-comment">//菜品价格</span><br>    <span class="hljs-keyword">private</span> BigDecimal price;<br>    <span class="hljs-comment">//图片</span><br>    <span class="hljs-keyword">private</span> String image;<br>    <span class="hljs-comment">//描述信息</span><br>    <span class="hljs-keyword">private</span> String description;<br>    <span class="hljs-comment">//0 停售 1 起售</span><br>    <span class="hljs-keyword">private</span> Integer status;<br>    <span class="hljs-comment">//更新时间</span><br>    <span class="hljs-keyword">private</span> LocalDateTime updateTime;<br>    <span class="hljs-comment">//分类名称</span><br>    <span class="hljs-keyword">private</span> String categoryName;<br>    <span class="hljs-comment">//菜品关联的口味</span><br>    <span class="hljs-keyword">private</span> List&lt;DishFlavor&gt; flavors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-comment">//private Integer copies;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 菜品分页查询</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dishPageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/page&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;菜品分页查询&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;PageResult&gt; <span class="hljs-title function_">page</span><span class="hljs-params">(DishPageQueryDTO dishPageQueryDTO)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;菜品分页查询:&#123;&#125;&quot;</span>, dishPageQueryDTO);<br>    <span class="hljs-type">PageResult</span> <span class="hljs-variable">pageResult</span> <span class="hljs-operator">=</span> dishService.pageQuery(dishPageQueryDTO);<span class="hljs-comment">//后绪步骤定义</span><br>    <span class="hljs-keyword">return</span> Result.success(pageResult);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 菜品分页查询</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dishPageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>PageResult <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(DishPageQueryDTO dishPageQueryDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 菜品分页查询</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dishPageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> PageResult <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(DishPageQueryDTO dishPageQueryDTO)</span> &#123;<br>    PageHelper.startPage(dishPageQueryDTO.getPage(), dishPageQueryDTO.getPageSize());<br>    Page&lt;DishVO&gt; page = dishMapper.pageQuery(dishPageQueryDTO);<span class="hljs-comment">//后绪步骤实现</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>(page.getTotal(), page.getResult());<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 菜品分页查询</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dishPageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Page&lt;DishVO&gt; <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(DishPageQueryDTO dishPageQueryDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pageQuery&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.sky.vo.DishVO&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.dto.DishPageQueryDTO&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--这里 as categoryName 传给 DishVO 使用--&gt;</span><br>    select d.*, c.`name` as categoryName  from dish d left join category c ON d.category_id=c.id<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;name!=null&quot;</span>&gt;</span> and c.`name` like concat(&#x27;%&#x27;, #&#123;name&#125;, &#x27;%&#x27;) <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;categoryId!=null&quot;</span>&gt;</span> and d.category_Id=#&#123;categoryId&#125; <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status!=null&quot;</span>&gt;</span> and d.status=#&#123;status&#125; <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>    order by d.create_time desc<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="删除菜品"><a href="#删除菜品" class="headerlink" title="删除菜品"></a>删除菜品</h2><p><strong>contorller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量删除菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;批量删除菜品&quot;)</span><br><span class="hljs-meta">@DeleteMapping</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> List&lt;Long&gt; ids)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;批量删除菜品:&#123;&#125;&quot;</span>, ids);<br>    dishService.deleteBatch(ids);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量删除菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteBatch</span><span class="hljs-params">(List&lt;Long&gt; ids)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量删除菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteBatch</span><span class="hljs-params">(List&lt;Long&gt; ids)</span> &#123;<br>    <span class="hljs-comment">// 如果正在启售, 不能删除</span><br>    ids.forEach(id-&gt;&#123;<br>        <span class="hljs-type">Dish</span> <span class="hljs-variable">dish</span> <span class="hljs-operator">=</span> dishMapper.getById(id);<br>        <span class="hljs-keyword">if</span> (dish.getStatus().equals(ENABLE))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeletionNotAllowedException</span>(DISH_ON_SALE);<br>        &#125;<br>    &#125;);<br><br>    <span class="hljs-comment">// 菜品被套餐关联,不能删除</span><br>    List&lt;Long&gt; setmealIds = setmealDishMapper.getSetmealIdsByDishIds(ids);<br>    <span class="hljs-keyword">if</span> (setmealIds!=<span class="hljs-literal">null</span> &amp;&amp; setmealIds.size()&gt;<span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeletionNotAllowedException</span>(DISH_BE_RELATED_BY_SETMEAL);<br>    &#125;<br><br>    ids.forEach(id-&gt;&#123;<br>        <span class="hljs-comment">// 可以删除, 删除菜品</span><br>        dishMapper.deleteById(id);<br>        <span class="hljs-comment">// 删除菜品口味关系</span><br>        dishFlavorMapper.deleteByDishId(id);<br>    &#125;);<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id删除菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Delete(&quot;delete from dish where id=#&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据菜品id删除数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Delete(&quot;delete from dish_flavor where dish_id=#&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteByDishId</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><h2 id="根据id查询菜品"><a href="#根据id查询菜品" class="headerlink" title="根据id查询菜品"></a>根据id查询菜品</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id查询菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;根据id查询菜品&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;DishVO&gt; <span class="hljs-title function_">getById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;根据id查询菜品:&#123;&#125;&quot;</span>, id);<br>    <span class="hljs-type">DishVO</span> <span class="hljs-variable">dishVO</span> <span class="hljs-operator">=</span> dishService.getById(id);<br>    <span class="hljs-keyword">return</span> Result.success(dishVO);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id查询菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>DishVO <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据菜品id回显菜品和菜品口味关系</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> DishVO <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 查菜品</span><br>    <span class="hljs-type">Dish</span> <span class="hljs-variable">dish</span> <span class="hljs-operator">=</span> dishMapper.getById(id);<br>    <span class="hljs-comment">// 查口味关系</span><br>    List&lt;DishFlavor&gt; dishFlavors = dishFlavorMapper.getByDishId(id);<br>    <span class="hljs-comment">// 封装返回</span><br>    <span class="hljs-type">DishVO</span> <span class="hljs-variable">dishVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DishVO</span>();<br>    BeanUtils.copyProperties(dish, dishVO);<br>    dishVO.setFlavors(dishFlavors);<br><br>    <span class="hljs-keyword">return</span> dishVO;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id获取菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Select(&quot;select * from dish where id=#&#123;id&#125;&quot;)</span><br>Dish <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据菜品id查询口味</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dishId</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Select(&quot;select * from dish_flavor where dish_id=#&#123;dishId&#125;&quot;)</span><br>List&lt;DishFlavor&gt;  <span class="hljs-title function_">getByDishId</span><span class="hljs-params">(Long dishId)</span>;<br></code></pre></td></tr></table></figure><h2 id="修改菜品"><a href="#修改菜品" class="headerlink" title="修改菜品"></a>修改菜品</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dishDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;修改菜品&quot;)</span><br><span class="hljs-meta">@PutMapping</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> DishDTO dishDTO)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;修改菜品:&#123;&#125;&quot;</span>, dishDTO);<br>    dishService.update(dishDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dishDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(DishDTO dishDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dishDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(DishDTO dishDTO)</span> &#123;<br>    <span class="hljs-type">Dish</span> <span class="hljs-variable">dish</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dish</span>();<br>    BeanUtils.copyProperties(dishDTO, dish);<br><br>    <span class="hljs-comment">// 修改菜品 不能先删后增,因为id规则主键自增的</span><br>    dishMapper.update(dish);<br><br>    <span class="hljs-comment">// 修改菜品口味关系 先删后增</span><br>    dishFlavorMapper.deleteByDishId(dishDTO.getId());<br>    List&lt;DishFlavor&gt; flavors = dishDTO.getFlavors();<br>    flavors.forEach(flavor-&gt;flavor.setDishId(dishDTO.getId()));<br>    dishFlavorMapper.insertBatch(flavors);<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dish</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@AutoFill(UPDATE)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Dish dish)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.entity.Dish&quot;</span>&gt;</span><br>    update dish<br>        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;name!=null&quot;</span>&gt;</span>name=#&#123;name&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;categoryId!=null&quot;</span>&gt;</span>category_id=#&#123;categoryId&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;price!=null&quot;</span>&gt;</span>price=#&#123;price&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;image!=null&quot;</span>&gt;</span>image=#&#123;image&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;description!=null&quot;</span>&gt;</span>description=#&#123;description&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;createTime!=null&quot;</span>&gt;</span>carate_time=#&#123;carateTime&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;createUser!=null&quot;</span>&gt;</span>carate_user=#&#123;carateUser&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateTime!=null&quot;</span>&gt;</span>update_time=#&#123;updateTime&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateUser!=null&quot;</span>&gt;</span>update_user=#&#123;updateUser&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>    where id=#&#123;id&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量插入口味数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> flavors</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">insertBatch</span><span class="hljs-params">(List&lt;DishFlavor&gt; flavors)</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据菜品id删除数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Delete(&quot;delete from dish_flavor where dish_id=#&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteByDishId</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertBatch&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.util.List&quot;</span>&gt;</span><br>    insert into dish_flavor(dish_id, name, value) values<br>        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;flavors&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;flavor&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span>&gt;</span><br>            (#&#123;flavor.dishId&#125;, #&#123;flavor.name&#125;, #&#123;flavor.value&#125;)<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="菜品起售停售"><a href="#菜品起售停售" class="headerlink" title="菜品起售停售"></a>菜品起售停售</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 菜品起售停售</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;菜品起售停售&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer status, Long id)</span>&#123;<br>    dishService.startOrStop(status, id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 菜品起售停售</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(Integer status, Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 菜品起售停售</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(Integer status, Long id)</span> &#123;<br>    <span class="hljs-type">Dish</span> <span class="hljs-variable">dish</span> <span class="hljs-operator">=</span> Dish.builder().status(status).id(id).build();<br>    dishMapper.update(dish);<br><br>    <span class="hljs-comment">// 如果是停售, 要把套餐也停售</span><br>    <span class="hljs-keyword">if</span> (status.equals(DISABLE))&#123;<br>        List&lt;Long&gt; dishIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        dishIds.add(id);<br>        List&lt;Long&gt; setmealIds = setmealDishMapper.getSetmealIdsByDishIds(dishIds);<br>        setmealIds.forEach(setmealId-&gt;&#123;<br>            <span class="hljs-type">Setmeal</span> <span class="hljs-variable">setmeal</span> <span class="hljs-operator">=</span> Setmeal.builder().status(status).id(setmealId).build();<br>            setmealMapper.update(setmeal);<br>        &#125;);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改菜品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dish</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@AutoFill(UPDATE)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Dish dish)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.entity.Dish&quot;</span>&gt;</span><br>    update dish<br>        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;name!=null&quot;</span>&gt;</span>name=#&#123;name&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;categoryId!=null&quot;</span>&gt;</span>category_id=#&#123;categoryId&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;price!=null&quot;</span>&gt;</span>price=#&#123;price&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;image!=null&quot;</span>&gt;</span>image=#&#123;image&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;description!=null&quot;</span>&gt;</span>description=#&#123;description&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;createTime!=null&quot;</span>&gt;</span>carate_time=#&#123;carateTime&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;createUser!=null&quot;</span>&gt;</span>carate_user=#&#123;carateUser&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateTime!=null&quot;</span>&gt;</span>update_time=#&#123;updateTime&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateUser!=null&quot;</span>&gt;</span>update_user=#&#123;updateUser&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status!=null&quot;</span>&gt;</span>status=#&#123;status&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>    where id=#&#123;id&#125;<br>&lt;/update<br></code></pre></td></tr></table></figure><h1 id="day04"><a href="#day04" class="headerlink" title="day04"></a>day04</h1><h2 id="新增套餐"><a href="#新增套餐" class="headerlink" title="新增套餐"></a>新增套餐</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> setmealDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;新增套餐&quot;)</span><br><span class="hljs-meta">@PostMapping</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SetmealDTO setmealDTO)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;新增套餐:&#123;&#125;&quot;</span>, setmealDTO);<br>    setmealService.save(setmealDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> setmealDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(SetmealDTO setmealDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> setmealDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(SetmealDTO setmealDTO)</span> &#123;<br>    <span class="hljs-comment">// 新增套餐</span><br>    <span class="hljs-type">Setmeal</span> <span class="hljs-variable">setmeal</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setmeal</span>();<br>    BeanUtils.copyProperties(setmealDTO, setmeal);<br>    setmealMapper.insert(setmeal);<br>    <span class="hljs-comment">// 查到套餐ID</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">setmealId</span> <span class="hljs-operator">=</span> setmealMapper.getSetmealIdByImage(setmeal.getImage());<br>    <span class="hljs-comment">// 新增套餐菜品关系</span><br>    List&lt;SetmealDish&gt; setmealDishes = setmealDTO.getSetmealDishes();<br>    setmealDishes.forEach(setmealDish -&gt; &#123;<br>        setmealDish.setSetmealId(setmealId);<br>    &#125;);<br>    setmealDishMapper.insertBatch(setmealDishes);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> setmeal</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@AutoFill(INSERT)</span><br><span class="hljs-meta">@Insert(&quot;insert into setmeal(category_id, description, image, name, price, status, create_user, create_time, update_time, update_user) values (#&#123;categoryId&#125;, #&#123;description&#125;, #&#123;image&#125;, #&#123;name&#125;, #&#123;price&#125;, #&#123;status&#125;, #&#123;createUser&#125;, #&#123;createTime&#125;, #&#123;updateTime&#125;, #&#123;updateUser&#125;)&quot;)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Setmeal setmeal)</span>;<br></code></pre></td></tr></table></figure><h2 id="套餐分页查询"><a href="#套餐分页查询" class="headerlink" title="套餐分页查询"></a>套餐分页查询</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 套餐分页查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;套餐分页查询&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/page&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;PageResult&gt; <span class="hljs-title function_">page</span><span class="hljs-params">(SetmealPageQueryDTO pageQueryDTO)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;套餐分页查询:&#123;&#125;&quot;</span>, pageQueryDTO);<br>    <span class="hljs-type">PageResult</span> <span class="hljs-variable">pageResult</span> <span class="hljs-operator">=</span> setmealService.pageQuery(pageQueryDTO);<br>    <span class="hljs-keyword">return</span> Result.success(pageResult);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 套餐分页查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>PageResult <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(SetmealPageQueryDTO pageQueryDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 套餐分页查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PageResult <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(SetmealPageQueryDTO pageQueryDTO)</span> &#123;<br>    PageHelper.startPage(pageQueryDTO.getPage(), pageQueryDTO.getPageSize());<br>    Page&lt;SetmealVO&gt; page = setmealMapper.pageQuery(pageQueryDTO);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>(page.getTotal(), page.getResult());<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 套餐分页查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageQueryDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Page&lt;SetmealVO&gt; <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(SetmealPageQueryDTO pageQueryDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pageQuery&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.sky.vo.SetmealVO&quot;</span>&gt;</span><br>    select s.*,c.name categoryName from setmeal s left join category c on s.category_id = c.id<br>    <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;name != null&quot;</span>&gt;</span>and s.name like concat(&#x27;%&#x27;,#&#123;name&#125;,&#x27;%&#x27;)<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span>and s.status = #&#123;status&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;categoryId != null&quot;</span>&gt;</span>and s.category_id = #&#123;categoryId&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>    order by s.create_time desc<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="批量删除套餐"><a href="#批量删除套餐" class="headerlink" title="批量删除套餐"></a>批量删除套餐</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量删除套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;批量删除套餐&quot;)</span><br><span class="hljs-meta">@DeleteMapping</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> List&lt;Long&gt; ids)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;批量删除套餐:&#123;&#125;&quot;</span>, ids);<br>    setmealService.removeBatch(ids);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量删除套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">removeBatch</span><span class="hljs-params">(List&lt;Long&gt; ids)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量删除套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeBatch</span><span class="hljs-params">(List&lt;Long&gt; ids)</span> &#123;<br>    <span class="hljs-comment">// 套餐起售则不能删</span><br>    ids.forEach(id-&gt;&#123;<br>        <span class="hljs-keyword">if</span> (setmealMapper.getById(id).getStatus().equals(ENABLE)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeletionNotAllowedException</span>(SETMEAL_ON_SALE);<br>    &#125;);<br><br>    <span class="hljs-comment">// 删除套餐</span><br>    setmealMapper.removeBatch(ids);<br><br>    <span class="hljs-comment">// 删除套餐菜品关系</span><br>    ids.forEach(id-&gt;&#123;<br>        setmealDishMapper.removeBySetmealId(id);<br>    &#125;);<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id批量删除套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">removeBatch</span><span class="hljs-params">(List&lt;Long&gt; ids)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;removeBatch&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.util.List&quot;</span>&gt;</span><br>    delete from setmeal where<br>        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;ids&quot;</span></span><br><span class="hljs-tag">                 <span class="hljs-attr">open</span>=<span class="hljs-string">&quot;id in (&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span> <span class="hljs-attr">close</span>=<span class="hljs-string">&quot;)&quot;</span>&gt;</span><br>            #&#123;id&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据套餐id删除</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Delete(&quot;delete from setmeal_dish where setmeal_id=#&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">removeBySetmealId</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><h2 id="修改套餐"><a href="#修改套餐" class="headerlink" title="修改套餐"></a>修改套餐</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;修改套餐&quot;)</span><br><span class="hljs-meta">@PutMapping</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SetmealDTO setmealDTO)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;修改套餐:&#123;&#125;&quot;</span>, setmealDTO);<br>    setmealService.update(setmealDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> setmealDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(SetmealDTO setmealDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改套餐和套餐菜品关系</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> setmealDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(SetmealDTO setmealDTO)</span> &#123;<br>    <span class="hljs-comment">// 修改套餐</span><br>    <span class="hljs-type">Setmeal</span> <span class="hljs-variable">setmeal</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setmeal</span>();<br>    BeanUtils.copyProperties(setmealDTO, setmeal);<br>    setmealMapper.update(setmeal);<br><br>    <span class="hljs-comment">// 修改套餐菜品关系 -&gt; 先删后增</span><br>    <span class="hljs-comment">// 删除关系</span><br>    setmealDishMapper.removeBySetmealId(setmeal.getId());<br>    <span class="hljs-comment">// 新增关系</span><br>    List&lt;SetmealDish&gt; setmealDishes = setmealDTO.getSetmealDishes();<br>    setmealDishes.forEach(setmealDish -&gt; setmealDish.setSetmealId(setmeal.getId()));<br>    setmealDishMapper.insertBatch(setmealDTO.getSetmealDishes());<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> setmeal</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@AutoFill(UPDATE)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Setmeal setmeal)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.entity.Setmeal&quot;</span>&gt;</span><br>    update setmeal<br>    <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;categoryId!=null&quot;</span>&gt;</span>category_id=#&#123;categoryId&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;name!=null&quot;</span>&gt;</span>name=#&#123;name&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;price!=null&quot;</span>&gt;</span>price=#&#123;price&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status!=null&quot;</span>&gt;</span>status=#&#123;status&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;description!=null&quot;</span>&gt;</span>description=#&#123;description&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;image!=null&quot;</span>&gt;</span>image=#&#123;image&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateTime!=null&quot;</span>&gt;</span>update_time=#&#123;updateTime&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateUser!=null&quot;</span>&gt;</span>update_user=#&#123;updateUser&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>    where id=#&#123;id&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="起售停售套餐"><a href="#起售停售套餐" class="headerlink" title="起售停售套餐"></a>起售停售套餐</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 起售停售套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> setmealId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;起售停售套餐&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer status,</span><br><span class="hljs-params">                                  <span class="hljs-meta">@RequestParam(&quot;id&quot;)</span> Long setmealId)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;起售停售套餐:status:&#123;&#125;,setmealId:&#123;&#125;&quot;</span>, status, setmealId);<br>    setmealService.startOrStop(status, setmealId);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 起售停售套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> setmealId</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(Integer status, Long setmealId)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 起售停售套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> setmealId</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(Integer status, Long setmealId)</span> &#123;<br>    setmealMapper.update(Setmeal.builder().status(status).id(setmealId).build());<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="根据id查询套餐"><a href="#根据id查询套餐" class="headerlink" title="根据id查询套餐"></a>根据id查询套餐</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id查询套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;根据id查询套餐&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;SetmealVO&gt; <span class="hljs-title function_">getById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;根据id查询套餐:&#123;&#125;&quot;</span>, id);<br>    <span class="hljs-type">SetmealVO</span> <span class="hljs-variable">setmealVO</span> <span class="hljs-operator">=</span> setmealService.getById(id);<br>    <span class="hljs-keyword">return</span> Result.success(setmealVO);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id查询套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>SetmealVO <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id查询套餐</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> SetmealVO <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 查询套餐</span><br>    <span class="hljs-type">Setmeal</span> <span class="hljs-variable">setmeal</span> <span class="hljs-operator">=</span> setmealMapper.getById(id);<br>    <span class="hljs-comment">// 查询菜品套餐关系</span><br>    List&lt;SetmealDish&gt; list = setmealDishMapper.getBySetmealId(id);<br>    <span class="hljs-comment">// 封装返回</span><br>    <span class="hljs-type">SetmealVO</span> <span class="hljs-variable">setmealVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetmealVO</span>();<br>    BeanUtils.copyProperties(setmeal, setmealVO);<br>    setmealVO.setSetmealDishes(list);<br>    <span class="hljs-keyword">return</span> setmealVO;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id获得套餐数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Select(&quot;select * from setmeal where id=#&#123;id&#125;&quot;)</span><br>Setmeal <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据套餐id找到关系数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Select(&quot;select * from setmeal_dish where setmeal_id=#&#123;id&#125;&quot;)</span><br>List&lt;SetmealDish&gt; <span class="hljs-title function_">getBySetmealId</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><h1 id="day05"><a href="#day05" class="headerlink" title="day05"></a>day05</h1><blockquote><p>利用redis查询店铺状态: 打烊还是营业中</p></blockquote><p><strong>controller</strong></p><p>管理端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.admin;<br><br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 15:44</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController(&quot;adminShopController&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/shop&quot;)</span><br><span class="hljs-meta">@Api(tags = &quot;店铺相关操作&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShopController</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate srt;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SHOP_STATUS&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取营业状态</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;获取营业状态&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/status&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;Integer&gt; <span class="hljs-title function_">getStatus</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> srt.opsForValue().get(KEY);<br>        <span class="hljs-keyword">if</span> (status != <span class="hljs-literal">null</span>) &#123;<br>            log.info(<span class="hljs-string">&quot;店铺状态: &#123;&#125;&quot;</span>, status.equals(<span class="hljs-string">&quot;1&quot;</span>) ? <span class="hljs-string">&quot;营业中&quot;</span> : <span class="hljs-string">&quot;打烊中&quot;</span>);<br>            <span class="hljs-keyword">return</span> Result.success(Integer.valueOf(status));<br>        &#125;<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置营业状态</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PutMapping(&quot;/&#123;status&#125;&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;设置营业状态&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">setStatus</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer status)</span>&#123;<br>        srt.opsForValue().set(KEY, status.toString());<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><p>用户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.user;<br><br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 15:50</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController(&quot;userShopController&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/user/shop&quot;)</span><br><span class="hljs-meta">@Api(tags = &quot;店铺相关操作&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate srt;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SHOP_STATUS&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取营业状态</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;获取营业状态&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/status&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">getStatus</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> srt.opsForValue().get(KEY);<br>        <span class="hljs-keyword">if</span> (status != <span class="hljs-literal">null</span>) &#123;<br>            log.info(<span class="hljs-string">&quot;店铺状态: &#123;&#125;&quot;</span>, status.equals(<span class="hljs-string">&quot;1&quot;</span>) ? <span class="hljs-string">&quot;营业中&quot;</span> : <span class="hljs-string">&quot;打烊中&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> Result.success(status);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="day06"><a href="#day06" class="headerlink" title="day06"></a>day06</h1><h2 id="HttpClient"><a href="#HttpClient" class="headerlink" title="HttpClient"></a>HttpClient</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221203185003231.png" alt="image-20221203185003231" style="zoom:50%;" /><p><strong>应用</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221203185536013.png" alt="image-20221203185536013" style="zoom: 50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221203185557674.png" alt="image-20221203185557674" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221203185632934.png" alt="image-20221203185632934" style="zoom:50%;" /></p><p>在应用程序里<code>访问提供这些功能的服务</code>，访问这些服务需要发送HTTP请求，并且接收响应数据，可通过HttpClient来实现</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221203185427462.png" alt="image-20221203185427462" style="zoom:50%;" /><p><strong>坐标</strong></p><p>(如果引入阿里云oss等坐标, 则已经包含了httpclient)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>httpclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.5.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>GET方式请求</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.test;<br><br><span class="hljs-keyword">import</span> org.apache.http.HttpEntity;<br><span class="hljs-keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;<br><span class="hljs-keyword">import</span> org.apache.http.client.methods.HttpGet;<br><span class="hljs-keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;<br><span class="hljs-keyword">import</span> org.apache.http.impl.client.HttpClients;<br><span class="hljs-keyword">import</span> org.apache.http.util.EntityUtils;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpClientTest</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试通过httpclient发送GET方式的请求</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGET</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//创建httpclient对象</span><br>        <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> HttpClients.createDefault();<br><br>        <span class="hljs-comment">//创建请求对象</span><br>        <span class="hljs-type">HttpGet</span> <span class="hljs-variable">httpGet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>(<span class="hljs-string">&quot;http://localhost:8080/user/shop/status&quot;</span>);<br><br>        <span class="hljs-comment">//发送请求，接受响应结果</span><br>        <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpClient.execute(httpGet);<br><br>        <span class="hljs-comment">//获取服务端返回的状态码</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">statusCode</span> <span class="hljs-operator">=</span> response.getStatusLine().getStatusCode();<br>        System.out.println(<span class="hljs-string">&quot;服务端返回的状态码为：&quot;</span> + statusCode);<br><br>        <span class="hljs-type">HttpEntity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> response.getEntity();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> EntityUtils.toString(entity);<br>        System.out.println(<span class="hljs-string">&quot;服务端返回的数据为：&quot;</span> + body);<br><br>        <span class="hljs-comment">//关闭资源</span><br>        response.close();<br>        httpClient.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>POST方式请求</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 测试通过httpclient发送POST方式的请求</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPOST</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-comment">// 创建httpclient对象</span><br>    <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> HttpClients.createDefault();<br><br>    <span class="hljs-comment">//创建请求对象</span><br>    <span class="hljs-type">HttpPost</span> <span class="hljs-variable">httpPost</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpPost</span>(<span class="hljs-string">&quot;http://localhost:8080/admin/employee/login&quot;</span>);<br><br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>    jsonObject.put(<span class="hljs-string">&quot;username&quot;</span>,<span class="hljs-string">&quot;admin&quot;</span>);<br>    jsonObject.put(<span class="hljs-string">&quot;password&quot;</span>,<span class="hljs-string">&quot;123456&quot;</span>);<br><br>    <span class="hljs-type">StringEntity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEntity</span>(jsonObject.toString());<br>    <span class="hljs-comment">//指定请求编码方式</span><br>    entity.setContentEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br>    <span class="hljs-comment">//数据格式</span><br>    entity.setContentType(<span class="hljs-string">&quot;application/json&quot;</span>);<br>    httpPost.setEntity(entity);<br><br>    <span class="hljs-comment">//发送请求</span><br>    <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpClient.execute(httpPost);<br><br>    <span class="hljs-comment">//解析返回结果</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">statusCode</span> <span class="hljs-operator">=</span> response.getStatusLine().getStatusCode();<br>    System.out.println(<span class="hljs-string">&quot;响应码为：&quot;</span> + statusCode);<br><br>    <span class="hljs-type">HttpEntity</span> <span class="hljs-variable">entity1</span> <span class="hljs-operator">=</span> response.getEntity();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> EntityUtils.toString(entity1);<br>    System.out.println(<span class="hljs-string">&quot;响应数据为：&quot;</span> + body);<br><br>    <span class="hljs-comment">//关闭资源</span><br>    response.close();<br>    httpClient.close();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="微信小程序"><a href="#微信小程序" class="headerlink" title="微信小程序"></a>微信小程序</h2><blockquote><p>开发者可以快速地开发一个小程序。可以在微信内被便捷使用</p></blockquote><p><strong>注册小程序</strong></p><p><a href="https://mp.weixin.qq.com/wxopen/waregister?action=step1">https://mp.weixin.qq.com/wxopen/waregister?action=step1</a></p><p><strong>完善小程序信息</strong></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221203212615981.png" alt="image-20221203212615981" style="zoom:50%;" /><p><strong>创建小程序</strong></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221203213042020.png" alt="image-20221203213042020"  /><p><strong>设置不校验合法域名</strong></p><blockquote><p>如果不勾选则本地tomcat不能到达小程序</p></blockquote><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221203213212370.png" alt="image-20221203213212370" style="zoom: 150%;" /><p><strong>目录结构</strong></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221203220557676.png" alt="image-20221203220557676" style="zoom:50%;" /><p><strong>app.js：</strong>必须存在，主要存放小程序的逻辑代码</p><p><strong>app.json：</strong>必须存在，小程序配置文件，主要存放小程序的公共配置</p><p><strong>app.wxss:</strong>  非必须存在，主要存放小程序公共样式表，类似于前端的CSS样式</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221203220826893.png" alt="image-20221203220826893" style="zoom:50%;" /><p><strong>js文件：</strong>必须存在，存放页面业务逻辑代码，编写的js代码。</p><p><strong>wxml文件：</strong>必须存在，存放页面结构，主要是做页面布局，页面效果展示的，类似于HTML页面。</p><p><strong>json文件：</strong>非必须，存放页面相关的配置。</p><p><strong>wxss文件：</strong>非必须，存放页面样式表，相当于CSS文件。</p><h2 id="微信登录"><a href="#微信登录" class="headerlink" title="微信登录"></a>微信登录</h2><p><strong>登录流程</strong></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/api-login.2fcc9f35.jpg"></p><ol><li>小程序端，调用wx.login()获取code，就是授权码。</li><li>小程序端，调用wx.request()发送请求并携带code，请求开发者服务器(自己编写的后端服务)。</li><li>开发者服务端，通过HttpClient向微信接口服务发送请求，并携带appId+appsecret+code三个参数。</li><li>开发者服务端，接收微信接口服务返回的数据，session_key+opendId等。opendId是微信用户的唯一标识。</li><li>开发者服务端，自定义登录态，生成令牌(token)和openid等数据返回给小程序端，方便后绪请求身份校验。</li><li>小程序端，收到自定义登录态，存储storage。</li><li>小程序端，后绪通过wx.request()发起业务请求时，携带token。</li><li>开发者服务端，收到请求后，通过携带的token，解析当前登录用户的id。</li><li>开发者服务端，身份校验通过后，继续相关的业务逻辑处理，最终返回业务数据。</li></ol><p><strong>测试</strong></p><ol><li>获得授权码</li></ol><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221204222008130.png" alt="image-20221204222008130" style="zoom:50%;" /><ol start="2"><li>明确请求接口</li></ol><p>请求方式: get</p><p>请求路径: <a href="https://api.weixin.qq.com/sns/jscode2session">https://api.weixin.qq.com/sns/jscode2session</a></p><p>请求参数: </p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231208162143175.png" alt="image-20231208162143175"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231208162334684.png" alt="image-20231208162334684"></p><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.user;<br><br><span class="hljs-keyword">import</span> com.sky.constant.JwtClaimsConstant;<br><span class="hljs-keyword">import</span> com.sky.dto.UserLoginDTO;<br><span class="hljs-keyword">import</span> com.sky.entity.User;<br><span class="hljs-keyword">import</span> com.sky.properties.JwtProperties;<br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.UserService;<br><span class="hljs-keyword">import</span> com.sky.utils.JwtUtil;<br><span class="hljs-keyword">import</span> com.sky.vo.UserLoginVO;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Objects;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.sky.constant.JwtClaimsConstant.USER_ID;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 16:31</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user/user&quot;)</span><br><span class="hljs-meta">@Api(tags = &quot;C端用户相关接口&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JwtProperties jwtProperties;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userLoginDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;登录&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/login&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;UserLoginVO&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserLoginDTO userLoginDTO)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;微信登录: &#123;&#125;&quot;</span>, userLoginDTO);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.wxLogin(userLoginDTO);<br><br>        <span class="hljs-comment">// 为微信用户生成jwt令牌</span><br>        HashMap&lt;String, Object&gt; claims = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        claims.put(USER_ID, user.getId());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> JwtUtil.createJWT(jwtProperties.getUserSecretKey(), jwtProperties.getUserTtl(), claims);<br><br>        <span class="hljs-comment">// 封装返回</span><br>        <span class="hljs-type">UserLoginVO</span> <span class="hljs-variable">userLoginVO</span> <span class="hljs-operator">=</span> UserLoginVO.builder()<br>                .id(user.getId()).openid(user.getOpenid())<br>                .token(token).build();<br>        <span class="hljs-keyword">return</span> Result.success(userLoginVO);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>JwtUtil</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.utils;<br><br><span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;<br><span class="hljs-keyword">import</span> io.jsonwebtoken.JwtBuilder;<br><span class="hljs-keyword">import</span> io.jsonwebtoken.Jwts;<br><span class="hljs-keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtUtil</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成jwt</span><br><span class="hljs-comment">     * 使用Hs256算法, 私匙使用固定秘钥</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> secretKey jwt秘钥</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ttlMillis jwt过期时间(毫秒)</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> claims    设置的信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">createJWT</span><span class="hljs-params">(String secretKey, <span class="hljs-type">long</span> ttlMillis, Map&lt;String, Object&gt; claims)</span> &#123;<br>        <span class="hljs-comment">// 指定签名的时候使用的签名算法，也就是header那部分</span><br>        <span class="hljs-type">SignatureAlgorithm</span> <span class="hljs-variable">signatureAlgorithm</span> <span class="hljs-operator">=</span> SignatureAlgorithm.HS256;<br><br>        <span class="hljs-comment">// 生成JWT的时间</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">expMillis</span> <span class="hljs-operator">=</span> System.currentTimeMillis() + ttlMillis;<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(expMillis);<br><br>        <span class="hljs-comment">// 设置jwt的body</span><br>        <span class="hljs-type">JwtBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> Jwts.builder()<br>                <span class="hljs-comment">// 如果有私有声明，一定要先设置这个自己创建的私有的声明，这个是给builder的claim赋值，一旦写在标准的声明赋值之后，就是覆盖了那些标准的声明的</span><br>                .setClaims(claims)<br>                <span class="hljs-comment">// 设置签名使用的签名算法和签名使用的秘钥</span><br>                .signWith(signatureAlgorithm, secretKey.getBytes(StandardCharsets.UTF_8))<br>                <span class="hljs-comment">// 设置过期时间</span><br>                .setExpiration(exp);<br><br>        <span class="hljs-keyword">return</span> builder.compact();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Token解密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> secretKey jwt秘钥 此秘钥一定要保留好在服务端, 不能暴露出去, 否则sign就可以被伪造, 如果对接多个客户端建议改造成多个</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token     加密后的token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Claims <span class="hljs-title function_">parseJWT</span><span class="hljs-params">(String secretKey, String token)</span> &#123;<br>        <span class="hljs-comment">// 得到DefaultJwtParser</span><br>        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> Jwts.parser()<br>                <span class="hljs-comment">// 设置签名的秘钥</span><br>                .setSigningKey(secretKey.getBytes(StandardCharsets.UTF_8))<br>                <span class="hljs-comment">// 设置需要解析的jwt</span><br>                .parseClaimsJws(token).getBody();<br>        <span class="hljs-keyword">return</span> claims;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>JwtProperties</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.properties;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;sky.jwt&quot;)</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtProperties</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 管理端员工生成jwt令牌相关配置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String adminSecretKey;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> adminTtl;<br>    <span class="hljs-keyword">private</span> String adminTokenName;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户端微信用户生成jwt令牌相关配置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String userSecretKey;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> userTtl;<br>    <span class="hljs-keyword">private</span> String userTokenName;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>UserLoginDTO</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.dto;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * C端用户登录</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserLoginDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String code;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>UserLoginVO</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserLoginVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String openid;<br>    <span class="hljs-keyword">private</span> String token;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.dto.UserLoginDTO;<br><span class="hljs-keyword">import</span> com.sky.entity.User;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 17:19</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userLoginDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    User <span class="hljs-title function_">wxLogin</span><span class="hljs-params">(UserLoginDTO userLoginDTO)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.sky.dto.UserLoginDTO;<br><span class="hljs-keyword">import</span> com.sky.entity.User;<br><span class="hljs-keyword">import</span> com.sky.exception.LoginFailedException;<br><span class="hljs-keyword">import</span> com.sky.mapper.UserMapper;<br><span class="hljs-keyword">import</span> com.sky.properties.WeChatProperties;<br><span class="hljs-keyword">import</span> com.sky.service.UserService;<br><span class="hljs-keyword">import</span> com.sky.utils.HttpClientUtil;<br><span class="hljs-keyword">import</span> com.sky.vo.UserLoginVO;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.sky.constant.MessageConstant.LOGIN_FAILED;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 17:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-comment">//微信服务接口地址</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WX_LOGIN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://api.weixin.qq.com/sns/jscode2session&quot;</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WeChatProperties weChatProperties;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userLoginDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">wxLogin</span><span class="hljs-params">(UserLoginDTO userLoginDTO)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">openId</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getOpenId(userLoginDTO.getCode());<br>        <span class="hljs-comment">// 判空openId, 如果为空则登录失败, 抛出业务异常</span><br>        <span class="hljs-keyword">if</span> (openId == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginFailedException</span>(LOGIN_FAILED);<br>        &#125;<br><br>        <span class="hljs-comment">// 判断用户是否为新用户</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.getByOpenId(openId);<br><br>        <span class="hljs-comment">// 如果是新用户, 注册</span><br>        <span class="hljs-keyword">if</span> (user==<span class="hljs-literal">null</span>) &#123;<br>            user = User.builder().openid(openId).createTime(LocalDateTime.now()).build();<br>            userMapper.insert(user);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据code获取openid</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> code</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getOpenId</span><span class="hljs-params">(String code)</span> &#123;<br>        <span class="hljs-comment">//调用微信接口服务，获得当前微信用户的openid</span><br>        Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;appid&quot;</span>,weChatProperties.getAppid());<br>        map.put(<span class="hljs-string">&quot;secret&quot;</span>,weChatProperties.getSecret());<br>        map.put(<span class="hljs-string">&quot;js_code&quot;</span>,code);<br>        map.put(<span class="hljs-string">&quot;grant_type&quot;</span>,<span class="hljs-string">&quot;authorization_code&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> HttpClientUtil.doGet(WX_LOGIN, map);<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSON.parseObject(json);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">openid</span> <span class="hljs-operator">=</span> jsonObject.getString(<span class="hljs-string">&quot;openid&quot;</span>);<br>        <span class="hljs-keyword">return</span> openid;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.mapper;<br><br><span class="hljs-keyword">import</span> com.sky.entity.User;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Insert;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Select;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 17:40</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据openId获得用户</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> openId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Select(&quot;select * from user where openid=#&#123;openId&#125;;&quot;)</span><br>    User <span class="hljs-title function_">getByOpenId</span><span class="hljs-params">(String openId)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增登录数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Insert(&quot;insert into user (openid, name, phone, sex, id_number, avatar, create_time) values (#&#123;openid&#125;, #&#123;name&#125;, #&#123;phone&#125;, #&#123;sex&#125;, #&#123;idNumber&#125;, #&#123;avatar&#125;, #&#123;createTime&#125;)&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(User user)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>interceptor</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.interceptor;<br><br><span class="hljs-keyword">import</span> com.sky.constant.JwtClaimsConstant;<br><span class="hljs-keyword">import</span> com.sky.context.BaseContext;<br><span class="hljs-keyword">import</span> com.sky.properties.JwtProperties;<br><span class="hljs-keyword">import</span> com.sky.utils.JwtUtil;<br><span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.messaging.handler.HandlerMethod;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.sky.constant.JwtClaimsConstant.USER_ID;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 17:55</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtTokenUserInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> JwtProperties jwtProperties;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//判断当前拦截的是controller的方法还是其他资源</span><br>        <span class="hljs-keyword">if</span> (!(handler <span class="hljs-keyword">instanceof</span> HandlerMethod)) &#123;<br>            <span class="hljs-comment">//当前拦截到的不是动态方法，直接放行</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 1.从请求头获取令牌</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(jwtProperties.getUserTokenName());<br><br>        <span class="hljs-comment">// 2.校验令牌</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            log.info(<span class="hljs-string">&quot;jwt校验:&#123;&#125;&quot;</span>, token);<br>            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token);<br>            <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> Long.valueOf(claims.get(USER_ID).toString());<br>            log.info(<span class="hljs-string">&quot;当前用户id:&#123;&#125;&quot;</span>, userId);<br>            BaseContext.setCurrentId(userId);<br>            <span class="hljs-comment">// 3.通过放行</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// 4.不通过, 响应401</span><br>            response.setStatus(<span class="hljs-number">401</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;开始注册自定义拦截器...&quot;</span>);<br>    registry.addInterceptor(jwtTokenAdminInterceptor)<br>            .addPathPatterns(<span class="hljs-string">&quot;/admin/**&quot;</span>)<br>            .excludePathPatterns(<span class="hljs-string">&quot;/admin/employee/login&quot;</span>);<br>    registry.addInterceptor(jwtTokenUserInterceptor)<br>            .addPathPatterns(<span class="hljs-string">&quot;/user/**&quot;</span>)<br>            .excludePathPatterns(<span class="hljs-string">&quot;/user/user/login&quot;</span>)<br>            .excludePathPatterns(<span class="hljs-string">&quot;/user/shop/status&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="day07"><a href="#day07" class="headerlink" title="day07"></a>day07</h1><h2 id="缓存菜品"><a href="#缓存菜品" class="headerlink" title="缓存菜品"></a>缓存菜品</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221208180818572.png" alt="image-20221208180818572" style="zoom:80%;" /><p>逻辑:</p><ol><li>每个分类下的菜品保存一份数据</li><li>数据库中菜品数据变化时<code>清理缓存</code></li></ol><blockquote><p>微信小程序界面缓存数据</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.user;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;<br><span class="hljs-keyword">import</span> com.sky.constant.StatusConstant;<br><span class="hljs-keyword">import</span> com.sky.entity.Dish;<br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.DishService;<br><span class="hljs-keyword">import</span> com.sky.vo.DishVO;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Set;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.sky.constant.RedisKeyConstant.DISH_KEY;<br><br><span class="hljs-meta">@RestController(&quot;userDishController&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/user/dish&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;C端-菜品浏览接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DishController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DishService dishService;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate srt;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据分类id查询菜品</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> categoryId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;根据分类id查询菜品&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;List&lt;DishVO&gt;&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(Long categoryId)</span> &#123;<br>        <span class="hljs-comment">// key: dish_分类id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> DISH_KEY + categoryId;<br><br>        <span class="hljs-comment">// 查询redis是否有菜品信息</span><br>        List&lt;DishVO&gt; list = <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> srt.opsForValue().get(key);<br>        <span class="hljs-keyword">if</span> (jsonStr != <span class="hljs-literal">null</span>) &#123;<br>            list = JSONUtil.toList(jsonStr, DishVO.class);<br>            <span class="hljs-keyword">return</span> Result.success(list);<br>        &#125;<br>        <span class="hljs-type">Dish</span> <span class="hljs-variable">dish</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dish</span>();<br>        dish.setCategoryId(categoryId);<br>        dish.setStatus(StatusConstant.ENABLE);<span class="hljs-comment">//查询起售中的菜品</span><br><br>        list = dishService.listWithFlavor(dish);<br><br>        <span class="hljs-comment">// 存入redis</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(list);<br>        srt.opsForValue().set(key, json);<br><br>        <span class="hljs-keyword">return</span> Result.success(list);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.constant;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 20:17</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisKeyConstant</span> &#123;<br>    <span class="hljs-comment">// 缓存菜品</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DISH_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dish_&quot;</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.admin;<br><br><span class="hljs-keyword">import</span> com.sky.dto.DishDTO;<br><span class="hljs-keyword">import</span> com.sky.dto.DishPageQueryDTO;<br><span class="hljs-keyword">import</span> com.sky.entity.Dish;<br><span class="hljs-keyword">import</span> com.sky.entity.Setmeal;<br><span class="hljs-keyword">import</span> com.sky.result.PageResult;<br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.DishService;<br><span class="hljs-keyword">import</span> com.sky.vo.DishVO;<br><span class="hljs-keyword">import</span> com.sky.vo.SetmealVO;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Set;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.sky.constant.RedisKeyConstant.DISH_KEY;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/7 15:26</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/dish&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;菜品相关接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DishController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DishService dishService;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate srt;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 清理缓存数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pattern</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanCache</span><span class="hljs-params">(String pattern)</span>&#123;<br>        Set&lt;String&gt; keys = srt.keys(pattern);<br>        <span class="hljs-keyword">if</span> (keys != <span class="hljs-literal">null</span>) &#123;<br>            srt.delete(keys);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增菜品</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dishDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-meta">@ApiOperation(&quot;新增菜品&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> DishDTO dishDTO)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;新增菜品:&#123;&#125;&quot;</span>, dishDTO);<br>        dishService.saveWithFlavor(dishDTO);<br><br>        <span class="hljs-comment">// 清理缓存数据</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">dishKey</span> <span class="hljs-operator">=</span> DISH_KEY + dishDTO.getCategoryId();<br>        cleanCache(dishKey);<br><br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 菜品分页查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dishPageQueryDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;菜品分页查询&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/page&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;PageResult&gt; <span class="hljs-title function_">page</span><span class="hljs-params">(DishPageQueryDTO dishPageQueryDTO)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;菜品分页查询:&#123;&#125;&quot;</span>, dishPageQueryDTO);<br>        <span class="hljs-type">PageResult</span> <span class="hljs-variable">pageResult</span> <span class="hljs-operator">=</span> dishService.pageQuery(dishPageQueryDTO);<br>        <span class="hljs-keyword">return</span> Result.success(pageResult);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 批量删除菜品</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;批量删除菜品&quot;)</span><br>    <span class="hljs-meta">@DeleteMapping</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> List&lt;Long&gt; ids)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;批量删除菜品:&#123;&#125;&quot;</span>, ids);<br>        dishService.deleteBatch(ids);<br><br>        <span class="hljs-comment">// 将所有菜品缓存数据清理掉, 所有dish_开头的key</span><br>        cleanCache(DISH_KEY+<span class="hljs-string">&quot;*&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id查询菜品</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;根据id查询菜品&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;DishVO&gt; <span class="hljs-title function_">getById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;根据id查询菜品:&#123;&#125;&quot;</span>, id);<br>        <span class="hljs-type">DishVO</span> <span class="hljs-variable">dishVO</span> <span class="hljs-operator">=</span> dishService.getById(id);<br>        <span class="hljs-keyword">return</span> Result.success(dishVO);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改菜品</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dishDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;修改菜品&quot;)</span><br>    <span class="hljs-meta">@PutMapping</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> DishDTO dishDTO)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;修改菜品:&#123;&#125;&quot;</span>, dishDTO);<br>        dishService.update(dishDTO);<br><br>        <span class="hljs-comment">// 将所有菜品缓存数据清理掉, 所有dish_开头的key</span><br>        cleanCache(DISH_KEY+<span class="hljs-string">&quot;*&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 菜品起售停售</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;菜品起售停售&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer status, Long id)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;菜品起售停售:status:&#123;&#125;, id:&#123;&#125;&quot;</span>, status, id);<br>        dishService.startOrStop(status, id);<br><br>        <span class="hljs-comment">//将所有的菜品缓存数据清理掉，所有以dish_开头的key</span><br>        cleanCache(DISH_KEY+<span class="hljs-string">&quot;*&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据分类id查询菜品</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> categoryId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;根据分类id查询菜品&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;List&lt;Dish&gt;&gt; <span class="hljs-title function_">getDishesByCategoryId</span><span class="hljs-params">(Long categoryId)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;根据分类id查询菜品:&#123;&#125;&quot;</span>, categoryId);<br>        List&lt;Dish&gt; dishes = dishService.getDishesByCategoryId(categoryId);<br>        <span class="hljs-keyword">return</span> Result.success(dishes);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Spring-Cache"><a href="#Spring-Cache" class="headerlink" title="Spring Cache"></a>Spring Cache</h2><blockquote><p><code>Spring Cache</code>实现基于注解的缓存功能, 加一个注解实现缓存功能</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>常用注解</strong></p><table><thead><tr><th><strong>注解</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>@EnableCaching</td><td>开启缓存注解功能，通常加在启动类上</td></tr><tr><td>@Cacheable</td><td>在方法执行前先查询缓存中是否有数据，如果有数据，则直接返回缓存数据；如果没有缓存数据，调用方法并将方法返回值放到缓存中</td></tr><tr><td>@CachePut</td><td>将方法的返回值放到缓存中</td></tr><tr><td>@CacheEvict</td><td>将一条或多条数据从缓存中删除</td></tr></tbody></table><p><strong>@CachePut</strong></p><p><strong>说明：</strong>key的写法如下</p><p>#user.id : #user指的是方法形参的名称, id指的是user的id属性 , 也就是使用user的id属性作为key ;</p><p>#result.id : #result代表方法返回值，该表达式 代表以返回对象的id属性作为key ；</p><p>#p0.id：#p0指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数的id属性作为key ;</p><p>#a0.id：#a0指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数的id属性作为key ;</p><p>#root.args[0].id:#root.args[0]指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数</p><p>的id属性作为key ;</p><p><strong>启动服务,通过swagger接口文档测试，访问UserController的save()方法</strong></p><p>因为id是自增，所以不需要设置id属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* CachePut：将方法返回值放入缓存</span><br><span class="hljs-comment">* value：缓存的名称，每个缓存名称下面可以有多个key</span><br><span class="hljs-comment">* key：缓存的key</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@PostMapping</span><br>   <span class="hljs-meta">@CachePut(value = &quot;userCache&quot;, key = &quot;#user.id&quot;)</span><span class="hljs-comment">//key的生成：userCache::1</span><br>   <span class="hljs-keyword">public</span> User <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span>&#123;<br>       userMapper.insert(user);<br>       <span class="hljs-keyword">return</span> user;<br>   &#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231208211035613.png" alt="image-20231208211035613"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231208211047188.png" alt="image-20231208211047188"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231208211103050.png" alt="image-20231208211103050"></p><p><strong>@Cacheable</strong></p><blockquote><p>放入缓存之前, 先进行查找, 如果有缓存就停止</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Cacheable(cacheNames = &quot;userCache&quot;, key = &quot;#id&quot;)</span><br><span class="hljs-meta">@GetMapping</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>&#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.getById(id);<br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>@CacheEvict</strong></p><blockquote><p>清理指定缓存</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CacheEvict(cacheNames = &quot;userCache&quot;, key = &quot;#id&quot;)</span> <span class="hljs-comment">// 删除userCache下指定缓存</span><br>   <span class="hljs-meta">@DeleteMapping</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span>&#123;<br>       userMapper.deleteById(id);<br>   &#125;<br><br>   <span class="hljs-meta">@CacheEvict(cacheNames = &quot;userCache&quot;, allEntries = true)</span><span class="hljs-comment">// 删除userCache下所有缓存</span><br><span class="hljs-meta">@DeleteMapping(&quot;/delAll&quot;)</span> <br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteAll</span><span class="hljs-params">()</span>&#123;<br>       userMapper.deleteAll();<br>   &#125;<br></code></pre></td></tr></table></figure><h2 id="缓存套餐"><a href="#缓存套餐" class="headerlink" title="缓存套餐"></a>缓存套餐</h2><ol><li>导入依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>启动类上加入@EnableCaching注解，开启缓存注解功能</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableTransactionManagement</span> <span class="hljs-comment">//开启注解方式的事务管理</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@EnableCaching</span> <span class="hljs-comment">// 开启注解方式的缓存管理</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkyApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(SkyApplication.class, args);<br>        log.info(<span class="hljs-string">&quot;server started&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>用户端setmealcontroller加@Cacheable</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 条件查询</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> categoryId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;根据分类id查询套餐&quot;)</span><br><span class="hljs-meta">@Cacheable(cacheNames = SETMEAL_CACHE, key = &quot;#categoryId&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;Setmeal&gt;&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(Long categoryId)</span> &#123;<br>    <span class="hljs-type">Setmeal</span> <span class="hljs-variable">setmeal</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setmeal</span>();<br>    setmeal.setCategoryId(categoryId);<br>    setmeal.setStatus(StatusConstant.ENABLE);<br><br>    List&lt;Setmeal&gt; list = setmealService.list(setmeal);<br>    <span class="hljs-keyword">return</span> Result.success(list);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>管理端setmealcontroller加@CacheEvict</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.admin;<br><br><span class="hljs-keyword">import</span> com.sky.dto.SetmealDTO;<br><span class="hljs-keyword">import</span> com.sky.dto.SetmealPageQueryDTO;<br><span class="hljs-keyword">import</span> com.sky.result.PageResult;<br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.SetmealService;<br><span class="hljs-keyword">import</span> com.sky.vo.SetmealVO;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.CacheEvict;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.sky.constant.RedisKeyConstant.SETMEAL_CACHE;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 套餐相关接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/7 23:28</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/setmeal&quot;)</span><br><span class="hljs-meta">@Api(tags = &quot;套餐相关接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SetmealController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> SetmealService setmealService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增套餐</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> setmealDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;新增套餐&quot;)</span><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-meta">@CacheEvict(cacheNames = SETMEAL_CACHE, key = &quot;#setmealDTO.categoryId&quot;)</span> <span class="hljs-comment">// setmealCache::100</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SetmealDTO setmealDTO)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;新增套餐:&#123;&#125;&quot;</span>, setmealDTO);<br>        setmealService.save(setmealDTO);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 套餐分页查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageQueryDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;套餐分页查询&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/page&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;PageResult&gt; <span class="hljs-title function_">page</span><span class="hljs-params">(SetmealPageQueryDTO pageQueryDTO)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;套餐分页查询:&#123;&#125;&quot;</span>, pageQueryDTO);<br>        <span class="hljs-type">PageResult</span> <span class="hljs-variable">pageResult</span> <span class="hljs-operator">=</span> setmealService.pageQuery(pageQueryDTO);<br>        <span class="hljs-keyword">return</span> Result.success(pageResult);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 批量删除套餐</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;批量删除套餐&quot;)</span><br>    <span class="hljs-meta">@DeleteMapping</span><br>    <span class="hljs-meta">@CacheEvict(cacheNames = SETMEAL_CACHE, allEntries = true)</span> <span class="hljs-comment">// setmealCache::*</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> List&lt;Long&gt; ids)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;批量删除套餐:&#123;&#125;&quot;</span>, ids);<br>        setmealService.removeBatch(ids);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改套餐</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;修改套餐&quot;)</span><br>    <span class="hljs-meta">@PutMapping</span><br>    <span class="hljs-meta">@CacheEvict(cacheNames = SETMEAL_CACHE, key = &quot;#setmealDTO.categoryId&quot;)</span> <span class="hljs-comment">// setmealCache::100</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SetmealDTO setmealDTO)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;修改套餐:&#123;&#125;&quot;</span>, setmealDTO);<br>        setmealService.update(setmealDTO);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 起售停售套餐</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> setmealId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;起售停售套餐&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span><br>    <span class="hljs-meta">@CacheEvict(cacheNames = SETMEAL_CACHE, key = &quot;#setmealId&quot;)</span> <span class="hljs-comment">// setmealCache::100</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer status,</span><br><span class="hljs-params">                                      <span class="hljs-meta">@RequestParam(&quot;id&quot;)</span> Long setmealId)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;起售停售套餐:status:&#123;&#125;,setmealId:&#123;&#125;&quot;</span>, status, setmealId);<br>        setmealService.startOrStop(status, setmealId);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id查询套餐</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;根据id查询套餐&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;SetmealVO&gt; <span class="hljs-title function_">getById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;根据id查询套餐:&#123;&#125;&quot;</span>, id);<br>        <span class="hljs-type">SetmealVO</span> <span class="hljs-variable">setmealVO</span> <span class="hljs-operator">=</span> setmealService.getById(id);<br>        <span class="hljs-keyword">return</span> Result.success(setmealVO);<br>    &#125;<br><br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231208214931370.png" alt="image-20231208214931370"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231208214937969.png" alt="image-20231208214937969"></p><h2 id="添加购物车"><a href="#添加购物车" class="headerlink" title="添加购物车"></a>添加购物车</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221210203822817.png" alt="image-20221210203822817" style="zoom:50%;" /><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.user;<br><br><span class="hljs-keyword">import</span> com.sky.dto.ShoppingCartDTO;<br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.ShoppingCartService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 21:59</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user/shoppingCart&quot;)</span><br><span class="hljs-meta">@Api(tags = &quot;用户端购物车相关操作&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShoppingCartController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> ShoppingCartService shoppingCartService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加购物车</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shoppingCartDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/add&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;添加购物车&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">addCart</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ShoppingCartDTO shoppingCartDTO)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;向购物车添加数据: &#123;&#125;&quot;</span>, shoppingCartDTO);<br>        shoppingCartService.addCart(shoppingCartDTO);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.dto.ShoppingCartDTO;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 22:01</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ShoppingCartService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加购物车</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shoppingCartDTO</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCart</span><span class="hljs-params">(ShoppingCartDTO shoppingCartDTO)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><span class="hljs-keyword">import</span> com.sky.context.BaseContext;<br><span class="hljs-keyword">import</span> com.sky.dto.ShoppingCartDTO;<br><span class="hljs-keyword">import</span> com.sky.entity.Dish;<br><span class="hljs-keyword">import</span> com.sky.entity.Setmeal;<br><span class="hljs-keyword">import</span> com.sky.entity.ShoppingCart;<br><span class="hljs-keyword">import</span> com.sky.mapper.DishMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.SetmealMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.ShoppingCartMapper;<br><span class="hljs-keyword">import</span> com.sky.service.ShoppingCartService;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 22:03</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShoppingCartServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ShoppingCartService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> ShoppingCartMapper shoppingCartMapper;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> SetmealMapper setmealMapper;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> DishMapper dishMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加购物车</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shoppingCartDTO</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCart</span><span class="hljs-params">(ShoppingCartDTO shoppingCartDTO)</span> &#123;<br>        <span class="hljs-type">ShoppingCart</span> <span class="hljs-variable">shoppingCart</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShoppingCart</span>();<br>        BeanUtils.copyProperties(shoppingCartDTO, shoppingCart);<br>        shoppingCart.setCreateTime(LocalDateTime.now());<br>        shoppingCart.setUserId(BaseContext.getCurrentId());<br><br>        <span class="hljs-comment">// 看购物车有没有这条数据</span><br>        List&lt;ShoppingCart&gt; shoppingCartList = shoppingCartMapper.list(shoppingCart);<br>        <span class="hljs-keyword">if</span> (shoppingCartList != <span class="hljs-literal">null</span> &amp;&amp; shoppingCartList.size() == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-comment">// 如果购物车有这条数据, 则数量+1</span><br>            shoppingCart = shoppingCartList.get(<span class="hljs-number">0</span>);<br>            shoppingCart.setNumber(shoppingCart.getNumber() + <span class="hljs-number">1</span>);<br>            shoppingCartMapper.updateNumberById(shoppingCart);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果购物车没有这条数据, 则插入数据</span><br>            <span class="hljs-comment">// 缺少数据 name image     number amount</span><br>            <span class="hljs-comment">// 依然分点的是`菜品`或`套餐`两种情况</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">dishId</span> <span class="hljs-operator">=</span> shoppingCart.getDishId();<br>            <span class="hljs-comment">// 点的是菜品</span><br>            <span class="hljs-keyword">if</span> (dishId != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">Dish</span> <span class="hljs-variable">dish</span> <span class="hljs-operator">=</span> dishMapper.getById(dishId);<br>                shoppingCart.setName(dish.getName());<br>                shoppingCart.setImage(dish.getImage());<br>                shoppingCart.setAmount(dish.getPrice());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 点的是套餐</span><br>                <span class="hljs-type">Setmeal</span> <span class="hljs-variable">setmeal</span> <span class="hljs-operator">=</span> setmealMapper.getById(shoppingCartDTO.getSetmealId());<br>                shoppingCart.setName(setmeal.getName());<br>                shoppingCart.setImage(setmeal.getImage());<br>                shoppingCart.setAmount(setmeal.getPrice());<br>            &#125;<br>            shoppingCart.setNumber(<span class="hljs-number">1</span>);<br>            shoppingCart.setCreateTime(LocalDateTime.now());<br>            shoppingCartMapper.insert(shoppingCart);<br>        &#125;<br><br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.mapper;<br><br><span class="hljs-keyword">import</span> com.sky.entity.ShoppingCart;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Update;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/8 22:04</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ShoppingCartMapper</span> &#123;<br><br><br>    <span class="hljs-comment">// 根据shoppingCart看购物车有没有这条数据</span><br>    List&lt;ShoppingCart&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(ShoppingCart shoppingCart)</span>;<br>    <br><br>    <span class="hljs-comment">// 根据shoppingCart插入购物车数据</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(ShoppingCart shoppingCart)</span>;<br><br>    <span class="hljs-comment">// 根据id修改份数</span><br>    <span class="hljs-meta">@Update(&quot;update shopping_cart set number = #&#123;number&#125; where id = #&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateNumberById</span><span class="hljs-params">(ShoppingCart shoppingCart)</span>;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.sky.mapper.ShoppingCartMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;list&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.entity.ShoppingCart&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.sky.entity.ShoppingCart&quot;</span>&gt;</span><br>        select * from shopping_cart<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;userId != null&quot;</span>&gt;</span><br>                and user_id = #&#123;userId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;dishId != null&quot;</span>&gt;</span><br>                and dish_id = #&#123;dishId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;setmealId != null&quot;</span>&gt;</span><br>                and setmeal_id = #&#123;setmealId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;dishFlavor != null&quot;</span>&gt;</span><br>                and dish_flavor = #&#123;dishFlavor&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>        order by create_time desc<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insert&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.entity.ShoppingCart&quot;</span>&gt;</span><br>        insert into shopping_cart(<br>            name, user_id, dish_id, setmeal_id, dish_flavor, number,<br>                amount, image, create_time<br>        )<br>        values (<br>            #&#123;name&#125;,#&#123;userId&#125;,#&#123;dishId&#125;,#&#123;setmealId&#125;,#&#123;dishFlavor&#125;,#&#123;number&#125;,<br>                #&#123;amount&#125;,#&#123;image&#125;,#&#123;createTime&#125;<br>        )<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="查看购物车"><a href="#查看购物车" class="headerlink" title="查看购物车"></a>查看购物车</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查看购物车</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;查看购物车&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;ShoppingCart&gt;&gt; <span class="hljs-title function_">list</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> Result.success(shoppingCartService.showShoppingCart());<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查看购物车</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><br>List&lt;ShoppingCart&gt; <span class="hljs-title function_">showShoppingCart</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查看购物车</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;ShoppingCart&gt; <span class="hljs-title function_">showShoppingCart</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> shoppingCartMapper.list(ShoppingCart.builder().userId(BaseContext.getCurrentId()).build());<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="清空购物车"><a href="#清空购物车" class="headerlink" title="清空购物车"></a>清空购物车</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 清空购物车</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;清空购物车&quot;)</span><br><span class="hljs-meta">@DeleteMapping(&quot;/clean&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">clean</span><span class="hljs-params">()</span>&#123;<br>    shoppingCartService.cleanShoppingCart();<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 清空购物车</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanShoppingCart</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 清空购物车</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanShoppingCart</span><span class="hljs-params">()</span> &#123;<br>    shoppingCartMapper.deleteByUserId(BaseContext.getCurrentId());<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 清空购物车</span><br><span class="hljs-meta">@Delete(&quot;delete from shopping_cart where user_id=#&#123;currentId&#125;&quot;)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteByUserId</span><span class="hljs-params">(Long currentId)</span>;<br></code></pre></td></tr></table></figure><h1 id="day08"><a href="#day08" class="headerlink" title="day08"></a>day08</h1><h2 id="地址簿功能"><a href="#地址簿功能" class="headerlink" title="地址簿功能"></a>地址簿功能</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.user;<br><br><span class="hljs-keyword">import</span> com.sky.context.BaseContext;<br><span class="hljs-keyword">import</span> com.sky.entity.AddressBook;<br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.AddressBookService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user/addressBook&quot;)</span><br><span class="hljs-meta">@Api(tags = &quot;C端地址簿接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddressBookController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressBookService addressBookService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询当前登录用户的所有地址信息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;查询当前登录用户的所有地址信息&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;List&lt;AddressBook&gt;&gt; <span class="hljs-title function_">list</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddressBook</span>();<br>        addressBook.setUserId(BaseContext.getCurrentId());<br>        List&lt;AddressBook&gt; list = addressBookService.list(addressBook);<br>        <span class="hljs-keyword">return</span> Result.success(list);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-meta">@ApiOperation(&quot;新增地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddressBook addressBook)</span> &#123;<br>        addressBookService.save(addressBook);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;根据id查询地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;AddressBook&gt; <span class="hljs-title function_">getById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> addressBookService.getById(id);<br>        <span class="hljs-keyword">return</span> Result.success(addressBook);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id修改地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PutMapping</span><br>    <span class="hljs-meta">@ApiOperation(&quot;根据id修改地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddressBook addressBook)</span> &#123;<br>        addressBookService.update(addressBook);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置默认地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PutMapping(&quot;/default&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;设置默认地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">setDefault</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddressBook addressBook)</span> &#123;<br>        addressBookService.setDefault(addressBook);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id删除地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@DeleteMapping</span><br>    <span class="hljs-meta">@ApiOperation(&quot;根据id删除地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span> &#123;<br>        addressBookService.deleteById(id);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询默认地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;default&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;查询默认地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;AddressBook&gt; <span class="hljs-title function_">getDefault</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//SQL:select * from address_book where user_id = ? and is_default = 1</span><br>        <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddressBook</span>();<br>        addressBook.setIsDefault(<span class="hljs-number">1</span>);<br>        addressBook.setUserId(BaseContext.getCurrentId());<br>        List&lt;AddressBook&gt; list = addressBookService.list(addressBook);<br><br>        <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span> &amp;&amp; list.size() == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.success(list.get(<span class="hljs-number">0</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;没有查询到默认地址&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.entity.AddressBook;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AddressBookService</span> &#123;<br><br>    List&lt;AddressBook&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    AddressBook <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDefault</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><span class="hljs-keyword">import</span> com.sky.context.BaseContext;<br><span class="hljs-keyword">import</span> com.sky.entity.AddressBook;<br><span class="hljs-keyword">import</span> com.sky.mapper.AddressBookMapper;<br><span class="hljs-keyword">import</span> com.sky.service.AddressBookService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddressBookServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AddressBookService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressBookMapper addressBookMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 条件查询</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;AddressBook&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(AddressBook addressBook)</span> &#123;<br>        <span class="hljs-keyword">return</span> addressBookMapper.list(addressBook);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(AddressBook addressBook)</span> &#123;<br>        addressBook.setUserId(BaseContext.getCurrentId());<br>        addressBook.setIsDefault(<span class="hljs-number">0</span>);<br>        addressBookMapper.insert(addressBook);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id查询</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> AddressBook <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> addressBookMapper.getById(id);<br>        <span class="hljs-keyword">return</span> addressBook;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id修改地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(AddressBook addressBook)</span> &#123;<br>        addressBookMapper.update(addressBook);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置默认地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDefault</span><span class="hljs-params">(AddressBook addressBook)</span> &#123;<br>        <span class="hljs-comment">//1、将当前用户的所有地址修改为非默认地址 update address_book set is_default = ? where user_id = ?</span><br>        addressBook.setIsDefault(<span class="hljs-number">0</span>);<br>        addressBook.setUserId(BaseContext.getCurrentId());<br>        addressBookMapper.updateIsDefaultByUserId(addressBook);<br><br>        <span class="hljs-comment">//2、将当前地址改为默认地址 update address_book set is_default = ? where id = ?</span><br>        addressBook.setIsDefault(<span class="hljs-number">1</span>);<br>        addressBookMapper.update(addressBook);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id删除地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span> &#123;<br>        addressBookMapper.deleteById(id);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.mapper;<br><br><span class="hljs-keyword">import</span> com.sky.entity.AddressBook;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.*;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AddressBookMapper</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 条件查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    List&lt;AddressBook&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Insert(&quot;insert into address_book&quot; +</span><br><span class="hljs-meta">            &quot;        (user_id, consignee, phone, sex, province_code, province_name, city_code, city_name, district_code,&quot; +</span><br><span class="hljs-meta">            &quot;         district_name, detail, label, is_default)&quot; +</span><br><span class="hljs-meta">            &quot;        values (#&#123;userId&#125;, #&#123;consignee&#125;, #&#123;phone&#125;, #&#123;sex&#125;, #&#123;provinceCode&#125;, #&#123;provinceName&#125;, #&#123;cityCode&#125;, #&#123;cityName&#125;,&quot; +</span><br><span class="hljs-meta">            &quot;                #&#123;districtCode&#125;, #&#123;districtName&#125;, #&#123;detail&#125;, #&#123;label&#125;, #&#123;isDefault&#125;)&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Select(&quot;select * from address_book where id = #&#123;id&#125;&quot;)</span><br>    AddressBook <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id修改</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据 用户id修改 是否默认地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Update(&quot;update address_book set is_default = #&#123;isDefault&#125; where user_id = #&#123;userId&#125;&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateIsDefaultByUserId</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id删除地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Delete(&quot;delete from address_book where id = #&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.sky.mapper.AddressBookMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;list&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;AddressBook&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;AddressBook&quot;</span>&gt;</span><br>        select * from address_book<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;userId != null&quot;</span>&gt;</span><br>                and user_id = #&#123;userId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phone != null&quot;</span>&gt;</span><br>                and phone = #&#123;phone&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;isDefault != null&quot;</span>&gt;</span><br>                and is_default = #&#123;isDefault&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;addressBook&quot;</span>&gt;</span><br>        update address_book<br>        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;consignee != null&quot;</span>&gt;</span><br>                consignee = #&#123;consignee&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;sex != null&quot;</span>&gt;</span><br>                sex = #&#123;sex&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phone != null&quot;</span>&gt;</span><br>                phone = #&#123;phone&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;detail != null&quot;</span>&gt;</span><br>                detail = #&#123;detail&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;label != null&quot;</span>&gt;</span><br>                label = #&#123;label&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;isDefault != null&quot;</span>&gt;</span><br>                is_default = #&#123;isDefault&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>        where id = #&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="用户下单"><a href="#用户下单" class="headerlink" title="用户下单"></a>用户下单</h2><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.user;<br><br><span class="hljs-keyword">import</span> com.sky.dto.OrdersSubmitDTO;<br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.OrderService;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderSubmitVO;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/9 14:22</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController(&quot;userOrderController&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/user/order&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;订单接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户下单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ordersSubmitDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;用户下单&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/submit&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;OrderSubmitVO&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrdersSubmitDTO ordersSubmitDTO)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;用户下单: &#123;&#125;&quot;</span>, ordersSubmitDTO);<br>        <span class="hljs-type">OrderSubmitVO</span> <span class="hljs-variable">orderSubmitVO</span> <span class="hljs-operator">=</span> orderService.submitOrder(ordersSubmitDTO);<br>        <span class="hljs-keyword">return</span> Result.success(orderSubmitVO);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.dto.*;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderSubmitVO;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户下单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ordersSubmitDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    OrderSubmitVO <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrdersSubmitDTO ordersSubmitDTO)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><span class="hljs-keyword">import</span> cn.hutool.db.sql.Order;<br><span class="hljs-keyword">import</span> com.sky.constant.MessageConstant;<br><span class="hljs-keyword">import</span> com.sky.context.BaseContext;<br><span class="hljs-keyword">import</span> com.sky.dto.OrdersSubmitDTO;<br><span class="hljs-keyword">import</span> com.sky.entity.AddressBook;<br><span class="hljs-keyword">import</span> com.sky.entity.OrderDetail;<br><span class="hljs-keyword">import</span> com.sky.entity.Orders;<br><span class="hljs-keyword">import</span> com.sky.entity.ShoppingCart;<br><span class="hljs-keyword">import</span> com.sky.exception.AddressBookBusinessException;<br><span class="hljs-keyword">import</span> com.sky.exception.ShoppingCartBusinessException;<br><span class="hljs-keyword">import</span> com.sky.mapper.AddressBookMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.OrderDetailMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.OrderMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.ShoppingCartMapper;<br><span class="hljs-keyword">import</span> com.sky.service.OrderService;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderSubmitVO;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.sky.constant.MessageConstant.ADDRESS_BOOK_IS_NULL;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.sky.constant.MessageConstant.SHOPPING_CART_IS_NULL;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/9 14:36</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderMapper orderMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderDetailMapper orderDetailMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ShoppingCartMapper shoppingCartMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressBookMapper addressBookMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户下单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ordersSubmitDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> OrderSubmitVO <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrdersSubmitDTO ordersSubmitDTO)</span> &#123;<br>        <span class="hljs-comment">// 异常情况处理 (收货地址为空, 超出配送范围, 购物车为空)</span><br>        <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> addressBookMapper.getById(ordersSubmitDTO.getAddressBookId());<br>        <span class="hljs-keyword">if</span> (addressBook == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 用户地址为空</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddressBookBusinessException</span>(ADDRESS_BOOK_IS_NULL);<br>        &#125;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br>        <span class="hljs-type">ShoppingCart</span> <span class="hljs-variable">shoppingCart</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShoppingCart</span>();<br>        shoppingCart.setUserId(userId);<br><br>        <span class="hljs-comment">// 查询当前用户购物车数据</span><br>        List&lt;ShoppingCart&gt; shoppingCartList = shoppingCartMapper.list(shoppingCart);<br>        <span class="hljs-keyword">if</span> (shoppingCartList==<span class="hljs-literal">null</span> || shoppingCartList.size()==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">// 购物车数据为空</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShoppingCartBusinessException</span>(SHOPPING_CART_IS_NULL);<br>        &#125;<br><br>        <span class="hljs-comment">// 构造订单数据</span><br>        <span class="hljs-type">Orders</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>        BeanUtils.copyProperties(ordersSubmitDTO, order);<br>        order.setPhone(addressBook.getPhone());<br>        order.setAddress(addressBook.getDetail());<br>        order.setConsignee(addressBook.getConsignee());<br>        order.setNumber(String.valueOf(System.currentTimeMillis()));<br>        order.setUserId(userId);<br>        order.setStatus(Orders.PENDING_PAYMENT);<br>        order.setPayStatus(Orders.UN_PAID);<br>        order.setOrderTime(LocalDateTime.now());<br><br>        <span class="hljs-comment">// 向订单插入1条数据</span><br>        orderMapper.insert(order);<br><br>        <span class="hljs-comment">// 订单明细数据</span><br>        List&lt;OrderDetail&gt; orderDetailList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (ShoppingCart cart : shoppingCartList) &#123;<br>            <span class="hljs-type">OrderDetail</span> <span class="hljs-variable">orderDetail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetail</span>();<br>            BeanUtils.copyProperties(cart, orderDetail);<br>            orderDetail.setOrderId(order.getId());<br>            orderDetailList.add(orderDetail);<br>        &#125;<br><br>        <span class="hljs-comment">// 向明细表插入n条数据</span><br>        orderDetailMapper.insertBatch(orderDetailList);<br><br>        <span class="hljs-comment">// 清理购物车中的数据</span><br>        shoppingCartMapper.deleteByUserId(userId);<br><br>        <span class="hljs-comment">// 封装返回结果</span><br>        <span class="hljs-type">OrderSubmitVO</span> <span class="hljs-variable">orderSubmitVO</span> <span class="hljs-operator">=</span> OrderSubmitVO.builder()<br>                .id(order.getId())<br>                .orderNumber(order.getNumber())<br>                .orderAmount(order.getAmount())<br>                .orderTime(order.getOrderTime()).build();<br><br>        <span class="hljs-keyword">return</span> orderSubmitVO;<br>    &#125;<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.mapper;<br><br><span class="hljs-keyword">import</span> com.sky.entity.OrderDetail;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/9 14:37</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderDetailMapper</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 批量插入订单明细数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderDetails</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertBatch</span><span class="hljs-params">(List&lt;OrderDetail&gt; orderDetails)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.sky.mapper.OrderDetailMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertBatch&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;list&quot;</span>&gt;</span><br>        insert into order_detail<br>        (name, order_id, dish_id, setmeal_id, dish_flavor, number, amount, image)<br>        values<br>        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;orderDetails&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;od&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span>&gt;</span><br>            (#&#123;od.name&#125;,#&#123;od.orderId&#125;,#&#123;od.dishId&#125;,#&#123;od.setmealId&#125;,#&#123;od.dishFlavor&#125;,<br>            #&#123;od.number&#125;,#&#123;od.amount&#125;,#&#123;od.image&#125;)<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>dto</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.dto;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersSubmitDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">//地址簿id</span><br>    <span class="hljs-keyword">private</span> Long addressBookId;<br>    <span class="hljs-comment">//付款方式</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> payMethod;<br>    <span class="hljs-comment">//备注</span><br>    <span class="hljs-keyword">private</span> String remark;<br>    <span class="hljs-comment">//预计送达时间</span><br>    <span class="hljs-meta">@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-keyword">private</span> LocalDateTime estimatedDeliveryTime;<br>    <span class="hljs-comment">//配送状态  1立即送出  0选择具体时间</span><br>    <span class="hljs-keyword">private</span> Integer deliveryStatus;<br>    <span class="hljs-comment">//餐具数量</span><br>    <span class="hljs-keyword">private</span> Integer tablewareNumber;<br>    <span class="hljs-comment">//餐具数量状态  1按餐量提供  0选择具体数量</span><br>    <span class="hljs-keyword">private</span> Integer tablewareStatus;<br>    <span class="hljs-comment">//打包费</span><br>    <span class="hljs-keyword">private</span> Integer packAmount;<br>    <span class="hljs-comment">//总金额</span><br>    <span class="hljs-keyword">private</span> BigDecimal amount;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>vo</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderSubmitVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">//订单id</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-comment">//订单号</span><br>    <span class="hljs-keyword">private</span> String orderNumber;<br>    <span class="hljs-comment">//订单金额</span><br>    <span class="hljs-keyword">private</span> BigDecimal orderAmount;<br>    <span class="hljs-comment">//下单时间</span><br>    <span class="hljs-keyword">private</span> LocalDateTime orderTime;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="微信支付"><a href="#微信支付" class="headerlink" title="微信支付"></a><strong>微信支付</strong></h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221214223302651.png" alt="image-20221214223302651" style="zoom:50%;" /><p><strong>支付流程</strong></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221214223910840.png" alt="image-20221214223910840" style="zoom:67%;" /><p><strong>准备</strong></p><p>2步关键步骤</p><ol><li>在商户系统调用微信后台的<code>下单</code>接口, 生成预支付<code>交易单</code>(卖家生成小票)</li><li>支付成功后微信后台会<code>推送消息</code>(把小票给买家看)</li></ol><p><strong>获取微信支付平台证书、商户私钥文件：</strong>(获取非常麻烦, 这里假设有)</p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221214234038395.png" alt="image-20221214234038395" style="zoom:50%;" /><p><strong>如何调用商户系统?</strong></p><p>调用过程本质是HTTP请求, 商户系统ip地址是当前自己电脑的ip, 微信后台无法调用</p><p>解决</p><p>内网穿透, <a href="https://dashboard.cpolar.com/get-started">cpolar</a>获得临时域名</p><p>cpolar 指定 authtoken </p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231209164033732.png" alt="image-20231209164033732"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231209164135850.png" alt="image-20231209164135850"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231209164217390.png" alt="image-20231209164217390"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231209164228949.png" alt="image-20231209164228949"></p><p>此时访问两个页面效果相同</p><p><a href="http://localhost:8080/doc.html#/home">http://localhost:8080/doc.html#/home</a></p><p><a href="https://249dad03.r1.cpolar.top/doc.html#/home">https://249dad03.r1.cpolar.top/doc.html#/home</a></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231209170311868.png" alt="image-20231209170311868"></p><p><strong>相关配置</strong></p><p>application-dev.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">sky:</span><br>  <span class="hljs-attr">wechat:</span><br>    <span class="hljs-attr">appid:</span> <span class="hljs-string">wxcd2e39f677fd30ba</span><br>    <span class="hljs-attr">secret:</span> <span class="hljs-string">84fbfdf5ea288f0c432d829599083637</span><br>    <span class="hljs-attr">mchid :</span> <span class="hljs-number">1561414331</span><br>    <span class="hljs-attr">mchSerialNo:</span> <span class="hljs-string">4B3B3DC35414AD50B1B755BAF8DE9CC7CF407606</span><br>    <span class="hljs-attr">privateKeyFilePath:</span> <span class="hljs-string">D:\apiclient_key.pem</span><br>    <span class="hljs-attr">apiV3Key:</span> <span class="hljs-string">CZBK51236435wxpay435434323FFDuv3</span><br>    <span class="hljs-attr">weChatPayCertFilePath:</span> <span class="hljs-string">D:\wechatpay_166D96F876F45C7D07CE98952A96EC980368ACFC.pem</span><br>    <span class="hljs-attr">notifyUrl:</span> <span class="hljs-string">https://www.weixin.qq.com/wxpay/pay.php</span><br>    <span class="hljs-attr">refundNotifyUrl:</span> <span class="hljs-string">https://www.weixin.qq.com/wxpay/pay.php</span><br></code></pre></td></tr></table></figure><p>application.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">sky:</span><br>  <span class="hljs-attr">wechat:</span><br>    <span class="hljs-attr">appid:</span> <span class="hljs-string">$&#123;sky.wechat.appid&#125;</span><br>    <span class="hljs-attr">secret:</span> <span class="hljs-string">$&#123;sky.wechat.secret&#125;</span><br>    <span class="hljs-attr">mchid :</span> <span class="hljs-string">$&#123;sky.wechat.mchid&#125;</span><br>    <span class="hljs-attr">mchSerialNo:</span> <span class="hljs-string">$&#123;sky.wechat.mchSerialNo&#125;</span><br>    <span class="hljs-attr">privateKeyFilePath:</span> <span class="hljs-string">$&#123;sky.wechat.privateKeyFilePath&#125;</span><br>    <span class="hljs-attr">apiV3Key:</span> <span class="hljs-string">$&#123;sky.wechat.apiV3Key&#125;</span><br>    <span class="hljs-attr">weChatPayCertFilePath:</span> <span class="hljs-string">$&#123;sky.wechat.weChatPayCertFilePath&#125;</span><br>    <span class="hljs-attr">notifyUrl:</span> <span class="hljs-string">$&#123;sky.wechat.notifyUrl&#125;</span><br>    <span class="hljs-attr">refundNotifyUrl:</span> <span class="hljs-string">$&#123;sky.wechat.refundNotifyUrl&#125;</span><br><br></code></pre></td></tr></table></figure><p>WeChatProperties.java：读取配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.properties;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;sky.wechat&quot;)</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeChatProperties</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String appid; <span class="hljs-comment">//小程序的appid</span><br>    <span class="hljs-keyword">private</span> String secret; <span class="hljs-comment">//小程序的秘钥</span><br>    <span class="hljs-keyword">private</span> String mchid; <span class="hljs-comment">//商户号</span><br>    <span class="hljs-keyword">private</span> String mchSerialNo; <span class="hljs-comment">//商户API证书的证书序列号</span><br>    <span class="hljs-keyword">private</span> String privateKeyFilePath; <span class="hljs-comment">//商户私钥文件</span><br>    <span class="hljs-keyword">private</span> String apiV3Key; <span class="hljs-comment">//证书解密的密钥</span><br>    <span class="hljs-keyword">private</span> String weChatPayCertFilePath; <span class="hljs-comment">//平台证书</span><br>    <span class="hljs-keyword">private</span> String notifyUrl; <span class="hljs-comment">//支付成功的回调地址</span><br>    <span class="hljs-keyword">private</span> String refundNotifyUrl; <span class="hljs-comment">//退款成功的回调地址</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据订单号和用户id查询订单</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> orderNumber</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Select(&quot;select * from orders where number = #&#123;orderNumber&#125; and user_id= #&#123;userId&#125;&quot;)</span><br>   Orders <span class="hljs-title function_">getByNumberAndUserId</span><span class="hljs-params">(String orderNumber, Long userId)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 修改订单信息</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> orders</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Orders orders)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.entity.Orders&quot;</span>&gt;</span><br>        update orders<br>        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;cancelReason != null and cancelReason!=&#x27;&#x27; &quot;</span>&gt;</span><br>                cancel_reason=#&#123;cancelReason&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;rejectionReason != null and rejectionReason!=&#x27;&#x27; &quot;</span>&gt;</span><br>                rejection_reason=#&#123;rejectionReason&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;cancelTime != null&quot;</span>&gt;</span><br>                cancel_time=#&#123;cancelTime&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;payStatus != null&quot;</span>&gt;</span><br>                pay_status=#&#123;payStatus&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;payMethod != null&quot;</span>&gt;</span><br>                pay_method=#&#123;payMethod&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;checkoutTime != null&quot;</span>&gt;</span><br>                checkout_time=#&#123;checkoutTime&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span><br>                status = #&#123;status&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;deliveryTime != null&quot;</span>&gt;</span><br>                delivery_time = #&#123;deliveryTime&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>        where id = #&#123;id&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 订单支付</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> ordersPaymentDTO</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   OrderPaymentVO <span class="hljs-title function_">payment</span><span class="hljs-params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 支付成功，修改订单状态</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> outTradeNo</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">paySuccess</span><span class="hljs-params">(String outTradeNo)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> UserMapper userMapper;<br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> WeChatPayUtil weChatPayUtil;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 订单支付</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersPaymentDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> OrderPaymentVO <span class="hljs-title function_">payment</span><span class="hljs-params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 当前登录用户id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.getById(userId);<br><br>    <span class="hljs-comment">//调用微信支付接口，生成预支付交易单</span><br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> weChatPayUtil.pay(<br>            ordersPaymentDTO.getOrderNumber(), <span class="hljs-comment">//商户订单号</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>), <span class="hljs-comment">//支付金额，单位 元</span><br>            <span class="hljs-string">&quot;苍穹外卖订单&quot;</span>, <span class="hljs-comment">//商品描述</span><br>            user.getOpenid() <span class="hljs-comment">//微信用户的openid</span><br>    );<br><br>    <span class="hljs-keyword">if</span> (jsonObject.getString(<span class="hljs-string">&quot;code&quot;</span>) != <span class="hljs-literal">null</span> &amp;&amp; jsonObject.getString(<span class="hljs-string">&quot;code&quot;</span>).equals(<span class="hljs-string">&quot;ORDERPAID&quot;</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(<span class="hljs-string">&quot;该订单已支付&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">OrderPaymentVO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> jsonObject.toJavaObject(OrderPaymentVO.class);<br>    vo.setPackageStr(jsonObject.getString(<span class="hljs-string">&quot;package&quot;</span>));<br><br>    <span class="hljs-keyword">return</span> vo;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 支付成功，修改订单状态</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> outTradeNo</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">paySuccess</span><span class="hljs-params">(String outTradeNo)</span> &#123;<br>    <span class="hljs-comment">// 当前登录用户id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br><br>    <span class="hljs-comment">// 根据订单号查询当前用户的订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getByNumberAndUserId(outTradeNo, userId);<br><br>    <span class="hljs-comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> Orders.builder()<br>            .id(ordersDB.getId())<br>            .status(Orders.TO_BE_CONFIRMED)<br>            .payStatus(Orders.PAID)<br>            .checkoutTime(LocalDateTime.now())<br>            .build();<br><br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>WechatPayUtil.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.utils;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.sky.properties.WeChatProperties;<br><span class="hljs-keyword">import</span> com.wechat.pay.contrib.apache.httpclient.WechatPayHttpClientBuilder;<br><span class="hljs-keyword">import</span> com.wechat.pay.contrib.apache.httpclient.util.PemUtil;<br><span class="hljs-keyword">import</span> org.apache.commons.lang.RandomStringUtils;<br><span class="hljs-keyword">import</span> org.apache.http.HttpHeaders;<br><span class="hljs-keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;<br><span class="hljs-keyword">import</span> org.apache.http.client.methods.HttpGet;<br><span class="hljs-keyword">import</span> org.apache.http.client.methods.HttpPost;<br><span class="hljs-keyword">import</span> org.apache.http.entity.ContentType;<br><span class="hljs-keyword">import</span> org.apache.http.entity.StringEntity;<br><span class="hljs-keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;<br><span class="hljs-keyword">import</span> org.apache.http.util.EntityUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileNotFoundException;<br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.security.PrivateKey;<br><span class="hljs-keyword">import</span> java.security.Signature;<br><span class="hljs-keyword">import</span> java.security.cert.X509Certificate;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 微信支付工具类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeChatPayUtil</span> &#123;<br><br>    <span class="hljs-comment">//微信支付下单接口地址</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">JSAPI</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi&quot;</span>;<br><br>    <span class="hljs-comment">//申请退款接口地址</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">REFUNDS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://api.mch.weixin.qq.com/v3/refund/domestic/refunds&quot;</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WeChatProperties weChatProperties;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取调用微信接口的客户端工具对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> CloseableHttpClient <span class="hljs-title function_">getClient</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">PrivateKey</span> <span class="hljs-variable">merchantPrivateKey</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//merchantPrivateKey商户API私钥，如何加载商户API私钥请看常见问题</span><br>            merchantPrivateKey = PemUtil.loadPrivateKey(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(weChatProperties.getPrivateKeyFilePath())));<br>            <span class="hljs-comment">//加载平台证书文件</span><br>            <span class="hljs-type">X509Certificate</span> <span class="hljs-variable">x509Certificate</span> <span class="hljs-operator">=</span> PemUtil.loadCertificate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(weChatProperties.getWeChatPayCertFilePath())));<br>            <span class="hljs-comment">//wechatPayCertificates微信支付平台证书列表。你也可以使用后面章节提到的“定时更新平台证书功能”，而不需要关心平台证书的来龙去脉</span><br>            List&lt;X509Certificate&gt; wechatPayCertificates = Arrays.asList(x509Certificate);<br><br>            <span class="hljs-type">WechatPayHttpClientBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> WechatPayHttpClientBuilder.create()<br>                    .withMerchant(weChatProperties.getMchid(), weChatProperties.getMchSerialNo(), merchantPrivateKey)<br>                    .withWechatPay(wechatPayCertificates);<br><br>            <span class="hljs-comment">// 通过WechatPayHttpClientBuilder构造的HttpClient，会自动的处理签名和验签</span><br>            <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> builder.build();<br>            <span class="hljs-keyword">return</span> httpClient;<br>        &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发送post方式请求</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> url</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> body</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">post</span><span class="hljs-params">(String url, String body)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> getClient();<br><br>        <span class="hljs-type">HttpPost</span> <span class="hljs-variable">httpPost</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpPost</span>(url);<br>        httpPost.addHeader(HttpHeaders.ACCEPT, ContentType.APPLICATION_JSON.toString());<br>        httpPost.addHeader(HttpHeaders.CONTENT_TYPE, ContentType.APPLICATION_JSON.toString());<br>        httpPost.addHeader(<span class="hljs-string">&quot;Wechatpay-Serial&quot;</span>, weChatProperties.getMchSerialNo());<br>        httpPost.setEntity(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEntity</span>(body, <span class="hljs-string">&quot;UTF-8&quot;</span>));<br><br>        <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpClient.execute(httpPost);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">bodyAsString</span> <span class="hljs-operator">=</span> EntityUtils.toString(response.getEntity());<br>            <span class="hljs-keyword">return</span> bodyAsString;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            httpClient.close();<br>            response.close();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发送get方式请求</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> url</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> getClient();<br><br>        <span class="hljs-type">HttpGet</span> <span class="hljs-variable">httpGet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>(url);<br>        httpGet.addHeader(HttpHeaders.ACCEPT, ContentType.APPLICATION_JSON.toString());<br>        httpGet.addHeader(HttpHeaders.CONTENT_TYPE, ContentType.APPLICATION_JSON.toString());<br>        httpGet.addHeader(<span class="hljs-string">&quot;Wechatpay-Serial&quot;</span>, weChatProperties.getMchSerialNo());<br><br>        <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpClient.execute(httpGet);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">bodyAsString</span> <span class="hljs-operator">=</span> EntityUtils.toString(response.getEntity());<br>            <span class="hljs-keyword">return</span> bodyAsString;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            httpClient.close();<br>            response.close();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * jsapi下单</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderNum    商户订单号</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> total       总金额</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> description 商品描述</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> openid      微信用户的openid</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">jsapi</span><span class="hljs-params">(String orderNum, BigDecimal total, String description, String openid)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;appid&quot;</span>, weChatProperties.getAppid());<br>        jsonObject.put(<span class="hljs-string">&quot;mchid&quot;</span>, weChatProperties.getMchid());<br>        jsonObject.put(<span class="hljs-string">&quot;description&quot;</span>, description);<br>        jsonObject.put(<span class="hljs-string">&quot;out_trade_no&quot;</span>, orderNum);<br>        jsonObject.put(<span class="hljs-string">&quot;notify_url&quot;</span>, weChatProperties.getNotifyUrl());<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">amount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        amount.put(<span class="hljs-string">&quot;total&quot;</span>, total.multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">100</span>)).setScale(<span class="hljs-number">2</span>, BigDecimal.ROUND_HALF_UP).intValue());<br>        amount.put(<span class="hljs-string">&quot;currency&quot;</span>, <span class="hljs-string">&quot;CNY&quot;</span>);<br><br>        jsonObject.put(<span class="hljs-string">&quot;amount&quot;</span>, amount);<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">payer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        payer.put(<span class="hljs-string">&quot;openid&quot;</span>, openid);<br><br>        jsonObject.put(<span class="hljs-string">&quot;payer&quot;</span>, payer);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> jsonObject.toJSONString();<br>        <span class="hljs-keyword">return</span> post(JSAPI, body);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 小程序支付</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderNum    商户订单号</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> total       金额，单位 元</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> description 商品描述</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> openid      微信用户的openid</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> JSONObject <span class="hljs-title function_">pay</span><span class="hljs-params">(String orderNum, BigDecimal total, String description, String openid)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//统一下单，生成预支付交易单</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">bodyAsString</span> <span class="hljs-operator">=</span> jsapi(orderNum, total, description, openid);<br>        <span class="hljs-comment">//解析返回结果</span><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSON.parseObject(bodyAsString);<br>        System.out.println(jsonObject);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">prepayId</span> <span class="hljs-operator">=</span> jsonObject.getString(<span class="hljs-string">&quot;prepay_id&quot;</span>);<br>        <span class="hljs-keyword">if</span> (prepayId != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">timeStamp</span> <span class="hljs-operator">=</span> String.valueOf(System.currentTimeMillis() / <span class="hljs-number">1000</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">nonceStr</span> <span class="hljs-operator">=</span> RandomStringUtils.randomNumeric(<span class="hljs-number">32</span>);<br>            ArrayList&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            list.add(weChatProperties.getAppid());<br>            list.add(timeStamp);<br>            list.add(nonceStr);<br>            list.add(<span class="hljs-string">&quot;prepay_id=&quot;</span> + prepayId);<br>            <span class="hljs-comment">//二次签名，调起支付需要重新签名</span><br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            <span class="hljs-keyword">for</span> (Object o : list) &#123;<br>                stringBuilder.append(o).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">signMessage</span> <span class="hljs-operator">=</span> stringBuilder.toString();<br>            <span class="hljs-type">byte</span>[] message = signMessage.getBytes();<br><br>            <span class="hljs-type">Signature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> Signature.getInstance(<span class="hljs-string">&quot;SHA256withRSA&quot;</span>);<br>            signature.initSign(PemUtil.loadPrivateKey(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(weChatProperties.getPrivateKeyFilePath()))));<br>            signature.update(message);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">packageSign</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(signature.sign());<br><br>            <span class="hljs-comment">//构造数据给微信小程序，用于调起微信支付</span><br>            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>            jo.put(<span class="hljs-string">&quot;timeStamp&quot;</span>, timeStamp);<br>            jo.put(<span class="hljs-string">&quot;nonceStr&quot;</span>, nonceStr);<br>            jo.put(<span class="hljs-string">&quot;package&quot;</span>, <span class="hljs-string">&quot;prepay_id=&quot;</span> + prepayId);<br>            jo.put(<span class="hljs-string">&quot;signType&quot;</span>, <span class="hljs-string">&quot;RSA&quot;</span>);<br>            jo.put(<span class="hljs-string">&quot;paySign&quot;</span>, packageSign);<br><br>            <span class="hljs-keyword">return</span> jo;<br>        &#125;<br>        <span class="hljs-keyword">return</span> jsonObject;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 申请退款</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> outTradeNo    商户订单号</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> outRefundNo   商户退款单号</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> refund        退款金额</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> total         原订单金额</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">refund</span><span class="hljs-params">(String outTradeNo, String outRefundNo, BigDecimal refund, BigDecimal total)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;out_trade_no&quot;</span>, outTradeNo);<br>        jsonObject.put(<span class="hljs-string">&quot;out_refund_no&quot;</span>, outRefundNo);<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">amount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        amount.put(<span class="hljs-string">&quot;refund&quot;</span>, refund.multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">100</span>)).setScale(<span class="hljs-number">2</span>, BigDecimal.ROUND_HALF_UP).intValue());<br>        amount.put(<span class="hljs-string">&quot;total&quot;</span>, total.multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">100</span>)).setScale(<span class="hljs-number">2</span>, BigDecimal.ROUND_HALF_UP).intValue());<br>        amount.put(<span class="hljs-string">&quot;currency&quot;</span>, <span class="hljs-string">&quot;CNY&quot;</span>);<br><br>        jsonObject.put(<span class="hljs-string">&quot;amount&quot;</span>, amount);<br>        jsonObject.put(<span class="hljs-string">&quot;notify_url&quot;</span>, weChatProperties.getRefundNotifyUrl());<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> jsonObject.toJSONString();<br><br>        <span class="hljs-comment">//调用申请退款接口</span><br>        <span class="hljs-keyword">return</span> post(REFUNDS, body);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>controller</strong></p><p>orderController</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 订单支付</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> ordersPaymentDTO</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@PutMapping(&quot;/payment&quot;)</span><br>  <span class="hljs-meta">@ApiOperation(&quot;订单支付&quot;)</span><br>  <span class="hljs-keyword">public</span> Result&lt;OrderPaymentVO&gt; <span class="hljs-title function_">payment</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrdersPaymentDTO ordersPaymentDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      log.info(<span class="hljs-string">&quot;订单支付：&#123;&#125;&quot;</span>, ordersPaymentDTO);<br>      <span class="hljs-type">OrderPaymentVO</span> <span class="hljs-variable">orderPaymentVO</span> <span class="hljs-operator">=</span> orderService.payment(ordersPaymentDTO);<br>      log.info(<span class="hljs-string">&quot;生成预支付交易单：&#123;&#125;&quot;</span>, orderPaymentVO);<br>      <span class="hljs-keyword">return</span> Result.success(orderPaymentVO);<br>  &#125;<br></code></pre></td></tr></table></figure><p>PayNotifycontroller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.notify;<br><br><span class="hljs-keyword">import</span> com.alibaba.druid.support.json.JSONUtils;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.sky.annotation.IgnoreToken;<br><span class="hljs-keyword">import</span> com.sky.properties.WeChatProperties;<br><span class="hljs-keyword">import</span> com.sky.service.OrderService;<br><span class="hljs-keyword">import</span> com.wechat.pay.contrib.apache.httpclient.util.AesUtil;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.http.entity.ContentType;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 支付回调相关接口</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/notify&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayNotifyController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WeChatProperties weChatProperties;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 支付成功回调</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/paySuccess&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">paySuccessNotify</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//读取数据</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> readData(request);<br>        log.info(<span class="hljs-string">&quot;支付成功回调：&#123;&#125;&quot;</span>, body);<br><br>        <span class="hljs-comment">//数据解密</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">plainText</span> <span class="hljs-operator">=</span> decryptData(body);<br>        log.info(<span class="hljs-string">&quot;解密后的文本：&#123;&#125;&quot;</span>, plainText);<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSON.parseObject(plainText);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">outTradeNo</span> <span class="hljs-operator">=</span> jsonObject.getString(<span class="hljs-string">&quot;out_trade_no&quot;</span>);<span class="hljs-comment">//商户平台订单号</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> jsonObject.getString(<span class="hljs-string">&quot;transaction_id&quot;</span>);<span class="hljs-comment">//微信支付交易号</span><br><br>        log.info(<span class="hljs-string">&quot;商户平台订单号：&#123;&#125;&quot;</span>, outTradeNo);<br>        log.info(<span class="hljs-string">&quot;微信支付交易号：&#123;&#125;&quot;</span>, transactionId);<br><br>        <span class="hljs-comment">//业务处理，修改订单状态、来单提醒</span><br>        orderService.paySuccess(outTradeNo);<br><br>        <span class="hljs-comment">//给微信响应</span><br>        responseToWeixin(response);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 读取数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">readData</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> request.getReader();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (result.length() &gt; <span class="hljs-number">0</span>) &#123;<br>                result.append(<span class="hljs-string">&quot;\n&quot;</span>);<br>            &#125;<br>            result.append(line);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result.toString();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 数据解密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> body</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">decryptData</span><span class="hljs-params">(String body)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">resultObject</span> <span class="hljs-operator">=</span> JSON.parseObject(body);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resultObject.getJSONObject(<span class="hljs-string">&quot;resource&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ciphertext</span> <span class="hljs-operator">=</span> resource.getString(<span class="hljs-string">&quot;ciphertext&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nonce</span> <span class="hljs-operator">=</span> resource.getString(<span class="hljs-string">&quot;nonce&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">associatedData</span> <span class="hljs-operator">=</span> resource.getString(<span class="hljs-string">&quot;associated_data&quot;</span>);<br><br>        <span class="hljs-type">AesUtil</span> <span class="hljs-variable">aesUtil</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AesUtil</span>(weChatProperties.getApiV3Key().getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-comment">//密文解密</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">plainText</span> <span class="hljs-operator">=</span> aesUtil.decryptToString(associatedData.getBytes(StandardCharsets.UTF_8),<br>                nonce.getBytes(StandardCharsets.UTF_8),<br>                ciphertext);<br><br>        <span class="hljs-keyword">return</span> plainText;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 给微信响应</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">responseToWeixin</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        response.setStatus(<span class="hljs-number">200</span>);<br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;SUCCESS&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;SUCCESS&quot;</span>);<br>        response.setHeader(<span class="hljs-string">&quot;Content-type&quot;</span>, ContentType.APPLICATION_JSON.toString());<br>        response.getOutputStream().write(JSONUtils.toJSONString(map).getBytes(StandardCharsets.UTF_8));<br>        response.flushBuffer();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221215205122716.png" alt="image-20221215205122716" style="zoom: 80%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221215205122716.png" alt="image-20221215205122716" style="zoom: 80%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221215205434552.png" alt="image-20221215205434552" style="zoom:80%;" /><h1 id="day-09"><a href="#day-09" class="headerlink" title="day 09"></a>day 09</h1><h2 id="用户端历史订单模块"><a href="#用户端历史订单模块" class="headerlink" title="用户端历史订单模块"></a>用户端历史订单模块</h2><h3 id="历史订单"><a href="#历史订单" class="headerlink" title="历史订单"></a>历史订单</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221128092537535.png" alt="image-20221128092537535"></p><ul><li>分页查询历史订单</li><li>可以根据订单状态查询</li><li>展示订单数据， 需要展示数据： 下单时间，订单状态，订单金额，订单明细</li></ul><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 历史订单查询</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> page</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageSize</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status   订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/historyOrders&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;历史订单查询&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;PageResult&gt; <span class="hljs-title function_">page</span><span class="hljs-params">(<span class="hljs-type">int</span> page, <span class="hljs-type">int</span> pageSize, Integer status)</span> &#123;<br>    <span class="hljs-type">PageResult</span> <span class="hljs-variable">pageResult</span> <span class="hljs-operator">=</span> orderService.pageQuery4User(page, pageSize, status);<br>    <span class="hljs-keyword">return</span> Result.success(pageResult);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户端订单分页查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> page</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageSize</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>PageResult <span class="hljs-title function_">pageQuery4User</span><span class="hljs-params">(<span class="hljs-type">int</span> page, <span class="hljs-type">int</span> pageSize, Integer status)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户端订单分页查询</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageNum</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageSize</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> PageResult <span class="hljs-title function_">pageQuery4User</span><span class="hljs-params">(<span class="hljs-type">int</span> pageNum, <span class="hljs-type">int</span> pageSize, Integer status)</span> &#123;<br>        <span class="hljs-comment">// 设置分页</span><br>        PageHelper.startPage(pageNum, pageSize);<br><br>        <span class="hljs-type">OrdersPageQueryDTO</span> <span class="hljs-variable">ordersPageQueryDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrdersPageQueryDTO</span>();<br>        ordersPageQueryDTO.setUserId(BaseContext.getCurrentId());<br>        ordersPageQueryDTO.setStatus(status);<br><br>        <span class="hljs-comment">// 分页条件查询</span><br>        Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO);<br><br>        List&lt;OrderVO&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>        <span class="hljs-comment">// 查询出订单明细，并封装入OrderVO进行响应</span><br>        <span class="hljs-keyword">if</span> (page != <span class="hljs-literal">null</span> &amp;&amp; page.getTotal() &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">for</span> (Orders orders : page) &#123;<br>                <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orders.getId();<span class="hljs-comment">// 订单id</span><br><br>                <span class="hljs-comment">// 查询订单明细</span><br>                List&lt;OrderDetail&gt; orderDetails = orderDetailMapper.getByOrderId(orderId);<br><br>                <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderVO</span>();<br>                BeanUtils.copyProperties(orders, orderVO);<br>                orderVO.setOrderDetailList(orderDetails);<br><br>                list.add(orderVO);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>(page.getTotal(), list);<br>    &#125;<br></code></pre></td></tr></table></figure><p>mapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 分页条件查询并按下单时间排序</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersPageQueryDTO</span><br><span class="hljs-comment"> */</span><br>Page&lt;Orders&gt; <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(OrdersPageQueryDTO ordersPageQueryDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pageQuery&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Orders&quot;</span>&gt;</span><br>       select * from orders<br>       <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;number != null and number!=&#x27;&#x27;&quot;</span>&gt;</span><br>               and number like concat(&#x27;%&#x27;,#&#123;number&#125;,&#x27;%&#x27;)<br>           <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phone != null and phone!=&#x27;&#x27;&quot;</span>&gt;</span><br>               and phone like concat(&#x27;%&#x27;,#&#123;phone&#125;,&#x27;%&#x27;)<br>           <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;userId != null&quot;</span>&gt;</span><br>               and user_id = #&#123;userId&#125;<br>           <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span><br>               and status = #&#123;status&#125;<br>           <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;beginTime != null&quot;</span>&gt;</span><br>               and order_time <span class="hljs-symbol">&amp;gt;</span>= #&#123;beginTime&#125;<br>           <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;endTime != null&quot;</span>&gt;</span><br>               and order_time <span class="hljs-symbol">&amp;lt;</span>= #&#123;endTime&#125;<br>           <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>       order by order_time desc<br>   <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据订单id查询订单明细</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Select(&quot;select * from order_detail where order_id = #&#123;orderId&#125;&quot;)</span><br>List&lt;OrderDetail&gt; <span class="hljs-title function_">getByOrderId</span><span class="hljs-params">(Long orderId)</span>;<br></code></pre></td></tr></table></figure><h3 id="查询订单"><a href="#查询订单" class="headerlink" title="查询订单"></a>查询订单</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221128102144294.png" alt="image-20221128102144294"></p><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询订单详情</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;查询订单详情&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/orderDetail/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;OrderVO&gt; <span class="hljs-title function_">details</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;<br>    <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> orderService.details(id);<br>    <span class="hljs-keyword">return</span> Result.success(orderVO);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询订单详情</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>OrderVO <span class="hljs-title function_">details</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询订单详情</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">details</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br><br>    <span class="hljs-comment">// 根据订单查询对应的菜品/套餐明细</span><br>    List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId());<br><br>    <span class="hljs-comment">// 将订单及其详情封装到OrderVO中并返回</span><br>    <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderVO</span>();<br>    BeanUtils.copyProperties(orders, orderVO);<br>    orderVO.setOrderDetailList(orderDetailList);<br><br>    <span class="hljs-keyword">return</span> orderVO;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id查询订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Select(&quot;select * from orders where id=#&#123;id&#125;&quot;)</span><br>Orders <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><h3 id="取消订单"><a href="#取消订单" class="headerlink" title="取消订单"></a>取消订单</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221128145444268.png" alt="image-20221128145444268"></p><ul><li>待支付和待接单状态， 可以直接取消订单</li><li>已接单状态， 取消需要和店家电话沟通</li><li>派送中状态， 取消需要和店家电话沟通</li><li>如果待接单状态取消订单， 需要给用户退款</li><li>取消订单后需要将订单状态修改为  <code>已取消</code></li></ul><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 取消订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;取消订单&quot;)</span><br><span class="hljs-meta">@PutMapping(&quot;/cancel/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">cancel</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    orderService.userCancelById(id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户取消订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">userCancelById</span><span class="hljs-params">(Long id)</span> <span class="hljs-keyword">throws</span> Exception;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户取消订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userCancelById</span><span class="hljs-params">(Long id)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br><br>    <span class="hljs-comment">// 校验订单是否存在</span><br>    <span class="hljs-keyword">if</span> (ordersDB == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(ORDER_NOT_FOUND);<br>    &#125;<br><br>    <span class="hljs-comment">// 订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</span><br>    <span class="hljs-keyword">if</span> (ordersDB.getStatus() &gt; TO_BE_CONFIRMED) &#123; <span class="hljs-comment">// &gt; 2</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(ORDER_STATUS_ERROR);<br>    &#125;<br><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>    orders.setId(ordersDB.getId());<br><br>    <span class="hljs-comment">// 订单处于待接单状态, 需要退款</span><br>    <span class="hljs-keyword">if</span> (ordersDB.getStatus().equals(TO_BE_CONFIRMED))&#123; <span class="hljs-comment">// = 2</span><br>         <span class="hljs-comment">// 调用微信支付接口退款</span><br>        weChatPayUtil.refund(<br>                ordersDB.getNumber(), <span class="hljs-comment">// 商户订单号</span><br>                ordersDB.getAddress(), <span class="hljs-comment">// 商户退款单号</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>), <span class="hljs-comment">// 退款金额, 单位 元</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>) <span class="hljs-comment">// 原订单金额</span><br>                            );<br>        <span class="hljs-comment">// 支付状态修改为 `退款`</span><br>        orders.setPayStatus(REFUND);<br>    &#125;<br><br>    <span class="hljs-comment">// 更新订单状态, 取消原因, 取消时间</span><br>    orders.setStatus(CANCELLED);<br>    orders.setCancelReason(<span class="hljs-string">&quot;用户取消&quot;</span>);<br>    orders.setCancelTime(LocalDateTime.now());<br>    orderMapper.update(orders);<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="再来一单"><a href="#再来一单" class="headerlink" title="再来一单"></a>再来一单</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221128173238656.png" alt="image-20221128173238656"></p><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 再来一单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;再来一单&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/repetition/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">repetition</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br>    orderService.repetition(id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 再来一单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">repetition</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 再来一单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">repetition</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 查询`用户id`</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br><br>    <span class="hljs-comment">// 根据`订单id`查询当前`订单详情`</span><br>    List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(id);<br><br>    <span class="hljs-comment">// 将`订单详情`对象转换为`购物车对象`</span><br>    <span class="hljs-comment">// orderDetailList -&gt; shoppingCartList</span><br>    List&lt;ShoppingCart&gt; shoppingCartList = orderDetailList.stream().map(x -&gt; &#123;<br>        <span class="hljs-comment">// 购物车对象</span><br>        <span class="hljs-type">ShoppingCart</span> <span class="hljs-variable">shoppingCart</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShoppingCart</span>();<br><br>        <span class="hljs-comment">// 将原订单详情里面的菜品信息复制到购物车对象</span><br>        BeanUtils.copyProperties(x, shoppingCart, <span class="hljs-string">&quot;id&quot;</span>); <span class="hljs-comment">// 忽略id字段</span><br>        shoppingCart.setUserId(userId);<br>        shoppingCart.setCreateTime(LocalDateTime.now());<br><br>        <span class="hljs-comment">// 返回购物车对象</span><br>        <span class="hljs-keyword">return</span> shoppingCart;<br>    &#125;).collect(Collectors.toList()); <span class="hljs-comment">// 收集成购物车列表</span><br><br>    <span class="hljs-comment">// 将购物车对象批量`添加`到数据库</span><br>    shoppingCartMapper.insertBatch(shoppingCartList);<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量插入购物车数据</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> shoppingCartList</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">insertBatch</span><span class="hljs-params">(List&lt;ShoppingCart&gt; shoppingCartList)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertBatch&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.util.List&quot;</span>&gt;</span><br>    insert into shopping_cart(name, image, user_id, dish_id, setmeal_id, dish_flavor, number, amount, create_time) VALUES<br>    <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;shoppingCartList&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;sc&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span>&gt;</span><br>        (#&#123;sc.name&#125;,#&#123;sc.image&#125;,#&#123;sc.userId&#125;,#&#123;sc.dishId&#125;,#&#123;sc.setmealId&#125;,#&#123;sc.dishFlavor&#125;,#&#123;sc.number&#125;,#&#123;sc.amount&#125;,#&#123;sc.createTime&#125;)        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="管理端订单管理模块"><a href="#管理端订单管理模块" class="headerlink" title="管理端订单管理模块"></a>管理端订单管理模块</h2><h3 id="订单搜索"><a href="#订单搜索" class="headerlink" title="订单搜索"></a>订单搜索</h3><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单搜索</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ordersPageQueryDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiOperation(&quot;订单搜索&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/conditionSearch&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;PageResult&gt; <span class="hljs-title function_">conditionSearch</span><span class="hljs-params">(OrdersPageQueryDTO ordersPageQueryDTO)</span>&#123;<br>        <span class="hljs-type">PageResult</span> <span class="hljs-variable">pageResult</span> <span class="hljs-operator">=</span> orderService.conditionSearch(ordersPageQueryDTO);<br>        <span class="hljs-keyword">return</span> Result.success(pageResult);<br>    &#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 订单搜索</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> ordersPageQueryDTO</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   PageResult <span class="hljs-title function_">conditionSearch</span><span class="hljs-params">(OrdersPageQueryDTO ordersPageQueryDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单搜索</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ordersPageQueryDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PageResult <span class="hljs-title function_">conditionSearch</span><span class="hljs-params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> &#123;<br>        PageHelper.startPage(ordersPageQueryDTO.getPage(), ordersPageQueryDTO.getPageSize());<br><br>        Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO);<br><br>        <span class="hljs-comment">// 部分订单状态, 需要额外返回`订单菜品信息`, 将Orders转换成OrderVO</span><br>        List&lt;OrderVO&gt; orderVOList = getOrderVOList(page);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>(page.getTotal(), orderVOList);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获得 OrderVOList</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> page</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> List&lt;OrderVO&gt; <span class="hljs-title function_">getOrderVOList</span><span class="hljs-params">(Page&lt;Orders&gt; page)</span> &#123;<br>        <span class="hljs-comment">// 需要返回菜品信息, 自定义OrderVO响应结果</span><br>        List&lt;Orders&gt; ordersList = page.getResult();<br>        List&lt;OrderVO&gt; orderVOList = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (!ListUtil.empty().isEmpty()) &#123;<br>            orderVOList = ordersList.stream().map(x -&gt; &#123;<br>                <span class="hljs-comment">// 将共同字段赋值到 OrderVO</span><br>                <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderVO</span>();<br>                BeanUtils.copyProperties(x, orderVO);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">orderDishes</span> <span class="hljs-operator">=</span> getOrderDishesStr(x);<br><br>                <span class="hljs-comment">// 将订单菜品信息封装到orderVO中, 添加到orderVOList</span><br>                orderVO.setOrderDishes(orderDishes);<br>                <span class="hljs-keyword">return</span> orderVO;<br>            &#125;).collect(Collectors.toList());<br>        &#125;<br>        <span class="hljs-keyword">return</span> orderVOList;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据orderId获取菜品信息字符串</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orders</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getOrderDishesStr</span><span class="hljs-params">(Orders orders)</span> &#123;<br>        <span class="hljs-comment">// 查一下订单菜品详情信息 (订单中的菜品和数量)</span><br>        List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId());<br><br>        <span class="hljs-comment">// 将每一条订单菜品信息拼接成字符串</span><br>        List&lt;String&gt; orderDishList = orderDetailList.stream()<br>                .map(x -&gt; x.getName() + <span class="hljs-string">&quot;*&quot;</span> + x.getNumber() + <span class="hljs-string">&quot;;&quot;</span>)<br>                .collect(Collectors.toList());<br><br>        <span class="hljs-comment">// 将订单对应的所有菜品信息拼接</span><br>        <span class="hljs-keyword">return</span> String.join(<span class="hljs-string">&quot;&quot;</span>, orderDishList);<br><br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="各状态订单数量"><a href="#各状态订单数量" class="headerlink" title="各状态订单数量"></a>各状态订单数量</h3><p><strong>controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 各个状态的订单数量统计</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;各个状态的订单数量统计&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/statistics&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;OrderStatisticsVO&gt; <span class="hljs-title function_">statistics</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">OrderStatisticsVO</span> <span class="hljs-variable">orderStatisticsVO</span> <span class="hljs-operator">=</span> orderService.statistics();<br>    <span class="hljs-keyword">return</span> Result.success(orderStatisticsVO);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 各个状态的订单数量统计</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>OrderStatisticsVO <span class="hljs-title function_">statistics</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 各个状态的订单数量统计</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> OrderStatisticsVO <span class="hljs-title function_">statistics</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 根据状态, 查询出待接单,待派送,派送中的订单数量</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">toBeConfirmed</span> <span class="hljs-operator">=</span> orderMapper.countStatus(TO_BE_CONFIRMED);<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">confirmed</span> <span class="hljs-operator">=</span> orderMapper.countStatus(CONFIRMED);<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">deliveryInProgress</span> <span class="hljs-operator">=</span> orderMapper.countStatus(DELIVERY_IN_PROGRESS);<br><br>    <span class="hljs-comment">// 将查询出的数据封装到orderStatisticsVO中响应</span><br>    <span class="hljs-type">OrderStatisticsVO</span> <span class="hljs-variable">orderStatisticsVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderStatisticsVO</span>();<br>    orderStatisticsVO.setToBeConfirmed(toBeConfirmed);<br>    orderStatisticsVO.setConfirmed(confirmed);<br>    orderStatisticsVO.setDeliveryInProgress(deliveryInProgress);<br><br>    <span class="hljs-keyword">return</span> orderStatisticsVO;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>VO</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderStatisticsVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">//待接单数量</span><br>    <span class="hljs-keyword">private</span> Integer toBeConfirmed;<br><br>    <span class="hljs-comment">//待派送数量</span><br>    <span class="hljs-keyword">private</span> Integer confirmed;<br><br>    <span class="hljs-comment">//派送中数量</span><br>    <span class="hljs-keyword">private</span> Integer deliveryInProgress;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据状态统计订单数量</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Select(&quot;select count(id) from orders where status = #&#123;status&#125;&quot;)</span><br>Integer <span class="hljs-title function_">countStatus</span><span class="hljs-params">(Integer status)</span>;<br></code></pre></td></tr></table></figure><h3 id="查询订单详情"><a href="#查询订单详情" class="headerlink" title="查询订单详情"></a>查询订单详情</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询订单详情</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;查询订单详情&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/details/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;OrderVO&gt; <span class="hljs-title function_">details</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br>    <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> orderService.details(id);<br>    <span class="hljs-keyword">return</span> Result.success(orderVO);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="接单"><a href="#接单" class="headerlink" title="接单"></a>接单</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221129105142623.png" alt="image-20221129105142623"></p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221129105116285.png" alt="image-20221129105116285"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;接单&quot;)</span><br><span class="hljs-meta">@PutMapping(&quot;/confirm&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">confirm</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrdersConfirmDTO ordersConfirmDTO)</span>&#123;<br>    orderService.confirm(ordersConfirmDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 接单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersConfirmDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(OrdersConfirmDTO ordersConfirmDTO)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 接单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersConfirmDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(OrdersConfirmDTO ordersConfirmDTO)</span> &#123;<br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> builder().id(ordersConfirmDTO.getId()).status(CONFIRMED).build();<br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="拒单"><a href="#拒单" class="headerlink" title="拒单"></a>拒单</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221129110428390.png" alt="image-20221129110428390"></p><ul><li>商家拒单其实就是将订单状态修改为“已取消”</li><li>只有订单处于“待接单”状态时可以执行拒单操作</li><li>商家拒单时需要指定拒单原因</li><li>商家拒单时，如果用户已经完成了支付，需要为用户退款</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 拒单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersRejectionDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;拒单&quot;)</span><br><span class="hljs-meta">@PutMapping(&quot;/rejection&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">rejection</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrdersRejectionDTO ordersRejectionDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    orderService.rejection(ordersRejectionDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 拒单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersRejectionDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">rejection</span><span class="hljs-params">(OrdersRejectionDTO ordersRejectionDTO)</span> <span class="hljs-keyword">throws</span> Exception;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 拒单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersRejectionDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rejection</span><span class="hljs-params">(OrdersRejectionDTO ordersRejectionDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getById(ordersRejectionDTO.getId());<br><br>    <span class="hljs-comment">// 订单只有状态为2才能拒单</span><br>    <span class="hljs-keyword">if</span> (ordersDB == <span class="hljs-literal">null</span> || !ordersDB.getStatus().equals(TO_BE_CONFIRMED))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(ORDER_STATUS_ERROR);<br>    &#125;<br><br>    <span class="hljs-comment">// 支付状态</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">payStatus</span> <span class="hljs-operator">=</span> ordersDB.getPayStatus();<br>    <span class="hljs-keyword">if</span> (payStatus == PAID) &#123;<br>        <span class="hljs-comment">// 用户已支付,需要退款</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">refund</span> <span class="hljs-operator">=</span> weChatPayUtil.refund(<br>                ordersDB.getNumber(),<br>                ordersDB.getNumber(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>)<br>        );<br>        log.info(<span class="hljs-string">&quot;申请退款: &#123;&#125;&quot;</span>, refund);<br>    &#125;<br><br>    <span class="hljs-comment">// 拒单需要退款, 根据订单id更新订单状态, 拒单原因, 取消时间</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>    orders.setId(ordersDB.getId());<br>    orders.setStatus(CANCELLED);<br>    orders.setRejectionReason(ordersRejectionDTO.getRejectionReason());<br>    orders.setCancelTime(LocalDateTime.now());<br><br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="取消订单-1"><a href="#取消订单-1" class="headerlink" title="取消订单"></a>取消订单</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221129111402099.png" alt="image-20221129111402099"></p><ul><li>取消订单其实就是将订单状态修改为“已取消”</li><li>商家取消订单时需要指定取消原因</li><li>商家取消订单时，如果用户已经完成了支付，需要为用户退款</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 取消订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersCancelDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;取消订单&quot;)</span><br><span class="hljs-meta">@PutMapping(&quot;/cancel&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">rejection</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrdersCancelDTO ordersCancelDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    orderService.cancel(ordersCancelDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 取消订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersCancelDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(OrdersCancelDTO ordersCancelDTO)</span> <span class="hljs-keyword">throws</span> Exception;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 商家取消订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersCancelDTO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(OrdersCancelDTO ordersCancelDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orderDB</span> <span class="hljs-operator">=</span> orderMapper.getById(ordersCancelDTO.getId());<br>    <br>    <span class="hljs-comment">// 支付状态</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">payStatus</span> <span class="hljs-operator">=</span> orderDB.getPayStatus();<br>    <span class="hljs-keyword">if</span> (payStatus == PAID) &#123;<br>        <span class="hljs-comment">// 用户已支付, 需要退款</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">refund</span> <span class="hljs-operator">=</span> weChatPayUtil.refund(<br>                orderDB.getNumber(),<br>                orderDB.getNumber(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>)<br>        );<br>        log.info(<span class="hljs-string">&quot;申请退款: &#123;&#125;&quot;</span>, refund);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 管理端取消订单需要退款, 根据订单id更新订单状态, 取消原因, 取消时间</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>    orders.setId(ordersCancelDTO.getId());<br>    orders.setStatus(CANCELLED);<br>    orders.setCancelReason(ordersCancelDTO.getCancelReason());<br>    orders.setOrderTime(LocalDateTime.now());<br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="派送订单"><a href="#派送订单" class="headerlink" title="派送订单"></a>派送订单</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 派送订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;派送订单&quot;)</span><br><span class="hljs-meta">@PutMapping(&quot;/delivery/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">delivery</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>    orderService.delivery(id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 派送订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">delivery</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 派送订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delivery</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orderDB</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br>    <br>    <span class="hljs-comment">// 校验订单是否存在, 且状态=3</span><br>    <span class="hljs-keyword">if</span> (orderDB==<span class="hljs-literal">null</span> &amp;&amp; !orderDB.getStatus().equals(CONFIRMED)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(ORDER_STATUS_ERROR);<br>    &#125;<br><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>    orders.setId(orderDB.getId());<br>    <span class="hljs-comment">// 更新订单状态 -&gt; 派送中</span><br>    orders.setStatus(DELIVERY_IN_PROGRESS);<br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="完成订单"><a href="#完成订单" class="headerlink" title="完成订单"></a>完成订单</h3><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221129112554051.png" alt="image-20221129112554051"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 完成订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;完成订单&quot;)</span><br><span class="hljs-meta">@PutMapping(&quot;/complete/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">complete</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br>    orderService.complete(id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 完成订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">complete</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 完成订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complete</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br><br>    <span class="hljs-comment">// 校验订单是否存在, 并且状态为4</span><br>    <span class="hljs-keyword">if</span> (ordersDB == <span class="hljs-literal">null</span> &amp;&amp; !ordersDB.getStatus().equals(DELIVERY_IN_PROGRESS)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR) ;<br>    &#125;<br><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>    orders.setId(ordersDB.getId());<br>    <span class="hljs-comment">// 更新订单状态, 状态为完成</span><br>    orders.setStatus(COMPLETED);<br>    orders.setDeliveryTime(LocalDateTime.now());<br>    <br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="集成百度地图"><a href="#集成百度地图" class="headerlink" title="集成百度地图"></a>集成百度地图</h3><blockquote><p>校验收货地址是否超出配送范围</p></blockquote><p>注册账号：<a href="https://passport.baidu.com/v2/?reg&tt=1671699340600&overseas=&gid=CF954C2-A3D2-417F-9FE6-B0F249ED7E33&tpl=pp&u=https://lbsyun.baidu.com/index.php?title=%E9%A6%96%E9%A1%B5">https://passport.baidu.com/v2/?reg&amp;tt=1671699340600&amp;overseas=&amp;gid=CF954C2-A3D2-417F-9FE6-B0F249ED7E33&amp;tpl=pp&amp;u=https%3A%2F%2Flbsyun.baidu.com%2Findex.php%3Ftitle%3D%E9%A6%96%E9%A1%B5</a></p><p>登录百度地图开放平台：<a href="https://lbsyun.baidu.com/">https://lbsyun.baidu.com/</a></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">shop:</span><br>  <span class="hljs-attr">address:</span> <span class="hljs-string">北京市海淀区上地十街10号</span><br><span class="hljs-attr">baidu:</span><br>  <span class="hljs-attr">ak:</span> <span class="hljs-string">IE2rBMptpxKftF58HIBo0WxjGXSQTpN4</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;$&#123;sky.shop.address&#125;&quot;)</span><br><span class="hljs-keyword">private</span> String shopAddress;<br><br><span class="hljs-meta">@Value(&quot;$&#123;sky.baidu.ak&#125;&quot;)</span><br><span class="hljs-keyword">private</span> String ak;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 检查客户的收货地址是否超出配送范围</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> address</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkOutOfRange</span><span class="hljs-params">(String address)</span> &#123;<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    map.put(<span class="hljs-string">&quot;address&quot;</span>,shopAddress);<br>    map.put(<span class="hljs-string">&quot;output&quot;</span>,<span class="hljs-string">&quot;json&quot;</span>);<br>    map.put(<span class="hljs-string">&quot;ak&quot;</span>,ak);<br><br>    <span class="hljs-comment">//获取店铺的经纬度坐标</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopCoordinate</span> <span class="hljs-operator">=</span> HttpClientUtil.doGet(<span class="hljs-string">&quot;https://api.map.baidu.com/geocoding/v3&quot;</span>, map);<br><br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSON.parseObject(shopCoordinate);<br>    <span class="hljs-keyword">if</span>(!jsonObject.getString(<span class="hljs-string">&quot;status&quot;</span>).equals(<span class="hljs-string">&quot;0&quot;</span>))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(<span class="hljs-string">&quot;店铺地址解析失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//数据解析</span><br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">location</span> <span class="hljs-operator">=</span> jsonObject.getJSONObject(<span class="hljs-string">&quot;result&quot;</span>).getJSONObject(<span class="hljs-string">&quot;location&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">lat</span> <span class="hljs-operator">=</span> location.getString(<span class="hljs-string">&quot;lat&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">lng</span> <span class="hljs-operator">=</span> location.getString(<span class="hljs-string">&quot;lng&quot;</span>);<br>    <span class="hljs-comment">//店铺经纬度坐标</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopLngLat</span> <span class="hljs-operator">=</span> lat + <span class="hljs-string">&quot;,&quot;</span> + lng;<br><br>    map.put(<span class="hljs-string">&quot;address&quot;</span>,address);<br>    <span class="hljs-comment">//获取用户收货地址的经纬度坐标</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">userCoordinate</span> <span class="hljs-operator">=</span> HttpClientUtil.doGet(<span class="hljs-string">&quot;https://api.map.baidu.com/geocoding/v3&quot;</span>, map);<br><br>    jsonObject = JSON.parseObject(userCoordinate);<br>    <span class="hljs-keyword">if</span>(!jsonObject.getString(<span class="hljs-string">&quot;status&quot;</span>).equals(<span class="hljs-string">&quot;0&quot;</span>))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(<span class="hljs-string">&quot;收货地址解析失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//数据解析</span><br>    location = jsonObject.getJSONObject(<span class="hljs-string">&quot;result&quot;</span>).getJSONObject(<span class="hljs-string">&quot;location&quot;</span>);<br>    lat = location.getString(<span class="hljs-string">&quot;lat&quot;</span>);<br>    lng = location.getString(<span class="hljs-string">&quot;lng&quot;</span>);<br>    <span class="hljs-comment">//用户收货地址经纬度坐标</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">userLngLat</span> <span class="hljs-operator">=</span> lat + <span class="hljs-string">&quot;,&quot;</span> + lng;<br><br>    map.put(<span class="hljs-string">&quot;origin&quot;</span>,shopLngLat);<br>    map.put(<span class="hljs-string">&quot;destination&quot;</span>,userLngLat);<br>    map.put(<span class="hljs-string">&quot;steps_info&quot;</span>,<span class="hljs-string">&quot;0&quot;</span>);<br><br>    <span class="hljs-comment">//路线规划</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> HttpClientUtil.doGet(<span class="hljs-string">&quot;https://api.map.baidu.com/directionlite/v1/driving&quot;</span>, map);<br><br>    jsonObject = JSON.parseObject(json);<br>    <span class="hljs-keyword">if</span>(!jsonObject.getString(<span class="hljs-string">&quot;status&quot;</span>).equals(<span class="hljs-string">&quot;0&quot;</span>))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(<span class="hljs-string">&quot;配送路线规划失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//数据解析</span><br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jsonObject.getJSONObject(<span class="hljs-string">&quot;result&quot;</span>);<br>    <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> (JSONArray) result.get(<span class="hljs-string">&quot;routes&quot;</span>);<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">distance</span> <span class="hljs-operator">=</span> (Integer) ((JSONObject) jsonArray.get(<span class="hljs-number">0</span>)).get(<span class="hljs-string">&quot;distance&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(distance &gt; <span class="hljs-number">5000</span>)&#123;<br>        <span class="hljs-comment">//配送距离超过5000米</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(<span class="hljs-string">&quot;超出配送范围&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户下单</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> ordersSubmitDTO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> OrderSubmitVO <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrdersSubmitDTO ordersSubmitDTO)</span> &#123;<br>    <span class="hljs-comment">// 异常情况处理 (收货地址为空, 超出配送范围, 购物车为空)</span><br>    <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> addressBookMapper.getById(ordersSubmitDTO.getAddressBookId());<br>    <span class="hljs-keyword">if</span> (addressBook == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 用户地址为空</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddressBookBusinessException</span>(ADDRESS_BOOK_IS_NULL);<br>    &#125;<br><br>    <span class="hljs-comment">// 检查用户收货地址是否超出配送范围</span><br>    checkOutOfRange(addressBook.getCityName() + addressBook.getDistrictName() + addressBook.getDetail());<br></code></pre></td></tr></table></figure><h1 id="day-10"><a href="#day-10" class="headerlink" title="day 10"></a>day 10</h1><h2 id="Spring-Task"><a href="#Spring-Task" class="headerlink" title="Spring Task"></a>Spring Task</h2><p><strong>订单状态定时处理</strong></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221218204021760.png" alt="image-20221218204021760" style="zoom:50%;" /><p><strong>来单提醒</strong></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221218204119663.png" alt="image-20221218204119663" style="zoom:50%;" /><p><strong>客户催单</strong></p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221218204202847.png" alt="image-20221218204202847" style="zoom:50%;" /><blockquote><p>Spring Task : 定时任务框架, 任务调度工具, 在某个时间点自动执行某个代码逻辑, 适用于<code>所有需要定时处理的业务</code></p></blockquote><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221218183213088.png" alt="image-20221218183213088" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221218183410430.png" alt="image-20221218183410430" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221218183614351.png" alt="image-20221218183614351" style="zoom:50%;" /></p><p><strong>corn 表达式</strong></p><blockquote><p>定义任务触发的 <code>时间</code>,  一般有6 | 7个区域  , 空格分开</p><p>不存在用 ? 表示, 日和周一般只存在一个</p><p>cron表达式在线生成器：<a href="https://cron.qqe2.com/">https://cron.qqe2.com/</a>  <a href="https://cron.qqe2.com/index-old.html">https://cron.qqe2.com/index-old.html</a></p></blockquote><table><thead><tr><th>秒</th><th>分</th><th>时</th><th>日</th><th>周</th><th>月</th><th>年</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>12</td><td>5</td><td>?</td><td>7</td><td>2022</td></tr></tbody></table><p>**通配符 : **</p><p>* 表示所有值； </p><p>? 表示未说明的值，即不关心它为何值； </p><p>- 表示一个指定的范围； </p><p>, 表示附加一个可能值； </p><p>&#x2F; 符号前表示开始时间，符号后表示每次递增的值；</p><p><strong>cron表达式案例：</strong></p><p>*&#x2F;5 * * * * ? 每隔5秒执行一次</p><p>0 *&#x2F;1 * * * ? 每隔1分钟执行一次</p><p>0 0 5-15 * * ? 每天5-15点整点触发</p><p>0 0&#x2F;3 * * * ? 每三分钟触发一次</p><p>0 0-5 14 * * ? 在每天下午2点到下午2:05期间的每1分钟触发 </p><p>0 0&#x2F;5 14 * * ? 在每天下午2点到下午2:55期间的每5分钟触发</p><p>0 0&#x2F;5 14,18 * * ? 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发</p><p>0 0&#x2F;30 9-17 * * ? 朝九晚五工作时间内每半小时</p><p>0 0 10,14,16 * * ? 每天上午10点，下午2点，4点 </p><p><strong>启动类添加注解 @EnableScheduling 开启任务调度</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@MapperScan(&quot;com.sky.mapper&quot;)</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableTransactionManagement</span> <span class="hljs-comment">//开启注解方式的事务管理</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-meta">@EnableCaching</span> <span class="hljs-comment">// 开启注解方式的缓存管理</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkyApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(SkyApplication.class, args);<br>        log.info(<span class="hljs-string">&quot;server started&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义定时任务类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定时任务 每隔5秒触发一次</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeTask</span><span class="hljs-params">()</span>&#123;<br>        log.info(<span class="hljs-string">&quot;定时任务开始执行：&#123;&#125;&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231209234659431.png" alt="image-20231209234659431"></p><h2 id="订单状态定时处理"><a href="#订单状态定时处理" class="headerlink" title="订单状态定时处理"></a>订单状态定时处理</h2><blockquote><p>下单未支付, 订单一直 <code>待支付</code>, 用户收货后未点击完成按钮, 订单一直 <code>派送中</code></p></blockquote><p>通过定时任务来修改订单状态</p><ol><li>通过定时任务每分钟检查一次是否存在支付超时订单, 如果存在则修改订单状态 <code>已取消</code></li><li>通过定时任务每天凌晨1点检查一次是否存在<code>派送中</code>的订单, 如果存在则修改订单状态<code>已完成</code></li></ol><p><strong>task</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 处理支付超时订单</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Scheduled(cron = &quot;0 * * * * * ?&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processTimeoutOrder</span><span class="hljs-params">()</span>&#123;<br>    log.info(<span class="hljs-string">&quot;处理支付超时订单: &#123;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> LocalDateTime.now().plusMinutes(-<span class="hljs-number">15</span>);<br><br>    <span class="hljs-comment">// select * from orders where status=1 and order_time&lt;当前时间-15min</span><br>    List&lt;Orders&gt; orderList = orderMapper.getByStatusAndOrdertimeLT(PENDING_PAYMENT, time);<br>    <span class="hljs-keyword">if</span> (orderList != <span class="hljs-literal">null</span> &amp;&amp; orderList.size()&gt;<span class="hljs-number">0</span>)&#123;<br>        orderList.forEach(orders -&gt; &#123;<br>            orders.setStatus(CANCELLED);<br>            orders.setCancelReason(<span class="hljs-string">&quot;支付超时, 自动取消&quot;</span>);<br>            orders.setCancelTime(LocalDateTime.now());<br>            orderMapper.update(orders);<br>        &#125;);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 处理派送中订单</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Scheduled(cron = &quot;0 0 1 * * ?&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processDeliveryOrder</span><span class="hljs-params">()</span>&#123;<br>    log.info(<span class="hljs-string">&quot;处理派送中订单: &#123;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> LocalDateTime.now().plusMinutes(-<span class="hljs-number">60</span>);<br><br>    <span class="hljs-comment">// select * from orders where status=4 and ordertime&lt;当前时间-1小时</span><br>    List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrdertimeLT(DELIVERY_IN_PROGRESS, time);<br>    <span class="hljs-keyword">if</span> (ordersList!=<span class="hljs-literal">null</span> &amp;&amp; ordersList.size()&gt;<span class="hljs-number">0</span>) &#123;<br>        ordersList.forEach(orders -&gt; &#123;<br>            orders.setStatus(COMPLETED);<br>            orderMapper.update(orders);<br>        &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据状态和下单时间查询订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderTime</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Select(&quot;select * from orders where status=#&#123;status&#125; and order_time&lt;#&#123;orderTime&#125;&quot;)</span><br>List&lt;Orders&gt; <span class="hljs-title function_">getByStatusAndOrdertimeLT</span><span class="hljs-params">(Integer status, LocalDateTime orderTime)</span>;<br></code></pre></td></tr></table></figure><h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><blockquote><p>基于TCP的<code>网络协议</code>, 实现浏览器和服务器双工通信, 浏览器和服务器只需要一次握手, 就可以创建持久的链接, 进行双向数据传输</p></blockquote><p><strong>Http  vs  WebSocket</strong></p><ul><li>HTTP是短连接, WebSocket是长连接</li><li>HTTP是<code>单向</code>的, 基于<code>请求响应</code>模式, WebSocket是<code>双向</code>通信, HTTP和WebSocket  底层都是<code>TCP连接</code></li></ul><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221222184340172.png" alt="image-20221222184340172" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221222184352573.png" alt="image-20221222184352573" style="zoom:50%;" /></p><ul><li>websocket缺点: 受网络限制比较大, 需要处理好重连</li></ul><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221222184616570.png" alt="image-20221222184616570" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221222184714092.png" alt="image-20221222184714092" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221222184742094.png" alt="image-20221222184742094" style="zoom:50%;" /><p><strong>案例</strong></p><blockquote><p>实现浏览器和服务器双向通信</p></blockquote><p>1). 直接使用websocket.html页面作为WebSocket客户端</p><p>2). 导入WebSocket的maven坐标</p><p>3). 导入WebSocket服务端组件WebSocketServer，用于和客户端通信</p><p>4). 导入配置类WebSocketConfiguration，注册WebSocket的服务端组件</p><p>5). 导入定时任务类WebSocketTask，定时向客户端推送数据</p><p><strong>客户端</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">HTML</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>WebSocket Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;send()&quot;</span>&gt;</span>发送消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;closeWebSocket()&quot;</span>&gt;</span>关闭连接<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;message&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> websocket = <span class="hljs-literal">null</span>;</span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> clientId = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>);</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//判断当前浏览器是否支持WebSocket</span></span><br><span class="language-javascript">    <span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;WebSocket&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-comment">//连接WebSocket节点</span></span><br><span class="language-javascript">        websocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&quot;ws://localhost:8080/ws/&quot;</span>+clientId);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    <span class="hljs-keyword">else</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;Not support websocket&#x27;</span>)</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//连接发生错误的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-string">&quot;error&quot;</span>);</span><br><span class="language-javascript">    &#125;;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//连接成功建立的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-string">&quot;连接成功&quot;</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//接收到消息的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(event.<span class="hljs-property">data</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//连接关闭的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-string">&quot;close&quot;</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。</span></span><br><span class="language-javascript">    <span class="hljs-variable language_">window</span>.<span class="hljs-property">onbeforeunload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        websocket.<span class="hljs-title function_">close</span>();</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//将消息显示在网页上</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-params">innerHTML</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;message&#x27;</span>).<span class="hljs-property">innerHTML</span> += innerHTML + <span class="hljs-string">&#x27;&lt;br/&gt;&#x27;</span>;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//发送消息</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">var</span> message = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;text&#x27;</span>).<span class="hljs-property">value</span>;</span><br><span class="language-javascript">        websocket.<span class="hljs-title function_">send</span>(message);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">//关闭连接</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">closeWebSocket</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">        websocket.<span class="hljs-title function_">close</span>();</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.websocket;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.websocket.OnClose;<br><span class="hljs-keyword">import</span> javax.websocket.OnMessage;<br><span class="hljs-keyword">import</span> javax.websocket.OnOpen;<br><span class="hljs-keyword">import</span> javax.websocket.Session;<br><span class="hljs-keyword">import</span> javax.websocket.server.PathParam;<br><span class="hljs-keyword">import</span> javax.websocket.server.ServerEndpoint;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Collection;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/10 10:51</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ServerEndpoint(&quot;/ws/&#123;sid&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketServer</span> &#123;<br>    <span class="hljs-comment">// 存放会话对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, Session&gt; sessionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 连接建立成功调用的方法</span><br>    <span class="hljs-meta">@OnOpen</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onOpen</span><span class="hljs-params">(Session session, <span class="hljs-meta">@PathParam(&quot;sid&quot;)</span> String sid)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;客户端: &quot;</span> + sid + <span class="hljs-string">&quot;建立连接&quot;</span>);<br>        sessionMap.put(sid, session);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 收到客户端消息调用的方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sid</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@OnMessage</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message, <span class="hljs-meta">@PathParam(&quot;sid&quot;)</span> String sid)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;收到来自客户端: &quot;</span> + sid + <span class="hljs-string">&quot;的消息:&quot;</span> + message);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 连接关闭调用的方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sid</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@OnClose</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClose</span><span class="hljs-params">(<span class="hljs-meta">@PathParam(&quot;sid&quot;)</span> String sid)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;连接断开: &quot;</span> + sid);<br>        sessionMap.remove(sid);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 群发</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendToAllClient</span><span class="hljs-params">(String message)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Collection&lt;Session&gt; sessions = sessionMap.values();<br>        <span class="hljs-keyword">for</span> (Session session : sessions) &#123;<br>            <span class="hljs-comment">// 服务器向客户端发送消息</span><br>            session.getBasicRemote().sendText(message);<br>        &#125;<br>    &#125;<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.task;<br><br><span class="hljs-keyword">import</span> com.sky.websocket.WebSocketServer;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Scheduled;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/10 10:58</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketTask</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WebSocketServer webSocketServer;<br><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageToClient</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        webSocketServer.sendToAllClient(<span class="hljs-string">&quot;这是来自服务端的消息:&quot;</span> + DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;HH:mm:ss&quot;</span>).format(LocalDateTime.now()));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="来单提醒"><a href="#来单提醒" class="headerlink" title="来单提醒"></a>来单提醒</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221222194450142.png" alt="image-20221222194450142" style="zoom:50%;" /><ul><li>websocket保持管理端和客户端长链接</li><li>客户支付则从服务端向客户端推送消息</li><li>客户端浏览器解析消息, 判断是提醒还是催单, 进行消息提示和语音播报</li><li>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content<ul><li>type 为消息类型，1为来单提醒 2为客户催单</li><li>orderId 为订单id</li><li>content 为消息内容</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 支付成功，修改订单状态</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> outTradeNo</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">paySuccess</span><span class="hljs-params">(String outTradeNo)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 当前登录用户id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br><br>    <span class="hljs-comment">// 根据订单号查询当前用户的订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getByNumberAndUserId(outTradeNo, userId);<br><br>    <span class="hljs-comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> Orders.builder()<br>            .id(ordersDB.getId())<br>            .status(TO_BE_CONFIRMED)<br>            .payStatus(Orders.PAID)<br>            .checkoutTime(LocalDateTime.now())<br>            .build();<br><br>    orderMapper.update(orders);<br><br>    HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    map.put(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// 消息类型: 1是来单提醒</span><br>    map.put(<span class="hljs-string">&quot;orderId&quot;</span>, orders.getId());<br>    map.put(<span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;订单号: &quot;</span>+outTradeNo);<br><br>    <span class="hljs-comment">// 通过WebSocket实现来单提醒, 向客户端浏览器推送消息</span><br>    webSocketServer.sendToAllClient(JSON.toJSONString(map));<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="客户催单"><a href="#客户催单" class="headerlink" title="客户催单"></a>客户催单</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20221222203345829.png" alt="image-20221222203345829" style="zoom:50%;" /><ul><li>通过WebSocket实现管理端页面和服务端保持长连接状态</li><li>当用户点击催单按钮后，调用WebSocket的相关API实现服务端向客户端推送消息</li><li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报<br>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content<ul><li>type 为消息类型，1为来单提醒 2为客户催单</li><li>orderId 为订单id</li><li>content 为消息内容</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户催单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;用户催单&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/reminder/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">reminder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br>    orderService.reminder(id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户催单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">reminder</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户催单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reminder</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 查询订单是否存在</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br>    <span class="hljs-keyword">if</span> (orders==<span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(ORDER_NOT_FOUND);<br>    &#125;<br>    <span class="hljs-comment">// 基于WebSocket实现催单</span><br>    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    map.put(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// 2代表用户催单</span><br>    map.put(<span class="hljs-string">&quot;orderId&quot;</span>, id);<br>    map.put(<span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;订单号:&quot;</span>+orders.getNumber());<br>    <br>    webSocketServer.sendToAllClient(JSON.toJSONString(map));<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="day11"><a href="#day11" class="headerlink" title="day11"></a>day11</h1><h2 id="echarts"><a href="#echarts" class="headerlink" title="echarts"></a>echarts</h2><p>快速入门：<a href="https://echarts.apache.org/handbook/zh/get-started/">https://echarts.apache.org/handbook/zh/get-started/</a></p><p>1). 引入echarts.js 文件(当天资料已提供)</p><p>2). 为 ECharts 准备一个设置宽高的 DOM</p><p>3). 初始化echarts实例</p><p>4). 指定图表的配置项和数据</p><p>5). 使用指定的配置项和数据显示图表</p><p><strong>示例</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ECharts<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 引入刚刚下载的 ECharts 文件 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;echarts.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 为 ECharts 准备一个定义了宽高的 DOM --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;main&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;width: 600px;height:400px;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">      <span class="hljs-comment">// 基于准备好的dom，初始化echarts实例</span></span><br><span class="language-javascript">      <span class="hljs-keyword">var</span> myChart = echarts.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;main&#x27;</span>));</span><br><span class="language-javascript"></span><br><span class="language-javascript">      <span class="hljs-comment">// 指定图表的配置项和数据</span></span><br><span class="language-javascript">      <span class="hljs-keyword">var</span> option = &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">title</span>: &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;ECharts 入门示例&#x27;</span></span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">tooltip</span>: &#123;&#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">legend</span>: &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">data</span>: [<span class="hljs-string">&#x27;销量&#x27;</span>]</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">xAxis</span>: &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">data</span>: [<span class="hljs-string">&#x27;衬衫&#x27;</span>, <span class="hljs-string">&#x27;羊毛衫&#x27;</span>, <span class="hljs-string">&#x27;雪纺衫&#x27;</span>, <span class="hljs-string">&#x27;裤子&#x27;</span>, <span class="hljs-string">&#x27;高跟鞋&#x27;</span>, <span class="hljs-string">&#x27;袜子&#x27;</span>]</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">yAxis</span>: &#123;&#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">series</span>: [</span><br><span class="language-javascript">          &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;销量&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;bar&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-attr">data</span>: [<span class="hljs-number">5</span>, <span class="hljs-number">20</span>, <span class="hljs-number">36</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>]</span><br><span class="language-javascript">          &#125;</span><br><span class="language-javascript">        ]</span><br><span class="language-javascript">      &#125;;</span><br><span class="language-javascript"></span><br><span class="language-javascript">      <span class="hljs-comment">// 使用刚指定的配置项和数据显示图表。</span></span><br><span class="language-javascript">      myChart.<span class="hljs-title function_">setOption</span>(option);</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231210191633902.png" alt="image-20231210191633902"></p><blockquote><p>使用Echarts 重点是研究当前图表所需<code>数据格式</code>, 通常需要后端提供动态数据</p></blockquote><h2 id="营业额统计"><a href="#营业额统计" class="headerlink" title="营业额统计"></a>营业额统计</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20230101160747433.png" alt="image-20230101160747433" style="zoom:50%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TurnoverReportVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span><br>    <span class="hljs-keyword">private</span> String dateList;<br><br>    <span class="hljs-comment">//营业额，以逗号分隔，例如：406.0,1520.0,75.0</span><br>    <span class="hljs-keyword">private</span> String turnoverList;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.admin;<br><br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.ReportService;<br><span class="hljs-keyword">import</span> com.sky.vo.TurnoverReportVO;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.format.annotation.DateTimeFormat;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/10 19:19</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/report&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;统计报表相关接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> ReportService reportSerice;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 营业额数据统计</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/turnoverStatistics&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;营业额数据统计&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;TurnoverReportVO&gt; <span class="hljs-title function_">turnoverStatistics</span><span class="hljs-params">(</span><br><span class="hljs-params">            <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span><br><span class="hljs-params">            <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end</span><br><span class="hljs-params">            )</span> &#123;<br>        <span class="hljs-keyword">return</span> Result.success(reportSerice.getTurnover(begin, end));<br>    &#125;<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.vo.TurnoverReportVO;<br><br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/10 19:25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ReportService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据时间区间统计营业额</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    TurnoverReportVO <span class="hljs-title function_">getTurnover</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><span class="hljs-keyword">import</span> com.sky.mapper.OrderMapper;<br><span class="hljs-keyword">import</span> com.sky.service.ReportService;<br><span class="hljs-keyword">import</span> com.sky.vo.TurnoverReportVO;<br><span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.LocalTime;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.sky.entity.Orders.COMPLETED;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.time.LocalTime.MAX;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.time.LocalTime.MIN;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/10 19:27</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ReportService</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> OrderMapper orderMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据时间区间统计营业额</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> TurnoverReportVO <span class="hljs-title function_">getTurnover</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span> &#123;<br>        List&lt;LocalDate&gt; dateList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        dateList.add(begin);<br><br>        <span class="hljs-keyword">while</span> (!begin.equals(end))&#123;<br>            begin = begin.plusDays(<span class="hljs-number">1</span>); <span class="hljs-comment">// 日期计算， 获得指定日期后1天的日期</span><br>            dateList.add(begin);<br>        &#125;<br><br>        List&lt;Double&gt; turnoverList = dateList.stream().map(date -&gt; &#123;<br>            <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, MIN);<br>            <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, MAX);<br>            <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            map.put(<span class="hljs-string">&quot;status&quot;</span>, COMPLETED);<br>            map.put(<span class="hljs-string">&quot;begin&quot;</span>, beginTime);<br>            map.put(<span class="hljs-string">&quot;end&quot;</span>, endTime);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">turnover</span> <span class="hljs-operator">=</span> orderMapper.sumByMap(map);<br>            turnover = turnover == <span class="hljs-literal">null</span> ? <span class="hljs-number">0.0</span> : turnover;<br>            <span class="hljs-keyword">return</span> turnover;<br>        &#125;).collect(Collectors.toList());<br><br>        <span class="hljs-comment">// 数据封装</span><br>        <span class="hljs-keyword">return</span> TurnoverReportVO.builder()<br>                .dateList(StringUtils.join(dateList, <span class="hljs-string">&quot;,&quot;</span>))<br>                .turnoverList(StringUtils.join(turnoverList, <span class="hljs-string">&quot;,&quot;</span>))<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据动态条件统计营业额</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Double <span class="hljs-title function_">sumByMap</span><span class="hljs-params">(HashMap map)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sumByMap&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.Double&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.util.HashMap&quot;</span>&gt;</span><br>    select sum(amount) from orders<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span>and status=#&#123;status&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;begin != null&quot;</span>&gt;</span>and order_time <span class="hljs-symbol">&amp;gt;</span>= #&#123;begin&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;end != null&quot;</span>&gt;</span>and order_time <span class="hljs-symbol">&amp;lt;</span>= #&#123;end&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="用户统计"><a href="#用户统计" class="headerlink" title="用户统计"></a>用户统计</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20230102213727736.png" alt="image-20230102213727736" style="zoom:50%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserReportVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span><br>    <span class="hljs-keyword">private</span> String dateList;<br><br>    <span class="hljs-comment">//用户总量，以逗号分隔，例如：200,210,220</span><br>    <span class="hljs-keyword">private</span> String totalUserList;<br><br>    <span class="hljs-comment">//新增用户，以逗号分隔，例如：20,21,10</span><br>    <span class="hljs-keyword">private</span> String newUserList;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户数据统计</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/userStatistics&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;用户数据统计&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;UserReportVO&gt; <span class="hljs-title function_">userStatistics</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span><br><span class="hljs-params">        <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end</span><br><span class="hljs-params">)</span>&#123;<br>    <span class="hljs-keyword">return</span> Result.success(reportSerice.getUserStatistics(begin, end));<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据时间区间统计用户数量</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><br>UserReportVO <span class="hljs-title function_">getUserStatistics</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据时间区间统计用户数量</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> UserReportVO <span class="hljs-title function_">getUserStatistics</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span> &#123;<br>    List&lt;LocalDate&gt; dateList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    dateList.add(begin);<br><br>    <span class="hljs-keyword">while</span> (!begin.equals(end))&#123;<br>        begin = begin.plusDays(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    List&lt;Integer&gt; newUserList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(); <span class="hljs-comment">//新增用户数</span><br>    List&lt;Integer&gt; totalUserList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(); <span class="hljs-comment">//总用户数</span><br><br>    <span class="hljs-keyword">for</span> (LocalDate date : dateList) &#123;<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.MIN);<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.MAX);<br>        <span class="hljs-comment">//新增用户数量 select count(id) from user where create_time &gt; ? and create_time &lt; ?</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">newUser</span> <span class="hljs-operator">=</span> getUserCount(beginTime, endTime);<br>        <span class="hljs-comment">//总用户数量 select count(id) from user where  create_time &lt; ?</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">totalUser</span> <span class="hljs-operator">=</span> getUserCount(<span class="hljs-literal">null</span>, endTime);<br><br>        newUserList.add(newUser);<br>        newUserList.add(totalUser);<br><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> UserReportVO.builder()<br>            .dateList(StringUtils.join(dateList, <span class="hljs-string">&quot;,&quot;</span>))<br>            .newUserList(StringUtils.join(newUserList, <span class="hljs-string">&quot;,&quot;</span>))<br>            .totalUserList(StringUtils.join(totalUserList, <span class="hljs-string">&quot;,&quot;</span>))<br>            .build();<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据时间区间统计用户数量</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> beginTime</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> endTime</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">getUserCount</span><span class="hljs-params">(LocalDateTime beginTime, LocalDateTime endTime)</span> &#123;<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;begin&quot;</span>, beginTime);<br>        map.put(<span class="hljs-string">&quot;end&quot;</span>, endTime);<br>        <span class="hljs-keyword">return</span> userMapper.countByMap(map);<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据动态条件统计用户数量</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Integer <span class="hljs-title function_">countByMap</span><span class="hljs-params">(HashMap map)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;countByMap&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.util.HashMap&quot;</span>&gt;</span><br>    select count(id) from user<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;begin != null&quot;</span>&gt;</span><br>                and create_time <span class="hljs-symbol">&amp;gt;</span>= #&#123;begin&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;end != null&quot;</span>&gt;</span><br>                and create_time <span class="hljs-symbol">&amp;lt;</span>= #&#123;end&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="订单统计"><a href="#订单统计" class="headerlink" title="订单统计"></a>订单统计</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20230107192859270.png" alt="image-20230107192859270" style="zoom:50%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderReportVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span><br>    <span class="hljs-keyword">private</span> String dateList;<br><br>    <span class="hljs-comment">//每日订单数，以逗号分隔，例如：260,210,215</span><br>    <span class="hljs-keyword">private</span> String orderCountList;<br><br>    <span class="hljs-comment">//每日有效订单数，以逗号分隔，例如：20,21,10</span><br>    <span class="hljs-keyword">private</span> String validOrderCountList;<br><br>    <span class="hljs-comment">//订单总数</span><br>    <span class="hljs-keyword">private</span> Integer totalOrderCount;<br><br>    <span class="hljs-comment">//有效订单数</span><br>    <span class="hljs-keyword">private</span> Integer validOrderCount;<br><br>    <span class="hljs-comment">//订单完成率</span><br>    <span class="hljs-keyword">private</span> Double orderCompletionRate;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 订单数据统计</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;订单数据统计&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/ordersStatistics&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;OrderReportVO&gt; <span class="hljs-title function_">orderStatistics</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span><br><span class="hljs-params">        <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end</span><br><span class="hljs-params">)</span>&#123;<br>    <span class="hljs-keyword">return</span> Result.success(reportService.getOrderStatistics(begin, end));<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据时间区间统计订单数量</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>OrderReportVO <span class="hljs-title function_">getOrderStatistics</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据时间区间统计订单数量</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> OrderReportVO <span class="hljs-title function_">getOrderStatistics</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span> &#123;<br>    List&lt;LocalDate&gt; dateList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    dateList.add(begin);<br><br>    <span class="hljs-keyword">while</span> (!begin.equals(end))&#123;<br>        begin=begin.plusDays(<span class="hljs-number">1</span>);<br>        dateList.add(begin);<br>    &#125;<br><br>    <span class="hljs-comment">// 每天订单总数集合</span><br>    List&lt;Integer&gt; orderCountList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">//每天有效订单数集合</span><br>    List&lt;Integer&gt; validOrderCountList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (LocalDate date : dateList) &#123;<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.MIN);<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.MAX);<br><br>        <span class="hljs-comment">//查询每天的总订单数 select count(id) from orders where order_time &gt; ? and order_time &lt; ?</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">orderCount</span> <span class="hljs-operator">=</span> getOrderCount(beginTime, endTime, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//查询每天的有效订单数 select count(id) from orders where order_time &gt; ? and order_time &lt; ? and status = ?</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">validOrderCount</span> <span class="hljs-operator">=</span> getOrderCount(beginTime, endTime, COMPLETED);<br><br>        orderCountList.add(orderCount);<br>        validOrderCountList.add(validOrderCount);<br>    &#125;<br><br>    <span class="hljs-comment">// 时间区间内的总订单数</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">totalOrderCount</span> <span class="hljs-operator">=</span> orderCountList.stream().reduce(Integer::sum).get();<br>    <span class="hljs-comment">// 时间区间内的总有效订单数</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">validOrderCount</span> <span class="hljs-operator">=</span> validOrderCountList.stream().reduce(Integer::sum).get();<br>    <span class="hljs-comment">// 订单完成率</span><br>    <span class="hljs-type">Double</span> <span class="hljs-variable">orderCompletionRate</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;<br>    <span class="hljs-keyword">if</span> (totalOrderCount != <span class="hljs-number">0</span>)&#123;<br>        orderCompletionRate = validOrderCount.doubleValue() / totalOrderCount;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> OrderReportVO.builder()<br>            .dateList(StringUtils.join(dateList, <span class="hljs-string">&quot;,&quot;</span>))<br>            .orderCountList(StringUtils.join(orderCountList, <span class="hljs-string">&quot;,&quot;</span>))<br>            .validOrderCountList(StringUtils.join(validOrderCountList, <span class="hljs-string">&quot;,&quot;</span>))<br>            .totalOrderCount(totalOrderCount)<br>            .validOrderCount(validOrderCount)<br>            .orderCompletionRate(orderCompletionRate)<br>            .build();<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据时间区间统计指定状态的订单数量</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> beginTime</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> endTime</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">getOrderCount</span><span class="hljs-params">(LocalDateTime beginTime, LocalDateTime endTime, Integer status)</span> &#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, status);<br>        map.put(<span class="hljs-string">&quot;begin&quot;</span>, beginTime);<br>        map.put(<span class="hljs-string">&quot;end&quot;</span>, endTime);<br>        <span class="hljs-keyword">return</span> orderMapper.countByMap(map);<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据动态条件统计用户数量</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Integer <span class="hljs-title function_">countByMap</span><span class="hljs-params">(HashMap map)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.sky.mapper.UserMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;countByMap&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.util.HashMap&quot;</span>&gt;</span><br>        select count(id) from user<br>            <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;begin != null&quot;</span>&gt;</span><br>                    and create_time <span class="hljs-symbol">&amp;gt;</span>= #&#123;begin&#125;<br>                <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;end != null&quot;</span>&gt;</span><br>                    and create_time <span class="hljs-symbol">&amp;lt;</span>= #&#123;end&#125;<br>                <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="销量前10"><a href="#销量前10" class="headerlink" title="销量前10"></a>销量前10</h2><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20230107203622747.png" alt="image-20230107203622747" style="zoom:50%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SalesTop10ReportVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//商品名称列表，以逗号分隔，例如：鱼香肉丝,宫保鸡丁,水煮鱼</span><br>    <span class="hljs-keyword">private</span> String nameList;<br><br>    <span class="hljs-comment">//销量列表，以逗号分隔，例如：260,215,200</span><br>    <span class="hljs-keyword">private</span> String numberList;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 销量排名统计</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/top10&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;销量排名统计&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;SalesTop10ReportVO&gt; <span class="hljs-title function_">top10</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span><br><span class="hljs-params">        <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end)</span>&#123;<br>    <span class="hljs-keyword">return</span> Result.success(reportService.getSalesTop10(begin,end));<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询指定时间区间内的销量排名top10</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>SalesTop10ReportVO <span class="hljs-title function_">getSalesTop10</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询指定时间区间内的销量排名top10</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> * */</span><br><span class="hljs-keyword">public</span> SalesTop10ReportVO <span class="hljs-title function_">getSalesTop10</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span>&#123;<br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(begin, LocalTime.MIN);<br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(end, LocalTime.MAX);<br>    List&lt;GoodsSalesDTO&gt; goodsSalesDTOList = orderMapper.getSalesTop10(beginTime, endTime);<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">nameList</span> <span class="hljs-operator">=</span> StringUtils.join(goodsSalesDTOList.stream().map(GoodsSalesDTO::getName).collect(Collectors.toList()),<span class="hljs-string">&quot;,&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">numberList</span> <span class="hljs-operator">=</span> StringUtils.join(goodsSalesDTOList.stream().map(GoodsSalesDTO::getNumber).collect(Collectors.toList()),<span class="hljs-string">&quot;,&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> SalesTop10ReportVO.builder()<br>            .nameList(nameList)<br>            .numberList(numberList)<br>            .build();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据动态条件统计用户数量</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Integer <span class="hljs-title function_">countByMap</span><span class="hljs-params">(HashMap map)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.sky.mapper.UserMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;countByMap&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.util.HashMap&quot;</span>&gt;</span><br>        select count(id) from user<br>            <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;begin != null&quot;</span>&gt;</span><br>                    and create_time <span class="hljs-symbol">&amp;gt;</span>= #&#123;begin&#125;<br>                <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;end != null&quot;</span>&gt;</span><br>                    and create_time <span class="hljs-symbol">&amp;lt;</span>= #&#123;end&#125;<br>                <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="day12"><a href="#day12" class="headerlink" title="day12"></a>day12</h1><h2 id="工作台"><a href="#工作台" class="headerlink" title="工作台"></a>工作台</h2><p>Controller层</p><p><strong>添加WorkSpaceController.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.admin;<br><br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.WorkspaceService;<br><span class="hljs-keyword">import</span> com.sky.vo.BusinessDataVO;<br><span class="hljs-keyword">import</span> com.sky.vo.DishOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.SetmealOverViewVO;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.LocalTime;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 工作台</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/workspace&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;工作台相关接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkSpaceController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WorkspaceService workspaceService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 工作台今日数据查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/businessData&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;工作台今日数据查询&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;BusinessDataVO&gt; <span class="hljs-title function_">businessData</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//获得当天的开始时间</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> LocalDateTime.now().with(LocalTime.MIN);<br>        <span class="hljs-comment">//获得当天的结束时间</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> LocalDateTime.now().with(LocalTime.MAX);<br><br>        <span class="hljs-type">BusinessDataVO</span> <span class="hljs-variable">businessDataVO</span> <span class="hljs-operator">=</span> workspaceService.getBusinessData(begin, end);<br>        <span class="hljs-keyword">return</span> Result.success(businessDataVO);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询订单管理数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/overviewOrders&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;查询订单管理数据&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;OrderOverViewVO&gt; <span class="hljs-title function_">orderOverView</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Result.success(workspaceService.getOrderOverView());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询菜品总览</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/overviewDishes&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;查询菜品总览&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;DishOverViewVO&gt; <span class="hljs-title function_">dishOverView</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Result.success(workspaceService.getDishOverView());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询套餐总览</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/overviewSetmeals&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;查询套餐总览&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;SetmealOverViewVO&gt; <span class="hljs-title function_">setmealOverView</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Result.success(workspaceService.getSetmealOverView());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Service</strong>层接口</p><p><strong>添加WorkspaceService.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.vo.BusinessDataVO;<br><span class="hljs-keyword">import</span> com.sky.vo.DishOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.SetmealOverViewVO;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WorkspaceService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据时间段统计营业数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    BusinessDataVO <span class="hljs-title function_">getBusinessData</span><span class="hljs-params">(LocalDateTime begin, LocalDateTime end)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询订单管理数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    OrderOverViewVO <span class="hljs-title function_">getOrderOverView</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询菜品总览</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    DishOverViewVO <span class="hljs-title function_">getDishOverView</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询套餐总览</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    SetmealOverViewVO <span class="hljs-title function_">getSetmealOverView</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p> <strong>Service层实现类</strong></p><p><strong>添加WorkspaceServiceImpl.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><span class="hljs-keyword">import</span> com.sky.constant.StatusConstant;<br><span class="hljs-keyword">import</span> com.sky.entity.Orders;<br><span class="hljs-keyword">import</span> com.sky.mapper.DishMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.OrderMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.SetmealMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.UserMapper;<br><span class="hljs-keyword">import</span> com.sky.service.WorkspaceService;<br><span class="hljs-keyword">import</span> com.sky.vo.BusinessDataVO;<br><span class="hljs-keyword">import</span> com.sky.vo.DishOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.SetmealOverViewVO;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.LocalTime;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkspaceServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WorkspaceService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderMapper orderMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DishMapper dishMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SetmealMapper setmealMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据时间段统计营业数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> BusinessDataVO <span class="hljs-title function_">getBusinessData</span><span class="hljs-params">(LocalDateTime begin, LocalDateTime end)</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 营业额：当日已完成订单的总金额</span><br><span class="hljs-comment">         * 有效订单：当日已完成订单的数量</span><br><span class="hljs-comment">         * 订单完成率：有效订单数 / 总订单数</span><br><span class="hljs-comment">         * 平均客单价：营业额 / 有效订单数</span><br><span class="hljs-comment">         * 新增用户：当日新增用户的数量</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;begin&quot;</span>,begin);<br>        map.put(<span class="hljs-string">&quot;end&quot;</span>,end);<br><br>        <span class="hljs-comment">//查询总订单数</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">totalOrderCount</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.COMPLETED);<br>        <span class="hljs-comment">//营业额</span><br>        <span class="hljs-type">Double</span> <span class="hljs-variable">turnover</span> <span class="hljs-operator">=</span> orderMapper.sumByMap(map);<br>        turnover = turnover == <span class="hljs-literal">null</span>? <span class="hljs-number">0.0</span> : turnover;<br><br>        <span class="hljs-comment">//有效订单数</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">validOrderCount</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-type">Double</span> <span class="hljs-variable">unitPrice</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;<br><br>        <span class="hljs-type">Double</span> <span class="hljs-variable">orderCompletionRate</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;<br>        <span class="hljs-keyword">if</span>(totalOrderCount != <span class="hljs-number">0</span> &amp;&amp; validOrderCount != <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">//订单完成率</span><br>            orderCompletionRate = validOrderCount.doubleValue() / totalOrderCount;<br>            <span class="hljs-comment">//平均客单价</span><br>            unitPrice = turnover / validOrderCount;<br>        &#125;<br><br>        <span class="hljs-comment">//新增用户数</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">newUsers</span> <span class="hljs-operator">=</span> userMapper.countByMap(map);<br><br>        <span class="hljs-keyword">return</span> BusinessDataVO.builder()<br>                .turnover(turnover)<br>                .validOrderCount(validOrderCount)<br>                .orderCompletionRate(orderCompletionRate)<br>                .unitPrice(unitPrice)<br>                .newUsers(newUsers)<br>                .build();<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询订单管理数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> OrderOverViewVO <span class="hljs-title function_">getOrderOverView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;begin&quot;</span>, LocalDateTime.now().with(LocalTime.MIN));<br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.TO_BE_CONFIRMED);<br><br>        <span class="hljs-comment">//待接单</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">waitingOrders</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-comment">//待派送</span><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.CONFIRMED);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">deliveredOrders</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-comment">//已完成</span><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.COMPLETED);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">completedOrders</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-comment">//已取消</span><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.CANCELLED);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">cancelledOrders</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-comment">//全部订单</span><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">allOrders</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-keyword">return</span> OrderOverViewVO.builder()<br>                .waitingOrders(waitingOrders)<br>                .deliveredOrders(deliveredOrders)<br>                .completedOrders(completedOrders)<br>                .cancelledOrders(cancelledOrders)<br>                .allOrders(allOrders)<br>                .build();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询菜品总览</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> DishOverViewVO <span class="hljs-title function_">getDishOverView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, StatusConstant.ENABLE);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">sold</span> <span class="hljs-operator">=</span> dishMapper.countByMap(map);<br><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, StatusConstant.DISABLE);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">discontinued</span> <span class="hljs-operator">=</span> dishMapper.countByMap(map);<br><br>        <span class="hljs-keyword">return</span> DishOverViewVO.builder()<br>                .sold(sold)<br>                .discontinued(discontinued)<br>                .build();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询套餐总览</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> SetmealOverViewVO <span class="hljs-title function_">getSetmealOverView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, StatusConstant.ENABLE);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">sold</span> <span class="hljs-operator">=</span> setmealMapper.countByMap(map);<br><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, StatusConstant.DISABLE);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">discontinued</span> <span class="hljs-operator">=</span> setmealMapper.countByMap(map);<br><br>        <span class="hljs-keyword">return</span> SetmealOverViewVO.builder()<br>                .sold(sold)<br>                .discontinued(discontinued)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Mapper</strong>层</p><p><strong>在SetmealMapper中添加countByMap方法定义</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据条件统计套餐数量</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   Integer <span class="hljs-title function_">countByMap</span><span class="hljs-params">(Map map)</span>;<br></code></pre></td></tr></table></figure><p><strong>在SetmealMapper.xml中添加对应SQL实现</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;countByMap&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span>&gt;</span><br>        select count(id) from setmeal<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span><br>                and status = #&#123;status&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;categoryId != null&quot;</span>&gt;</span><br>                and category_id = #&#123;categoryId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>在DishMapper中添加countByMap方法定义</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据条件统计菜品数量</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   Integer <span class="hljs-title function_">countByMap</span><span class="hljs-params">(Map map)</span>;<br></code></pre></td></tr></table></figure><p><strong>在DishMapper.xml中添加对应SQL实现</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;countByMap&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span>&gt;</span><br>        select count(id) from dish<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span><br>                and status = #&#123;status&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;categoryId != null&quot;</span>&gt;</span><br>                and category_id = #&#123;categoryId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="Apache-POI"><a href="#Apache-POI" class="headerlink" title="Apache POI"></a>Apache POI</h2><blockquote><p>处理Office文件的项目， 在java和office文件进行读写操作， </p><p>一般用于操作Excel文件</p></blockquote><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20230131110631081.png" alt="image-20230131110631081" style="zoom:50%;" /><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi-ooxml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>java -&gt; office</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.test;<br><br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFCell;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFRow;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFSheet;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">POITest</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 基于POI向Excel文件写入数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//在内存中创建一个Excel文件对象</span><br>        <span class="hljs-type">XSSFWorkbook</span> <span class="hljs-variable">excel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XSSFWorkbook</span>();<br>        <span class="hljs-comment">//创建Sheet页</span><br>        <span class="hljs-type">XSSFSheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> excel.createSheet(<span class="hljs-string">&quot;itcast&quot;</span>);<br><br>        <span class="hljs-comment">//在Sheet页中创建行，0表示第1行</span><br>        <span class="hljs-type">XSSFRow</span> <span class="hljs-variable">row1</span> <span class="hljs-operator">=</span> sheet.createRow(<span class="hljs-number">0</span>);<br>        <span class="hljs-comment">//创建单元格并在单元格中设置值，单元格编号也是从0开始，1表示第2个单元格</span><br>        row1.createCell(<span class="hljs-number">1</span>).setCellValue(<span class="hljs-string">&quot;姓名&quot;</span>);<br>        row1.createCell(<span class="hljs-number">2</span>).setCellValue(<span class="hljs-string">&quot;城市&quot;</span>);<br><br>        <span class="hljs-type">XSSFRow</span> <span class="hljs-variable">row2</span> <span class="hljs-operator">=</span> sheet.createRow(<span class="hljs-number">1</span>);<br>        row2.createCell(<span class="hljs-number">1</span>).setCellValue(<span class="hljs-string">&quot;张三&quot;</span>);<br>        row2.createCell(<span class="hljs-number">2</span>).setCellValue(<span class="hljs-string">&quot;北京&quot;</span>);<br><br>        <span class="hljs-type">XSSFRow</span> <span class="hljs-variable">row3</span> <span class="hljs-operator">=</span> sheet.createRow(<span class="hljs-number">2</span>);<br>        row3.createCell(<span class="hljs-number">1</span>).setCellValue(<span class="hljs-string">&quot;李四&quot;</span>);<br>        row3.createCell(<span class="hljs-number">2</span>).setCellValue(<span class="hljs-string">&quot;上海&quot;</span>);<br><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;D:\\itcast.xlsx&quot;</span>));<br>        <span class="hljs-comment">//通过输出流将内存中的Excel文件写入到磁盘上</span><br>        excel.write(out);<br><br>        <span class="hljs-comment">//关闭资源</span><br>        out.flush();<br>        out.close();<br>        excel.close();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        write();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20230131112905034.png" alt="image-20230131112905034" style="zoom:50%;" /><p><strong>office -&gt; java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.test;<br><br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFCell;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFRow;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFSheet;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">POITest</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 基于POI读取Excel文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;D:\\itcast.xlsx&quot;</span>));<br>        <span class="hljs-comment">//通过输入流读取指定的Excel文件</span><br>        <span class="hljs-type">XSSFWorkbook</span> <span class="hljs-variable">excel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XSSFWorkbook</span>(in);<br>        <span class="hljs-comment">//获取Excel文件的第1个Sheet页</span><br>        <span class="hljs-type">XSSFSheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> excel.getSheetAt(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">//获取Sheet页中的最后一行的行号</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">lastRowNum</span> <span class="hljs-operator">=</span> sheet.getLastRowNum();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= lastRowNum; i++) &#123;<br>            <span class="hljs-comment">//获取Sheet页中的行</span><br>            <span class="hljs-type">XSSFRow</span> <span class="hljs-variable">titleRow</span> <span class="hljs-operator">=</span> sheet.getRow(i);<br>            <span class="hljs-comment">//获取行的第2个单元格</span><br>            <span class="hljs-type">XSSFCell</span> <span class="hljs-variable">cell1</span> <span class="hljs-operator">=</span> titleRow.getCell(<span class="hljs-number">1</span>);<br>            <span class="hljs-comment">//获取单元格中的文本内容</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cellValue1</span> <span class="hljs-operator">=</span> cell1.getStringCellValue();<br>            <span class="hljs-comment">//获取行的第3个单元格</span><br>            <span class="hljs-type">XSSFCell</span> <span class="hljs-variable">cell2</span> <span class="hljs-operator">=</span> titleRow.getCell(<span class="hljs-number">2</span>);<br>            <span class="hljs-comment">//获取单元格中的文本内容</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cellValue2</span> <span class="hljs-operator">=</span> cell2.getStringCellValue();<br><br>            System.out.println(cellValue1 + <span class="hljs-string">&quot; &quot;</span> +cellValue2);<br>        &#125;<br><br>        <span class="hljs-comment">//关闭资源</span><br>        in.close();<br>        excel.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        read();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20230131113255962.png" alt="image-20230131113255962" style="zoom:50%;" /><h2 id="导出-Excel"><a href="#导出-Excel" class="headerlink" title="导出 Excel"></a>导出 Excel</h2><blockquote><p>导出<code>运营数据</code></p><p>1). 设计Excel模板文件</p><p>2). 查询近30天的运营数据</p><p>3). 将查询到的运营数据写入模板文件</p><p>4). 通过输出流将Excel文件下载到客户端浏览器</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 导出运营数据报表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ApiOperation(&quot;导出运营数据&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/export&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">export</span><span class="hljs-params">(HttpServletResponse response)</span>&#123;<br>    reportService.exportBusinessData(response);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 导出运营数据报表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">exportBusinessData</span><span class="hljs-params">(HttpServletResponse response)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**导出近30天的运营数据报表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportBusinessData</span><span class="hljs-params">(HttpServletResponse response)</span> &#123;<br>    <span class="hljs-type">LocalDate</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> LocalDate.now().minusDays(<span class="hljs-number">30</span>);<br>    <span class="hljs-type">LocalDate</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> LocalDate.now().minusDays(<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//查询概览运营数据，提供给Excel模板文件</span><br>    <span class="hljs-type">BusinessDataVO</span> <span class="hljs-variable">businessData</span> <span class="hljs-operator">=</span> workspaceService.getBusinessData(LocalDateTime.of(begin,LocalTime.MIN), LocalDateTime.of(end, LocalTime.MAX));<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="hljs-string">&quot;template/运营数据报表模板.xlsx&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//基于提供好的模板文件创建一个新的Excel表格对象</span><br>        <span class="hljs-type">XSSFWorkbook</span> <span class="hljs-variable">excel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XSSFWorkbook</span>(inputStream);<br>        <span class="hljs-comment">//获得Excel文件中的一个Sheet页</span><br>        <span class="hljs-type">XSSFSheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> excel.getSheet(<span class="hljs-string">&quot;Sheet1&quot;</span>);<br><br>        sheet.getRow(<span class="hljs-number">1</span>).getCell(<span class="hljs-number">1</span>).setCellValue(begin + <span class="hljs-string">&quot;至&quot;</span> + end);<br>        <span class="hljs-comment">//获得第4行</span><br>        <span class="hljs-type">XSSFRow</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> sheet.getRow(<span class="hljs-number">3</span>);<br>        <span class="hljs-comment">//获取单元格</span><br>        row.getCell(<span class="hljs-number">2</span>).setCellValue(businessData.getTurnover());<br>        row.getCell(<span class="hljs-number">4</span>).setCellValue(businessData.getOrderCompletionRate());<br>        row.getCell(<span class="hljs-number">6</span>).setCellValue(businessData.getNewUsers());<br>        row = sheet.getRow(<span class="hljs-number">4</span>);<br>        row.getCell(<span class="hljs-number">2</span>).setCellValue(businessData.getValidOrderCount());<br>        row.getCell(<span class="hljs-number">4</span>).setCellValue(businessData.getUnitPrice());<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) &#123;<br>            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> begin.plusDays(i);<br>            <span class="hljs-comment">//准备明细数据</span><br>            businessData = workspaceService.getBusinessData(LocalDateTime.of(date,LocalTime.MIN), LocalDateTime.of(date, LocalTime.MAX));<br>            row = sheet.getRow(<span class="hljs-number">7</span> + i);<br>            row.getCell(<span class="hljs-number">1</span>).setCellValue(date.toString());<br>            row.getCell(<span class="hljs-number">2</span>).setCellValue(businessData.getTurnover());<br>            row.getCell(<span class="hljs-number">3</span>).setCellValue(businessData.getValidOrderCount());<br>            row.getCell(<span class="hljs-number">4</span>).setCellValue(businessData.getOrderCompletionRate());<br>            row.getCell(<span class="hljs-number">5</span>).setCellValue(businessData.getUnitPrice());<br>            row.getCell(<span class="hljs-number">6</span>).setCellValue(businessData.getNewUsers());<br>        &#125;<br>        <span class="hljs-comment">//通过输出流将文件下载到客户端浏览器中</span><br>        <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>        excel.write(out);<br>        <span class="hljs-comment">//关闭资源</span><br>        out.flush();<br>        out.close();<br>        excel.close();<br><br>    &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>spring基本使用</title>
    <link href="/2023/12/06/spring%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/12/06/spring%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="IoC容器基础"><a href="#IoC容器基础" class="headerlink" title="IoC容器基础"></a>IoC容器基础</h1><h2 id="简单上手"><a href="#简单上手" class="headerlink" title="简单上手"></a>简单上手</h2><p>轻量级的<code>IoC</code>和<code>AOP</code>的容器框架, 针对<code>Bean</code>的生命周期进行管理的轻量级容器.</p><p>IoC(控制反转), 把复杂系统分解成互相合作的对象, 这些对象通过封装对外透明, 可以灵活的重用和扩展</p><p>我们把对象交给IoC容器管理, 根据配置文件决定给我们哪个实现类</p><p>高内聚,低耦合是现代软件开发的设计目标, Spring框架给我们提供IoC容器进行对象管理, 被管理的对象是Bean</p><p>Student -编写配置-&gt; Bean配置 -提供给-&gt; IoC容器 -提供-&gt; student对象</p><h2 id="Bean注册和配置"><a href="#Bean注册和配置" class="headerlink" title="Bean注册和配置"></a>Bean注册和配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml">// name 命名,防止冲突; alias 起一个小名<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span> <span class="hljs-attr">scope</span>=<span class="hljs-string">&quot;prototype&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">alias</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;s&quot;</span> /&gt;</span><br><br>// 单例模式(默认)&#123;一开始（容器加载配置时）就被创建，我们之后拿到的都是这个对象&#125;和原型模式&#123;只有在获取时才会被创建&#125;<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span> <span class="hljs-attr">scope</span>=<span class="hljs-string">&quot;singleton&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student1&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span> <span class="hljs-attr">scope</span>=<span class="hljs-string">&quot;prototype&quot;</span>/&gt;</span><br><br>// 懒加载: 只有在真正第一次使用时才会创建对象<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span> <span class="hljs-attr">lazy-init</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br><br>// depend-on 在哪个对象之后执行<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span> <span class="hljs-attr">lazy-init</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;art&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.ArtStudent&quot;</span> <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;student&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sport&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.SportStudent&quot;</span> <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;student&quot;</span>/&gt;</span><br><br></code></pre></td></tr></table></figure><h2 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs xml">// 属性注入 property<br><br>// 注入自定义对象 ref<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;teacher&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.ProgramTeacher&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.Student&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;teacher&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;teacher&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>// 注入基本类型 value<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.Student&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;卢本伟&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>// 构造方法注入 constructor<br><br>// 注入自定义对象 ref<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;teacher&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.ArtTeacher&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.Student&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;teacher&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;teacher&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>// 注入基本类型 value<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student2&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;age&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;1&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;int&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;1&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>// 注入集合 list<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.Student&quot;</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--  对于集合类型，我们可以直接使用标签编辑集合的默认值  --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;list&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>AAA<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>BBB<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>CCC<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>// 注入集合 map<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.Student&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;map&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;语文&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;100.0&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;数学&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;80.0&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;英语&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;92.5&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h2 id="自动装配"><a href="#自动装配" class="headerlink" title="自动装配"></a>自动装配</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml">// 三种自动装配方法 <br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;teacher&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.teacher.ProgramTeacher&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span> <span class="hljs-attr">autowire</span>=<span class="hljs-string">&quot;constructor&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student1&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span> <span class="hljs-attr">autowire</span>=<span class="hljs-string">&quot;byType&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student2&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span> <span class="hljs-attr">autowire</span>=<span class="hljs-string">&quot;byName&quot;</span> /&gt;</span><br><br>// byType 的错误, 这样两个bean注入时出错, 应该注明注入哪个teacher<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;teacher&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.teacher.ProgramTeacher&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;teacher2&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.teacher.ArtTeacher&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student1&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span> <span class="hljs-attr">autowire</span>=<span class="hljs-string">&quot;byType&quot;</span>/&gt;</span><br>// 1.设定primary属性，表示这个Bean作为主要的Bean，当出现歧义时，也会优先选择<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;teacher&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.teacher.ProgramTeacher&quot;</span> <span class="hljs-attr">primary</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>// 2.希望ProgramTeacher这个Bean在任何情况下都不参与到自动装配中，此时我们就可以将它的自动装配候选关闭<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;teacher2&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.teacher.ArtTeacher&quot;</span> <span class="hljs-attr">autowire-candidate</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br><br></code></pre></td></tr></table></figure><h2 id="生命周期与继承"><a href="#生命周期与继承" class="headerlink" title="生命周期与继承"></a>生命周期与继承</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml">// 指定初始化方法和销毁方法<br>public void init()&#123;<br>    System.out.println(&quot;我是对象初始化时要做的事情！&quot;);    <br>&#125;<br>public void destroy()&#123;<br>    System.out.println(&quot;我是对象销毁时要做的事情！&quot;);<br>&#125;<br>// 配置<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;student&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.Student&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;init&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;destroy&quot;</span>/&gt;</span><br>// 执行<br>ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(&quot;test.xml&quot;);<br>context.close();<br><br>// bean的继承, 配置abstract抽象不能调用<br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;artStudent&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.ArtStudent&quot;</span> <span class="hljs-attr">abstract</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;小明&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sportStudent&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.test.bean.student.SportStudent&quot;</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">&quot;artStudent&quot;</span>/&gt;</span><br><br>// 最外层的beans标签中进行默认配置,整个上下文中所有的Bean都采用某种配置<br><br>https://www.springframework.org/schema/beans/spring-beans.xsd&quot; default-lazy-init=&quot;true&quot;&gt;<br><br></code></pre></td></tr></table></figure><h2 id="工厂模式和工厂Bean"><a href="#工厂模式和工厂Bean" class="headerlink" title="工厂模式和工厂Bean"></a>工厂模式和工厂Bean</h2><p>外界不用类的构造方法完成对象创建, 利用反射找到工厂类, 利用工厂类生成需要的Bean对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// class填写为这个类这个只是为了告诉Spring我们的工厂方法在哪个位置，真正注册的是工厂方法提供的东西</span><br>&lt;bean name=<span class="hljs-string">&quot;studentFactory&quot;</span> class=<span class="hljs-string">&quot;com.test.bean.StudentFactory&quot;</span>/&gt;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentFactory</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Student <span class="hljs-title function_">getStudent</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;欢迎光临电子厂&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">ApplicationContext</span>  <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;test.xml&quot;</span>);<br>    <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> (Student) context.getBean(<span class="hljs-string">&quot;studentFactory&quot;</span>);<br>    System.out.println(student);<br><br>&#125;<br><br><span class="hljs-comment">// 直接注入工厂类</span><br>&lt;bean name=<span class="hljs-string">&quot;studentFactory&quot;</span> class=<span class="hljs-string">&quot;com.test.bean.student.StudentFactory&quot;</span> /&gt;<br>&lt;bean factory-bean=<span class="hljs-string">&quot;studentFactory&quot;</span> factory-method=<span class="hljs-string">&quot;getStudent&quot;</span> /&gt;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">ApplicationContext</span>  <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;test.xml&quot;</span>);<br>    <span class="hljs-type">StudentFactory</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> (StudentFactory) context.getBean(<span class="hljs-string">&quot;studentFactory&quot;</span>);<br>    <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> context.getBean(Student.class);<br><br>&#125;<br><br><span class="hljs-comment">// 继承工厂类接口</span><br>&lt;bean name=<span class="hljs-string">&quot;studentFactory&quot;</span> class=<span class="hljs-string">&quot;com.test.bean.student.StudentFactory&quot;</span> /&gt;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;Student&gt; &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Student <span class="hljs-title function_">getStudent</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;欢迎光临电子厂&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Student <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> getStudent();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() &#123;<br>        <span class="hljs-keyword">return</span> Student.class;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span>  <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;test.xml&quot;</span>);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> context.getBean(Student.class);<br>        <span class="hljs-type">StudentFactory</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> context.getBean(StudentFactory.class);<br>        <span class="hljs-comment">// 获得学生bean对象</span><br>        System.out.println(context.getBean(<span class="hljs-string">&quot;studentFactory&quot;</span>));<br>        <span class="hljs-comment">// 获得工厂bean对象</span><br>        System.out.println(context.getBean(<span class="hljs-string">&quot;&amp;studentFactory&quot;</span>));<br>    &#125;<br><br></code></pre></td></tr></table></figure><h2 id="注解开发"><a href="#注解开发" class="headerlink" title="注解开发"></a>注解开发</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"> <br><span class="hljs-comment">// 注入bean</span><br><span class="hljs-meta">@Import(SecConfig.class)</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfiguration</span> &#123;<br><br>    <span class="hljs-meta">@Bean(name = &quot;student&quot;, initMethod = &quot;&quot;, destroyMethod = &quot;&quot;, autowireCandidate = false)</span><br>    <span class="hljs-meta">@Lazy(true)</span>     <span class="hljs-comment">//对应lazy-init属性</span><br>    <span class="hljs-meta">@Scope(&quot;prototype&quot;)</span>    <span class="hljs-comment">//对应scope属性</span><br>    <span class="hljs-meta">@DependsOn(&quot;teacher&quot;)</span>    <span class="hljs-comment">//对应depends-on属性</span><br>    <span class="hljs-keyword">public</span> Student <span class="hljs-title function_">student</span><span class="hljs-params">(Teacher teacher)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(teacher);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Teacher <span class="hljs-title function_">teacher</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Teacher</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 自动装配</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    Teacher teacher;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;我被构造了&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">study</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;study&quot;</span>);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">// @Autowired 和 @Resource 区别</span><br><span class="hljs-meta">@Resource</span>默认ByName如果找不到则ByType，可以添加到set方法、字段上。<br><span class="hljs-meta">@Autowired</span>默认是byType，只会根据类型寻找，可以添加在构造方法、set方法、字段、方法参数上。<br><span class="hljs-meta">@Resource</span> = <span class="hljs-meta">@Autowired</span> + <span class="hljs-meta">@Qualifier</span><br><span class="hljs-meta">@Resource</span> 需要另外导入包<br>&lt;dependency&gt;<br>    &lt;groupId&gt;jakarta.annotation&lt;/groupId&gt;<br>    &lt;artifactId&gt;jakarta.annotation-api&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">2.1</span><span class="hljs-number">.1</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br><br><span class="hljs-comment">// @Component</span><br><span class="hljs-meta">@Component(&quot;lbwnb&quot;)</span>   <span class="hljs-comment">//同样可以自己起名字</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>&#125;<br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(&quot;com.test.bean&quot;)</span>   <span class="hljs-comment">//包扫描，这样Spring就会去扫描对应包下所有的类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfiguration</span> &#123;<br>&#125;<br><br><span class="hljs-comment">// 工厂类</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;Student&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Student <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> &#123;   <span class="hljs-comment">//生产的Bean对象</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() &#123;   <span class="hljs-comment">//生产的Bean类型</span><br>        <span class="hljs-keyword">return</span> Student.class;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span> &#123;   <span class="hljs-comment">//生产的Bean是否采用单例模式</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="SpringEL-表达式"><a href="#SpringEL-表达式" class="headerlink" title="SpringEL 表达式"></a>SpringEL 表达式</h1><h2 id="注入外部属性"><a href="#注入外部属性" class="headerlink" title="注入外部属性"></a>注入外部属性</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 配置文件</span><br>test.name=士兵<br><br><span class="hljs-comment">// 导入配置文件</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(&quot;com.test.bean&quot;)</span><br><span class="hljs-meta">@PropertySource(value = &quot;classpath:test.properties&quot;, encoding = &quot;UTF-8&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfiguration</span> &#123;<br>&#125;<br><br><span class="hljs-comment">// 注入</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;test.name&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">study</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;study =&gt; &quot;</span> + name);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="SpEL简单使用"><a href="#SpEL简单使用" class="headerlink" title="SpEL简单使用"></a>SpEL简单使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfiguration.class);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> context.getBean(Student.class);<br>        <span class="hljs-type">SpelExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;name&quot;</span>);<br>        exp.setValue(student, <span class="hljs-string">&quot;刻晴&quot;</span>);<br>        System.out.println(exp.getValue(student));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfiguration.class);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> context.getBean(Student.class);<br>        <span class="hljs-type">SpelExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-comment">// 取出</span><br>        System.out.println(parser.parseExpression(<span class="hljs-string">&quot;map[&#x27;活尸]&quot;</span>));<br>        System.out.println(parser.parseExpression(<span class="hljs-string">&quot;list[2]&quot;</span>));<br>        <span class="hljs-comment">// 创建集合</span><br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;&#123;5, 2, 1, 4, 6, 7, 0, 3, 9, 8&#125;&quot;</span>);<br>        List&lt;?&gt; list = (List&lt;?&gt;) exp.getValue();<br>        System.out.println(list);<br><br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp1</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;&#123;name: &#x27;小明&#x27;, info: &#123;address: &#x27;北京市朝阳区&#x27;, tel: 10086&#125;&#125;&quot;</span>);<br>        System.out.println(exp1.getValue());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="AOP-面向切片"><a href="#AOP-面向切片" class="headerlink" title="AOP 面向切片"></a>AOP 面向切片</h1><p>代码切入类的指定方法,指定位置; 在方法执行前或执行后, 作一些<code>额外操作</code>, 就是<code>代理</code>;<br>保证原有业务不变的情况下，添加额外的动作.</p><p>如何使用AOP ?</p><ol><li>需要切入的<code>类</code>, 类的哪个<code>方法</code>需要被切入.</li><li>切入后执行什么<code>动作</code>.</li><li>方法执行<code>前</code>切入还是<code>后</code>切入.</li><li>如何告诉Spring容器我们要切入.</li></ol><h2 id="使用配置实现AOP"><a href="#使用配置实现AOP" class="headerlink" title="使用配置实现AOP"></a>使用配置实现AOP</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">aop:config</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">aop:pointcut</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;test&quot;</span> <span class="hljs-attr">expression</span>=<span class="hljs-string">&quot;execution(* com.test.bean.student.Student.study(String))&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">aop:aspect</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;studentAOP&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;aop:after method=&quot;afterStudy&quot; pointcut-ref=&quot;test&quot; /&gt;--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">aop:around</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;aroundStudy&quot;</span> <span class="hljs-attr">pointcut-ref</span>=<span class="hljs-string">&quot;test&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">aop:aspect</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">aop:config</span>&gt;</span><br><br>public class Student &#123;<br><br>   public void study(String str) &#123;<br>       System.out.println(&quot;执行study方法, 参数: &quot; + str);<br>   &#125;<br><br>&#125;<br><br>public class StudentAOP &#123;<br>    public void afterStudy(JoinPoint point) &#123;<br>        System.out.println(&quot;意义在哪里...参数: &quot; + point.getArgs()[0]);<br>    &#125;<br><br>    public void aroundStudy(ProceedingJoinPoint joinPoint) throws Throwable &#123;<br>        System.out.println(&quot;方法开始之前&quot;);<br>        Object arg = joinPoint.getArgs()[0];<br>        joinPoint.proceed();<br>        System.out.println(&quot;方法执行完毕, 结果为: &quot; + arg);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="使用接口实现AOP"><a href="#使用接口实现AOP" class="headerlink" title="使用接口实现AOP"></a>使用接口实现AOP</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// before</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentAOP</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodBeforeAdvice</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(Method method, Object[] args, Object target)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;通过Advice实现AOP&quot;</span>);<br>    &#125;<br>&#125;<br><br>&lt;bean id=<span class="hljs-string">&quot;student&quot;</span> class=<span class="hljs-string">&quot;com.test.bean.student.Student&quot;</span>/&gt;<br>&lt;bean id=<span class="hljs-string">&quot;studentAOP&quot;</span> class=<span class="hljs-string">&quot;com.test.bean.aop.StudentAOP&quot;</span>/&gt;<br>&lt;aop:config&gt;<br>    &lt;aop:pointcut id=<span class="hljs-string">&quot;test&quot;</span> expression=<span class="hljs-string">&quot;execution(* com.test.bean.student.Student.study(String))&quot;</span> /&gt;<br>    &lt;aop:advisor advice-ref=<span class="hljs-string">&quot;studentAOP&quot;</span> pointcut-ref=<span class="hljs-string">&quot;test&quot;</span> /&gt;<br>&lt;/aop:config&gt;<br><br><span class="hljs-comment">// after</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentAOP</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AfterReturningAdvice</span> &#123;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturning</span><span class="hljs-params">(Object returnValue, Method method, Object[] args, Object target)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;我是执行后方法&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// around</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentAOP</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(MethodInvocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;我是执行之前&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> invocation.proceed();<br>        System.out.println(<span class="hljs-string">&quot;我是执行之后&quot;</span>);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="使用注解实现AOP"><a href="#使用注解实现AOP" class="headerlink" title="使用注解实现AOP"></a>使用注解实现AOP</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentAOP</span> &#123;<br>    <span class="hljs-meta">@Before(&quot;execution(* com.test.bean.student.Student.study(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(JoinPoint point)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;我是之前执行的内容！: 参数: &quot;</span> + point.getArgs()[<span class="hljs-number">0</span>]);<br>    &#125;<br>    <span class="hljs-meta">@AfterReturning(&quot;execution(* com.test.bean.student.Student.study(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">(JoinPoint point)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;我是之后执行的内容！: 参数: &quot;</span> + point.getArgs()[<span class="hljs-number">0</span>]);<br>    &#125;<br>    <span class="hljs-meta">@Around(&quot;execution(* com.test.bean.student.Student.study(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint point)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;方法执行之前！&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> point.proceed();<br>        System.out.println(<span class="hljs-string">&quot;方法执行之后！&quot;</span>);<br>        <span class="hljs-keyword">return</span> val;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@EnableAspectJAutoProxy</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(&quot;com.test.bean&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfiguration</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="整合数据库"><a href="#整合数据库" class="headerlink" title="整合数据库"></a>整合数据库</h1><p>数据库的链接开关耗费资源, JDBC定义数据源DataSource接口, 将连接交给DataSource管理, 采用池化技术创建好连接</p><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/-1701159815238.png" alt="连接池"></p><h2 id="整合Mybatis框架"><a href="#整合Mybatis框架" class="headerlink" title="整合Mybatis框架"></a>整合Mybatis框架</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfiguration.class);<br>        <span class="hljs-type">TestMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> context.getBean(TestMapper.class);<br>        System.out.println(mapper.getOrder());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="使用HikariCP连接池"><a href="#使用HikariCP连接池" class="headerlink" title="使用HikariCP连接池"></a>使用HikariCP连接池</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>@Bean<br>public DataSource dataSource() &#123;<br>    HikariDataSource dataSource = new HikariDataSource();<br>    dataSource.setJdbcUrl(&quot;jdbc:mysql://localhost:3306/study&quot;);<br>    dataSource.setDriverClassName(&quot;com.mysql.cj.jdbc.Driver&quot;);<br>    dataSource.setUsername(&quot;root&quot;);<br>    dataSource.setPassword(&quot;123456&quot;);<br>    return dataSource;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>原子性:要么成功,要么失败<br>一致性:不能成功一半<br>隔离性:事务和事务之间隔离<br>持久性:事务完成不能回退</p><table><thead><tr><th>隔离级别</th><th>脏读</th><th>可重复读</th><th>幻读</th></tr></thead><tbody><tr><td>读未提交</td><td>可能</td><td>可能</td><td>可能</td></tr><tr><td>读已提交</td><td>不能</td><td>可能</td><td>可能</td></tr><tr><td>可重复读</td><td>不能</td><td>不能</td><td>可能</td></tr><tr><td>串行化</td><td>不能</td><td>不能</td><td>不能</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>().setUser_id(<span class="hljs-number">7</span>).setNum(<span class="hljs-number">2</span>).setName(<span class="hljs-string">&quot;手套&quot;</span>).setPrice(<span class="hljs-number">900</span>);<br>        testMapper.insertOrder(order);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;我是测试异常&quot;</span>);<br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>().setUser_id(<span class="hljs-number">7</span>).setNum(<span class="hljs-number">5</span>).setName(<span class="hljs-string">&quot;袜子&quot;</span>).setPrice(<span class="hljs-number">900</span>);<br>        testMapper.insertOrder(order1);<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="JUnit"><a href="#JUnit" class="headerlink" title="JUnit"></a>JUnit</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.0.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>@ExtendWith(SpringExtension.class)<br>@ContextConfiguration(classes = MainConfiguration.class)<br>public class TestMain &#123;<br>    @Autowired<br>    TestServiceImpl service;<br>    @Test<br>    public void test()&#123;<br>        service.test();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jQuery使用</title>
    <link href="/2023/12/06/jQuery%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/12/06/jQuery%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<p><code>Dom对象 &lt;=&gt; jQuery对象</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Dom对象 &lt;=&gt; jQuery对象<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/jquery.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mydiv&quot;</span>&gt;</span>咒术回战<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">// Dom</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> mydiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;mydiv&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Dom: &#x27;</span> + mydiv.<span class="hljs-property">innerText</span>);</span><br><span class="language-javascript">    <span class="hljs-comment">// jQuery</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> mydiv1 = $(<span class="hljs-string">&#x27;#mydiv&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;jQuery: &#x27;</span> + mydiv1[<span class="hljs-number">0</span>].<span class="hljs-property">innerText</span>);</span><br><span class="language-javascript">    <span class="hljs-comment">// Dom -&gt; jQuery</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> $1 = $(mydiv);</span><br><span class="language-javascript">    <span class="hljs-comment">// jQuery -&gt; Dom</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> dom = <span class="hljs-title function_">jQuery</span>($1);  <span class="hljs-comment">// 1</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> dom1 = $1[<span class="hljs-number">0</span>];  <span class="hljs-comment">// 2</span></span><br><span class="language-javascript">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="jQuery选择器"><a href="#jQuery选择器" class="headerlink" title="jQuery选择器"></a>jQuery选择器</h1><p>查找定位元素,把选择器字符串传入方法能选择不同Dom对象并以jQuery包装集形式返回</p><p><code>基础选择器</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>基础选择器<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/jquery.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>银骑士<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;id1&quot;</span>&gt;</span>黑骑士<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;class1&quot;</span>&gt;</span>恶魔王子<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">// id选择器</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> $1 = $(#id1);</span><br><span class="language-javascript">    <span class="hljs-comment">// 元素选择器</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> $span = $(<span class="hljs-string">&#x27;span&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-comment">// 类选择器</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> $class1 = $(<span class="hljs-string">&#x27;.class1&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-comment">// 通用选择器</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> $2 = $(<span class="hljs-string">&#x27;*&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-comment">// 组合选择器</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> $combine = $(<span class="hljs-string">&#x27;span, #id1, .class1&#x27;</span>);</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><table><thead><tr><th>选择器</th><th>格式</th></tr></thead><tbody><tr><td>id选择器</td><td>$(#id)</td></tr><tr><td>元素名称选择器</td><td>$(element)</td></tr><tr><td>类选择器</td><td>$(.class)</td></tr><tr><td>选择所有元素</td><td>$(*)</td></tr><tr><td>组合选择器</td><td>$(s1,s2,s3)</td></tr></tbody></table><p><code>层次选择器</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>层次选择器<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/jquery.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;testing&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;lang&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;lang-javascript&quot;</span>&gt;</span>JavaScript<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;lang-python&quot;</span>&gt;</span>Python<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;lang-lua&quot;</span>&gt;</span>Lua<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">// 后代选择器 (后代范围更广)</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> $ul = $(<span class="hljs-string">&#x27;ul li&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-comment">// 子代选择器</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> $ul1 = $(<span class="hljs-string">&#x27;ul.lang &gt; li.lang-javascript&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-comment">// 相邻选择器</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> $lang = $(<span class="hljs-string">&#x27;.lang-javascript + li&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-comment">// 同辈选择器 (同辈范围更广)</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> $lang1 = $(<span class="hljs-string">&#x27;.lang-javascript ~ li&#x27;</span>);</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><table><thead><tr><th>选择器</th><th>格式</th></tr></thead><tbody><tr><td>后代选择器</td><td>$(s1 s2)</td></tr><tr><td>子代选择器</td><td>$(parent &gt; child)</td></tr><tr><td>相邻选择器</td><td>$(prev + next)</td></tr><tr><td>同辈选择器</td><td>$(prev ~ sibling)</td></tr></tbody></table><p>表单选择器</p><table><thead><tr><th>选择器</th><th>格式</th></tr></thead><tbody><tr><td>表单选择器</td><td>$(:input)</td></tr><tr><td>文本框选择器</td><td>$(:text)</td></tr><tr><td>密码框选择器</td><td>$(:password)</td></tr><tr><td>单选按钮选择器</td><td>$(:radio)</td></tr><tr><td>复选框选择器</td><td>$(:checkbox)</td></tr><tr><td>提交按钮选择器</td><td>$(:submit)</td></tr><tr><td>图像域选择器</td><td>$(:image)</td></tr><tr><td>重置按钮选择器</td><td>$(:reset)</td></tr><tr><td>按钮选择器</td><td>$(:button)</td></tr><tr><td>文件域选择器</td><td>$(:file)</td></tr></tbody></table><h1 id="Dom操作"><a href="#Dom操作" class="headerlink" title="Dom操作"></a>Dom操作</h1><p><code>操作元素属性</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>操作元素属性<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/jquery.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ch&quot;</span> <span class="hljs-attr">checked</span>=<span class="hljs-string">&quot;checked&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;aa&quot;</span> <span class="hljs-attr">abc</span>=<span class="hljs-string">&quot;abc&quot;</span> /&gt;</span> aa<br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ch&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;bb&quot;</span> <span class="hljs-attr">test</span>=<span class="hljs-string">true/</span>&gt;</span> bb<br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">// 获取属性</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> attr1 = $(<span class="hljs-string">&#x27;#aa&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;abc&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> attr2 = $(<span class="hljs-string">&#x27;#bb&#x27;</span>).<span class="hljs-title function_">prop</span>(<span class="hljs-string">&#x27;test&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;attr: &#x27;</span> + attr1 + <span class="hljs-string">&#x27; prop: &#x27;</span> + attr2)</span><br><span class="language-javascript">    <span class="hljs-comment">// 设置属性</span></span><br><span class="language-javascript">    $(<span class="hljs-string">&#x27;#aa&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;value&#x27;</span>, <span class="hljs-number">1</span>)</span><br><span class="language-javascript">    <span class="hljs-comment">// 删除属性</span></span><br><span class="language-javascript">    $(<span class="hljs-string">&#x27;#aa&#x27;</span>).<span class="hljs-title function_">removeAttr</span>(<span class="hljs-string">&#x27;value&#x27;</span>)</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>attr(属性名称)</td><td>获取指定的属性值</td></tr><tr><td>prop(属性名称)</td><td>获取具有true和false两个属性的属性值</td></tr></tbody></table><p><code>操作元素样式</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>操作元素样式<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/jquery.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">div</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>;</span><br><span class="language-css">            <span class="hljs-attribute">width</span>: <span class="hljs-number">180px</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css">        <span class="hljs-selector-class">.blue</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">background</span>: blue;</span><br><span class="language-css">        &#125;</span><br><span class="language-css">        <span class="hljs-selector-class">.green</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">background</span>: green;</span><br><span class="language-css">        &#125;</span><br><span class="language-css">        <span class="hljs-selector-class">.larger</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">30px</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>css方法设置元素样式<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;conBlue&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;blue larger&quot;</span>&gt;</span>天蓝色<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;conRed&quot;</span>&gt;</span>大红色<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;remove&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;blue larger&quot;</span>&gt;</span>天蓝色<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">// 获取class</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> cls = $(<span class="hljs-string">&quot;#conBlue&quot;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;class&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cls);</span><br><span class="language-javascript">    <span class="hljs-comment">// 修改class</span></span><br><span class="language-javascript">    $(<span class="hljs-string">&quot;#conBlue&quot;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;class&#x27;</span>, <span class="hljs-string">&#x27;green&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-comment">// 添加class</span></span><br><span class="language-javascript">    $(<span class="hljs-string">&quot;#conBlue&quot;</span>).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&#x27;larger&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-comment">// 添加具体样式</span></span><br><span class="language-javascript">    $(<span class="hljs-string">&quot;#conBlue&quot;</span>).<span class="hljs-title function_">css</span>(<span class="hljs-string">&#x27;font-size&#x27;</span>, <span class="hljs-string">&#x27;90px&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-comment">// 移除样式</span></span><br><span class="language-javascript">    $(<span class="hljs-string">&quot;#conBlue&quot;</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;green&#x27;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>attr(‘class’)</td><td>获取class属性的值,即样式名称</td></tr><tr><td>attr(‘class’, ‘样式名’)</td><td>获取class属性的值,修改样式</td></tr><tr><td>addClass(‘样式名’)</td><td>添加样式名称</td></tr><tr><td>css(‘样式名’, ‘样式’)</td><td>添加具体样式</td></tr><tr><td>removeClass(‘样式名’)</td><td>移除样式</td></tr></tbody></table><p><code>操作元素内容</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>操作元素内容 <span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/jquery.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;html&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;text&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    $(<span class="hljs-string">&#x27;#html&#x27;</span>).<span class="hljs-title function_">html</span>(<span class="hljs-string">&#x27;&lt;h1&gt;Tokyo&lt;/h1&gt;&#x27;</span>)</span><br><span class="language-javascript">    $(<span class="hljs-string">&#x27;#text&#x27;</span>).<span class="hljs-title function_">text</span>(<span class="hljs-string">&#x27;Tokyo&#x27;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>html()</td><td>获取元素html内容</td></tr><tr><td>html(‘html, 内容’)</td><td>设定元素html内容</td></tr><tr><td>text()</td><td>获取元素的文本内容,不包含html</td></tr><tr><td>text(‘text 内容’)</td><td>设置元素文本内容,不包含html</td></tr><tr><td>val()</td><td>获取元素value值</td></tr><tr><td>val(‘值’)</td><td>设定元素的value值</td></tr></tbody></table><p><code>添加元素</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>添加元素<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/jquery.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span><br><span class="language-css">    <span class="hljs-selector-tag">div</span>&#123;</span><br><span class="language-css">      <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span> <span class="hljs-number">0</span>;</span><br><span class="language-css">    &#125;</span><br><span class="language-css">    <span class="hljs-selector-tag">span</span>&#123;</span><br><span class="language-css">      <span class="hljs-attribute">color</span>: white;</span><br><span class="language-css">      <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>;</span><br><span class="language-css">    &#125;</span><br><span class="language-css">    <span class="hljs-selector-class">.red</span>&#123;</span><br><span class="language-css">      <span class="hljs-attribute">background-color</span>: red;</span><br><span class="language-css">    &#125;</span><br><span class="language-css">    <span class="hljs-selector-class">.blue</span>&#123;</span><br><span class="language-css">      <span class="hljs-attribute">background-color</span>: blue;</span><br><span class="language-css">    &#125;</span><br><span class="language-css">    <span class="hljs-selector-class">.green</span>&#123;</span><br><span class="language-css">      <span class="hljs-attribute">background-color</span>: green;</span><br><span class="language-css">    &#125;</span><br><span class="language-css">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;red&quot;</span>&gt;</span>男神<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;blue&quot;</span>&gt;</span>偶像<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;green&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>小鲜肉<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> span = <span class="hljs-string">&quot;&lt;span&gt;小狗&lt;/span&gt;&quot;</span></span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> span1 = <span class="hljs-string">&quot;&lt;span&gt;无头恶魔&lt;/span&gt;&quot;</span></span><br><span class="language-javascript">  <span class="hljs-comment">// prepend append是子元素</span></span><br><span class="language-javascript">  <span class="hljs-comment">// 在小鲜肉前面加小狗</span></span><br><span class="language-javascript">  $(<span class="hljs-string">&quot;.green&quot;</span>).<span class="hljs-title function_">prepend</span>(span)</span><br><span class="language-javascript">  <span class="hljs-comment">// 在小鲜肉前面加无头恶魔</span></span><br><span class="language-javascript">  $(<span class="hljs-string">&quot;.green&quot;</span>).<span class="hljs-title function_">append</span>(span1)</span><br><span class="language-javascript">  <span class="hljs-comment">// before after是同级元素</span></span><br><span class="language-javascript">  <span class="hljs-comment">// 在男神前加石像鬼</span></span><br><span class="language-javascript">  $(<span class="hljs-string">&quot;.red&quot;</span>).<span class="hljs-title function_">before</span>(<span class="hljs-string">&quot;&lt;span class=&#x27;green&#x27;&gt;石像鬼&lt;/span&gt;&quot;</span>)</span><br><span class="language-javascript">  <span class="hljs-comment">// 在偶像后加黑骑士</span></span><br><span class="language-javascript">  $(<span class="hljs-string">&quot;.blue&quot;</span>).<span class="hljs-title function_">after</span>(<span class="hljs-string">&quot;&lt;span class=&#x27;blue&#x27;&gt;黑骑士&lt;/span&gt;&quot;</span>)</span><br><span class="language-javascript"></span><br><span class="language-javascript">  $(<span class="hljs-string">&quot;.red&quot;</span>).<span class="hljs-title function_">remove</span>()</span><br><span class="language-javascript">  $(<span class="hljs-string">&quot;.red&quot;</span>).<span class="hljs-title function_">empty</span>()</span><br><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">//$(&#x27;div.green&#x27;).remove()</span></span><br><span class="language-javascript">  $(<span class="hljs-string">&#x27;div.green&#x27;</span>).<span class="hljs-title function_">empty</span>()</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>$(selector).prepend(content)</td><td>在被选元素内部开头插入元素或内容</td></tr><tr><td>$(content).prependTo(selector)</td><td>另一种写法</td></tr><tr><td>$(selector).append(content)</td><td>在被选元素内部结尾插入元素或内容</td></tr><tr><td>$(content).appendTo(selector)</td><td>另一种写法</td></tr><tr><td>$(selector).before(content)</td><td>在元素前插入指定元素</td></tr><tr><td>$(selector).after(content)</td><td>在元素后插入指定元素</td></tr></tbody></table><p>删除和清空元素</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>$(selector).remove()</td><td>删除被选元素,标签都删了</td></tr><tr><td>$(selector).empty()</td><td>清空被选元素的内容,标签还在</td></tr></tbody></table><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js">$(<span class="hljs-string">&quot;.red&quot;</span>).<span class="hljs-title function_">remove</span>()<br>$(<span class="hljs-string">&quot;.red&quot;</span>).<span class="hljs-title function_">empty</span>()<br></code></pre></td></tr></table></figure><h1 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h1><p><code>ready 加载事件</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>加载事件<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/jquery.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-comment">// 一般我们页面从上向下加载,这里获取不到div标签, 但是ready可以在页面加载完成后加载</span></span><br><span class="language-javascript">        $(()=&gt;&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;ready加载事件&quot;</span>);</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($(<span class="hljs-string">&#x27;#p1&#x27;</span>).<span class="hljs-title function_">text</span>());</span><br><span class="language-javascript">        &#125;)</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;p1&quot;</span>&gt;</span>文本<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ready()可以写多个, 按顺序执行 $(()&#x3D;&gt;{}) &lt;&#x3D;&gt; $(document).ready(function(){})</p><p><code>bind 绑定事件</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>绑定事件<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/jquery.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;btn1&quot;</span>&gt;</span>你好<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;btn2&quot;</span>&gt;</span>你好<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;btn3&quot;</span>&gt;</span>你好<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($(<span class="hljs-string">&#x27;#btn3&#x27;</span>).<span class="hljs-title function_">text</span>());</span><br><span class="language-javascript">    <span class="hljs-comment">// 两种写法均可</span></span><br><span class="language-javascript">    <span class="hljs-comment">/*$(&#x27;#btn1&#x27;).click(()=&gt;&#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">        console.log(&#x27;你好&#x27;)</span></span><br><span class="hljs-comment"><span class="language-javascript">    &#125;)</span></span><br><span class="hljs-comment"><span class="language-javascript">    $(&#x27;#btn2&#x27;).bind(&#x27;click&#x27;, ()=&gt;&#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">        console.log(&#x27;尊嘟假嘟2&#x27;)</span></span><br><span class="hljs-comment"><span class="language-javascript">    &#125;)*/</span></span><br><span class="language-javascript">    <span class="hljs-comment">// 一次绑定多个</span></span><br><span class="language-javascript">    $(<span class="hljs-string">&#x27;#btn1&#x27;</span>).<span class="hljs-title function_">click</span>(<span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;你好&#x27;</span>)</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">keypress</span>(<span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;尊嘟假嘟&#x27;</span>)</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    $(<span class="hljs-string">&#x27;#btn2&#x27;</span>).<span class="hljs-title function_">bind</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;尊嘟假嘟2&#x27;</span>)</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">bind</span>(<span class="hljs-string">&#x27;keypress&#x27;</span>, <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;你好2&#x27;</span>)</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>为被选元素添加一个或多个事件处理程序, 并规定事件发生时运行的函数</p>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jQuery</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Axios使用</title>
    <link href="/2023/12/06/Axios%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/12/06/Axios%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<p>axios? 前端ajax请求库</p><p>特点?  基于xhr+promise异步ajax请求库, 浏览器端和node端都可用, 支持请求&#x2F;响应拦截器, 支持请求取消,</p><p>请求&#x2F;响应数据转换, 批量发送多个请求</p><p><code>Restful风格的Get,Post,Put,Delete 4种方法的8种写法(简写和完整写法)</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;../css/bootstrap.min.css&quot;</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/axios.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/vue.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;page-header&quot;</span>&gt;</span>基本使用<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;get()&quot;</span>&gt;</span> 发送GET请求 <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-warning&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;post()&quot;</span>&gt;</span> 发送POST请求 <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-success&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;put()&quot;</span>&gt;</span> 发送 PUT 请求 <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-danger&quot;</span>  @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;delete1()&quot;</span>&gt;</span> 发送 DELETE 请求 <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">        axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">baseURL</span> = <span class="hljs-string">&quot;http://localhost:3000&quot;</span></span><br><span class="language-javascript">        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">            <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;.container&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">                <span class="hljs-keyword">return</span>&#123;</span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            &#125;,</span><br><span class="language-javascript">            <span class="hljs-attr">methods</span>:&#123;</span><br><span class="language-javascript">                <span class="hljs-comment">// 简写</span></span><br><span class="language-javascript">                <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">                    axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/posts/2&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>))</span><br><span class="language-javascript">                &#125;,</span><br><span class="language-javascript">                <span class="hljs-title function_">post</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">                    axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/posts&#x27;</span>,&#123;</span><br><span class="language-javascript">                        <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,</span><br><span class="language-javascript">                        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;约会大作战&#x27;</span>,</span><br><span class="language-javascript">                        <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;后宫&#x27;</span></span><br><span class="language-javascript">                    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>))</span><br><span class="language-javascript">                &#125;,</span><br><span class="language-javascript">                <span class="hljs-title function_">put</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">                    axios.<span class="hljs-title function_">put</span>(<span class="hljs-string">&#x27;/posts/1&#x27;</span>,&#123;</span><br><span class="language-javascript">                        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;进击的巨人&#x27;</span>,</span><br><span class="language-javascript">                        <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;动作 / 动画 / 奇幻&#x27;</span></span><br><span class="language-javascript">                    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>))</span><br><span class="language-javascript">                &#125;,</span><br><span class="language-javascript">                <span class="hljs-title function_">delete1</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">                    axios.<span class="hljs-title function_">delete</span>(<span class="hljs-string">&#x27;/posts/4&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>))</span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">                <span class="hljs-comment">/*</span></span><br><span class="hljs-comment"><span class="language-javascript">                // 完整写法</span></span><br><span class="hljs-comment"><span class="language-javascript">                get()&#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">                    axios(&#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">                        url: &#x27;/posts/1&#x27;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                        method: &#x27;get&#x27;</span></span><br><span class="hljs-comment"><span class="language-javascript">                    &#125;).then(res =&gt; console.log(res.data))</span></span><br><span class="hljs-comment"><span class="language-javascript">                &#125;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                post()&#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">                    axios(&#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">                        url: &#x27;/posts&#x27;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                        method: &#x27;post&#x27;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                        data: &#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">                            title: &#x27;无职转生&#x27;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                            type: &#x27;后宫&#x27;</span></span><br><span class="hljs-comment"><span class="language-javascript">                        &#125;</span></span><br><span class="hljs-comment"><span class="language-javascript">                    &#125;).then(res =&gt; console.log(res.data))</span></span><br><span class="hljs-comment"><span class="language-javascript">                &#125;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                put()&#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">                    axios(&#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">                        url: &#x27;/posts/3&#x27;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                        method: &#x27;put&#x27;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                        data: &#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">                            title: &#x27;我推的孩子&#x27;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                            type: &#x27;后宫&#x27;</span></span><br><span class="hljs-comment"><span class="language-javascript">                        &#125;</span></span><br><span class="hljs-comment"><span class="language-javascript">                    &#125;).then(res =&gt; console.log(res.data))</span></span><br><span class="hljs-comment"><span class="language-javascript">                &#125;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                delete1()&#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">                    axios(&#123;</span></span><br><span class="hljs-comment"><span class="language-javascript">                        url: &#x27;/posts/1&#x27;,</span></span><br><span class="hljs-comment"><span class="language-javascript">                        method: &#x27;delete&#x27;</span></span><br><span class="hljs-comment"><span class="language-javascript">                    &#125;).then(res =&gt; console.log(res.data))</span></span><br><span class="hljs-comment"><span class="language-javascript">                &#125;*/</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;)</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>常用默认配置</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;../css/bootstrap.min.css&quot;</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/axios.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/vue.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;page-header&quot;</span>&gt;</span>基本使用<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;get()&quot;</span>&gt;</span> 发送GET请求 <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">// 默认请求方法类型</span></span><br><span class="language-javascript">    axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">method</span>=<span class="hljs-string">&#x27;GET&#x27;</span></span><br><span class="language-javascript">    <span class="hljs-comment">// 默认基础路径</span></span><br><span class="language-javascript">    axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">baseURL</span> = <span class="hljs-string">&quot;http://localhost:3000&quot;</span></span><br><span class="language-javascript">    <span class="hljs-comment">// 默认参数</span></span><br><span class="language-javascript">    axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">params</span> = &#123; <span class="hljs-attr">id</span>:<span class="hljs-number">100</span> &#125;</span><br><span class="language-javascript">    <span class="hljs-comment">// 默认超时时间</span></span><br><span class="language-javascript">    axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">timeout</span> = <span class="hljs-number">3000</span></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">      <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;.container&#x27;</span>,</span><br><span class="language-javascript">      <span class="hljs-attr">methods</span>: &#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">          <span class="hljs-title function_">axios</span>(&#123;</span><br><span class="language-javascript">            <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/posts/1&#x27;</span></span><br><span class="language-javascript">          &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>))</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">      &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>创建实例对象发请求</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;../css/bootstrap.min.css&quot;</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/axios.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/vue.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;page-header&quot;</span>&gt;</span>基本使用<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;get()&quot;</span>&gt;</span> 发送GET请求<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> test = axios.<span class="hljs-title function_">create</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">baseURL</span>: <span class="hljs-string">&quot;http://localhost:3000&quot;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span></span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">baseURL</span> = <span class="hljs-string">&quot;http://localhost:3000&quot;</span></span><br><span class="language-javascript">    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;.container&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;&#125;</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">methods</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">                test.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/posts/1&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>))</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>拦截器</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/axios.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/vue.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">// Promise</span></span><br><span class="language-javascript">  <span class="hljs-comment">// 设置请求拦截器,config配置对象</span></span><br><span class="language-javascript">  axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">config</span>)&#123;</span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;请求拦截器 成功&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-comment">// 修改config的参数</span></span><br><span class="language-javascript">    config.<span class="hljs-property">params</span> = &#123; <span class="hljs-attr">a</span>: <span class="hljs-number">100</span> &#125;</span><br><span class="language-javascript">    <span class="hljs-keyword">return</span> config</span><br><span class="language-javascript">  &#125;, <span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>)&#123;</span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;请求拦截器 失败&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">// 设置响应拦截器</span></span><br><span class="language-javascript">  axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>)&#123;</span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;响应拦截器 成功&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-keyword">return</span> response</span><br><span class="language-javascript">  &#125;, <span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>)&#123;</span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;响应拦截器 失败&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">// 发起请求</span></span><br><span class="language-javascript">  <span class="hljs-title function_">axios</span>(&#123;</span><br><span class="language-javascript">    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;get&#x27;</span>,</span><br><span class="language-javascript">    <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;http://localhost:3000/posts&#x27;</span></span><br><span class="language-javascript">  &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span>=&gt;</span>&#123;</span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;自定义回调处理成功的结果&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response)</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>取消请求</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;../css/bootstrap.min.css&quot;</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/axios.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/vue.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;page-header&quot;</span>&gt;</span>axios取消请求<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;send&quot;</span>&gt;</span> 发送请求 <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-warning&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;cancel1&quot;</span> &gt;</span> 取消请求 <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">let</span> cancel = <span class="hljs-literal">null</span></span><br><span class="language-javascript">  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">    <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;.container&#x27;</span>,</span><br><span class="language-javascript">    <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">return</span>&#123;</span><br><span class="language-javascript">      &#125;</span><br><span class="language-javascript">    &#125;,</span><br><span class="language-javascript">    <span class="hljs-attr">methods</span>: &#123;</span><br><span class="language-javascript">      <span class="hljs-title function_">send</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-comment">// 检测上一次请求是否完成</span></span><br><span class="language-javascript">        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cancel</span> != <span class="hljs-literal">null</span>)&#123;</span><br><span class="language-javascript">          <span class="hljs-comment">// 取消上一次请求</span></span><br><span class="language-javascript">          <span class="hljs-title function_">cancel</span>()</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">        <span class="hljs-title function_">axios</span>(&#123;</span><br><span class="language-javascript">          <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;get&#x27;</span>,</span><br><span class="language-javascript">          <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;http://localhost:3000/posts/1&#x27;</span>,</span><br><span class="language-javascript">          <span class="hljs-comment">// 设置配置对象的属性</span></span><br><span class="language-javascript">          <span class="hljs-attr">cancelToken</span>: <span class="hljs-keyword">new</span> axios.<span class="hljs-title class_">CancelToken</span>(<span class="hljs-function">(<span class="hljs-params">c</span>)=&gt;</span>&#123;</span><br><span class="language-javascript">            cancel = c</span><br><span class="language-javascript">          &#125;)</span><br><span class="language-javascript">        &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;</span><br><span class="language-javascript">          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>);</span><br><span class="language-javascript">          cancel = <span class="hljs-literal">null</span></span><br><span class="language-javascript">        &#125;)</span><br><span class="language-javascript">      &#125;,</span><br><span class="language-javascript">      <span class="hljs-title function_">cancel1</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-comment">// 取消请求</span></span><br><span class="language-javascript">        <span class="hljs-title function_">cancel</span>()</span><br><span class="language-javascript">      &#125;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>axios</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ajax</title>
    <link href="/2023/12/06/Ajax%E7%9A%84%E5%90%84%E7%A7%8D%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/12/06/Ajax%E7%9A%84%E5%90%84%E7%A7%8D%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="原生"><a href="#原生" class="headerlink" title="原生"></a>原生</h1><p>异步js和xml, 在浏览器<code>不用刷新向服务器发送异步请求</code></p><p>优点<br>    不用刷新页面即可与服务器通信<br>    根据用户事件更新部分页面内容</p><p>缺点<br>    没有浏览历史,不能回退<br>    存在跨域问题(同源)<br>    SEO(搜索引擎优化)不友好, 爬虫爬不到</p><p>HTTP: 超文本传输协议,规定浏览器和万维网服务器之间互相通信的<code>规则</code></p><p>请求报文</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs coq">请求行 | <span class="hljs-type">请求方法 GET</span>... | <span class="hljs-type">url</span> | <span class="hljs-type">HTTP</span>协议版本(HTTP/<span class="hljs-number">1.1</span>)<br>请求头 | <span class="hljs-type">k</span>: v (Host: atfgweg.com    Cookie: name=jihj    Content-type: application/x-www-form-urlencoded)<br>请求体 | <span class="hljs-type">GET</span>请求为空;  POST请求可空可不空(uname=admin&amp;pwd=<span class="hljs-number">123</span>) <br></code></pre></td></tr></table></figure><p>响应报文</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml">响应行 | HTTP/1.1(协议) 200(响应码) OK(响应字符串)<br>响应头 | k:v<br>响应体 | html代码  =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>发送Get请求</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>发送Get请求<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">&quot;button&quot;</span>)[<span class="hljs-number">0</span>];</span><br><span class="language-javascript">    btn.<span class="hljs-property">onclick</span> = <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;点击一次按钮&#x27;</span>)</span><br><span class="language-javascript">        <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();</span><br><span class="language-javascript">        xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;http://localhost:3000/posts/1&#x27;</span>)</span><br><span class="language-javascript">        xhr.<span class="hljs-title function_">send</span>()</span><br><span class="language-javascript">        xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>)&#123;</span><br><span class="language-javascript">                <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>)&#123;</span><br><span class="language-javascript">                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">response</span>);</span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>发送Post请求</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>发送Post请求<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">&quot;button&quot;</span>)[<span class="hljs-number">0</span>];</span><br><span class="language-javascript">    btn.<span class="hljs-property">onclick</span> = <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;点击一次按钮&#x27;</span>)</span><br><span class="language-javascript">        <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();</span><br><span class="language-javascript">        xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;http://localhost:3000/posts&#x27;</span>)</span><br><span class="language-javascript">        xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;application/json;charset=utf-8&#x27;</span>);</span><br><span class="language-javascript">        <span class="hljs-keyword">const</span> data = &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">id</span>: <span class="hljs-number">10</span>,</span><br><span class="language-javascript">            <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;咒术回战 0&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27; 喜剧 / 动画 / 奇幻 /&#x27;</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">        xhr.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data))</span><br><span class="language-javascript">        xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>)&#123;</span><br><span class="language-javascript">                <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>)&#123;</span><br><span class="language-javascript">                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">response</span>);</span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>IE缓存问题</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;https://localhost:8000/ie?t=&#x27;</span>+<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()) <span class="hljs-comment">// 加一个时间戳,让每一次请求都不一样,不走缓存</span><br></code></pre></td></tr></table></figure><p>超时和网络异常</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">xhr.<span class="hljs-property">timeout</span> = <span class="hljs-number">200</span> <span class="hljs-comment">// 超时时间</span><br>xhr.<span class="hljs-property">ontimeout</span> = <span class="hljs-function">()=&gt;</span><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;超时回调&#x27;</span>)<br>xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">()=&gt;</span><span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;网络异常回调&#x27;</span>)<br></code></pre></td></tr></table></figure><p>取消请求</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">xhr.<span class="hljs-title function_">abort</span>()<br></code></pre></td></tr></table></figure><p><code>发送请求同时取消上一次请求</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>发送请求同时取消上一次请求<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>点击发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-keyword">var</span> btns = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">&#x27;button&#x27;</span>);</span><br><span class="language-javascript">        <span class="hljs-keyword">let</span> xhr  = <span class="hljs-literal">null</span></span><br><span class="language-javascript">        <span class="hljs-keyword">let</span> isSending = <span class="hljs-literal">false</span> <span class="hljs-comment">//是否正在发送Ajax请求</span></span><br><span class="language-javascript">        btns[<span class="hljs-number">0</span>].<span class="hljs-property">onclick</span> = <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">if</span> (isSending) xhr.<span class="hljs-title function_">abort</span>() <span class="hljs-comment">// 如果正在发送,则取消,并重新发送请求</span></span><br><span class="language-javascript">            xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>()</span><br><span class="language-javascript">            <span class="hljs-comment">// 修改 标识变量的值</span></span><br><span class="language-javascript">            isSending = <span class="hljs-literal">true</span></span><br><span class="language-javascript">            xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;http://localhost:8000/delay&#x27;</span>)</span><br><span class="language-javascript">            xhr.<span class="hljs-title function_">send</span>()</span><br><span class="language-javascript">            xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">                <span class="hljs-keyword">if</span> (x.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) &#123;</span><br><span class="language-javascript">                    isSending = <span class="hljs-literal">false</span></span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="jQuery"><a href="#jQuery" class="headerlink" title="jQuery"></a>jQuery</h1><p><code>jQuery发送Ajax</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>jQuery发送Ajax<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/jquery.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>jQuery发送ajax请求<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>GET<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>POST<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>通用型方法ajax<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-comment">// get</span></span><br><span class="language-javascript">        $(<span class="hljs-string">&#x27;button&#x27;</span>).<span class="hljs-title function_">eq</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">click</span>(<span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">            $.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;http://localhost:3000/posts/1&#x27;</span>, &#123; a :<span class="hljs-number">100</span> &#125;, <span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res))</span><br><span class="language-javascript">        &#125;)</span><br><span class="language-javascript">        <span class="hljs-comment">// post</span></span><br><span class="language-javascript">        <span class="hljs-keyword">const</span> data = &#123;</span><br><span class="language-javascript">            <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;天使降临到我身边&quot;</span>,</span><br><span class="language-javascript">            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;后宫&quot;</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">        $(<span class="hljs-string">&#x27;button&#x27;</span>).<span class="hljs-title function_">eq</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">click</span>(<span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">            $.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;http://localhost:3000/posts&#x27;</span>, data, <span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res))</span><br><span class="language-javascript">        &#125;)</span><br><span class="language-javascript">        <span class="hljs-comment">// 通用</span></span><br><span class="language-javascript">        $(<span class="hljs-string">&#x27;button&#x27;</span>).<span class="hljs-title function_">eq</span>(<span class="hljs-number">2</span>).<span class="hljs-title function_">click</span>(<span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">            $.<span class="hljs-title function_">ajax</span>(&#123;</span><br><span class="language-javascript">                <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;http://localhost:3000/posts/1&#x27;</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">data</span>: &#123; a :<span class="hljs-number">100</span> &#125;,</span><br><span class="language-javascript">                <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;GET&#x27;</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res),</span><br><span class="language-javascript">                <span class="hljs-attr">error</span>: <span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res),</span><br><span class="language-javascript">                <span class="hljs-attr">timeout</span>: <span class="hljs-number">200</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">headers</span>: &#123;</span><br><span class="language-javascript">                    <span class="hljs-attr">test</span>: <span class="hljs-string">&#x27;test&#x27;</span></span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            &#125;)</span><br><span class="language-javascript">        &#125;)</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="axios"><a href="#axios" class="headerlink" title="axios"></a>axios</h1><p><code>axios发送Ajax</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>axios 发送Ajax请求 <span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../js/axios.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>GET<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>POST<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>通用AJAX<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> btns = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&#x27;button&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-comment">// 基本路径</span></span><br><span class="language-javascript">    axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">baseURL</span> = <span class="hljs-string">&#x27;http://localhost:3000&#x27;</span></span><br><span class="language-javascript"></span><br><span class="language-javascript">    btns[<span class="hljs-number">0</span>].<span class="hljs-property">onclick</span> = <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">        axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/posts/1&#x27;</span>, &#123;</span><br><span class="language-javascript">            <span class="hljs-comment">// 请求参数</span></span><br><span class="language-javascript">            <span class="hljs-attr">params</span>: &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">id</span>: <span class="hljs-number">100</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;dog&#x27;</span></span><br><span class="language-javascript">            &#125;,</span><br><span class="language-javascript">            <span class="hljs-comment">// 请求头</span></span><br><span class="language-javascript">            <span class="hljs-attr">headers</span>: &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">test</span>: <span class="hljs-string">&#x27;test&#x27;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res))</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    btns[<span class="hljs-number">1</span>].<span class="hljs-property">onclick</span> = <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">        axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/posts&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-comment">// 请求体</span></span><br><span class="language-javascript">            &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;狗&#x27;</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">age</span>: <span class="hljs-number">16</span></span><br><span class="language-javascript">            &#125;,</span><br><span class="language-javascript">            &#123;</span><br><span class="language-javascript">                <span class="hljs-comment">// 请求参数</span></span><br><span class="language-javascript">                <span class="hljs-attr">params</span>: &#123;</span><br><span class="language-javascript">                    <span class="hljs-attr">id</span>: <span class="hljs-number">100</span>,</span><br><span class="language-javascript">                    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;dog&#x27;</span></span><br><span class="language-javascript">                &#125;,</span><br><span class="language-javascript">                <span class="hljs-comment">// 请求头</span></span><br><span class="language-javascript">                <span class="hljs-attr">headers</span>: &#123;</span><br><span class="language-javascript">                    <span class="hljs-attr">test</span>: <span class="hljs-string">&#x27;test&#x27;</span></span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res))</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    btns[<span class="hljs-number">2</span>].<span class="hljs-property">onclick</span> = <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">axios</span>(&#123;</span><br><span class="language-javascript">            <span class="hljs-comment">// 路径</span></span><br><span class="language-javascript">            <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/posts&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-comment">// 请求方法</span></span><br><span class="language-javascript">            <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-comment">// 请求参数</span></span><br><span class="language-javascript">            <span class="hljs-attr">params</span>: &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">id</span>: <span class="hljs-number">100</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;dog&#x27;</span></span><br><span class="language-javascript">            &#125;,</span><br><span class="language-javascript">            <span class="hljs-comment">// 请求头</span></span><br><span class="language-javascript">            <span class="hljs-attr">headers</span>: &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">test</span>: <span class="hljs-string">&#x27;test&#x27;</span></span><br><span class="language-javascript">            &#125;,</span><br><span class="language-javascript">            <span class="hljs-comment">// 请求体</span></span><br><span class="language-javascript">            <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;狗&#x27;</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">age</span>: <span class="hljs-number">16</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>)</span><br><span class="language-javascript">        &#125;)</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h1 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h1><p><code>fetch发送Ajax</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>fetch发送Ajax<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>AJAX请求<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;button&#x27;</span>);</span><br><span class="language-javascript">    btn.<span class="hljs-property">onclick</span> = <span class="hljs-function">()=&gt;</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://localhost:3000/posts?age=8&#x27;</span>, &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-attr">headers</span>: &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">test</span>: <span class="hljs-string">&#x27;test&#x27;</span></span><br><span class="language-javascript">            &#125;,</span><br><span class="language-javascript">            <span class="hljs-attr">body</span>: &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">age</span>: <span class="hljs-string">&#x27;18&#x27;</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;n&#x27;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res))</span><br><span class="language-javascript"></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="CORS-解决跨域"><a href="#CORS-解决跨域" class="headerlink" title="CORS 解决跨域"></a>CORS 解决跨域</h1><p>跨域是违背同源策略(浏览器协议,域名,端口必须一样)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 允许http://localhost:8000页面发送请求</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="hljs-string">&#x27;http://localhost:8000&#x27;</span>)<br><span class="hljs-comment">// 允许任意页面发送Ajax请求</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>)<br><span class="hljs-comment">// 请求头随意加</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Headers&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>)<br><span class="hljs-comment">// 请求方法随意 默认get post, 加put delete</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Method&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Ajax</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>idea的一些使用技巧</title>
    <link href="/2023/12/06/idea%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/"/>
    <url>/2023/12/06/idea%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/</url>
    
    <content type="html"><![CDATA[<h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><p><code>4个箭头</code></p><ol><li>恢复: 跳到下一个断点（如果有），没有直接运行到完成 </li><li>步过： 执行下一行代码 </li><li>步入： 执行当前行代码以及方法内部的代码，进入方法内部 </li><li>步出： 跳出当前方法，继续执行后续代码</li></ol><p><code>给方法打断点打在头和尾,方便定位这个方法</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">a</span>&#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> &#123;  <span class="hljs-comment">// 断点1</span><br>        xxx;<br>                xxx;<br>                xxx;<br>                        xxx;<br>    &#125;  <span class="hljs-comment">// 断点2</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>给ServiceImpl打断点,如果找不到ServiceImpl, 打在Service上 </code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IService</span>&#123;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span>;  <span class="hljs-comment">// 断点</span><br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><p><code>冲突</code><br>      |————-时间线————————————|<br>小明: |——-克隆小刚的代码—|—–修改代码 a.java—-|–提交代码(冲突)–|<br>小刚: |————修改代码 a.java——|-提交代码-|</p><p>点击合并(merge)  -&gt;  根据提示框操作</p><p><code>基本操作</code><br>找到左侧项目对应一个文件,右键选择 add commit rollback，    git reset(重置HEAD)<br>先拉pull: 右上角箭头拉<br>后推push: 右下角分支名称处操作</p><p><code>提交点回滚</code><br>左下角git点开看到commit历史进度, 找到对应点右键 rollback, 弹窗选择hard(硬)</p><p><code>分支</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 克隆分支(默认主分支master)</span><br>git <span class="hljs-built_in">clone</span> -b master https://xxxxx.git<br><br><span class="hljs-comment"># 新建并切换到一个新分支</span><br>git checkout -b xxx<br></code></pre></td></tr></table></figure><h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><table><thead><tr><th>快捷键</th><th>功能</th></tr></thead><tbody><tr><td>ctrl + f12</td><td>查看当前类的所有方法</td></tr><tr><td>ctrl + h</td><td>打开一个叫做“类型层次结构”的视图</td></tr><tr><td>ctrl + alt + m</td><td>抽取方法</td></tr><tr><td>ctrl + alt + o</td><td>优化导入的类,把import不用的删去</td></tr><tr><td>ctrl + alt + t</td><td>try-catch</td></tr><tr><td>ctrl + y</td><td>删除当前行</td></tr><tr><td>ctrl + Shift  + f</td><td>查找强化,everything</td></tr><tr><td>ctrl + Shift  + j</td><td>自动将下一行上移到当前行末尾</td></tr><tr><td>ctrl + shift + z</td><td>取消撤销</td></tr><tr><td>F2</td><td>跳转到下一个高亮错误 或 警告位置</td></tr></tbody></table><p><a href="https://cloud.tencent.com/developer/article/1767794">IDEA Windows + Mac 快捷键（全）</a></p>]]></content>
    
    
    <categories>
      
      <category>软件操作</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IDEA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>博客搭建</title>
    <link href="/2023/12/03/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/"/>
    <url>/2023/12/03/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="博客搭建"><a href="#博客搭建" class="headerlink" title="博客搭建"></a>博客搭建</h1><img src="https://fgj-img.oss-cn-beijing.aliyuncs.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20231202193129.jpg?Expires=1701675594&OSSAccessKeyId=TMP.3KhWsPuC7vDAQGSYqiwQ1Bg4aqGNYiRro6GvrUm7WX7BssdwB41eb2B1J3joF9YArLGLbiuMK2sakjWKoUqs73zJH1veoV&Signature=pnlCUFUJgPUJTXfSK1RxDEQHoio%3D" style="zoom:25%;" /><h2 id="1-创建仓库，配置GitHub-Pages"><a href="#1-创建仓库，配置GitHub-Pages" class="headerlink" title="1. 创建仓库，配置GitHub Pages"></a>1. 创建仓库，配置GitHub Pages</h2><p>创建仓库 <code>&lt;用户名&gt;.github.io</code> 格式</p><p>根目录加index.html文件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Someone&#x27;s Blog<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, Blog World ~<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>&lt;GitHub用户名&gt;.github.io</code>仓库url <code> https://&lt;GitHub 用户名&gt;.github.io</code> 可以在setting.page里找到</p><p>然后浏览器可以呈现效果</p><h2 id="2-安装-Git-和-NodeJS"><a href="#2-安装-Git-和-NodeJS" class="headerlink" title="2. 安装 Git 和 NodeJS"></a>2. 安装 Git 和 NodeJS</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">scoop install git <span class="hljs-comment"># 安装Git</span><br><br>scoop install nvm <span class="hljs-comment"># 安装 nvm</span><br>nvm list available <span class="hljs-comment"># 查看可用的 NodeJS 版本，这里建议使用 LTS 版本</span><br>nvm install 16.18.0 <span class="hljs-comment"># 安装 NodeJS，我这里安装的是最新 LTS 版本 16.18.0</span><br>sudo nvm use 16.18.0 <span class="hljs-comment"># NodeJS 版本使用 16.18.0，注意这里需要管理员权限，可以先使用 scoop 安装 sudo 这个工具</span><br></code></pre></td></tr></table></figure><h2 id="3-安装-Hexo"><a href="#3-安装-Hexo" class="headerlink" title="3. 安装 Hexo"></a>3. 安装 Hexo</h2><ol><li>全局安装 Hexo-cli 工具</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install -g hexo-cli<br><br>hexo -v <span class="hljs-comment"># 查看版本，目前最新版本为 4.3.0</span><br></code></pre></td></tr></table></figure><ol start="2"><li>创建项目my-blog并初始化</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">hexo init my-blog<br><span class="hljs-built_in">cd</span> my-blog<br>npm install<br></code></pre></td></tr></table></figure><ol start="3"><li>生成网页文件 &amp; 本地启动</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">hexo generate <span class="hljs-comment"># 生成页面，此命令可以简写为 `hexo g`</span><br>hexo server <span class="hljs-comment"># 本地启动，可简写为 `hexo s`</span><br></code></pre></td></tr></table></figure><h2 id="4-更换主题"><a href="#4-更换主题" class="headerlink" title="4. 更换主题"></a>4. 更换主题</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> hexo-blog<br>git <span class="hljs-built_in">clone</span> 主题<br></code></pre></td></tr></table></figure><h2 id="5-基本操作"><a href="#5-基本操作" class="headerlink" title="5.基本操作"></a>5.基本操作</h2><h3 id="基本设置更改"><a href="#基本设置更改" class="headerlink" title="基本设置更改"></a>基本设置更改</h3><blockquote><p>主题优先级高于hexo</p></blockquote><p>主题yml   -&gt;    &#x2F;hexo-blog&#x2F;themes&#x2F;hexo-theme-fluid-1.9.5&#x2F;_config.yml</p><p>hexo主yml-&gt;&#x2F;hexo-blog&#x2F;_config.yml</p><h3 id="本地启动"><a href="#本地启动" class="headerlink" title="本地启动"></a>本地启动</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell">hexo g <span class="hljs-literal">-d</span><br>hexo s<br></code></pre></td></tr></table></figure><h3 id="发布Github"><a href="#发布Github" class="headerlink" title="发布Github"></a>发布Github</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">hexo g -d</span><br></code></pre></td></tr></table></figure><p>前提是配置插件</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">npm install hexo-deployer-git <span class="hljs-comment">--save</span><br></code></pre></td></tr></table></figure><p>修改根目录下的 <code>_config.yml</code>，配置 <code>GitHub</code> 相关信息</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">deploy:</span><br><span class="hljs-symbol">  type:</span> git<br><span class="hljs-symbol">  repo:</span> https:<span class="hljs-comment">//github.com/yaorongke/yaorongke.github.io.git</span><br><span class="hljs-symbol">  branch:</span> main<br><span class="hljs-symbol">  token:</span> ghp_3KakcaPHerunNRyMerofcFd9pblU282FSbsY<br></code></pre></td></tr></table></figure><h3 id="创建文章"><a href="#创建文章" class="headerlink" title="创建文章"></a>创建文章</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">hexo new post 文件名<br></code></pre></td></tr></table></figure><h3 id="标签和分类"><a href="#标签和分类" class="headerlink" title="标签和分类"></a>标签和分类</h3><blockquote><p>标签(tags)           分类(categories)</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">title:</span> <span class="hljs-string">测试文章</span><br><span class="hljs-attr">date:</span> <span class="hljs-number">2021-06-10 16:35:20</span><br><span class="hljs-attr">tags:</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">原创</span><br><span class="hljs-attr">categories:</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Java</span><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-meta"></span><br><span class="hljs-meta"></span><br><span class="hljs-string">这是一篇测试文章</span><br></code></pre></td></tr></table></figure><h3 id="关于图片"><a href="#关于图片" class="headerlink" title="关于图片"></a>关于图片</h3><ul><li>直接图床</li><li>默认路径: &#x2F;img&#x2F;xxxx.jpg</li></ul><p><img src="http://s532yoxd1.bkt.gdipper.com/default.png?e=1701595060&token=Q_u2sh06owjvRxd8Hsqlg_fh_FzUiEv1i97VL2UR:-jwfpqG1UFk5wi6P-rsWZlGImow="></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2023/12/03/hello-world/"/>
    <url>/2023/12/03/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
