

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="fgj">
  <meta name="keywords" content="">
  
    <meta name="description" content="学成在线媒资管理模块模块需求分析每个教学机构在媒资系统管理自己的教学资源, 包括视频,图片,文档等文件; 包括媒资文件的查询, 文件上传, 视频处理等 媒资查询：教学机构查询自己所拥有的媒资信息。 文件上传：包括上传图片、上传文档、上传视频。 视频处理：视频上传成功，系统自动对视频进行编码处理。 文件删除：教学机构删除自己上传的媒资文件。 媒资管理整体流程:  业务流程上传图片  上传视频">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线媒资管理模块">
<meta property="og:url" content="http://example.com/2023/12/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/index.html">
<meta property="og:site_name" content="FGJ">
<meta property="og:description" content="学成在线媒资管理模块模块需求分析每个教学机构在媒资系统管理自己的教学资源, 包括视频,图片,文档等文件; 包括媒资文件的查询, 文件上传, 视频处理等 媒资查询：教学机构查询自己所拥有的媒资信息。 文件上传：包括上传图片、上传文档、上传视频。 视频处理：视频上传成功，系统自动对视频进行编码处理。 文件删除：教学机构删除自己上传的媒资文件。 媒资管理整体流程:  业务流程上传图片  上传视频">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215110626923.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111304183.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111317043.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111324980.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111337503.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111734104.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111814289.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112017556.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112146890.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112213461.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112223642.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112440191.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112900190.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112915290.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112924360.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112946150.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113114569.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113229701.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113326453.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113402863.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113810903.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113946841.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215123004526.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215125329824.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182334467.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182354671.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182410899.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182427946.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182447578.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220047655.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220357445.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220413980.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220757178.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215221521134.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215221529910.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217161648811.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215225149429.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215233423589.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215233529684.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215233646868.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215235010632.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216194353457.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216194714379.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216195914542.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202614936.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202646182.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202658155.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202707768.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202716547.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216203051482.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216214756277.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216214926087.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215027914.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215449458.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215459908.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215804186.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215749771.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219200451925.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219200554329.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217161648811.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217161939939.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217145801454.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217145813948.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162114895.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162124359.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162132320.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162624649.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217173010850.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220155342270.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217215739463.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220190016041.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218121841727.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218155456382.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218161624892.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220215437187.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218171732665.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218165848288.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220215956789.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220220247185.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218172612877.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218172625994.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220221201255.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218173130560.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218174301374.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220222154365.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218174617845.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218175345239.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218175426198.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218180248106.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218180304964.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218202929546.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218203153029.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235250912.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218204829676.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235520938.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235431373.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235333054.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218205201099.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218212704684.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218212809395.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218213124845.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218215322204.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218215443345.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103203263.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103221247.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103236246.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103249414.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105332918.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105340899.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105349404.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105356913.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105405675.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105434515.png">
<meta property="article:published_time" content="2023-12-21T13:16:30.000Z">
<meta property="article:modified_time" content="2023-12-21T13:30:23.169Z">
<meta property="article:author" content="fgj">
<meta property="article:tag" content="学成在线">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215110626923.png">
  
  
  
  <title>学成在线媒资管理模块 - FGJ</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>FGJ&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="学成在线媒资管理模块"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-12-21 21:16" pubdate>
          2023年12月21日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          111k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          924 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">学成在线媒资管理模块</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="媒资管理模块"><a href="#媒资管理模块" class="headerlink" title="媒资管理模块"></a>媒资管理模块</h2><h3 id="模块需求分析"><a href="#模块需求分析" class="headerlink" title="模块需求分析"></a>模块需求分析</h3><p>每个教学机构在媒资系统管理自己的教学资源, 包括视频,图片,文档等文件; 包括媒资文件的查询, 文件上传, 视频处理等</p>
<p>媒资查询：教学机构查询自己所拥有的媒资信息。</p>
<p>文件上传：包括上传图片、上传文档、上传视频。</p>
<p>视频处理：视频上传成功，系统自动对视频进行编码处理。</p>
<p>文件删除：教学机构删除自己上传的媒资文件。</p>
<p>媒资管理整体流程:</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215110626923.png" srcset="/img/loading.gif" lazyload alt="image-20231215110626923"></p>
<h3 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h3><p>上传图片</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111304183.png" srcset="/img/loading.gif" lazyload alt="image-20231215111304183"></p>
<p>上传视频</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111317043.png" srcset="/img/loading.gif" lazyload alt="image-20231215111317043"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111324980.png" srcset="/img/loading.gif" lazyload alt="image-20231215111324980"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111337503.png" srcset="/img/loading.gif" lazyload alt="image-20231215111337503"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111734104.png" srcset="/img/loading.gif" lazyload alt="image-20231215111734104"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215111814289.png" srcset="/img/loading.gif" lazyload alt="image-20231215111814289"></p>
<p>处理视频</p>
<p>对需要转码的视频系统自动对其处理, 处理后生成视频的URL, 处理视频没有界面, 后台自动执行</p>
<p>审核媒资</p>
<p>通过鉴黄接口<code>自动审核</code>视频, 对有异议的视频进行<code>人工审核</code></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112017556.png" srcset="/img/loading.gif" lazyload alt="image-20231215112017556"></p>
<p>点击预览视频, 可以预览, 若是视频可以播放</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112146890.png" srcset="/img/loading.gif" lazyload alt="image-20231215112146890"></p>
<p>点击审核, 完成媒资审核过程</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112213461.png" srcset="/img/loading.gif" lazyload alt="image-20231215112213461"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112223642.png" srcset="/img/loading.gif" lazyload alt="image-20231215112223642"></p>
<p>绑定媒资</p>
<p>课程计划创建完成后绑定媒资, 如果课程计划绑定了视频, 进入课程在线学习界面播放视频</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112440191.png" srcset="/img/loading.gif" lazyload alt="image-20231215112440191"></p>
<p>如何将课程计划绑定媒资?</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112900190.png" srcset="/img/loading.gif" lazyload alt="image-20231215112900190"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112915290.png" srcset="/img/loading.gif" lazyload alt="image-20231215112915290"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112924360.png" srcset="/img/loading.gif" lazyload alt="image-20231215112924360"></p>
<p>关联后</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215112946150.png" srcset="/img/loading.gif" lazyload alt="image-20231215112946150"></p>
<h3 id="搭建模块环境"><a href="#搭建模块环境" class="headerlink" title="搭建模块环境"></a>搭建模块环境</h3><p>目前有3个微服务: 内容管理, 系统管理, 媒资管理</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113114569.png" srcset="/img/loading.gif" lazyload alt="image-20231215113114569"></p>
<p>后期会有更多微服务, 这种由前端直接请求微服务的方式有弊端, 如果前端对每个请求地址都配置绝对路径, 不利于系统维护<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113229701.png" srcset="/img/loading.gif" lazyload alt="image-20231215113229701"></p>
<p>系统上线后需要改公网域名, 这种地址非常多则非常麻烦, 采用<code>网关</code>来解决</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113326453.png" srcset="/img/loading.gif" lazyload></p>
<p>在前端代码只需要指定每个接口的相对路径即可</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113402863.png" srcset="/img/loading.gif" lazyload alt="image-20231215113402863"></p>
<p>在前端一个固定的地方在接口地址前统一加网关地址, 每个请求统一到网关, 由网关将请求转发到具体的微服务</p>
<p>为什么所有请求先到网关? 有了网关可以对请求进行路由, 路由到具体的微服务, 减少外界对微服务的成本, 比如: 400电话, 根据请求路径进行路由, 根据host地址进行路由等</p>
<p>当多个微服务实例可以通过<code>负载均衡</code>算法进行路由</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113810903.png" srcset="/img/loading.gif" lazyload alt="image-20231215113810903"></p>
<p>另外, 网关还可以实现权限控制, 限流等功能</p>
<p>项目用 Spring Cloud Gateway 作为网关, 网关在请求路由需要知道每个微服务实例的地址, 项目使用Nacos作为服务发现中心和配置中心, 整体架构图:  </p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215113946841.png" srcset="/img/loading.gif" lazyload alt="image-20231215113946841"></p>
<p>流程: </p>
<ol>
<li>微服务启动, 将自己注册到Nacos, Nacos记录各微服务实例地址</li>
<li>网关从Nacos读取服务列表, 包括服务名称, 服务地址</li>
<li>请求到达网关, 网关将请求路由到具体的微服务</li>
</ol>
<blockquote>
<p>Nacos两个作用:</p>
<ol>
<li>服务发现中心: 微服务将自身注册到Nacos, 网关从Nacos获取微服务列表</li>
<li>配置中心:  微服务配置信息非常复杂, 提供系统可维护性, <code>微服务配置信息</code>统一在Nacos配置</li>
</ol>
</blockquote>
<h4 id="搭建Nacos"><a href="#搭建Nacos" class="headerlink" title="搭建Nacos"></a>搭建Nacos</h4><p>Spring Cloud 是一套规范, Spring Cloud alibaba nacos服务注册中心, 根据网关架构图, 使用网关搭建Nacos</p>
<p>对于Nacos, 应该搞清两个概念, namespace和group</p>
<p>namespace: 用于区分环境, 比如: 开发环境, 测试环境, 生产环境</p>
<p>group: 用于区分项目: 比如 xuecheng-plus项目, xuecheng2.0项目</p>
<p>首先在nacos配置namespace</p>
<p>登录centos , 启动nacos,  sh &#x2F;data&#x2F;soft&#x2F;restart.sh自动启动nacos</p>
<blockquote>
<p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:8848/nacos/">http://192.168.101.65:8848/nacos/</a></p>
<p>账号密码：nacos&#x2F;nacos</p>
</blockquote>
<p>找到命名空间</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215123004526.png" srcset="/img/loading.gif" lazyload alt="image-20231215123004526"></p>
<p>新建一个新的命名空间</p>
<p>在system和content两个模块中加入依赖和yml配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- nacos 发现服务 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>content</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">content-api</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br></code></pre></td></tr></table></figure>

<p>system</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">system-api</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br></code></pre></td></tr></table></figure>

<p>启动</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215125329824.png" srcset="/img/loading.gif" lazyload alt="image-20231215125329824"></p>
<h4 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h4><p>搭建Nacos配置中心，目的是通过Nacos管理项目所有配置</p>
<p>将项目中的配置文件分分类：</p>
<ol>
<li>每个项目<code>特有</code>的配置</li>
</ol>
<p>该配置只在有些项目中需要配置， 或该配置在每个项目中配置的值不同</p>
<p>比如: spring.application.name 每个项目都需要配置但值不一样, 有些项目需要连数据库, 有些项目需要连消息队列</p>
<ol start="2">
<li>项目中<code>共有</code>的配置</li>
</ol>
<p>在项目中配置内容相同的配置, 比如redis的配置, 很多项目用同一套redis配置</p>
<ol start="3">
<li><code>扩展</code>的来自别的模块的配置</li>
</ol>
<blockquote>
<p>nacos如何定位一个具体的配置文件 ?</p>
<ol>
<li><p>namespace; group 来找到具体的环境和具体项目</p>
</li>
<li><p>dataid 找到具体的配置文件, dataid有三部分组成: contetnt - service - dev . yaml  三部分</p>
<p>content-service: 第一部分,   application.yml配置的应用名, 即spring.application.name 的值</p>
<p>dev:  第二部分, 环境名, 通过spring.profiles.active指定</p>
<p>yaml: 第三部分, 配置文件的后缀</p>
</li>
</ol>
<p>所以, 如果我们要配置content-service工程的配置文件,</p>
<p>在开发环境中配置content-service-dev.yaml</p>
<p>在测试环境中配置content-service-test.yaml</p>
<p>在生产环境中配置content-service-prod.yaml</p>
<p>我们启动项目传入spring.profiles.active参数决定引用哪个环境的配置文件, 例如: 传入<code>spring.profiles.active=dev</code> 则使用dev环境的配置文件即 <code>content-service-dev.yaml</code></p>
</blockquote>
<h5 id="配置content-api"><a href="#配置content-api" class="headerlink" title="配置content-api"></a>配置content-api</h5><p>检查依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- nacos 发现服务 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- nacos 配置服务 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>修改bootstrap.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#server:</span><br><span class="hljs-comment">#  servlet:</span><br><span class="hljs-comment">#    context-path: /content # 所有接口根路径</span><br><span class="hljs-comment">#  port: 63040</span><br><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">content-api</span> <span class="hljs-comment"># 服务名</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 环境名</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span> <span class="hljs-comment"># 服务注册相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>      <span class="hljs-attr">config:</span> <span class="hljs-comment"># 配置文件相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span><br><span class="hljs-comment">#  datasource:</span><br><span class="hljs-comment">#    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="hljs-comment">#    url: jdbc:mysql://192.168.101.65:3306/xc402_content?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br><span class="hljs-comment">#    username: root</span><br><span class="hljs-comment">#    password: mysql</span><br><br><br><span class="hljs-comment"># 日志文件配置路径</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">config:</span> <span class="hljs-string">classpath:log4j2-dev.xml</span><br><br><span class="hljs-comment"># swagger 文档配置</span><br><span class="hljs-comment">#swagger:</span><br><span class="hljs-comment">#  title: &quot;学成在线内容管理系统&quot;</span><br><span class="hljs-comment">#  description: &quot;内容系统管理系统对课程相关信息进行管理&quot;</span><br><span class="hljs-comment">#  base-package: com.xuecheng.content</span><br><span class="hljs-comment">#  enabled: true</span><br><span class="hljs-comment">#  version: 1.0.0</span><br><br></code></pre></td></tr></table></figure>

<p>编写nacos配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/content</span> <span class="hljs-comment"># 所有接口根路径</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">63040</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.101.65:3306/xc402_content?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">mysql</span><br><span class="hljs-attr">swagger:</span><br>  <span class="hljs-attr">title:</span> <span class="hljs-string">&quot;学成在线内容管理系统&quot;</span><br>  <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;内容系统管理系统对课程相关信息进行管理&quot;</span><br>  <span class="hljs-attr">base-package:</span> <span class="hljs-string">com.xuecheng.content</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>为什么不在nacos配置spring.application.name?</p>
<p>nacos客户端根据这个发现服务&amp;确定nacos配置文件名称, 要在<code>工程本地</code>配置</p>
</blockquote>
<h5 id="配置-content-service"><a href="#配置-content-service" class="headerlink" title="配置 content-service"></a>配置 content-service</h5><p>目标: service云端配mysql; api云端配所有接口根路径; api本地配拓展云端配置; api&amp;service本地配共用配置</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182334467.png" srcset="/img/loading.gif" lazyload alt="image-20231215182334467"></p>
<p>api云端</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182354671.png" srcset="/img/loading.gif" lazyload alt="image-20231215182354671"></p>
<p>service云端</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182410899.png" srcset="/img/loading.gif" lazyload alt="image-20231215182410899"></p>
<p>swagger共用</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182427946.png" srcset="/img/loading.gif" lazyload alt="image-20231215182427946"></p>
<p>日志共用</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215182447578.png" srcset="/img/loading.gif" lazyload alt="image-20231215182447578"></p>
<p>api本地</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">content-api</span> <span class="hljs-comment"># 服务名</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 环境名</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span> <span class="hljs-comment"># 服务注册相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>      <span class="hljs-attr">config:</span> <span class="hljs-comment"># 配置文件相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-comment"># 引入nacos的 content-service-dev.yaml 的数据库相关依赖</span><br>        <span class="hljs-attr">extension-configs:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">content-service-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">shared-configs:</span> <span class="hljs-comment"># 共用共享配置</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">swagger-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">logging-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>service本地</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">content-service</span> <span class="hljs-comment"># 服务名</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 环境名</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">config:</span> <span class="hljs-comment"># 配置文件相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">shared-configs:</span> <span class="hljs-comment"># 共用共享配置</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">swagger-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">logging-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h5 id="配置优先级"><a href="#配置优先级" class="headerlink" title="配置优先级"></a>配置优先级</h5><p>所有微服务配置统一由nacos配置, 用到的配置文件有本地配置文件bootstrap.yaml 和 nacos 的配置文件, SpringBoot 读取配置文件的顺序如下:</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220047655.png" srcset="/img/loading.gif" lazyload alt="image-20231215220047655"></p>
<p>引入云配置的形式有:</p>
<ol>
<li>以项目应用名方式引入</li>
<li>以扩展配置文件方式引入</li>
<li>以共享配置文件方式引入</li>
<li>本地配置文件</li>
</ol>
<p>各配置文件优先级: <code>项目应用名配置文件&gt;扩展配置文件&gt;共享配置文件&gt;本地配置文件</code></p>
<p>有时我们测试程序在本地加一个配置进行测试</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220357445.png" srcset="/img/loading.gif" lazyload alt="image-20231215220357445"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220413980.png" srcset="/img/loading.gif" lazyload alt="image-20231215220413980"></p>
<p>启动, 发现没有生效, 因为云端配的63040, 优先级更高</p>
<p>如果想要本地优先, 在nacos配置文件加入配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#配置本地优先</span><br><span class="hljs-attr">spring:</span><br> <span class="hljs-attr">cloud:</span><br>  <span class="hljs-attr">config:</span><br>    <span class="hljs-attr">override-none:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215220757178.png" srcset="/img/loading.gif" lazyload alt="image-20231215220757178"></p>
<p>导入配置文件</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215221521134.png" srcset="/img/loading.gif" lazyload alt="image-20231215221521134"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215221529910.png" srcset="/img/loading.gif" lazyload alt="image-20231215221529910"></p>
<p>作业: 配置system模块</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#server:</span><br><span class="hljs-comment">#  servlet:</span><br><span class="hljs-comment">#    context-path: /system</span><br><span class="hljs-comment">#  port: 63110</span><br><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">system-api</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span> <span class="hljs-comment"># 服务注册相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>      <span class="hljs-attr">config:</span> <span class="hljs-comment"># 配置文件相关配置</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-comment"># 引入nacos的 system-service-dev.yaml 的数据库相关依赖</span><br>        <span class="hljs-attr">extension-configs:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">system-service-$&#123;spring.profiles.active&#125;.yaml</span><br>              <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>              <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">shared-configs:</span> <span class="hljs-comment"># 共用共享配置</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">swagger-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">logging-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br><span class="hljs-comment">#  datasource:</span><br><span class="hljs-comment">#    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="hljs-comment">#    url: jdbc:mysql://192.168.101.65:3306/xcplus_system?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br><span class="hljs-comment">#    username: root</span><br><span class="hljs-comment">#    password: mysql</span><br><span class="hljs-comment">## 日志文件配置路径</span><br><span class="hljs-comment">#logging:</span><br><span class="hljs-comment">#  config: classpath:log4j2-dev.xml</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">## swagger 文档配置</span><br><span class="hljs-comment">#swagger:</span><br><span class="hljs-comment">#  title: &quot;学成在线系统管理&quot;</span><br><span class="hljs-comment">#  description: &quot;系统管理接口&quot;</span><br><span class="hljs-comment">#  base-package: com.xuecheng.system</span><br><span class="hljs-comment">#  enabled: true</span><br><span class="hljs-comment">#  version: 1.0.0</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="搭建-Gateway"><a href="#搭建-Gateway" class="headerlink" title="搭建 Gateway"></a>搭建 Gateway</h4><blockquote>
<p>前端开启网关</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217161648811.png" srcset="/img/loading.gif" lazyload alt="image-20231217161648811"></p>
</blockquote>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215225149429.png" srcset="/img/loading.gif" lazyload alt="image-20231215225149429"></p>
<p>pom.xml 导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xuecheng-plus-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!--网关--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!--服务发现中心--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>bootstrap.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#微服务配置</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev402</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-project</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">shared-configs:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">logging-$&#123;spring.profiles.active&#125;.yaml</span><br>            <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-common</span><br>            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>云端配置</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215233423589.png" srcset="/img/loading.gif" lazyload alt="image-20231215233423589"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">63010</span> <span class="hljs-comment"># 网关端口</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br><span class="hljs-comment">#      filter:</span><br><span class="hljs-comment">#        strip-prefix:</span><br><span class="hljs-comment">#          enabled: true</span><br>      <span class="hljs-attr">routes:</span> <span class="hljs-comment"># 网关路由配置</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">content-api</span> <span class="hljs-comment"># 路由id，自定义，只要唯一即可</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://content-api</span> <span class="hljs-comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/content/**</span> <span class="hljs-comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span><br><span class="hljs-comment">#          filters:</span><br><span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">system-api</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://system-api</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/system/**</span><br><span class="hljs-comment">#          filters:</span><br><span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">media-api</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://media-api</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/media/**</span><br><span class="hljs-comment">#          filters:</span><br><span class="hljs-comment">#            - StripPrefix=1</span><br><br></code></pre></td></tr></table></figure>

<p>httpclient测试</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215233529684.png" srcset="/img/loading.gif" lazyload alt="image-20231215233529684"></p>
<p>swagger测试</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215233646868.png" srcset="/img/loading.gif" lazyload alt="image-20231215233646868"></p>
<h4 id="搭建媒资工程"><a href="#搭建媒资工程" class="headerlink" title="搭建媒资工程"></a>搭建媒资工程</h4><p>导入资料</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231215235010632.png" srcset="/img/loading.gif" lazyload alt="image-20231215235010632"></p>
<p>导入数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- MySQL dump 10.13  Distrib 8.0.31, for Win64 (x86_64)</span><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Host: 192.168.101.65    Database: xc148_media</span><br><span class="hljs-comment">-- ------------------------------------------------------</span><br><span class="hljs-comment">-- Server version	8.0.26</span><br><br><span class="hljs-comment">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */</span>;<br><span class="hljs-comment">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */</span>;<br><span class="hljs-comment">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */</span>;<br><span class="hljs-comment">/*!50503 SET NAMES utf8mb4 */</span>;<br><span class="hljs-comment">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */</span>;<br><span class="hljs-comment">/*!40103 SET TIME_ZONE=&#x27;+00:00&#x27; */</span>;<br><span class="hljs-comment">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */</span>;<br><span class="hljs-comment">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span>;<br><span class="hljs-comment">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#x27;NO_AUTO_VALUE_ON_ZERO&#x27; */</span>;<br><span class="hljs-comment">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span>;<br><br><br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Table structure for table `media_files`</span><br><span class="hljs-comment">--</span><br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `media_files`;<br><span class="hljs-comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;<br><span class="hljs-comment">/*!50503 SET character_set_client = utf8mb4 */</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `media_files` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件id,md5值&#x27;</span>,<br>  `company_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;机构ID&#x27;</span>,<br>  `company_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;机构名称&#x27;</span>,<br>  `filename` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件名称&#x27;</span>,<br>  `file_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件类型（图片、文档，视频）&#x27;</span>,<br>  `tags` <span class="hljs-type">varchar</span>(<span class="hljs-number">120</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;标签&#x27;</span>,<br>  `bucket` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;存储目录&#x27;</span>,<br>  `file_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;存储路径&#x27;</span>,<br>  `file_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件id&#x27;</span>,<br>  `url` <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;媒资文件访问地址&#x27;</span>,<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">60</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;上传人&#x27;</span>,<br>  `create_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;上传时间&#x27;</span>,<br>  `change_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;修改时间&#x27;</span>,<br>  `status` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;状态,1:正常，0:不展示&#x27;</span>,<br>  `remark` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;备注&#x27;</span>,<br>  `audit_status` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;审核状态&#x27;</span>,<br>  `audit_mind` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;审核意见&#x27;</span>,<br>  `file_size` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件大小&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE,<br>  <span class="hljs-keyword">UNIQUE</span> KEY `unique_fileid` (`file_id`) <span class="hljs-keyword">USING</span> BTREE COMMENT <span class="hljs-string">&#x27;文件id唯一索引 &#x27;</span><br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span> COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;媒资信息&#x27;</span>;<br><span class="hljs-comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Dumping data for table `media_files`</span><br><span class="hljs-comment">--</span><br><br>LOCK TABLES `media_files` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_files` DISABLE KEYS */</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `media_files` (`id`, `company_id`, `company_name`, `filename`, `file_type`, `tags`, `bucket`, `file_path`, `file_id`, `url`, `username`, `create_date`, `change_date`, `status`, `remark`, `audit_status`, `audit_mind`, `file_size`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;1137f04b2f44d1b2c37bcb73608864da&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;course29943168382846755.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/18.html&#x27;</span>,<span class="hljs-string">&#x27;1137f04b2f44d1b2c37bcb73608864da&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-18 12:21:32&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">34210</span>),(<span class="hljs-string">&#x27;1580180577525002241&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.jpg&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;8383a8c2c1d098fcc07da7d6e79ae31e&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/10/12/8383a8c2c1d098fcc07da7d6e79ae31e.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-12 20:56:23&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">5767</span>),(<span class="hljs-string">&#x27;18f919e23bedab97a78762c4875addc4&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;垂直分库-插入和查询测试.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;1/8/18f919e23bedab97a78762c4875addc4/18f919e23bedab97a78762c4875addc4.avi&#x27;</span>,<span class="hljs-string">&#x27;18f919e23bedab97a78762c4875addc4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-15 09:45:18&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">16305152</span>),(<span class="hljs-string">&#x27;1d0f0e6ed8a0c4a89bfd304b84599d9c&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;asset-icoGather.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&#x27;</span>,<span class="hljs-string">&#x27;1d0f0e6ed8a0c4a89bfd304b84599d9c&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:21:28&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">8059</span>),(<span class="hljs-string">&#x27;1f229319d6fed3431d2f9d06193a433b&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;01-分布式事务专题课程介绍.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;1/f/1f229319d6fed3431d2f9d06193a433b/1f229319d6fed3431d2f9d06193a433b.avi&#x27;</span>,<span class="hljs-string">&#x27;1f229319d6fed3431d2f9d06193a433b&#x27;</span>,<span class="hljs-string">&#x27;/video/1/f/1f229319d6fed3431d2f9d06193a433b/1f229319d6fed3431d2f9d06193a433b.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:30:02&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">14705152</span>),(<span class="hljs-string">&#x27;23f83ae728bd1269eee7ea2236e79644&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;16-Nacos配置管理-课程总结.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;2/3/23f83ae728bd1269eee7ea2236e79644/23f83ae728bd1269eee7ea2236e79644.avi&#x27;</span>,<span class="hljs-string">&#x27;23f83ae728bd1269eee7ea2236e79644&#x27;</span>,<span class="hljs-string">&#x27;/video/2/3/23f83ae728bd1269eee7ea2236e79644/23f83ae728bd1269eee7ea2236e79644.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:21:44&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">26053632</span>),(<span class="hljs-string">&#x27;287cdd91c5d444e0752b626cbd95b41c&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;nacos01.mp4&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;2/8/287cdd91c5d444e0752b626cbd95b41c/287cdd91c5d444e0752b626cbd95b41c.mp4&#x27;</span>,<span class="hljs-string">&#x27;287cdd91c5d444e0752b626cbd95b41c&#x27;</span>,<span class="hljs-string">&#x27;/video/2/8/287cdd91c5d444e0752b626cbd95b41c/287cdd91c5d444e0752b626cbd95b41c.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:28:43&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">25953447</span>),(<span class="hljs-string">&#x27;33c643206bb7c08e2cb99b622d7a1b63&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/10/07/33c643206bb7c08e2cb99b622d7a1b63.png&#x27;</span>,<span class="hljs-string">&#x27;33c643206bb7c08e2cb99b622d7a1b63&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/10/07/33c643206bb7c08e2cb99b622d7a1b63.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-07 06:20:05&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">169788</span>),(<span class="hljs-string">&#x27;345db593849aada5675ed1e438650eeb&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/10/07/345db593849aada5675ed1e438650eeb.png&#x27;</span>,<span class="hljs-string">&#x27;345db593849aada5675ed1e438650eeb&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/10/07/345db593849aada5675ed1e438650eeb.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-07 09:31:46&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">70171</span>),(<span class="hljs-string">&#x27;3a5a861d1c745d05166132c47b44f9e4&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;01-Nacos配置管理-内容介绍.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;3/a/3a5a861d1c745d05166132c47b44f9e4/3a5a861d1c745d05166132c47b44f9e4.avi&#x27;</span>,<span class="hljs-string">&#x27;3a5a861d1c745d05166132c47b44f9e4&#x27;</span>,<span class="hljs-string">&#x27;/video/3/a/3a5a861d1c745d05166132c47b44f9e4/3a5a861d1c745d05166132c47b44f9e4.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:19:24&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">23839232</span>),(<span class="hljs-string">&#x27;3fb1d9a565cb92f395f384bd62ef24cd&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1614759607876_0.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-string">&#x27;课程图片&#x27;</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/3fb1d9a565cb92f395f384bd62ef24cd.png&#x27;</span>,<span class="hljs-string">&#x27;3fb1d9a565cb92f395f384bd62ef24cd&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/3fb1d9a565cb92f395f384bd62ef24cd.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:06:11&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">58873</span>),(<span class="hljs-string">&#x27;500598cae139f77c1bb54459909e0443&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;course8561649859933456434.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/119.html&#x27;</span>,<span class="hljs-string">&#x27;500598cae139f77c1bb54459909e0443&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/course/119.html&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-07 09:39:49&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">35652</span>),(<span class="hljs-string">&#x27;538bd3d652593b8df70d84e643b12842&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;course6941513291436463735.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/121.html&#x27;</span>,<span class="hljs-string">&#x27;538bd3d652593b8df70d84e643b12842&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2023-02-09 11:33:18&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">36292</span>),(<span class="hljs-string">&#x27;5878a684ee9a36daae5d0741aaca0747&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;Spring Security集成测试&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;5/8/5878a684ee9a36daae5d0741aaca0747/5878a684ee9a36daae5d0741aaca0747.avi&#x27;</span>,<span class="hljs-string">&#x27;5878a684ee9a36daae5d0741aaca0747&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-16 15:30:17&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>),(<span class="hljs-string">&#x27;6ad24a762f67c18f61966c1b8c55abe6&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;07-分布式事务基础理论-BASE理论.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;6/a/6ad24a762f67c18f61966c1b8c55abe6/6ad24a762f67c18f61966c1b8c55abe6.avi&#x27;</span>,<span class="hljs-string">&#x27;6ad24a762f67c18f61966c1b8c55abe6&#x27;</span>,<span class="hljs-string">&#x27;/video/6/a/6ad24a762f67c18f61966c1b8c55abe6/6ad24a762f67c18f61966c1b8c55abe6.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:30:16&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">13189632</span>),(<span class="hljs-string">&#x27;70a98b4a2fffc89e50b101f959cc33ca&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;22-Hmily实现TCC事务-开发bank2的confirm方法.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;7/0/70a98b4a2fffc89e50b101f959cc33ca/70a98b4a2fffc89e50b101f959cc33ca.avi&#x27;</span>,<span class="hljs-string">&#x27;70a98b4a2fffc89e50b101f959cc33ca&#x27;</span>,<span class="hljs-string">&#x27;/video/7/0/70a98b4a2fffc89e50b101f959cc33ca/70a98b4a2fffc89e50b101f959cc33ca.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-14 18:30:52&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">18444288</span>),(<span class="hljs-string">&#x27;74b386417bb9f3764009dc94068a5e44&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;test2.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/74b386417bb9f3764009dc94068a5e44.html&#x27;</span>,<span class="hljs-string">&#x27;74b386417bb9f3764009dc94068a5e44&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:56:02&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">40124</span>),(<span class="hljs-string">&#x27;757891eae4473e7ba78827656b1ccacf&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;studyuser.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;757891eae4473e7ba78827656b1ccacf&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/10/13/757891eae4473e7ba78827656b1ccacf.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-13 19:57:01&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">4922</span>),(<span class="hljs-string">&#x27;8026f17cf7b8697eccec2c8406d0c96c&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;nacos.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/10/04/8026f17cf7b8697eccec2c8406d0c96c.png&#x27;</span>,<span class="hljs-string">&#x27;8026f17cf7b8697eccec2c8406d0c96c&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/10/04/8026f17cf7b8697eccec2c8406d0c96c.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-04 18:55:01&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">128051</span>),(<span class="hljs-string">&#x27;809694a6a974c35e3a36f36850837d7c&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;809694a6a974c35e3a36f36850837d7c&#x27;</span>,<span class="hljs-string">&#x27;/video/8/0/809694a6a974c35e3a36f36850837d7c/809694a6a974c35e3a36f36850837d7c.avi&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-13 21:27:14&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>),(<span class="hljs-string">&#x27;81d7ed5153316f5774885d3b4c07d8bc&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;Spring Security快速上手-创建工程.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;8/1/81d7ed5153316f5774885d3b4c07d8bc/81d7ed5153316f5774885d3b4c07d8bc.avi&#x27;</span>,<span class="hljs-string">&#x27;81d7ed5153316f5774885d3b4c07d8bc&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-15 09:41:50&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">19945472</span>),(<span class="hljs-string">&#x27;9b0a355a0a954fdb3671998b4b016474&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;test.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/test.html&#x27;</span>,<span class="hljs-string">&#x27;9b0a355a0a954fdb3671998b4b016474&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-17 17:04:40&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">34174</span>),(<span class="hljs-string">&#x27;a16da7a132559daf9e1193166b3e7f52&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.jpg&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/a16da7a132559daf9e1193166b3e7f52.jpg&#x27;</span>,<span class="hljs-string">&#x27;a16da7a132559daf9e1193166b3e7f52&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/a16da7a132559daf9e1193166b3e7f52.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:26:08&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">248329</span>),(<span class="hljs-string">&#x27;a61805e1360ab946def5471aaefc0a98&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;teacherpic.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/12/18/a61805e1360ab946def5471aaefc0a98.jpg&#x27;</span>,<span class="hljs-string">&#x27;a61805e1360ab946def5471aaefc0a98&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/12/18/a61805e1360ab946def5471aaefc0a98.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-18 12:10:52&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">11600</span>),(<span class="hljs-string">&#x27;a6fb4fc7faf1d3d0831819969529b888&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1.项目背景.mp4&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;a6fb4fc7faf1d3d0831819969529b888&#x27;</span>,<span class="hljs-string">&#x27;/video/a/6/a6fb4fc7faf1d3d0831819969529b888/a6fb4fc7faf1d3d0831819969529b888.mp4&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-13 21:30:17&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>),(<span class="hljs-string">&#x27;b2deb4a098bb12653c57bbaa0099697a&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;course3448922126748441722.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/117.html&#x27;</span>,<span class="hljs-string">&#x27;b2deb4a098bb12653c57bbaa0099697a&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/course/117.html&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-04 19:20:01&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">37705</span>),(<span class="hljs-string">&#x27;c051fe97e672dd399902a90f4ac67962&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;widget-3.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/12/18/c051fe97e672dd399902a90f4ac67962.jpg&#x27;</span>,<span class="hljs-string">&#x27;c051fe97e672dd399902a90f4ac67962&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/12/18/c051fe97e672dd399902a90f4ac67962.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-18 12:02:29&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">62469</span>),(<span class="hljs-string">&#x27;ca1d75b0a37b85fafd5f2e443f6f3f01&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;course2996275631019924973.html&#x27;</span>,<span class="hljs-string">&#x27;001003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;course/118.html&#x27;</span>,<span class="hljs-string">&#x27;ca1d75b0a37b85fafd5f2e443f6f3f01&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/course/118.html&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-10-07 06:40:51&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">35905</span>),(<span class="hljs-string">&#x27;d4af959873182feb0fdb91dc6c1958b5&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;widget-5.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-string">&#x27;课程图片&#x27;</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/18/d4af959873182feb0fdb91dc6c1958b5.png&#x27;</span>,<span class="hljs-string">&#x27;d4af959873182feb0fdb91dc6c1958b5&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/18/d4af959873182feb0fdb91dc6c1958b5.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-18 21:49:55&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">17799</span>),(<span class="hljs-string">&#x27;db4e24f27d78ccac14401b7479b35c26&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;nonepic.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/23/db4e24f27d78ccac14401b7479b35c26.jpg&#x27;</span>,<span class="hljs-string">&#x27;db4e24f27d78ccac14401b7479b35c26&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/23/db4e24f27d78ccac14401b7479b35c26.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-23 18:27:26&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">6919</span>),(<span class="hljs-string">&#x27;df39983fcad83a6ceef14bfeeb1bc523&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;add.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/df39983fcad83a6ceef14bfeeb1bc523.jpg&#x27;</span>,<span class="hljs-string">&#x27;df39983fcad83a6ceef14bfeeb1bc523&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/df39983fcad83a6ceef14bfeeb1bc523.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:13:59&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">10487</span>),(<span class="hljs-string">&#x27;e00ce88f53cc391d9ffd51a81834d2af&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;widget-1.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-string">&#x27;课程图片&#x27;</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/18/e00ce88f53cc391d9ffd51a81834d2af.jpg&#x27;</span>,<span class="hljs-string">&#x27;e00ce88f53cc391d9ffd51a81834d2af&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/18/e00ce88f53cc391d9ffd51a81834d2af.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-18 21:48:50&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">71386</span>),(<span class="hljs-string">&#x27;e726b71ba99c70e8c9d2850c2a7019d7&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;asset-login_img.jpg&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/e726b71ba99c70e8c9d2850c2a7019d7.jpg&#x27;</span>,<span class="hljs-string">&#x27;e726b71ba99c70e8c9d2850c2a7019d7&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/e726b71ba99c70e8c9d2850c2a7019d7.jpg&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:44:50&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">22620</span>),(<span class="hljs-string">&#x27;ef29eb93515e32f2d897956d5d914db7&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;Snipaste_2023-02-09_11-06-52.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2023/02/09/ef29eb93515e32f2d897956d5d914db7.png&#x27;</span>,<span class="hljs-string">&#x27;ef29eb93515e32f2d897956d5d914db7&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2023/02/09/ef29eb93515e32f2d897956d5d914db7.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2023-02-09 11:07:02&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">327814</span>),(<span class="hljs-string">&#x27;efd2eacc4485946fc27feb0caef7506c&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;读写分离-理解读写分离.avi&#x27;</span>,<span class="hljs-string">&#x27;001002&#x27;</span>,<span class="hljs-string">&#x27;课程视频&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;e/f/efd2eacc4485946fc27feb0caef7506c/efd2eacc4485946fc27feb0caef7506c.avi&#x27;</span>,<span class="hljs-string">&#x27;efd2eacc4485946fc27feb0caef7506c&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-12-15 09:45:19&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">14879232</span>),(<span class="hljs-string">&#x27;fbb57de7001cccf1e28fbe34c7506ddc&#x27;</span>,<span class="hljs-number">1232141425</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;asset-logo.png&#x27;</span>,<span class="hljs-string">&#x27;001001&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;mediafiles&#x27;</span>,<span class="hljs-string">&#x27;2022/09/20/fbb57de7001cccf1e28fbe34c7506ddc.png&#x27;</span>,<span class="hljs-string">&#x27;fbb57de7001cccf1e28fbe34c7506ddc&#x27;</span>,<span class="hljs-string">&#x27;/mediafiles/2022/09/20/fbb57de7001cccf1e28fbe34c7506ddc.png&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;2022-09-20 21:55:25&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;002003&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-number">4355</span>);<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_files` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Table structure for table `media_process`</span><br><span class="hljs-comment">--</span><br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `media_process`;<br><span class="hljs-comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;<br><span class="hljs-comment">/*!50503 SET character_set_client = utf8mb4 */</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `media_process` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `file_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">120</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件标识&#x27;</span>,<br>  `filename` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件名称&#x27;</span>,<br>  `bucket` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;存储桶&#x27;</span>,<br>  `file_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;存储路径&#x27;</span>,<br>  `status` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;状态,1:未处理，2：处理成功  3处理失败&#x27;</span>,<br>  `create_date` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;上传时间&#x27;</span>,<br>  `finish_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;完成时间&#x27;</span>,<br>  `fail_count` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;失败次数&#x27;</span>,<br>  `url` <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;媒资文件访问地址&#x27;</span>,<br>  `errormsg` <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;失败原因&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE,<br>  <span class="hljs-keyword">UNIQUE</span> KEY `unique_fileid` (`file_id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span>;<br><span class="hljs-comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Dumping data for table `media_process`</span><br><span class="hljs-comment">--</span><br><br>LOCK TABLES `media_process` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_process` DISABLE KEYS */</span>;<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_process` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Table structure for table `media_process_history`</span><br><span class="hljs-comment">--</span><br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `media_process_history`;<br><span class="hljs-comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;<br><span class="hljs-comment">/*!50503 SET character_set_client = utf8mb4 */</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `media_process_history` (<br>  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `file_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">120</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件标识&#x27;</span>,<br>  `filename` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件名称&#x27;</span>,<br>  `bucket` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;存储源&#x27;</span>,<br>  `status` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;状态,1:未处理，2：处理成功  3处理失败&#x27;</span>,<br>  `create_date` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;上传时间&#x27;</span>,<br>  `finish_date` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;完成时间&#x27;</span>,<br>  `url` <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;媒资文件访问地址&#x27;</span>,<br>  `fail_count` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;失败次数&#x27;</span>,<br>  `file_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;文件路径&#x27;</span>,<br>  `errormsg` <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;失败原因&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span>;<br><span class="hljs-comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Dumping data for table `media_process_history`</span><br><span class="hljs-comment">--</span><br><br>LOCK TABLES `media_process_history` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_process_history` DISABLE KEYS */</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `media_process_history` (`id`, `file_id`, `filename`, `bucket`, `status`, `create_date`, `finish_date`, `url`, `file_path`, `errormsg`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;81d7ed5153316f5774885d3b4c07d8bc&#x27;</span>,<span class="hljs-string">&#x27;Spring Security快速上手-创建工程.avi&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 09:41:50&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 10:30:26&#x27;</span>,<span class="hljs-string">&#x27;/video/8/1/81d7ed5153316f5774885d3b4c07d8bc/81d7ed5153316f5774885d3b4c07d8bc.mp4&#x27;</span>,<span class="hljs-string">&#x27;8/1/81d7ed5153316f5774885d3b4c07d8bc/81d7ed5153316f5774885d3b4c07d8bc.avi&#x27;</span>,<span class="hljs-keyword">NULL</span>),(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;18f919e23bedab97a78762c4875addc4&#x27;</span>,<span class="hljs-string">&#x27;垂直分库-插入和查询测试.avi&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 09:45:18&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 10:30:11&#x27;</span>,<span class="hljs-string">&#x27;/video/1/8/18f919e23bedab97a78762c4875addc4/18f919e23bedab97a78762c4875addc4.mp4&#x27;</span>,<span class="hljs-string">&#x27;1/8/18f919e23bedab97a78762c4875addc4/18f919e23bedab97a78762c4875addc4.avi&#x27;</span>,<span class="hljs-keyword">NULL</span>),(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;efd2eacc4485946fc27feb0caef7506c&#x27;</span>,<span class="hljs-string">&#x27;读写分离-理解读写分离.avi&#x27;</span>,<span class="hljs-string">&#x27;video&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 09:45:19&#x27;</span>,<span class="hljs-string">&#x27;2022-12-15 10:31:04&#x27;</span>,<span class="hljs-string">&#x27;/video/e/f/efd2eacc4485946fc27feb0caef7506c/efd2eacc4485946fc27feb0caef7506c.mp4&#x27;</span>,<span class="hljs-string">&#x27;e/f/efd2eacc4485946fc27feb0caef7506c/efd2eacc4485946fc27feb0caef7506c.avi&#x27;</span>,<span class="hljs-keyword">NULL</span>);<br><span class="hljs-comment">/*!40000 ALTER TABLE `media_process_history` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Table structure for table `mq_message`</span><br><span class="hljs-comment">--</span><br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `mq_message`;<br><span class="hljs-comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;<br><span class="hljs-comment">/*!50503 SET character_set_client = utf8mb4 */</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mq_message` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息id&#x27;</span>,<br>  `message_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息类型代码&#x27;</span>,<br>  `business_key1` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `business_key2` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `business_key3` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `mq_host` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列主机&#x27;</span>,<br>  `mq_port` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列端口&#x27;</span>,<br>  `mq_virtualhost` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列虚拟主机&#x27;</span>,<br>  `mq_queue` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;队列名称&#x27;</span>,<br>  `inform_num` <span class="hljs-type">int</span> unsigned <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;通知次数&#x27;</span>,<br>  `state` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;处理状态，0:初始，1:成功&#x27;</span>,<br>  `returnfailure_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复失败时间&#x27;</span>,<br>  `returnsuccess_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复成功时间&#x27;</span>,<br>  `returnfailure_msg` <span class="hljs-type">varchar</span>(<span class="hljs-number">2048</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复失败内容&#x27;</span>,<br>  `inform_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;最近通知时间&#x27;</span>,<br>  `stage_state1` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;阶段1处理状态, 0:初始，1:成功&#x27;</span>,<br>  `stage_state2` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;阶段2处理状态, 0:初始，1:成功&#x27;</span>,<br>  `stage_state3` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;阶段3处理状态, 0:初始，1:成功&#x27;</span>,<br>  `stage_state4` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;阶段4处理状态, 0:初始，1:成功&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span>;<br><span class="hljs-comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Dumping data for table `mq_message`</span><br><span class="hljs-comment">--</span><br><br>LOCK TABLES `mq_message` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `mq_message` DISABLE KEYS */</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `mq_message` (`id`, `message_type`, `business_key1`, `business_key2`, `business_key3`, `mq_host`, `mq_port`, `mq_virtualhost`, `mq_queue`, `inform_num`, `state`, `returnfailure_date`, `returnsuccess_date`, `returnfailure_msg`, `inform_date`, `stage_state1`, `stage_state2`, `stage_state3`, `stage_state4`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;f29a3149-7429-40be-8a4e-9909f32003b0&#x27;</span>,<span class="hljs-string">&#x27;xc.mq.msgsync.coursepub&#x27;</span>,<span class="hljs-string">&#x27;111&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">5607</span>,<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;xc.course.publish.queue&#x27;</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;0&#x27;</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>,<span class="hljs-keyword">NULL</span>);<br><span class="hljs-comment">/*!40000 ALTER TABLE `mq_message` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Table structure for table `mq_message_history`</span><br><span class="hljs-comment">--</span><br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `mq_message_history`;<br><span class="hljs-comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;<br><span class="hljs-comment">/*!50503 SET character_set_client = utf8mb4 */</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mq_message_history` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息id&#x27;</span>,<br>  `message_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息类型代码&#x27;</span>,<br>  `business_key1` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `business_key2` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `business_key3` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;关联业务信息&#x27;</span>,<br>  `mq_host` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列主机&#x27;</span>,<br>  `mq_port` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列端口&#x27;</span>,<br>  `mq_virtualhost` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;消息队列虚拟主机&#x27;</span>,<br>  `mq_queue` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;队列名称&#x27;</span>,<br>  `inform_num` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) unsigned zerofill <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;通知次数&#x27;</span>,<br>  `state` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) unsigned zerofill <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;处理状态，0:初始，1:成功，2:失败&#x27;</span>,<br>  `returnfailure_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复失败时间&#x27;</span>,<br>  `returnsuccess_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复成功时间&#x27;</span>,<br>  `returnfailure_msg` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;回复失败内容&#x27;</span>,<br>  `inform_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;最近通知时间&#x27;</span>,<br>  `stage_state1` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `stage_state2` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `stage_state3` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `stage_state4` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3 ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span>;<br><span class="hljs-comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;<br><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- Dumping data for table `mq_message_history`</span><br><span class="hljs-comment">--</span><br><br>LOCK TABLES `mq_message_history` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `mq_message_history` DISABLE KEYS */</span>;<br><span class="hljs-comment">/*!40000 ALTER TABLE `mq_message_history` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br><span class="hljs-comment">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */</span>;<br><br><span class="hljs-comment">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */</span>;<br><span class="hljs-comment">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */</span>;<br><span class="hljs-comment">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */</span>;<br><span class="hljs-comment">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */</span>;<br><span class="hljs-comment">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */</span>;<br><span class="hljs-comment">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */</span>;<br><span class="hljs-comment">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */</span>;<br><br><span class="hljs-comment">-- Dump completed on 2023-02-09 16:51:35</span><br><br></code></pre></td></tr></table></figure>

<p>修改云端数据库名对应    xc402_media</p>
<h3 id="分布式文件系统"><a href="#分布式文件系统" class="headerlink" title="分布式文件系统"></a>分布式文件系统</h3><blockquote>
<p><code>文件系统</code>是负责管理和存储文件的系统软件, 操作系统通过<code>文件系统</code>提供的接口<code>存储文件</code>, 用户通过<code>操作系统访问磁盘文件</code></p>
</blockquote>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216194353457.png" srcset="/img/loading.gif" lazyload alt="image-20231216194353457"></p>
<p>短视频平台的海量视频和图片, 应该怎么存储? 满足海量用户的浏览</p>
<blockquote>
<p><code>分布式文件系统</code>:  <code>一个</code>计算机无法存储海量文件, 通过网络将<code>若干</code>计算机组织<code>共同存储</code>海量文件, 接收用户请求, 这些组织起来的计算机通过<code>网络通信</code></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216194714379.png" srcset="/img/loading.gif" lazyload alt="image-20231216194714379"></p>
<p>优点:</p>
<ol>
<li>一台计算机文件系统处理<code>能力扩充</code>到多台计算机同时处理</li>
<li>一台计算机挂了还有另外<code>副本</code>计算机提供数据</li>
<li>每台计算机可以放到不同的地域, 用户可以<code>就近访问</code>, 提高访问速度</li>
</ol>
</blockquote>
<p>有一些分布式文件系统方案:  NFS   GFS  HDFS  云计算·厂家</p>
<p>本项目使用  <code>MinIO</code></p>
<h4 id="MinIO"><a href="#MinIO" class="headerlink" title="MinIO"></a>MinIO</h4><p>轻量的构建分布式文件系统的微服务, 和其他应用结合使用, 适合存储大容量非结构化数据, 可以和其他应用结合使用, 适合存储大容量非结构化数据, 例如图片, 视频, 日志, 备份数据, 容器&#x2F;虚拟机镜像等</p>
<p>官网：<a target="_blank" rel="noopener" href="https://min.io/">https://min.io</a></p>
<p>中文：<a target="_blank" rel="noopener" href="https://www.minio.org.cn/%EF%BC%8Chttp://docs.minio.org.cn/docs/">https://www.minio.org.cn/，http://docs.minio.org.cn/docs/</a></p>
<p>MinIO 集群采用<code>去中心化</code>共享架构, 每个节点对等关系, 通过Nginx对MinIO进行负载均衡访问</p>
<p>去中心化好处?</p>
<p>大数据中, 设计理念是无中心和分布式, Minio 分布式模式搭建一个高可用的对象存储服务, 使用这些存储设备, 不用考虑真实物理位置</p>
<p>将分布在不同服务器的多块硬盘组成一个对象存储服务, 由于硬盘分布在<code>不同的节点</code>, 分布式MinIO避免<code>单点故障</code></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216195914542.png" srcset="/img/loading.gif" lazyload alt="image-20231216195914542"></p>
<p>使用<code>纠删码技术</code>保护数据, 是一种恢复丢失和损坏数据的数字算法, 将数据分块冗余的分散存储在各个节点的磁盘, 所有可用磁盘组成一个集合, 上传一个文件时通过纠删码算法对文件分块存储, 将文件本身分成4个数据块, 4个校验块, 数据块和校验块分散存储在8块硬盘上</p>
<p>使用纠删码好处是即便丢失一半数量的硬盘, 也可以恢复数据, 不影响盛传和下载, 多于一半则无法恢复</p>
<p>下载minio，下载地址在<a target="_blank" rel="noopener" href="https://dl.min.io/server/minio/release/%EF%BC%8C%E5%8F%AF%E4%BB%8E%E8%AF%BE%E7%A8%8B%E8%B5%84%E6%96%99%E6%89%BE%E5%88%B0MinIO%E7%9A%84%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6minio.zip%E8%A7%A3%E5%8E%8B%E5%8D%B3%E5%8F%AF%E4%BD%BF%E7%94%A8%EF%BC%8CCMD%E8%BF%9B%E5%85%A5%E6%9C%89minio.exe%E7%9A%84%E7%9B%AE%E5%BD%95%EF%BC%8C%E8%BF%90%E8%A1%8C%E4%B8%8B%E8%BE%B9%E7%9A%84%E5%91%BD%E4%BB%A4%EF%BC%9A">https://dl.min.io/server/minio/release/，可从课程资料找到MinIO的安装文件minio.zip解压即可使用，CMD进入有minio.exe的目录，运行下边的命令：</a></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livescript">.<span class="hljs-string">\minio.exe</span> server D:<span class="hljs-string">\develop\minio_data\data1</span>  D:<span class="hljs-string">\develop\minio_data\data2</span>  D:<span class="hljs-string">\develop\minio_data\data3</span>  D:<span class="hljs-string">\develop\minio_data\data4</span><br></code></pre></td></tr></table></figure>

<p>下边输入<a href="http://localhost:9000进行登录，账号和密码为：minioadmin/minioadmin">http://localhost:9000进行登录，账号和密码为：minioadmin/minioadmin</a></p>
<p>登录成功</p>
<p>创建存储桶并存入几个文件</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202614936.png" srcset="/img/loading.gif" lazyload alt="image-20231216202614936"></p>
<p>可以发现文件被同时存入4个文件夹</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202646182.png" srcset="/img/loading.gif" lazyload alt="image-20231216202646182"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202658155.png" srcset="/img/loading.gif" lazyload alt="image-20231216202658155"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202707768.png" srcset="/img/loading.gif" lazyload alt="image-20231216202707768"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216202716547.png" srcset="/img/loading.gif" lazyload alt="image-20231216202716547"></p>
<p>删除1个data目录, 文件不影响, 过一会恢复为4个目录</p>
<p>删除2个data目录, 文件不影响, 过一会恢复为4个目录</p>
<p>删除3个data目录, 由于 集合中共有4块硬盘，有大于一半的硬盘损坏数据无法恢复。此时报错：We encountered an internal error, please try again. (Read failed. Insufficient number of drives online)在线驱动器数量不足。</p>
<p>Docker中测试 minio</p>
<p>资料中的虚拟机已经部署好了  minio</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sh /data/soft /restart.sh<br></code></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://192.168.101.65:9000/">http://192.168.101.65:9000</a></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216203051482.png" srcset="/img/loading.gif" lazyload alt="image-20231216203051482"></p>
<p>本项目创建两个buckets：</p>
<p>mediafiles： 普通文件</p>
<p>video：视频文件</p>
<h4 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h4><p>MinIO 提供多个语言版本的SDK支持</p>
<p>文档地址：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-quickstart-guide.html">https://docs.min.io/docs/java-client-quickstart-guide.html</a></p>
<p>xuecheng-plus-media-service 导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">cxxxxxxxxxx11 1<span class="hljs-comment">&lt;!-- minio 分布式文件系统 --&gt;</span>2<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>3    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.minio<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>4    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>minio<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>5    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>6<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>7<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>8    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>9    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>10    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>参数说明: </p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Endpoint</td>
<td>对象存储服务的URL</td>
</tr>
<tr>
<td>Access Key</td>
<td>Access key就像用户ID，可以唯一标识你的账户</td>
</tr>
<tr>
<td>Secret Key</td>
<td>Secret key是你账户的密码</td>
</tr>
</tbody></table>
<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media;<br><br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfo;<br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfoUtil;<br><span class="hljs-keyword">import</span> io.minio.GetObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.MinioClient;<br><span class="hljs-keyword">import</span> io.minio.RemoveObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.UploadObjectArgs;<br><span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.FilterInputStream;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/16 20:44</span><br><span class="hljs-comment"> * 测试 MinIO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinioTest</span> &#123;<br><br>    <span class="hljs-comment">// 准备minio客户端</span><br>    <span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span> MinioClient.builder()<br>            .endpoint(<span class="hljs-string">&quot;http://192.168.101.65:9000&quot;</span>)<br>            .credentials(<span class="hljs-string">&quot;minioadmin&quot;</span>, <span class="hljs-string">&quot;minioadmin&quot;</span>)<br>            .build();<br><br><br>    <span class="hljs-comment">// 上传文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">upload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">// 通过扩展名取出mimeType</span><br>        <span class="hljs-type">ContentInfo</span> <span class="hljs-variable">extensionMatch</span> <span class="hljs-operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="hljs-string">&quot;.mp4&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE; <span class="hljs-comment">// 通用mimeType, 字节流</span><br>        <span class="hljs-keyword">if</span> (extensionMatch != <span class="hljs-literal">null</span>) &#123;<br>            mimeType = extensionMatch.getMimeType();<br>        &#125;<br><br>        <span class="hljs-comment">// 上传文件的参数信息</span><br>        <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>) <span class="hljs-comment">//桶</span><br>                .filename(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>) <span class="hljs-comment">//本地文件路径</span><br>                <span class="hljs-comment">// .object(&quot;lqx.mp4&quot;) //对象名</span><br>                .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                .contentType(mimeType)<br>                .build();<br><br>        <span class="hljs-comment">// 上传文件</span><br>        minioClient.uploadObject(uploadObjectArgs);<br><br>    &#125;<br><br>    <span class="hljs-comment">// 删除文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">RemoveObjectArgs</span> <span class="hljs-variable">removeObjectArgs</span> <span class="hljs-operator">=</span> RemoveObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>)<br>                .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                .build();<br>        minioClient.removeObject(removeObjectArgs);<br>    &#125;<br><br><br>    <span class="hljs-comment">// 查询文件: 从minio下载文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">get</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">GetObjectArgs</span> <span class="hljs-variable">getObjectArgs</span> <span class="hljs-operator">=</span> GetObjectArgs.builder()<br>                            .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>)<br>                            .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                            .build();<br>        <span class="hljs-comment">// GetObjectResponse extends FilterInputStream</span><br>        <span class="hljs-comment">// 查询远程服务获取一个流对象</span><br>        <span class="hljs-type">FilterInputStream</span> <span class="hljs-variable">filterInputStream</span> <span class="hljs-operator">=</span> minioClient.getObject(getObjectArgs);<br>        <span class="hljs-comment">// 指定输出流</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\output\\lqx.mp4&quot;</span>);<br>        <span class="hljs-comment">// 拷贝流</span><br>        IOUtils.copy(filterInputStream, outputStream);<br><br><br>        <span class="hljs-comment">// 校验文件完整性, 对文件的内容进行md5校验(上传和下载过程出现网络丢包, 所以需要进行md5校验)</span><br>        <span class="hljs-comment">// 这里source_md5不能用filterInputStream, 网络文件的md5不稳定, 要用原始文件(传之前硬盘文件)的md5</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">source_md5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">local_md5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\output\\lqx.mp4&quot;</span>));<br>        <span class="hljs-keyword">if</span> (source_md5.equals(local_md5)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;下载成功&quot;</span>);<br>        &#125;<br>    &#125;<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216214756277.png" srcset="/img/loading.gif" lazyload alt="image-20231216214756277"></p>
<hr>
<h3 id="上传图片"><a href="#上传图片" class="headerlink" title="上传图片"></a>上传图片</h3><h4 id="业务流程-1"><a href="#业务流程-1" class="headerlink" title="业务流程"></a>业务流程</h4><p>课程图片是宣传课程的信息, 在新增课程界面上传课程图片, 可以修改课程图片</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216214926087.png" srcset="/img/loading.gif" lazyload alt="image-20231216214926087"></p>
<p>上传课程图片总体上包括两部分：</p>
<p>1、上传课程图片前端请求媒资管理服务将文件上传至分布式文件系统，并且在<code>媒资管理数据库</code>保存文件信息。</p>
<p>2、上传图片成功保存图片地址到<code>课程基本信息表</code>中</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215027914.png" srcset="/img/loading.gif" lazyload alt="image-20231216215027914"></p>
<p>1、前端进入上传图片界面</p>
<p>2、上传图片，请求媒资管理服务。</p>
<p>3、媒资管理服务将图片文件存储在MinIO。</p>
<p>4、媒资管理记录文件信息到数据库。</p>
<p>5、前端请求内容管理服务<code>保存课程信息</code>，在内容管理数据库保存图片地址。</p>
<h4 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h4><p>设计的表: course_base(课程信息表中的图片字段)   之前的</p>
<p>media_files(媒资数据库的文件表)</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215449458.png" srcset="/img/loading.gif" lazyload alt="image-20231216215449458"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215459908.png" srcset="/img/loading.gif" lazyload alt="image-20231216215459908"></p>
<h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h4><p>创建存储桶 mediafiles(public)</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215804186.png" srcset="/img/loading.gif" lazyload alt="image-20231216215804186"></p>
<p>nacos配置</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231216215749771.png" srcset="/img/loading.gif" lazyload alt="image-20231216215749771"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">YAML</span><br><span class="hljs-attr">minio:</span><br>  <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://192.168.101.65:9000</span><br>  <span class="hljs-attr">accessKey:</span> <span class="hljs-string">minioadmin</span><br>  <span class="hljs-attr">secretKey:</span> <span class="hljs-string">minioadmin</span><br>  <span class="hljs-attr">bucket:</span><br>    <span class="hljs-attr">files:</span> <span class="hljs-string">mediafiles</span><br>    <span class="hljs-attr">videofiles:</span> <span class="hljs-string">video</span><br></code></pre></td></tr></table></figure>

<p>media-service 工程 minio 配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.config;<br><br><span class="hljs-keyword">import</span> io.minio.MinioClient;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> minio配置</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/12 19:32</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinioConfig</span> &#123;<br><br><br> <span class="hljs-meta">@Value(&quot;$&#123;minio.endpoint&#125;&quot;)</span><br> <span class="hljs-keyword">private</span> String endpoint;<br> <span class="hljs-meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span><br> <span class="hljs-keyword">private</span> String accessKey;<br> <span class="hljs-meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span><br> <span class="hljs-keyword">private</span> String secretKey;<br><br> <span class="hljs-meta">@Bean</span><br> <span class="hljs-keyword">public</span> MinioClient <span class="hljs-title function_">minioClient</span><span class="hljs-params">()</span> &#123;<br><br>  <span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span><br>          MinioClient.builder()<br>                  .endpoint(endpoint)<br>                  .credentials(accessKey, secretKey)<br>                  .build();<br>  <span class="hljs-keyword">return</span> minioClient;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><p>此接口定义为一个通用的上传文件接口， 可以上传图片或其他文件</p>
<p>请求路径: &#x2F;media&#x2F;upload&#x2F;coursefile</p>
<p>请求内容:	Content-Type：multipart&#x2F;form-data</p>
<p>form-data: name&#x3D;”filedata”; filename&#x3D;”具体的文件名称”</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json">JSON<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;companyId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1232141425</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;companyName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;filename&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.jpg&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;fileType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;001001&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;tags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;bucket&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;fileId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;timelength&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;createDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2022-09-12T21:57:18&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;changeDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;remark&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;auditStatus&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;auditMind&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;fileSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">248329</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;上传图片&quot;)</span> <span class="hljs-comment">// 服务器是消费者, 消费类型: multipart/form-data</span><br>    <span class="hljs-meta">@PostMapping(value = &quot;/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span><br>    <span class="hljs-keyword">public</span> UploadFileResultDto <span class="hljs-title function_">upload</span><span class="hljs-params">(<span class="hljs-meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile filedata)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">// 接收到文件了, 这时文件作为临时文件存在 tomcat 但是获取不到路径</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br><br>        <span class="hljs-type">UploadFileParamsDto</span> <span class="hljs-variable">uploadFileParamsDto</span> <span class="hljs-operator">=</span> UploadFileParamsDto.builder()<br>                .filename(filedata.getOriginalFilename()) <span class="hljs-comment">// 原始文件名称</span><br>                .fileSize(filedata.getSize()) <span class="hljs-comment">// 文件大小</span><br>                .fileType(<span class="hljs-string">&quot;001001&quot;</span>) <span class="hljs-comment">//文件类型</span><br>                .build();<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">tempFile</span> <span class="hljs-operator">=</span> File.createTempFile(<span class="hljs-string">&quot;minio&quot;</span>, <span class="hljs-string">&quot;.temp&quot;</span>);<span class="hljs-comment">//创建临时文件</span><br>        filedata.transferTo(tempFile);<span class="hljs-comment">//文件转换</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">localFilePath</span> <span class="hljs-operator">=</span> tempFile.getAbsolutePath();<span class="hljs-comment">//获取绝对路径 此时文件在tomcat</span><br><br>        <span class="hljs-comment">// 调用service上传图片</span><br>        mediaFileService.uploadFile(companyId, uploadFileParamsDto, localFilePath);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>service</p>
<pre><code class=" mermaid">graph LR

uploadFile --&gt; getMimeType
uploadFile --&gt; getMd5ByFilename
uploadFile --&gt; getDefaultFolderPath
uploadFile --&gt; addMediaFilesToMinIO
uploadFile --&gt; addMediaFilesToDB
</code></pre>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> UploadFileResultDto <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span> &#123;<br>        <span class="hljs-comment">// 将文件上传minio</span><br>        <span class="hljs-comment">// 根据文件名得到扩展名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> uploadFileParamsDto.getFilename();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> getMimeType(extension);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> getMd5ByFilename(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(localFilePath));<br>        <span class="hljs-comment">// 约定objectName怎么存 -&gt; /年/月/日/md5.后缀</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> getDefaultFolderPath() + md5 + extension;<br>        <span class="hljs-comment">// 将文件上传到minio</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isUploadMinIO</span> <span class="hljs-operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_mediafiles, objectName);<br>        <span class="hljs-keyword">if</span> (!isUploadMinIO)&#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;上传文件到MinIO失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 将文件信息保存到DB</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> addMediaFilesToDB(companyId, uploadFileParamsDto, md5, bucket_mediafiles, objectName);<br>        <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;文件上传后保存信息失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 准备返回的对象</span><br>        <span class="hljs-type">UploadFileResultDto</span> <span class="hljs-variable">uploadFileResultDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadFileResultDto</span>();<br>        BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);<br>        <span class="hljs-keyword">return</span> uploadFileResultDto;<br>    &#125;<br> <br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将文件信息保存到DB</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> companyId           机构id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> uploadFileParamsDto 上传文件的信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> md5                   md5</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bucket                桶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> objectName         对象名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">addMediaFilesToDB</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String md5, String bucket, String objectName)</span> &#123;<br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(md5);<br>        <span class="hljs-keyword">if</span> (mediaFiles==<span class="hljs-literal">null</span>)&#123;<br>            mediaFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFiles</span>();<br>            BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);<br>            <span class="hljs-comment">// 文件id</span><br>            mediaFiles.setId(md5);<br>            <span class="hljs-comment">// 机构id</span><br>            mediaFiles.setCompanyId(companyId);<br>            <span class="hljs-comment">// 桶</span><br>            mediaFiles.setBucket(bucket);<br>            <span class="hljs-comment">// 对象名称</span><br>            mediaFiles.setFilePath(objectName);<br>            <span class="hljs-comment">// file_id</span><br>            mediaFiles.setFileId(md5);<br>            <span class="hljs-comment">// url 完整访问地址</span><br>            mediaFiles.setUrl(<span class="hljs-string">&quot;/&quot;</span>+bucket+<span class="hljs-string">&quot;/&quot;</span>+objectName);<br>            <span class="hljs-comment">// 上传时间</span><br>            mediaFiles.setCreateDate(LocalDateTime.now());<br>            <span class="hljs-comment">// 状态</span><br>            mediaFiles.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>            <span class="hljs-comment">// 审核状态</span><br>            mediaFiles.setAuditStatus(<span class="hljs-string">&quot;002003&quot;</span>);<br>            <span class="hljs-comment">// 插入数据库</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> mediaFilesMapper.insert(mediaFiles);<br>            <span class="hljs-keyword">if</span> (insert&lt;=<span class="hljs-number">0</span>)&#123;<br>                log.debug(<span class="hljs-string">&quot;向数据库保存文件信息失败, bucket:&#123;&#125;, objectName: &#123;&#125;&quot;</span>, bucket, objectName);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> mediaFiles;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取文件默认存储目录路径     年/月/日/   2023-12-19 -&gt; 2023/12/19/</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getDefaultFolderPath</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">folder</span> <span class="hljs-operator">=</span> sdf.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>) + <span class="hljs-string">&quot;/&quot;</span>;<br>        <span class="hljs-keyword">return</span> folder;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取文件md5</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMd5ByFilename</span><span class="hljs-params">(File file)</span>&#123;<br>        <span class="hljs-keyword">try</span>(<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file))&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileMd5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(fileInputStream);<br>            <span class="hljs-keyword">return</span> fileMd5;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">// 通过扩展名取出mimeType      .mp4 -&gt; video/mp4</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMimeType</span><span class="hljs-params">(String extension)</span> &#123;<br>        <span class="hljs-keyword">if</span> (extension == <span class="hljs-literal">null</span>) &#123;<br>            extension = <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        <span class="hljs-type">ContentInfo</span> <span class="hljs-variable">extensionMatch</span> <span class="hljs-operator">=</span> ContentInfoUtil.findExtensionMatch(extension);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE; <span class="hljs-comment">// 通用mimeType, 字节流</span><br>        <span class="hljs-keyword">if</span> (extensionMatch != <span class="hljs-literal">null</span>) &#123;<br>            mimeType = extensionMatch.getMimeType();<br>        &#125;<br>        <span class="hljs-keyword">return</span> mimeType;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将文件上传到minio</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> localFilePath 本地文件路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mimeType      媒体类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bucket        桶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> objectName    对象名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addMediaFilesToMinIO</span><span class="hljs-params">(String localFilePath, String mimeType, String bucket, String objectName)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 准备上传文件的参数信息</span><br>            <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>                    .bucket(bucket) <span class="hljs-comment">//桶</span><br>                    .filename(localFilePath) <span class="hljs-comment">//本地文件路径</span><br>                    .object(objectName) <span class="hljs-comment">// 对象名</span><br>                    .contentType(mimeType)<br>                    .build();<br>            minioClient.uploadObject(uploadObjectArgs); <span class="hljs-comment">// 上传</span><br>            log.debug(<span class="hljs-string">&quot;上传文件到minio成功, bucket:&#123;&#125;, objectName:&#123;&#125;&quot;</span>, bucket, objectName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            log.error(<span class="hljs-string">&quot;上传文件到minio出错, bucket:&#123;&#125;, objectName:&#123;&#125;, 错误信息:&#123;&#125;&quot;</span>, bucket, objectName, e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="事务优化"><a href="#事务优化" class="headerlink" title="事务优化"></a>事务优化</h4><p>给uploadFile方法加@Transactional注解, 代理对象执行此方法前会开启事务</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219200451925.png" srcset="/img/loading.gif" lazyload alt="image-20231219200451925"></p>
<p>如果没有加@Transactional注解, 代理对象执行方法前不进行事务控制</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219200554329.png" srcset="/img/loading.gif" lazyload alt="image-20231219200554329"></p>
<p><code>事务失效</code></p>
<p>由于uploadFile方法包括网络操作(addMediaFilesToMinIO耗时长), 占用数据库资源, 在addMediaFilesToDB加@Transactional(去掉uploadFile的注解), 根据上面分析, 这样丧失了事务的作用</p>
<p><code>解决</code></p>
<p>在service类中注入一个当前类的代理对象currentProxy  , addMediaFilesToDB提到service接口层, 利用注入的方式调用</p>
<p>addMediaFilesToDB</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 注入MediaFileService代理对象</span><br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileService currentProxy;<br></code></pre></td></tr></table></figure>

<p>接口层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">MediaFiles <span class="hljs-title function_">addMediaFilesToDB</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String objectName, String fileMD5, String bucket)</span>;<br></code></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> UploadFileResultDto <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span> &#123;<br>    <span class="hljs-comment">// 将文件上传minio</span><br>    <span class="hljs-comment">// 根据文件名得到扩展名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> uploadFileParamsDto.getFilename();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> getMimeType(extension);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> getMd5ByFilename(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(localFilePath));<br>    <span class="hljs-comment">// 约定objectName怎么存 -&gt; /年/月/日/md5.后缀</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> getDefaultFolderPath() + md5 + extension;<br>    <span class="hljs-comment">// 将文件上传到minio</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isUploadMinIO</span> <span class="hljs-operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_mediafiles, objectName);<br>    <span class="hljs-keyword">if</span> (!isUploadMinIO)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;上传文件到MinIO失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 将文件信息保存到DB</span><br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> currentProxy.addMediaFilesToDB(companyId, uploadFileParamsDto, md5, bucket_mediafiles, objectName);<br>    <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;文件上传后保存信息失败&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 准备返回的对象</span><br>    <span class="hljs-type">UploadFileResultDto</span> <span class="hljs-variable">uploadFileResultDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadFileResultDto</span>();<br>    BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);<br>    <span class="hljs-keyword">return</span> uploadFileResultDto;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 将文件信息保存到DB</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> companyId           机构id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> uploadFileParamsDto 上传文件的信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> md5                   md5</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> bucket                桶</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> objectName         对象名称</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">addMediaFilesToDB</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String md5, String bucket, String objectName)</span> &#123;<br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(md5);<br>    <span class="hljs-keyword">if</span> (mediaFiles==<span class="hljs-literal">null</span>)&#123;<br>        mediaFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFiles</span>();<br>        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);<br>        <span class="hljs-comment">// 文件id</span><br>        mediaFiles.setId(md5);<br>        <span class="hljs-comment">// 机构id</span><br>        mediaFiles.setCompanyId(companyId);<br>        <span class="hljs-comment">// 桶</span><br>        mediaFiles.setBucket(bucket);<br>        <span class="hljs-comment">// 对象名称</span><br>        mediaFiles.setFilePath(objectName);<br>        <span class="hljs-comment">// file_id</span><br>        mediaFiles.setFileId(md5);<br>        <span class="hljs-comment">// url 完整访问地址</span><br>        mediaFiles.setUrl(<span class="hljs-string">&quot;/&quot;</span>+bucket+<span class="hljs-string">&quot;/&quot;</span>+objectName);<br>        <span class="hljs-comment">// 上传时间</span><br>        mediaFiles.setCreateDate(LocalDateTime.now());<br>        <span class="hljs-comment">// 状态</span><br>        mediaFiles.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        <span class="hljs-comment">// 审核状态</span><br>        mediaFiles.setAuditStatus(<span class="hljs-string">&quot;002003&quot;</span>);<br>        <span class="hljs-comment">// 插入数据库</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> mediaFilesMapper.insert(mediaFiles);<br>        <span class="hljs-keyword">if</span> (insert&lt;=<span class="hljs-number">0</span>)&#123;<br>            log.debug(<span class="hljs-string">&quot;向数据库保存文件信息失败, bucket:&#123;&#125;, objectName: &#123;&#125;&quot;</span>, bucket, objectName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> mediaFiles;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>在updateFile添加@Transactional 调用updateFile方法开启数据库事务, 如果上传文件时间较长(上传超大的视频), 数据库事务持续时间变长, 数据库连接释放变慢, 导致数据库连接不够用</p>
<p>由于spring的动态代理机制, 不能只在 addMediaFilesToDB 加@Transactional即可</p>
<p>判断方法能否被事务控制?</p>
<ol>
<li>是不是通过代理对象调用的方法</li>
<li>该方法是否添加了@Transactional 注解</li>
</ol>
<p>我们需要通过代理对象去调用addMediaFilesToDB方法</p>
<p>非事务方法调用事务方法的解决:</p>
<p>在service类中注入当前类的代理对象, 将事务方法提到接口层,利用代理对象调用非事务方法</p>
</blockquote>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">### 上传文件<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>media_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/media/upload/coursefile<br>Content-Type<span class="hljs-punctuation">:</span> multipart/form-data; boundary=WebAppBoundary<br><br>--WebAppBoundary<br>Content-Disposition<span class="hljs-punctuation">:</span> form-data; name=<span class="hljs-string">&quot;filedata&quot;</span>; filename=<span class="hljs-string">&quot;1.jpg&quot;</span><br>Content-Type<span class="hljs-punctuation">:</span> application/octet-stream<br><br>&lt; d<span class="hljs-punctuation">:</span>/develop/upload/<span class="hljs-number">1.</span>jpg<br></code></pre></td></tr></table></figure>



<h4 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a>前后端联调</h4><blockquote>
<p>别忘了前端开启网关, 不然这里 404</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217161648811.png" srcset="/img/loading.gif" lazyload alt="image-20231217161648811"></p>
</blockquote>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217161939939.png" srcset="/img/loading.gif" lazyload alt="image-20231217161939939"></p>
<h4 id="bug修复"><a href="#bug修复" class="headerlink" title="bug修复"></a>bug修复</h4><p>媒资列表可以查看到上传的图片信息, 条件查询不起作用</p>
<p>缺少查询条件</p>
<p>修改MediaFileServiceImpl中的queryMediaFiles方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PageResult&lt;MediaFiles&gt; <span class="hljs-title function_">queryMediaFiles</span><span class="hljs-params">(Long companyId, PageParams pageParams, QueryMediaParamsDto queryMediaParamsDto)</span> &#123;<br><br>        <span class="hljs-comment">//构建查询条件对象</span><br>        LambdaQueryWrapper&lt;MediaFiles&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>+       queryWrapper.like(!StringUtils.isEmpty(queryMediaParamsDto.getFilename()), MediaFiles::getFilename, queryMediaParamsDto.getFilename());<br>+       queryWrapper.eq(!StringUtils.isEmpty(queryMediaParamsDto.getFileType()), MediaFiles::getFileType, queryMediaParamsDto.getFileType());<br>        <span class="hljs-comment">//分页对象</span><br>        Page&lt;MediaFiles&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());<br>        <span class="hljs-comment">// 查询数据内容获得结果</span><br>        Page&lt;MediaFiles&gt; pageResult = mediaFilesMapper.selectPage(page, queryWrapper);<br>        <span class="hljs-comment">// 获取数据列表</span><br>        List&lt;MediaFiles&gt; list = pageResult.getRecords();<br>        <span class="hljs-comment">// 获取数据总数</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> pageResult.getTotal();<br>        <span class="hljs-comment">// 构建结果集</span><br>        PageResult&lt;MediaFiles&gt; mediaListResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());<br>        <span class="hljs-keyword">return</span> mediaListResult;<br><br>    &#125;<br></code></pre></td></tr></table></figure>

<h3 id="上传视频"><a href="#上传视频" class="headerlink" title="上传视频"></a>上传视频</h3><h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217145801454.png" srcset="/img/loading.gif" lazyload alt="image-20231217145801454"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217145813948.png" srcset="/img/loading.gif" lazyload alt="image-20231217145813948"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162114895.png" srcset="/img/loading.gif" lazyload alt="image-20231217162114895"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162124359.png" srcset="/img/loading.gif" lazyload alt="image-20231217162124359"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162132320.png" srcset="/img/loading.gif" lazyload alt="image-20231217162132320"></p>
<h4 id="断点续传技术"><a href="#断点续传技术" class="headerlink" title="断点续传技术"></a>断点续传技术</h4><blockquote>
<p>通常视频比较大, 对于媒资系统需求要满足大文件上传要求, http协议对上传文件没有限制, 但是客户的网络环境质量, 电脑配置如果较差, 大文件快传完了突然断网了, 需要重新上传, 用户体验差, 所以对于大文件需要支持	<code>断点续传</code>	</p>
<p>什么是 断点续传?</p>
<p>在下载或上传时, 将下载和上传任务人为的<code>划分成几个部分</code>, 每<code>一个部分</code>采用<code>一个线程</code>进行上传或下载, 如果网络故障, 可以从上传或下载的部分可是继续上传下载未完成的部分, 不用从头开始上传下载, 节省操作时间, 提高用户体验</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217162624649.png" srcset="/img/loading.gif" lazyload alt="image-20231217162624649"></p>
<ol>
<li>前端上传前把文件分成块</li>
<li>一块一块的上传, 上传中断后重新上传, 已上传分块不用再上传</li>
<li>各分块上传完成最后在服务端合并</li>
</ol>
</blockquote>
<h5 id="测试本地分块上传-合并和清理"><a href="#测试本地分块上传-合并和清理" class="headerlink" title="测试本地分块上传,合并和清理"></a>测试<code>本地</code>分块上传,合并和清理</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media;<br><br><span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.RandomAccessFile;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 大文件测试</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/17 16:33</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigFileTest</span> &#123;<br><br>    <span class="hljs-comment">// 文件分块</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testChunk</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">sourceFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>); <span class="hljs-comment">// 源文件</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">chunkSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1</span>; <span class="hljs-comment">//分块大小1MB</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">chunkNum</span> <span class="hljs-operator">=</span> (<span class="hljs-type">long</span>) Math.ceil(sourceFile.length() * <span class="hljs-number">1.0</span> / chunkSize); <span class="hljs-comment">//分块数量</span><br>        System.out.println(<span class="hljs-string">&quot;分块数量: &quot;</span> + chunkNum);<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">//缓冲区</span><br>        <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(sourceFile, <span class="hljs-string">&quot;r&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; chunkNum; i++) &#123;<br>            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\chunk\\&quot;</span> + i);<br>            <span class="hljs-keyword">if</span> (file.createNewFile()) &#123;<br>                <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">rw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(file, <span class="hljs-string">&quot;rw&quot;</span>);<br>                rw.seek(<span class="hljs-number">0</span>); <span class="hljs-comment">//指针指向文件顶端</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">while</span> ((len = r.read(buffer)) != -<span class="hljs-number">1</span>) &#123; <span class="hljs-comment">//len=1024</span><br>                    rw.write(buffer, <span class="hljs-number">0</span>, len); <span class="hljs-comment">//向这个分块写入数据</span><br>                    <span class="hljs-keyword">if</span> (file.length() &gt;= chunkSize) <span class="hljs-keyword">break</span>; <span class="hljs-comment">//写满1024</span><br>                &#125;<br>                rw.close();<br>                System.out.println(<span class="hljs-string">&quot;分块&quot;</span> + i + <span class="hljs-string">&quot;写入完成&quot;</span>);<br>            &#125;<br>        &#125;<br>        r.close();<br>        System.out.println(<span class="hljs-string">&quot;所有分块写入完成&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-comment">// 块文件合并</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMerge</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">sourceFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">chunkFolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\chunk\\&quot;</span>);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">mergeFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx2.mp4&quot;</span>);<br>        <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">rw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(mergeFile, <span class="hljs-string">&quot;rw&quot;</span>);<br>        rw.seek(<span class="hljs-number">0</span>);<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        List&lt;File&gt; chunkList = Arrays.asList(chunkFolder.listFiles());<br>        chunkList.sort(Comparator.comparing(o -&gt; Integer.parseInt(o.getName()))); <span class="hljs-comment">//从小到大排序</span><br><br>        <span class="hljs-keyword">for</span> (File chunkFile : chunkList) &#123;<br>            <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(chunkFile, <span class="hljs-string">&quot;r&quot;</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span> ((len = r.read(buffer)) != -<span class="hljs-number">1</span>) &#123;<br>                rw.write(buffer, <span class="hljs-number">0</span>, len);<br>            &#125;<br>            r.close();<br>        &#125;<br>        rw.close();<br>        <span class="hljs-comment">//校验文件</span><br>        <span class="hljs-keyword">try</span> (<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(sourceFile);<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">mergeFileStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(mergeFile);<br>        ) &#123;<br>            <span class="hljs-comment">//取出原始文件的md5</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">originalMd5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(fileInputStream);<br>            <span class="hljs-comment">//取出合并文件的md5进行比较</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">mergeFileMd5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(mergeFileStream);<br>            <span class="hljs-keyword">if</span> (originalMd5.equals(mergeFileMd5)) &#123;<br>                System.out.println(<span class="hljs-string">&quot;合并文件成功&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;合并文件失败&quot;</span>);<br>            &#125;<br><br>        &#125;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="测试minio上传-合并和清理"><a href="#测试minio上传-合并和清理" class="headerlink" title="测试minio上传,合并和清理"></a>测试<code>minio</code>上传,合并和清理</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media;<br><br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfo;<br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfoUtil;<br><span class="hljs-keyword">import</span> io.minio.*;<br><span class="hljs-keyword">import</span> io.minio.messages.DeleteError;<br><span class="hljs-keyword">import</span> io.minio.messages.DeleteObject;<br><span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.FilterInputStream;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><span class="hljs-keyword">import</span> java.util.stream.Stream;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/16 20:44</span><br><span class="hljs-comment"> * 测试 MinIO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinioTest</span> &#123;<br><br>    <span class="hljs-comment">// 准备minio客户端</span><br>    <span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span> MinioClient.builder()<br>            .endpoint(<span class="hljs-string">&quot;http://192.168.101.65:9000&quot;</span>)<br>            .credentials(<span class="hljs-string">&quot;minioadmin&quot;</span>, <span class="hljs-string">&quot;minioadmin&quot;</span>)<br>            .build();<br><br><br>    <span class="hljs-comment">// 上传文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">upload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">// 通过扩展名取出mimeType</span><br>        <span class="hljs-type">ContentInfo</span> <span class="hljs-variable">extensionMatch</span> <span class="hljs-operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="hljs-string">&quot;.mp4&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE; <span class="hljs-comment">// 通用mimeType, 字节流</span><br>        <span class="hljs-keyword">if</span> (extensionMatch != <span class="hljs-literal">null</span>) &#123;<br>            mimeType = extensionMatch.getMimeType();<br>        &#125;<br><br>        <span class="hljs-comment">// 上传文件的参数信息</span><br>        <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>) <span class="hljs-comment">//桶</span><br>                .filename(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>) <span class="hljs-comment">//本地文件路径</span><br>                <span class="hljs-comment">// .object(&quot;lqx.mp4&quot;) //对象名</span><br>                .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                .contentType(mimeType)<br>                .build();<br><br>        <span class="hljs-comment">// 上传文件</span><br>        minioClient.uploadObject(uploadObjectArgs);<br><br>    &#125;<br><br>    <span class="hljs-comment">// 删除文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">RemoveObjectArgs</span> <span class="hljs-variable">removeObjectArgs</span> <span class="hljs-operator">=</span> RemoveObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>)<br>                .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                .build();<br>        minioClient.removeObject(removeObjectArgs);<br>    &#125;<br><br><br>    <span class="hljs-comment">// 查询文件: 从minio下载文件</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">get</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">GetObjectArgs</span> <span class="hljs-variable">getObjectArgs</span> <span class="hljs-operator">=</span> GetObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>)<br>                .object(<span class="hljs-string">&quot;/test/lqx.mp4&quot;</span>)<br>                .build();<br>        <span class="hljs-comment">// GetObjectResponse extends FilterInputStream</span><br>        <span class="hljs-comment">// 查询远程服务获取一个流对象</span><br>        <span class="hljs-type">FilterInputStream</span> <span class="hljs-variable">filterInputStream</span> <span class="hljs-operator">=</span> minioClient.getObject(getObjectArgs);<br>        <span class="hljs-comment">// 指定输出流</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\output\\lqx.mp4&quot;</span>);<br>        <span class="hljs-comment">// 拷贝流</span><br>        IOUtils.copy(filterInputStream, outputStream);<br><br><br>        <span class="hljs-comment">// 校验文件完整性, 对文件的内容进行md5校验(上传和下载过程出现网络丢包, 所以需要进行md5校验)</span><br>        <span class="hljs-comment">// 这里source_md5不能用filterInputStream, 网络文件的md5不稳定, 要用原始文件(传之前硬盘文件)的md5</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">source_md5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\lqx.mp4&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">local_md5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\output\\lqx.mp4&quot;</span>));<br>        <span class="hljs-keyword">if</span> (source_md5.equals(local_md5)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;下载成功&quot;</span>);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">// 分块文件上传到minio</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">chunkUpload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; i++) &#123;<br>            <span class="hljs-comment">// 上传文件的参数信息</span><br>            <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>                    .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>) <span class="hljs-comment">//桶</span><br>                    .filename(<span class="hljs-string">&quot;C:\\Users\\fu\\Videos\\chunk\\&quot;</span> + i) <span class="hljs-comment">//本地文件路径</span><br>                    .object(<span class="hljs-string">&quot;chunk/&quot;</span> + i)<br>                    .build();<br><br>            <span class="hljs-comment">// 上传文件</span><br>            minioClient.uploadObject(uploadObjectArgs);<br>            System.out.println(<span class="hljs-string">&quot;上传分块&quot;</span> + i + <span class="hljs-string">&quot;成功&quot;</span>);<br>        &#125;<br><br><br>    &#125;<br><br>    <span class="hljs-comment">// 调用minio接口合并分块</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">merge</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">/*List&lt;ComposeSource&gt; sources = new ArrayList&lt;&gt;();</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        for (int i = 0; i &lt; 6; i++) &#123;</span><br><span class="hljs-comment">            ComposeSource composeSource = ComposeSource.builder()</span><br><span class="hljs-comment">                    .bucket(&quot;testbucket&quot;)</span><br><span class="hljs-comment">                    .object(&quot;chunk/&quot; + i)</span><br><span class="hljs-comment">                    .build();</span><br><span class="hljs-comment">            sources.add(composeSource);</span><br><span class="hljs-comment">        &#125;*/</span><br><br>        List&lt;ComposeSource&gt; sources = Stream.iterate(<span class="hljs-number">0</span>, i -&gt; ++i).limit(<span class="hljs-number">6</span>)<br>                .map(i -&gt; ComposeSource.builder().bucket(<span class="hljs-string">&quot;testbucket&quot;</span>).object(<span class="hljs-string">&quot;chunk/&quot;</span> + i).build())<br>                .collect(Collectors.toList());<br><br><br>        <span class="hljs-type">ComposeObjectArgs</span> <span class="hljs-variable">composeObjectArgs</span> <span class="hljs-operator">=</span> ComposeObjectArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>)<br>                .sources(sources)<br>                .object(<span class="hljs-string">&quot;mergeLqx.mp4&quot;</span>)<br>                .build();<br>        minioClient.composeObject(composeObjectArgs);<br>        System.out.println(<span class="hljs-string">&quot;合并成功&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-comment">// 清理分块</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeChunk</span><span class="hljs-params">()</span> &#123;<br><br>        List&lt;DeleteObject&gt; deleteObjects = Stream.iterate(<span class="hljs-number">0</span>, i -&gt; ++i).limit(<span class="hljs-number">6</span>)<br>                .map(i -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteObject</span>(<span class="hljs-string">&quot;chunk/&quot;</span> + i)).collect(Collectors.toList());<br><br><br>        <span class="hljs-type">RemoveObjectsArgs</span> <span class="hljs-variable">removeObjectsArgs</span> <span class="hljs-operator">=</span> RemoveObjectsArgs.builder()<br>                .bucket(<span class="hljs-string">&quot;testbucket&quot;</span>).objects(deleteObjects).build();<br>        minioClient.removeObjects(removeObjectsArgs);<br>        Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);<br>        results.forEach(r-&gt;&#123;<br>            <span class="hljs-type">DeleteError</span> <span class="hljs-variable">deleteError</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                deleteError = r.get();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;);<br><br>    &#125;<br><br><br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="上传视频流程"><a href="#上传视频流程" class="headerlink" title="上传视频流程"></a>上传视频流程</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217173010850.png" srcset="/img/loading.gif" lazyload alt="image-20231217173010850"></p>
<ol>
<li>前端上传文件前, 请求媒资接口层检查文件是否存在<ol>
<li>若存在,则不再上传</li>
<li>若不存在, 则开始上传, 首先对视频文件进行分块</li>
</ol>
</li>
<li>前端分块进行上传, 上传前首先检查分块是否已经存在<ol>
<li>若分块已存在, 则不再上传</li>
<li>若分块不存在, 则开始上传分块</li>
</ol>
</li>
<li>前端请求媒资管理接口层, 请求上传分块</li>
<li>接口层请求服务层上传分块</li>
<li>服务端将分块信息上传到minio</li>
<li>前端将分块上传完毕, 请求接口层合并分块</li>
<li>接口层请求服务层合并分块</li>
<li>服务层根据文件信息找到minio中的分块文件, 下载到本地临时目录, 将所有分块下载完毕后开始合并</li>
<li>合并完成后, 将合并后的文件上传到minio</li>
</ol>
<h4 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h4><p>操作成功返回</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>操作失败返回</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.dto.UploadFileParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 上传视频</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/17 18:04</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = &quot;大文件上传接口&quot;, tags = &quot;大文件上传接口&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigFilesController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileService mediaFileService;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;文件上传前检查文件&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/upload/checkfile&quot;)</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkfile</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5)</span>&#123;<br>        <span class="hljs-keyword">return</span> mediaFileService.checkfile(fileMd5);<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;文件上传前检查分块&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkchunk</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span>String fileMd5,</span><br><span class="hljs-params">                                            <span class="hljs-meta">@RequestParam(&quot;chunk&quot;)</span><span class="hljs-type">int</span> chunk)</span>&#123;<br>        <span class="hljs-keyword">return</span> mediaFileService.checkchunk(fileMd5, chunk);<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;上传分块文件&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span><br>    <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">uploadchunk</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span><br><span class="hljs-params">                                             <span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span>String fileMd5,</span><br><span class="hljs-params">                                             <span class="hljs-meta">@RequestParam(&quot;chunk&quot;)</span><span class="hljs-type">int</span> chunk)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">tempFile</span> <span class="hljs-operator">=</span> File.createTempFile(<span class="hljs-string">&quot;minio&quot;</span>, <span class="hljs-string">&quot;.temp&quot;</span>);<span class="hljs-comment">//创建临时文件</span><br>        file.transferTo(tempFile);<span class="hljs-comment">//文件转换</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">localFilePath</span> <span class="hljs-operator">=</span> tempFile.getAbsolutePath();<span class="hljs-comment">//获取绝对路径 此时文件在tomcat</span><br>        <span class="hljs-keyword">return</span> mediaFileService.uploadchunk(fileMd5, chunk, localFilePath);<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;合并分块文件&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span><br>    <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">mergechunks</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;fileMd5&quot;)</span>String fileMd5,</span><br><span class="hljs-params">                                             <span class="hljs-meta">@RequestParam(&quot;fileName&quot;)</span>String fileName,</span><br><span class="hljs-params">                                             <span class="hljs-meta">@RequestParam(&quot;chunkTotal&quot;)</span><span class="hljs-type">int</span> chunkTotal)</span>&#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">companyId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1232141425L</span>;<br>        <span class="hljs-type">UploadFileParamsDto</span> <span class="hljs-variable">uploadFileParamsDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadFileParamsDto</span>();<br>        uploadFileParamsDto.setFilename(fileName);<br>        uploadFileParamsDto.setTags(<span class="hljs-string">&quot;视频文件&quot;</span>);<br>        uploadFileParamsDto.setFileType(<span class="hljs-string">&quot;001002&quot;</span>);<br>        <span class="hljs-keyword">return</span> mediaFileService.mergechunk(companyId, fileMd5, chunkTotal, uploadFileParamsDto);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;<br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfo;<br><span class="hljs-keyword">import</span> com.j256.simplemagic.ContentInfoUtil;<br><span class="hljs-keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PageResult;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.PagesParams;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.media.mapper.MediaFilesMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.media.mapper.MediaProcessHistoryMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.media.mapper.MediaProcessMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.dto.QueryMediaParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.dto.UploadFileParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.dto.UploadFileResultDto;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaFiles;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaProcess;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaProcessHistory;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileService;<br><span class="hljs-keyword">import</span> io.minio.*;<br><span class="hljs-keyword">import</span> io.minio.messages.DeleteError;<br><span class="hljs-keyword">import</span> io.minio.messages.DeleteObject;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><span class="hljs-keyword">import</span> java.util.stream.Stream;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/10 8:58</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaFileServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MediaFileService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaFilesMapper mediaFilesMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaProcessMapper mediaProcessMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaProcessHistoryMapper mediaProcessHistoryMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MinioClient minioClient;<br><br>    <span class="hljs-comment">// 注入MediaFileService代理对象</span><br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileService currentProxy;<br><br><br>    <span class="hljs-comment">// 从配置文件获取bucket</span><br>    <span class="hljs-comment">// 存储普通文件</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;minio.bucket.files&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String bucket_mediafiles;<br>    <span class="hljs-comment">// 存储视频</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;minio.bucket.videofiles&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String bucket_video;<br><br>    <span class="hljs-comment">// 查询媒体信息</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PageResult&lt;MediaFiles&gt; <span class="hljs-title function_">queryMediaFiels</span><span class="hljs-params">(Long companyId, PagesParams pageParams,</span><br><span class="hljs-params">                                                  QueryMediaParamsDto queryMediaParamsDto)</span> &#123;<br><br>        <span class="hljs-comment">//构建查询条件对象</span><br>        LambdaQueryWrapper&lt;MediaFiles&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        queryWrapper.like(!StringUtils.isEmpty(queryMediaParamsDto.getFilename()), MediaFiles::getFilename, queryMediaParamsDto.getFilename());<br>        queryWrapper.eq(!StringUtils.isEmpty(queryMediaParamsDto.getFileType()), MediaFiles::getFileType, queryMediaParamsDto.getFileType());<br>        <span class="hljs-comment">//分页对象</span><br>        Page&lt;MediaFiles&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());<br>        <span class="hljs-comment">// 查询数据内容获得结果</span><br>        Page&lt;MediaFiles&gt; pageResult = mediaFilesMapper.selectPage(page, queryWrapper);<br>        <span class="hljs-comment">// 获取数据列表</span><br>        List&lt;MediaFiles&gt; list = pageResult.getRecords();<br>        <span class="hljs-comment">// 获取数据总数</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> pageResult.getTotal();<br>        <span class="hljs-comment">// 构建结果集</span><br>        PageResult&lt;MediaFiles&gt; mediaListResult =<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());<br>        <span class="hljs-keyword">return</span> mediaListResult;<br><br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自动生成目录</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> year  是否包含年</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> month 是否包含月</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> day   是否包含天</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> stringBuffer</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getFilder</span><span class="hljs-params">(<span class="hljs-type">boolean</span> year, <span class="hljs-type">boolean</span> month, <span class="hljs-type">boolean</span> day)</span> &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">stringBuffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">dateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dateString</span> <span class="hljs-operator">=</span> dateFormat.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        String[] split = dateString.split(<span class="hljs-string">&quot;-&quot;</span>);<br>        <span class="hljs-keyword">if</span> (year) &#123;<br>            stringBuffer.append(split[<span class="hljs-number">0</span>]).append(<span class="hljs-string">&quot;/&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (month) &#123;<br>            stringBuffer.append(split[<span class="hljs-number">1</span>]).append(<span class="hljs-string">&quot;/&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (day) &#123;<br>            stringBuffer.append(split[<span class="hljs-number">2</span>]).append(<span class="hljs-string">&quot;/&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> stringBuffer.toString();<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">getPlayUrlByMediaId</span><span class="hljs-params">(String mediaId)</span> &#123;<br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(mediaId);<br>        <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span> || StringUtils.isEmpty(mediaFiles.getUrl())) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;视频没有转码处理&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> mediaFiles;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startTask</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> mediaProcessMapper.startTask(id);<br>        <span class="hljs-keyword">return</span> result &lt;= <span class="hljs-number">0</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 保存进程完成状态</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveProcessFinishStatus</span><span class="hljs-params">(Long taskId, String status, String fileId, String url, String errorMsg)</span> &#123;<br>        <span class="hljs-comment">// 查出任务, 如果不存在则直接返回</span><br>        <span class="hljs-type">MediaProcess</span> <span class="hljs-variable">mediaProcess</span> <span class="hljs-operator">=</span> mediaProcessMapper.selectById(taskId);<br>        <span class="hljs-keyword">if</span> (mediaProcess == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 处理失败, 更新任务处理结果</span><br>        LambdaQueryWrapper&lt;MediaProcess&gt; queryWrapperById = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;MediaProcess&gt;()<br>                .eq(MediaProcess::getId, taskId);<br>        <span class="hljs-comment">// 处理失败</span><br>        <span class="hljs-keyword">if</span> (status.equals(<span class="hljs-string">&quot;3&quot;</span>)) &#123;<br>            <span class="hljs-type">MediaProcess</span> <span class="hljs-variable">mediaProcess_u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaProcess</span>();<br>            mediaProcess_u.setStatus(<span class="hljs-string">&quot;3&quot;</span>);<br>            mediaProcess_u.setErrormsg(errorMsg);<br>            mediaProcess_u.setFailCount(mediaProcess.getFailCount() + <span class="hljs-number">1</span>);<br>            mediaProcessMapper.update(mediaProcess_u, queryWrapperById);<br>            log.debug(<span class="hljs-string">&quot;更新任务处理状态为失败, 任务信息:&#123;&#125;&quot;</span>, mediaProcess_u);<br>        &#125;<br>        <span class="hljs-comment">// 任务处理成功</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(fileId);<br>        <span class="hljs-keyword">if</span> (mediaFiles != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 更新媒资文件里的url</span><br>            mediaFiles.setUrl(url);<br>            mediaFilesMapper.updateById(mediaFiles);<br>        &#125;<br>        <span class="hljs-comment">// 处理成功, 更新url和状态</span><br>        mediaProcess.setUrl(url);<br>        mediaProcess.setStatus(<span class="hljs-string">&quot;2&quot;</span>);<br>        mediaProcess.setFinishDate(LocalDateTime.now());<br>        mediaProcessMapper.updateById(mediaProcess);<br><br>        <span class="hljs-comment">// 添加历史记录</span><br>        <span class="hljs-type">MediaProcessHistory</span> <span class="hljs-variable">mediaProcessHistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaProcessHistory</span>();<br>        BeanUtils.copyProperties(mediaProcess, mediaProcessHistory);<br>        mediaProcessHistoryMapper.insert(mediaProcessHistory);<br>        <span class="hljs-comment">// 删除mediaProcess</span><br>        mediaProcessMapper.deleteById(mediaProcess.getId());<br><br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UploadFileResultDto <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span> &#123;<br>        <span class="hljs-comment">// 将文件上传minio</span><br>        <span class="hljs-comment">// 根据文件名得到扩展名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> uploadFileParamsDto.getFilename();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> getMimeType(extension);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> getMd5ByFilename(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(localFilePath));<br>        <span class="hljs-comment">// 约定objectName怎么存 -&gt; /年/月/日/md5.后缀</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> getDefaultFolderPath() + md5 + extension;<br>        <span class="hljs-comment">// 将文件上传到minio</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isUploadMinIO</span> <span class="hljs-operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_mediafiles, objectName);<br>        <span class="hljs-keyword">if</span> (!isUploadMinIO) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;上传文件到MinIO失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 将文件信息保存到DB</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> currentProxy.addMediaFilesToDB(companyId, uploadFileParamsDto, md5, bucket_mediafiles, objectName);<br>        <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;文件上传后保存信息失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 准备返回的对象</span><br>        <span class="hljs-type">UploadFileResultDto</span> <span class="hljs-variable">uploadFileResultDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadFileResultDto</span>();<br>        BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);<br>        <span class="hljs-keyword">return</span> uploadFileResultDto;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将文件信息保存到DB</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> companyId           机构id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> uploadFileParamsDto 上传文件的信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> md5                 md5</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bucket              桶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> objectName          对象名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">addMediaFilesToDB</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String md5, String bucket, String objectName)</span> &#123;<br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(md5);<br>        <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>            mediaFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFiles</span>();<br>            BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);<br>            <span class="hljs-comment">// 文件id</span><br>            mediaFiles.setId(md5);<br>            <span class="hljs-comment">// 机构id</span><br>            mediaFiles.setCompanyId(companyId);<br>            <span class="hljs-comment">// 桶</span><br>            mediaFiles.setBucket(bucket);<br>            <span class="hljs-comment">// 对象名称</span><br>            mediaFiles.setFilePath(objectName);<br>            <span class="hljs-comment">// file_id</span><br>            mediaFiles.setFileId(md5);<br>            <span class="hljs-comment">// url 完整访问地址</span><br>            mediaFiles.setUrl(<span class="hljs-string">&quot;/&quot;</span> + bucket + <span class="hljs-string">&quot;/&quot;</span> + objectName);<br>            <span class="hljs-comment">// 上传时间</span><br>            mediaFiles.setCreateDate(LocalDateTime.now());<br>            <span class="hljs-comment">// 状态</span><br>            mediaFiles.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>            <span class="hljs-comment">// 审核状态</span><br>            mediaFiles.setAuditStatus(<span class="hljs-string">&quot;002003&quot;</span>);<br>            <span class="hljs-comment">// 插入数据库</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> mediaFilesMapper.insert(mediaFiles);<br>            <span class="hljs-keyword">if</span> (insert &lt;= <span class="hljs-number">0</span>) &#123;<br>                log.debug(<span class="hljs-string">&quot;向数据库保存文件信息失败, bucket:&#123;&#125;, objectName: &#123;&#125;&quot;</span>, bucket, objectName);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> mediaFiles;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取文件默认存储目录路径     年/月/日/   2023-12-19 -&gt; 2023/12/19/</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getDefaultFolderPath</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">folder</span> <span class="hljs-operator">=</span> sdf.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>) + <span class="hljs-string">&quot;/&quot;</span>;<br>        <span class="hljs-keyword">return</span> folder;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取文件md5</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMd5ByFilename</span><span class="hljs-params">(File file)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileMd5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(fileInputStream);<br>            <span class="hljs-keyword">return</span> fileMd5;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">// 通过扩展名取出mimeType      .mp4 -&gt; video/mp4</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMimeType</span><span class="hljs-params">(String extension)</span> &#123;<br>        <span class="hljs-keyword">if</span> (extension == <span class="hljs-literal">null</span>) &#123;<br>            extension = <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        <span class="hljs-type">ContentInfo</span> <span class="hljs-variable">extensionMatch</span> <span class="hljs-operator">=</span> ContentInfoUtil.findExtensionMatch(extension);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE; <span class="hljs-comment">// 通用mimeType, 字节流</span><br>        <span class="hljs-keyword">if</span> (extensionMatch != <span class="hljs-literal">null</span>) &#123;<br>            mimeType = extensionMatch.getMimeType();<br>        &#125;<br>        <span class="hljs-keyword">return</span> mimeType;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将文件上传到minio</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> localFilePath 本地文件路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mimeType      媒体类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bucket        桶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> objectName    对象名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addMediaFilesToMinIO</span><span class="hljs-params">(String localFilePath, String mimeType, String bucket, String objectName)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 准备上传文件的参数信息</span><br>            <span class="hljs-type">UploadObjectArgs</span> <span class="hljs-variable">uploadObjectArgs</span> <span class="hljs-operator">=</span> UploadObjectArgs.builder()<br>                    .bucket(bucket) <span class="hljs-comment">//桶</span><br>                    .filename(localFilePath) <span class="hljs-comment">//本地文件路径</span><br>                    .object(objectName) <span class="hljs-comment">// 对象名</span><br>                    .contentType(mimeType)<br>                    .build();<br>            minioClient.uploadObject(uploadObjectArgs); <span class="hljs-comment">// 上传</span><br>            log.debug(<span class="hljs-string">&quot;上传文件到minio成功, bucket:&#123;&#125;, objectName:&#123;&#125;&quot;</span>, bucket, objectName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            log.error(<span class="hljs-string">&quot;上传文件到minio出错, bucket:&#123;&#125;, objectName:&#123;&#125;, 错误信息:&#123;&#125;&quot;</span>, bucket, objectName, e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkfile</span><span class="hljs-params">(String fileMd5)</span> &#123;<br>        <span class="hljs-comment">// 先查询数据库</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(fileMd5);<br>        <span class="hljs-keyword">if</span> (mediaFiles != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 如果数据库存在则查询minio</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">bucket</span> <span class="hljs-operator">=</span> mediaFiles.getBucket();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> mediaFiles.getFilePath();<br>            <span class="hljs-type">GetObjectArgs</span> <span class="hljs-variable">getObjectArgs</span> <span class="hljs-operator">=</span> GetObjectArgs.builder()<br>                    .bucket(bucket)<br>                    .object(filePath)<br>                    .build();<br>            <span class="hljs-comment">// 查询远程服务获取一个流对象</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">FilterInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> minioClient.getObject(getObjectArgs);<br>                <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">// 文件在DB和minio都有，不用干活了</span><br>                    <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;Boolean&gt; <span class="hljs-title function_">checkchunk</span><span class="hljs-params">(String fileMd5, <span class="hljs-type">int</span> chunkIndex)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">chunkFileFolderPath</span> <span class="hljs-operator">=</span> getChunkFileFolderPath(fileMd5);<br><br>        <span class="hljs-type">GetObjectArgs</span> <span class="hljs-variable">getObjectArgs</span> <span class="hljs-operator">=</span> GetObjectArgs.builder()<br>                .bucket(bucket_video)<br>                .object(chunkFileFolderPath + chunkIndex)<br>                .build();<br>        <span class="hljs-comment">// 查询远程服务获取一个流对象</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FilterInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> minioClient.getObject(getObjectArgs);<br>            <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 分块在minio都有，不用干活了</span><br>                <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>        &#125;<br>        <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 得到分块文件目录</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getFilePathByMd5</span><span class="hljs-params">(String fileMd5,String fileExt)</span> &#123;<br>        <span class="hljs-keyword">return</span> fileMd5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5.substring(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + fileExt;<br>    &#125;<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getChunkFileFolderPath</span><span class="hljs-params">(String fileMd5)</span> &#123;<br>        <span class="hljs-keyword">return</span> fileMd5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5.substring(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + <span class="hljs-string">&quot;/&quot;</span> + <span class="hljs-string">&quot;chunk&quot;</span> + <span class="hljs-string">&quot;/&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">uploadchunk</span><span class="hljs-params">(String fileMd5, <span class="hljs-type">int</span> chunk, String localChunkFilePath)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">chunkFilePath</span> <span class="hljs-operator">=</span> getChunkFileFolderPath(fileMd5) + chunk;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> getMimeType(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// 将分块上传到minio</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isUpload</span> <span class="hljs-operator">=</span> addMediaFilesToMinIO(localChunkFilePath, mimeType, bucket_video, chunkFilePath);<br>        <span class="hljs-keyword">if</span> (!isUpload) &#123;<br>            <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;上传文件失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RestResponse <span class="hljs-title function_">mergechunk</span><span class="hljs-params">(Long companyId, String fileMd5, <span class="hljs-type">int</span> chunkTotal, UploadFileParamsDto uploadFileParamsDto)</span> &#123;<br>        <span class="hljs-comment">// 合并-&gt;校验-&gt;入库-&gt;清理</span><br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">chunkFileFolderPath</span> <span class="hljs-operator">=</span> getChunkFileFolderPath(fileMd5);<br>        <span class="hljs-comment">//找到所有的分块文件调用minio的sdk进行文件合并</span><br>        List&lt;ComposeSource&gt; sources = Stream.iterate(<span class="hljs-number">0</span>, i -&gt; ++i).limit(chunkTotal)<br>                .map(i -&gt; ComposeSource.builder().bucket(bucket_video).object(chunkFileFolderPath + i).build())<br>                .collect(Collectors.toList());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> uploadFileParamsDto.getFilename();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileExt</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> getFilePathByMd5(fileMd5, fileExt);<br>        <span class="hljs-type">ComposeObjectArgs</span> <span class="hljs-variable">composeObjectArgs</span> <span class="hljs-operator">=</span> ComposeObjectArgs.builder()<br>                .bucket(bucket_video)<br>                .sources(sources)<br>                .object(objectName)<span class="hljs-comment">//合并后文件objectName</span><br>                .build();<br>        <span class="hljs-keyword">try</span> &#123;<br>            minioClient.composeObject(composeObjectArgs);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            log.error(<span class="hljs-string">&quot;合并文件出错,bucket:&#123;&#125;,objectName:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>,bucket_video,objectName,e.getMessage());<br>            <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;合并文件异常&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//校验合并的文件和源文件是否一致，视频上传才成功</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> downloadFileFromMinIO(bucket_video, objectName);<br>        <span class="hljs-comment">//文件大小</span><br>        uploadFileParamsDto.setFileSize(file.length());<br><br><br><br>        <span class="hljs-comment">//计算合并后文件md5</span><br>        <span class="hljs-keyword">try</span>(<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">mergeFile_md5</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(fileInputStream);<br>            <span class="hljs-comment">//比较原始md5和合并后文件md5</span><br>            <span class="hljs-keyword">if</span> (!fileMd5.equals(mergeFile_md5))&#123;<br>                log.error(<span class="hljs-string">&quot;校验合并文件的md5值不一致,原始md5：&#123;&#125;,合并md5:&#123;&#125;&quot;</span>,fileMd5, mergeFile_md5);<br>                <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;文件校验失败&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;文件校验失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//将文件信息入库</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> currentProxy.addMediaFilesToDB(companyId, uploadFileParamsDto, fileMd5, bucket_video, objectName);<br>        <span class="hljs-keyword">if</span>(mediaFiles==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-literal">false</span>, <span class="hljs-string">&quot;文件入库失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//清理分块文件</span><br>        clearChunkFiles(chunkFileFolderPath, chunkTotal);<br><br>        <span class="hljs-keyword">return</span> RestResponse.success(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//从minio下载文件</span><br>    <span class="hljs-keyword">public</span> File <span class="hljs-title function_">downloadFileFromMinIO</span><span class="hljs-params">(String bucket, String objectName)</span>&#123;<br>        <span class="hljs-comment">// 临时文件</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">minioFile</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> minioClient.getObject(GetObjectArgs.builder().bucket(bucket).object(objectName).build());<br>            <span class="hljs-comment">// 创建临时文件</span><br>            minioFile = File.createTempFile(<span class="hljs-string">&quot;minio&quot;</span>, <span class="hljs-string">&quot;.merge&quot;</span>);<br>            outputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(minioFile);<br>            IOUtils.copy(stream, outputStream);<br>            <span class="hljs-keyword">return</span> minioFile;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (outputStream!=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    outputStream.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//清理分块文件</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearChunkFiles</span><span class="hljs-params">(String chunkFileFolderPath, <span class="hljs-type">int</span> chunkTotal)</span>&#123;<br>        List&lt;DeleteObject&gt; deleteObjects = Stream.iterate(<span class="hljs-number">0</span>, i -&gt; ++i).limit(chunkTotal)<br>                .map(i -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteObject</span>(chunkFileFolderPath+i)).collect(Collectors.toList());<br>        <span class="hljs-type">RemoveObjectsArgs</span> <span class="hljs-variable">removeObjectsArgs</span> <span class="hljs-operator">=</span> RemoveObjectsArgs.builder().bucket(bucket_video).objects(deleteObjects).build();<br>        Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);<br>        <span class="hljs-comment">// 还没删, 需要遍历一下</span><br>        <span class="hljs-keyword">for</span> (Result&lt;DeleteError&gt; result : results) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">DeleteError</span> <span class="hljs-variable">deleteError</span> <span class="hljs-operator">=</span> result.get();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>视频上传大小限制, 默认1MB</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">multipart:</span><br>      <span class="hljs-attr">max-file-size:</span> <span class="hljs-string">50MB</span><br>      <span class="hljs-attr">max-request-size:</span> <span class="hljs-string">50MB</span><br></code></pre></td></tr></table></figure>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220155342270.png" srcset="/img/loading.gif" lazyload alt="image-20231220155342270"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231217215739463.png" srcset="/img/loading.gif" lazyload alt="image-20231217215739463"></p>
<h3 id="文件预览"><a href="#文件预览" class="headerlink" title="文件预览"></a>文件预览</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(value = &quot;预览文件&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/preview/&#123;mediaId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> RestResponse&lt;String&gt; <span class="hljs-title function_">getPlayUrlByMediaId</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String mediaId)</span> &#123;<br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFileService.getPlayUrlByMediaId(mediaId);<br>    <span class="hljs-keyword">return</span> RestResponse.success(mediaFiles.getUrl());<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">getPlayUrlByMediaId</span><span class="hljs-params">(String mediaId)</span> &#123;<br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(mediaId);<br>    <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span> || StringUtils.isEmpty(mediaFiles.getUrl()))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;视频没有转码处理&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> mediaFiles;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>面试</strong></p>
<ol>
<li><p>什么情况Spring事务失效?</p>
<ol>
<li>方法中捕获异常没有抛出</li>
<li>非事务方法调用事务方法</li>
<li>事务内部调用事务方法</li>
<li>@Transactional 标记的方法不是public</li>
<li>抛出的异常与rollbackFor指定的异常不匹配, 默认rollbackFor指定的异常为RuntimeException</li>
<li>数据库表不支持事务, 比如MySQL的MyISAM</li>
<li>Spring的传播行为导致事务失效, 比如: PROPAGATION_NEVER PROPAGTION_NOT_SUPPORTED</li>
</ol>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220190016041.png" srcset="/img/loading.gif" lazyload alt="image-20231220190016041"></p>
<ol start="2">
<li><p>断点续传是怎么做的?</p>
<p>我们基于分块上传的模式实现断点续传需求,当文件上传一部分断网后已经上传过的不再上传</p>
<ol>
<li><p>前端对文件分块</p>
</li>
<li><p>前端使用多线程一块块上传,上传前给服务端发一个消息校验该分块是否上传,如果已上传则不再上传</p>
</li>
<li><p>等所有分块上传完毕,服务端合并所有分块,校验文件的完整性</p>
<p>因为分块全部上传到了服务器,服务器将所有分块按顺序合并,就是写每个分块文件内容按顺序依次写入一个文件中， 使用字节流去读写文件</p>
</li>
<li><p>前端给服务传入一个md5值,服务端合并文件后计算合并后文件的md5是否和前端传的一样, 如果一样则说文件完整,如果不一样则由于网络丢包导致文件不完整,这是上传失败需要重新上传</p>
</li>
</ol>
</li>
<li><p>分块文件清理问题?</p>
<p>上传一个文件进行分块上传,上传一半不传了,之前上传到minio分块文件要清理吗?怎么清理?</p>
<ol>
<li>在数据库有一张文件表记录minio中存储的文件信息</li>
<li>文件开始上传时会写入文件表,状态为上传中,上传完成会更新状态为上传完成</li>
<li>当一个文件传了一半不再上传了说明该文件没有上传完成,会有定时任务去查询文件表的记录,如果文件未上传完成则删除minio中没有上传成功的文件目录</li>
</ol>
</li>
</ol>
</li>
</ol>
</blockquote>
<h3 id="XXL-JOB"><a href="#XXL-JOB" class="headerlink" title="XXL-JOB"></a>XXL-JOB</h3><h4 id="分布式任务处理"><a href="#分布式任务处理" class="headerlink" title="分布式任务处理"></a>分布式任务处理</h4><blockquote>
<p><code>分布式任务调度</code></p>
<p>视频上传成功需要对视频格式处理, 如果用java程序对视频处理有一个关键的需求是视频比较多时, 如何高效的处理. </p>
<p>如何高效处理任务? </p>
<ol>
<li>多线程: 充分利用单机的资源</li>
<li>分布式 + 多线程: 充分利用多台计算机, 每台计算机使用多线程处理</li>
</ol>
<p>方案二可扩展性更强, 是一种常见的分布式任务调度的处理方案</p>
<p>任务调度: 对任务的调度, 系统为了完成特定业务, 基于给定的<code>时间点</code>, 给定<code>时间间隔</code>或给定<code>执行次数</code> <code>自动执行任务</code></p>
</blockquote>
<p>多线程实现任务调度</p>
<p>开启一个线程,每sleep一段时间,  执行任务调度</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-comment">// 任务执行时间间隔</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">timeInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;<br>    <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> something</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(timeInterval);<br>                &#125; <span class="hljs-keyword">catch</span>(InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(runnable);<br>    thread.start();<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>JDK提供相关支持, Timer ScheduledExecutor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">Timer</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timer</span>();<br>    timer.schedule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> something</span><br>        &#125;<br>    &#125;, <span class="hljs-number">1000</span>, <span class="hljs-number">2000</span>); <span class="hljs-comment">// 1秒后开始调度，每2秒执行一次</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>Timer的优点在于简单易用，每个Timer对应一个线程，因此可以同时启动多个Timer并行执行多个任务，同一个Timer中的任务是串行执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">10</span>);<br>    service.scheduleAtFixedRate(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> something</span><br>                System.out.println(<span class="hljs-string">&quot;todo something&quot;</span>);<br>            &#125;<br>        &#125;, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, TimeUnit.SECONDS);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ScheduledExecutor，其设计思想是，每一个被调度的任务都会由线程池中的一个线程去执行，因此任务是并发执行的，相互之间不会受到干扰</p>
<p>Timer和ScheduledExecutor都仅能提供基于开始时间与重复间隔的任务调度，不能胜任更加复杂的调度需求。比如，设置每个月第一天凌晨1点执行任务、复杂调度任务的管理、任务键传递数据等等</p>
<p>Quartz</p>
<blockquote>
<p>任务调度框架, 满足复杂的调度需求</p>
<p>Job 定义需要执行的任务, Trigger 设置调度策略, Scheduler 将二者组装, 并触发任务开始执行</p>
<p>支持时间间隔调度, 按日历调度, 设置 CronTrigger 表达式(包括秒, 分, 时, 日, 月, 周, 年) 进行任务调度,</p>
<p>第三方Quartz 方式实现任务调度</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String [] agrs)</span> <span class="hljs-keyword">throws</span> SchedulerException &#123;<br>    <span class="hljs-comment">//创建一个Scheduler</span><br>    <span class="hljs-type">SchedulerFactory</span> <span class="hljs-variable">schedulerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StdSchedulerFactory</span>();<br>    <span class="hljs-type">Scheduler</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> schedulerFactory.getScheduler();<br>    <span class="hljs-comment">//创建JobDetail</span><br>    <span class="hljs-type">JobBuilder</span> <span class="hljs-variable">jobDetailBuilder</span> <span class="hljs-operator">=</span> JobBuilder.newJob(MyJob.class);<br>    jobDetailBuilder.withIdentity(<span class="hljs-string">&quot;jobName&quot;</span>,<span class="hljs-string">&quot;jobGroupName&quot;</span>);<br>    <span class="hljs-type">JobDetail</span> <span class="hljs-variable">jobDetail</span> <span class="hljs-operator">=</span> jobDetailBuilder.build();<br>    <span class="hljs-comment">//创建触发的CronTrigger 支持按日历调度</span><br>    <span class="hljs-type">CronTrigger</span> <span class="hljs-variable">trigger</span> <span class="hljs-operator">=</span> TriggerBuilder.newTrigger()<br>            .withIdentity(<span class="hljs-string">&quot;triggerName&quot;</span>, <span class="hljs-string">&quot;triggerGroupName&quot;</span>)<br>            .startNow()<br>            .withSchedule(CronScheduleBuilder.cronSchedule(<span class="hljs-string">&quot;0/2 * * * * ?&quot;</span>))<br>            .build();<br>    <span class="hljs-comment">//创建触发的SimpleTrigger 简单的间隔调度</span><br>    <span class="hljs-comment">/*SimpleTrigger trigger = TriggerBuilder.newTrigger()</span><br><span class="hljs-comment">            .withIdentity(&quot;triggerName&quot;,&quot;triggerGroupName&quot;)</span><br><span class="hljs-comment">            .startNow()</span><br><span class="hljs-comment">            .withSchedule(SimpleScheduleBuilder</span><br><span class="hljs-comment">                    .simpleSchedule()</span><br><span class="hljs-comment">                    .withIntervalInSeconds(2)</span><br><span class="hljs-comment">                    .repeatForever())</span><br><span class="hljs-comment">            .build();*/</span><br>    scheduler.scheduleJob(jobDetail,trigger);<br>    scheduler.start();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Job</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(JobExecutionContext jobExecutionContext)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;todo something&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><code>分布式任务调度</code></p>
<p>通常集成在应用中, 如优惠券服务汇总包括了定时发布优惠券调度程序; 结算服务包括定期生成报表的任务调度程序</p>
<p>由于采用分布式架构, 一个服务通常部署在多个冗余示例运行我们的业务, 在这种分布式环境运行任务调度, 称之为分布式业务调度</p>
</blockquote>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218121841727.png" srcset="/img/loading.gif" lazyload alt="image-20231218121841727"></p>
<p>分布式调度目标: </p>
<ol>
<li>并行任务调度</li>
<li>高可用</li>
<li>弹性扩容</li>
<li>任务管理与检测</li>
<li>避免任务重复执行</li>
</ol>
<h4 id="XXL-JOB-1"><a href="#XXL-JOB-1" class="headerlink" title="XXL-JOB"></a>XXL-JOB</h4><blockquote>
<p>一个轻量的分布式任务调度平台</p>
<p>官网：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
</blockquote>
<p>由<code>调度中心, 执行器, 任务</code>组成, 分布式执行的是<code>执行器</code></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218155456382.png" srcset="/img/loading.gif" lazyload alt="image-20231218155456382"></p>
<ul>
<li>调度中心</li>
</ul>
<p>管理调度信息， 按照调度配置<code>发出调度请求</code>， 自身不承担业务代码</p>
<p>主要职责是执行器管理， 任务管理，监控运维，日志管理等</p>
<ul>
<li>任务执行器</li>
</ul>
<p>负责<code>接收调度请求</code>并<code>执行任务逻辑</code></p>
<p>主要职责是注册服务, 任务执行服务(接收任务放入线程池的任务队列), 执行结果上报, 日志服务等</p>
<ul>
<li>任务</li>
</ul>
<p>负责<code>执行</code>具体的<code>业务逻辑</code></p>
<p>调度中心和执行器之间的工作流程</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218161624892.png" srcset="/img/loading.gif" lazyload alt="image-20231218161624892"></p>
<ol>
<li>任务执行器根据配置的调度中心的地址, 自动<code>注册</code>到调度中心</li>
<li>达到任务<code>触发条件</code>, 调度中心<code>下发任务</code></li>
<li>执行器基于线程池执行任务, 把执行结果放入内存<code>队列</code>, 把执行日志写入<code>日志</code>文件</li>
<li>执行器消费内存队列中的执行<code>结果</code>, 主动上报给调度中心</li>
<li>当用户在调度中心查看任务日志, 调度中心请求任务执行器, 任务执行器读取任务日志文件并返回<code>日志</code>详情</li>
</ol>
<h4 id="搭建-XXL-JOB"><a href="#搭建-XXL-JOB" class="headerlink" title="搭建 XXL-JOB"></a>搭建 XXL-JOB</h4><p>首先下载XXL-JOB</p>
<ul>
<li>GitHub：<a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></li>
<li>GitEE：<a target="_blank" rel="noopener" href="https://gitee.com/xuxueli0323/xxl-job">https://gitee.com/xuxueli0323/xxl-job</a></li>
<li>项目使用2.3.1版本： <a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job/releases/tag/2.3.1">https://github.com/xuxueli/xxl-job/releases/tag/2.3.1</a></li>
</ul>
<p>使用IDEA打开项目</p>
<ul>
<li>xxl-job-admin：调度中心</li>
<li>xxl-job-core：公共依赖</li>
<li>xxj-job-executor-samples：执行器Sample示例<ul>
<li>xxl-job-executor-sample-springboot：SpringBoot版本，通过SpringBoot管理执行器</li>
<li>xxl-job-executor-sample-frameless：无框架版本</li>
</ul>
</li>
</ul>
<h5 id="调度中心"><a href="#调度中心" class="headerlink" title="调度中心"></a>调度中心</h5><p>根据数据库脚本创建数据库，修改数据库连接信息和端口，启动xxl-job-admin</p>
<blockquote>
<p>其实虚拟机已经有<code>调度中心</code>了,  	xxl-job-* 项目只是做参考</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220215437187.png" srcset="/img/loading.gif" lazyload alt="image-20231220215437187"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218171732665.png" srcset="/img/loading.gif" lazyload alt="image-20231218171732665"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:8088/xxl-job-admin/">http://192.168.101.65:8088/xxl-job-admin/</a></p>
<p>账号和密码：admin&#x2F;123456</p>
</blockquote>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218165848288.png" srcset="/img/loading.gif" lazyload alt="image-20231218165848288"></p>
<h5 id="执行器"><a href="#执行器" class="headerlink" title="执行器"></a>执行器</h5><p>执行器负责和调度中心通信, 接收调度中心发起的任务调度请求</p>
<ol start="0">
<li>新建执行器</li>
</ol>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220215956789.png" srcset="/img/loading.gif" lazyload alt="image-20231220215956789"></p>
<ol>
<li>media service 模块依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>nacos media-service-dev.yaml   配置   xxl-job</li>
</ol>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">xxl:</span><br><span class="hljs-symbol">  job:</span><br><span class="hljs-symbol">    admin:</span> <br><span class="hljs-symbol">      addresses:</span> http:<span class="hljs-comment">//192.168.101.65:8088/xxl-job-admin</span><br><span class="hljs-symbol">    executor:</span><br><span class="hljs-symbol">      appname:</span> testHandler<br><span class="hljs-symbol">      address:</span> <br><span class="hljs-symbol">      ip:</span> <br><span class="hljs-symbol">      port:</span> <span class="hljs-number">9999</span><br><span class="hljs-symbol">      logpath:</span> <span class="hljs-keyword">/data/</span>applogs<span class="hljs-keyword">/xxl-job/</span>jobhandler<br><span class="hljs-symbol">      logretentiondays:</span> <span class="hljs-number">30</span><br><span class="hljs-symbol">    accessToken:</span> default_token<br></code></pre></td></tr></table></figure>



<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220220247185.png" srcset="/img/loading.gif" lazyload alt="image-20231220220247185"></p>
<ol start="3">
<li>配置执行器</li>
</ol>
<p>在media-service导入示例项目中的XxlJobConfig</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218172612877.png" srcset="/img/loading.gif" lazyload alt="image-20231218172612877" style="zoom:50%;" />

<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218172625994.png" srcset="/img/loading.gif" lazyload alt="image-20231218172625994" style="zoom:50%;" />

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.config;<br><br><span class="hljs-keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * xxl-job config</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> xuxueli 2017-04-28</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XxlJobConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String adminAddresses;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String accessToken;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String appname;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String ip;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String logPath;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> logRetentionDays;<br><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> XxlJobSpringExecutor <span class="hljs-title function_">xxlJobExecutor</span><span class="hljs-params">()</span> &#123;<br>        logger.info(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);<br>        <span class="hljs-type">XxlJobSpringExecutor</span> <span class="hljs-variable">xxlJobSpringExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XxlJobSpringExecutor</span>();<br>        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);<br>        xxlJobSpringExecutor.setAppname(appname);<br>        xxlJobSpringExecutor.setAddress(address);<br>        xxlJobSpringExecutor.setIp(ip);<br>        xxlJobSpringExecutor.setPort(port);<br>        xxlJobSpringExecutor.setAccessToken(accessToken);<br>        xxlJobSpringExecutor.setLogPath(logPath);<br>        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);<br><br>        <span class="hljs-keyword">return</span> xxlJobSpringExecutor;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 针对多网卡、容器内部署等情况，可借助 &quot;spring-cloud-commons&quot; 提供的 &quot;InetUtils&quot; 组件灵活定制注册IP；</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     *      1、引入依赖：</span><br><span class="hljs-comment">     *          &lt;dependency&gt;</span><br><span class="hljs-comment">     *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="hljs-comment">     *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;</span><br><span class="hljs-comment">     *             &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="hljs-comment">     *         &lt;/dependency&gt;</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     *      2、配置文件，或者容器启动变量</span><br><span class="hljs-comment">     *          spring.cloud.inetutils.preferred-networks: &#x27;xxx.xxx.xxx.&#x27;</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     *      3、获取IP</span><br><span class="hljs-comment">     *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();</span><br><span class="hljs-comment">     */</span><br><br><br><br></code></pre></td></tr></table></figure>



<p>启动media模块,可以看到执行器关联了机器地址</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220221201255.png" srcset="/img/loading.gif" lazyload alt="image-20231220221201255"></p>
<h5 id="执行任务"><a href="#执行任务" class="headerlink" title="执行任务"></a>执行任务</h5><p>参考xxljob的方法</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218173130560.png" srcset="/img/loading.gif" lazyload alt="image-20231218173130560"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.service.jobhandler;<br><br><span class="hljs-keyword">import</span> com.xxl.job.core.context.XxlJobHelper;<br><span class="hljs-keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * XxlJob开发示例（Bean模式）</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 开发步骤：</span><br><span class="hljs-comment"> *      1、任务开发：在Spring Bean实例中，开发Job方法；</span><br><span class="hljs-comment"> *      2、注解配置：为Job方法添加注解 &quot;<span class="hljs-doctag">@XxlJob</span>(value=&quot;自定义jobhandler名称&quot;, init = &quot;JobHandler初始化方法&quot;, destroy = &quot;JobHandler销毁方法&quot;)&quot;，注解value值对应的是调度中心新建任务的JobHandler属性的值。</span><br><span class="hljs-comment"> *      3、执行日志：需要通过 &quot;XxlJobHelper.log&quot; 打印执行日志；</span><br><span class="hljs-comment"> *      4、任务结果：默认任务结果为 &quot;成功&quot; 状态，不需要主动设置；如有诉求，比如设置任务结果为失败，可以通过 &quot;XxlJobHelper.handleFail/handleSuccess&quot; 自主设置任务结果；</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> xuxueli 2019-12-11 21:52:51</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleXxlJob</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(SampleXxlJob.class);<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 1、简单任务示例（Bean模式）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@XxlJob(&quot;demoJobHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demoJobHandler</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        XxlJobHelper.log(<span class="hljs-string">&quot;处理视频&quot;</span>);<br><br>        <span class="hljs-comment">// default success</span><br><br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218174301374.png" srcset="/img/loading.gif" lazyload alt="image-20231218174301374"></p>
<p>新增任务管理(我们希望5s打印一次    “处理视频”)</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220222154365.png" srcset="/img/loading.gif" lazyload alt="image-20231220222154365"></p>
<blockquote>
<p><code>标红必填部分的解释</code></p>
<p>调度类型：</p>
<p>固定速度指按固定的间隔定时调度。</p>
<p>Cron，通过Cron表达式实现更丰富的定时调度策略。</p>
<p>Cron表达式是一个字符串，通过它可以定义调度策略，格式如下：</p>
<p>{秒数} {分钟} {小时} {日期} {月份} {星期} {年份(可为空)}</p>
<p>xxl-job提供图形界面去配置：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218174617845.png" srcset="/img/loading.gif" lazyload alt="image-20231218174617845"></p>
<p>一些例子如下：</p>
<p>30 10 1 * * ? 每天1点10分30秒触发</p>
<p>0&#x2F;30 * * * * ? 每30秒触发一次</p>
<p>* 0&#x2F;10 * * * ? 每10分钟触发一次</p>
<p>运行模式有BEAN和GLUE</p>
<ul>
<li><p>bean模式较常用是在项目工程编写执行器任务代码</p>
</li>
<li><p>glue将任务代码编写在调度中心</p>
</li>
</ul>
<p>JobHandler即任务方法名，填写任务方法上边@XxlJob注解中的名称</p>
<p>路由策略: 当执行器集群部署, 调度中心向哪个执行器发任务, 这里选择第一个表示只向第一个执行器发任务, 路由策略其他选项后面的分片广播章节解释</p>
<p>高级配置其他设置后面的分片广播章节解释</p>
</blockquote>
<p>因为这里关了media工程, 日志显示失败</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218175345239.png" srcset="/img/loading.gif" lazyload alt="image-20231218175345239"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218175426198.png" srcset="/img/loading.gif" lazyload alt="image-20231218175426198"></p>
<p>启动media工程</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218180248106.png" srcset="/img/loading.gif" lazyload alt="image-20231218180248106"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218180304964.png" srcset="/img/loading.gif" lazyload alt="image-20231218180304964"></p>
<h4 id="分片广播"><a href="#分片广播" class="headerlink" title="分片广播"></a>分片广播</h4><p>如何进行分布式任务处理? 启动多个执行器组成一个集群, 去执行任务</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218202929546.png" srcset="/img/loading.gif" lazyload alt="image-20231218202929546"></p>
<p>执行器在集群部署下调度中心有哪些路由策略?</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs markdown">SQL<br>高级配置：<br><span class="hljs-bullet">    -</span> 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；<br><span class="hljs-code">        FIRST（第一个）：固定选择第一个机器；</span><br><span class="hljs-code">        LAST（最后一个）：固定选择最后一个机器；</span><br><span class="hljs-code">        ROUND（轮询）：；</span><br><span class="hljs-code">        RANDOM（随机）：随机选择在线的机器；</span><br><span class="hljs-code">        CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。</span><br><span class="hljs-code">        LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；</span><br><span class="hljs-code">        LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；</span><br><span class="hljs-code">        FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；</span><br><span class="hljs-code">        BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</span><br><span class="hljs-code">        SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">    -</span> 子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度，通过子任务可以实现一个任务执行完成去执行另一个任务。<br><span class="hljs-bullet">    -</span> 调度过期策略：<br><span class="hljs-bullet">        -</span> 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；<br><span class="hljs-bullet">        -</span> 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；<br><span class="hljs-bullet">    -</span> 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；<br><span class="hljs-code">        单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</span><br><span class="hljs-code">        丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</span><br><span class="hljs-code">        覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</span><br><span class="hljs-code">    - 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；</span><br><span class="hljs-code">    - 失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</span><br><span class="hljs-code"></span><br></code></pre></td></tr></table></figure>

<p>分片是指调度中心以执行器为维度进行分片, 将集群执行器标上序号: 0,1,2,3等, 广播是指每次调度向集群的所有执行器发送任务调度, 请求中携带分片参数:</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218203153029.png" srcset="/img/loading.gif" lazyload alt="image-20231218203153029"></p>
<p>每个执行器收到调度请求同时接收分片参数:</p>
<p>xxl-job 支持动态扩容执行器集群从而动态增加分片数量, 当<code>任务量增加</code>可以部署<code>更多的执行器</code>到集群, 调度中心会动态修改<code>分片的数量</code></p>
<p>作业分片适用哪些场景?</p>
<ul>
<li>分片任务场景: 10个执行器的集群处理10w条数据, 每台机器处理1w条数据, 耗时降低10倍</li>
<li>广播任务场景: 广播执行器同时运行<code>shell脚本</code>, 广播集群节点进行缓存更新等</li>
</ul>
<p>​	所以, 广播分片方式不仅可以发挥每个执行器的能力, 并根据分片参数可以控制任务是否执行, 最终灵活控制执行器集群分布式处理任务</p>
<p>使用说明: 分片广播和普通任务开发流程一致, 不同是可以获取<code>分片参数</code>进行分片业务处理</p>
<p><strong>任务方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 2、分片广播任务</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@XxlJob(&quot;shardingJobHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shardingJobHandler</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//分片参数</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardIndex(); <span class="hljs-comment">//执行器序号</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardTotal</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardTotal(); <span class="hljs-comment">//执行器总数</span><br><br>        System.out.println(<span class="hljs-string">&quot;shardIndex: &quot;</span> + shardIndex + <span class="hljs-string">&quot; shardTotal: &quot;</span> + shardTotal);<br><br><br>    &#125;<br></code></pre></td></tr></table></figure>

<p>添加任务</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235250912.png" srcset="/img/loading.gif" lazyload alt="image-20231220235250912"></p>
<p>复制一个mediaapplication实例</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218204829676.png" srcset="/img/loading.gif" lazyload alt="image-20231218204829676"></p>
<p>启动两个media模块服务</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235520938.png" srcset="/img/loading.gif" lazyload alt="image-20231220235520938"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235431373.png" srcset="/img/loading.gif" lazyload alt="image-20231220235431373"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231220235333054.png" srcset="/img/loading.gif" lazyload alt="image-20231220235333054"></p>
<p>当一次分片广播到来, 各执行器如何根据分片参数去分布式执行任务, 保证执行器之间执行的任务不重复呢?</p>
<h3 id="视频处理"><a href="#视频处理" class="headerlink" title="视频处理"></a>视频处理</h3><h4 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h4><h5 id="作业分片方案"><a href="#作业分片方案" class="headerlink" title="作业分片方案"></a>作业分片方案</h5><p>任务添加成功后, 对要处理的任务, 添加到待处理的任务表中, 现在启动多个执行器示例去查询这些待处理任务, 此时如何保证多个执行器不会重复执行任务?</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218205201099.png" srcset="/img/loading.gif" lazyload></p>
<p>在上一节测试中, 每个执行器收到广播任务有两个参数, <code>分片序号</code>和<code>分片总数</code></p>
<ul>
<li><p>每个执行器从数据表取任务时, 可以用<code>任务id</code>对<code>分片总数</code>取余, 如果等于该执行器的<code>分片序号</code>, 则执行此任务</p>
</li>
<li><p><code>任务ID  %  分片总数  =  分片序号</code></p>
</li>
<li><p>1 % 2 &#x3D; 1，执行器2执行</p>
<p>2 % 2 &#x3D; 0，执行器1执行</p>
<p>3 % 2 &#x3D; 1，执行器2执行</p>
<p>4 % 2 &#x3D; 1，执行器1执行</p>
</li>
<li><p>以此类推</p>
</li>
</ul>
<h5 id="保证任务不重复执行"><a href="#保证任务不重复执行" class="headerlink" title="保证任务不重复执行"></a>保证任务不重复执行</h5><p>通过作业分片方案保证执行器之间分配的任务不重复执行</p>
<p>但是如果同一个执行器, 处理一个视频, 没有处理完, 此时调度中心来了一个请求调度, 为了不重复处理同一个视频, 怎么办?</p>
<blockquote>
<p>配置调度过期策略</p>
<p>忽略: 调度过期后, <code>忽略过期的任务</code>, 从当前时间开始重新计算下次触发时间</p>
<p>立即执行一次:  调度过期后, 立即执行一次, 从当前时间开始重新计算下次触发时间</p>
</blockquote>
<p>这里我们选择<code>忽略</code>，如果立即执行一次，可能会重复调度</p>
<p>其次，我们在看阻塞处理策略。</p>
<p>阻塞处理策略就是当前执行器正在执行任务还没有结束时，调度中心又请求调度，此时该如何处理</p>
<blockquote>
<p>阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</p>
<ul>
<li>单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</li>
<li>丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</li>
<li>覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务</li>
</ul>
</blockquote>
<p>这里选择<code>丢弃后续调度</code>，避免重复调度</p>
<p>最后，也就是要注意保证任务处理的<code>幂等性</code>，什么是<code>任务的幂等性</code>？</p>
<blockquote>
<p>任务的幂等性: 对于数据的操作不论多少次, 操作的结果一致的</p>
</blockquote>
<p>执行器接收调度请求去执行任务, 要有办法去<code>判断任务是否处理完成</code>, 如果处理完则不再处理, 即使重复调度处理相同的任务也不能重复处理相同的视频</p>
<blockquote>
<p>幂等性: 描述了一次或多次请求某一个资源, 对于资源本身应该具有相同的结果</p>
</blockquote>
<p>幂等性是为了解决重复提交问题: 比如: 恶意刷单, 重复支付等等</p>
<p>解决幂等性方案:</p>
<ol>
<li>数据库约束, 例如: 唯一索引, 主键</li>
<li>乐观锁, 长用户数据库, 更新数据时根据乐观锁状态去更新</li>
<li>唯一序列号, 操作传递一个唯一序列号, 操作时判断与该序列号相等, 则执行</li>
</ol>
<p>这里我们在数据库视频处理表中添加<code>状态处理</code>字段, 视频处理完成更新状态为完成, 执行视频前判断<code>是否完成</code>, 如果已经完成则不再处理</p>
<h5 id="业务流程-2"><a href="#业务流程-2" class="headerlink" title="业务流程"></a>业务流程</h5><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218212704684.png" srcset="/img/loading.gif" lazyload alt="image-20231218212704684"></p>
<p>详细流程</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218212809395.png" srcset="/img/loading.gif" lazyload alt="image-20231218212809395"></p>
<ol>
<li>任务调度中心广播作业分片</li>
<li>执行器收到广播作业分片, 从数据库读取待处理任务</li>
<li>执行器根据任务内容minio下载要处理的文件</li>
<li>执行器启动多线程处理任务</li>
<li>任务处理完成后, 上传处理后的视频到minio</li>
<li>将更新任务处理结果, 如果视频处理完成, 除了更新任务处理结果之外, 将文件的访问地址更新到任务处理表及文件, 最后将任务完成记录写入历史表</li>
</ol>
<p>待处理任务表</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218213124845.png" srcset="/img/loading.gif" lazyload alt="image-20231218213124845"></p>
<h4 id="查询待处理任务"><a href="#查询待处理任务" class="headerlink" title="查询待处理任务"></a>查询待处理任务</h4><h5 id="添加待处理任务"><a href="#添加待处理任务" class="headerlink" title="添加待处理任务"></a>添加待处理任务</h5><p>上传视频成功, 向视频处理待处理表添加记录, 暂时只添加.avi类型视频的处理记录</p>
<p>根据Mime Type 去判断, 是否为avi视频, 下面列出部分mime type</p>
<table>
<thead>
<tr>
<th align="center">Video Type</th>
<th align="center">Extension</th>
<th align="center">MIME Type</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Flash</td>
<td align="center">fl</td>
<td align="center">video&#x2F;x-flv</td>
</tr>
<tr>
<td align="center">MPEG-4</td>
<td align="center">.mp4</td>
<td align="center">video&#x2F;mp4</td>
</tr>
<tr>
<td align="center">iPhone Index</td>
<td align="center">.m3u8</td>
<td align="center">application&#x2F;x-mpegURL</td>
</tr>
<tr>
<td align="center">iPhone Segment</td>
<td align="center">.ts</td>
<td align="center">video&#x2F;MP2T</td>
</tr>
<tr>
<td align="center">3GP Mobile</td>
<td align="center">.3gp</td>
<td align="center">video&#x2F;3gpp</td>
</tr>
<tr>
<td align="center">QuickTime</td>
<td align="center">.mov</td>
<td align="center">video&#x2F;quicktime</td>
</tr>
<tr>
<td align="center">A&#x2F;V Interleave</td>
<td align="center">.avi</td>
<td align="center">video&#x2F;x-msvideo</td>
</tr>
<tr>
<td align="center">Windows Media</td>
<td align="center">.wmv</td>
<td align="center">video&#x2F;x-ms-wmv</td>
</tr>
</tbody></table>
<p>avi视频的mine type是<code>video/x-msvideo</code></p>
<p>修改addMediaFilesToDB方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> MediaFiles <span class="hljs-title function_">addMediaFilesToDB</span><span class="hljs-params">(Long companyId, UploadFileParamsDto uploadFileParamsDto,</span><br><span class="hljs-params">                                    String objectName, String fileMD5, String bucket_files)</span> &#123;<br>    <span class="hljs-comment">// 保存到数据库</span><br>    <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(fileMD5);<br>    <span class="hljs-keyword">if</span> (mediaFiles == <span class="hljs-literal">null</span>) &#123;<br>        mediaFiles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaFiles</span>();<br>        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);<br>        mediaFiles.setId(fileMD5);<br>        mediaFiles.setFileId(fileMD5);<br>        mediaFiles.setCompanyId(companyId);<br>        mediaFiles.setBucket(bucket_files);<br>        mediaFiles.setCreateDate(LocalDateTime.now());<br>        mediaFiles.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        mediaFiles.setFilePath(objectName);<br>        <span class="hljs-comment">// 获取源文件名的contentType</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">contentType</span> <span class="hljs-operator">=</span> MyFileUtils.getContentType(objectName);<br>        <span class="hljs-comment">// 如果是图片格式或者mp4格式，则设置URL属性，否则不设置</span><br>        <span class="hljs-keyword">if</span> (contentType.contains(<span class="hljs-string">&quot;image&quot;</span>) || contentType.contains(<span class="hljs-string">&quot;mp4&quot;</span>)) &#123;<br>            mediaFiles.setUrl(<span class="hljs-string">&quot;/&quot;</span> + bucket_files + <span class="hljs-string">&quot;/&quot;</span> + objectName);<br>        &#125;<br>        <span class="hljs-comment">// 查阅数据字典，002003表示审核通过</span><br>        mediaFiles.setAuditStatus(<span class="hljs-string">&quot;002003&quot;</span>);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> mediaFilesMapper.insert(mediaFiles);<br>        <span class="hljs-keyword">if</span> (insert &lt;= <span class="hljs-number">0</span>) &#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;保存文件信息失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 添加待处理任务</span><br>        addWaitingTask(mediaFiles);<br>		<span class="hljs-keyword">return</span> mediaFiles;<br>    &#125;<br>    <span class="hljs-keyword">return</span> mediaFiles;<br>&#125;<br><br><span class="hljs-comment">// 添加待处理任务</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addWaitingTask</span><span class="hljs-params">(MediaFiles mediaFiles)</span>&#123;<br>    <span class="hljs-comment">// 获取文件mimeType</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> mediaFiles.getFilename();<br>    <span class="hljs-comment">// 文件扩展名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> getMimeType(extension);<br>    <span class="hljs-comment">// 通过mimeType判断如果是avi视频,再写入待处理任务</span><br>    <span class="hljs-keyword">if</span> (mimeType.equals(<span class="hljs-string">&quot;video/x-msvideo&quot;</span>))&#123;<br>        <span class="hljs-type">MediaProcess</span> <span class="hljs-variable">mediaProcess</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaProcess</span>();<br>        BeanUtils.copyProperties(mediaFiles, mediaProcess);<br>        mediaProcess.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<span class="hljs-comment">// 状态是未处理</span><br>        mediaProcess.setCreateDate(LocalDateTime.now());<br>        mediaProcess.setFailCount(<span class="hljs-number">0</span>);<span class="hljs-comment">//失败默认值为0</span><br>        mediaProcess.setUrl(<span class="hljs-literal">null</span>);<span class="hljs-comment">//最终互联网播放url</span><br>        <span class="hljs-comment">// 向mediaProcess插入记录</span><br>        mediaProcessMapper.insert(mediaProcess);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="查询待处理任务-1"><a href="#查询待处理任务-1" class="headerlink" title="查询待处理任务"></a>查询待处理任务</h5><p>如何保证查询到的待处理视频记录不重复? 用任务id对分片总数取模, 如果等于该执行器的分片序号, 则执行, 同时为了避免同一个任务被执行两次, 我们需要额外指定任务状态为未处理</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> media_process <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">%</span> #&#123;shareTotal&#125; <span class="hljs-operator">=</span> #&#123;shareIndex&#125; <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1&#x27;</span> LIMIT #&#123;count&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据分片参数获取待处理任务</span><br><span class="hljs-comment">     * @param shardTotal    分片总数</span><br><span class="hljs-comment">     * @param shardIndex    分片序号</span><br><span class="hljs-comment">     * @param count         任务数</span><br><span class="hljs-comment">     * @return</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `media_process` t <span class="hljs-keyword">where</span> t.id <span class="hljs-operator">%</span> <span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> (t.`status`<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">or</span> t.`status`<span class="hljs-operator">=</span><span class="hljs-number">3</span>) <span class="hljs-keyword">AND</span> t.fail_count<span class="hljs-operator">&lt;</span><span class="hljs-number">3</span> limit <span class="hljs-number">2</span><br>    <span class="hljs-variable">@Select</span>(&quot;SELECT * FROM media_process WHERE id % #&#123;shardTotal&#125; = #&#123;shardIndex&#125; AND (status = &#x27;1&#x27; or status = &#x27;3&#x27;) and fail_count&lt;3 LIMIT #&#123;count&#125;&quot;)<br>    List<span class="hljs-operator">&lt;</span>MediaProcess<span class="hljs-operator">&gt;</span> selectListByShardIndex(<span class="hljs-variable">@Param</span>(&quot;shardTotal&quot;) <span class="hljs-type">int</span> shardTotal, <span class="hljs-variable">@Param</span>(&quot;shardIndex&quot;) <span class="hljs-type">int</span> shardIndex, <span class="hljs-variable">@Param</span>(&quot;count&quot;) <span class="hljs-type">int</span> count);<br><br></code></pre></td></tr></table></figure>

<p>把mapper封装到接口MediaFileProcessService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.service.impl;<br><br><span class="hljs-keyword">import</span> com.xuecheng.media.mapper.MediaProcessMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaProcess;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;<br><span class="hljs-keyword">import</span> groovy.util.logging.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/18 21:44</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaFileProcessServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MediaFileProcessService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaProcessMapper mediaProcessMapper;<br><br>    <span class="hljs-comment">// 查询待处理任务</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;MediaProcess&gt; <span class="hljs-title function_">getMediaProcessList</span><span class="hljs-params">(<span class="hljs-type">int</span> shardIndex, <span class="hljs-type">int</span> shardTotal, <span class="hljs-type">int</span> count)</span> &#123;<br>        <span class="hljs-keyword">return</span> mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="开始执行任务"><a href="#开始执行任务" class="headerlink" title="开始执行任务"></a>开始执行任务</h4><h5 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h5><p>为了避免多线程争夺同一个任务使用synchronized同步锁去解决</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-title function_">synchronized</span><span class="hljs-params">(锁对象)</span>&#123;<br>   执行任务...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>synchronized 只能保证同一个虚拟机中多个线程去争抢锁</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218215322204.png" srcset="/img/loading.gif" lazyload alt="image-20231218215322204"></p>
<p>如果多个执行器分布式部署, 不能保证同一个视频只有一个执行器处理</p>
<p>现在实现分布式环境所有虚拟机中的线程同步执行就需要让多个虚拟机共用一个锁, 虚拟机可以分布式部署, 锁也可以分布式部署</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231218215443345.png" srcset="/img/loading.gif" lazyload alt="image-20231218215443345"></p>
<p>虚拟机去抢占同一个锁, 锁是一个单独的程序提供加锁, 解锁服务; 该锁不属于某个虚拟机, 而是分布式部署, 由多个虚拟机共享, 这种锁叫分布式锁</p>
<p>实现分布式锁方案很多: </p>
<ol>
<li>基于数据库实现分布式锁</li>
<li>基于redis实现分布式锁</li>
<li>使用zookeeper实现</li>
</ol>
<h5 id="开启任务"><a href="#开启任务" class="headerlink" title="开启任务"></a>开启任务</h5><p>基于数据库实现一下, 开始执行任务将任务状态更新为4表示任务执行中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> media_process m <span class="hljs-keyword">set</span> m.status<span class="hljs-operator">=</span><span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-keyword">where</span>  m.id<span class="hljs-operator">=</span>?<br></code></pre></td></tr></table></figure>

<p>如果多个线程执行该sql将会执行成功, 需求是只能有一个线程抢到锁, 所以sql无法满足需求</p>
<p>下面使用乐观锁实现更新操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> media_process m <span class="hljs-keyword">set</span> m.status<span class="hljs-operator">=</span><span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-keyword">where</span> (m.status<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">or</span> m.status<span class="hljs-operator">=</span><span class="hljs-string">&#x27;3&#x27;</span>) <span class="hljs-keyword">and</span> m.fail_count<span class="hljs-operator">&lt;</span><span class="hljs-number">3</span> <span class="hljs-keyword">and</span> m.id<span class="hljs-operator">=</span>?<br></code></pre></td></tr></table></figure>

<p>多个线程同时执行上面的sql只会有一个线程执行成功</p>
<p>什么是乐观锁, 悲观锁?</p>
<p>synchronized是一种悲观锁，在执行被synchronized包裹的代码时需要首先获取锁，没有拿到锁则无法执行，是总悲观的认为别的线程会去抢，所以要悲观锁。</p>
<p>乐观锁的思想是它不认为会有线程去争抢，尽管去执行，如果没有执行成功就再去重试。</p>
<p>mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 开启一个任务</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id 任务id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 更新记录数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Update(&quot;update media_process m set m.status=&#x27;4&#x27; where (m.status=&#x27;1&#x27; or m.status=&#x27;3&#x27;) and m.fail_count&lt;3 and m.id=#&#123;id&#125;&quot;)</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">startTask</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;id&quot;)</span> <span class="hljs-type">long</span> id)</span>;<br></code></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startTask</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> mediaProcessMapper.startTask(id);<br>    <span class="hljs-keyword">return</span> result&lt;=<span class="hljs-number">0</span>?<span class="hljs-literal">false</span>:<span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="更新任务状态"><a href="#更新任务状态" class="headerlink" title="更新任务状态"></a>更新任务状态</h4><p>任务处理完成后需要更新任务处理结果， 任务执行成功更新视频的url, 任务处理结果, 将待处理任务记录删除, 同时向历史任务表添加记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveProcessFinishStatus</span><span class="hljs-params">(Long taskId, String status, String fileId, String url, String errorMsg)</span> &#123;<br>        <span class="hljs-comment">//要更新的任务</span><br>        <span class="hljs-type">MediaProcess</span> <span class="hljs-variable">mediaProcess</span> <span class="hljs-operator">=</span> mediaProcessMapper.selectById(taskId);<br>        <span class="hljs-keyword">if</span> (mediaProcess == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//如果任务执行失败</span><br>        <span class="hljs-keyword">if</span> (status.equals(<span class="hljs-string">&quot;3&quot;</span>))&#123;<br>            <span class="hljs-comment">//更新mediaProcess表的状态</span><br>            mediaProcess.setStatus(<span class="hljs-string">&quot;3&quot;</span>);<br>            mediaProcess.setFailCount(mediaProcess.getFailCount()+<span class="hljs-number">1</span>);<span class="hljs-comment">//失败次数+1</span><br>            mediaProcess.setErrormsg(errorMsg);<br>            mediaProcessMapper.updateById(mediaProcess);<br>            <span class="hljs-comment">//todo 更高效的更新方式</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//如果任务执行成功</span><br>        <span class="hljs-comment">//文件表记录</span><br>        <span class="hljs-comment">//更新media_file表中的url</span><br>        <span class="hljs-type">MediaFiles</span> <span class="hljs-variable">mediaFiles</span> <span class="hljs-operator">=</span> mediaFilesMapper.selectById(fileId);<br>        mediaFiles.setUrl(url);<br>        mediaFilesMapper.updateById(mediaFiles);<br><br>        <span class="hljs-comment">//更新mediaProcess表的状态</span><br>        mediaProcess.setStatus(<span class="hljs-string">&quot;2&quot;</span>);<br>        mediaProcess.setFinishDate(LocalDateTime.now());<br>        mediaProcess.setUrl(url);<br>        mediaProcessMapper.updateById(mediaProcess);<br><br>        <span class="hljs-comment">//将mediaProcess记录插入到mediaProcessHistory表</span><br>        <span class="hljs-type">MediaProcessHistory</span> <span class="hljs-variable">mediaProcessHistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaProcessHistory</span>();<br>        BeanUtils.copyProperties(mediaProcess, mediaProcessHistory);<br>        mediaProcessHistoryMapper.insert(mediaProcessHistory);<br><br>        <span class="hljs-comment">//删除mediaProcess表状态</span><br>        mediaProcessMapper.deleteById(mediaFiles);<br><br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="视频处理-1"><a href="#视频处理-1" class="headerlink" title="视频处理"></a>视频处理</h4><p>视频采用并发处理，每个视频使用一个线程去处理，每次处理的视频数量不要超过cpu核心数</p>
<p>所有视频处理完成结束本次执行，为防止代码异常出现无限期等待则添加超时设置，到达超时时间还没有处理完成仍结束任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.media.service.jobhandler;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.utils.Mp4VideoUtil;<br><span class="hljs-keyword">import</span> com.xuecheng.media.model.po.MediaProcess;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;<br><span class="hljs-keyword">import</span> com.xuecheng.media.service.MediaFileService;<br><span class="hljs-keyword">import</span> com.xxl.job.core.context.XxlJobHelper;<br><span class="hljs-keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * XxlJob开发示例（Bean模式）</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 开发步骤：</span><br><span class="hljs-comment"> * 1、任务开发：在Spring Bean实例中，开发Job方法；</span><br><span class="hljs-comment"> * 2、注解配置：为Job方法添加注解 &quot;<span class="hljs-doctag">@XxlJob</span>(value=&quot;自定义jobhandler名称&quot;, init = &quot;JobHandler初始化方法&quot;, destroy = &quot;JobHandler销毁方法&quot;)&quot;，注解value值对应的是调度中心新建任务的JobHandler属性的值。</span><br><span class="hljs-comment"> * 3、执行日志：需要通过 &quot;XxlJobHelper.log&quot; 打印执行日志；</span><br><span class="hljs-comment"> * 4、任务结果：默认任务结果为 &quot;成功&quot; 状态，不需要主动设置；如有诉求，比如设置任务结果为失败，可以通过 &quot;XxlJobHelper.handleFail/handleSuccess&quot; 自主设置任务结果；</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> xuxueli 2019-12-11 21:52:51</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoTask</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileProcessService mediaFileProcessService;<br>    <span class="hljs-meta">@Autowired</span><br>    MediaFileService mediaFileService;<br><br>    <span class="hljs-comment">//ffmpeg的路径</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;videoprocess.ffmpegpath&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String ffmpegpath;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 视频处理任务</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@XxlJob(&quot;videoJobHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">videoJobHandler</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//分片参数</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardIndex(); <span class="hljs-comment">//执行器序号</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardTotal</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardTotal(); <span class="hljs-comment">//执行器总数</span><br><br>        <span class="hljs-comment">//确定cpu核心数</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">processors</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();<br><br><br>        <span class="hljs-comment">//查询待处理任务</span><br>        List&lt;MediaProcess&gt; mediaProcessList = mediaFileProcessService.getMediaProcessList(shardIndex, shardTotal, processors);<br>        <span class="hljs-comment">//任务数量</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> mediaProcessList.size();<br>        log.debug(<span class="hljs-string">&quot;取到的视频任务数:&#123;&#125;&quot;</span>, size);<br>        <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//工具类创建一个线程池,线程数 &lt;= CPU数, 上面的mediaProcessList不一定是满的</span><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(size);<br>        <span class="hljs-comment">//使用计数器</span><br>        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(size);<br><br>        mediaProcessList.forEach(mediaProcess -&gt; &#123;<br><br>            <span class="hljs-comment">//将任务加入线程池</span><br>            executorService.execute(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//任务执行逻辑</span><br>                    <span class="hljs-comment">//1.争抢任务(开启任务)</span><br>                    <span class="hljs-type">Long</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> mediaProcess.getId();<br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> mediaFileProcessService.startTask(taskId);<br>                    <span class="hljs-keyword">if</span> (!isLock) &#123;<br>                        log.error(<span class="hljs-string">&quot;抢占任务失败, 任务id:&#123;&#125;&quot;</span>, taskId);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br><br>                    <span class="hljs-comment">//2.执行视频转码</span><br>                    <span class="hljs-comment">//下载minio视频到本地</span><br>                    <span class="hljs-comment">//桶</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">bucket</span> <span class="hljs-operator">=</span> mediaProcess.getBucket();<br>                    <span class="hljs-comment">//objectName</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> mediaProcess.getFilePath();<br>                    <span class="hljs-comment">//md5</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> mediaProcess.getFileId();<br><br><br>                    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> mediaFileService.downloadFileFromMinIO(bucket, filePath);<br>                    <span class="hljs-keyword">if</span> (file == <span class="hljs-literal">null</span>) &#123;<br>                        log.error(<span class="hljs-string">&quot;下载视频错误, 任务id:&#123;&#125;,bucket:&#123;&#125;,filePath:&#123;&#125;&quot;</span>, taskId, bucket, filePath);<br>                        <span class="hljs-comment">//保存任务状态为失败</span><br>                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="hljs-string">&quot;3&quot;</span>, md5, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;下载视频到本地失败&quot;</span>);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br><br>                    <span class="hljs-comment">//源avi视频的路径</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">video_path</span> <span class="hljs-operator">=</span> file.getAbsolutePath();<br>                    <span class="hljs-comment">//转换后mp4文件的名称</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">mp4_name</span> <span class="hljs-operator">=</span> md5 + <span class="hljs-string">&quot;.mp4&quot;</span>;<br>                    <span class="hljs-comment">//转换后mp4文件的路径</span><br>                    <span class="hljs-comment">//先创建临时文件,这个文件作为转换后的文件</span><br>                    <span class="hljs-type">File</span> <span class="hljs-variable">mp4File</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        mp4File = File.createTempFile(<span class="hljs-string">&quot;minio&quot;</span>, <span class="hljs-string">&quot;.mp4&quot;</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                        log.debug(<span class="hljs-string">&quot;创建临时文件异常,&#123;&#125;&quot;</span>, e.getMessage());<br>                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="hljs-string">&quot;3&quot;</span>, md5, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;创建临时文件异常&quot;</span>);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">mp4_path</span> <span class="hljs-operator">=</span> mp4File.getAbsolutePath();<br>                    <span class="hljs-comment">//创建工具类对象</span><br>                    <span class="hljs-type">Mp4VideoUtil</span> <span class="hljs-variable">videoUtil</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mp4VideoUtil</span>(ffmpegpath, video_path, mp4_name, mp4_path);<br>                    <span class="hljs-comment">//开始视频转换，成功将返回success</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> videoUtil.generateMp4();<br><br>                    <span class="hljs-comment">//视频转码失败</span><br>                    <span class="hljs-keyword">if</span> (!result.equals(<span class="hljs-string">&quot;success&quot;</span>)) &#123;<br>                        log.debug(<span class="hljs-string">&quot;视频转码失败,原因:&#123;&#125;,bucket:&#123;&#125;,objectName:&#123;&#125;&quot;</span>, result, bucket, filePath);<br>                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="hljs-string">&quot;3&quot;</span>, md5, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;视频转码失败: &quot;</span> + result);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br><br>                    <span class="hljs-comment">// mp4文件的url</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> getFilePathByMd5(md5, <span class="hljs-string">&quot;.mp4&quot;</span>);<br><br>                    <span class="hljs-comment">//视频转码成功</span><br>                    <span class="hljs-comment">//3.上传minio</span><br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">addMediaFilesToMinIO</span> <span class="hljs-operator">=</span> mediaFileService.addMediaFilesToMinIO(mp4_path, <span class="hljs-string">&quot;video/mp4&quot;</span>, bucket, url);<br>                    <span class="hljs-keyword">if</span> (!addMediaFilesToMinIO) &#123;<br>                        log.debug(<span class="hljs-string">&quot;上传mp4到minio失败,taskid:&#123;&#125;&quot;</span>, taskId);<br>                        mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="hljs-string">&quot;3&quot;</span>, md5, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;上传mp4到minio失败&quot;</span>);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br><br>                    <span class="hljs-comment">//4.保存任务状态为成功</span><br>                    mediaFileProcessService.saveProcessFinishStatus(taskId, <span class="hljs-string">&quot;2&quot;</span>, md5, url, <span class="hljs-string">&quot;下载视频到本地失败&quot;</span>);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-comment">//计数器-1</span><br>                    countDownLatch.countDown();<br>                &#125;<br>            &#125;);<br><br>        &#125;);<br><br>        <span class="hljs-comment">//阻塞,等大家完成任务,整个方法才完成; 指定一个最大限度的等待时间,阻塞最多等待一定时间解除阻塞</span><br>        countDownLatch.await(<span class="hljs-number">30</span>, TimeUnit.MINUTES);<br><br><br>    &#125;<br><br>    <span class="hljs-comment">// 得到分块文件目录</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getFilePathByMd5</span><span class="hljs-params">(String fileMd5, String fileExt)</span> &#123;<br>        <span class="hljs-keyword">return</span> fileMd5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5.substring(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + <span class="hljs-string">&quot;/&quot;</span> + fileMd5 + fileExt;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><h5 id="基本测试"><a href="#基本测试" class="headerlink" title="基本测试"></a>基本测试</h5><p>进入xxl-job调度中心添加执行器和视频处理任务</p>
<p>在xxl-job配置任务调度策略：</p>
<p>1）配置阻塞处理策略为：丢弃后续调度。</p>
<p>2）配置视频处理调度时间间隔不用根据视频处理时间去确定，可以配置的小一些，如：5分钟，即使到达调度时间如果视频没有处理完会丢弃调度请求。</p>
<p>配置完成开始测试视频处理：</p>
<p>1、首先上传至少4个视频，非mp4格式。</p>
<p>2、在xxl-job启动视频处理任务</p>
<p>3、观察媒资管理服务后台日志</p>
<h5 id="失败测试"><a href="#失败测试" class="headerlink" title="失败测试"></a>失败测试</h5><p>1、先停止调度中心的视频处理任务。</p>
<p>2、上传视频，手动修改待处理任务表中file_path字段为一个不存在的文件地址</p>
<p>3、启动任务</p>
<p>观察任务处理失败后是否会重试，并记录失败次数。</p>
<h5 id="抢占任务测试"><a href="#抢占任务测试" class="headerlink" title="抢占任务测试"></a>抢占任务测试</h5><p>1、修改调度中心中视频处理任务的阻塞处理策略为“覆盖之间的调度”</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103203263.png" srcset="/img/loading.gif" lazyload alt="image-20231219103203263"></p>
<p>2、在抢占任务代码处打断点并选择支持多线程方式</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103221247.png" srcset="/img/loading.gif" lazyload alt="image-20231219103221247"></p>
<p>3、在抢占任务代码处的下边两行代码分别打上断点，避免观察时代码继续执行。</p>
<p>4、启动任务</p>
<p>此时多个线程执行都停留在断点处</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103236246.png" srcset="/img/loading.gif" lazyload alt="image-20231219103236246"></p>
<p>依次放行，观察同一个任务只会被一个线程抢占成功。</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219103249414.png" srcset="/img/loading.gif" lazyload alt="image-20231219103249414"></p>
<h4 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h4><h5 id="任务补偿机制"><a href="#任务补偿机制" class="headerlink" title="任务补偿机制"></a>任务补偿机制</h5><p>如果有线程抢占了某个视频的处理任务，如果<code>线程处理过程中挂掉了</code>，该视频的状态将会一直是处理中，其它线程将无法处理，这个问题需要用补偿机制。</p>
<p>单独启动一个任务找到待处理任务表中超过执行期限但仍在处理中的任务，将任务的状态改为执行失败。</p>
<p>任务执行期限是处理一个视频的最大时间，比如定为30分钟，通过任务的启动时间去判断任务是否超过执行期限。</p>
<p>大家思考这个sql该如何实现？</p>
<p>大家尝试自己实现此任务补偿机制。</p>
<h5 id="达到最大失败次数"><a href="#达到最大失败次数" class="headerlink" title="达到最大失败次数"></a>达到最大失败次数</h5><p>当任务达到<code>最大失败次数</code>时一般就说明程序处理此视频存在问题，这种情况就需要人工处理，在页面上会提示失败的信息，人工可手动执行该视频进行处理，或通过其它转码工具进行视频转码，转码后直接上传mp4视频。</p>
<h5 id="分块文件清理问题"><a href="#分块文件清理问题" class="headerlink" title="分块文件清理问题"></a>分块文件清理问题</h5><p>上传一个文件进行分块上传，上传一半不传了，之前上传到minio的分块文件要清理吗？怎么做的？</p>
<p>1、在数据库中有一张文件表记录minio中存储的文件信息。</p>
<p>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。</p>
<p>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除minio中没有上传成功的文件目录。</p>
<blockquote>
<p>面试</p>
<ol>
<li>xxl-job的原理是什么? xxl-job是什么?</li>
</ol>
<p>xxl-job分布式任务调度服务由调度中心和执行器组成, 调度中心负责按任务调度策略向执行器下发任务, 执行器负责接收任务, 执行任务</p>
<ul>
<li>首先部署并启动xxl-job调度中心（一个java工程，打成jar包可以放到虚拟机上运行）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">nohup</span> java -jar xxl-job-admin...  &amp; <br></code></pre></td></tr></table></figure>

<ul>
<li>在微服务中添加xxl-job依赖, 在微服务配置执行器</li>
</ul>
<p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>yml配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">xxl:</span><br>  <span class="hljs-attr">job:</span><br>    <span class="hljs-attr">admin:</span> <br>      <span class="hljs-attr">addresses:</span> <span class="hljs-string">http://192.168.101.128:18088/xxl-job-admin/</span><br>    <span class="hljs-attr">executor:</span><br>      <span class="hljs-attr">appname:</span> <span class="hljs-string">media-process-service</span><br>      <span class="hljs-attr">address:</span><br>      <span class="hljs-attr">ip:</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span><br>      <span class="hljs-attr">logpath:</span> <span class="hljs-string">/data/applogs/xxl-job-jobhandler</span><br>      <span class="hljs-attr">logretentiondays:</span> <span class="hljs-number">30</span><br>    <span class="hljs-attr">accessToken:</span> <span class="hljs-string">default_token</span><br></code></pre></td></tr></table></figure>

<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* xxl-job config</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* <span class="hljs-doctag">@author</span> xuxueli 2017-04-28</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XxlJobConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String adminAddresses;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String accessToken;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String appname;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String ip;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String logPath;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> logRetentionDays;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> XxlJobSpringExecutor <span class="hljs-title function_">xxlJobExecutor</span><span class="hljs-params">()</span> &#123;<br>        logger.info(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);<br>        <span class="hljs-type">XxlJobSpringExecutor</span> <span class="hljs-variable">xxlJobSpringExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XxlJobSpringExecutor</span>();<br>        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);<br>        xxlJobSpringExecutor.setAppname(appname);<br>        xxlJobSpringExecutor.setAddress(address);<br>        xxlJobSpringExecutor.setIp(ip);<br>        xxlJobSpringExecutor.setPort(port);<br>        xxlJobSpringExecutor.setAccessToken(accessToken);<br>        xxlJobSpringExecutor.setLogPath(logPath);<br>        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);<br>        <span class="hljs-keyword">return</span> xxlJobSpringExecutor;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 针对多网卡、容器内部署等情况，可借助 &quot;spring-cloud-commons&quot; 提供的 &quot;InetUtils&quot; 组件灵活定制注册IP；</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *      1、引入依赖：</span><br><span class="hljs-comment">    *          &lt;dependency&gt;</span><br><span class="hljs-comment">    *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="hljs-comment">    *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;</span><br><span class="hljs-comment">    *             &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="hljs-comment">    *         &lt;/dependency&gt;</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *      2、配置文件，或者容器启动变量</span><br><span class="hljs-comment">    *          spring.cloud.inetutils.preferred-networks: &#x27;xxx.xxx.xxx.&#x27;</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *      3、获取IP</span><br><span class="hljs-comment">    *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();</span><br><span class="hljs-comment">    */</span><br><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>启动微服务, 执行器向调度中心上报自己</li>
<li>在微服务写一个任务方法, 用xxl-job的注解去标记执行任务的方法名称</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@XxlJob(&quot;testJob&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testJob</span><span class="hljs-params">()</span> &#123;<br>    log.debug(<span class="hljs-string">&quot;开始执行.......&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>在微服务写一个任务方法, 用xxl-job注解标记执行任务的方法名称</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@XxlJob(&quot;testJob&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testJob</span><span class="hljs-params">()</span> &#123;<br>    log.debug(<span class="hljs-string">&quot;开始执行.......&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>在调度中心配置任务调度策略, 调度策略是每个多长时间执行, 或者每天&#x2F;每月固定时间去执行</li>
<li>在调度中心启动任务</li>
<li>调度中心根据任务调度策略, 到达时间开始下发任务给执行器</li>
<li>执行器收到任务开始执行任务</li>
</ul>
<ol start="2">
<li>如何保证任务不重复执行?<ol>
<li>调度中心按分片广播方式下发任务</li>
<li>执行器收到作业分片广播的参数：分片总数(shardTotal)和分片序号(shardIndex)，计算<code>任务id % 分片总数</code>(taskId % shardTotal)，如果结果等于分片序号，就去执行这个任务(taskId % shardTotal &#x3D; shardIndex)。这样就可以保证不同的执行器执行不同的任务</li>
<li>配置调度过期策略为忽略, 避免同一个执行器多次重复执行同一个任务</li>
<li>配置任务阻塞处理策略为丢弃后续调度, 注意: 丢弃也没事, 下一次调度还可以执行</li>
<li>另外还要保证任务处理的幂等性，执行过的任务可以打一个状态标记已完成（上面的代码设置status&#x3D;2即为完成），下次再次调度该任务时，判断该任务已完成，就不再执行</li>
</ol>
</li>
<li>任务幂等性如何保证?<ul>
<li>幂等性描述的是一次和多次请求某一个资源，对于资源本身，应该返回同样的结果</li>
<li>幂等性是为了解决重复提交问题，例如：恶意刷单，重复支付等</li>
<li>解决幂等性的常用方案<ol>
<li>数据库约束，例如：唯一索引、主键</li>
<li>乐观锁：常用于数据库，更新数据时，根据乐观锁的状态去更新</li>
<li>唯一序列号，请求前生成的唯一序列号，携带序列号去请求，执行时在redis记录该序列号，用于表示该序列号请求已经执行过了，如果相同的序列号再次来执行，则说明是重复执行。这里的解决方式是在数据库中添加状态处理字段，视频处理完成，则更新该字段为已完成，执行视频处理之前判断状态是否为已完成，若已完成则不处理</li>
</ol>
</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="绑定媒资"><a href="#绑定媒资" class="headerlink" title="绑定媒资"></a>绑定媒资</h3><h4 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h4><p>到目前为止，媒资管理已完成文件上传、视频处理、我的媒资功能等基本功能，其它模块可以使用媒资文件，本节要讲解课程计划绑定媒资文件。</p>
<p>如何将课程计划绑定媒资呢？</p>
<p>首先进入课程计划界面，然后选择要绑定的视频进行绑定即可。</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105332918.png" srcset="/img/loading.gif" lazyload alt="image-20231219105332918"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105340899.png" srcset="/img/loading.gif" lazyload alt="image-20231219105340899"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105349404.png" srcset="/img/loading.gif" lazyload alt="image-20231219105349404"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105356913.png" srcset="/img/loading.gif" lazyload alt="image-20231219105356913"></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105405675.png" srcset="/img/loading.gif" lazyload alt="image-20231219105405675"></p>
<h4 id="数据模型-1"><a href="#数据模型-1" class="headerlink" title="数据模型"></a>数据模型</h4><p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231219105434515.png" srcset="/img/loading.gif" lazyload alt="image-20231219105434515"></p>
<h4 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a>接口定义</h4><p>根据业务流程，用户进入课程计划列表，首先确定向哪个课程计划添加视频，点击”添加视频“后用户选择视频，选择视频，点击提交，前端以json格式请求以下参数：</p>
<p>提交媒资文件id、文件名称、教学计划id</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">JSON</span><br>&#123;<br>  <span class="hljs-string">&quot;mediaId&quot;</span>: <span class="hljs-string">&quot;70a98b4a2fffc89e50b101f959cc33ca&quot;</span>,<br>  <span class="hljs-string">&quot;fileName&quot;</span>: <span class="hljs-string">&quot;22-Hmily实现TCC事务-开发bank2的confirm方法.avi&quot;</span>,<br>  <span class="hljs-string">&quot;teachplanId&quot;</span>: <span class="hljs-number">257</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>此接口在内容管理模块提供。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(value = &quot;课程计划和媒资信息绑定&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/teachplan/association/media&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">associationMedia</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> BindTeachplanMediaDto bindTeachplanMediaDto)</span>&#123;<br>    teachplanService.associationMedia(bindTeachplanMediaDto);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 教学计划绑定媒资</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> TeachplanMedia <span class="hljs-title function_">associationMedia</span><span class="hljs-params">(BindTeachplanMediaDto bindTeachplanMediaDto)</span> &#123;<br>    <span class="hljs-comment">//教学计划id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">teachplanId</span> <span class="hljs-operator">=</span> bindTeachplanMediaDto.getTeachplanId();<br>    <span class="hljs-type">Teachplan</span> <span class="hljs-variable">teachplan</span> <span class="hljs-operator">=</span> teachplanMapper.selectById(teachplanId);<br>    <span class="hljs-keyword">if</span>(teachplan==<span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;教学计划不存在&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">grade</span> <span class="hljs-operator">=</span> teachplan.getGrade();<br>    <span class="hljs-keyword">if</span>(grade!=<span class="hljs-number">2</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;只允许第二级教学计划绑定媒资文件&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//课程id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">courseId</span> <span class="hljs-operator">=</span> teachplan.getCourseId();<br><br>    <span class="hljs-comment">//先删除原来该教学计划绑定的媒资</span><br>    teachplanMediaMapper.delete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;TeachplanMedia&gt;().eq(TeachplanMedia::getTeachplanId,teachplanId));<br><br>    <span class="hljs-comment">//再添加教学计划与媒资的绑定关系</span><br>    <span class="hljs-type">TeachplanMedia</span> <span class="hljs-variable">teachplanMedia</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TeachplanMedia</span>();<br>    teachplanMedia.setCourseId(courseId);<br>    teachplanMedia.setTeachplanId(teachplanId);<br>    teachplanMedia.setMediaFilename(bindTeachplanMediaDto.getFileName());<br>    teachplanMedia.setMediaId(bindTeachplanMediaDto.getMediaId());<br>    teachplanMedia.setCreateDate(LocalDateTime.now());<br>    teachplanMediaMapper.insert(teachplanMedia);<br>    <span class="hljs-keyword">return</span> teachplanMedia;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dts">Plain Text<br><span class="hljs-meta">### 课程计划绑定视频</span><br><span class="hljs-title class_">POST</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>media_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">/media/</span>teachplan<span class="hljs-keyword">/association/</span>media<br>Content-Type: application/json<br><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-string">&quot;mediaId&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;fileName&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;teachplanId&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br><br></code></pre></td></tr></table></figure>

<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>解除课程计划和媒资信息绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(value = &quot;解除课程计划和媒资信息绑定&quot;)</span><br><span class="hljs-meta">@DeleteMapping(&quot;/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">liftAssociationMedia</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long mediaId, <span class="hljs-meta">@PathVariable</span> Long teachPlanId)</span>&#123;<br>    teachplanService.liftAssociationMedia(mediaId, teachPlanId);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">liftAssociationMedia</span><span class="hljs-params">(Long mediaId, Long teachPlanId)</span> &#123;<br>    LambdaQueryWrapper&lt;TeachplanMedia&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>    queryWrapper.eq(TeachplanMedia::getTeachplanId, teachPlanId)<br>            .eq(TeachplanMedia::getMediaId, mediaId);<br>    teachplanMediaMapper.delete(queryWrapper);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">Java<br><br><span class="hljs-comment">### 课程计划接触视频绑定</span><br>DELETE &#123;&#123;media_host&#125;&#125;<span class="hljs-regexp">/media/</span>teachplan<span class="hljs-regexp">/association/m</span>edia<span class="hljs-regexp">/&#123;teachPlanId&#125;/</span>&#123;mediaId&#125;<br><br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="category-chain-item">项目</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" class="print-no-link">#学成在线</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>学成在线媒资管理模块</div>
      <div>http://example.com/2023/12/21/学成在线媒资管理模块/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>fgj</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年12月21日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/12/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/" title="学成在线内容管理模块">
                        <span class="hidden-mobile">学成在线内容管理模块</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":173,"height":346},"mobile":{"show":true},"log":false});</script></body>
</html>
