

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="fgj">
  <meta name="keywords" content="">
  
    <meta name="description" content="学成在线认证授权模块模块需求分析什么是认证授权？截至目前，项目已经完成了课程发布功能，课程发布后用户通过在线学习页面点播视频进行学习。如何记录学生的学习过程？要想掌握学生的学习情况需要知道用户的身份信息，记录哪个用户什么时间学习什么课程，如果用户要购买课程需要知道用户身份信息，所以，去管理学生的学习过程最基本的要实现用户的身份认证。 认证授权模块实现平台所有用户的身份认证和用户授权功能。  什么是">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线认证授权模块">
<meta property="og:url" content="http://example.com/2023/12/27/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97/index.html">
<meta property="og:site_name" content="FGJ">
<meta property="og:description" content="学成在线认证授权模块模块需求分析什么是认证授权？截至目前，项目已经完成了课程发布功能，课程发布后用户通过在线学习页面点播视频进行学习。如何记录学生的学习过程？要想掌握学生的学习情况需要知道用户的身份信息，记录哪个用户什么时间学习什么课程，如果用户要购买课程需要知道用户身份信息，所以，去管理学生的学习过程最基本的要实现用户的身份认证。 认证授权模块实现平台所有用户的身份认证和用户授权功能。  什么是">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224135916160.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224140155582.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224145850718.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224145910870.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224150315672.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224150349007.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224193913439.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224194407935.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224194933546.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224200453107.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224210819390.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224210849405.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224210903149.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224211328473.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224211635903.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224212214373.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224213256012.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224215931088.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224220018348.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224220029966.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224221619711.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224222136941.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224233859129.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224235114107.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226100944623.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226101103155.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226104100548.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226104244665.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226104446104.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226113249085.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226113456327.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226114121004.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226114240112.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226114917649.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226120332267.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226120801314.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226122508837.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226154848189.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226160736318.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226161045777.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226161233377.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226162949138.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226163459122.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226163746443.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226170841828.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226170947053.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226171541617.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226202942941.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226210615365.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226212746628.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226213250628.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226213354276.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226214116514.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226214145555.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226223602447.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226223648221.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226233742308.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234103548.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234215263.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234421292.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234549805.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234710976.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234719991.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227105656290.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227111010963.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227111058273.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227111247459.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227121958289.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227122010128.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227123937245.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227124310952.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135247356.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135503309.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135516048.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135538956.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135552058.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135645831.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227150001461.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227150055537.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155538069.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155551246.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155646094.png">
<meta property="og:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155822920.png">
<meta property="article:published_time" content="2023-12-27T08:23:15.000Z">
<meta property="article:modified_time" content="2023-12-27T08:23:51.093Z">
<meta property="article:author" content="fgj">
<meta property="article:tag" content="学成在线">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224135916160.png">
  
  
  
  <title>学成在线认证授权模块 - FGJ</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Home</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://fgj2.oss-cn-beijing.aliyuncs.com/ddd.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="学成在线认证授权模块"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-12-27 16:23" pubdate>
          2023年12月27日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          79k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          657 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">学成在线认证授权模块</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="认证授权模块"><a href="#认证授权模块" class="headerlink" title="认证授权模块"></a>认证授权模块</h2><h3 id="模块需求分析"><a href="#模块需求分析" class="headerlink" title="模块需求分析"></a>模块需求分析</h3><h4 id="什么是认证授权？"><a href="#什么是认证授权？" class="headerlink" title="什么是认证授权？"></a>什么是认证授权？</h4><p>截至目前，项目已经完成了课程发布功能，课程发布后用户通过在线学习页面点播视频进行学习。如何记录学生的学习过程？要想掌握学生的学习情况需要知道用户的身份信息，记录哪个用户什么时间学习什么课程，如果用户要购买课程需要知道用户身份信息，所以，去管理学生的学习过程最基本的要实现用户的身份认证。</p>
<p>认证授权模块实现平台所有用户的<strong>身份认证和用户授权</strong>功能。</p>
<blockquote>
<p>什么是用户身份认证？</p>
<p>用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证表现形式有：<strong>用户密码登录，微信扫码</strong>等方法</p>
<p>项目包括学生，学习机构老师，平台运营人员三类用户，不管哪一类用户在访问项目受保护的资源需要身份认证，比如：发布课程操作，需要学习机构老师首先登录系统成功，然后再执行发布课程操作。创建订单，需要学生用户首先登录系统，才可以创建订单。如图</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224135916160.png" srcset="/img/loading.gif" lazyload alt="image-20231224135916160" style="zoom:67%;" />

<p>什么是用户授权？</p>
<p>用户认证通过后访问系统的资源，系统会判断用户是否拥有访问资源权限，只<strong>允许访问有权限的系统资源</strong>，<strong>没有权限的资源无法访问</strong>，这个过程叫用户授权。比如：用户去发布课程，系统首先进行用户身份认证，认证通过后继续判断用户是否有发布课程的权限，如果没有权限则拒绝继续访问系统，如果有权限则继续发布课程</p>
<p>如图</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224140155582.png" srcset="/img/loading.gif" lazyload alt="image-20231224140155582" style="zoom:67%;" />
</blockquote>
<h4 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h4><h5 id="统一认证"><a href="#统一认证" class="headerlink" title="统一认证"></a>统一认证</h5><p>项目包括学生，学习机构老师，平台运营人员三类用户，三类用户使用统一的认证入口，如图：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224145850718.png" srcset="/img/loading.gif" lazyload alt="image-20231224145850718" style="zoom:50%;" />

<p>用户输入账号和密码提交认证，认证通过则继续操作。</p>
<p>项目由统一认证服务受理用户的认证请求，如下图</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224145910870.png" srcset="/img/loading.gif" lazyload alt="image-20231224145910870" style="zoom:67%;" />

<p>认证通过由认证服务向给用户颁发令牌，相当于访问系统的通行证，用户拿着令牌去访问系统的资源。</p>
<h5 id="单点登录"><a href="#单点登录" class="headerlink" title="单点登录"></a><strong>单点登录</strong></h5><p>本项目基于微服务架构构建，微服务包括：内容管理服务，媒资管理服务，学习中心服务，系统管理服务等，为了提高用户体验，<code>用户只需要认证一次即可在多个拥有访问权限的系统访问</code>，这个功能叫<code>单点登录</code></p>
<p>引用百度百科：单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。</p>
<p>如下图，用户只需要认证一次，便可以在多个拥有访问权限的系统中访问。</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224150315672.png" srcset="/img/loading.gif" lazyload alt="image-20231224150315672" style="zoom:50%;" />

<h5 id="第三方认证"><a href="#第三方认证" class="headerlink" title="第三方认证"></a>第三方认证</h5><p>为了提高用户体验，很多网站有扫码登录的功能，如：微信扫码登录、QQ扫码登录等。扫码登录的好处是用户不用输入账号和密码，操作简便，另外一个好处就是有利于用户信息的共享，互联网的优势就是资源共享，用户也是一种资源，对于一个新网站如果让用户去注册是很困难的，如果提供了微信扫码登录将省去用户注册的成本，是一种非常有效的推广手段。</p>
<p>微信扫码登录其中的原理正是使用了第三方认证，如下图</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224150349007.png" srcset="/img/loading.gif" lazyload alt="image-20231224150349007" style="zoom:50%;" />

<h3 id="Spring-Security-认证"><a href="#Spring-Security-认证" class="headerlink" title="Spring Security 认证"></a>Spring Security 认证</h3><h4 id="Spring-Security-介绍"><a href="#Spring-Security-介绍" class="headerlink" title="Spring Security 介绍"></a>Spring Security 介绍</h4><p>认证功能几乎是每个项目都具备的功能，并且它与业务无关，市面上有很多认证框架，如：Apache Shiro、CAS、Spring Security等。由于本项目基于Spring Cloud技术构建，Spring Security是spring家族的一份子且和Spring Cloud集成的很好，所以本项目选用Spring Security作为认证服务的技术框架。</p>
<p>Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架，它是一个专注于为 Java 应用程序提供身份验证和授权的框架。</p>
<p>项目主页：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></p>
<p>Spring cloud Security： <a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-security">https://spring.io/projects/spring-cloud-security</a></p>
<h4 id="认证授权入门"><a href="#认证授权入门" class="headerlink" title="认证授权入门"></a>认证授权入门</h4><h5 id="创建认证服务工程"><a href="#创建认证服务工程" class="headerlink" title="创建认证服务工程"></a>创建认证服务工程</h5><p>下面我们使用spring security框架快速构建认证授权功能体系</p>
<ol>
<li>部署认证服务功能</li>
</ol>
<p>从课程资料中拷贝xuecheng-plus-auth工程到自己的工程目录下。</p>
<p>此工程是一个普通的spring boot工程，可以连接数据库。</p>
<p>此工程不具备认证授权的功能</p>
<ol start="2">
<li>创建数据库</li>
</ol>
<p>创建xc_users数据库</p>
<p>导入课程资料中的xcplus_users.sql脚本。</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224193913439.png" srcset="/img/loading.gif" lazyload alt="image-20231224193913439" style="zoom:50%;" />

<p>在nacos中新增auth-service-dev.yaml：</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">server</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">servlet</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">context-path</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/auth</span><br>  <span class="hljs-attribute">port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">63070</span><br><span class="hljs-attribute">spring</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">datasource</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">driver-class-name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attribute">url</span><span class="hljs-punctuation">:</span> <span class="hljs-string">jdbc:mysql://192.168.101.65:3306/xc402_users?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br>    <span class="hljs-attribute">username</span><span class="hljs-punctuation">:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attribute">password</span><span class="hljs-punctuation">:</span> <span class="hljs-string">mysql</span><br></code></pre></td></tr></table></figure>

<p>初始工程自带了一个Controller类，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.auth.controller;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 测试controller</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/27 17:25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> &#123;<br><br>  <span class="hljs-meta">@Autowired</span><br>  XcUserMapper userMapper;<br><br>  <span class="hljs-meta">@RequestMapping(&quot;/login-success&quot;)</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">loginSuccess</span><span class="hljs-params">()</span>&#123;<br><br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;登录成功&quot;</span>;<br>  &#125;<br><br><br>  <span class="hljs-meta">@RequestMapping(&quot;/user/&#123;id&#125;&quot;)</span><br>  <span class="hljs-keyword">public</span> XcUser <span class="hljs-title function_">getuser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> String id)</span>&#123;<br>    <span class="hljs-type">XcUser</span> <span class="hljs-variable">xcUser</span> <span class="hljs-operator">=</span> userMapper.selectById(id);<br>    <span class="hljs-keyword">return</span> xcUser;<br>  &#125;<br><br>  <span class="hljs-meta">@RequestMapping(&quot;/r/r1&quot;)</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">r1</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;访问r1资源&quot;</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@RequestMapping(&quot;/r/r2&quot;)</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">r2</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;访问r2资源&quot;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>启动工程，尝试访问  <a target="_blank" rel="noopener" href="http://localhost:63070/auth/r/r1">http://localhost:63070/auth/r/r1</a> :</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224194407935.png" srcset="/img/loading.gif" lazyload alt="image-20231224194407935" style="zoom:50%;" />

<p>访问用户信息：<a target="_blank" rel="noopener" href="http://localhost:63070/auth/user/52">http://localhost:63070/auth/user/52</a></p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224194933546.png" srcset="/img/loading.gif" lazyload alt="image-20231224194933546" style="zoom:50%;" />

<h5 id="认证测试"><a href="#认证测试" class="headerlink" title="认证测试"></a>认证测试</h5><p>下边向auth认证工程集成Spring security，向pom.xml加入Spring Security所需要的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>重启工程，访问<a target="_blank" rel="noopener" href="http://localhost:63070/auth/r/r1">http://localhost:63070/auth/r/r1</a></p>
<p>自动进入&#x2F;login登录页面，&#x2F;login是spring security提供的,此页面有几个css样式加载会稍微慢点，如下图：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224200453107.png" srcset="/img/loading.gif" lazyload alt="image-20231224200453107" style="zoom:50%;" />

<p>账号和密码是多少呢？下一步需要进行安全配置。</p>
<p>拷贝课程资料下的WebSecurityConfig.java到config下需要三部分内容：</p>
<ol>
<li>用户信息</li>
</ol>
<p>在内存配置两个用户: zhangsan  lisi </p>
<p>zhangsan 用户拥有权限  p1 </p>
<p>lisi用户拥有的权限为p2</p>
<ol start="2">
<li>密码方式</li>
</ol>
<p>暂时采用明文方式</p>
<ol start="3">
<li>安全拦截机制</li>
</ol>
<p>&#x2F;r&#x2F;** 开头的请求需要认证</p>
<p>登录成功到成功页面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-comment">//配置用户信息服务</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span><br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>            manager.createUser(User.withUsername(<span class="hljs-string">&quot;zhangsan&quot;</span>).password(<span class="hljs-string">&quot;123&quot;</span>).authorities(<span class="hljs-string">&quot;p1&quot;</span>).build());<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;lisi&quot;</span>).password(<span class="hljs-string">&quot;456&quot;</span>).authorities(<span class="hljs-string">&quot;p2&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> manager;<br>&#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//密码为明文方式</span><br>        <span class="hljs-keyword">return</span> NoOpPasswordEncoder.getInstance();<br>    &#125;<br><br>    <span class="hljs-comment">//配置安全拦截机制</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http<br>                .authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/r/**&quot;</span>).authenticated()<span class="hljs-comment">//访问/r开始的请求需要认证通过</span><br>                .anyRequest().permitAll()<span class="hljs-comment">//其它请求全部放行</span><br>                .and()<br>                .formLogin().successForwardUrl(<span class="hljs-string">&quot;/login-success&quot;</span>);<span class="hljs-comment">//登录成功跳转到/login-success</span><br>                http.logout().logoutUrl(<span class="hljs-string">&quot;/logout&quot;</span>);<span class="hljs-comment">//退出地址</span><br>    &#125;<br></code></pre></td></tr></table></figure>

<p>重启工程</p>
<p>1、访问<a target="_blank" rel="noopener" href="http://localhost:63070/auth/user/52">http://localhost:63070/auth/user/52</a> 可以正常访问</p>
<p>2、访问<a target="_blank" rel="noopener" href="http://localhost:63070/auth/r/r1">http://localhost:63070/auth/r/r1</a> 显示（跳转到）登录页面</p>
<p>账号zhangsan，密码为123，如果输入的密码不正确会认证失败，输入正确显示登录成功。</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224210819390.png" srcset="/img/loading.gif" lazyload alt="image-20231224210819390" style="zoom:50%;" />

<p>http.logout().logoutUrl(“&#x2F;logout”);配置了退出页面，认证成功后访问&#x2F;logout可退出登录。</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224210849405.png" srcset="/img/loading.gif" lazyload alt="image-20231224210849405" style="zoom:25%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224210903149.png" srcset="/img/loading.gif" lazyload alt="image-20231224210903149" style="zoom:25%;" /></p>
<h5 id="授权测试"><a href="#授权测试" class="headerlink" title="授权测试"></a>授权测试</h5><p>用户认证通过去访问系统资源时spring security进行授权控制，判断用户是否有该资源的访问权限，如果有则继续访问，如果没有则拒绝访问。</p>
<p>下边测试授权功能：</p>
<p>1、配置用户拥有哪些权限。</p>
<p>在WebSecurityConfig类配置zhangsan拥有p1权限，lisi拥有p2权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span><br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;zhangsan&quot;</span>).password(<span class="hljs-string">&quot;123&quot;</span>).authorities(<span class="hljs-string">&quot;p1&quot;</span>).build());<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;lisi&quot;</span>).password(<span class="hljs-string">&quot;456&quot;</span>).authorities(<span class="hljs-string">&quot;p2&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> manager;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2、指定资源与权限的关系。</p>
<p>什么是系统的资源？</p>
<p>比如：查询一个用户的信息，用户信息就是系统的资源，要访问资源需要通过URL，所以我们在controller中定义的每个http的接口就是访问资源的接口。</p>
<p>下边在controller中配置&#x2F;r&#x2F;r1需要p1权限，&#x2F;r&#x2F;r2需要p2权限。</p>
<p>hasAuthority(‘p1’)表示拥有p1权限方可访问。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/r/r1&quot;)</span><br><span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;p1&#x27;)&quot;)</span><span class="hljs-comment">//拥有p1权限方可访问</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">r1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;访问r1资源&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">@RequestMapping(&quot;/r/r2&quot;)</span><br><span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;p2&#x27;)&quot;)</span><span class="hljs-comment">//拥有p2权限方可访问</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">r2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;访问r2资源&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>现在重启工程。</p>
<p>当访问以&#x2F;r&#x2F;开头的url时会判断用户是否认证，如果没有认证则跳转到登录页面，如果已经认证则判断用户是否具有该URL的访问权限，如果具有该URL的访问权限则继续，否则拒绝访问。</p>
<p>例如：</p>
<p>访问&#x2F;r&#x2F;r1，使用zhangsan登录可以正常访问，因为在&#x2F;r&#x2F;r1的方法上指定了权限p1，zhangsan用户拥有权限p1,所以可以正常访问。</p>
<p>访问&#x2F;r&#x2F;r1，使用lisi登录则拒绝访问，由于lisi用户不具有权限p1需要拒绝访问</p>
<p>注意：如果访问上不加@PreAuthorize，此方法没有授权控制。</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224211328473.png" srcset="/img/loading.gif" lazyload alt="image-20231224211328473" style="zoom:50%;" />

<h5 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h5><p>通过测试<code>认证</code>和<code>授权</code>两个功能，我们了解了Spring Security的基本使用方法，下边了解它的工作流程。</p>
<p>Spring Security 所解决的问题是 <code>安全访问控制</code>，而安全访问控制功能其实就是对所有进入系统的请求进行<code>拦截</code>，<code>校验每个请求是否能访问它所期望的资源</code>，根据前边知识的学习，可以通过Filter或AOP等技术来实现，Security 对Web资源的保护靠 Filter 实现， 索引从 Filter 技术入手，深入Security原理</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224211635903.png" srcset="/img/loading.gif" lazyload alt="image-20231224211635903" style="zoom:50%;" />

<p>FilterChainProxy是一个代理，真正起作用的是FilterChainProxy中的SecurityFilterChain (过滤器链) 所包含的各个Filter，同时这些Filter作为Bean被Spring管理，他们是Spring Security的核心，各有各的职责，但他们并不直接处理用户的<code>认证</code>，也不直接处理用户的授权，而是把他们交给认证管理器（AuthenticationManager）和决策管理器（AccessDecisionManager）来处理</p>
<p>Spring Security功能是实现主要由一系列过滤器链相互配合完成</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224212214373.png" srcset="/img/loading.gif" lazyload alt="image-20231224212214373"></p>
<p>下面介绍过滤器链中的主要的几个过滤器及其作用</p>
<p><code>SecurityContextPersistenceFilter</code> 这个Filter是整个拦截过程的<code>入口和出口</code>，也就是第一个和最后一个拦截器，会在请求开始时从配置好的SecurityContextRepository中获取SecurityContext，然后把它设置给SecurityContextHolder，在请求完成后将SecurityContextHolder持有的SecurityContext再保存到配置好的SecurityContextRepository，同时清除securityContextHolder 所持有的SecurityContext；</p>
<p><code>UsernamePasswordAuthenticationFilter</code> 用于处理来自表单提交的<code>认证</code>，该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的AuthenticationSuccessHandler 和 AuthenticationFailureHandler，这些都可以根据需求做相关改变；</p>
<p><code>FilterSecurityInterceptor</code> 用于保护web资源的，使用AccessDecisionManager对当前用户进行<code>授权</code>访问，签名已经详细访问过了；</p>
<p><code>ExceptionTranslationFilter</code> 能够捕获来自 FilterChain 的所有异常，并进行处理，但它只会处理两类异常： AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。</p>
<p>Spring Security的执行流程如下：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224213256012.png" srcset="/img/loading.gif" lazyload alt="image-20231224213256012"></p>
<ol>
<li>用户提交用户名，密码被SecurityFilterChain中的  <code>UsernamePasswordAuthenticationFilter</code>过滤器获取到，封装为请求Authentication，通常情况下是 UsernamePasswordAuthenticationToken 实现类</li>
<li>然后过滤器将<code>Authentication</code>提交至认证管理器<code>AuthenticationManager</code>进行认证。</li>
<li>认证成功后， <code>AuthenticationManager</code>身份管理器返回一个被填充满了信息的 (权限信息，身份信息，细节信息，但密码通常会被删除) <code>Authentication</code> 实例</li>
<li><code>SecurityContextHolder</code> 安全上下文容器将第3步填充了信息的 <code>Authentication</code>，通过SecurityContextHolder.getContext().setAuthentication(…)方法，设置到其中。</li>
<li>可以看出<code>AuthenticationManager</code>接口（<code>认证管理器</code>）是认证相关的核心接口，也是发起认证的出发点，他的实现类是 <code>ProviderManager</code>，而 Spring Security 支持多种认证方式，因此 <code>ProviderManager</code> 维护了一个 <code>List&lt;AuthenticationProvider&gt;</code> 列表，支持多种认证方式，最终实际的认证工作是由 <code>AuthenticationProvider</code> 完成的。<strong>Web表单</strong>对应 -&gt; 的<code>AuthentitaionProvider</code>实现类是<code>DaoAuthenticationProvider</code>，它的内部维护着一个 <code>UserDetailsService</code> 负责 <code>UserDetails</code> 的获取，最终<code> AuthenticationProvider</code> 将 <code>UserDetails</code> 填充到 <code>Authentication</code></li>
</ol>
<h4 id="什么是OAuth2"><a href="#什么是OAuth2" class="headerlink" title="什么是OAuth2"></a>什么是OAuth2</h4><h5 id="OAuth2认证流程"><a href="#OAuth2认证流程" class="headerlink" title="OAuth2认证流程"></a>OAuth2认证流程</h5><p>前面提到<code>微信扫码认证</code>，这是一种<code>第三方认证</code>方式，这种认证方式基于 OAuth2 协议实现的</p>
<p>OAuth 协议为用户资源提供一个安全，开放，简易的标准。同时，任何第三方都可以使用 OAuth 认证服务，任何服务提供商都可以实现自身的OAuth认证服务，因而OAuth是开放的。业界提供了OAuth的多种实现入PHP，JS，JAVA，Ruby等语言开发包，节约程序员时间，因此OAUTH是简易的。互联网很多服务如Open API，很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。</p>
<p>Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/oAuth/7153134?fr=aladdin">https://baike.baidu.com/item/oAuth/7153134?fr=aladdin</a></p>
<p>Oauth协议：<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a></p>
<p>下面分析一个 Oauth2 认证的例子，黑马程序员网站使用微信认证扫码登录过程：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224215931088.png" srcset="/img/loading.gif" lazyload alt="image-20231224215931088"></p>
<p>具体流程如下：</p>
<ol>
<li>用户点击微信扫码</li>
</ol>
<p>用户进入黑马程序登录页面，点击微信图标打开微信扫码页面</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224220018348.png" srcset="/img/loading.gif" lazyload alt="image-20231224220018348" style="zoom:50%;" /><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224220029966.png" srcset="/img/loading.gif" lazyload alt="image-20231224220029966" style="zoom: 33%;" /></p>
<p>微信扫码目的是通过微信获取当前用户的身份信息才会让当前用户在黑马网站登录成功</p>
<p>现在搞清几个概念？</p>
<p>资源：用户信息，在微信中存储</p>
<p>资源拥有者：用户是用户信息资源的拥有者</p>
<p>认证服务：微信负责认证当前用户的身份，负责为客户端颁发令牌</p>
<p>客户端：客户端会携带令牌请求微信获取用户信息，黑马程序网站即客户端，黑马网站需在浏览器打开</p>
<ol start="2">
<li>用户授权黑马网站访问用户信息</li>
</ol>
<p>资源拥有者扫描二维码表示资源拥有者请求微信进行认证，微信认证通过向用户手机返回授权页面，如下图：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224221619711.png" srcset="/img/loading.gif" lazyload alt="image-20231224221619711" style="zoom:50%;" />

<p>询问用户是否授权黑马程序员访问自己在微信的用户信息，用户点击“确认登录”表示同意授权，微信认证服务器颁发一个授权码给黑马程序员网站</p>
<p>只有资源拥有者同意，微信才允许黑马网站访问资源</p>
<ol start="3">
<li>黑马程序员网站获取一个<code>授权码</code></li>
<li>携带授权码请求微信认证服务器申请令牌，此交互过程用户看不到</li>
<li>微信认证服务器向黑马程序员网站响应令牌，此交互过程用户看不到</li>
<li>黑马程序员网站请求微信资源服务器获取资源即用户信息，黑马程序员网站携带<code>令牌</code>请求访问微信服务器获取用户基本信息</li>
<li>资源服务器返回受保护的资源，即用户信息</li>
<li>黑马网站接收到用户信息，此时用户在黑马网站登录成功</li>
</ol>
<p>理解了微信扫码登录黑马网站流程，接下来认识Oauth2.0的认证流程，如下：</p>
<p>引自Oauth2.0协议rfc6749 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a></p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224222136941.png" srcset="/img/loading.gif" lazyload alt="image-20231224222136941" style="zoom:50%;" />

<p>Oauth2包括以下角色：</p>
<p>1、客户端</p>
<p>本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：手机客户端、浏览器等。</p>
<p>上边示例中黑马网站即为客户端，它需要通过浏览器打开。</p>
<p>2、资源拥有者</p>
<p>通常为用户，也可以是应用程序，即该资源的拥有者。</p>
<p>A表示 客户端请求资源拥有者授权。</p>
<p>B表示 资源拥有者授权客户端即黑马网站访问自己的用户信息。</p>
<p>3、授权服务器（也称认证服务器）</p>
<p>认证服务器对资源拥有者进行认证，还会对客户端进行认证并颁发令牌。</p>
<p>C 客户端即黑马网站携带授权码请求认证。</p>
<p>D认证通过颁发令牌。</p>
<p>4、资源服务器</p>
<p>存储资源的服务器。</p>
<p>E表示客户端即黑马网站携带令牌请求资源服务器获取资源。</p>
<p>F表示资源服务器校验令牌通过后提供受保护资源。</p>
<h5 id="OAuth2在本项目的应用"><a href="#OAuth2在本项目的应用" class="headerlink" title="OAuth2在本项目的应用"></a>OAuth2在本项目的应用</h5><p>Oauth2是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用Oauth2，本项目使用Oauth2实现如下目标：</p>
<p>1、学成在线访问第三方系统的资源。</p>
<p>本项目要接入微信扫码登录所以本项目要使用OAuth2协议访问微信中的用户信息。</p>
<p>2、外部系统访问学成在线的资源 。</p>
<p>同样当第三方系统想要访问学成在线网站的资源也可以基于OAuth2协议。</p>
<p>3、学成在线前端（客户端） 访问学成在线微服务的资源。</p>
<p>本项目是前后端分离架构，前端访问微服务资源也可以基于OAuth2协议进行认证。</p>
<h5 id="OAuth2的授权模式"><a href="#OAuth2的授权模式" class="headerlink" title="OAuth2的授权模式"></a>OAuth2的授权模式</h5><p>四种模式中<code>授权码模式</code>和<code>密码模式</code>应用Spring Security支持OAuth2认证，<code>OAuth2</code>提供授权码模式、密码模式、简化模式、客户端模式等<code>四种授权模式</code>，前边举的微信扫码登录的例子就是基于<code>授权码模式</code>，这较多，本节使用Spring Security演示<code>授权码模式、密码模式</code>，其余两种请自行查阅相关资料。</p>
<h6 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h6><p>OAuth2的几个授权模式是根据不同的应用场景以不同的方式去获取令牌，最终目的是要获取认证服务颁发的令牌，最终通过令牌去获取资源。</p>
<p>授权码模式简单理解是使用<code>授权码</code>去<code>获取令牌</code>，要想获取令牌先要<code>获取授权码</code>，授权码的获取需要资源拥有者亲自<code>授权同意</code>才可以获取。</p>
<p>下图是授权码模式的交互图：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224233859129.png" srcset="/img/loading.gif" lazyload alt="image-20231224233859129" style="zoom:50%;" />

<p>以黑马网站微信扫码登录为例进行说明：</p>
<ol>
<li>用户打开浏览器</li>
<li>通过浏览器访问客户端（黑马网站）</li>
<li>用户通过浏览器向认证服务请求<strong>授权</strong>，请求授权时会携带客户端的URL，此URL为下发授权码的重定向地址</li>
<li>认证服务向资源拥有者返回授权页面</li>
<li>资源拥有者亲自授权同意</li>
<li>通过浏览器向认证服务发送授权同意</li>
<li>认证服务向客户端地址重定向并携带授权码</li>
<li>客户端收到授权码</li>
<li>客户端携带授权码向认证服务申请令牌</li>
<li>认证服务向客户端颁发令牌</li>
</ol>
<pre><code class=" mermaid">graph LR
用户 --授权同意--&gt; 客户端 --发送授权同意--&gt; 认证服务
认证服务1 --授权码--&gt; 客户端1
客户端2 --携带授权码申请令牌--&gt; 认证服务2
认证服务3 --颁发令牌--&gt; 客户端3
</code></pre>

<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231224235114107.png" srcset="/img/loading.gif" lazyload alt="image-20231224235114107"></p>
<h6 id="授权码模式测试"><a href="#授权码模式测试" class="headerlink" title="授权码模式测试"></a>授权码模式测试</h6><p>1、从课程资料中拷贝 AuthorizationServer.java、TokenConfig.java到认证服务的config包下。</p>
<p>说明“：AuthorizationServer用 @EnableAuthorizationServer 注解标识并继承AuthorizationServerConfigurerAdapter来配置OAuth2.0 授权服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.auth.config;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpMethod;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.AuthorizationServerTokenServices;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 授权服务器配置</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/26 22:25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableAuthorizationServer</span> <span class="hljs-comment">//启用授权服务器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationServer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizationServerConfigurerAdapter</span> &#123;<br></code></pre></td></tr></table></figure>

<p>AuthorizationServerConfigurerAdapter要求配置以下几个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationServerConfigurerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthorizationServerConfigurer</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AuthorizationServerConfigurerAdapter</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerSecurityConfigurer security)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li>ClientDetailsServiceConfigurer 用来配置客户端详情服务（ClientDetailsService），随便一个客户端都可以随便接入到它的认证服务吗？错，服务提供商会给批准介入的客户端一个<code>身份</code>，用于接入时的<code>凭据</code>，有<code>客户端标识和客户端密钥</code>，在这里配置批准介入的<code>客户端的详细信息</code></li>
<li>AuthorizationServerEndpointsConfigurer 用来配置令牌（token）的访问端点和令牌服务（token services）</li>
<li>AuthorizationServerSecurityConfigurer：用来配置令牌端点的安全约束.</li>
</ol>
<p>2.TokenConfig为令牌策略配置类</p>
<p>暂时先使用InMemoryTokenStore在内存存储令牌，令牌的有效期等信息配置如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//令牌管理服务</span><br><span class="hljs-meta">@Bean(name=&quot;authorizationServerTokenServicesCustom&quot;)</span><br><span class="hljs-keyword">public</span> AuthorizationServerTokenServices <span class="hljs-title function_">tokenService</span><span class="hljs-params">()</span> &#123;<br>    DefaultTokenServices service=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTokenServices</span>();<br>    service.setSupportRefreshToken(<span class="hljs-literal">true</span>);<span class="hljs-comment">//支持刷新令牌</span><br>    service.setTokenStore(tokenStore);<span class="hljs-comment">//令牌存储策略</span><br>    service.setAccessTokenValiditySeconds(<span class="hljs-number">7200</span>); <span class="hljs-comment">// 令牌默认有效期2小时</span><br>    service.setRefreshTokenValiditySeconds(<span class="hljs-number">259200</span>); <span class="hljs-comment">// 刷新令牌默认有效期3天</span><br>    <span class="hljs-keyword">return</span> service;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.配置认证管理bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-comment">// 配置认证管理bean</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>重启认证服务</p>
<blockquote>
<p>注意：关闭所有代理</p>
</blockquote>
<ol>
<li>get请求获取授权码</li>
</ol>
<p>地址: </p>
<p><a target="_blank" rel="noopener" href="http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&response_type=code&scope=all&redirect_uri=http://www.51xuecheng.cn">http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</a></p>
<p>参数列表如下：</p>
<p>•     client_id：客户端准入标识。</p>
<p>•     response_type：授权码模式固定为code。</p>
<p>•     scope：客户端权限。</p>
<p>•     redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）。</p>
<p>输入账号zhangsan、密码123登录成功，输入&#x2F;oauth&#x2F;authorize?client_id&#x3D;XcWebApp&amp;response_type&#x3D;code&amp;scope&#x3D;all&amp;redirect_uri&#x3D;<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/">http://www.51xuecheng.cn</a></p>
<p>显示授权页面</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226100944623.png" srcset="/img/loading.gif" lazyload alt="image-20231226100944623"></p>
<p>授权“XcWebApp”访问自己的受保护资源?</p>
<p>选择同意。</p>
<p>2、请求成功，重定向至<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/?code=%E6%8E%88%E6%9D%83%E7%A0%81%EF%BC%8C%E6%AF%94%E5%A6%82%EF%BC%9Ahttp://www.51xuecheng.cn/?code=Wqjb5H">http://www.51xuecheng.cn/?code=授权码，比如：http://www.51xuecheng.cn/?code=Wqjb5H</a></p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226101103155.png" srcset="/img/loading.gif" lazyload alt="image-20231226101103155" style="zoom:50%;" />

<p>3、使用httpclient工具post申请令牌</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">### 授权码模式<br>### 第一步申请授权码(浏览器请求)/oauth/authorize?client_id=c1&amp;response_type=code&amp;scope=all&amp;redirect_uri=http<span class="hljs-punctuation">:</span><span class="hljs-comment">//www.51xuecheng.cn</span><br>### 第二步申请令牌<br>### 将授权码进行替换<br>###### 授权码模式<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>auth_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=authorization_code&amp;code=<span class="hljs-number">8</span>k39Al&amp;redirect_uri=http<span class="hljs-punctuation">:</span><span class="hljs-comment">//www.51xuecheng.cn</span><br></code></pre></td></tr></table></figure>

<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226104100548.png" srcset="/img/loading.gif" lazyload alt="image-20231226104100548"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;access_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0f7edccc-7a63-44b0-a520-963198dbca90&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;token_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bearer&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;refresh_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;b0d51a8f-1bbf-44a3-be7b-794953208b20&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;expires_in&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7199</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;scope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;all&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>说明：</p>
<p>1、access_token，访问令牌，用于访问资源使用。</p>
<p>2、token_type，bearer是在RFC6750中定义的一种token类型，在携带令牌访问资源时需要在head中加入bearer 空格 令牌内容</p>
<p>3、refresh_token，当令牌快过期时使用刷新令牌可以再次生成令牌。</p>
<p>4、expires_in：过期时间（秒）</p>
<p>5、scope，令牌的权限范围，服务端可以根据令牌的权限范围去对令牌授权。</p>
<h6 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h6><p>密码模式相对授权码模式简单，授权码模式需要借助浏览器供用户亲自授权，密码模式不用借助浏览器，如下图：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226104244665.png" srcset="/img/loading.gif" lazyload alt="image-20231226104244665" style="zoom:50%;" />

<ol>
<li>资源拥有者提供账号和密码</li>
<li>客户端向认证服务申请令牌，请求中携带账号和密码</li>
<li>认证服务校验账号密码正确，颁发令牌</li>
</ol>
<p>开始测试：</p>
<p>1、POST请求获取令牌</p>
<p>&#x2F;oauth&#x2F;token?client_id&#x3D;XcWebApp&amp;client_secret&#x3D;XcWebApp&amp;grant_type&#x3D;password&amp;username&#x3D;shangsan&amp;password&#x3D;123</p>
<p>参数列表如下：</p>
<p>•     client_id：客户端准入标识。</p>
<p>•     client_secret：客户端秘钥。</p>
<p>•     grant_type：授权类型，填写password表示密码模式</p>
<p>•     username：资源拥有者用户名。</p>
<p>•     password：资源拥有者密码。</p>
<p>2、授权服务器将令牌（access_token）发送给client</p>
<p>使用httpclient进行测试</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dts">Java<br><span class="hljs-meta">### 密码模式</span><br><span class="hljs-title class_">POST</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>auth_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">/auth/</span>oauth/token?client_<span class="hljs-attr">id</span><span class="hljs-operator">=</span>XcWebApp<span class="hljs-variable">&amp;client_secret</span>=XcWebApp<span class="hljs-variable">&amp;grant_type</span>=password<span class="hljs-variable">&amp;username</span>=zhangsan<span class="hljs-variable">&amp;password</span>=<span class="hljs-number">123</span><br><br></code></pre></td></tr></table></figure>

<p>返回示例：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226104446104.png" srcset="/img/loading.gif" lazyload alt="image-20231226104446104"></p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">JSON</span><br>&#123;<br>  <span class="hljs-string">&quot;access_token&quot;</span>: <span class="hljs-string">&quot;368b1ee7-a9ee-4e9a-aae6-0fcab243aad2&quot;</span>,<br>  <span class="hljs-string">&quot;token_type&quot;</span>: <span class="hljs-string">&quot;bearer&quot;</span>,<br>  <span class="hljs-string">&quot;refresh_token&quot;</span>: <span class="hljs-string">&quot;3d56e139-0ee6-4ace-8cbe-1311dfaa991f&quot;</span>,<br>  <span class="hljs-string">&quot;expires_in&quot;</span>: <span class="hljs-number">6806</span>,<br>  <span class="hljs-string">&quot;scope&quot;</span>: <span class="hljs-string">&quot;all&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这种模式十分简单，但是却意味着直接将<code>用户敏感信息泄漏</code>给了client，因此这就说明这种模式只能用于client是我们自己开发的情况下。</p>
<h6 id="本项目的应用方式"><a href="#本项目的应用方式" class="headerlink" title="本项目的应用方式"></a>本项目的应用方式</h6><p>通过演示授权码模式和密码模式，授权码模式适合客户端和认证服务非同一个系统的情况，所以本项目使用授权码模式完成微信扫码认证。本项目采用密码模式作为前端请求微服务的认证方式。</p>
<h4 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h4><h5 id="普通令牌的问题"><a href="#普通令牌的问题" class="headerlink" title="普通令牌的问题"></a>普通令牌的问题</h5><p>客户申请到令牌，接下来客户端携带令牌去访问资源，到资源服务器将会校验令牌合法性</p>
<p>资源服务器如何校验令牌的合法性？</p>
<p>我们以OAuth2的密码模式为例进行说明：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226113249085.png" srcset="/img/loading.gif" lazyload alt="image-20231226113249085" style="zoom:50%;" />

<p>从第4步开始说明：</p>
<ol>
<li>客户端携带令牌访问资源服务获取资源</li>
<li>资源服务远程请求认证服务校验令牌合法性</li>
<li>如果令牌合法资源服务向客户端返回资源</li>
</ol>
<p>这里有一个问题：</p>
<p>校验令牌需要远程请求认证服务，客户端每次访问都会远程校验，执行性能低，如果让资源服务自己校验令牌合法性将省去远程请求认证服务的成本，提高性能</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226113456327.png" srcset="/img/loading.gif" lazyload alt="image-20231226113456327" style="zoom:50%;" />

<p>如何解决上面问题，实现资源服务自行校验令牌</p>
<p>令牌采用JWT格式即可解决上面问题，用户认证通过后得到一个JWT令牌</p>
<p>JWT令牌包括用户相关的信息，客户端只需要携带JWT访问资源服务，资源服务根据事先约定的算法自行完成令牌校验，无需每次请求认证服务完成授权</p>
<h5 id="什么是JWT"><a href="#什么是JWT" class="headerlink" title="什么是JWT"></a>什么是JWT</h5><p>JSON Web Token JWT 是一种使用JSON格式传递网络令牌技术，它是一个开放的行业标准（RFC 7519），它定义了一种简洁的、自包含的协议格式，用于通信双方传递json对象，传递的信息经过数字签名可以被验证和信任，可以使用HMAC算法或使用RSA的公钥&#x2F;私钥来签名，防止内容篡改。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a></p>
<p>使用JWT可以实现无状态认证，什么是无状态认证？</p>
<p>传统基于session的方式是有状态认证，用户登录成功将<code>用户身份信息存储在服务端</code>，加大了服务端的存储压力，并且这种方式不适合分布式系统应用</p>
<p>如图，当用户访问应用服务，每个应用服务都会去服务器查看session信息，如果session中没有该用户则说明用户没有登录，此时会重新认证，而解决这个问题的方法是session复制&#x2F;粘贴<br><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226114121004.png" srcset="/img/loading.gif" lazyload alt="image-20231226114121004" style="zoom:50%;" /></p>
<p>如果基于令牌技术在分布式系统实现认证则服务端不用存储session，可以将用户信息存在令牌，用户认证通过认证服务颁发令牌，用户将令牌存在客户端，去访问应用服务携带令牌，服务端从jwt解析用户信息，这个过程是无状态认证</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226114240112.png" srcset="/img/loading.gif" lazyload alt="image-20231226114240112" style="zoom:50%;" />

<p>jwt令牌优点：</p>
<ol>
<li>基于json，方便解析</li>
<li>在令牌自定义内容，易于扩展</li>
<li>通过非对称加密算法及数字签字技术，jwt防止篡改，安全</li>
<li>资源服务使用jwt可以不依赖认证服务即可完成授权</li>
</ol>
<p>缺点：</p>
<p>１、JWT令牌较长，占存储空间比较大。</p>
<p>下边是一个JWT令牌的示例：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Plain</span> <span class="hljs-built_in">Text</span><br><span class="hljs-variable">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><span class="hljs-operator">.</span><span class="hljs-variable">eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQyNTQ2NzIsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijg4OTEyYjJkLTVkMDUtNGMxNC1iYmMzLWZkZTk5NzdmZWJjNiIsImNsaWVudF9pZCI6ImMxIn0</span><span class="hljs-operator">.</span><span class="hljs-variable">wkDBL7roLrvdBG2oGnXeoXq</span><span class="hljs-operator">-</span><span class="hljs-variable">zZRgE9IVV2nxd</span><span class="hljs-operator">-</span><span class="hljs-type">ez_oA</span><br><br></code></pre></td></tr></table></figure>

<p>jwt令牌由3部分组成，中间使用点分隔， 比如： xxxxx.yyyyy.zzzzz</p>
<ol>
<li>Header</li>
</ol>
<p>头部包括令牌的类型(jwt)，及哈希算法</p>
<p>一个例子如下：</p>
<p> 下边是Header部分的内容</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">JSON<br>   <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;alg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HS256&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;typ&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JWT&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure>

<p> 将上边的内容使用Base64Url编码，得到一个字符串就是JWT令牌的第一部分。</p>
<ol start="2">
<li>Payload</li>
</ol>
<p>第二部分是负载，内容是一个json对象，是存放有效信息的地方，可以存放jwt提供的信息字段，比如：iss（签发者）exp（过期时间戳）sub（面向的用户）等，可以自定义字段</p>
<p> 此部分不建议存放敏感信息，因为此部分可以解码还原原始内容。</p>
<p>最后将第二部分负载使用Base64Url编码，得到一个字符串就是JWT令牌的第二部分。</p>
<p> 一个例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;sub&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1234567890&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;456&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;admin&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>Signature</li>
</ol>
<p> 第三部分是签名，此部分用于防止jwt内容被篡改。</p>
<p> 这个部分使用base64url将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用header中声明的签名算法进行签名。</p>
<p> 一个例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JSON">HMACSHA256(<br>  base64UrlEncode(header) + <span class="hljs-string">&quot;.&quot;</span> +<br>  base64UrlEncode(payload)<span class="hljs-punctuation">,</span><br>  secret)<br><br></code></pre></td></tr></table></figure>

<p>base64UrlEncode(header)：jwt令牌的第一部分。</p>
<p>base64UrlEncode(payload)：jwt令牌的第二部分。</p>
<p>secret：签名所使用的密钥。</p>
<p><code>为什么JWT可以防止篡改？</code></p>
<p>第三部分使用签名算法对第一部分和第二部分的内容进行签名，常用的签名算法是 HS256，常见的还有md5,sha 等，签名算法需要使用密钥进行签名，密钥不对外公开，并且签名是不可逆的，如果第三方更改了内容那么服务器验证签名就会失败，要想保证验证签名正确必须保证内容、密钥与签名前一致。</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226114917649.png" srcset="/img/loading.gif" lazyload alt="image-20231226114917649" style="zoom:50%;" />

<p>从上图可以看出认证服务和资源服务使用相同的密钥，这叫对称加密，对称加密效率高，如果一旦密钥泄露可以伪造jwt令牌。</p>
<p>JWT还可以使用非对称加密，认证服务自己保留私钥，将公钥下发给受信任的客户端、资源服务，公钥和私钥是配对的，成对的公钥和私钥才可以正常加密和解密，非对称加密效率低但相比对称加密非对称加密更安全一些。</p>
<h5 id="测试生成JWT令牌"><a href="#测试生成JWT令牌" class="headerlink" title="测试生成JWT令牌"></a>测试生成JWT令牌</h5><p>在认证服务中配置jwt令牌服务，即可实现生成jwt格式的令牌, </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.auth.config;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.AuthorizationServerTokenServices;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultTokenServices;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancerChain;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Administrator</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenConfig</span> &#123;<br><br>    <span class="hljs-comment">// 密钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">SIGNING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mq123&quot;</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    TokenStore tokenStore;<br><br>    <span class="hljs-comment">/*@Bean</span><br><span class="hljs-comment">    public TokenStore tokenStore() &#123;</span><br><span class="hljs-comment">        //使用内存存储令牌（普通令牌）</span><br><span class="hljs-comment">        return new InMemoryTokenStore();</span><br><span class="hljs-comment">    &#125;*/</span><br><br>    <span class="hljs-comment">//Jwt 访问令牌转换器</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JwtAccessTokenConverter accessTokenConverter;<br><br>    <span class="hljs-comment">//令牌商店</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> TokenStore <span class="hljs-title function_">tokenStore</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenStore</span>(accessTokenConverter());<br>    &#125;<br><br>    <span class="hljs-comment">//访问令牌转换器</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title function_">accessTokenConverter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">JwtAccessTokenConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessTokenConverter</span>();<br>        converter.setSigningKey(SIGNING_KEY);<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br><br>    <span class="hljs-comment">//令牌管理服务</span><br>    <span class="hljs-meta">@Bean(name=&quot;authorizationServerTokenServicesCustom&quot;)</span><br>    <span class="hljs-keyword">public</span> AuthorizationServerTokenServices <span class="hljs-title function_">tokenService</span><span class="hljs-params">()</span> &#123;<br>        DefaultTokenServices service=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTokenServices</span>();<br>        service.setSupportRefreshToken(<span class="hljs-literal">true</span>);<span class="hljs-comment">//支持刷新令牌</span><br>        service.setTokenStore(tokenStore);<span class="hljs-comment">//令牌存储策略</span><br><br>        <span class="hljs-type">TokenEnhancerChain</span> <span class="hljs-variable">tokenEnhancerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenEnhancerChain</span>();<br>        tokenEnhancerChain.setTokenEnhancers(Arrays.asList(accessTokenConverter));<br>        service.setTokenEnhancer(tokenEnhancerChain);<br><br>        service.setAccessTokenValiditySeconds(<span class="hljs-number">7200</span>); <span class="hljs-comment">// 令牌默认有效期2小时</span><br>        service.setRefreshTokenValiditySeconds(<span class="hljs-number">259200</span>); <span class="hljs-comment">// 刷新令牌默认有效期3天</span><br>        <span class="hljs-keyword">return</span> service;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226120332267.png" srcset="/img/loading.gif" lazyload alt="image-20231226120332267"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;access_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE3MDM1NzA1ODAsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6IjZlZTMyNjUzLTlmMzctNGE2My04NTY1LTQ0ODgwNjFlOGZiZCIsImNsaWVudF9pZCI6IlhjV2ViQXBwIn0.2romuPqN8siRBX9B65wgpaZL5bfatPWNSLdfUW3oK6g&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;token_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bearer&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;refresh_token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJhdGkiOiI2ZWUzMjY1My05ZjM3LTRhNjMtODU2NS00NDg4MDYxZThmYmQiLCJleHAiOjE3MDM4MjI1ODAsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImM4MmQyNmNkLWQ1MjItNDE1Zi05ZGZmLWMxODI5YjI3YzQwMiIsImNsaWVudF9pZCI6IlhjV2ViQXBwIn0.iKX8dG0EQzM_UoS_1l70XkpjOJoUeav19ln4Q6aWmOU&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;expires_in&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7199</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;scope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;all&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;jti&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;6ee32653-9f37-4a63-8565-4488061e8fbd&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ol>
<li>access_token:  生成的jwt令牌，用户访问资源使用</li>
<li>token_type, bearer是在RFC6750中定义的一种token类型，在携带jwt访问资源时需要在head中加入bearer jwt令牌内容</li>
<li>refresh_token，当jwt令牌快过期时使用刷新令牌可以再次生成jwt令牌。</li>
<li>expires_in：过期时间（秒）</li>
<li>scope，令牌的<code>权限范围</code>，服务端可以根据令牌的权限范围去<code>对令牌授权。 </code></li>
<li>jti：令牌的唯一标识。</li>
</ol>
<p>我们可以通过check_token接口校验jwt令牌</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">### 校验jwt令牌<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>auth_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJzdHUxIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY2NDM3MTc4MCwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiZjBhM2NkZWItMzk5ZC00OGYwLTg4MDQtZWNhNjM4YWQ4ODU3IiwiY2xpZW50X2lkIjoiYzEifQ.qy46CSCJsH3eXWTHgdcntZhzcSzfRQlBU0dxAjZcsUw<br></code></pre></td></tr></table></figure>

<p>响应示例如下：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226120801314.png" srcset="/img/loading.gif" lazyload alt="image-20231226120801314"></p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs prolog">&#123;<br>  <span class="hljs-string">&quot;aud&quot;</span>: [<br>    <span class="hljs-string">&quot;xuecheng-plus&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;user_name&quot;</span>: <span class="hljs-string">&quot;zhangsan&quot;</span>,<br>  <span class="hljs-string">&quot;scope&quot;</span>: [<br>    <span class="hljs-string">&quot;all&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;active&quot;</span>: true,<br>  <span class="hljs-string">&quot;exp&quot;</span>: <span class="hljs-number">1703570580</span>,<br>  <span class="hljs-string">&quot;authorities&quot;</span>: [<br>    <span class="hljs-string">&quot;p1&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;jti&quot;</span>: <span class="hljs-string">&quot;6ee32653-9f37-4a63-8565-4488061e8fbd&quot;</span>,<br>  <span class="hljs-string">&quot;client_id&quot;</span>: <span class="hljs-string">&quot;XcWebApp&quot;</span><br>&#125;		<br></code></pre></td></tr></table></figure>

<h5 id="测试资源服务校验令牌"><a href="#测试资源服务校验令牌" class="headerlink" title="测试资源服务校验令牌"></a>测试资源服务校验令牌</h5><p>拿到了jwt令牌下一步是携带令牌访问资源服务的资源，本项目各个微服务是资源服务，比如：内容管理服务，客户端申请到jwt令牌，携带jwt去内容管理服务查询课程信息，此时内容管理服务对jwt去校验，只有jwt合法才能继续访问，如图：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226122508837.png" srcset="/img/loading.gif" lazyload alt="image-20231226122508837"></p>
<p>1、在内容管理服务的content-api工程中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--认证相关--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>2、在内容管理服务的content-api工程中添加TokenConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.content.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Administrator</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenConfig</span> &#123;<br><br>    <span class="hljs-comment">//jwt签名密钥,与认证服务保持一致</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">SIGNING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mq123&quot;</span>;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> TokenStore <span class="hljs-title function_">tokenStore</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//JWT令牌存储方案</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenStore</span>(accessTokenConverter());<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title function_">accessTokenConverter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">JwtAccessTokenConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessTokenConverter</span>();<br>        converter.setSigningKey(SIGNING_KEY);<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br><br>   <span class="hljs-comment">/* @Bean</span><br><span class="hljs-comment">    public TokenStore tokenStore() &#123;</span><br><span class="hljs-comment">        //使用内存存储令牌（普通令牌）</span><br><span class="hljs-comment">        return new InMemoryTokenStore();</span><br><span class="hljs-comment">    &#125;*/</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>3、添加资源服务配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.config;<br><br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Administrator</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableResourceServer</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResouceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ResourceServerConfigurerAdapter</span> &#123;<br><br><br>    <span class="hljs-comment">//资源服务标识</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RESOURCE_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;xuecheng-plus&quot;</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    TokenStore tokenStore;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ResourceServerSecurityConfigurer resources)</span> &#123;<br>        resources.resourceId(RESOURCE_ID)<span class="hljs-comment">//资源 id</span><br>                .tokenStore(tokenStore)<br>                .stateless(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.csrf().disable()<br>                .authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/r/**&quot;</span>,<span class="hljs-string">&quot;/course/**&quot;</span>).authenticated()<span class="hljs-comment">//所有/r/**的请求必须认证通过</span><br>                .anyRequest().permitAll()<br>        ;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据配置可知&#x2F;course&#x2F;**开头的接口需要认证通过。</p>
<p>重启内容管理服务</p>
<p>使用httpclient测试：</p>
<p>1、访问根据课程id查询课程接口</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">GET http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:63040/content/course/2</span><br></code></pre></td></tr></table></figure>

<p>返回未认证</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs smalltalk">&#123;<br>  <span class="hljs-comment">&quot;error&quot;</span>: <span class="hljs-comment">&quot;unauthorized&quot;</span>,<br>  <span class="hljs-comment">&quot;error_description&quot;</span>: <span class="hljs-comment">&quot;Full authentication is required to access this resource&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>从返回信息可知当前没有认证。</p>
<p>下边携带JWT令牌访问接口：</p>
<p>1、申请jwt令牌</p>
<p>采用密码模式申请令牌。</p>
<p>2、携带jwt令牌访问资源服务地址</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Plain</span> Text<br><span class="hljs-comment">### 携带token访问资源服务</span><br><span class="hljs-attribute">GET</span> http://localhost:<span class="hljs-number">63040</span>/content/course/<span class="hljs-number">2</span><br><span class="hljs-attribute">Authorization</span>: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzMzM0OTgsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6IjhhM2M2OTk1LWU1ZGEtNDQ1Yy05ZDAyLTEwNDFlYzk3NTkwOSIsImNsaWVudF9pZCI6ImMxIn0.<span class="hljs-number">73</span>eNDxTX5ifttGCjwc7xrd-Sbp_mCfcIerI3lGetZto<br><br></code></pre></td></tr></table></figure>

<p>如果携带jwt令牌且jwt正确则正常访问资源服务的内容。</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226154848189.png" srcset="/img/loading.gif" lazyload alt="image-20231226154848189"></p>
<p>如果不正确则报令牌无效的错误：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">JSON<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;invalid_token&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;error_description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Cannot convert access token to JSON&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure>

<h5 id="测试获取用户身份"><a href="#测试获取用户身份" class="headerlink" title="测试获取用户身份"></a>测试获取用户身份</h5><p>jwt令牌记录了用户身份信息，当客户端携带jwt访问资源服务，资源服务校验通过后将前两部分内容<code>还原</code>即可取出用户身份信息，将用户身份信息放在SecurityContextHolder上下文，SecurityContext和当前线程绑定，方便获取用户身份</p>
<p>以查询课程接口为例，进入查询课程接口代码，添加获取用户身份的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;根据课程id查询课程基础信息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/course/&#123;courseId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">getCourseBaseById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;<br>    <span class="hljs-comment">//取出当前用户身份</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication().getPrincipal();<br>    System.out.println(principal);<br>    <span class="hljs-keyword">return</span> courseBaseInfoService.getCourseBaseInfo(courseId);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试时注意：</p>
<ol>
<li>在资源服务配置中指定安全拦截机制&#x2F;course&#x2F;开头的请求需要认证，即请求&#x2F;course&#x2F;{courseId}接口需要携带jwt令牌且签证通过</li>
<li>认证服务生成jwt令牌将用户身份信息写入令牌，认证服务在哪里获取用户身份</li>
</ol>
<p>目前是将用户信息硬编码并暂存到内存中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span><br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;zhangsan&quot;</span>).password(<span class="hljs-string">&quot;123&quot;</span>).authorities(<span class="hljs-string">&quot;p1&quot;</span>).build());<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;lisi&quot;</span>).password(<span class="hljs-string">&quot;456&quot;</span>).authorities(<span class="hljs-string">&quot;p2&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> manager;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>我们使用密码模式生成jwt令牌用的是zhangsan的信息，所以jwt令牌存储了zhangsan的信息，那在资源服务应该可以取出zhangsan的信息</li>
</ol>
<p>下面重启内容管理服务，跟踪到用户身份是否正确</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226160736318.png" srcset="/img/loading.gif" lazyload alt="image-20231226160736318" style="zoom:50%;" />

<h4 id="网关认证"><a href="#网关认证" class="headerlink" title="网关认证"></a><strong>网关认证</strong></h4><h5 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a><strong>技术方案</strong></h5><p>到目前为止，测试通过了认证服务颁发jwt令牌，客户端携带jwt访问资源服务，资源服务对jwt的合法性进行验证。如下图：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226161045777.png" srcset="/img/loading.gif" lazyload alt="image-20231226161045777"></p>
<p>仔细观察此图，遗漏了本项目架构中非常重要的组件：网关，加上网关并完善后如下图所示：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226161233377.png" srcset="/img/loading.gif" lazyload alt="image-20231226161233377" style="zoom:67%;" />

<p>所有访问微服务的请求经过网关，在网关进行用户<code>身份认证</code>将很多非法的请求拦截到微服务外，这叫做网关认证</p>
<p>下面需要明确网关的职责：</p>
<ol>
<li>网站白名单维护</li>
</ol>
<p>针对不用认证的URL全部放行</p>
<ol start="2">
<li>校验jwt的合法性</li>
</ol>
<p>除了白名单剩下的是需要认证的请求，网关需要校验jwt的合法性，jwt合法则说明用户身份合法，否则身份不合法则拒绝继续访问</p>
<p>网关负责授权吗？</p>
<p>网关不负责授权，对请求的	<code>授权</code>	操作在各个<code>微服务</code>进行，因为微服务最清楚用户有哪些权限访问哪些接口</p>
<h5 id="实现网关认证"><a href="#实现网关认证" class="headerlink" title="实现网关认证"></a>实现网关认证</h5><p>下边实现网关认证，实现以下职责：</p>
<ol>
<li>网站白名单维护</li>
</ol>
<p>针对不用认证的URL放行</p>
<ol start="2">
<li>校验jwt的合法性</li>
</ol>
<p>除了白名单剩下的就是需要认证的要求，网关需要验证jwt的合法性，jwt合法则说明用户身份合法，否则说明身份不合法则拒绝继续访问</p>
<p>1、在网关工程添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- spring security --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2、拷贝课程资料下网关认证配置类到网关工程的config包下。</p>
<p>3、配置白名单文件security-whitelist.properties</p>
<p>内容如下（持续补充）</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">/**</span>=<span class="hljs-string">临时全部放行</span><br><span class="hljs-attr">/auth/**</span>=<span class="hljs-string">认证地址</span><br><span class="hljs-attr">/content/open/**</span>=<span class="hljs-string">内容管理公开访问接口</span><br><span class="hljs-attr">/media/open/**</span>=<span class="hljs-string">媒资管理公开访问接口</span><br></code></pre></td></tr></table></figure>

<p>重启网关工程，进行测试</p>
<p>1、申请令牌</p>
<p>2、通过网关访问资源服务</p>
<p>这里访问内容管理服务</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">### 通过网关访问资源服务<br>GET http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:63010/content/course/2</span><br>Authorization<span class="hljs-punctuation">:</span> Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE3MDM1ODY1NTEsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImRjMzAxZTMxLTNjM2MtNGMzMS05ZWMxLTQxMzcyZjA5MDc4NyIsImNsaWVudF9pZCI6IlhjV2ViQXBwIn0<span class="hljs-number">.1</span>hOMXETZ7xb7jgjbQPnDlTtXUN7JS7y_rjtXRpLRdT8<br></code></pre></td></tr></table></figure>

<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226162949138.png" srcset="/img/loading.gif" lazyload alt="image-20231226162949138" style="zoom:50%;" />

<p>当token正确时可以正常访问资源服务，token验证失败返回token无效</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">JSON</span><br>&#123;<br>  <span class="hljs-string">&quot;errMessage&quot;</span>: <span class="hljs-string">&quot;认证令牌无效&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>注意：网关鉴权功能调试通过后，由于目前还没有开发认证功能，前端请求网关的URL不在白名单中间时会“没有认证”的错误，暂时在白名单中添加 全部放行配置，待认证功能开发完成再屏蔽全部放行配置，</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226163459122.png" srcset="/img/loading.gif" lazyload alt="image-20231226163459122" style="zoom:50%;" />

<h4 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h4><h5 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h5><p>至此我们了解了使用Spring Security进行认证授权的过程，本节实现<code>用户认证</code>功能。</p>
<p>目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。</p>
<p>本项目也要支持多种认证。</p>
<h5 id="连接用户中心数据库"><a href="#连接用户中心数据库" class="headerlink" title="连接用户中心数据库"></a>连接用户中心数据库</h5><h6 id="连接数据库认证"><a href="#连接数据库认证" class="headerlink" title="连接数据库认证"></a><strong>连接数据库认证</strong></h6><p>基于认证流程在研究Security过程已经测试通过，目前用户认证流程：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226163746443.png" srcset="/img/loading.gif" lazyload alt="image-20231226163746443"><br>认证需要的用户信息存储在用户中心数据库，现在需要将认证服务连接数据库查询用户信息。</p>
<p>在研究Security过程将<strong>用户信息硬编码</strong>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span><br>    <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;zhangsan&quot;</span>).password(<span class="hljs-string">&quot;123&quot;</span>).authorities(<span class="hljs-string">&quot;p1&quot;</span>).build());<br>    manager.createUser(User.withUsername(<span class="hljs-string">&quot;lisi&quot;</span>).password(<span class="hljs-string">&quot;456&quot;</span>).authorities(<span class="hljs-string">&quot;p2&quot;</span>).build());<br>    <span class="hljs-keyword">return</span> manager;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们要认证服务中连接用户中心数据库查询用户信息：</p>
<p>如何使用Security连接数据库认证？</p>
<p>前边学习Spring Security工作原理时有一张执行流程图，如下图：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226170841828.png" srcset="/img/loading.gif" lazyload alt="image-20231226170841828"></p>
<p>用户提交账号和密码由DaoAuthenticationProvider调用UserDetailsService的loadUserByUsername方法获取UserDetails用户信息</p>
<p>查询DaoAuthenticationProvider的源代码如下：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226170947053.png" srcset="/img/loading.gif" lazyload alt="image-20231226170947053"></p>
<p>UserDetailsService是一个接口，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.security.core.userdetails;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br>    UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String var1)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>UserDetails是用户信息接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br><br>    String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span>;<br><br>    String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>我们实现UserDetailsService接口查询数据库得到用户信息返回UserDetails类型的<code>用户信息</code>即可，框架调用loadUserByUsername()方法拿到用户信息之后如何执行的：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226171541617.png" srcset="/img/loading.gif" lazyload alt="image-20231226171541617" style="zoom:50%;" />

<p>首先屏蔽原来定义的UserDetailsService。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*//配置用户信息服务</span><br><span class="hljs-comment">@Bean</span><br><span class="hljs-comment">public UserDetailsService userDetailsService() &#123;</span><br><span class="hljs-comment">    //这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span><br><span class="hljs-comment">    InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();</span><br><span class="hljs-comment">    manager.createUser(User.withUsername(&quot;zhangsan&quot;).password(&quot;123&quot;).authorities(&quot;p1&quot;).build());</span><br><span class="hljs-comment">    manager.createUser(User.withUsername(&quot;lisi&quot;).password(&quot;456&quot;).authorities(&quot;p2&quot;).build());</span><br><span class="hljs-comment">    return manager;</span><br><span class="hljs-comment">&#125;*/</span><br></code></pre></td></tr></table></figure>

<p>下边自定义  UserDetailsService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 17:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br><br>    <span class="hljs-comment">//根据账号查询用户信息</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, s));<br>        <span class="hljs-keyword">if</span> (user==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//取出数据库存储的正确密码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-comment">//用户权限，如果不加报错  Cannot pass a null GrantedAuthority collection</span><br>        String[] authorities = &#123;<span class="hljs-string">&quot;test&quot;</span>&#125;; <span class="hljs-comment">//自定义假的权限</span><br>        <span class="hljs-comment">//创建UserDetails对象，权限信息待实现授权功能时再向UserDetail中加入</span><br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> User<br>                .withUsername(user.getUsername())<br>                .password(password)<br>                .authorities(authorities)<br>                .build();<br>        <span class="hljs-keyword">return</span> userDetails;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>数据库的密码加过密的，用户输入的密码是明文，我们需要修改密码格式器PasswordEncoder，原来使用的是NoOpPasswordEncoder，他是通过明文方式比较密码，现在我们修改为BCryptPasswordEncoder，将用户输入的密码编码未BCrypt格式与数据库中密码比对。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">//        //密码为明文方式</span><br><span class="hljs-comment">//        return NoOpPasswordEncoder.getInstance();</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p>我们通过测试代码测试BCryptPasswordEncoder，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;111111&quot;</span>;<br>    <span class="hljs-type">PasswordEncoder</span> <span class="hljs-variable">passwordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++) &#123;<br>        <span class="hljs-comment">//每个计算出的Hash值都不一样</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">hashPass</span> <span class="hljs-operator">=</span> passwordEncoder.encode(password);<br>        System.out.println(hashPass);<br>        <span class="hljs-comment">//虽然每次计算的密码Hash值不一样但是校验是通过的</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> passwordEncoder.matches(password, hashPass);<br>        System.out.println(f);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改数据库中的密码为Bcrypt格式，并且记录明文密码，稍后申请令牌时需要。</p>
<p>由于修改密码编码方式还需要将客户端的密钥更改为Bcrypt格式.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//客户端详情服务</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span><br>            <span class="hljs-keyword">throws</span> Exception &#123;<br>        clients.inMemory()<span class="hljs-comment">// 使用in-memory存储</span><br>                .withClient(<span class="hljs-string">&quot;XcWebApp&quot;</span>)<span class="hljs-comment">// client_id</span><br><span class="hljs-comment">//                .secret(&quot;secret&quot;)//客户端密钥</span><br>                .secret(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>().encode(<span class="hljs-string">&quot;XcWebApp&quot;</span>))<span class="hljs-comment">//客户端密钥</span><br>                .resourceIds(<span class="hljs-string">&quot;xuecheng-plus&quot;</span>)<span class="hljs-comment">//资源列表</span><br>                .authorizedGrantTypes(<span class="hljs-string">&quot;authorization_code&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>,<span class="hljs-string">&quot;client_credentials&quot;</span>,<span class="hljs-string">&quot;implicit&quot;</span>,<span class="hljs-string">&quot;refresh_token&quot;</span>)<span class="hljs-comment">// 该client允许的授权类型authorization_code,password,refresh_token,implicit,client_credentials</span><br>                .scopes(<span class="hljs-string">&quot;all&quot;</span>)<span class="hljs-comment">// 允许的授权范围</span><br>                .autoApprove(<span class="hljs-literal">false</span>)<span class="hljs-comment">//false跳转到授权页面</span><br>                <span class="hljs-comment">//客户端接收授权码的重定向地址</span><br>                .redirectUris(<span class="hljs-string">&quot;http://www.51xuecheng.cn&quot;</span>)<br>        ;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>现在重启认证服务。</p>
<p>下边使用httpclient进行测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java">### 密码模式<br>POST &#123;&#123;auth_host&#125;&#125;/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=stu1&amp;password=<span class="hljs-number">111111</span><br></code></pre></td></tr></table></figure>

<p>输入正确的账号和密码，申请令牌成功。</p>
<p>输入错误的密码，报错：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">Java</span><br><span class="hljs-keyword"></span>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;invalid_grant&quot;</span>,<br>  <span class="hljs-string">&quot;error_description&quot;</span>: <span class="hljs-string">&quot;用户名或密码错误&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输入错误的账号，报错：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">Java</span><br><span class="hljs-keyword"></span>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;unauthorized&quot;</span>,<br>  <span class="hljs-string">&quot;error_description&quot;</span>: <span class="hljs-string">&quot;UserDetailsService returned null, which is an interface contract violation&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="扩展用户身份信息"><a href="#扩展用户身份信息" class="headerlink" title="扩展用户身份信息"></a>扩展用户身份信息</h6><p>用户表中存储了用户的账号、手机号、email，昵称、qq等信息，UserDetails接口只返回了username、密码等信息，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br><br>    String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span>;<br><br>    String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>我们需要扩展用户身份的信息，在jwt令牌中存储用户昵称，头像，qq等信息。</p>
<p>如何扩展Spring Security的用户身份信息呢？</p>
<p>在认证阶段DaoAuthenticationProvider会调用UserDetailService查询用户信息，这里可以获取齐全的用户信息，由于JWT令牌中用户身份信息来源于UserDetails，Userdetails定义了username给用户身份信息，这里两个思路：1.扩展Userdetails，让他包括更多的自定义属性，2.扩展username的内容，比如存入json数据内容作为username的内容，比较而言，方案二更简单，而且不会破坏UserDetails的结构,我们用方案二</p>
<p>修改UserServiceImpl如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 17:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br><br>    <span class="hljs-comment">//根据账号查询用户信息</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, s));<br>        <span class="hljs-keyword">if</span> (user==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//取出数据库存储的正确密码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-comment">//用户权限，如果不加报错  Cannot pass a null GrantedAuthority collection</span><br>        String[] authorities = &#123;<span class="hljs-string">&quot;p1&quot;</span>&#125;; <span class="hljs-comment">//自定义假的权限</span><br>        <span class="hljs-comment">//为了安全在令牌中不放密码</span><br>        user.setPassword(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//将user对象转json</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userString</span> <span class="hljs-operator">=</span> JSON.toJSONString(user);<br>        <span class="hljs-comment">//创建UserDetails对象，权限信息待实现授权功能时再向UserDetail中加入</span><br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> User<br>                .withUsername(userString)<br>                .password(password)<br>                .authorities(authorities)<br>                .build();<br>        <span class="hljs-keyword">return</span> userDetails;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>重启认证服务，重新生成令牌，生成成功。</p>
<p>我们可以使用check_token查询jwt的内容</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JSON">###校验jwt令牌<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>auth_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/auth/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJzdHUxIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTcwMzU5OTE4MSwiYXV0aG9yaXRpZXMiOlsidGVzdCJdLCJqdGkiOiJkMjBkZWUzNC02NGY4LTQyZjUtOTRjMC1jNjFkYTUzYWUzMjAiLCJjbGllbnRfaWQiOiJYY1dlYkFwcCJ9.bA-whhHgbZCG-uXBYKAIVzYQ1GB5Xb6A_-sIE5LkM_E<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs json">POST http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:63070/auth/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJzdHUxIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTcwMzU5OTE4MSwiYXV0aG9yaXRpZXMiOlsidGVzdCJdLCJqdGkiOiJkMjBkZWUzNC02NGY4LTQyZjUtOTRjMC1jNjFkYTUzYWUzMjAiLCJjbGllbnRfaWQiOiJYY1dlYkFwcCJ9.bA-whhHgbZCG-uXBYKAIVzYQ1GB5Xb6A_-sIE5LkM_E</span><br><br>HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> <br>Transfer-Encoding<span class="hljs-punctuation">:</span> chunked<br>Cache-Control<span class="hljs-punctuation">:</span> no-cache<span class="hljs-punctuation">,</span> no-store<span class="hljs-punctuation">,</span> max-age=<span class="hljs-number">0</span><span class="hljs-punctuation">,</span> must-revalidate<br>Connection<span class="hljs-punctuation">:</span> keep-alive<br>Content-Type<span class="hljs-punctuation">:</span> application/json<br>Date<span class="hljs-punctuation">:</span> Tue<span class="hljs-punctuation">,</span> <span class="hljs-number">26</span> Dec <span class="hljs-number">2023</span> <span class="hljs-number">11</span><span class="hljs-punctuation">:</span><span class="hljs-number">59</span><span class="hljs-punctuation">:</span><span class="hljs-number">54</span> GMT<br>Expires<span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>Keep-Alive<span class="hljs-punctuation">:</span> timeout=<span class="hljs-number">4</span><br>Pragma<span class="hljs-punctuation">:</span> no-cache<br>Proxy-Connection<span class="hljs-punctuation">:</span> keep-alive<br>X-Content-Type-Options<span class="hljs-punctuation">:</span> nosniff<br>X-Frame-Options<span class="hljs-punctuation">:</span> DENY<br>X-Xss-Protection<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>; mode=block<br><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;aud&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;xuecheng-plus&quot;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;user_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;stu1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;scope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;all&quot;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;active&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;exp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1703599181</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;authorities&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;test&quot;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;jti&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;d20dee34-64f8-42f5-94c0-c61da53ae320&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;client_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;XcWebApp&quot;</span><br><span class="hljs-punctuation">&#125;</span><br>响应文件已保存。<br>&gt; <span class="hljs-number">2023</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span>T195954<span class="hljs-number">.200</span>.json<br><br>Response code<span class="hljs-punctuation">:</span> <span class="hljs-number">200</span>; Time<span class="hljs-punctuation">:</span> <span class="hljs-number">37</span>ms (<span class="hljs-number">37</span> ms); Content length<span class="hljs-punctuation">:</span> <span class="hljs-number">182</span> bytes (<span class="hljs-number">182</span> B)<br><br></code></pre></td></tr></table></figure>

<p>user_name 存储了用户信息的json格式，在资源服务中可以取出该json格式的内容转为用户对象使用</p>
<h6 id="资源服务获取用户身份"><a href="#资源服务获取用户身份" class="headerlink" title="资源服务获取用户身份"></a>资源服务获取用户身份</h6><p>下边编写一个工具类在各个微服务中去使用，<code>获取当前登录用户的对象</code>。</p>
<p>在content-api中定义此类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.xuecheng.util;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 获取当前用户身份工具类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/18 18:02</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityUtil</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> XcUser <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">principalObj</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication().getPrincipal();<br>            <span class="hljs-keyword">if</span> (principalObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>                <span class="hljs-comment">//取出用户身份信息</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> principalObj.toString();<br>                <span class="hljs-comment">//将json转成对象</span><br>                <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> JSON.parseObject(principal, XcUser.class);<br>                <span class="hljs-keyword">return</span> user;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;获取当前登录用户身份出错:&#123;&#125;&quot;</span>, e.getMessage());<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Data</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XcUser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>        <span class="hljs-keyword">private</span> String id;<br><br>        <span class="hljs-keyword">private</span> String username;<br><br>        <span class="hljs-keyword">private</span> String password;<br><br>        <span class="hljs-keyword">private</span> String salt;<br><br>        <span class="hljs-keyword">private</span> String name;<br>        <span class="hljs-keyword">private</span> String nickname;<br>        <span class="hljs-keyword">private</span> String wxUnionid;<br>        <span class="hljs-keyword">private</span> String companyId;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 头像</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> String userpic;<br><br>        <span class="hljs-keyword">private</span> String utype;<br><br>        <span class="hljs-keyword">private</span> LocalDateTime birthday;<br><br>        <span class="hljs-keyword">private</span> String sex;<br><br>        <span class="hljs-keyword">private</span> String email;<br><br>        <span class="hljs-keyword">private</span> String cellphone;<br><br>        <span class="hljs-keyword">private</span> String qq;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 用户状态</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> String status;<br><br>        <span class="hljs-keyword">private</span> LocalDateTime createTime;<br><br>        <span class="hljs-keyword">private</span> LocalDateTime updateTime;<br><br><br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>下边在内容管理服务中测试此工具类，以查询课程信息接口为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@ApiOperation(&quot;根据课程id查询课程基础信息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/course/&#123;courseId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> CourseBaseInfoDto <span class="hljs-title function_">getCourseBaseById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;<br>    <span class="hljs-comment">//取出当前用户身份</span><br><span class="hljs-comment">//    Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br>   SecurityUtil.<span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> SecurityUtil.getUser();<br>    System.out.println(user);<br><br>    <span class="hljs-keyword">return</span> courseBaseInfoService.getCourseBaseInfo(courseId);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>重启内容管理服务：</p>
<p>1、启动认证服务、网关、内容管理服务</p>
<p>2、生成新的令牌</p>
<p>3、携带令牌访问内容管理服务的查询课程接口</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226202942941.png" srcset="/img/loading.gif" lazyload alt="image-20231226202942941"></p>
<h5 id="支持认证方式多样"><a href="#支持认证方式多样" class="headerlink" title="支持认证方式多样"></a>支持认证方式多样</h5><h6 id="统一认证入口"><a href="#统一认证入口" class="headerlink" title="统一认证入口"></a>统一认证入口</h6><p>目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。基于当前研究的Spring Security认证流程如何支持多样化的认证方式呢？</p>
<p>1、支持账号和密码认证</p>
<p>采用OAuth2协议的密码模式即可实现。</p>
<p>2、支持手机号加验证码认证</p>
<p>用户认证提交的是手机号和验证码，并不是账号和密码</p>
<p>3  微信扫码认证</p>
<p>基于OAuth2协议和微信交互，学成在线网站向微信服务器申请一个令牌，然后携带令牌去微信查询用户信息，查询成功则用户在学成在线项目认证通过</p>
<p>目前我们测试通过OAuth2的密码模式，用户认证会提交账号和密码，由DaoAuthenticationProvider调用UserDetailsService的loadUserByUsername()方法获取UserDetails用户信息。</p>
<p>在前边我们自定义了UserDetailsService接口实现类，通过loadUserByUsername()方法根据账号查询用户信息。</p>
<p>而不同的认证方式提交的数据不一样，比如：手机加验证码方式会提交手机号和验证码，账号密码方式会提交账号、密码、验证码。</p>
<p>我们可以在loadUserByUsername()方法上作文章，将用户原来提交的<code>账号数据</code>改为提交<code>json数据</code>，json数据可以扩展不同认证方式所提交的各种参数。</p>
<p>首先创建一个DTO类表示认证的参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.model.dto;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 认证用户请求参数</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/29 10:56</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthParamsDto</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String username; <span class="hljs-comment">//用户名</span><br>    <span class="hljs-keyword">private</span> String password; <span class="hljs-comment">//域  用于扩展</span><br>    <span class="hljs-keyword">private</span> String cellphone;<span class="hljs-comment">//手机号</span><br>    <span class="hljs-keyword">private</span> String checkcode;<span class="hljs-comment">//验证码</span><br>    <span class="hljs-keyword">private</span> String checkcodekey;<span class="hljs-comment">//验证码key</span><br>    <span class="hljs-keyword">private</span> String authType; <span class="hljs-comment">// 认证的类型   password:用户名密码模式类型    sms:短信模式类型</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; payload = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<span class="hljs-comment">//附加数据，作为扩展，不同认证类型可拥有不同的附加数据。如认证类型为短信时包含smsKey : sms:3d21042d054548b08477142bbca95cfa; 所有情况下都包含clientId</span><br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>此时loadUserByUsername()方法可以修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 17:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br><br>    <span class="hljs-comment">//根据账号查询用户信息</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">AuthParamsDto</span> <span class="hljs-variable">authParamsDto</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//将认证参数转为AuthParamsDto类型</span><br>            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.info(<span class="hljs-string">&quot;认证请求不符合项目要求：&#123;&#125;&quot;</span>, s);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;认证请求数据格式不对&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//账号</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authParamsDto.getUsername();<br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));<br>        <span class="hljs-keyword">if</span> (user==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//取出数据库存储的正确密码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-comment">//用户权限，如果不加报错  Cannot pass a null GrantedAuthority collection</span><br>        String[] authorities = &#123;<span class="hljs-string">&quot;p1&quot;</span>&#125;; <span class="hljs-comment">//自定义假的权限</span><br>        <span class="hljs-comment">//将user对象转json</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userString</span> <span class="hljs-operator">=</span> JSON.toJSONString(user);<br>        <span class="hljs-comment">//创建UserDetails对象，权限信息待实现授权功能时再向UserDetail中加入</span><br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> User<br>                .withUsername(userString)<br>                .password(password)<br>                .authorities(authorities)<br>                .build();<br>        <span class="hljs-keyword">return</span> userDetails;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>原来的DaoAuthenticationProvider 会进行密码校验，重新定义DaoAuthenticationProviderCustom类，重写类的additionalAuthenticationChecks方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.auth.config;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.dao.DaoAuthenticationProvider;<br><span class="hljs-keyword">import</span> org.springframework.security.core.AuthenticationException;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义 DaoAuthenticationProviderCustom</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 20:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DaoAuthenticationProviderCustom</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DaoAuthenticationProvider</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserDetailsService</span><span class="hljs-params">(UserDetailsService userDetailsService)</span> &#123;<br>        <span class="hljs-built_in">super</span>.setUserDetailsService(userDetailsService);<br>    &#125;<br><br>    <span class="hljs-comment">//屏蔽密码对比</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">additionalAuthenticationChecks</span><span class="hljs-params">(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改WebSecurityConfig类指定daoAuthenticationProviderCustom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Autowired</span><br>DaoAuthenticationProviderCustom daoAuthenticationProviderCustom;<br><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    auth.authenticationProvider(daoAuthenticationProviderCustom);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>此时可以重启认证服务，测试申请令牌接口，传入的账号信息改为json数据，如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">################扩展认证请求参数后######################<br>###密码模式<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>auth_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=<span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;stu1&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;authType&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;password&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;111111&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>经过测试发现loadUserByUsername()方法可以正常接收到认证请求中的json数据。</p>
<p>有了这些认证参数我们可以定义一个认证Service接口去进行各种方式的认证。</p>
<p>定义用户信息，为了扩展性让它继承XcUser</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.model.dto;<br><br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 用户扩展信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/30 13:56</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XcUserExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">XcUser</span> &#123;<br>    <span class="hljs-comment">//用户权限</span><br>    List&lt;String&gt; permissions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>定义认证Service 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.XcUserExt;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 21:02</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 认证方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> authParamsDto 认证参数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.xuecheng.ucenter.model.po.XcUser 用户信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/29 12:11</span><br><span class="hljs-comment">     */</span><br>    XcUserExt <span class="hljs-title function_">execute</span><span class="hljs-params">(AuthParamsDto authParamsDto)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>loadUserByUsername()修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    ApplicationContext applicationContext;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> 查询用户信息组成用户身份信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> s  AuthParamsDto类型的json数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> org.springframework.security.core.userdetails.UserDetails</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2022/9/28 18:30</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br><br>        <span class="hljs-type">AuthParamsDto</span> <span class="hljs-variable">authParamsDto</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//将认证参数转为AuthParamsDto类型</span><br>            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.info(<span class="hljs-string">&quot;认证请求不符合项目要求:&#123;&#125;&quot;</span>,s);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;认证请求数据格式不对&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//开始认证</span><br>        authService.execute(authParamsDto);<br>        .....<br><br></code></pre></td></tr></table></figure>

<p>到此我们基于Spring Security认证流程修改为如下：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226210615365.png" srcset="/img/loading.gif" lazyload alt="image-20231226210615365"></p>
<h6 id="实现账号密码认证"><a href="#实现账号密码认证" class="headerlink" title="实现账号密码认证"></a><strong>实现账号密码认证</strong></h6><p>上节定义了AuthService认证接口，下边实现该接口实现账号密码认证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.XcUserExt;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.AuthService;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 账号密码认证</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 21:08</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service(&quot;password_authservice&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PasswordAuthServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthService</span> &#123;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    PasswordEncoder passwordEncoder;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title function_">execute</span><span class="hljs-params">(AuthParamsDto authParamsDto)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authParamsDto.getUsername();<span class="hljs-comment">//账号</span><br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));<br>        <span class="hljs-keyword">if</span> (user==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号不存在&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">XcUserExt</span> <span class="hljs-variable">xcUserExt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XcUserExt</span>();<br>        BeanUtils.copyProperties(user, xcUserExt);<br>        <span class="hljs-comment">// 校验密码</span><br>        <span class="hljs-comment">// 取出数据库存储的正确密码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">passwordDB</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">passwordForm</span> <span class="hljs-operator">=</span> authParamsDto.getPassword();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">matches</span> <span class="hljs-operator">=</span> passwordEncoder.matches(passwordForm, passwordDB);<br>        <span class="hljs-keyword">if</span>(!matches)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号或密码错误&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> xcUserExt;<br>    &#125;<br>    <br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改UserServiceImpl类，根据认证方式使用不同的认证bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.XcUserExt;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.AuthService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义UserDetailsService用来对接Spring Security</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/26 17:20</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br><span class="hljs-comment">//    @Autowired</span><br><span class="hljs-comment">//    AuthService authService;</span><br><br>    <span class="hljs-meta">@Autowired</span><br>    ApplicationContext applicationContext;<br><br><br>    <span class="hljs-comment">//查询用户信息组成用户身份信息, s: AuthParamsDto类型的json数据</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">AuthParamsDto</span> <span class="hljs-variable">authParamsDto</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//将认证参数转为AuthParamsDto类型</span><br>            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.info(<span class="hljs-string">&quot;认证请求不符合项目要求：&#123;&#125;&quot;</span>, s);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;认证请求数据格式不对&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 认证方法</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">authType</span> <span class="hljs-operator">=</span> authParamsDto.getAuthType();<br>        <span class="hljs-type">AuthService</span> <span class="hljs-variable">authService</span> <span class="hljs-operator">=</span> applicationContext.getBean(authType + <span class="hljs-string">&quot;_authservice&quot;</span>, AuthService.class);<br>        <span class="hljs-type">XcUserExt</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> authService.execute(authParamsDto);<br>        <span class="hljs-keyword">return</span> getUserPrincipal(user);<br><br>    &#125;<br><br>    <span class="hljs-comment">//查询用户信息</span><br>    <span class="hljs-keyword">private</span> UserDetails <span class="hljs-title function_">getUserPrincipal</span><span class="hljs-params">(XcUserExt user)</span> &#123;<br>        <span class="hljs-comment">//用户权限,如果不加报Cannot pass a null GrantedAuthority collection</span><br>        String[] authorities = &#123;<span class="hljs-string">&quot;p1&quot;</span>&#125;;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> user.getPassword();<br>        <span class="hljs-comment">//为了安全在令牌中不放密码</span><br>        user.setPassword(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//将user对象转json</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userString</span> <span class="hljs-operator">=</span> JSON.toJSONString(user);<br>        <span class="hljs-comment">//创建UserDetails对象</span><br>        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> User.withUsername(userString).password(password ).authorities(authorities).build();<br>        <span class="hljs-keyword">return</span> userDetails;<br><br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>重启认证服务，测试申请令牌接口。</p>
<p>1、测试账号和密码都正确的情况是否可以申请令牌成功。</p>
<p>2、测试密码错误的情况。</p>
<p>3、测试账号不存在情况。</p>
<h5 id="验证码服务"><a href="#验证码服务" class="headerlink" title="验证码服务"></a><strong>验证码服务</strong></h5><h6 id="创建验证码服务工程"><a href="#创建验证码服务工程" class="headerlink" title="创建验证码服务工程"></a><strong>创建验证码服务工程</strong></h6><p>在认证时一般都需要输入验证码，验证码有什么用？</p>
<p>验证码可以防止恶性攻击，比如：XSS跨站脚本攻击、CSRF跨站请求伪造攻击，一些比较复杂的图形验证码可以有效的防止恶性攻击。</p>
<p>为了保护系统的安全在一些比较重要的操作都需要验证码</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226212746628.png" srcset="/img/loading.gif" lazyload alt="image-20231226212746628" style="zoom:50%;" />

<p>验证码的类型也有很多：图片、语音、手机短信验证码等。</p>
<p>本项目创建单独的验证码服务为各业务提供验证码的生成、校验等服务。</p>
<p>拷贝课程资料目录xuecheng-plus-checkcode验证码服务工程到自己的工程目录。</p>
<p>定义nacos配置文件</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">YAML</span><br><span class="hljs-attribute">server</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">servlet</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">context-path</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/checkcode</span><br>  <span class="hljs-attribute">port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">63075</span><br><br></code></pre></td></tr></table></figure>

<p>注意修改bootstrap.yml中的命名空间为自己定义的命名空间。</p>
<p>配置redis-dev.yaml，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span> <br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">10</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">10000</span><br>    <span class="hljs-comment">#redisson:</span><br>      <span class="hljs-comment">#配置文件目录</span><br>      <span class="hljs-comment">#config: classpath:singleServerConfig.yaml</span><br><br></code></pre></td></tr></table></figure>

<h6 id="验证码接口测试"><a href="#验证码接口测试" class="headerlink" title="验证码接口测试"></a>验证码接口测试</h6><p>验证码服务对外提供的接口有：</p>
<p>1、生成验证码</p>
<p>2、校验验证码。</p>
<p>如下：<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226213250628.png" srcset="/img/loading.gif" lazyload alt="image-20231226213250628" style="zoom:50%;" /></p>
<p>验证码服务如何生成并校验验证码？</p>
<p>拿图片验证码举例：</p>
<p>1、先生成一个指定位数的验证码，根据需要可能是数字、数字字母组合或文字。</p>
<p>2、根据生成的验证码生成一个图片并返回给页面</p>
<p>3、给生成的验证码分配一个<code>key</code>，将key和验证码一同存入缓存。这个key和图片一同返回给页面。</p>
<p>4、用户输入验证码，连同key一同提交至认证服务。</p>
<p>5、认证服务拿key和输入的验证码请求验证码服务去校验</p>
<p>6、验证码服务根据key从缓存取出正确的验证码和用户输入的验证码进行比对，如果相同则校验通过，否则不通过。</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226213354276.png" srcset="/img/loading.gif" lazyload alt="image-20231226213354276"></p>
<p>根据接口分析，验证码服务接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.checkcode.controller;<br><br><span class="hljs-keyword">import</span> com.xuecheng.checkcode.model.CheckCodeParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.checkcode.model.CheckCodeResultDto;<br><span class="hljs-keyword">import</span> com.xuecheng.checkcode.service.CheckCodeService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiImplicitParam;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiImplicitParams;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 验证码服务接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/29 18:39</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = &quot;验证码服务接口&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CheckCodeController</span> &#123;<br><br>    <span class="hljs-meta">@Resource(name = &quot;PicCheckCodeService&quot;)</span><br>    <span class="hljs-keyword">private</span> CheckCodeService picCheckCodeService;<br><br><br>    <span class="hljs-meta">@ApiOperation(value=&quot;生成验证信息&quot;, notes=&quot;生成验证信息&quot;)</span><br>    <span class="hljs-meta">@PostMapping(value = &quot;/pic&quot;)</span><br>    <span class="hljs-keyword">public</span> CheckCodeResultDto <span class="hljs-title function_">generatePicCheckCode</span><span class="hljs-params">(CheckCodeParamsDto checkCodeParamsDto)</span>&#123;<br>        <span class="hljs-keyword">return</span> picCheckCodeService.generate(checkCodeParamsDto);<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation(value=&quot;校验&quot;, notes=&quot;校验&quot;)</span><br>    <span class="hljs-meta">@ApiImplicitParams(&#123;</span><br><span class="hljs-meta">            @ApiImplicitParam(name = &quot;name&quot;, value = &quot;业务名称&quot;, required = true, dataType = &quot;String&quot;, paramType=&quot;query&quot;),</span><br><span class="hljs-meta">            @ApiImplicitParam(name = &quot;key&quot;, value = &quot;验证key&quot;, required = true, dataType = &quot;String&quot;, paramType=&quot;query&quot;),</span><br><span class="hljs-meta">            @ApiImplicitParam(name = &quot;code&quot;, value = &quot;验证码&quot;, required = true, dataType = &quot;String&quot;, paramType=&quot;query&quot;)</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-meta">@PostMapping(value = &quot;/verify&quot;)</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">verify</span><span class="hljs-params">(String key, String code)</span>&#123;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> picCheckCodeService.verify(key,code);<br>        <span class="hljs-keyword">return</span> isSuccess;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>404   -&gt; 修改网关的nacos配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br><span class="hljs-attr">port:</span> <span class="hljs-number">63010</span> <span class="hljs-comment"># 网关端口</span><br><span class="hljs-attr">spring:</span><br><span class="hljs-attr">cloud:</span><br> <span class="hljs-attr">gateway:</span><br>   <span class="hljs-comment">#      filter:</span><br>   <span class="hljs-comment">#        strip-prefix:</span><br>   <span class="hljs-comment">#          enabled: true</span><br>   <span class="hljs-attr">routes:</span> <span class="hljs-comment"># 网关路由配置</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">content-api</span> <span class="hljs-comment"># 路由id，自定义，只要唯一即可</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://content-api</span> <span class="hljs-comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/content/**</span> <span class="hljs-comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span><br>        <span class="hljs-comment">#          filters:</span><br>        <span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">system-api</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://system-api</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/system/**</span><br>        <span class="hljs-comment">#          filters:</span><br>        <span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">media-api</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://media-api</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/media/**</span><br>        <span class="hljs-comment">#          filters:</span><br>        <span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">checkcode</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://checkcode</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/checkcode/**</span><br>        <span class="hljs-comment">#          filters:</span><br>        <span class="hljs-comment">#            - StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">auth-service</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://auth-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/auth/**</span><br>  <span class="hljs-comment">#          filters:</span><br>  <span class="hljs-comment">#            - StripPrefix=1</span><br></code></pre></td></tr></table></figure>


</blockquote>
<p>1、生成验证码接口</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">### 申请验证码<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>checkcode_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/checkcode/pic<br></code></pre></td></tr></table></figure>

<p>2、校验验证码接口</p>
<p>根据生成验证码返回的key以及日志中输出正确的验证码去测试。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">### 校验验证码<br>POST <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>checkcode_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span>/checkcode/verify?key=checkcode<span class="hljs-punctuation">:</span><span class="hljs-number">9</span>c7084e05f4442a3be23ce045f011d6e&amp;code=<span class="hljs-number">9E2</span>Q<br></code></pre></td></tr></table></figure>

<h5 id="账号密码认证"><a href="#账号密码认证" class="headerlink" title="账号密码认证"></a><strong>账号密码认证</strong></h5><h6 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h6><p>到目前为止账号和密码认证所需要的技术、组件都已开发完毕，下边实现账号密码认证，输出如下图：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226214116514.png" srcset="/img/loading.gif" lazyload alt="image-20231226214116514" style="zoom:50%;" />

<p>执行流程如下：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226214145555.png" srcset="/img/loading.gif" lazyload alt="image-20231226214145555"></p>
<h6 id="账号密码认证开发"><a href="#账号密码认证开发" class="headerlink" title="账号密码认证开发"></a><strong>账号密码认证开发</strong></h6><p>1、在认证服务定义远程调用验证码服务的接口</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.ucenter.feignclient;<br><br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RequestParam;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 搜索服务远程接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/20 20:29</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@FeignClient(value = <span class="hljs-string">&quot;checkcode&quot;</span>,fallbackFactory = CheckCodeClientFactory.class)</span><br> <span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/checkcode&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CheckCodeClient</span> &#123;<br><br> <span class="hljs-meta">@PostMapping(value = <span class="hljs-string">&quot;/verify&quot;</span>)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-built_in">Boolean</span> verify(<span class="hljs-meta">@RequestParam(<span class="hljs-string">&quot;key&quot;</span>)</span> String key,<span class="hljs-meta">@RequestParam(<span class="hljs-string">&quot;code&quot;</span>)</span> String code);<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>CheckCodeClientFactory</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CheckCodeClientFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;<span class="hljs-title class_">CheckCodeClient</span>&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CheckCodeClient</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">Throwable throwable</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CheckCodeClient</span>() &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-title class_">Boolean</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key, <span class="hljs-built_in">String</span> code</span>) &#123;<br>                log.<span class="hljs-title function_">debug</span>(<span class="hljs-string">&quot;调用验证码服务熔断异常:&#123;&#125;&quot;</span>, throwable.<span class="hljs-title function_">getMessage</span>());<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>启动类添加：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@EnableFeignClients(basePackages=&#123;<span class="hljs-string">&quot;com.xuecheng.*.feignclient&quot;</span>&#125;)</span><br><br></code></pre></td></tr></table></figure>

<p>配置文件引入feign-dev.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">Java</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">feign-$&#123;spring.profiles.active&#125;.yaml</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-common</span><br>  <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure>

<p>2、完善PasswordAuthServiceImpl</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Java<br><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.feignclient.CheckCodeClient;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.AuthService;<br><span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @description 账号密码认证</span><br><span class="hljs-comment"> * @author Mr.M</span><br><span class="hljs-comment"> * @date 2022/9/29 12:12</span><br><span class="hljs-comment"> * @version 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@Service</span>(<span class="hljs-string">&quot;password_authservice&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">PasswordAuthServiceImpl</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">AuthService</span></span> </span>&#123;<br><br> <span class="hljs-meta">@Autowired</span><br> XcUserMapper xcUserMapper;<br><br> <span class="hljs-meta">@Autowired</span><br> PasswordEncoder passwordEncoder;<br> <span class="hljs-meta">@Autowired</span><br> CheckCodeClient checkCodeClient;<br><br> <span class="hljs-meta">@Override</span><br> <span class="hljs-keyword">public</span> XcUser execute(AuthParamsDto authParamsDto) &#123;<br><br>  <span class="hljs-comment">//校验验证码</span><br>  <span class="hljs-keyword">String</span> checkcode = authParamsDto.getCheckcode();<br>  <span class="hljs-keyword">String</span> checkcodekey = authParamsDto.getCheckcodekey();<br><br>  <span class="hljs-keyword">if</span>(StringUtils.isBlank(checkcodekey) || StringUtils.isBlank(checkcode))&#123;<br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">&quot;验证码为空&quot;</span>);<br><br>  &#125;<br>  Boolean verify = checkCodeClient.verify(checkcodekey, checkcode);<br>  <span class="hljs-keyword">if</span>(!verify)&#123;<br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">&quot;验证码输入错误&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">//账号</span><br>  <span class="hljs-keyword">String</span> username = authParamsDto.getUsername();<br>  XcUser user = xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-type">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser:<span class="hljs-type"></span>:getUsername, username));<br>  <span class="hljs-keyword">if</span>(user==<span class="hljs-literal">null</span>)&#123;<br>   <span class="hljs-comment">//返回空表示用户不存在</span><br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">&quot;账号不存在&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">//校验密码</span><br>  <span class="hljs-comment">//取出数据库存储的正确密码</span><br>  <span class="hljs-keyword">String</span> passwordDb  =user.getPassword();<br>  <span class="hljs-keyword">String</span> passwordForm = authParamsDto.getPassword();<br>  boolean matches = passwordEncoder.matches(passwordForm, passwordDb);<br>  <span class="hljs-keyword">if</span>(!matches)&#123;<br>   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">&quot;账号或密码错误&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> user;<br> &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>小技巧：目前账号密码方式添加了验证码校验，为了后期获取令牌方便可以重新定义一个不需要验证码校验的认证类AuthService ，AuthService 中去掉验证码的校验，方便生成令牌。</p>
<h6 id="账号密码认证测试"><a href="#账号密码认证测试" class="headerlink" title="账号密码认证测试"></a><strong>账号密码认证测试</strong></h6><p>1、使用浏览器访问 <a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/sign.html">http://www.51xuecheng.cn/sign.html</a></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226223602447.png" srcset="/img/loading.gif" lazyload alt="image-20231226223602447"></p>
<p>2、首先测试验证码，分别输入正确的验证码和错误的验证码进行测试</p>
<p>3、输入正确的账号密码和错误的账号密码进行测试</p>
<p>登录成功将jwt令牌存储cookie.</p>
<p>4、测试自动登录</p>
<p>勾选自动登录cookie生成时间为30天，不勾选自动登录关闭浏览器窗口后自动删除cookie。</p>
<h4 id="微信扫码登录"><a href="#微信扫码登录" class="headerlink" title="微信扫码登录"></a><strong>微信扫码登录</strong></h4><h5 id="接入规范"><a href="#接入规范" class="headerlink" title="接入规范"></a><strong>接入规范</strong></h5><h6 id="接入流程"><a href="#接入流程" class="headerlink" title="接入流程"></a><strong>接入流程</strong></h6><p>微信扫码登录基于OAuth2协议的授权码模式，</p>
<p>接口文档：</p>
<p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</a></p>
<p>流程如下：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226223648221.png" srcset="/img/loading.gif" lazyload alt="image-20231226223648221"></p>
<p>第3方应用获取access_token令牌后即可请求微信获取用户信息，成功获取用户信息表示用户第3方应用认证成功</p>
<h6 id="请求获取授权码"><a href="#请求获取授权码" class="headerlink" title="请求获取授权码"></a>请求获取授权码</h6><p>第三方使用网站应用授权登录前请注意已获取相应网页授权作用域(scope&#x3D;snsapi_login)，则可以通过在PC端打开以下链接：</p>
<p><a target="_blank" rel="noopener" href="https://open.weixin.qq.com/connect/qrconnect?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect">https://open.weixin.qq.com/connect/qrconnect?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect</a> </p>
<p>若提示“该链接无法访问”，请检查参数是否填写错误，如redirect_url域名与审核时填写的授权域名不一致或scope不为snsapi_login</p>
<p><strong>参数说明</strong></p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226233742308.png" srcset="/img/loading.gif" lazyload alt="image-20231226233742308"></p>
<p><strong>返回说明</strong></p>
<p>用户允许授权后，将会重定向到redirect_uri的网址上，并且带上 code 和state参数</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">redirect_uri?code=CODE&amp;state=STATE<br></code></pre></td></tr></table></figure>

<p>若用户禁止授权，则不会发生重定向。</p>
<p>登录一号店网站应用 <a target="_blank" rel="noopener" href="https://test.yhd.com/wechat/login.do">https://test.yhd.com/wechat/login.do</a> 打开后，一号店会生成 state 参数，跳转到 <a target="_blank" rel="noopener" href="https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&redirect_uri=https://passport.yhd.com/wechat/callback.do&response_type=code&scope=snsapi_login&state=3d6be0a4035d839573b04816624a415e#wechat_redirect">https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&amp;redirect_uri=https%3A%2F%2Fpassport.yhd.com%2Fwechat%2Fcallback.do&amp;response_type=code&amp;scope=snsapi_login&amp;state=3d6be0a4035d839573b04816624a415e#wechat_redirect</a> 微信用户使用微信扫描二维码并且确认登录后，PC端会跳转到 <a target="_blank" rel="noopener" href="https://test.yhd.com/wechat/callback.do?code=CODE&state=3d6be0a40sssssxxxxx6624a415e">https://test.yhd.com/wechat/callback.do?code=CODE&amp;state=3d6be0a40sssssxxxxx6624a415e</a> 为了满足网站更定制化的需求，我们还提供了第二种获取 code 的方式，支持网站将微信登录二维码内嵌到自己页面中，用户使用微信扫码授权后通过 JS 将code返回给网站。 JS微信登录主要用途：网站希望用户在网站内就能完成登录，无需跳转到微信域下登录后再返回，提升微信登录的流畅性与成功率。 网站内嵌二维码微信登录 JS 实现办法：</p>
<p>步骤1：在页面中先引入如下 JS 文件（支持https）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">http</span>:<span class="hljs-comment">//res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js</span><br></code></pre></td></tr></table></figure>

<p>步骤2：在需要使用微信登录的地方实例以下 JS 对象：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WxLogin</span>(&#123;<br><span class="hljs-attr">self_redirect</span>:<span class="hljs-literal">true</span>,<br><span class="hljs-attr">id</span>:<span class="hljs-string">&quot;login_container&quot;</span>, <br><span class="hljs-attr">appid</span>: <span class="hljs-string">&quot;&quot;</span>, <br><span class="hljs-attr">scope</span>: <span class="hljs-string">&quot;&quot;</span>, <br><span class="hljs-attr">redirect_uri</span>: <span class="hljs-string">&quot;&quot;</span>,<br> <span class="hljs-attr">state</span>: <span class="hljs-string">&quot;&quot;</span>,<br><span class="hljs-attr">style</span>: <span class="hljs-string">&quot;&quot;</span>,<br><span class="hljs-attr">href</span>: <span class="hljs-string">&quot;&quot;</span><br>&#125;);<br></code></pre></td></tr></table></figure>

<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234103548.png" srcset="/img/loading.gif" lazyload alt="image-20231226234103548"></p>
<h6 id="通过-code-获取access-token"><a href="#通过-code-获取access-token" class="headerlink" title="通过 code 获取access_token"></a><strong>通过 code 获取access_token</strong></h6><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">https</span>:<span class="hljs-comment">//api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code</span><br></code></pre></td></tr></table></figure>

<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234215263.png" srcset="/img/loading.gif" lazyload alt="image-20231226234215263"></p>
<p><strong>返回说明</strong></p>
<p>正确的返回：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Plain</span> <span class="hljs-built_in">Text</span><br><span class="hljs-punctuation">&#123;</span> <br><span class="hljs-string">&quot;access_token&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;ACCESS_TOKEN&quot;</span><span class="hljs-operator">,</span> <br><span class="hljs-string">&quot;expires_in&quot;</span><span class="hljs-operator">:</span><span class="hljs-number">7200</span><span class="hljs-operator">,</span> <br><span class="hljs-string">&quot;refresh_token&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;REFRESH_TOKEN&quot;</span><span class="hljs-operator">,</span><br><span class="hljs-string">&quot;openid&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;OPENID&quot;</span><span class="hljs-operator">,</span> <br><span class="hljs-string">&quot;scope&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;SCOPE&quot;</span><span class="hljs-operator">,</span><br><span class="hljs-string">&quot;unionid&quot;</span><span class="hljs-operator">:</span> <span class="hljs-string">&quot;o6_bmasdasdsad6_2sgVt7hMZOPfL&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure>

<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234421292.png" srcset="/img/loading.gif" lazyload alt="image-20231226234421292" style="zoom:50%;" />

<p>错误返回样例</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">Plain Text<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;errcode&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">40029</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;errmsg&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;invalid code&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h6 id="通过access-token调用接口"><a href="#通过access-token调用接口" class="headerlink" title="通过access_token调用接口"></a><strong>通过access_token调用接口</strong></h6><p>获取access_token后，进行接口调用，有以下前提</p>
<p>​	</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Plain</span> <span class="hljs-built_in">Text</span><br><span class="hljs-type">access_token</span>有效且未超时；<br>微信用户已授权给第三方应用帐号相应接口作用域（<span class="hljs-variable">scope</span>）。<br><br></code></pre></td></tr></table></figure>

<p>对于接口作用域（scope），能调用的接口有以下</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234549805.png" srcset="/img/loading.gif" lazyload alt="image-20231226234549805"></p>
<p> 其中snsapi_base属于基础接口，若应用已拥有其它 scope 权限，则默认拥有snsapi_base的权限。使用snsapi_base可以让移动端网页授权绕过跳转授权登录页请求用户授权的动作，直接跳转第三方网页带上授权临时票据（code），但会使得用户已授权作用域（scope）仅为snsapi_base，从而导致无法获取到需要用户授权才允许获得的数据和基础功能。 接口调用方法可查阅<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html">《微信授权关系接口调用指南》</a></p>
<p>获取用户信息接口文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html</a></p>
<p>接口地址</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sqf">Plain <span class="hljs-built_in">Text</span><br>http请求方式: <span class="hljs-built_in">GET</span><br>https:<span class="hljs-comment">//api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID</span><br><br></code></pre></td></tr></table></figure>

<p>如下：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234710976.png" srcset="/img/loading.gif" lazyload alt="image-20231226234710976"></p>
<p>响应</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231226234719991.png" srcset="/img/loading.gif" lazyload alt="image-20231226234719991"></p>
<p>说明如下：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dns">参数            说明<br>openid        普通用户的标识，对当前开发者帐号唯一<br>nickname        普通用户昵称<br>sex            普通用户性别，<span class="hljs-number">1</span>为男性，<span class="hljs-number">2</span>为女性<br>province        普通用户个人资料填写的省份<br>city            普通用户个人资料填写的城市<br>country        国家，如中国为CN<br>headimgurl        用户头像，最后一个数值代表正方形头像大小（有<span class="hljs-number">0、46、64、96</span>、<span class="hljs-number">132</span>数值可选，<span class="hljs-number">0</span>代表<span class="hljs-number">640*640</span>正方形头像），用户没有头像时该项为空<br>privilege        用户特权信息，json数组，如微信沃卡用户为（chinaunicom）<br>unionid          用户统一标识。针对一个微信开放平台帐号下的应用，同一用户的 unionid 是唯一的。<br></code></pre></td></tr></table></figure>

<h5 id="准备开发环境"><a href="#准备开发环境" class="headerlink" title="准备开发环境"></a><strong>准备开发环境</strong></h5><h6 id="添加应用"><a href="#添加应用" class="headerlink" title="添加应用"></a>添加应用</h6><p>1、注册微信开放平台</p>
<p><a target="_blank" rel="noopener" href="https://open.weixin.qq.com/">https://open.weixin.qq.com/</a></p>
<p>2、添加应用</p>
<p>进入网站应用，添加应用</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227105656290.png" srcset="/img/loading.gif" lazyload alt="image-20231227105656290"></p>
<p>3、添加应用需要指定一个外网域名作为微信回调域名</p>
<p>审核通过后，生成app密钥。</p>
<p>最终获取appID和AppSecret</p>
<h6 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a><strong>内网穿透</strong></h6><p>我们开发环境在局域网，微信回调指向一个公网域名</p>
<p>如何让微信回调请求到我们的开发计算机呢？</p>
<p>使用内网穿透，什么是内网穿透？</p>
<blockquote>
<p>内网穿透</p>
<p>将内网外网通过隧道打通，让内网数据让外网可以获取，比如常用的办公软件等，一般在办公室或家里，通过拨号上网，这样办公软件只有在本地局域网可以访问，那问题来嘞，如果在手机或公司外地上班的员工，如何访问到办公软件？需要内网穿透工具，开启隧道后，内网穿透工具会分配一个专属域名&#x2F;端口，办公软件可以在公网了，在外办公的员工可以在任何地方办公了</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227111010963.png" srcset="/img/loading.gif" lazyload alt="image-20231227111010963"></p>
<p>在内网穿透服务器开启隧道，配置外网域名，配置穿透内网的端口即本地电脑上的端口</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227111058273.png" srcset="/img/loading.gif" lazyload alt="image-20231227111058273"></p>
<p>这样我们配置认证服务端口，最终实现外网域名访问本地认证服务</p>
<p>2  在本地安装内网穿透工具，工具配置内网穿透服务器隧道token</p>
<p>市面上做内网穿透的商家很多，需要时可以查阅资料了解下。</p>
</blockquote>
<h5 id="接入微信登录"><a href="#接入微信登录" class="headerlink" title="接入微信登录"></a><strong>接入微信登录</strong></h5><h6 id="接入分析"><a href="#接入分析" class="headerlink" title="接入分析"></a>接入分析</h6><p>根据OAuth2协议授权码流程，结合本项目自身特点，分析接入微信扫码登录的流程如下：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227111247459.png" srcset="/img/loading.gif" lazyload alt="image-20231227111247459"></p>
<p>本项目认证服务需要做哪些事？</p>
<ol>
<li>需要定义接口接收微信下发的授权码</li>
<li>收到授权码调用微信接口申请令牌</li>
<li>申请到令牌调用微信获取用户信息</li>
<li>获取用户信息成功将其写入本项目用户中心数据库</li>
<li>最后重定向到浏览器自动登录</li>
</ol>
<h6 id="定义接口"><a href="#定义接口" class="headerlink" title="定义接口"></a><strong>定义接口</strong></h6><p>参考接口规范中请求获取授权码定义接收微信下发的授权码接口</p>
<p>定义 WxLoginController 类，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.auth.controller;<br><br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 微信登录</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/27 12:11</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WxLoginController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/wxlogin&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">wxLogin</span><span class="hljs-params">(String code,String state)</span>&#123;<br>        log.debug(<span class="hljs-string">&quot;微信扫码回调,code:&#123;&#125;,state:&#123;&#125;&quot;</span>,code,state);<br>        <span class="hljs-comment">//请求微信申请令牌，拿到令牌查询用户信息，将用户信息写入项目数据库</span><br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">xcUser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XcUser</span>();<br>        <span class="hljs-comment">//暂时硬编码，目的是调试环境</span><br>        xcUser.setUsername(<span class="hljs-string">&quot;t1&quot;</span>);<br>        <span class="hljs-keyword">if</span> (xcUser==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:http://www.51xuecheng.cn/error.html&quot;</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> xcUser.getUsername();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:http://www.51xuecheng.cn/sign.html?username=&quot;</span>+username+<span class="hljs-string">&quot;&amp;authType=wx&quot;</span>;<br>    &#125;<br>    <br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>定义微信认证的service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.XcUserExt;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.AuthService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 微信扫码认证</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/27 12:16</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service(&quot;wx_authservice&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WxAuthServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthService</span>  &#123;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title function_">execute</span><span class="hljs-params">(AuthParamsDto authParamsDto)</span> &#123;<br>        <span class="hljs-comment">//账号</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authParamsDto.getUsername();<br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号不存在&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">XcUserExt</span> <span class="hljs-variable">xcUserExt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XcUserExt</span>();<br>        BeanUtils.copyProperties(user,xcUserExt);<br>        <span class="hljs-keyword">return</span> xcUserExt;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="接口环境测试"><a href="#接口环境测试" class="headerlink" title="接口环境测试"></a><strong>接口环境测试</strong></h6><p>接口定义好下边进行测试下，主要目的是测试接口调度的环境。</p>
<p>1、启动内网穿透工具</p>
<p>2、在&#x2F;wxLogin接口中打断点</p>
<p>3、打开前端微信扫码页面</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227121958289.png" srcset="/img/loading.gif" lazyload alt="image-20231227121958289"></p>
<p>点击微信图标打开二维码</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227122010128.png" srcset="/img/loading.gif" lazyload alt="image-20231227122010128"></p>
<p>用户扫码，确认授权</p>
<p>此时正常进入 &#x2F;wxLogin 方法，最后跳转到</p>
<p><a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/sign.html?username=t1&authType=wx">http://www.51xuecheng.cn/sign.html?username=t1&amp;authType=wx</a></p>
<h6 id="申请令牌"><a href="#申请令牌" class="headerlink" title="申请令牌"></a><strong>申请令牌</strong></h6><p>接下来请求微信申请令牌。</p>
<p>1、使用restTemplate请求微信，配置RestTemplate bean</p>
<p>在启动类配置restTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Bean</span><br>RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">RestTemplate</span> <span class="hljs-variable">restTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttp3ClientHttpRequestFactory</span>());<br>    <span class="hljs-keyword">return</span>  restTemplate;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>定义与微信认证的service接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 微信认证接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/27 12:22</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WxAuthService</span> &#123;<br>    XcUser <span class="hljs-title function_">wxAuth</span><span class="hljs-params">(String code)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续在WxAuthServiceImpl类写WxAuthService 接口的实现，在其中定义申请令牌的私有方法并由wxAuth方法去调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.ucenter.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.dto.XcUserExt;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.AuthService;<br><span class="hljs-keyword">import</span> com.xuecheng.ucenter.service.WxAuthService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpMethod;<br><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 微信扫码认证</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/27 12:16</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service(&quot;wx_authservice&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WxAuthServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthService</span>, WxAuthService &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    XcUserMapper xcUserMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;weixin.appid&#125;&quot;)</span><br>    String appid;<br>    <span class="hljs-meta">@Value(&quot;$&#123;weixin.secret&#125;&quot;)</span><br>    String secret;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title function_">execute</span><span class="hljs-params">(AuthParamsDto authParamsDto)</span> &#123;<br>        <span class="hljs-comment">//账号</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authParamsDto.getUsername();<br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//返回空表示用户不存在</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号不存在&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">XcUserExt</span> <span class="hljs-variable">xcUserExt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XcUserExt</span>();<br>        BeanUtils.copyProperties(user,xcUserExt);<br>        <span class="hljs-keyword">return</span> xcUserExt;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> XcUser <span class="hljs-title function_">wxAuth</span><span class="hljs-params">(String code)</span> &#123;<br>        <span class="hljs-comment">//收到code调用的微信接口申请access_token</span><br>        Map&lt;String, String&gt; access_token_map = getAccess_token(code);<br>        <span class="hljs-keyword">if</span> (access_token_map==<span class="hljs-literal">null</span>)<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">//获取用户信息</span><br>        <span class="hljs-comment">//添加用户到数据库</span><br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">xcUser</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">return</span> xcUser;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 申请访问令牌,响应示例</span><br><span class="hljs-comment">     &#123;</span><br><span class="hljs-comment">     &quot;access_token&quot;:&quot;ACCESS_TOKEN&quot;,</span><br><span class="hljs-comment">     &quot;expires_in&quot;:7200,</span><br><span class="hljs-comment">     &quot;refresh_token&quot;:&quot;REFRESH_TOKEN&quot;,</span><br><span class="hljs-comment">     &quot;openid&quot;:&quot;OPENID&quot;,</span><br><span class="hljs-comment">     &quot;scope&quot;:&quot;SCOPE&quot;,</span><br><span class="hljs-comment">     &quot;unionid&quot;: &quot;o6_bmasdasdsad6_2sgVt7hMZOPfL&quot;</span><br><span class="hljs-comment">     &#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String,String&gt; <span class="hljs-title function_">getAccess_token</span><span class="hljs-params">(String code)</span> &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">wxUrl_template</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code&quot;</span>;<br>        <span class="hljs-comment">//请求微信地址</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">wxUrl</span> <span class="hljs-operator">=</span> String.format(wxUrl_template, appid, secret, code);<br><br>        log.info(<span class="hljs-string">&quot;调用微信接口申请access_token, url:&#123;&#125;&quot;</span>, wxUrl);<br><br>        ResponseEntity&lt;String&gt; exchange = restTemplate.exchange(wxUrl, HttpMethod.POST, <span class="hljs-literal">null</span>, String.class);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> exchange.getBody();<br>        log.info(<span class="hljs-string">&quot;调用微信接口申请access_token: 返回值:&#123;&#125;&quot;</span>, result);<br>        Map&lt;String,String&gt; resultMap = JSON.parseObject(result, Map.class);<br><br>        <span class="hljs-keyword">return</span> resultMap;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>下边在controller中调用wxAuth接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WxLoginController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    WxAuthService wxAuthService;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/wxLogin&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">wxLogin</span><span class="hljs-params">(String code, String state)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        log.debug(<span class="hljs-string">&quot;微信扫码回调,code:&#123;&#125;,state:&#123;&#125;&quot;</span>,code,state);<br>        <span class="hljs-comment">//请求微信申请令牌，拿到令牌查询用户信息，将用户信息写入本项目数据库</span><br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">xcUser</span> <span class="hljs-operator">=</span> wxAuthService.wxAuth(code);<br>        <span class="hljs-keyword">if</span>(xcUser==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:http://www.51xuecheng.cn/error.html&quot;</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> xcUser.getUsername();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:http://www.51xuecheng.cn/sign.html?username=&quot;</span>+username+<span class="hljs-string">&quot;&amp;authType=wx&quot;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>测试获取用户信息</p>
<p>1、在wxAuthService中获取用户信息处打断点</p>
<p>2、进入<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/wxsign.html">http://www.51xuecheng.cn/wxsign.html</a></p>
<p>3、手机扫码并授权，观察是否成功申请到令牌</p>
<h6 id="获取用户信息"><a href="#获取用户信息" class="headerlink" title="获取用户信息"></a><strong>获取用户信息</strong></h6><p>在WxAuthServiceImpl类中定义获取用户信息方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**获取用户信息，示例如下：</span><br><span class="hljs-comment"> &#123;</span><br><span class="hljs-comment"> &quot;openid&quot;:&quot;OPENID&quot;,</span><br><span class="hljs-comment"> &quot;nickname&quot;:&quot;NICKNAME&quot;,</span><br><span class="hljs-comment"> &quot;sex&quot;:1,</span><br><span class="hljs-comment"> &quot;province&quot;:&quot;PROVINCE&quot;,</span><br><span class="hljs-comment"> &quot;city&quot;:&quot;CITY&quot;,</span><br><span class="hljs-comment"> &quot;country&quot;:&quot;COUNTRY&quot;,</span><br><span class="hljs-comment"> &quot;headimgurl&quot;: &quot;https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0&quot;,</span><br><span class="hljs-comment"> &quot;privilege&quot;:[</span><br><span class="hljs-comment"> &quot;PRIVILEGE1&quot;,</span><br><span class="hljs-comment"> &quot;PRIVILEGE2&quot;</span><br><span class="hljs-comment"> ],</span><br><span class="hljs-comment"> &quot;unionid&quot;: &quot; o6_bmasdasdsad6_2sgVt7hMZOPfL&quot;</span><br><span class="hljs-comment"> &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> Map&lt;String,String&gt; <span class="hljs-title function_">getUserinfo</span><span class="hljs-params">(String access_token,String openid)</span> &#123;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">wxUrl_template</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s&quot;</span>;<br>    <span class="hljs-comment">//请求微信地址</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">wxUrl</span> <span class="hljs-operator">=</span> String.format(wxUrl_template, access_token,openid);<br><br>    log.info(<span class="hljs-string">&quot;调用微信接口申请access_token, url:&#123;&#125;&quot;</span>, wxUrl);<br><br>    ResponseEntity&lt;String&gt; exchange = restTemplate.exchange(wxUrl, HttpMethod.POST, <span class="hljs-literal">null</span>, String.class);<br><br>    <span class="hljs-comment">//防止乱码进行转码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span>     <span class="hljs-title class_">String</span>(exchange.getBody().getBytes(StandardCharsets.ISO_8859_1), StandardCharsets.UTF_8);<br>    log.info(<span class="hljs-string">&quot;调用微信接口申请access_token: 返回值:&#123;&#125;&quot;</span>, result);<br>    Map&lt;String,String&gt; resultMap = JSON.parseObject(result, Map.class);<br><br>    <span class="hljs-keyword">return</span> resultMap;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用获取用户信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> XcUser <span class="hljs-title function_">wxAuth</span><span class="hljs-params">(String code)</span>&#123;<br><br>        <span class="hljs-comment">//收到code调用微信接口申请access_token</span><br>        Map&lt;String, String&gt; access_token_map = getAccess_token(code);<br>        <span class="hljs-keyword">if</span>(access_token_map==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        System.out.println(access_token_map);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">openid</span> <span class="hljs-operator">=</span> access_token_map.get(<span class="hljs-string">&quot;openid&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">access_token</span> <span class="hljs-operator">=</span> access_token_map.get(<span class="hljs-string">&quot;access_token&quot;</span>);<br>        <span class="hljs-comment">//拿access_token查询用户信息</span><br>        Map&lt;String, String&gt; userinfo = getUserinfo(access_token, openid);<br>        <span class="hljs-keyword">if</span>(userinfo==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//添加用户到数据库</span><br>        <span class="hljs-type">XcUser</span> <span class="hljs-variable">xcUser</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">return</span> xcUser;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>测试获取用户信息</p>
<p>1、在获取用户信息处打断点</p>
<p>2、进入<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/wxsign.html">http://www.51xuecheng.cn/wxsign.html</a></p>
<p>3、手机扫码授权</p>
<h6 id="保存用户信息"><a href="#保存用户信息" class="headerlink" title="保存用户信息"></a>保存用户信息</h6><p>向数据库保存用户信息，如果用户不存在将其保存在数据库。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Java<br><span class="hljs-meta">@Autowired</span><br>XcUserRoleMapper xcUserRoleMapper;<br><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> XcUser addWxUser(Map userInfo_map)&#123;<br>    <span class="hljs-keyword">String</span> unionid = userInfo_map.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;unionid&quot;</span>).toString();<br>    <span class="hljs-comment">//根据unionid查询数据库</span><br>    XcUser xcUser = xcUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-type">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser:<span class="hljs-type"></span>:getWxUnionid, unionid));<br>    <span class="hljs-keyword">if</span>(xcUser!=<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> xcUser;<br>    &#125;<br>    <span class="hljs-keyword">String</span> userId = UUID.randomUUID().toString();<br>    xcUser = <span class="hljs-keyword">new</span> <span class="hljs-type">XcUser</span>();<br>    xcUser.setId(userId);<br>    xcUser.setWxUnionid(unionid);<br>    <span class="hljs-comment">//记录从微信得到的昵称</span><br>    xcUser.setNickname(userInfo_map.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;nickname&quot;</span>).toString());<br>    xcUser.setUserpic(userInfo_map.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;headimgurl&quot;</span>).toString());<br>    xcUser.setName(userInfo_map.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;nickname&quot;</span>).toString());<br>    xcUser.setUsername(unionid);<br>    xcUser.setPassword(unionid);<br>    xcUser.setUtype(<span class="hljs-string">&quot;101001&quot;</span>);<span class="hljs-comment">//学生类型</span><br>    xcUser.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<span class="hljs-comment">//用户状态</span><br>    xcUser.setCreateTime(LocalDateTime.now());<br>    xcUserMapper.insert(xcUser);<br>    XcUserRole xcUserRole = <span class="hljs-keyword">new</span> <span class="hljs-type">XcUserRole</span>();<br>    xcUserRole.setId(UUID.randomUUID().toString());<br>    xcUserRole.setUserId(userId);<br>    xcUserRole.setRoleId(<span class="hljs-string">&quot;17&quot;</span>);<span class="hljs-comment">//学生角色</span><br>    xcUserRoleMapper.insert(xcUserRole);<br>    <span class="hljs-keyword">return</span> xcUser;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>调用保存用户信息</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-title class_">WxAuthServiceImpl</span> currentProxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title class_">XcUser</span> <span class="hljs-title function_">wxAuth</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> code</span>)&#123;<br><br>    <span class="hljs-comment">//收到code调用微信接口申请access_token</span><br>    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; access_token_map = <span class="hljs-title function_">getAccess_token</span>(code);<br>    <span class="hljs-keyword">if</span>(access_token_map==<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(access_token_map);<br>    <span class="hljs-title class_">String</span> openid = access_token_map.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;openid&quot;</span>);<br>    <span class="hljs-title class_">String</span> access_token = access_token_map.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;access_token&quot;</span>);<br>    <span class="hljs-comment">//拿access_token查询用户信息</span><br>    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; userinfo = <span class="hljs-title function_">getUserinfo</span>(access_token, openid);<br>    <span class="hljs-keyword">if</span>(userinfo==<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">//将用户信息保存到数据库</span><br>    <span class="hljs-title class_">XcUser</span> xcUser = currentProxy.<span class="hljs-title function_">addWxUser</span>(userinfo);<br>    <span class="hljs-keyword">return</span> xcUser;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>测试保存用户信息</p>
<p>1、在保存用户信息处打断点</p>
<p>2、进入<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/wxsign.html">http://www.51xuecheng.cn/wxsign.html</a></p>
<p>3、手机扫码授权</p>
<p>4、自动跳转到登录页面，提交认证成功。</p>
<h4 id="用户授权"><a href="#用户授权" class="headerlink" title="用户授权"></a>用户授权</h4><h5 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h5><p>如何实现授权？业界通常基于RBAC实现授权</p>
<p>RBAC分为两种方式：</p>
<p>基于角色的访问控制（Role-Based Access Control）</p>
<p>基于资源的访问控制（Resource-Based Access Control）</p>
<p>角色的访问控制（Role-Based Access Control）是按角色进行授权，比如：主体的角色为总经理可以查询企业运营报表，查询员工工资信息等，访问控制流程如下：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227123937245.png" srcset="/img/loading.gif" lazyload alt="image-20231227123937245" style="zoom:70%;" />

<p>根据上图的判断逻辑，授权代码可以表示如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(主体.hasRole(<span class="hljs-string">&quot;总经理角色id&quot;</span>))&#123;<br>查询工资<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果上图中查询工资所需要的角色变化为总经理和部门经理，此时就需要修改判断逻辑为“判断用户的角色是否是总经理或部门经理”，修改代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(主体.hasRole(<span class="hljs-string">&quot;总经理角色id&quot;</span>) ||  主体.hasRole(<span class="hljs-string">&quot;部门经理角色id&quot;</span>))&#123;<br>    查询工资<br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据上边的例子发现，当需要修改角色的权限时就需要修改授权的相关代码，系统可扩展性差。</p>
<p>基于资源的访问控制（Resource-Based Access</p>
<p>Control）是按资源（或权限）进行授权，比如：用户必须具有查询工资权限才可以查询员工工资信息等，访问控制流程如下：</p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227124310952.png" srcset="/img/loading.gif" lazyload alt="image-20231227124310952" style="zoom:80%;" />

<p>根据上图中的判断，授权代码可以表示为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-title function_">if</span><span class="hljs-params">(主体.hasPermission(<span class="hljs-string">&quot;查询工资权限标识&quot;</span>)</span>)&#123;<br>    查询工资<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>优点：系统设计时定义好查询工资的权限标识，即使查询工资需要的角色变化未总经理和部门经理也不需要修改授权代码，系统可扩展性强</p>
<h5 id="资源服务授权流程"><a href="#资源服务授权流程" class="headerlink" title="资源服务授权流程"></a><strong>资源服务授权流程</strong></h5><p>本项目在资源服务内部进行授权，基于<code>资源</code>的授权模式，因为接口在资源服务，通过在<code>接口</code>处添加<code>授权注解</code>实现授权</p>
<p>1、首先配置nginx代理</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">Java</span><br>   http &#123;<br>    <span class="hljs-attribute">server_names_hash_bucket_size</span> <span class="hljs-number">64</span>;<br>    ...<br>   <br>   <span class="hljs-comment">#前端开发服务</span><br>  <span class="hljs-section">upstream</span> uidevserver&#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8601</span> weight=<span class="hljs-number">10</span>;<br>  &#125; <br>   <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  teacher.51xuecheng.cn;<br>        <span class="hljs-comment">#charset koi8-r;</span><br>        <span class="hljs-attribute">ssi</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">ssi_silent_errors</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>        <span class="hljs-comment">#location / &#123;</span><br>         <span class="hljs-comment">#   alias   D:/itcast2022/xc_edu3.0/code_1/dist/;</span><br>         <span class="hljs-comment">#   index  index.html index.htm;</span><br>        <span class="hljs-comment">#&#125;</span><br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">proxy_pass</span>   http://uidevserver;<br>        &#125;<br><br>        <span class="hljs-section">location</span> /api/ &#123;<br>                <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/;<br>        &#125; <br>        <br>        <br>   &#125;<br><br></code></pre></td></tr></table></figure>

<p>加载nginx 配置</p>
<p>2、在资源服务集成Spring Security</p>
<p>在需要授权的接口处使用@PreAuthorize(“hasAuthority(‘权限标识符’)”)进行控制</p>
<p>下边代码指定&#x2F;course&#x2F;list接口需要拥有xc_teachmanager_course_list 权限。</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135247356.png" srcset="/img/loading.gif" lazyload alt="image-20231227135247356"></p>
<p>设置了@PreAuthorize表示执行此方法需要授权，如果当前用户请求接口没有权限则抛出异常</p>
<p>org.springframework.security.access.AccessDeniedException: 不允许访问</p>
<p>3、在统一异常处理处解析此异常信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@ExceptionHandler(Exception.class)</span><br><span class="hljs-meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span><br><span class="hljs-keyword">public</span> RestErrorResponse <span class="hljs-title function_">exception</span><span class="hljs-params">(Exception e)</span> &#123;<br><br>   log.error(<span class="hljs-string">&quot;【系统异常】&#123;&#125;&quot;</span>,e.getMessage(),e);<br>   e.printStackTrace();<br>   <span class="hljs-keyword">if</span>(e.getMessage().equals(<span class="hljs-string">&quot;不允许访问&quot;</span>))&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestErrorResponse</span>(<span class="hljs-string">&quot;没有操作此功能的权限&quot;</span>);<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestErrorResponse</span>(CommonError.UNKOWN_ERROR.getErrMessage());<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>4、重启资源服务进行测试</p>
<p>使用教学机构用户登录系统</p>
<p>这里使用t1用户登录，账号:t1、密码：111111</p>
<p>登录成功，点击“教学机构”</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135503309.png" srcset="/img/loading.gif" lazyload alt="image-20231227135503309"></p>
<p>当用户没有权限时页面提示：没有操作此功能的权限。</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135516048.png" srcset="/img/loading.gif" lazyload alt="image-20231227135516048"></p>
<h5 id="授权相关的数据模型"><a href="#授权相关的数据模型" class="headerlink" title="授权相关的数据模型"></a><strong>授权相关的数据模型</strong></h5><p>如何给用户分配权限呢？</p>
<p>首先要学习数据模型，本项目授权相关的数据表如下：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135538956.png" srcset="/img/loading.gif" lazyload alt="image-20231227135538956"></p>
<p>说明如下：</p>
<p>xc_user：用户表，存储了系统用户信息，用户类型包括：学生、老师、管理员等</p>
<p>xc_role：角色表，存储了系统的角色信息，学生、老师、教学管理员、系统管理员等。</p>
<p>xc_user_role：用户角色表，一个用户可拥有多个角色，一个角色可被多个用户所拥有</p>
<p>xc_menu:模块表，记录了菜单及菜单下的权限</p>
<p>xc_permission:角色权限表，一个角色可拥有多个权限，一个权限可被多个角色所拥有</p>
<p>本项目教学阶段不再实现权限定义及用户权限分配的功能，权限分配的界面原型如下图所示：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135552058.png" srcset="/img/loading.gif" lazyload alt="image-20231227135552058"></p>
<p>本项目要求掌握基于权限数据模型（5张数据表），要求在数据库中操作完成给用户分配权限、查询用户权限等需求。</p>
<p>1、查询用户所拥有的权限</p>
<p>步骤：</p>
<p>查询用户的id</p>
<p>查询用户所拥有的角色</p>
<p>查询用户所拥有的权限</p>
<p>例子：</p>
<p>SELECT * FROM xc_menu WHERE id IN(<br>   SELECT menu_id FROM xc_permission WHERE role_id IN(<br>     SELECT role_id FROM xc_user_role WHERE user_id &#x3D; ‘49’<br>   )<br> )</p>
<p>2、给用户分配权限</p>
<p>1）添加权限</p>
<p>查询用户的id</p>
<p>查询权限的id</p>
<p>查询用户的角色，如果没有角色需要先给用户指定角色</p>
<p>向角色权限表添加记录</p>
<p>2）删除用户权限</p>
<p>本项目是基于角色分配权限，如果要删除用户的权限可以给用户换角色，那么新角色下的权限就是用户的权限；如果不换用户的角色可以删除角色下的权限即删除角色权限关系表相应记录，这样操作是将角色下的权限删除，属于该角色的用户都将删除此权限。</p>
<h5 id="查询用户权限"><a href="#查询用户权限" class="headerlink" title="查询用户权限"></a>查询用户权限</h5><p>使用Spring Security进行授权，首先在生成jwt前会查询用户的权限，如下图：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227135645831.png" srcset="/img/loading.gif" lazyload alt="image-20231227135645831"></p>
<p>接下来需要修改UserServiceImpl和PasswordAuthServiceImpl从数据库查询用户的权限。</p>
<p>1、定义mapper接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">XcMenuMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;XcMenu&gt; &#123;<br>    <span class="hljs-meta">@Select(&quot;SELECT    * FROM xc_menu WHERE id IN (SELECT menu_id FROM xc_permission WHERE role_id IN ( SELECT role_id FROM xc_user_role WHERE user_id = #&#123;userId&#125; ))&quot;)</span><br>    List&lt;XcMenu&gt; <span class="hljs-title function_">selectPermissionByUserId</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;userId&quot;)</span> String userId)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>2、修改PasswordAuthServiceImpl</p>
<p>修改UserServiceImpl类的getUserPrincipal方法，查询权限信息</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Java<br>//查询用户身份<br><span class="hljs-built_in">public</span> UserDetails getUserPrincipal(XcUserExt <span class="hljs-keyword">user</span>)&#123;<br>    String <span class="hljs-keyword">password</span> = <span class="hljs-keyword">user</span>.getPassword();<br>    //查询用户权限<br>    List&lt;XcMenu&gt; xcMenus = menuMapper.selectPermissionByUserId(<span class="hljs-keyword">user</span>.getId());<br>    List&lt;String&gt; permissions = <span class="hljs-built_in">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-keyword">if</span>(xcMenus.size()&lt;=<span class="hljs-number">0</span>)&#123;<br>        //用户权限,如果不加则报Cannot pass a <span class="hljs-keyword">null</span> GrantedAuthority collection<br>        permissions.<span class="hljs-keyword">add</span>(&quot;p1&quot;);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        xcMenus.<span class="hljs-keyword">forEach</span>(menu-&gt;&#123;<br>            permissions.<span class="hljs-keyword">add</span>(menu.getCode());<br>        &#125;);<br>    &#125;<br>    //将用户权限放在XcUserExt中<br>    <span class="hljs-keyword">user</span>.setPermissions(permissions);<br><br>    //为了安全在令牌中不放密码<br>    <span class="hljs-keyword">user</span>.setPassword(<span class="hljs-keyword">null</span>);<br>    //将<span class="hljs-keyword">user</span>对象转<span class="hljs-type">json</span><br>    String userString = <span class="hljs-type">JSON</span>.toJSONString(<span class="hljs-keyword">user</span>);<br>    String[] authorities = permissions.toArray(<span class="hljs-built_in">new</span> String[<span class="hljs-number">0</span>]);<br>    UserDetails userDetails = <span class="hljs-keyword">User</span>.withUsername(userString).<span class="hljs-keyword">password</span>(<span class="hljs-keyword">password</span>).authorities(authorities).build();<br>    <span class="hljs-keyword">return</span> userDetails;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="权限测试"><a href="#权限测试" class="headerlink" title="权限测试"></a><strong>权限测试</strong></h6><p>以上实现了认证时从数据库查询用户的权限，下边进行用户授权测试。</p>
<p>重启认证服务，使用内容管理课程列表查询为例，代码如下：</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227150001461.png" srcset="/img/loading.gif" lazyload alt="image-20231227150001461"></p>
<p>用户拥有xc_teachmanager_course_list权限方可访问课程查询接口。</p>
<p>以用户stu1为例，当它没有此权限时页面报“没有此操作的权限”错误</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227150055537.png" srcset="/img/loading.gif" lazyload alt="image-20231227150055537"></p>
<p>将xc_teachmanager_course_list权限分配给用户。</p>
<p>1）首先找到当前用户的角色</p>
<p>2）找到xc_teachmanager_course_list权限的主键</p>
<p>3）在角色权限关系表中添加记录</p>
<p>分配完权限需要重新登录</p>
<p>由于用户分配了xc_teachmanager_course_list权限，用户具有访问课程查询接口的权限。</p>
<h5 id="细粒度授权"><a href="#细粒度授权" class="headerlink" title="细粒度授权"></a><strong>细粒度授权</strong></h5><h6 id="什么是细粒度授权"><a href="#什么是细粒度授权" class="headerlink" title="什么是细粒度授权"></a><strong>什么是细粒度授权</strong></h6><p>细粒度授权也叫数据范围授权，即不同的用户所拥有的操作权限相同，但是能够操作的数据范围不一样，用户A和用户B都是教学机构的，他们都拥有我的课程权限，但是两个用户所查询的数据不一样的</p>
<p>本项目有哪些细粒度授权：</p>
<p>比如：</p>
<p>我的课程，教学机构只允许查询本教学机构下的课程信息</p>
<p>我的选课，学生只能查询自己所选课</p>
<p>如何实现细粒度授权？</p>
<p>细粒度授权设计不同的业务逻辑，通常在<code>service</code>层实现，根据不同的用户进行校验，根据不同的参数查询不同的数据或操作不同的数据</p>
<h6 id="教学机构细粒度授权"><a href="#教学机构细粒度授权" class="headerlink" title="教学机构细粒度授权"></a>教学机构细粒度授权</h6><p>教学机构在维护课程时只允许维护本机构的课程，教学机构细粒度授权过程如下：</p>
<ol>
<li>获取当前登录的用户身份</li>
<li>得到用户所属教育机构的id</li>
<li>查询该教学机构下的课程信息</li>
</ol>
<p>最终实现用户只允许查询自己机构的课程信息</p>
<p>根据公司id查询课程，流程如下：</p>
<ol>
<li>教学机构用户登录系统，从用户身份中取出所属机构的id，在用户表中设计了company_id字段存储该用户所属的机构id.</li>
<li>接口层取出当前登录用户的身份，取出机构id</li>
<li>将机构id传入service方法。</li>
<li>service方法将机构id传入Dao方法，最终查询出本机构的课程信息。</li>
</ol>
<p>代码实现如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;课程查询接口&quot;</span>)</span><br><span class="hljs-meta">@PreAuthorize(<span class="hljs-string">&quot;hasAuthority(&#x27;xc_teachmanager_course_list&#x27;)&quot;</span>)</span><span class="hljs-comment">//拥有课程列表查询的权限方可访问</span><br><span class="hljs-meta">@PostMapping(<span class="hljs-string">&quot;/course/list&quot;</span>)</span><br><span class="hljs-keyword">public</span> PageResult&lt;CourseBase&gt; list(PageParams pageParams, <span class="hljs-meta">@RequestBody</span> QueryCourseParamsDto queryCourseParams)&#123;<br>    <span class="hljs-comment">//取出用户身份</span><br>    XcUser user = SecurityUtil.getUser();<br>    <span class="hljs-comment">//机构id</span><br>    String companyId = user.getCompanyId();<br>    <span class="hljs-keyword">return</span> courseBaseInfoService.queryCourseBaseList(<span class="hljs-built_in">Long</span>.parseLong(companyId),pageParams,queryCourseParams);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>Service方法如下：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs perl">Java<br>@Override<br>public PageResult&lt;CourseBase&gt; queryCourseBaseList(Long companyId,PageParams pageParams, QueryCourseParamsDto queryCourseParamsDto) &#123;<br><br> <span class="hljs-regexp">//</span>构建查询条件对象<br> LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();<br> <span class="hljs-regexp">//</span>机构id<br> queryWrapper.e<span class="hljs-string">q(CourseBase::getCompanyId,companyId)</span>;<br> ....<br><br></code></pre></td></tr></table></figure>

<h6 id="教学机构细粒度授权测试"><a href="#教学机构细粒度授权测试" class="headerlink" title="教学机构细粒度授权测试"></a>教学机构细粒度授权测试</h6><p>使用一个教学机构的用户登录项目，并且此用户具有查询课程的权限。</p>
<p>手机修改数据库指定用户归属到一个机构中，涉及以下数据表：</p>
<p>xc_company为机构表</p>
<p>xc_company_user为机构用户关系表</p>
<p>xc_user表中有company_id字段。</p>
<p>我们准备了t1 用户作为此次测试的用户，使用此用户登录系统：</p>
<p>提前在查询课程列表接口处打上断点。</p>
<p>经过测试可以正常取出用户所属的机构id</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155538069.png" srcset="/img/loading.gif" lazyload alt="image-20231227155538069"></p>
<p>跟踪持久层日志发现已将机构id传入dao方法，拼装sql语句，查询本机构的课程信息</p>
<p><img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155551246.png" srcset="/img/loading.gif" lazyload alt="image-20231227155551246"></p>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a><strong>实战</strong></h4><h5 id="找回密码"><a href="#找回密码" class="headerlink" title="找回密码"></a>找回密码</h5><p>需求：忘记密码需要找回，可以通过手机号找回密码，通过邮箱找回密码以及人工通道。</p>
<p>界面访问地址：<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/findpassword.html">http://www.51xuecheng.cn/findpassword.html</a></p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155646094.png" srcset="/img/loading.gif" lazyload alt="image-20231227155646094" style="zoom: 30%;" />

<p>接口：</p>
<p>手机验证码：&#x2F;api&#x2F;checkcode&#x2F;phone?param1&#x3D;手机号</p>
<p>邮箱验证码：&#x2F;api&#x2F;checkcode&#x2F;phone?param1&#x3D;电子邮箱地址</p>
<p>找回密码：&#x2F;api&#x2F;auth&#x2F;findpassword</p>
<p>请求：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-type">JSON</span><br>&#123;<br>     cellphone:<span class="hljs-string">&#x27;&#x27;</span>,<br>     email:<span class="hljs-string">&#x27;&#x27;</span>,<br>     checkcodekey:<span class="hljs-string">&#x27;&#x27;</span>,<br>     checkcode:<span class="hljs-string">&#x27;&#x27;</span>,<br>     confirmpwd:<span class="hljs-string">&#x27;&#x27;</span>,<br>     <span class="hljs-keyword">password</span>:<span class="hljs-string">&#x27;&#x27;</span><br> &#125;<br><br></code></pre></td></tr></table></figure>

<p>响应：</p>
<p>200: 找回成功</p>
<p>其它：找回失败，失败原因使用统一异常处理返回的信息格式</p>
<p>执行流程<br> 1、校验验证码，不一致则抛出异常</p>
<p>2、判断两次密码是否一致，不一致则抛出异常</p>
<p>3、根据手机号和邮箱查询用户</p>
<p>4、如果找到用户更新为新密码</p>
<h5 id="注册"><a href="#注册" class="headerlink" title="注册"></a><strong>注册</strong></h5><p>需求：为学生提供注册入口，通过此入口注册的用户为学生用户。</p>
<p>界面访问地址：<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/register.html">http://www.51xuecheng.cn/register.html</a></p>
<img src="https://fgj2.oss-cn-beijing.aliyuncs.com/image-20231227155822920.png" srcset="/img/loading.gif" lazyload alt="image-20231227155822920" style="zoom:50%;" />

<p>接口：</p>
<p>手机验证码：&#x2F;api&#x2F;checkcode&#x2F;phone?param1&#x3D;手机号</p>
<p>注册：&#x2F;api&#x2F;auth&#x2F;register</p>
<p>请求：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-type">JSON</span><br>&#123;<br>   cellphone:<span class="hljs-string">&#x27;&#x27;</span>,<br>   username:<span class="hljs-string">&#x27;&#x27;</span>,<br>   email:<span class="hljs-string">&#x27;&#x27;</span>,<br>   nickname:<span class="hljs-string">&#x27;&#x27;</span>,<br>   <span class="hljs-keyword">password</span>:<span class="hljs-string">&#x27;&#x27;</span>,<br>   confirmpwd:<span class="hljs-string">&#x27;&#x27;</span>,<br>   checkcodekey:<span class="hljs-string">&#x27;&#x27;</span>,<br>   checkcode:<span class="hljs-string">&#x27;&#x27;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>响应：</p>
<p>200: 注册成功</p>
<p>其它：注册失败，失败原因使用统一异常处理返回的信息格式</p>
<p>执行流程：</p>
<p>1、校验验证码，如果不一致则抛出异常</p>
<p>2、校验两次密码是否一致，如果不一致则抛出异常</p>
<p>3、校验用户是否存在，如果存在则抛出异常</p>
<p>4、向用户表、用户角色关系表添加数据。角色为学生角色。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="category-chain-item">项目</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" class="print-no-link">#学成在线</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>学成在线认证授权模块</div>
      <div>http://example.com/2023/12/27/学成在线认证授权模块/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>fgj</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年12月27日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/12/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9D%97/" title="学成在线选课学习模块">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">学成在线选课学习模块</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/12/24/%E5%BC%80%E5%8F%91%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/" title="开发中遇到的疑难杂症">
                        <span class="hidden-mobile">开发中遇到的疑难杂症</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":173,"height":346},"mobile":{"show":true},"log":false});</script></body>
</html>
