

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="fgj">
  <meta name="keywords" content="">
  
    <meta name="description" content="学成在线选课学习模块模块需求分析模块介绍本模块实现了学生选课、下单支付、学习的整体流程。 网站的课程有免费和收费两种，对于免费课程学生选课后可直接学习，对于收费课程学生需要下单且支付成功方可选课、学习。 选课：是将课程加入我的课程表的过程。 我的课程表：记录我在网站学习的课程，我的课程表中有免费课程和收费课程两种，对于免费课程可直接添加到我的课程表，对于收费课程需要下单、支付成功后自动加入我的课程">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线选课学习模块">
<meta property="og:url" content="http://example.com/2023/12/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9D%97/index.html">
<meta property="og:site_name" content="FGJ">
<meta property="og:description" content="学成在线选课学习模块模块需求分析模块介绍本模块实现了学生选课、下单支付、学习的整体流程。 网站的课程有免费和收费两种，对于免费课程学生选课后可直接学习，对于收费课程学生需要下单且支付成功方可选课、学习。 选课：是将课程加入我的课程表的过程。 我的课程表：记录我在网站学习的课程，我的课程表中有免费课程和收费课程两种，对于免费课程可直接添加到我的课程表，对于收费课程需要下单、支付成功后自动加入我的课程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183107025.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183311995.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183325851.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183352609.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183405427.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183440601.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183711890.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183728480.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227192817451.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227192938124.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227193034659.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227193134743.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227193209748.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227193245036.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227193318603.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227210354604.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227210412122.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227220253997.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227220317702.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222035987.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222119819.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222135726.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222217090.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222239304.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222332267.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222351730.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222526187.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222546668.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222558986.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222720763.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222732135.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222748812.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222759514.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222846119.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222856243.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222910116.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222955798.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227223708482.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227223728162.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227223737861.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227223753507.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227223819177.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227224325344.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228105119750.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228105127061.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228105132882.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228105136481.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228122017158.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228122951520.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123118940.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123217999.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123246199.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123300596.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123308530.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123318978.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123332015.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123342421.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123354472.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123405580.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228124613838.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228130333847.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228130352721.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228130615281.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228130627772.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228130911469.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228131040367.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228131047937.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228131053925.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228131059488.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228134423910.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228140552111.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228150138159.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228154534620.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228154549404.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228160002856.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228160054086.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228160632215.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228161740547.png">
<meta property="og:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228162734898.png">
<meta property="article:published_time" content="2023-12-28T08:28:42.000Z">
<meta property="article:modified_time" content="2024-01-14T07:34:24.483Z">
<meta property="article:author" content="fgj">
<meta property="article:tag" content="学成在线">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183107025.png">
  
  
  
  <title>学成在线选课学习模块 - FGJ</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Home</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://fgj3.oss-cn-beijing.aliyuncs.com/wallhaven-3zmr6y_1920x1080.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="学成在线选课学习模块"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-12-28 16:28" pubdate>
          2023年12月28日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          76k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          637 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">学成在线选课学习模块</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><h2 id="选课学习模块"><a href="#选课学习模块" class="headerlink" title="选课学习模块"></a>选课学习模块</h2><h3 id="模块需求分析"><a href="#模块需求分析" class="headerlink" title="模块需求分析"></a><strong>模块需求分析</strong></h3><h4 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h4><p>本模块实现了学生选课、下单支付、学习的整体流程。</p>
<p>网站的课程有免费和收费两种，对于免费课程学生选课后可直接学习，对于收费课程学生需要下单且支付成功方可选课、学习。</p>
<p>选课：是将课程加入我的课程表的过程。</p>
<p>我的课程表：记录我在网站学习的课程，我的课程表中有免费课程和收费课程两种，对于免费课程可直接添加到我的课程表，对于收费课程需要下单、支付成功后自动加入我的课程表。</p>
<p>模块整体流程如下：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183107025.png" srcset="/img/loading.gif" lazyload alt="image-20231227183107025"></p>
<h4 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h4><h5 id="学习引导"><a href="#学习引导" class="headerlink" title="学习引导"></a><strong>学习引导</strong></h5><p>用户通过搜索课程、课程推荐等信息进入课程详情页面，点击“马上学习” 引导进入学习界面去学习。</p>
<p>流程如下：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183311995.png" srcset="/img/loading.gif" lazyload alt="image-20231227183311995"></p>
<p>1、进入课程详情点击马上学习</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183325851.png" srcset="/img/loading.gif" lazyload alt="image-20231227183325851"></p>
<p>2、课程免费时引导加入我的课程表、或进入学习界面。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183352609.png" srcset="/img/loading.gif" lazyload alt="image-20231227183352609"></p>
<p>3、课程收费时引导去支付、或试学。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183405427.png" srcset="/img/loading.gif" lazyload alt="image-20231227183405427"></p>
<h5 id="选课流程"><a href="#选课流程" class="headerlink" title="选课流程"></a><strong>选课流程</strong></h5><p>选课是将课程加入我的课程表的过程。</p>
<p>对免费课程选课后可直接加入我的课程表，对收费课程选课后需要下单支付成功系统自动加入我的课程表。</p>
<p>流程如下：</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183440601.png" srcset="/img/loading.gif" lazyload alt="image-20231227183440601" style="zoom:70%;" />

<h5 id="支付流程"><a href="#支付流程" class="headerlink" title="支付流程"></a><strong>支付流程</strong></h5><p>本项目与第三方支付平台对接完成支付操作</p>
<p>流程如下</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183711890.png" srcset="/img/loading.gif" lazyload alt="image-20231227183711890"></p>
<h5 id="在线学习"><a href="#在线学习" class="headerlink" title="在线学习"></a><strong>在线学习</strong></h5><p>选课成功用户可以在线学习，对于免费课程无需选课即可在线学习。</p>
<p>流程如下</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227183728480.png" srcset="/img/loading.gif" lazyload alt="image-20231227183728480"></p>
<h5 id="免费课程续期"><a href="#免费课程续期" class="headerlink" title="免费课程续期"></a><strong>免费课程续期</strong></h5><p>免费课程加入我的课程表默认为1年有效期，到期用户可申请续期，流程如下：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227192817451.png" srcset="/img/loading.gif" lazyload alt="image-20231227192817451"></p>
<h3 id="添加选课"><a href="#添加选课" class="headerlink" title="添加选课"></a><strong>添加选课</strong></h3><h5 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h5><h6 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h6><p>选课是将课程加入我的课程表的过程，根据选课的业务流程进行详细分析，业务流程如下：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227192938124.png" srcset="/img/loading.gif" lazyload alt="image-20231227192938124"></p>
<p>选课信息存入选课记录表，免费课程被选课除了进入选课记录表同时进入我的课程表，收费课程进入选课记录表后需要经过下单、支付成功才可以进入我的课程表。</p>
<p>我的课程表记录了用户学习的课程，包括免费课程、收费课程（已经支付）。</p>
<p>1、选课记录表</p>
<p>当用户将课程添加到课程表时需要先创建选课记录</p>
<p>结构如<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227193034659.png" srcset="/img/loading.gif" lazyload alt="image-20231227193034659">：</p>
<p>选课类型：免费课程、收费课程。</p>
<p>选课状态：选课成功、待支付、选课删除。</p>
<p>对于免费课程：课程价格为0，有效期默认365，开始服务时间为选课时间，结束服务时间为选课时间加1年后的时间，选课状态为选课成功。</p>
<p>对于收费课程：按课程的现价、有效期确定开始服务时间、结束服务时间，选课状态为待支付。</p>
<p>收费课程的选课记录需要支付成功后选课状态为成功。</p>
<p>2、我的课程表</p>
<p>我的课程表中记录了用户选课成功的课程，所以我的课程表的数据来源于选课记录表。</p>
<p>对于免费课程创建选课记录后同时向我的课程表添加记录。</p>
<p>对于收费课程创建选课记录后需要下单支付成功后自动向我的课程表添加记录。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227193134743.png" srcset="/img/loading.gif" lazyload alt="image-20231227193134743"></p>
<h6 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a><strong>执行流程</strong></h6><p>在学习引导处，可以直接将免费课程加入我的课程表，如下图：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227193209748.png" srcset="/img/loading.gif" lazyload alt="image-20231227193209748"></p>
<p>对于收费课程先创建选课记录表，支付成功后，收到支付结果由系统自动加入我的课程表。</p>
<p>执行流程如下：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227193245036.png" srcset="/img/loading.gif" lazyload alt="image-20231227193245036"></p>
<h5 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h5><h6 id="部署学习中心工程"><a href="#部署学习中心工程" class="headerlink" title="部署学习中心工程"></a><strong>部署学习中心工程</strong></h6><p>从课程资料拷贝学习中心服务工程到自己的工程目录，结构如下：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227193318603.png" srcset="/img/loading.gif" lazyload alt="image-20231227193318603"></p>
<p>注意去修改nacos的命名空间。</p>
<p>创建数据库xc_learning，并导入数据</p>
<p>修改数据库的连接，改成自己的数据库。</p>
<p>nacos配置文件：learning-api-dev.yaml</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">YAML</span><br><span class="hljs-attribute">server</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">servlet</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">context-path</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/learning</span><br>  <span class="hljs-attribute">port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">63020</span><br><br><br></code></pre></td></tr></table></figure>

<p>learning-service-dev.yaml</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dts">YAML<br><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">  datasource:</span><br>    driver-class-name: com.mysql.cj.jdbc.Driver<br><span class="hljs-symbol">    url:</span> jdbc:mysql:<span class="hljs-comment">//192.168.101.65:3306/xc402_learning?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span><br><span class="hljs-symbol">    username:</span> root<br><span class="hljs-symbol">    password:</span> mysql<br><br></code></pre></td></tr></table></figure>

<h6 id="添加查询课程接口"><a href="#添加查询课程接口" class="headerlink" title="添加查询课程接口"></a><strong>添加查询课程接口</strong></h6><p>内容管理服务提供查询课程信息接口，此接口从课程发布表查询。</p>
<p>此接口主要提供其它微服务远程调用，所以此接口不用授权，本项目标记此类接口统一以 &#x2F;r开头。</p>
<p>在课程发布controller类中定义课程发布信息查询接口。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;查询课程发布信息&quot;</span>)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/r/coursepublish/&#123;courseId&#125;&quot;</span>)</span><br><span class="hljs-keyword">public</span> CoursePublish getCoursepublish(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> courseId) &#123;<br>    CoursePublish coursePublish = coursePublishService.getCoursePublish(courseId);<br>     <span class="hljs-keyword">return</span> coursePublish;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>Service如下：</p>
<p>如果课程发布状态正常则正常返回，否则返回空。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">public</span> CoursePublish <span class="hljs-title function_">getCoursePublish</span><span class="hljs-params">(Long courseId)</span>&#123;<br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> coursePublishMapper.selectById(courseId);<br>    <span class="hljs-keyword">return</span> coursePublish ;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>测试：</p>
<p>启动内容管理服务，使用httpclient测试</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dts">Plain Text<br><span class="hljs-meta">### 查询课程发布信息</span><br><span class="hljs-title class_">GET</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>content_host<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-keyword">/content/</span>r<span class="hljs-keyword">/coursepublish/</span><span class="hljs-number">2</span><br><br></code></pre></td></tr></table></figure>

<p>由于是在网关处进行令牌校验，所以在微服务处不再校验令牌的合法性，修改内容管理content-api工程的ResouceServerConfig类，屏蔽authenticated()。</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">Java<br> @Override<br> public void configure<span class="hljs-params">(HttpSecurity http)</span> throws Exception &#123;<br>  http.csrf<span class="hljs-params">()</span><span class="hljs-string">.disable</span><span class="hljs-params">()</span><br>          <span class="hljs-string">.authorizeRequests</span><span class="hljs-params">()</span><br><span class="hljs-string">//</span>          <span class="hljs-string">.antMatchers</span><span class="hljs-params">(&quot;/r/**&quot;,&quot;/course/**&quot;)</span><span class="hljs-string">.authenticated</span><span class="hljs-params">()</span><span class="hljs-string">//</span>所有<span class="hljs-string">/r/</span>**的请求必须认证通过<br>          <span class="hljs-string">.anyRequest</span><span class="hljs-params">()</span><span class="hljs-string">.permitAll</span><span class="hljs-params">()</span><br>  ;<br> &#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="测试查询课程信息接口"><a href="#测试查询课程信息接口" class="headerlink" title="测试查询课程信息接口"></a><strong>测试查询课程信息接口</strong></h6><p>学生中心服务远程调用内容管理服务的查询课程发布信息接口。</p>
<p>导入的学习中心工程已经存在ContentServiceClient 接口，通过此接口远程调用课程查询接口。</p>
<p>编写测试接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning;<br><br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CoursePublish;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.feignclient.ContentServiceClient;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Assertions;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> Feign接口测试类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/24 17:15</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignClientTest</span> &#123;<br><br>  <span class="hljs-meta">@Autowired</span><br> ContentServiceClient contentServiceClient;<br><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testContentServiceClient</span><span class="hljs-params">()</span>&#123;<br>   <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursepublish</span> <span class="hljs-operator">=</span> contentServiceClient.getCoursepublish(<span class="hljs-number">18L</span>);<br>   Assertions.assertNotNull(coursepublish);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>在进行feign远程调用时会将字符串转成LocalDateTime，在CoursePublish 类中LocalDateTime的属性上边添加如下代码：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">@<span class="hljs-built_in">JsonFormat</span>(shape = JsonFormat<span class="hljs-selector-class">.Shape</span><span class="hljs-selector-class">.STRING</span>,pattern = <span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)<br></code></pre></td></tr></table></figure>

<h6 id="添加选课接口"><a href="#添加选课接口" class="headerlink" title="添加选课接口"></a><strong>添加选课接口</strong></h6><p> <strong>接口分析</strong></p>
<p>本接口支持免费课程选课、收费课程选课。</p>
<p>免费课程选课：添加选课记录、添加我的课程表。</p>
<p>收费课程选课：添加选课记录。</p>
<p><strong>接口定义</strong></p>
<p>1、请求参数：课程id、当前用户id</p>
<p>2、响应结果：选课记录信息、学习资格</p>
<p>学习资格：<code>[&#123;&quot;code&quot;:&quot;702001&quot;,&quot;desc&quot;:&quot;正常学习&quot;&#125;,&#123;&quot;code&quot;:&quot;702002&quot;,&quot;desc&quot;:&quot;没有选课或选课后没有支付&quot;&#125;,&#123;&quot;code&quot;:&quot;702003&quot;,&quot;desc&quot;:&quot;已过期需要申请续期或重新支付&quot;&#125;]</code></p>
<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.learning.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.service.MyCourseTablesService;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.util.SecurityUtil;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 我的课程表接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/2 14:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = &quot;我的课程表接口&quot;, tags = &quot;我的课程表接口&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCourseTablesController</span> &#123;<br>    <span class="hljs-meta">@ApiOperation(&quot;添加选课&quot;)</span><br>     <span class="hljs-meta">@PostMapping(&quot;/choosecourse/&#123;courseId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> XcChooseCourseDto <span class="hljs-title function_">addChooseCourse</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>  &#123;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Service接口定义：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.po.XcChooseCourse;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.po.XcCourseTables;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 我的课程表service接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/2 16:07</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyCourseTablesService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 添加选课</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId 用户id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId 课程id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.xuecheng.learning.model.dto.XcChooseCourseDto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/24 17:33</span><br><span class="hljs-comment">*/</span><br> <span class="hljs-keyword">public</span> XcChooseCourseDto addChooseCourse(String userId, <span class="hljs-built_in">Long</span> courseId);<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>Service接口执行流程</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs typescript">package com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">service</span>;<br><br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">content</span>.<span class="hljs-property">model</span>.<span class="hljs-property">po</span>.<span class="hljs-property">CoursePublish</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">feignclient</span>.<span class="hljs-property">ContentServiceClient</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">mapper</span>.<span class="hljs-property">XcChooseCourseMapper</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">mapper</span>.<span class="hljs-property">XcCourseTablesMapper</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">model</span>.<span class="hljs-property">dto</span>.<span class="hljs-property">XcChooseCourseDto</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">model</span>.<span class="hljs-property">po</span>.<span class="hljs-property">XcChooseCourse</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">model</span>.<span class="hljs-property">po</span>.<span class="hljs-property">XcCourseTables</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Autowired</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Service</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">transaction</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Transactional</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 付广建 2023/12/27 20:23</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCourseTablesServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MyCourseTablesService</span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-title class_">XcChooseCourseMapper</span> xcChooseCourseMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-title class_">XcCourseTablesMapper</span> xcCourseTablesMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-title class_">ContentServiceClient</span> contentServiceClient;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-title class_">MyCourseTablesService</span> myCourseTablesService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-title class_">MyCourseTablesServiceImpl</span> currentProxy;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">XcChooseCourseDto</span> <span class="hljs-title function_">addChooseCourse</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userId,Long courseId</span>) &#123;<br>        <span class="hljs-comment">//查询课程信息</span><br>        <span class="hljs-title class_">CoursePublish</span> coursepublish = contentServiceClient.<span class="hljs-title function_">getCoursepublish</span>(courseId);<br>        <span class="hljs-comment">//课程收费标准</span><br>        <span class="hljs-title class_">String</span> charge = coursepublish.<span class="hljs-title function_">getCharge</span>();<br>        <span class="hljs-comment">//选课记录</span><br>        <span class="hljs-title class_">XcChooseCourse</span> chooseCourse = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;201000&quot;</span>.<span class="hljs-title function_">equals</span>(charge))&#123;<span class="hljs-comment">//课程免费</span><br>            <span class="hljs-comment">//添加免费课程</span><br>            chooseCourse  = <span class="hljs-title function_">addFreeCoruse</span>(userId, coursepublish);<br>            <span class="hljs-comment">//添加到我的课程表</span><br>            <span class="hljs-title class_">XcCourseTables</span> xcCourseTables = <span class="hljs-title function_">addCourseTables</span>(chooseCourse);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">//添加收费课程</span><br>            chooseCourse  = <span class="hljs-title function_">addChargeCoruse</span>(userId, coursepublish);<br>        &#125;<br>        <span class="hljs-comment">//获取学习资格</span><br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//添加免费课程,免费课程加入选课记录表、我的课程表</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">XcChooseCourse</span> <span class="hljs-title function_">addFreeCoruse</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userId, CoursePublish coursepublish</span>) &#123;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//添加收费课程</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">XcChooseCourse</span> <span class="hljs-title function_">addChargeCoruse</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userId,CoursePublish coursepublish</span>)&#123;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">//添加到我的课程表</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">XcCourseTables</span> <span class="hljs-title function_">addCourseTables</span>(<span class="hljs-params">XcChooseCourse xcChooseCourse</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>添加免费课程</strong></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs perl">//添加免费课程,免费课程加入选课记录表、我的课程表<br>public XcChooseCourse addFreeCourse(String userId, CoursePublish coursepublish) &#123;<br>    <span class="hljs-regexp">//</span>查询选课记录表是否存在免费的且选课成功的订单<br>    LambdaQueryWrapper&lt;XcChooseCourse&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();<br>    queryWrapper = queryWrapper.e<span class="hljs-string">q(XcChooseCourse::getUserId, userId)</span><br>            .e<span class="hljs-string">q(XcChooseCourse::getCourseId, coursepublish.getId()</span>)<br>            .e<span class="hljs-string">q(XcChooseCourse::getOrderType, &quot;700001&quot;)</span>//免费课程<br>            .e<span class="hljs-string">q(XcChooseCourse::getStatus, &quot;701001&quot;)</span>;<span class="hljs-regexp">//</span>选课成功<br>    List&lt;XcChooseCourse&gt; xcChooseCourses = xcChooseCourseMapper.selectList(queryWrapper);<br>    <span class="hljs-keyword">if</span> (xcChooseCourses!=null&amp;&amp;xcChooseCourses.size()&gt;<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">return</span> xcChooseCourses.get(<span class="hljs-number">0</span>);<br>    &#125;<br>    //添加选课记录信息<br>    XcChooseCourse xcChooseCourse = new XcChooseCourse();<br>    xcChooseCourse.setCourseId(coursepublish.getId());<br>    xcChooseCourse.setCompanyId(coursepublish.getCompanyId());<br>    xcChooseCourse.setValidDays(coursepublish.getValidDays());<br>    xcChooseCourse.setStatus(coursepublish.getStatus());<br>    xcChooseCourse.setCoursePrice(0f);<span class="hljs-regexp">//</span>免费课程价格为<span class="hljs-number">0</span><br>    xcChooseCourse.setUserId(userId);<br>    xcChooseCourse.setOrderType(<span class="hljs-string">&quot;700001&quot;</span>);<span class="hljs-regexp">//</span>免费课程<br>    xcChooseCourse.setCreateDate(LocalDateTime.now());<br>    xcChooseCourse.setStatus(<span class="hljs-string">&quot;701001&quot;</span>);<span class="hljs-regexp">//</span>选课成功<br>    xcChooseCourse.setValidDays(<span class="hljs-number">365</span>);<br>    xcChooseCourse.setValidtimeStart(LocalDateTime.now());<br>    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(<span class="hljs-number">365</span>));<br>    xcChooseCourseMapper.insert(xcChooseCourse);<br>    <span class="hljs-keyword">return</span> xcChooseCourse;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>添加我的课程表</strong></p>
<p>我的课程表的记录来源于选课记录，选课记录成功将课程信息添加到我的课程表。如果我的课程表已存在课程可能已经过期，如果有新的课程记录则需要我的课程表中的现有信息。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-comment">//添加到我的课程表</span><br>    <span class="hljs-keyword">public</span> XcCourseTables addCourseTables(XcChooseCourse xcChooseCourse)&#123;<br>        <span class="hljs-comment">//选课记录完成且未过期可以添加课程到课程表</span><br>        <span class="hljs-built_in">String</span> status = xcChooseCourse.getStatus();<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;701001&quot;</span>.<span class="hljs-keyword">equals</span>(status))&#123;<br>            XueChengPlusException.cast(<span class="hljs-string">&quot;选课未成功，无法添加到课程表&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//查询我的课程表</span><br>        XcCourseTables xcCourseTables = getXcCourseTables(xcChooseCourse.getUserId(), xcChooseCourse.getCourseId());<br>        <span class="hljs-keyword">if</span> (xcCourseTables!=<span class="hljs-built_in">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> xcCourseTables;<br>        &#125;<br>        XcCourseTables xcCourseTablesNew = <span class="hljs-literal">new</span> XcCourseTables();<br>        xcCourseTablesNew.setChooseCourseId(xcChooseCourse.getId());<br>        xcCourseTablesNew.setUserId(xcChooseCourse.getUserId());<br>        xcCourseTablesNew.setCourseId(xcChooseCourse.getCourseId());<br>        xcCourseTablesNew.setCompanyId(xcChooseCourse.getCompanyId());<br>        xcCourseTablesNew.setCourseName(xcChooseCourse.getCourseName());<br>        xcCourseTablesNew.setCreateDate(LocalDateTime.now());<br>        xcCourseTablesNew.setValidtimeStart(xcChooseCourse.getValidtimeStart());<br>        xcCourseTablesNew.setValidtimeEnd(xcChooseCourse.getValidtimeEnd());<br>        xcCourseTablesNew.setCourseType(xcChooseCourse.getOrderType());<br>        xcCourseTablesMapper.insert(xcCourseTablesNew);<br><br>        <span class="hljs-keyword">return</span> xcCourseTablesNew;<br>    &#125;<br><br>    <span class="hljs-comment">//根据课程和用户查询我的课程表中某一门课程</span><br>    <span class="hljs-keyword">private</span> XcCourseTables getXcCourseTables(<span class="hljs-built_in">String</span> userId, Long courseId) &#123;<br>        XcCourseTables xcCourseTables = xcCourseTablesMapper<br>                .selectOne(<span class="hljs-literal">new</span> LambdaQueryWrapper&lt;XcCourseTables&gt;()<br>                        .<span class="hljs-literal">eq</span>(XcCourseTables<span class="hljs-type">::getUserId</span>, userId)<br>                        .<span class="hljs-literal">eq</span>(XcCourseTables<span class="hljs-type">::getCourseId</span>, courseId));<br>        <span class="hljs-keyword">return</span> xcCourseTables;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><strong>添加收费课程</strong></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs perl">//添加收费课程<br>public XcChooseCourse addChargeCourse(String userId,CoursePublish coursepublish)&#123;<br>    <span class="hljs-regexp">//</span>如果存在待支付交易记录直接返回<br>    LambdaQueryWrapper&lt;XcChooseCourse&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();<br>    queryWrapper = queryWrapper.e<span class="hljs-string">q(XcChooseCourse::getUserId,userId)</span><br>            .e<span class="hljs-string">q(XcChooseCourse::getCourseId,coursepublish.getId()</span>)<br>            .e<span class="hljs-string">q(XcChooseCourse::getOrderType, &quot;700002&quot;)</span>//收费订单<br>            .e<span class="hljs-string">q(XcChooseCourse::getStatus, &quot;701002&quot;)</span>;<span class="hljs-regexp">//</span>待支付<br>    List&lt;XcChooseCourse&gt; xcChooseCourses = xcChooseCourseMapper.selectList(queryWrapper);<br>    <span class="hljs-keyword">if</span> (xcChooseCourses!=null&amp;&amp;xcChooseCourses.size()&gt;<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">return</span> xcChooseCourses.get(<span class="hljs-number">0</span>);<br>    &#125;<br>    XcChooseCourse xcChooseCourse = new XcChooseCourse();<br>    xcChooseCourse.setCourseId(coursepublish.getId());<br>    xcChooseCourse.setCourseName(coursepublish.getName());<br>    xcChooseCourse.setCoursePrice(coursepublish.getPrice());<br>    xcChooseCourse.setUserId(userId);<br>    xcChooseCourse.setCompanyId(coursepublish.getCompanyId());<br>    xcChooseCourse.setOrderType(<span class="hljs-string">&quot;700002&quot;</span>);<span class="hljs-regexp">//</span>收费课程<br>    xcChooseCourse.setCreateDate(LocalDateTime.now());<br>    xcChooseCourse.setStatus(<span class="hljs-string">&quot;701002&quot;</span>);<span class="hljs-regexp">//</span>待支付<br><br>    xcChooseCourse.setValidDays(coursepublish.getValidDays());<br>    xcChooseCourse.setValidtimeStart(LocalDateTime.now());<br>    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(coursepublish.getValidDays()));<br>    xcChooseCourseMapper.insert(xcChooseCourse);<br>    <span class="hljs-keyword">return</span> xcChooseCourse;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>获取学习资格</strong></p>
<p>定义获取学习资格接口</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs julia">Java<br>public interface MyCourseTablesService &#123;<br><br>    public XcChooseCourseDto addChooseCourse(<span class="hljs-built_in">String</span> userId, Long courseId);<br>    /**<br>     * <span class="hljs-meta">@description</span> 判断学习资格<br>     * <span class="hljs-meta">@param</span> userId<br>     * <span class="hljs-meta">@param</span> courseId<br>     * <span class="hljs-meta">@return</span> XcCourseTablesDto 学习资格状态 [&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702001&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;正常学习&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702002&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;没有选课或选课后没有支付&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702003&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;已过期需要申请续期或重新支付&quot;</span>&#125;]<br>     * <span class="hljs-meta">@author</span> Mr.M<br>     * <span class="hljs-meta">@date</span> <span class="hljs-number">2022</span>/<span class="hljs-number">10</span>/<span class="hljs-number">3</span> <span class="hljs-number">7</span>:<span class="hljs-number">37</span><br>     */<br>    public XcCourseTablesDto getLearningStatus(<span class="hljs-built_in">String</span> userId, Long courseId);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>接口实现如下：</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">Java<br><span class="hljs-operator">/**</span><br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span>description 判断学习资格<br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span>param userId<br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span>param courseId<br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span><span class="hljs-keyword">return</span> XcCourseTablesDto 学习资格状态 [&#123;<span class="hljs-string">&quot;code&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;702001&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;正常学习&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;702002&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;没有选课或选课后没有支付&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;702003&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;已过期需要申请续期或重新支付&quot;</span>&#125;]<br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span>author Mr.M<br> <span class="hljs-operator">*</span> <span class="hljs-operator">@</span>date <span class="hljs-number">2022</span><span class="hljs-operator">/</span><span class="hljs-number">10</span><span class="hljs-operator">/</span><span class="hljs-number">3</span> <span class="hljs-number">7</span><span class="hljs-operator">:</span>37<br><span class="hljs-operator">*/</span><br><span class="hljs-keyword">public</span> XcCourseTablesDto getLearningStatus(String userId, Long courseId)&#123;<br>    <span class="hljs-comment">//查询我的课程表</span><br>    XcCourseTables xcCourseTables <span class="hljs-operator">=</span> getXcCourseTables(userId, courseId);<br>    <span class="hljs-keyword">if</span>(xcCourseTables<span class="hljs-operator">==</span><span class="hljs-literal">null</span>)&#123;<br>        XcCourseTablesDto xcCourseTablesDto <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> XcCourseTablesDto();<br>        <span class="hljs-comment">//没有选课或选课后没有支付</span><br>        xcCourseTablesDto.setLearnStatus(<span class="hljs-string">&quot;702002&quot;</span>);<br>        <span class="hljs-keyword">return</span> xcCourseTablesDto;<br>    &#125;<br>    XcCourseTablesDto xcCourseTablesDto <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> XcCourseTablesDto();<br>    BeanUtils.copyProperties(xcCourseTables,xcCourseTablesDto);<br>    <span class="hljs-comment">//是否过期,true过期，false未过期</span><br>    boolean isExpires <span class="hljs-operator">=</span> xcCourseTables.getValidtimeEnd().isBefore(LocalDateTime.now());<br>    <span class="hljs-keyword">if</span>(<span class="hljs-operator">!</span>isExpires)&#123;<br>        <span class="hljs-comment">//正常学习</span><br>        xcCourseTablesDto.setLearnStatus(<span class="hljs-string">&quot;702001&quot;</span>);<br>       <span class="hljs-keyword">return</span> xcCourseTablesDto;<br><br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-comment">//已过期</span><br>        xcCourseTablesDto.setLearnStatus(<span class="hljs-string">&quot;702003&quot;</span>);<br>        <span class="hljs-keyword">return</span> xcCourseTablesDto;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p> <strong>service接口完善</strong></p>
<p>完善Service接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> XcChooseCourseDto <span class="hljs-title function_">addChooseCourse</span><span class="hljs-params">(String userId,Long courseId)</span> &#123;<br>    <span class="hljs-comment">//查询课程信息</span><br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursepublish</span> <span class="hljs-operator">=</span> contentServiceClient.getCoursepublish(courseId);<br>    <span class="hljs-comment">//课程收费标准</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">charge</span> <span class="hljs-operator">=</span> coursepublish.getCharge();<br>    <span class="hljs-comment">//选课记录</span><br>    <span class="hljs-type">XcChooseCourse</span> <span class="hljs-variable">chooseCourse</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;201000&quot;</span>.equals(charge))&#123;<span class="hljs-comment">//课程免费</span><br>        <span class="hljs-comment">//添加免费课程</span><br>        chooseCourse  = addFreeCourse(userId, coursepublish);<br>        <span class="hljs-comment">//添加到我的课程表</span><br>        <span class="hljs-type">XcCourseTables</span> <span class="hljs-variable">xcCourseTables</span> <span class="hljs-operator">=</span> addCourseTables(chooseCourse);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-comment">//添加收费课程</span><br>        chooseCourse  = addChargeCourse(userId, coursepublish);<br>    &#125;<br>    <span class="hljs-type">XcChooseCourseDto</span> <span class="hljs-variable">xcChooseCourseDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XcChooseCourseDto</span>();<br>    BeanUtils.copyProperties(chooseCourse,xcChooseCourseDto);<br>    <span class="hljs-comment">//获取学习资格</span><br>    <span class="hljs-type">XcCourseTablesDto</span> <span class="hljs-variable">xcCourseTablesDto</span>  <span class="hljs-operator">=</span> getLearningStatus(userId, courseId);<br>    xcChooseCourseDto.setLearnStatus(xcCourseTablesDto.getLearnStatus());<br>    <span class="hljs-keyword">return</span> xcChooseCourseDto;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>完善controller</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@Autowired</span><br>MyCourseTablesService courseTablesService;<br><br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;添加选课&quot;</span>)</span><br><span class="hljs-meta">@PostMapping(<span class="hljs-string">&quot;/choosecourse/&#123;courseId&#125;&quot;</span>)</span><br><span class="hljs-keyword">public</span> XcChooseCourseDto addChooseCourse(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> courseId) &#123;<br>    <span class="hljs-comment">//登录用户</span><br>    SecurityUtil.XcUser user = SecurityUtil.getUser();<br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;请登录后继续选课&quot;</span>);<br>    &#125;<br>    String userId = user.getId();<br>    <span class="hljs-keyword">return</span>  courseTablesService.addChooseCourse(userId, courseId);<br><br>&#125;<br><br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;查询学习资格&quot;</span>)</span><br><span class="hljs-meta">@PostMapping(<span class="hljs-string">&quot;/choosecourse/learnstatus/&#123;courseId&#125;&quot;</span>)</span><br><span class="hljs-keyword">public</span> XcCourseTablesDto getLearnstatus(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> courseId) &#123;<br>    <span class="hljs-comment">//登录用户</span><br>    SecurityUtil.XcUser user = SecurityUtil.getUser();<br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;请登录后继续选课&quot;</span>);<br>    &#125;<br>    String userId = user.getId();<br>    <span class="hljs-keyword">return</span>  courseTablesService.getLeanringStatus(userId, courseId);<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h5><h6 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a><strong>单元测试</strong></h6><p>1、准备测试环境</p>
<p>发布两门课程，一门为免费，一门为收费。</p>
<p>小技巧：可以更改课程发布表已有课程的收费标准进行测试。</p>
<p>2、测试添加免费课程</p>
<p>成功：选课记录表一条记录、我的课程表一条记录。</p>
<p>3、测试添加收费课程</p>
<p>成功：选课记录表一条记录</p>
<p>4、重复添加选课</p>
<p>重复添加相同的课程，观察是否存在异常。</p>
<p>5、生成令牌，为方便生成令牌暂时将PasswordAuthServiceImpl类中的验证码屏蔽</p>
<p>6、使用httpclient测试如下：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs llvm">Bash<br>### 添加选课<br>POST &#123;&#123;learning_host&#125;&#125;/learning/choosecourse/<span class="hljs-number">2</span><br>Authorization: Bearer eyJhbGciOiJIUzI<span class="hljs-number">1</span>NiIsInR<span class="hljs-number">5</span>cCI<span class="hljs-number">6</span>IkpXVCJ<span class="hljs-number">9</span>.eyJhdWQiOlsieHVlY<span class="hljs-number">2</span>hlbmctcGx<span class="hljs-number">1</span>cyJdLCJ<span class="hljs-number">1</span><span class="hljs-keyword">c</span><span class="hljs-number">2</span>VyX<span class="hljs-number">25</span>hbWUiOiJ<span class="hljs-number">7</span>XCJiaXJ<span class="hljs-number">0</span>aGRheVwiOlwiMjAyMi<span class="hljs-number">0</span>wOS<span class="hljs-number">0</span>yOFQxOToyODo<span class="hljs-number">0</span>NlwiLFwiY<span class="hljs-number">3</span>JlYXRlVGltZVwiOlwiMjAyMi<span class="hljs-number">0</span>wOS<span class="hljs-number">0</span>yOFQwODozMjowM<span class="hljs-number">1</span>wiLFwiaWRcIjpcIjUwXCIsXCJuYW<span class="hljs-number">1</span>lXCI<span class="hljs-number">6</span>XCLlrabnlJ<span class="hljs-number">8</span>xXCIsXCJuaWNrbmFtZVwiOlwi<span class="hljs-number">5</span>aSn<span class="hljs-number">5</span>rC<span class="hljs-number">054</span>mbXCIsXCJwZXJtaXNzaW<span class="hljs-number">9</span>uc<span class="hljs-number">1</span>wiOltcInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJcIixcInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJfdXNlclwiLFwieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">91</span><span class="hljs-keyword">c</span><span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>FkZFwiLFwieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">91</span><span class="hljs-keyword">c</span><span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>VkaXRcIixcInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJfdXNlcl<span class="hljs-number">92</span>aWV<span class="hljs-number">3</span>XCIsXCJ<span class="hljs-number">4</span>Y<span class="hljs-number">19</span>zeXNtYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">3</span>VzZXJfZGVsZXRlXCIsXCJ<span class="hljs-number">4</span>Y<span class="hljs-number">19</span>zeXNtYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>RvY<span class="hljs-number">1</span>wiLFwieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">9</span>sb<span class="hljs-number">2</span>dcIixcInhjX<span class="hljs-number">3</span>RlYWNobWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">3</span>Vyc<span class="hljs-number">2</span>VcIixcInhjX<span class="hljs-number">3</span>RlYWNobWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">3</span>Vyc<span class="hljs-number">2</span>VfYWRkXCIsXCJ<span class="hljs-number">4</span>Y<span class="hljs-number">190</span>ZWFjaG<span class="hljs-number">1</span>hbmFnZXJfY<span class="hljs-number">291</span>cnNlX<span class="hljs-number">2</span>Jhc<span class="hljs-number">2</span>VcIixcInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJfY<span class="hljs-number">29</span>tcGFueVwiLFwieGNfdGVhY<span class="hljs-number">2</span>htYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>NvdXJzZV<span class="hljs-number">9</span>saXN<span class="hljs-number">0XC</span>JdLFwic<span class="hljs-number">2</span>V<span class="hljs-number">4</span>XCI<span class="hljs-number">6</span>XCIxXCIsXCJzdGF<span class="hljs-number">0</span>dXNcIjpcIjFcIixcInVzZXJuYW<span class="hljs-number">1</span>lXCI<span class="hljs-number">6</span>XCJzdHUxXCIsXCJ<span class="hljs-number">1</span><span class="hljs-keyword">c</span><span class="hljs-number">2</span>VycGljXCI<span class="hljs-number">6</span>XCJodHRwOi<span class="hljs-number">8</span>vZmlsZS<span class="hljs-number">54</span>dWVjaGVuZy<span class="hljs-number">1</span>wbHVzLmNvbS<span class="hljs-number">9</span>kZGRmXCIsXCJ<span class="hljs-number">1</span>dHlwZVwiOlwiMTAxMDAxXCJ<span class="hljs-number">9</span>Iiwic<span class="hljs-number">2</span>NvcGUiOlsiYWxsIl<span class="hljs-number">0</span>sImV<span class="hljs-number">4</span>cCI<span class="hljs-number">6</span>MTY<span class="hljs-number">2</span>NzI<span class="hljs-number">5</span>OTQwNiwiYXV<span class="hljs-number">0</span>aG<span class="hljs-number">9</span>yaXRpZXMiOlsieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">9</span>kb<span class="hljs-number">2</span>MiLCJ<span class="hljs-number">4</span>Y<span class="hljs-number">19</span>zeXNtYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">3</span>VzZXJfdmlldyIsInhjX<span class="hljs-number">3</span>RlYWNobWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">3</span>Vyc<span class="hljs-number">2</span>UiLCJ<span class="hljs-number">4</span>Y<span class="hljs-number">19</span>zeXNtYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">3</span>VzZXJfYWRkIiwieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">21</span>wYW<span class="hljs-number">55</span>IiwieGNfc<span class="hljs-number">3</span>lzbWFuYWdlcl<span class="hljs-number">91</span><span class="hljs-keyword">c</span><span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>RlbGV<span class="hljs-number">0</span>ZSIsInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJfdXNlciIsInhjX<span class="hljs-number">3</span>RlYWNobWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">3</span>Vyc<span class="hljs-number">2</span>VfYmFzZSIsInhjX<span class="hljs-number">3</span>RlYWNobWFuYWdlcl<span class="hljs-number">9</span>jb<span class="hljs-number">3</span>Vyc<span class="hljs-number">2</span>VfbGlzdCIsInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXIiLCJ<span class="hljs-number">4</span>Y<span class="hljs-number">19</span>zeXNtYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>xvZyIsInhjX<span class="hljs-number">3</span>N<span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span>hbmFnZXJfdXNlcl<span class="hljs-number">9</span>lZGl<span class="hljs-number">0</span>IiwieGNfdGVhY<span class="hljs-number">2</span>htYW<span class="hljs-number">5</span>hZ<span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>NvdXJzZV<span class="hljs-number">9</span>hZGQiXSwianRpIjoiOTYyOTYzMWQtYjRiMC<span class="hljs-number">00</span>NTlkLTgzYzktM<span class="hljs-number">2</span>Q<span class="hljs-number">4</span>MmRiNmI<span class="hljs-number">4</span>NDEzIiwiY<span class="hljs-number">2</span>xpZW<span class="hljs-number">50</span>X<span class="hljs-number">2</span>lkIjoiWGNXZWJBcHAifQ.b<span class="hljs-number">77</span>ZreiNlPoN-_dnAWxuBfH<span class="hljs-number">32</span>tPIoRwg<span class="hljs-number">2</span>ePgKn_aZ<span class="hljs-number">8</span><span class="hljs-keyword">c</span><br><br></code></pre></td></tr></table></figure>

<h6 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a><strong>前后端联调</strong></h6><p>测试流程：</p>
<p>1、启动认证服务、网关服务、验证码服务、学习中心服务、内容管理服务。</p>
<p>2、发布一门免费课程、一门收费课程</p>
<p>3、进入课程详情界面，点击“马上学习”</p>
<p>4、报名成功，自动跳转到学习界面。</p>
<p>5、观察选课记录表、我的课程表数据是否正确。</p>
<p>对于免费课程在课程详情页面点击“马上学习”，通过引导界面添加选课。</p>
<p>1、进入课程详情点击马上学习</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227210354604.png" srcset="/img/loading.gif" lazyload alt="image-20231227210354604" style="zoom:50%;" />

<p>2、课程免费时引导加入我的课程表、或进入学习界面。</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227210412122.png" srcset="/img/loading.gif" lazyload alt="image-20231227210412122" style="zoom:50%;" />

<h3 id="支付"><a href="#支付" class="headerlink" title="支付"></a>支付</h3><h5 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h5><h6 id="执行流程-1"><a href="#执行流程-1" class="headerlink" title="执行流程"></a>执行流程</h6><p>用户去学习收费课程时引导其去支付，如下图：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227220253997.png" srcset="/img/loading.gif" lazyload alt="image-20231227220253997"></p>
<p>当用户点击“微信支付”或支付宝支付时执行流程如下：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227220317702.png" srcset="/img/loading.gif" lazyload alt="image-20231227220317702"></p>
<ol>
<li>请求学习中心服务创建选课记录</li>
<li>请求订单服务创建商品订单，生成支付二维码</li>
<li>用户扫码请求订单支付服务，订单支付服务请求第三方支付平台生成支付订单</li>
<li>前端唤起支付客户端，用户输入密码完成支付</li>
<li>第三方支付平台支付完成支付通知</li>
<li>订单支付服务接收第三方支付通知结果</li>
<li>用户在前端查询支付结果，请求订单支付服务查询支付结果</li>
<li>订单支付服务向学习中心服务通知支付结果</li>
<li>学习中心服务收到支付结果，如果支付成功则更新选课记录，并添加到我的课程表</li>
</ol>
<h6 id="通用订单服务设计"><a href="#通用订单服务设计" class="headerlink" title="通用订单服务设计"></a><strong>通用订单服务设计</strong></h6><p>在本项目中不仅选课需要下单、购买学习资料、老师一对一答疑等所以收费项目都需要下单支付。</p>
<p>所以本项目设计通用的订单服务，通用的订单服务承接各业务模块的收费支付需求，当用户需要交费时统一生成商品订单并进行支付。</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222035987.png" srcset="/img/loading.gif" lazyload alt="image-20231227222035987" style="zoom:50%;" />

<p>所有收费业务最终转换为商品订单记录在订单服务的<code>商品订单表</code>。</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222119819.png" srcset="/img/loading.gif" lazyload alt="image-20231227222119819" style="zoom:33%;" />

<p>以选课为例，选课记录表的ID记录在商品订单表的out_business_id字段。</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222135726.png" srcset="/img/loading.gif" lazyload alt="image-20231227222135726" style="zoom:50%;" />

<h5 id="支付接口调研"><a href="#支付接口调研" class="headerlink" title="支付接口调研"></a><strong>支付接口调研</strong></h5><h6 id="微信支付接口调研"><a href="#微信支付接口调研" class="headerlink" title="微信支付接口调研"></a><strong>微信支付接口调研</strong></h6><p>一般情况下，一个网站要支持在线支付功能通常接入第三方支付平台，比如：微信支付、支付宝、其它的聚合支付平台。</p>
<p>本项目的需求实现手机扫码支付，现在对微信、支付宝的支付接口进行调研。</p>
<p>微信目前提供的支付方式如下：</p>
<p>地址：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/static/product/product_index.shtml">https://pay.weixin.qq.com/static/product/product_index.shtml</a></p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222217090.png" srcset="/img/loading.gif" lazyload alt="image-20231227222217090" style="zoom:67%;" />

<p>1、付款码支付是指用户展示微信钱包内的“付款码”给商户系统扫描后直接完成支付，适用于线下场所面对面收银的场景，例如商超、便利店、餐饮、医院、学校、电影院和旅游景区等具有明确经营地址的实体场所。</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222239304.png" srcset="/img/loading.gif" lazyload alt="image-20231227222239304" style="zoom:67%;" />

<p>2、JSAPI支付是指商户通过调用微信支付提供的JSAPI接口，在支付场景中调起微信支付模块完成收款</p>
<p>线下场所：调用接口生成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p>
<p>公众号场景：用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付</p>
<p>PC网站场景：在网站中展示二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222332267.png" srcset="/img/loading.gif" lazyload alt="image-20231227222332267" style="zoom:50%;" />

<p>3、小程序支付是指商户通过调用微信支付小程序支付接口，在微信小程序平台内实现支付功能；用户打开商家助手小程序下单，输入支付密码并完成支付后，返回商家小程序。</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222351730.png" srcset="/img/loading.gif" lazyload alt="image-20231227222351730" style="zoom:67%;" />

<p>4、Native支付是指商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站、实体店单品或订单、媒体广告支付等场景。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222526187.png" srcset="/img/loading.gif" lazyload alt="image-20231227222526187"></p>
<p>5、APP支付是指商户通过在移动端应用APP中集成开放SDK调起微信支付模块来完成支付。适用于在移动端APP中集成微信支付功能的场景。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222546668.png" srcset="/img/loading.gif" lazyload alt="image-20231227222546668"></p>
<p>6、刷脸支付是指用户在刷脸设备前通过摄像头刷脸、识别身份后进行的一种支付方式，安全便捷。适用于线下实体场所的收银场景，如商超、餐饮、便利店、医院、学校等。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222558986.png" srcset="/img/loading.gif" lazyload alt="image-20231227222558986"></p>
<p>以上接口native和JSAPI都可以实现pc网站实现扫码支付，两者区别是什么？怎么选择？</p>
<p>JSAPI除了在pc网站扫码支付还可以实现公众号页面内支付，可以实现在手机端H5页面唤起微信客户端完成支付。</p>
<p>本项目选择JSAPI支付接口。</p>
<p>接口文档：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml</a></p>
<p>如何开通JSAPI支付接口?</p>
<p>以企业身份注册微信公众号<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com/</a></p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222720763.png" srcset="/img/loading.gif" lazyload alt="image-20231227222720763" style="zoom:50%;" />

<p>登录公众号，点击左侧菜单“微信支付”开通微信支付，如下：</p>
<p>需要提供营业执照、身份证等信息。</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222732135.png" srcset="/img/loading.gif" lazyload alt="image-20231227222732135" style="zoom:67%;" />

<p>点击申请接入，需要注册微信商户号。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222748812.png" srcset="/img/loading.gif" lazyload alt="image-20231227222748812"></p>
<p>注册微信商户号的过程请参考官方文档，本文档略。参考地址如下：</p>
<p><a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none">https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none</a></p>
<p>开通微信支付后即可在微信商户平台（pay.weixin.qq.com）开通JSAPI支付。</p>
<p>登录商品平台，进入产品中心，开通JSAPI支付：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222759514.png" srcset="/img/loading.gif" lazyload alt="image-20231227222759514"></p>
<p>注意：JSAPI支付方式需要在公众号配置回调域名，此域名为已经备案的外网域名。</p>
<p>最后在公众号开发信息中获取：开发者id、开发者密码。</p>
<h6 id="支付宝接口调研"><a href="#支付宝接口调研" class="headerlink" title="支付宝接口调研"></a><strong>支付宝接口调研</strong></h6><p>支付宝支付产品如下：</p>
<p>文档：<a target="_blank" rel="noopener" href="https://b.alipay.com/signing/productSetV2.htm">https://b.alipay.com/signing/productSetV2.htm</a></p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222846119.png" srcset="/img/loading.gif" lazyload alt="image-20231227222846119"></p>
<p>与本项目需求相关的接口：电脑网站支付、手机网站支付。</p>
<p>1、电脑网站支付</p>
<p>PC网站轻松收款，资金马上到账：用户在商家PC网站消费，自动跳转支付宝PC网站收银台完成付款。 交易资金直接打入商家支付宝账户，实时到账。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222856243.png" srcset="/img/loading.gif" lazyload alt="image-20231227222856243"></p>
<p>2、手机网站支付</p>
<p>用户在商家手机网站消费，通过浏览器自动跳转支付宝APP或支付宝网页完成付款。 轻松实现和APP支付相同的支付体验。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222910116.png" srcset="/img/loading.gif" lazyload alt="image-20231227222910116"></p>
<p>对比两种支付方式：手机网站支付方式可以在H5网页唤起支付宝，手机扫码支付可以使用手机网站支付方式来完成，相比电脑网站支付形式更灵活。</p>
<p>本项目选择手机网站支付方式。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p>
<p>如何开通支付宝手机网站支付接口？</p>
<p>进入网址：<a target="_blank" rel="noopener" href="https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001">https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001</a></p>
<p>点击：立即开通</p>
<p>上传营业执照等资料，提交审核，根据提示进行开通。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227222955798.png" srcset="/img/loading.gif" lazyload alt="image-20231227222955798"></p>
<h4 id="准备开发环境"><a href="#准备开发环境" class="headerlink" title="准备开发环境"></a><strong>准备开发环境</strong></h4><h5 id="支付宝开发环境"><a href="#支付宝开发环境" class="headerlink" title="支付宝开发环境"></a><strong>支付宝开发环境</strong></h5><p>第三方支付接口流程大同小异，考虑开发及教学的方便性，支付宝提供支付宝沙箱环境开发支付接口，在教学中接入支付宝手机网站支付接口。</p>
<p>1、配置沙箱环境</p>
<p>沙箱环境是支付宝开放平台为开发者提供的与生产环境完全隔离的联调测试环境，开发者在沙箱环境中完成的接口调用不会对生产环境中的数据造成任何影响。</p>
<p>接入手机网站支付需要具备如下条件：</p>
<p>•     申请前必须拥有经过实名认证的支付宝账户；</p>
<p>•     企业或个体工商户可申请；</p>
<p>•     需提供真实有效的营业执照，且支付宝账户名称需与营业执照主体一致；</p>
<p>•     网站能正常访问且页面显示完整，网站需要明确经营内容且有完整的商品信息；</p>
<p>•     网站必须通过ICP备案。如为个体工商户，网站备案主体需要与支付宝账户主体名称一致；</p>
<p>•     如为个体工商户，则团购不开放，且古玩、珠宝等奢侈品、投资类行业无法申请本产品。</p>
<p>详细参见：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203">https://docs.open.alipay.com/203</a></p>
<p>本文档使用支付宝沙箱进行开发测试，这里主要介绍支付宝沙箱环境配置。</p>
<p>详细参见：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/200/105311/">https://docs.open.alipay.com/200/105311/</a></p>
<p>2、模拟器</p>
<p>下载模拟器：<a target="_blank" rel="noopener" href="http://mumu.163.com/">http://mumu.163.com/</a></p>
<p>安装模拟器，安装在没有空格和中文的目录。</p>
<p>安装成功，启动模拟器</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227223708482.png" srcset="/img/loading.gif" lazyload alt="image-20231227223708482" style="zoom:67%;" />

<p>下一步在模拟器安装支付宝：</p>
<p>选择课程资料中支付宝安装包wallet_101521226_client_release_201812261416.apk（沙箱版本）</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227223728162.png" srcset="/img/loading.gif" lazyload alt="image-20231227223728162"></p>
<p>安装成功后支付宝客户端的快捷方式出现在桌面上。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227223737861.png" srcset="/img/loading.gif" lazyload alt="image-20231227223737861"></p>
<p>使用沙箱环境的买家账号登录沙箱版本的支付宝。</p>
<p>查看沙箱环境的账号</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227223753507.png" srcset="/img/loading.gif" lazyload alt="image-20231227223753507"></p>
<h5 id="创建订单服务"><a href="#创建订单服务" class="headerlink" title="创建订单服务"></a><strong>创建订单服务</strong></h5><p>拷贝课程资料目录下的订单服务工程xuecheng-plus-orders到自己的工程目录。1</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227223819177.png" srcset="/img/loading.gif" lazyload alt="image-20231227223819177" style="zoom:50%;" />

<p>创建xc_orders数据库，并导入xcplus_orders.sql </p>
<p>修改nacos中orders-service-dev.yaml的数据库连接参数</p>
<h4 id="支付接口测试"><a href="#支付接口测试" class="headerlink" title="支付接口测试"></a><strong>支付接口测试</strong></h4><h5 id="阅读接口定义"><a href="#阅读接口定义" class="headerlink" title="阅读接口定义"></a><strong>阅读接口定义</strong></h5><p>手机网站支付接入流程详细参见：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/105285/">https://docs.open.alipay.com/203/105285/</a></p>
<p>1、接口交互流程如下：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231227224325344.png" srcset="/img/loading.gif" lazyload alt="image-20231227224325344"></p>
<ol>
<li>用户在商户的H5网站下单支付后，商户系统按照<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/107090">手机网站支付接口alipay.trade.wap.pay</a>API的参数规范生成订单数据</li>
<li>前端页面通过Form表单形式请求到支付宝，此时支付宝自动将页面跳转至支付宝H5收银台页面，如果用户手机安装了支付宝APP，则自动唤起支付宝APP</li>
<li>输入支付密码完成支付</li>
<li>用户在支付宝APP或H5收银台完成支付后，会根据商户在手机网站支付API中传入的前台回跳地址return_url自动跳转回商户页面，同时在URL请求中以Query String的形式附带上支付结果参数，详细回跳参数见“手机网站支付接口alipay.trade.wap.pay”<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/107090#s2">前台回跳参数</a>。</li>
<li>支付宝会根据原始支付API中传入的异步通知地址notify_url, 通过POST请求形式将支付结果作为参数通知到商户系统，详情见<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/105286">支付结果异步通知</a>。</li>
</ol>
<p>2、接口定义</p>
<p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p>
<p>接口定义：外部商户请求支付宝创建订单并支付</p>
<p>公共参数</p>
<p><strong>请求地址</strong>：</p>
<p>开发中使用沙箱地址：<a target="_blank" rel="noopener" href="https://openapi.alipaydev.com/gateway.do">https://openapi.alipaydev.com/gateway.do</a></p>
<p>请求参数：</p>
<p>详细查阅<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p>
<p>一部分由sdk设置，一部分需要编写程序时指定。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228105119750.png" srcset="/img/loading.gif" lazyload alt="image-20231228105119750"></p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228105127061.png" srcset="/img/loading.gif" lazyload alt="image-20231228105127061"></p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228105132882.png" srcset="/img/loading.gif" lazyload alt="image-20231228105132882"></p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228105136481.png" srcset="/img/loading.gif" lazyload alt="image-20231228105136481"></p>
<p>其它扩展参数参见接口文档。</p>
<p>3、示例代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-type">Java</span><br><span class="hljs-keyword">public</span> void doPost(<span class="hljs-type">HttpServletRequest</span> httpRequest,<br>                   <span class="hljs-type">HttpServletResponse</span> httpResponse) <span class="hljs-keyword">throws</span> <span class="hljs-type">ServletException</span>, <span class="hljs-type">IOException</span> &#123;<br>    <span class="hljs-type">AlipayClient</span> alipayClient <span class="hljs-operator">=</span> <span class="hljs-operator">...</span> <span class="hljs-comment">//获得初始化的AlipayClient</span><br>    <span class="hljs-type">AlipayTradeWapPayRequest</span> alipayRequest <span class="hljs-operator">=</span> new <span class="hljs-type">AlipayTradeWapPayRequest</span>();<span class="hljs-comment">//创建API对应的request</span><br>    alipayRequest.setReturnUrl(<span class="hljs-string">&quot;http://domain.com/CallBack/return_url.jsp&quot;</span>);<br>    alipayRequest.setNotifyUrl(<span class="hljs-string">&quot;http://domain.com/CallBack/notify_url.jsp&quot;</span>);<span class="hljs-comment">//在公共参数中设置回跳和通知地址</span><br>    alipayRequest.setBizContent(<span class="hljs-string">&quot;&#123;&quot;</span> <span class="hljs-operator">+</span><br>            <span class="hljs-string">&quot;    <span class="hljs-subst">\&quot;</span>out_trade_no<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>20150320010101002<span class="hljs-subst">\&quot;</span>,&quot;</span> <span class="hljs-operator">+</span><br>            <span class="hljs-string">&quot;    <span class="hljs-subst">\&quot;</span>total_amount<span class="hljs-subst">\&quot;</span>:88.88,&quot;</span> <span class="hljs-operator">+</span><br>            <span class="hljs-string">&quot;    <span class="hljs-subst">\&quot;</span>subject<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>Iphone6 16G<span class="hljs-subst">\&quot;</span>,&quot;</span> <span class="hljs-operator">+</span><br>            <span class="hljs-string">&quot;    <span class="hljs-subst">\&quot;</span>product_code<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>QUICK_WAP_WAY<span class="hljs-subst">\&quot;</span>&quot;</span> <span class="hljs-operator">+</span><br>            <span class="hljs-string">&quot;  &#125;&quot;</span>);<span class="hljs-comment">//填充业务参数</span><br>    <span class="hljs-type">String</span> form <span class="hljs-operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="hljs-comment">//调用SDK生成表单</span><br>    httpResponse.setContentType(<span class="hljs-string">&quot;text/html;charset=&quot;</span> <span class="hljs-operator">+</span> <span class="hljs-type">AlipayServiceEnvConstants</span>.<span class="hljs-type">CHARSET</span>);<br>    httpResponse.getWriter().write(form);<span class="hljs-comment">//直接将完整的表单html输出到页面</span><br>    httpResponse.getWriter().flush();<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="下单执行流程"><a href="#下单执行流程" class="headerlink" title="下单执行流程"></a><strong>下单执行流程</strong></h5><p>根据接口描述，支付宝下单接口的执行流程如下：</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228122017158.png" srcset="/img/loading.gif" lazyload alt="image-20231228122017158" style="zoom:50%;" />

<h5 id="支付接口测试-1"><a href="#支付接口测试-1" class="headerlink" title="支付接口测试"></a><strong>支付接口测试</strong></h5><h6 id="编写下单代码"><a href="#编写下单代码" class="headerlink" title="编写下单代码"></a><strong>编写下单代码</strong></h6><p>根据接口流程，首先在订单服务编写测试类请求支付宝下单的接口。</p>
<p>在订单服务api工程添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml">XML<br><span class="hljs-comment">&lt;!-- 支付宝SDK --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alipay.sdk<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>alipay-sdk-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.7.73.ALL<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 支付宝SDK依赖的日志 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>下载示例代码<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105910">https://opendocs.alipay.com/open/203/105910</a></p>
<p>拷贝示例代码，修改、测试。</p>
<p>拷贝AlipayConfig.java到订单服务的service工程</p>
<p>编写测试	PayTestController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.orders.api;<br><br><span class="hljs-keyword">import</span> com.alipay.api.AlipayApiException;<br><span class="hljs-keyword">import</span> com.alipay.api.AlipayClient;<br><span class="hljs-keyword">import</span> com.alipay.api.DefaultAlipayClient;<br><span class="hljs-keyword">import</span> com.alipay.api.request.AlipayTradeWapPayRequest;<br><span class="hljs-keyword">import</span> com.xuecheng.orders.config.AlipayConfig;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 测试支付宝接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/20 22:19</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayTestController</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;pay.alipay.APP_ID&#125;&quot;)</span><br>    String APP_ID;<br>    <span class="hljs-meta">@Value(&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;)</span><br>    String APP_PRIVATE_KEY;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;)</span><br>    String ALIPAY_PUBLIC_KEY;<br><br><br><br>    <span class="hljs-meta">@RequestMapping(&quot;/alipaytest&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest httpRequest,</span><br><span class="hljs-params">                       HttpServletResponse httpResponse)</span> <span class="hljs-keyword">throws</span> ServletException, IOException, AlipayApiException &#123;<br>        <span class="hljs-type">AlipayClient</span> <span class="hljs-variable">alipayClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY,AlipayConfig.SIGNTYPE);<br>        <span class="hljs-comment">//获得初始化的AlipayClient</span><br>        <span class="hljs-type">AlipayTradeWapPayRequest</span> <span class="hljs-variable">alipayRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayTradeWapPayRequest</span>();<span class="hljs-comment">//创建API对应的request</span><br><span class="hljs-comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span><br><span class="hljs-comment">//        alipayRequest.setNotifyUrl(&quot;http://domain.com/CallBack/notify_url.jsp&quot;);//在公共参数中设置回跳和通知地址</span><br>        alipayRequest.setBizContent(<span class="hljs-string">&quot;&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;out_trade_no\&quot;:\&quot;202210100010101002\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;total_amount\&quot;:0.1,&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;subject\&quot;:\&quot;Iphone6 16G\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;product_code\&quot;:\&quot;QUICK_WAP_WAY\&quot;&quot;</span> +<br>                <span class="hljs-string">&quot;  &#125;&quot;</span>);<span class="hljs-comment">//填充业务参数</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">form</span> <span class="hljs-operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="hljs-comment">//调用SDK生成表单</span><br>        httpResponse.setContentType(<span class="hljs-string">&quot;text/html;charset=&quot;</span> + AlipayConfig.CHARSET);<br>        httpResponse.getWriter().write(form);<span class="hljs-comment">//直接将完整的表单html输出到页面</span><br>        httpResponse.getWriter().flush();<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="生成二维码"><a href="#生成二维码" class="headerlink" title="生成二维码"></a><strong>生成二维码</strong></h6><p>用户在前端使用支付宝沙箱通过扫码请求下单接口，我们需要生成订单服务的下单接口的二维码。</p>
<p>ZXing是一个开源的类库，是用Java编写的多格式的1D &#x2F; 2D条码图像处理库，使用ZXing可以生成、识别QR Code（二维码）。常用的二维码处理库还有zbar，近几年已经不再更新代码，下边介绍ZXing生成二维码的方法。</p>
<p>1）引入依赖</p>
<p>在base工程pom.xml中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml">XML<br>        <span class="hljs-comment">&lt;!-- 二维码生成&amp;识别组件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.zxing<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.zxing<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javase<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>2）生成二维码方法</p>
<p>拷贝课程资料中utils下的QRCodeUtil.java到base工程util包下。</p>
<p>测试根据内容生成二维码方法，在QRCodeUtil中添加main方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">QRCodeUtil</span> <span class="hljs-variable">qrCodeUtil</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QRCodeUtil</span>();<br>        System.out.println(qrCodeUtil.createQRCode(<span class="hljs-string">&quot;http://www.itcast.cn/&quot;</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>));<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p>运行main方法输入二维码图片的base64串，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">Bash<br>data:image/png;<span class="hljs-built_in">base64</span>,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABQElEQVR42u2YPZKDMAyF5aFIuUfIUThafDSOwhEoUzC8fZKMySSbrVI8ZuICBX8uIvtZPxjeDfuSf8liPi7LFSgrzRTvV3XCKawXYLptFobviz6ZzB2xEfTjhyS9OwXB3A7jbMSngLOQ0I4v2AZf96wqTWJ9+9/dYEHSx2RYqfg/oqUgiX3nFBVfcCepcSbiJP67iwZ1G+5+Am7kyTzW9OcW/kRAX+QJ953+uCl8zO5PV5UsaffUp8rqP5+jiySJU8jtNxcNrysetCNK6A/V4lEQeU+xa0eZREE1tOTpFYod0VKXsKCqvRqMkW5pkza8Ggy3WgEuTvZcz0dcUBc+9MneL1DqkXjQz0eaZA1LqVtmzcMffTKPiPwz1mh2zkGyNwtT9kguTVI7LWv6ul7DCpOjX9iaGV66HDny/ZL1WfILfc/hMHLUpekAAAAASUVORK5CYII=<br><br><br></code></pre></td></tr></table></figure>

<p>将base64串复制到浏览器地址后回车将展示一个二维码，用户用手机扫此二维码将请求至<a target="_blank" rel="noopener" href="http://www.itcast.cn/%E3%80%82">http://www.itcast.cn/。</a><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228122951520.png" srcset="/img/loading.gif" lazyload alt="image-20231228122951520" style="zoom:25%;" /></p>
<h6 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h6><p>1、生成订单服务下单接口的二维码</p>
<p>修改二维码生成的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>      <span class="hljs-type">QRCodeUtil</span> <span class="hljs-variable">qrCodeUtil</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QRCodeUtil</span>();<br>      System.out.println(qrCodeUtil.createQRCode(<span class="hljs-string">&quot;http://localhost:63030/orders/alipaytest&quot;</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意：<a href="http://localhost:63030地址用模拟器无法访问，进入cmd命令状态，输入命令ipconfig">http://localhost:63030地址用模拟器无法访问，进入cmd命令状态，输入命令ipconfig</a> -all 查看本地网卡分配的局域网ip地址，将上边的地址修改如下</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade">Plain <span class="hljs-built_in">Text</span><br>http:<span class="hljs-comment">//192.168.101.1:63030/orders/alipaytest</span><br><br></code></pre></td></tr></table></figure>

<p>运行main方法，复制输出到控制台的base64串。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">Bash<br>data:image/png;<span class="hljs-built_in">base64</span>,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABxUlEQVR42u2YO46EMBBEGxE45AjcBC6GhCUuNtzER3DoANFbZT4zu9KmNavVOLAwj6BV/TXmvy37kL9Oopl1sS+DWV/M2oRzKyWL+95tfXDfenyzJK/vlCTZ0G1WGpzDDlKA9ST2YbfJrMnz2wiE8WQw8A2E/lkc6kQ66afnBKTGKCwaru179ApIXVBnzNb7gy+/ZbCAQJgB5zLCyrD6ZnSSlPAxm1VNyphh28NmKUFI7F3EQ55qrXJfL3VUBOGZJyssF74C45tWSjbEBW2DJslG94QPtQTNYsyzH9WSrgmXOiqCCBlgFmIUhMLwKCVcSFHkxsaagcY1vmSwgkRDZE5WO4YzT6tYSuIprNTEzskBedq5lNS4wEs2TOiEbT1tUxGslaW6OoX98+5ZKhLpmhYFi8LsTNY7T1WE7apNzE5UCgiDD2cpca+T612v0zNGZYQWMVDhJG7h2dE1BOoMSIujUjQcZUYxOWcXBodzeuKmJdddhtNTqZNcc1cxDTnuMmwbxr7dup5wjl8S44J9O75Mdkpyzo1hr/eqV9tUBE+8waBy80p1T3YictxpDyexcQUXk+Muw9m5RohZnWKU5PMX55+RLyKnzJvqtaeFAAAAAElFTkSuQmCC<br><br><br></code></pre></td></tr></table></figure>

<p>打开模拟器，在模拟器中打开浏览器，将base64串复制到浏览器的地址栏。</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123118940.png" srcset="/img/loading.gif" lazyload alt="image-20231228123118940" style="zoom:50%;" />

<p>使用截屏工具进行截屏，稍后使用支付宝沙箱客户端扫此图片。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123217999.png" srcset="/img/loading.gif" lazyload alt="image-20231228123217999"></p>
<p>2、启动订单服务</p>
<p>3、打开模拟器，在模拟器中打开支付宝沙箱客户端，并使用沙箱客户端账号密码登录。</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123246199.png" srcset="/img/loading.gif" lazyload alt="image-20231228123246199" style="zoom:67%;" />

<p>点击扫一扫选择相册中刚才截屏的二维码</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123300596.png" srcset="/img/loading.gif" lazyload alt="image-20231228123300596" style="zoom:50%;" />

<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123308530.png" srcset="/img/loading.gif" lazyload alt="image-20231228123308530" style="zoom:67%;" />

<p>扫码后如果提示系统繁忙再重试<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123318978.png" srcset="/img/loading.gif" lazyload alt="image-20231228123318978" style="zoom:67%;" /></p>
<p>如果提示请求勿重复提交则需要修改下单测试代码中指定的out_trade_no商品订单号，订单号在每个商户是唯一的，每次支付前修改out_trade_no 为一个没有使用过的订单号。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123332015.png" srcset="/img/loading.gif" lazyload alt="image-20231228123332015"></p>
<p>修改订单号后重启订单服务，再使用沙箱支付宝客户端扫码<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123342421.png" srcset="/img/loading.gif" lazyload alt="image-20231228123342421" style="zoom:50%;" /></p>
<p>输入支付密码进行支付。</p>
<p>支付密码为沙箱账号的支付密码，此支付所扣款为沙箱账号的虚拟货币余额。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123354472.png" srcset="/img/loading.gif" lazyload alt="image-20231228123354472"></p>
<p>支付成功界面：<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228123405580.png" srcset="/img/loading.gif" lazyload alt="image-20231228123405580"></p>
<h5 id="支付结果查询接口"><a href="#支付结果查询接口" class="headerlink" title="支付结果查询接口"></a><strong>支付结果查询接口</strong></h5><p>支付完成可以调用第三方支付平台的支付结果查询接口 查询支付结果。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p>
<p>示例代码：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Java<br>AlipayClient alipayClient = <span class="hljs-built_in">new</span> DefaultAlipayClient(&quot;https://openapi.alipay.com/gateway.do&quot;,&quot;app_id&quot;,&quot;your private_key&quot;,&quot;json&quot;,&quot;GBK&quot;,&quot;alipay_public_key&quot;,&quot;RSA2&quot;);<br>AlipayTradeQueryRequest request = <span class="hljs-built_in">new</span> AlipayTradeQueryRequest();<br>JSONObject bizContent = <span class="hljs-built_in">new</span> JSONObject();<br>bizContent.put(&quot;out_trade_no&quot;, &quot;20150320010101001&quot;);<br>//bizContent.put(&quot;trade_no&quot;, &quot;2014112611001004680073956707&quot;);<br>request.setBizContent(bizContent.toString());<br>AlipayTradeQueryResponse response = alipayClient.<span class="hljs-keyword">execute</span>(request);<br><span class="hljs-keyword">if</span>(response.isSuccess())&#123;<br>    <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;调用成功&quot;);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;调用失败&quot;);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>刚才订单付款成功，可以使用out_trade_no商品订单号或支付宝的交易流水号trade_no去查询支付结果。</p>
<p>out_trade_no商品订单号: 是在下单请求时指定的商品订单号。</p>
<p>支付宝的交易流水号trade_no：是支付完成后支付宝通知支付结果时发送的trade_no</p>
<p>我们使用out_trade_no商品订单号去查询，代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br>package com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">orders</span>.<span class="hljs-property">api</span>;<br><br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">fastjson</span>.<span class="hljs-property">JSONObject</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">AlipayApiException</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">AlipayClient</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">DefaultAlipayClient</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">request</span>.<span class="hljs-property">AlipayTradeQueryRequest</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">response</span>.<span class="hljs-property">AlipayTradeQueryResponse</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">junit</span>.<span class="hljs-property">jupiter</span>.<span class="hljs-property">api</span>.<span class="hljs-property">Test</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Value</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">test</span>.<span class="hljs-property">context</span>.<span class="hljs-property">SpringBootTest</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 支付宝查询接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/4 17:18</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AliPayTest</span> &#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.APP_ID&#125;&quot;</span>)<br>    <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">APP_ID</span>;<br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;</span>)<br>    <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">APP_PRIVATE_KEY</span>;<br>    <br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;</span>)<br>    <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">ALIPAY_PUBLIC_KEY</span>;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">queryPayResult</span>() throws <span class="hljs-title class_">AlipayApiException</span> &#123;<br>    <span class="hljs-title class_">AlipayClient</span> alipayClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAlipayClient</span>(<span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">URL</span>, <span class="hljs-variable constant_">APP_ID</span>, <span class="hljs-variable constant_">APP_PRIVATE_KEY</span>, <span class="hljs-string">&quot;json&quot;</span>, <span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">CHARSET</span>, <span class="hljs-variable constant_">ALIPAY_PUBLIC_KEY</span>, <span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">SIGNTYPE</span>); <span class="hljs-comment">//获得初始化的AlipayClient</span><br>    <span class="hljs-title class_">AlipayTradeQueryRequest</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayTradeQueryRequest</span>();<br>    <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> bizContent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>();<br>    bizContent.<span class="hljs-title function_">put</span>(<span class="hljs-string">&quot;out_trade_no&quot;</span>, <span class="hljs-string">&quot;202210100010101002&quot;</span>);<br>    <span class="hljs-comment">//bizContent.put(&quot;trade_no&quot;, &quot;2014112611001004680073956707&quot;);</span><br>    request.<span class="hljs-title function_">setBizContent</span>(bizContent.<span class="hljs-title function_">toString</span>());<br>    <span class="hljs-title class_">AlipayTradeQueryResponse</span> response = alipayClient.<span class="hljs-title function_">execute</span>(request);<br>    <span class="hljs-keyword">if</span> (response.<span class="hljs-title function_">isSuccess</span>()) &#123;<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;调用成功&quot;</span>);<br>        <span class="hljs-title class_">String</span> resultJson = response.<span class="hljs-title function_">getBody</span>();<br>        <span class="hljs-comment">//转map</span><br>        <span class="hljs-title class_">Map</span> resultMap = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parseObject</span>(resultJson, <span class="hljs-title class_">Map</span>.<span class="hljs-property">class</span>);<br>        <span class="hljs-title class_">Map</span> alipay_trade_query_response = (<span class="hljs-title class_">Map</span>) resultMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;alipay_trade_query_response&quot;</span>);<br>        <span class="hljs-comment">//支付结果</span><br>        <span class="hljs-title class_">String</span> trade_status = (<span class="hljs-title class_">String</span>) alipay_trade_query_response.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;trade_status&quot;</span>);<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(trade_status);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;调用失败&quot;</span>);<br>    &#125;<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>运行代码，输出如下：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Plain</span> <span class="hljs-built_in">Text</span><br>调用成功<br><span class="hljs-type">TRADE_SUCCESS</span><br><br></code></pre></td></tr></table></figure>

<p>输出结果即是调用支付宝查询接口查询到的支付结果+</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228124613838.png" srcset="/img/loading.gif" lazyload alt="image-20231228124613838"></p>
<p>参考文档<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a> 查阅每个参数的意义。</p>
<p>我们主要需要下边的参数：</p>
<p>“out_trade_no” : “20220520010101026”,</p>
<p>“trade_no”:”2022100422001422760505740639” ： 支付宝交易流水号</p>
<p>“total_amount” : “1.30”</p>
<p>“trade_status” : “TRADE_SUCCESS”： 交易状态</p>
<p>交易状态类型：</p>
<p>交易状态：WAIT_BUYER_PAY（交易创建，等待买家付款）</p>
<p>TRADE_CLOSED（未付款交易超时关闭，或支付完成后全额退款）</p>
<p>TRADE_SUCCESS（交易支付成功）</p>
<p>TRADE_FINISHED（交易结束，不可退款）</p>
<h5 id="支付结果通知接口"><a href="#支付结果通知接口" class="headerlink" title="支付结果通知接口"></a><strong>支付结果通知接口</strong></h5><h6 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a><strong>准备环境</strong></h6><p>对于手机网站支付产生的交易，支付宝会通知商户支付结果，有两种通知方式，通过return_url、notify_url进行通知，使用return_url不能保证通知到位，推荐使用notify_url完成支付结构通知。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228130333847.png" srcset="/img/loading.gif" lazyload alt="image-20231228130333847"></p>
<p>具体的使用方法是在调用下单接口的 API 中传入的异步通知地址 notify_url，通过 POST 请求的形式将支付结果作为参数通知到商户系统。详情可查看 <a target="_blank" rel="noopener" href="https://opendocs.alipay.com/support/01raw4">支付宝异步通知说明</a> 。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105286">https://opendocs.alipay.com/open/203/105286</a></p>
<p>根据下单执行流程，订单服务收到支付结果需要对内容进行验签，验签过程如下：</p>
<p>\1.    在通知返回参数列表中，除去sign、sign_type两个参数外，凡是通知返回回来的参数皆是待验签的参数。将剩下参数进行 url_decode，然后进行字典排序，组成字符串，得到待签名字符串； 生活号异步通知组成的待验签串里需要保留 sign_type 参数。</p>
<p>\2.    将签名参数（sign）使用 base64 解码为字节码串；</p>
<p>\3.    使用 RSA 的验签方法，通过签名字符串、签名参数（经过 base64 解码）及支付宝公钥验证签名。</p>
<p>\4.    验证签名正确后，必须再严格按照如下描述校验通知数据的正确性。</p>
<p>在上述验证通过后，商户必须根据支付宝不同类型的业务通知，正确的进行不同的业务处理，并且过滤重复的通知结果数据。</p>
<p>通过验证out_trade_no、total_amount、appid参数的正确性判断通知请求的合法性。</p>
<p>验证的过程可以参考sdk demo代码，下载 sdk demo代码，<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105910">https://opendocs.alipay.com/open/203/105910</a></p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228130352721.png" srcset="/img/loading.gif" lazyload alt="image-20231228130352721"></p>
<p>参考demo中的alipay.trade.wap.pay-java-utf-8\WebContent\ notify_url.jsp</p>
<p>另外，支付宝通知订单服务的地址必须为外网域名且备案通过可以正常访问。</p>
<p>此接口仍然使用内网穿透技术。</p>
<h6 id="编写测试代码"><a href="#编写测试代码" class="headerlink" title="编写测试代码"></a><strong>编写测试代码</strong></h6><p>1、在下单请求时设置通知地址request.setNotifyUrl(“商户自己的notify_url地址”);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@GetMapping(&quot;/alipaytest&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">alipaytest</span><span class="hljs-params">(HttpServletRequest httpRequest,</span><br><span class="hljs-params">                           HttpServletResponse httpResponse)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-comment">//构造sdk的客户端对象</span><br>        <span class="hljs-type">AlipayClient</span> <span class="hljs-variable">alipayClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAlipayClient</span>(serverUrl, APP_ID, APP_PRIVATE_KEY, <span class="hljs-string">&quot;json&quot;</span>, CHARSET, ALIPAY_PUBLIC_KEY, sign_type); <span class="hljs-comment">//获得初始化的AlipayClient</span><br>        <span class="hljs-type">AlipayTradeWapPayRequest</span> <span class="hljs-variable">alipayRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayTradeWapPayRequest</span>();<span class="hljs-comment">//创建API对应的request</span><br><span class="hljs-comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span><br>        alipayRequest.setNotifyUrl(<span class="hljs-string">&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify&quot;</span>);<span class="hljs-comment">//在公共参数中设置回跳和通知地址</span><br>        .....<br>        <br><br></code></pre></td></tr></table></figure>

<p>2、编写接收通知接口，接收参数并验签</p>
<p>参考课程资料下的alipay.trade.wap.pay-java-utf-8\WebContent\notify_url.jsp</p>
<p>代码如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs awk">Java<br><span class="hljs-regexp">//</span>接收通知<br>@PostMapping(<span class="hljs-string">&quot;/paynotify&quot;</span>)<br>public void paynotify(HttpServletRequest request,HttpServletResponse response) throws UnsupportedEncodingException, AlipayApiException &#123;<br>    Map&lt;String,String&gt; params = new HashMap&lt;String,String&gt;();<br>    Map requestParams = request.getParameterMap();<br>    <span class="hljs-keyword">for</span> (Iterator iter = requestParams.keySet().iterator(); iter.hasNext();) &#123;<br>        String name = (String) iter.<span class="hljs-keyword">next</span>();<br>        String[] values = (String[]) requestParams.get(name);<br>        String valueStr = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; values.length; i++) &#123;<br>            valueStr = (i == values.length - <span class="hljs-number">1</span>) ? valueStr + values[i]<br>                    : valueStr + values[i] + <span class="hljs-string">&quot;,&quot;</span>;<br>        &#125;<br>        <span class="hljs-regexp">//</span>乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化<br>        <span class="hljs-regexp">//</span>valueStr = new String(valueStr.getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>), <span class="hljs-string">&quot;gbk&quot;</span>);<br>        params.put(name, valueStr);<br>    &#125;<br><br>   <br>    <span class="hljs-regexp">//</span>获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以上仅供参考)<span class="hljs-regexp">//</span><br>    <span class="hljs-regexp">//</span>计算得出通知验证结果<br>    <span class="hljs-regexp">//</span>boolean AlipaySignature.rsaCheckV1(Map&lt;String, String&gt; params, String publicKey, String charset, String sign_type)<br>    boolean verify_result = AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="hljs-string">&quot;RSA2&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(verify_result) &#123;<span class="hljs-regexp">//</span>验证成功<br>        <span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><span class="hljs-regexp">//</span><br>        <span class="hljs-regexp">//</span>请在这里加上商户的业务逻辑程序代码<br>        <br>         <span class="hljs-regexp">//</span>商户订单号<br>        String out_trade_no = new String(request.getParameter(<span class="hljs-string">&quot;out_trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-regexp">//</span>支付宝交易号<br>    <br>        String trade_no = new String(request.getParameter(<span class="hljs-string">&quot;trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>    <br>        <span class="hljs-regexp">//</span>交易状态<br>        String trade_status = new String(request.getParameter(<span class="hljs-string">&quot;trade_status&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br><br><br>        <span class="hljs-regexp">//</span>——请根据您的业务逻辑来编写程序（以下代码仅作参考）——<br><br>        <span class="hljs-keyword">if</span> (trade_status.equals(<span class="hljs-string">&quot;TRADE_FINISHED&quot;</span>)) &#123;<span class="hljs-regexp">//</span>交易结束<br>            <span class="hljs-regexp">//</span>判断该笔订单是否在商户网站中已经做过处理<br>            <span class="hljs-regexp">//</span>如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序<br>            <span class="hljs-regexp">//</span>请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的<br>            <span class="hljs-regexp">//</span>如果有做过处理，不执行商户的业务程序<br><br>            <span class="hljs-regexp">//</span>注意：<br>            <span class="hljs-regexp">//</span>如果签约的是可退款协议，退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知<br>            <span class="hljs-regexp">//</span>如果没有签约可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (trade_status.equals(<span class="hljs-string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;<span class="hljs-regexp">//</span>交易成功<br>            System.out.println(trade_status);<br>            <span class="hljs-regexp">//</span>判断该笔订单是否在商户网站中已经做过处理<br>            <span class="hljs-regexp">//</span>如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序<br>            <span class="hljs-regexp">//</span>请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的<br>            <span class="hljs-regexp">//</span>如果有做过处理，不执行商户的业务程序<br><br>            <span class="hljs-regexp">//</span>注意：<br>            <span class="hljs-regexp">//</span>如果签约的是可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。<br>        &#125;<br>        response.getWriter().write(<span class="hljs-string">&quot;success&quot;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        response.getWriter().write(<span class="hljs-string">&quot;fail&quot;</span>);<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="通知接口测试"><a href="#通知接口测试" class="headerlink" title="通知接口测试"></a><strong>通知接口测试</strong></h6><p>1、重启订单服务，并在接收通知接口中打上断点</p>
<p>2、配置内网穿透的本地端口为订单服务端口，启动内网穿透客户端。</p>
<p>3、打开模拟器、支付宝沙箱，扫码、支付。</p>
<p>4、观察接收订单支付数据等是否正常。</p>
<h4 id="生成支付二维码"><a href="#生成支付二维码" class="headerlink" title="生成支付二维码"></a><strong>生成支付二维码</strong></h4><h5 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h5><h6 id="执行流程-2"><a href="#执行流程-2" class="headerlink" title="执行流程"></a><strong>执行流程</strong></h6><p>再次打开课程支付引导界面，点击“支付宝支付”按钮系统该如何处理？</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228130615281.png" srcset="/img/loading.gif" lazyload alt="image-20231228130615281"></p>
<p>点击“支付宝支付”此时打开支付二维码，用户扫码支付。</p>
<p>所以首先需要生成支付二维码，用户扫描二维码开始请求支付宝下单，在向支付宝下单前需要添加选课记录、创建商品订单、生成支付交易记录。</p>
<p>生成二维码执行流程如下：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228130627772.png" srcset="/img/loading.gif" lazyload alt="image-20231228130627772"></p>
<p>执行流程：</p>
<ol>
<li>前端调用学习中心服务的添加选课接口</li>
<li>添加选课成功请求订单服务生成支付二维码接口</li>
<li>生成二维码接口：创建商品订单，生成支付交易记录，生成二维码</li>
<li>将二维码返回给前端，用户扫码</li>
</ol>
<p>用户扫码支付流程如下：</p>
<img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228130911469.png" srcset="/img/loading.gif" lazyload alt="image-20231228130911469" style="zoom:50%;" />

<p>执行流程：</p>
<p>1、用户输入支付<code>密码</code>，支付成功。</p>
<p>2、接收第三方平台通知的<code>支付结果</code>。</p>
<p>3、根据支付结果更新支付交易记录的<code>支付状态</code>为支付成功。</p>
<h6 id="数据模型-1"><a href="#数据模型-1" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h6><p>订单支付模式的核心由三张表组成：订单表、订单明细表、支付交易记录表。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228131040367.png" srcset="/img/loading.gif" lazyload alt="image-20231228131040367"></p>
<p>订单表：记录订单信息</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228131047937.png" srcset="/img/loading.gif" lazyload alt="image-20231228131047937"></p>
<p>订单明细表记录订单的详细信息</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228131053925.png" srcset="/img/loading.gif" lazyload alt="image-20231228131053925"></p>
<p>支付交易记录表记录每次支付的交易明细</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228131059488.png" srcset="/img/loading.gif" lazyload alt="image-20231228131059488"></p>
<p>订单号注意唯一性，安全性，尽量短等特点，生成方案常用的如下：</p>
<ol>
<li>时间戳+随机数</li>
</ol>
<p>年月日时分秒毫秒+随机数</p>
<ol start="2">
<li>高并发场景</li>
</ol>
<p>年月日时分秒毫秒+随机数+redis自增序列</p>
<ol start="3">
<li>订单号中加上业务标识</li>
</ol>
<p>订单号加上业务标识方便客服，比如：第10位是业务类型，第11位是用户类型等。</p>
<ol start="4">
<li>雪花算法</li>
</ol>
<p>雪花算法是推特内部使用的分布式环境下的唯一ID生成算法，它基于时间戳生成，保证有序递增，加以入计算机硬件等元素，可以满足高并发环境下ID不重复。</p>
<p>本项目订单号生成采用雪花算法。</p>
<h5 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h5><p>在订单服务中定义生成支付二维码接口。</p>
<p>请求：订单信息</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Java<br><span class="hljs-keyword">package</span> com.xuecheng.orders.model.dto;<br><br><span class="hljs-keyword">import</span> com.xuecheng.orders.model.po.XcOrders;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.ToString;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @author Mr.M</span><br><span class="hljs-comment"> * @version 1.0</span><br><span class="hljs-comment"> * @description 创建商品订单</span><br><span class="hljs-comment"> * @date 2022/10/4 10:21</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">AddOrderDto</span>  </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 总价</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">Float</span> totalPrice;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单类型</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> orderType;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> orderName;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单描述</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> orderDescrip;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单明细json，不可为空</span><br><span class="hljs-comment">     * [&#123;&quot;goodsId&quot;:&quot;&quot;,&quot;goodsType&quot;:&quot;&quot;,&quot;goodsName&quot;:&quot;&quot;,&quot;goodsPrice&quot;:&quot;&quot;,&quot;goodsDetail&quot;:&quot;&quot;&#125;,&#123;...&#125;]</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> orderDetail;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 外部系统业务id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> outBusinessId;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>响应：支付交易记录信息及二维码信息</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-type">Java</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ToString</span><br>public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PayRecordDto</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">XcPayRecord</span> </span>&#123;<br><br>    <span class="hljs-comment">//二维码</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> qrcode;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Api(value = &quot;订单支付接口&quot;, tags = &quot;订单支付接口&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;生成支付二维码&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/generatepaycode&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title function_">generatePayCode</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddOrderDto addOrderDto)</span> &#123;<br>        <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>用户扫码请求下单，定义下单接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(&quot;扫码下单接口&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/requestpay&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestpay</span><span class="hljs-params">(String payNo,HttpServletResponse httpResponse)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a>接口实现</h5><h6 id="保存商品订单"><a href="#保存商品订单" class="headerlink" title="保存商品订单"></a>保存商品订单</h6><p>定义保存订单信息接口</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">Java<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderService</span> </span>&#123;<br><br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 创建商品订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> addOrderDto 订单信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> PayRecordDto 支付交易记录(包括二维码)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/4 11:02</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-function">PayRecordDto <span class="hljs-title">createOrder</span><span class="hljs-params">(String userId,AddOrderDto addOrderDto)</span></span>;<br><br></code></pre></td></tr></table></figure>

<p>在保存订单接口中需要完成创建商品订单、创建支付交易记录，接口实现方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    XcOrdersMapper ordersMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    XcOrdersGoodsMapper ordersGoodsMapper;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    XcPayRecordMapper payRecordMapper;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId, AddOrderDto addOrderDto)</span> &#123;<br><br>        <span class="hljs-comment">//添加商品订单</span><br><br>        <span class="hljs-comment">//添加支付交易记录</span><br>        <br>        <span class="hljs-comment">//生成二维码</span><br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>编写创建商品订单方法，商品订单的数据来源于选课记录，在订单表需要存入选课记录的ID，这里需要作好幂等处理。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs lasso">Java<br>@Transactional<br><span class="hljs-keyword">public</span> XcOrders saveXcOrders(<span class="hljs-built_in">String</span> userId,AddOrderDto addOrderDto)&#123;<br>    <span class="hljs-comment">//幂等性处理</span><br>    XcOrders <span class="hljs-keyword">order</span> = getOrderByBusinessId(addOrderDto.getOutBusinessId());<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">order</span>!=<span class="hljs-built_in">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">order</span>;<br>    &#125;<br>    <span class="hljs-keyword">order</span> = <span class="hljs-literal">new</span> XcOrders();<br>    <span class="hljs-comment">//生成订单号</span><br>    long orderId = IdWorkerUtils.getInstance().nextId();<br>    <span class="hljs-keyword">order</span>.setId(orderId);<br>    <span class="hljs-keyword">order</span>.setTotalPrice(addOrderDto.getTotalPrice());<br>    <span class="hljs-keyword">order</span>.setCreateDate(LocalDateTime.now());<br>    <span class="hljs-keyword">order</span>.setStatus(<span class="hljs-string">&quot;600001&quot;</span>);<span class="hljs-comment">//未支付</span><br>    <span class="hljs-keyword">order</span>.setUserId(userId);<br>    <span class="hljs-keyword">order</span>.setOrderType(addOrderDto.getOrderType());<br>    <span class="hljs-keyword">order</span>.setOrderName(addOrderDto.getOrderName());<br>    <span class="hljs-keyword">order</span>.setOrderDetail(addOrderDto.getOrderDetail());<br>    <span class="hljs-keyword">order</span>.setOrderDescrip(addOrderDto.getOrderDescrip());<br>    <span class="hljs-keyword">order</span>.setOutBusinessId(addOrderDto.getOutBusinessId());<span class="hljs-comment">//选课记录id</span><br>    ordersMapper.insert(<span class="hljs-keyword">order</span>);<br>    <span class="hljs-built_in">String</span> orderDetailJson = addOrderDto.getOrderDetail();<br>    <span class="hljs-built_in">List</span>&lt;XcOrdersGoods&gt; xcOrdersGoodsList = JSON.parseArray(orderDetailJson, XcOrdersGoods.class);<br>    xcOrdersGoodsList.forEach(goods-&gt;&#123;<br>        XcOrdersGoods xcOrdersGoods = <span class="hljs-literal">new</span> XcOrdersGoods();<br>        BeanUtils.copyProperties(goods,xcOrdersGoods);<br>        xcOrdersGoods.setOrderId(orderId);<span class="hljs-comment">//订单号</span><br>        ordersGoodsMapper.insert(xcOrdersGoods);<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">order</span>;<br>&#125;<br><br><span class="hljs-comment">//根据业务id查询订单</span><br><span class="hljs-keyword">public</span> XcOrders getOrderByBusinessId(<span class="hljs-built_in">String</span> businessId) &#123;<br>    XcOrders orders = ordersMapper.selectOne(<span class="hljs-literal">new</span> LambdaQueryWrapper&lt;XcOrders&gt;().<span class="hljs-literal">eq</span>(XcOrders<span class="hljs-type">::getOutBusinessId</span>, businessId));<br>    <span class="hljs-keyword">return</span> orders;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="创建支付交易记录"><a href="#创建支付交易记录" class="headerlink" title="创建支付交易记录"></a><strong>创建支付交易记录</strong></h6><p>为什么创建支付交易记录？</p>
<p>在请求微信或支付宝下单接口时需要传入 商品订单号，在与第三方支付平台对接时发现，当用户支付失败或因为其它原因最终该订单没有支付成功，此时再次调用第三方支付平台的下单接口发现报错“订单号已存在”，此时如果我们传入一个没有使用过的订单号就可以解决问题，但是商品订单已经创建，因为没有支付成功重新创建一个新订单是不合理的。</p>
<p>解决以上问题的方案是：</p>
<p>1、用户每次发起都创建一个新的支付交易记录 ，此交易记录与商品订单关联。</p>
<p>2、将支付交易记录的流水号传给第三方支付系统下单接口，这样就即使没有支付成功就不会出现上边的问题。</p>
<p>3、需要提醒用户不要重复支付。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228134423910.png" srcset="/img/loading.gif" lazyload alt="image-20231228134423910"></p>
<p>编写创建支付交易记录的方法：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Java<br>public XcPayRecord createPayRecord(XcOrders orders)&#123;<br>    if(order<span class="hljs-operator">=</span><span class="hljs-operator">=</span>null)&#123;<br>       XueChengPlusException.cast(<span class="hljs-string">&quot;订单不存在&quot;</span>)<span class="hljs-comment">;</span><br>    &#125;<br>    if(orders.getStatus().equals(<span class="hljs-string">&quot;600002&quot;</span>))&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;订单已支付&quot;</span>)<span class="hljs-comment">;</span><br>    &#125;<br>    XcPayRecord payRecord <span class="hljs-operator">=</span> new XcPayRecord()<span class="hljs-comment">;</span><br>    //生成支付交易流水号<br>    long payNo <span class="hljs-operator">=</span> IdWorkerUtils.getInstance().nextId()<span class="hljs-comment">;</span><br>    payRecord.setPayNo(payNo)<span class="hljs-comment">;</span><br>    payRecord.setOrderId(orders.getId())<span class="hljs-comment">;//商品订单号</span><br>    payRecord.setOrderName(orders.getOrderName())<span class="hljs-comment">;</span><br>    payRecord.setTotalPrice(orders.getTotalPrice())<span class="hljs-comment">;</span><br>    payRecord.setCurrency(<span class="hljs-string">&quot;CNY&quot;</span>)<span class="hljs-comment">;</span><br>    payRecord.setCreateDate(LocalDateTime.now())<span class="hljs-comment">;</span><br>    payRecord.setStatus(<span class="hljs-string">&quot;601001&quot;</span>)<span class="hljs-comment">;//未支付</span><br>    payRecord.setUserId(orders.getUserId())<span class="hljs-comment">;</span><br>    payRecordMapper.insert(payRecord)<span class="hljs-comment">;</span><br>    return payRecord<span class="hljs-comment">;</span><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="生成支付二维码-1"><a href="#生成支付二维码-1" class="headerlink" title="生成支付二维码"></a><strong>生成支付二维码</strong></h6><p>1、在nacos中orders-service-dev.yaml配置二维码的url</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts">Java<br><span class="hljs-symbol">pay:</span><br><span class="hljs-symbol"> qrcodeurl:</span> http:<span class="hljs-comment">//192.168.101.1/api/orders/requestpay?payNo=%s</span><br></code></pre></td></tr></table></figure>

<p>2、完善创建订单service方法:</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PayRecordDto createOrder(<span class="hljs-keyword">String</span> userId, AddOrderDto addOrderDto) &#123;<br>    <span class="hljs-comment">//创建商品订单</span><br>    XcOrders orders = saveXcOrders(userId, addOrderDto);<br>    <span class="hljs-keyword">if</span>(orders==<span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.<span class="hljs-keyword">cast</span>(<span class="hljs-string">&quot;订单创建失败&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(orders.getStatus().equals(<span class="hljs-string">&quot;600002&quot;</span>))&#123;<br>        XueChengPlusException.<span class="hljs-keyword">cast</span>(<span class="hljs-string">&quot;订单已支付&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//生成支付记录</span><br>    XcPayRecord payRecord = createPayRecord(orders);<br>    <span class="hljs-comment">//生成二维码</span><br>    <span class="hljs-keyword">String</span> qrCode = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//url要可以被模拟器访问到，url为下单接口(稍后定义)</span><br>        <span class="hljs-keyword">String</span> url = <span class="hljs-keyword">String</span>.format(qrcodeurl, payRecord.getPayNo());<br>        qrCode = <span class="hljs-keyword">new</span> <span class="hljs-type">QRCodeUtil</span>().createQRCode(url, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        XueChengPlusException.<span class="hljs-keyword">cast</span>(<span class="hljs-string">&quot;生成二维码出错&quot;</span>);<br>    &#125;<br>    PayRecordDto payRecordDto = <span class="hljs-keyword">new</span> <span class="hljs-type">PayRecordDto</span>();<br>    BeanUtils.copyProperties(payRecord,payRecordDto);<br>    payRecordDto.setQrcode(qrCode);<br><br>    <span class="hljs-keyword">return</span> payRecordDto;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="生成二维码接口完善"><a href="#生成二维码接口完善" class="headerlink" title="生成二维码接口完善"></a><strong>生成二维码接口完善</strong></h6><p>完善生成支付二维码controller接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Autowired</span><br>OrderService orderService;<br>    <br><span class="hljs-meta">@ApiOperation(&quot;生成支付二维码&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/generatepaycode&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title function_">generatePayCode</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddOrderDto addOrderDto)</span> &#123;<br>    <span class="hljs-comment">//登录用户</span><br>    SecurityUtil.<span class="hljs-type">XcUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> SecurityUtil.getUser();<br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;请登录后继续选课&quot;</span>);<br>    &#125;<br>   <span class="hljs-keyword">return</span> orderService.createOrder(user.getId(), addOrderDto);<br>   <br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="扫码下单接口完善"><a href="#扫码下单接口完善" class="headerlink" title="扫码下单接口完善"></a><strong>扫码下单接口完善</strong></h6><p>生成了支付二维码，用户扫码请求第三方支付平台下单、支付。</p>
<p>1、定义查询支付交易记录的Service接口与实现方法</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 查询支付交易记录</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> payNo  交易记录号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.xuecheng.orders.model.po.XcPayRecord</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/20 23:38</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-function">XcPayRecord <span class="hljs-title">getPayRecordByPayno</span><span class="hljs-params">(String payNo)</span></span>;<br></code></pre></td></tr></table></figure>

<p>实现如下：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs perl">Java<br>@Override<br>public XcPayRecord getPayRecordByPayno(String payNo) &#123;<br>    XcPayRecord xcPayRecord = payRecordMapper.selectOne(new LambdaQueryWrapper&lt;XcPayRecord&gt;().e<span class="hljs-string">q(XcPayRecord::getPayNo, payNo)</span>);<br>    <span class="hljs-keyword">return</span> xcPayRecord;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>2 定义下单接口如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-type">Java</span><br><span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.APP_ID&#125;&quot;</span>)<br><span class="hljs-type">String</span> <span class="hljs-type">APP_ID</span>;<br><span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;</span>)<br><span class="hljs-type">String</span> <span class="hljs-type">APP_PRIVATE_KEY</span>;<br><br><span class="hljs-meta">@Value</span>(<span class="hljs-string">&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;</span>)<br><span class="hljs-type">String</span> <span class="hljs-type">ALIPAY_PUBLIC_KEY</span>;<br><br>    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">&quot;扫码下单接口&quot;</span>)<br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/requestpay&quot;</span>)<br>    <span class="hljs-keyword">public</span> void requestpay(<span class="hljs-type">String</span> payNo,<span class="hljs-type">HttpServletResponse</span> httpResponse) <span class="hljs-keyword">throws</span> <span class="hljs-type">IOException</span> &#123;<br>        <span class="hljs-comment">//如果payNo不存在则提示重新发起支付</span><br>        <span class="hljs-type">XcPayRecord</span> payRecord <span class="hljs-operator">=</span> orderService.getPayRecordByPayno(payNo);<br>        <span class="hljs-keyword">if</span>(payRecord <span class="hljs-operator">==</span> null)&#123;<br>            <span class="hljs-type">XueChengPlusException</span>.cast(<span class="hljs-string">&quot;请重新点击支付获取二维码&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//支付状态</span><br>        <span class="hljs-type">String</span> status <span class="hljs-operator">=</span> payRecord.getStatus();<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;601002&quot;</span>.equals(status))&#123;<br>            <span class="hljs-type">XueChengPlusException</span>.cast(<span class="hljs-string">&quot;订单已支付，请勿重复支付。&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//构造sdk的客户端对象</span><br>        <span class="hljs-type">AlipayClient</span> client <span class="hljs-operator">=</span> new <span class="hljs-type">DefaultAlipayClient</span>(<span class="hljs-type">AlipayConfig</span>.<span class="hljs-type">URL</span>, <span class="hljs-type">APP_ID</span>, <span class="hljs-type">APP_PRIVATE_KEY</span>, <span class="hljs-type">AlipayConfig</span>.<span class="hljs-type">FORMAT</span>, <span class="hljs-type">AlipayConfig</span>.<span class="hljs-type">CHARSET</span>, <span class="hljs-type">ALIPAY_PUBLIC_KEY</span>, <span class="hljs-type">AlipayConfig</span>.<span class="hljs-type">SIGNTYPE</span>);<span class="hljs-comment">//获得初始化的AlipayClient</span><br>        <span class="hljs-type">AlipayTradeWapPayRequest</span> alipayRequest <span class="hljs-operator">=</span> new <span class="hljs-type">AlipayTradeWapPayRequest</span>();<span class="hljs-comment">//创建API对应的request</span><br><span class="hljs-comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span><br><span class="hljs-comment">//        alipayRequest.setNotifyUrl(&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify&quot;);//在公共参数中设置回跳和通知地址</span><br>        alipayRequest.setBizContent(<span class="hljs-string">&quot;&#123;&quot;</span> <span class="hljs-operator">+</span><br>                <span class="hljs-string">&quot; <span class="hljs-subst">\&quot;</span>out_trade_no<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>&quot;</span><span class="hljs-operator">+</span>payRecord.getPayNo()<span class="hljs-operator">+</span><span class="hljs-string">&quot;<span class="hljs-subst">\&quot;</span>,&quot;</span> <span class="hljs-operator">+</span><br>                <span class="hljs-string">&quot; <span class="hljs-subst">\&quot;</span>total_amount<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>&quot;</span><span class="hljs-operator">+</span>payRecord.getTotalPrice()<span class="hljs-operator">+</span><span class="hljs-string">&quot;<span class="hljs-subst">\&quot;</span>,&quot;</span> <span class="hljs-operator">+</span><br>                <span class="hljs-string">&quot; <span class="hljs-subst">\&quot;</span>subject<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>&quot;</span><span class="hljs-operator">+</span>payRecord.getOrderName()<span class="hljs-operator">+</span><span class="hljs-string">&quot;<span class="hljs-subst">\&quot;</span>,&quot;</span> <span class="hljs-operator">+</span><br>                <span class="hljs-string">&quot; <span class="hljs-subst">\&quot;</span>product_code<span class="hljs-subst">\&quot;</span>:<span class="hljs-subst">\&quot;</span>QUICK_WAP_PAY<span class="hljs-subst">\&quot;</span>&quot;</span> <span class="hljs-operator">+</span><br>                <span class="hljs-string">&quot; &#125;&quot;</span>);<span class="hljs-comment">//填充业务参数</span><br>        <span class="hljs-type">String</span> form <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//请求支付宝下单接口,发起http请求</span><br>            form <span class="hljs-operator">=</span> client.pageExecute(alipayRequest).getBody(); <span class="hljs-comment">//调用SDK生成表单</span><br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-type">AlipayApiException</span> e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        httpResponse.setContentType(<span class="hljs-string">&quot;text/html;charset=&quot;</span> <span class="hljs-operator">+</span> <span class="hljs-type">AlipayConfig</span>.<span class="hljs-type">CHARSET</span>);<br>        httpResponse.getWriter().write(form);<span class="hljs-comment">//直接将完整的表单html输出到页面</span><br>        httpResponse.getWriter().flush();<br>        httpResponse.getWriter().close();<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="支付测试"><a href="#支付测试" class="headerlink" title="支付测试"></a><strong>支付测试</strong></h5><p>测试准备：</p>
<p>1、启动网关服务、认证服务、验证码服务、学习中心服务、订单服务、内容管理服务。</p>
<p>2、发布一门收费课程。</p>
<p>3、使用资料目录中的新模板course_template.ftl </p>
<p>测试流程：</p>
<p>1、进入收费课程详细页面，点击马上学习。</p>
<p>2、跟踪浏览器及微服务，观察选课记录是否创建成功、商品订单是否创建成功、支付交易记录是否创建成功。</p>
<p>3、观察生成二维码是否成功</p>
<p>4、使用模拟器扫码测试，是否可以正常支付。</p>
<p>如果报订单参数异常报如下错误，需要检查请求支付宝的下单数据是否正确。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228140552111.png" srcset="/img/loading.gif" lazyload alt="image-20231228140552111"></p>
<h4 id="查询支付结果"><a href="#查询支付结果" class="headerlink" title="查询支付结果"></a><strong>查询支付结果</strong></h4><h5 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h5><p>根据之前的调研获取支付结果的接口，包括：主动查询支付结果，被动接受支付结果</p>
<p>这里先实现主动查询支付结果，当支付完成用户点击支付结果，将请求第三方支付平台查询支付结果。</p>
<p>在OrderController类中定义接口如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;查询支付结果&quot;</span>)</span><br><span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/payresult&quot;</span>)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> PayRecordDto payresult(String payNo) throws IOException &#123;<br><br>    <span class="hljs-comment">//查询支付结果</span><br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="接口实现-1"><a href="#接口实现-1" class="headerlink" title="接口实现"></a>接口实现</h5><h6 id="总体接口"><a href="#总体接口" class="headerlink" title="总体接口"></a>总体接口</h6><p>1、定义查询支付结果的service</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 请求支付宝查询支付结果</span><br><span class="hljs-comment"> * @param payNo 支付记录id</span><br><span class="hljs-comment"> * @return 支付记录信息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title">queryPayResult</span><span class="hljs-params">(<span class="hljs-type">String</span> payNo)</span></span>;<br><br></code></pre></td></tr></table></figure>

<p>2、service实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title function_">queryPayResult</span><span class="hljs-params">(String payNo)</span>&#123;<br>    <span class="hljs-type">XcPayRecord</span> <span class="hljs-variable">payRecord</span> <span class="hljs-operator">=</span> getPayRecordByPayno(payNo);<br>    <span class="hljs-keyword">if</span> (payRecord == <span class="hljs-literal">null</span>) &#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;请重新点击支付获取二维码&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//支付状态</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> payRecord.getStatus();<br>    <span class="hljs-comment">//如果支付成功直接返回</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;601002&quot;</span>.equals(status)) &#123;<br>        <span class="hljs-type">PayRecordDto</span> <span class="hljs-variable">payRecordDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PayRecordDto</span>();<br>        BeanUtils.copyProperties(payRecord, payRecordDto);<br>        <span class="hljs-keyword">return</span> payRecordDto;<br>    &#125;<br>    <span class="hljs-comment">//从支付宝查询支付结果</span><br>    <span class="hljs-type">PayStatusDto</span> <span class="hljs-variable">payStatusDto</span> <span class="hljs-operator">=</span> queryPayResultFromAlipay(payNo);<br>    <span class="hljs-comment">//保存支付结果</span><br>    currentProxy.saveAliPayStatus( payStatusDto);<br>    <span class="hljs-comment">//重新查询支付记录</span><br>    payRecord = getPayRecordByPayno(payNo);<br>    <span class="hljs-type">PayRecordDto</span> <span class="hljs-variable">payRecordDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PayRecordDto</span>();<br>    BeanUtils.copyProperties(payRecord, payRecordDto);<br>    <span class="hljs-keyword">return</span> payRecordDto;<br><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 请求支付宝查询支付结果</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> payNo 支付交易号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 支付结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> PayStatusDto <span class="hljs-title function_">queryPayResultFromAlipay</span><span class="hljs-params">(String payNo)</span>&#123;<br><br>&#125;<br><br><br><br><br></code></pre></td></tr></table></figure>

<h6 id="查询支付结果-1"><a href="#查询支付结果-1" class="headerlink" title="查询支付结果"></a><strong>查询支付结果</strong></h6><p>定义从支付宝查询支付结果的方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 请求支付宝查询支付结果</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> payNo 支付交易号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 支付结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_">PayStatusDto</span> <span class="hljs-title function_">queryPayResultFromAlipay</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> payNo</span>) &#123;<br><br>    <span class="hljs-comment">//========请求支付宝查询支付结果=============</span><br>    <span class="hljs-title class_">AlipayClient</span> alipayClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAlipayClient</span>(<span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">URL</span>, <span class="hljs-variable constant_">APP_ID</span>, <span class="hljs-variable constant_">APP_PRIVATE_KEY</span>, <span class="hljs-string">&quot;json&quot;</span>, <span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">CHARSET</span>, <span class="hljs-variable constant_">ALIPAY_PUBLIC_KEY</span>, <span class="hljs-title class_">AlipayConfig</span>.<span class="hljs-property">SIGNTYPE</span>); <span class="hljs-comment">//获得初始化的AlipayClient</span><br>    <span class="hljs-title class_">AlipayTradeQueryRequest</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayTradeQueryRequest</span>();<br>    <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> bizContent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>();<br>    bizContent.<span class="hljs-title function_">put</span>(<span class="hljs-string">&quot;out_trade_no&quot;</span>, payNo);<br>    request.<span class="hljs-title function_">setBizContent</span>(bizContent.<span class="hljs-title function_">toString</span>());<br>    <span class="hljs-title class_">AlipayTradeQueryResponse</span> response = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        response = alipayClient.<span class="hljs-title function_">execute</span>(request);<br>        <span class="hljs-keyword">if</span> (!response.<span class="hljs-title function_">isSuccess</span>()) &#123;<br>            <span class="hljs-title class_">XueChengPlusException</span>.<span class="hljs-title function_">cast</span>(<span class="hljs-string">&quot;请求支付查询查询失败&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">AlipayApiException</span> e) &#123;<br>        log.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;请求支付宝查询支付结果异常:&#123;&#125;&quot;</span>, e.<span class="hljs-title function_">toString</span>(), e);<br>        <span class="hljs-title class_">XueChengPlusException</span>.<span class="hljs-title function_">cast</span>(<span class="hljs-string">&quot;请求支付查询查询失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//获取支付结果</span><br>    <span class="hljs-title class_">String</span> resultJson = response.<span class="hljs-title function_">getBody</span>();<br>    <span class="hljs-comment">//转map</span><br>    <span class="hljs-title class_">Map</span> resultMap = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parseObject</span>(resultJson, <span class="hljs-title class_">Map</span>.<span class="hljs-property">class</span>);<br>    <span class="hljs-title class_">Map</span> alipay_trade_query_response = (<span class="hljs-title class_">Map</span>) resultMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;alipay_trade_query_response&quot;</span>);<br>    <span class="hljs-comment">//支付结果</span><br>    <span class="hljs-title class_">String</span> trade_status = (<span class="hljs-title class_">String</span>) alipay_trade_query_response.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;trade_status&quot;</span>);<br>    <span class="hljs-title class_">String</span> total_amount = (<span class="hljs-title class_">String</span>) alipay_trade_query_response.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;total_amount&quot;</span>);<br>    <span class="hljs-title class_">String</span> trade_no = (<span class="hljs-title class_">String</span>) alipay_trade_query_response.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;trade_no&quot;</span>);<br>    <span class="hljs-comment">//保存支付结果</span><br>    <span class="hljs-title class_">PayStatusDto</span> payStatusDto = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PayStatusDto</span>();<br>    payStatusDto.<span class="hljs-title function_">setOut_trade_no</span>(payNo);<br>    payStatusDto.<span class="hljs-title function_">setTrade_status</span>(trade_status);<br>    payStatusDto.<span class="hljs-title function_">setApp_id</span>(<span class="hljs-variable constant_">APP_ID</span>);<br>    payStatusDto.<span class="hljs-title function_">setTrade_no</span>(trade_no);<br>    payStatusDto.<span class="hljs-title function_">setTotal_amount</span>(total_amount);<br>    <span class="hljs-keyword">return</span> payStatusDto;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="保存支付结果"><a href="#保存支付结果" class="headerlink" title="保存支付结果"></a><strong>保存支付结果</strong></h6><p>1、定义保存支付结果的接口</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 保存支付宝支付结果</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> payStatusDto  支付结果信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/4 16:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveAliPayStatus</span><span class="hljs-params">(PayStatusDto payStatusDto)</span> </span>;<br><br></code></pre></td></tr></table></figure>

<p>2、编写接口实现</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Java<br>@Transactional<br>@Override<br><span class="hljs-built_in">public</span> <span class="hljs-type">void</span> saveAliPayStatus(PayStatusDto payStatusDto) &#123;<br>    //支付流水号<br>    String payNo = payStatusDto.getOut_trade_no();<br>    XcPayRecord payRecord = getPayRecordByPayno(payNo);<br>    <span class="hljs-keyword">if</span> (payRecord == <span class="hljs-keyword">null</span>) &#123;<br>        XueChengPlusException.cast(&quot;支付记录找不到&quot;);<br>    &#125;<br>    //支付结果<br>    String trade_status = payStatusDto.getTrade_status();<br>    <span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;收到支付结果:&#123;&#125;,支付记录:&#123;&#125;&#125;&quot;, payStatusDto.toString(),payRecord.toString());<br>    <span class="hljs-keyword">if</span> (trade_status.equals(&quot;TRADE_SUCCESS&quot;)) &#123;<br><br>        //支付金额变为分<br>        <span class="hljs-type">Float</span> totalPrice = payRecord.getTotalPrice() * <span class="hljs-number">100</span>;<br>        <span class="hljs-type">Float</span> total_amount = <span class="hljs-type">Float</span>.parseFloat(payStatusDto.getTotal_amount()) * <span class="hljs-number">100</span>;<br>        //校验是否一致<br>        <span class="hljs-keyword">if</span> (!payStatusDto.getApp_id().equals(APP_ID) || totalPrice.intValue() != total_amount.intValue()) &#123;<br>            //校验失败<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;校验支付结果失败,支付记录:&#123;&#125;,APP_ID:&#123;&#125;,totalPrice:&#123;&#125;&quot; ,payRecord.toString(),payStatusDto.getApp_id(),total_amount.intValue());<br>            XueChengPlusException.cast(&quot;校验支付结果失败&quot;);<br>        &#125;<br>        <span class="hljs-keyword">log</span>.<span class="hljs-keyword">debug</span>(&quot;更新支付结果,支付交易流水号:&#123;&#125;,支付结果:&#123;&#125;&quot;, payNo, trade_status);<br>        XcPayRecord payRecord_u = <span class="hljs-built_in">new</span> XcPayRecord();<br>        payRecord_u.setStatus(&quot;601002&quot;);//支付成功<br>        payRecord_u.setOutPayChannel(&quot;Alipay&quot;);<br>        payRecord_u.setOutPayNo(payStatusDto.getTrade_no());//支付宝交易号<br>        payRecord_u.setPaySuccessTime(LocalDateTime.now());//通知时间<br>        <span class="hljs-type">int</span> update1 = payRecordMapper.<span class="hljs-keyword">update</span>(payRecord_u, <span class="hljs-built_in">new</span> LambdaQueryWrapper&lt;XcPayRecord&gt;().eq(XcPayRecord::getPayNo, payNo));<br>        <span class="hljs-keyword">if</span> (update1 &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;更新支付记录状态成功:&#123;&#125;&quot;, payRecord_u.toString());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;更新支付记录状态失败:&#123;&#125;&quot;, payRecord_u.toString());<br>            XueChengPlusException.cast(&quot;更新支付记录状态失败&quot;);<br>        &#125;<br>        //关联的订单号<br>        Long orderId = payRecord.getOrderId();<br>        XcOrders orders = ordersMapper.selectById(orderId);<br>        <span class="hljs-keyword">if</span> (orders == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;根据支付记录[&#123;&#125;&#125;]找不到订单&quot;, payRecord_u.toString());<br>            XueChengPlusException.cast(&quot;根据支付记录找不到订单&quot;);<br>        &#125;<br>        XcOrders order_u = <span class="hljs-built_in">new</span> XcOrders();<br>        order_u.setStatus(&quot;600002&quot;);//支付成功<br>        <span class="hljs-type">int</span> <span class="hljs-keyword">update</span> = ordersMapper.<span class="hljs-keyword">update</span>(order_u, <span class="hljs-built_in">new</span> LambdaQueryWrapper&lt;XcOrders&gt;().eq(XcOrders::getId, orderId));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">update</span> &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;更新订单表状态成功,订单号:&#123;&#125;&quot;, orderId);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">log</span>.<span class="hljs-keyword">info</span>(&quot;更新订单表状态失败,订单号:&#123;&#125;&quot;, orderId);<br>            XueChengPlusException.cast(&quot;更新订单表状态失败&quot;);<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="接口测试-2"><a href="#接口测试-2" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h5><p>1、完善接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@ApiOperation(&quot;查询支付结果&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/payresult&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> PayRecordDto <span class="hljs-title function_">payresult</span><span class="hljs-params">(String payNo)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//调用支付宝接口查询</span><br>    <span class="hljs-type">PayRecordDto</span> <span class="hljs-variable">payRecordDto</span> <span class="hljs-operator">=</span> orderService.queryPayResult(payNo);<br>    <span class="hljs-keyword">return</span> payRecordDto;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>2、测试流程</p>
<p>完成生成支付二维码</p>
<p>用支付宝扫码但不支付</p>
<p>使用httpclient请求查询支付结果，查询失败</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Java<br><span class="hljs-comment">### 查询支付结果</span><br><span class="hljs-built_in">GET</span> &#123;&#123;orders_host&#125;&#125;/orders/payresult?<span class="hljs-attribute">payNo</span>=1628648111951941632<br>Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ7XCJiaXJ0aGRheVwiOlwiMjAyMi0wOS0yOFQxOToyODo0NlwiLFwiY3JlYXRlVGltZVwiOlwiMjAyMi0wOS0yOFQwODozMjowM1wiLFwiaWRcIjpcIjUwXCIsXCJuYW1lXCI6XCLlrabnlJ8xXCIsXCJuaWNrbmFtZVwiOlwi5aSn5rC054mbXCIsXCJwZXJtaXNzaW9uc1wiOltdLFwic2V4XCI6XCIxXCIsXCJzdGF0dXNcIjpcIjFcIixcInVzZXJuYW1lXCI6XCJzdHUxXCIsXCJ1c2VycGljXCI6XCJodHRwOi8vZmlsZS41MXh1ZWNoZW5nLmNuL2RkZGZcIixcInV0eXBlXCI6XCIxMDEwMDFcIn0iLCJzY29wZSI6WyJhbGwiXSwiZXhwIjoxNjc3MTQwMDI1LCJhdXRob3JpdGllcyI6WyJwMSJdLCJqdGkiOiJmYThiMmY1OS03ZTQ5LTRmODUtOTBlMC05NzYwNjlkYjE3ODIiLCJjbGllbnRfaWQiOiJYY1dlYkFwcCJ9.89sp5lPdFafZ_HdGhe8Cpv0anMJC3vT4PtaGMHgCkr8<br><br></code></pre></td></tr></table></figure>

<p>用支付宝扫码再次完成支付</p>
<p>使用httpclient请求查询支付结果，支付结果为成功，并更新支付记录状态和订单状态。</p>
<p>3、使用前后端联调</p>
<p>拷贝资料目录中LocalDateTimeConfig.java到base工程下，处理long转string精度损失的问题。</p>
<p>使用最新的门户代码xc-ui-pc-static-portal.zip</p>
<h4 id="接收支付通知"><a href="#接收支付通知" class="headerlink" title="接收支付通知"></a><strong>接收支付通知</strong></h4><h5 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h5><p>支付完成后第三方支付系统会主动通知支付结果，要实现主动通知需要在请求支付系统下单时传入NotifyUrl，这里有两个url：NotifyUrl和ReturnUrl，ReturnUrl是支付完成后支付系统携带支付结果重定向到ReturnUrl地址，NotifyUrl是支付完成后支付系统在后台定时去通知，使用NotifyUrl比使用ReturnUrl有保证。</p>
<p>根据接口描述：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105286%E7%9A%84%E5%86%85%E5%AE%B9%E4%B8%8B%E8%BE%B9%E5%9C%A8%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%AE%9A%E4%B9%89%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E9%80%9A%E7%9F%A5%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%82">https://opendocs.alipay.com/open/203/105286的内容下边在订单服务定义接收支付结果通知的接口。</a></p>
<p>首先在下单时指定NotifyUrl:</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Java<br>alipayRequest.setNotifyUrl(<span class="hljs-string">&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/receivenotify&quot;</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>接收支付结果通知接口如下：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Java<br><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">&quot;接收支付结果通知&quot;</span>)<br><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">&quot;/receivenotify&quot;</span>)<br><span class="hljs-keyword">public</span> void receivenotify(HttpServletRequest request,HttpServletResponse out) throws UnsupportedEncodingException, AlipayApiException &#123;<br>    Map&lt;<span class="hljs-keyword">String</span>,<span class="hljs-keyword">String</span>&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-type">HashMap</span>&lt;<span class="hljs-keyword">String</span>,<span class="hljs-keyword">String</span>&gt;();<br>    Map requestParams = request.getParameterMap();<br>    <span class="hljs-keyword">for</span> (Iterator iter = requestParams.keySet().iterator(); iter.hasNext();) &#123;<br>        <span class="hljs-keyword">String</span> name = (<span class="hljs-keyword">String</span>) iter.next();<br>        <span class="hljs-keyword">String</span>[] values = (<span class="hljs-keyword">String</span>[]) requestParams.<span class="hljs-keyword">get</span>(name);<br>        <span class="hljs-keyword">String</span> valueStr = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; values.length; i++) &#123;<br>            valueStr = (i == values.length - <span class="hljs-number">1</span>) ? valueStr + values[i]<br>                    : <span class="hljs-type">valueStr </span>+ values[i] + <span class="hljs-string">&quot;,&quot;</span>;<br>        &#125;<br>        params.put(name, valueStr);<br>    &#125;<br><br>    <span class="hljs-comment">//验签</span><br>    boolean verify_result = AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="hljs-string">&quot;RSA2&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(verify_result) &#123;<span class="hljs-comment">//验证成功</span><br><br>        <span class="hljs-comment">//商户订单号</span><br>        <span class="hljs-keyword">String</span> out_trade_no = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;out_trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//支付宝交易号</span><br>        <span class="hljs-keyword">String</span> trade_no = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//交易状态</span><br>        <span class="hljs-keyword">String</span> trade_status = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;trade_status&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//appid</span><br>        <span class="hljs-keyword">String</span> app_id = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;app_id&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//total_amount</span><br>        <span class="hljs-keyword">String</span> total_amount = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;total_amount&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br><br>        <span class="hljs-comment">//交易成功处理</span><br>        <span class="hljs-keyword">if</span> (trade_status.equals(<span class="hljs-string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;<br>           <br>           <span class="hljs-comment">//处理逻辑。。。</span><br>            <br>        &#125;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="接口实现-2"><a href="#接口实现-2" class="headerlink" title="接口实现"></a><strong>接口实现</strong></h5><p>完善contorller接口</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Java<br><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">&quot;接收支付结果通知&quot;</span>)<br><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">&quot;/receivenotify&quot;</span>)<br><span class="hljs-keyword">public</span> void receivenotify(HttpServletRequest request) throws UnsupportedEncodingException, AlipayApiException &#123;<br>    Map&lt;<span class="hljs-keyword">String</span>,<span class="hljs-keyword">String</span>&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-type">HashMap</span>&lt;<span class="hljs-keyword">String</span>,<span class="hljs-keyword">String</span>&gt;();<br>    Map requestParams = request.getParameterMap();<br>    <span class="hljs-keyword">for</span> (Iterator iter = requestParams.keySet().iterator(); iter.hasNext();) &#123;<br>        <span class="hljs-keyword">String</span> name = (<span class="hljs-keyword">String</span>) iter.next();<br>        <span class="hljs-keyword">String</span>[] values = (<span class="hljs-keyword">String</span>[]) requestParams.<span class="hljs-keyword">get</span>(name);<br>        <span class="hljs-keyword">String</span> valueStr = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; values.length; i++) &#123;<br>            valueStr = (i == values.length - <span class="hljs-number">1</span>) ? valueStr + values[i]<br>                    : <span class="hljs-type">valueStr </span>+ values[i] + <span class="hljs-string">&quot;,&quot;</span>;<br>        &#125;<br>        params.put(name, valueStr);<br>    &#125;<br><br>    <span class="hljs-comment">//验签</span><br>    boolean verify_result = AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="hljs-string">&quot;RSA2&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(verify_result) &#123;<span class="hljs-comment">//验证成功</span><br><br>        <span class="hljs-comment">//商户订单号</span><br>        <span class="hljs-keyword">String</span> out_trade_no = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;out_trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//支付宝交易号</span><br>        <span class="hljs-keyword">String</span> trade_no = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;trade_no&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//交易状态</span><br>        <span class="hljs-keyword">String</span> trade_status = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;trade_status&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//appid</span><br>        <span class="hljs-keyword">String</span> app_id = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;app_id&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-comment">//total_amount</span><br>        <span class="hljs-keyword">String</span> total_amount = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(request.getParameter(<span class="hljs-string">&quot;total_amount&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br><br>        <span class="hljs-comment">//交易成功处理</span><br>        <span class="hljs-keyword">if</span> (trade_status.equals(<span class="hljs-string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;<br><br>            PayStatusDto payStatusDto = <span class="hljs-keyword">new</span> <span class="hljs-type">PayStatusDto</span>();<br>            payStatusDto.setOut_trade_no(out_trade_no);<br>            payStatusDto.setTrade_status(trade_status);<br>            payStatusDto.setApp_id(app_id);<br>            payStatusDto.setTrade_no(trade_no);<br>            payStatusDto.setTotal_amount(total_amount);<br><br>           <span class="hljs-comment">//处理逻辑。。。</span><br>            orderService.saveAliPayStatus(payStatusDto);<br>        &#125;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="接口测试-3"><a href="#接口测试-3" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h5><p>测试准备：</p>
<p>1、启动网关服务、认证服务、验证码服务、学习中心服务、内容管理服务。</p>
<p>2、发布一门收费课程。</p>
<p>测试流程：</p>
<p>1、对选课进行支付</p>
<p>2、支付成功跟踪service方法的日志，支付成功需要更新支付交易表记录的状态、通知时间、支付宝交易号、支付渠道(Alipay)</p>
<p>支付成功更新订单表的状态为空。</p>
<h3 id="支付通知"><a href="#支付通知" class="headerlink" title="支付通知"></a><strong>支付通知</strong></h3><h4 id="需求分析-3"><a href="#需求分析-3" class="headerlink" title="需求分析"></a>需求分析</h4><p>订单服务作为通用服务在订单支付成功后需要将支付结果异步通知给其它微服务。</p>
<p>下图使用了消息队列完成支付结果通知：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228150138159.png" srcset="/img/loading.gif" lazyload alt="image-20231228150138159"></p>
<p>学习中心服务：对收费课程选课需要支付，与订单服务对接完成支付。</p>
<p>学习资源服务：对收费的学习资料需要购买后下载，与订单服务对接完成支付。</p>
<p>订单服务完成支付后将支付结果发给每一个与订单服务对接的微服务，订单服务将消息发给交换机，由交换机广播消息，每个订阅消息的微服务都可以接收到支付结果.</p>
<p>微服务收到支付结果根据订单的类型去更新自己的业务数据。</p>
<h4 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a><strong>技术方案</strong></h4><p>使用消息队列进行异步通信需要保证消息的可靠性，即生产端将消息成功通知到消费端</p>
<p>消息从生产端发送到消费端经历了如下过程：</p>
<ol>
<li>消息发送到交换机</li>
<li>消息由交换机发送到队列</li>
<li>消费者收到消息进行处理</li>
</ol>
<p>保证消息的可靠性需要保证以上过程的可靠性，本项目使用RabbitMQ可以通过如下方面保证消息的可靠性：</p>
<ol>
<li>生产者的确认机制</li>
</ol>
<p>发送消息前使用数据库事务将消息保存在数据库表中</p>
<p>成功发送到交换机将消息从数据库删除</p>
<ol start="2">
<li>mq持久化</li>
</ol>
<p>mq收到消息进行持久化，当mq重启及时消息没有消费也不会丢失</p>
<p>需要配置交换机持久化，队列持久化，发送消息时设置持久化</p>
<ol start="3">
<li>消费者确认机制</li>
</ol>
<p>消费者消费成功自动发送ack，否则重试消费</p>
<h4 id="发送支付结果"><a href="#发送支付结果" class="headerlink" title="发送支付结果"></a><strong>发送支付结果</strong></h4><h5 id="订单服务集成MQ"><a href="#订单服务集成MQ" class="headerlink" title="订单服务集成MQ"></a>订单服务集成MQ</h5><p>订单服务通过消息队列将支付结果发给学习中心服务，消息队列采用发布订阅模式。</p>
<ol>
<li>订单服务创建支付结果通知交换机</li>
<li>学习中心服务绑定队列到交换机</li>
</ol>
<p>项目使用RabbitMQ作为消息队列，在课前下发的虚拟上已经安装了RabbitMQ.</p>
<p>执行docker start rabbitmq 启动RabbitMQ。访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:15672/">http://192.168.101.65:15672/</a> </p>
<p>账户密码：guest&#x2F;guest</p>
<p>交换机为Fanout广播模式。</p>
<p>首先需要在学习中心服务和订单服务工程配置连接消息队列。</p>
<p>1、首先在订单服务添加消息队列依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml">XML<br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>2、在nacos配置rabbitmq-dev.yaml为通用配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">YAML</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span> <span class="hljs-comment">#correlated 异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback</span><br>    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#开启publish-return功能，同样是基于callback机制，需要定义ReturnCallback</span><br>    <span class="hljs-attr">template:</span><br>      <span class="hljs-attr">mandatory:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">none</span> <span class="hljs-comment">#出现异常时返回unack，消息回滚到mq；没有异常，返回ack ,manual:手动控制,none:丢弃消息，不回滚到mq</span><br>        <span class="hljs-attr">retry:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#开启消费者失败重试</span><br>          <span class="hljs-attr">initial-interval:</span> <span class="hljs-string">1000ms</span> <span class="hljs-comment">#初识的失败等待时长为1秒</span><br>          <span class="hljs-attr">multiplier:</span> <span class="hljs-number">1</span> <span class="hljs-comment">#失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span><br>          <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span> <span class="hljs-comment">#最大重试次数</span><br>          <span class="hljs-attr">stateless:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#true无状态；false有状态。如果业务中包含事务，这里改为false</span><br><br></code></pre></td></tr></table></figure>

<p>3、在订单服务接口工程引入rabbitmq-dev.yaml配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">shared-configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">rabbitmq-$&#123;spring.profiles.active&#125;.yaml</span><br>    <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-common</span><br>    <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure>

<p>4、在订单服务service工程编写MQ配置类，配置交换机</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.orders.config;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.*;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/2/23 16:59</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayNotifyConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br><br>    <span class="hljs-comment">//交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;paynotify_exchange_fanout&quot;</span>;<br>    <span class="hljs-comment">//支付结果通知消息类型</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MESSAGE_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;payresult_notify&quot;</span>;<br>    <span class="hljs-comment">//支付通知队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PAYNOTIFY_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;paynotify_queue&quot;</span>;<br><br>    <span class="hljs-comment">//声明交换机，且持久化</span><br>    <span class="hljs-meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span><br>    <span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title function_">paynotify_exchange_fanout</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-comment">//支付通知队列,且持久化</span><br>    <span class="hljs-meta">@Bean(PAYNOTIFY_QUEUE)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">course_publish_queue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build();<br>    &#125;<br><br>    <span class="hljs-comment">//交换机和支付通知队列绑定</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">binding_course_publish_queue</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="hljs-meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-comment">// 获取RabbitTemplate</span><br>        <span class="hljs-type">RabbitTemplate</span> <span class="hljs-variable">rabbitTemplate</span> <span class="hljs-operator">=</span> applicationContext.getBean(RabbitTemplate.class);<br>        <span class="hljs-comment">//消息处理service</span><br>        <span class="hljs-type">MqMessageService</span> <span class="hljs-variable">mqMessageService</span> <span class="hljs-operator">=</span> applicationContext.getBean(MqMessageService.class);<br>        <span class="hljs-comment">// 设置ReturnCallback</span><br>        rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -&gt; &#123;<br>            <span class="hljs-comment">// 投递失败，记录日志</span><br>            log.info(<span class="hljs-string">&quot;消息发送失败，应答码&#123;&#125;，原因&#123;&#125;，交换机&#123;&#125;，路由键&#123;&#125;,消息&#123;&#125;&quot;</span>,<br>                    replyCode, replyText, exchange, routingKey, message.toString());<br>            <span class="hljs-type">MqMessage</span> <span class="hljs-variable">mqMessage</span> <span class="hljs-operator">=</span> JSON.parseObject(message.toString(), MqMessage.class);<br>            <span class="hljs-comment">//将消息再添加到消息表</span><br>            mqMessageService.addMessage(mqMessage.getMessageType(),mqMessage.getBusinessKey1(),mqMessage.getBusinessKey2(),mqMessage.getBusinessKey3());<br><br>        &#125;);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>重启订单服务，登录rabbitmq，查看交换机自动创建成功</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228154534620.png" srcset="/img/loading.gif" lazyload alt="image-20231228154534620"></p>
<p>查看队列自动成功</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228154549404.png" srcset="/img/loading.gif" lazyload alt="image-20231228154549404"></p>
<h5 id="发送支付结果-1"><a href="#发送支付结果-1" class="headerlink" title="发送支付结果"></a><strong>发送支付结果</strong></h5><p>在OrderService中定义接口</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发送通知结果</span><br><span class="hljs-comment"> * @param message</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">notifyPayResult</span><span class="hljs-params">(MqMessage message)</span></span>;<br><br></code></pre></td></tr></table></figure>

<p>编写接口实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyPayResult</span><span class="hljs-params">(MqMessage message)</span> &#123;<br><br>    <span class="hljs-comment">//1、消息体，转json</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> JSON.toJSONString(message);<br>    <span class="hljs-comment">//设置消息持久化</span><br>    <span class="hljs-type">Message</span> <span class="hljs-variable">msgObj</span> <span class="hljs-operator">=</span> MessageBuilder.withBody(msg.getBytes(StandardCharsets.UTF_8))<br>            .setDeliveryMode(MessageDeliveryMode.PERSISTENT)<br>            .build();<br>    <span class="hljs-comment">// 2.全局唯一的消息ID，需要封装到CorrelationData中</span><br>    <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(message.getId().toString());<br>    <span class="hljs-comment">// 3.添加callback</span><br>    correlationData.getFuture().addCallback(<br>            result -&gt; &#123;<br>                <span class="hljs-keyword">if</span>(result.isAck())&#123;<br>                    <span class="hljs-comment">// 3.1.ack，消息成功</span><br>                    log.debug(<span class="hljs-string">&quot;通知支付结果消息发送成功, ID:&#123;&#125;&quot;</span>, correlationData.getId());<br>                    <span class="hljs-comment">//删除消息表中的记录</span><br>                    mqMessageService.completed(message.getId());<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-comment">// 3.2.nack，消息失败</span><br>                    log.error(<span class="hljs-string">&quot;通知支付结果消息发送失败, ID:&#123;&#125;, 原因&#123;&#125;&quot;</span>,correlationData.getId(), result.getReason());<br>                &#125;<br>            &#125;,<br>            ex -&gt; log.error(<span class="hljs-string">&quot;消息发送异常, ID:&#123;&#125;, 原因&#123;&#125;&quot;</span>,correlationData.getId(),ex.getMessage())<br>    );<br>    <span class="hljs-comment">// 发送消息</span><br>    rabbitTemplate.convertAndSend(PayNotifyConfig.PAYNOTIFY_EXCHANGE_FANOUT, <span class="hljs-string">&quot;&quot;</span>, msgObj,correlationData);<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>订单服务收到第三方平台的支付结果时，在saveAliPayStatus方法中添加代码，向数据库消息表添加消息并进行发送消息，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveAliPayStatus</span><span class="hljs-params">(PayStatusDto payStatusDto)</span> &#123;<br>        .......<br>        <span class="hljs-comment">//保存消息记录,参数1：支付结果通知类型，2: 业务id，3:业务类型</span><br>        <span class="hljs-type">MqMessage</span> <span class="hljs-variable">mqMessage</span> <span class="hljs-operator">=</span> mqMessageService.addMessage(<span class="hljs-string">&quot;payresult_notify&quot;</span>, orders.getOutBusinessId(), orders.getOrderType(), <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//通知消息</span><br>        notifyPayResult(mqMessage);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>配置交换机和队列</p>
<p>在order-service工程配置</p>
<p>消息发送方法</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Java<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发送通知结果</span><br><span class="hljs-comment"> * @param message</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">notifyPayResult</span><span class="hljs-params">(MqMessage message)</span></span>;<br><br><br><br></code></pre></td></tr></table></figure>

<h4 id="接收支付结果"><a href="#接收支付结果" class="headerlink" title="接收支付结果"></a><strong>接收支付结果</strong></h4><h5 id="学习中心服务集成MQ"><a href="#学习中心服务集成MQ" class="headerlink" title="学习中心服务集成MQ"></a><strong>学习中心服务集成MQ</strong></h5><p>1、在学习中心服务添加消息队列依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">XML<br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>2、在学习中心服务接口工程引入rabbitmq-dev.yaml配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">YAML</span><br><span class="hljs-attr">shared-configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">rabbitmq-$&#123;spring.profiles.active&#125;.yaml</span><br>    <span class="hljs-attr">group:</span> <span class="hljs-string">xuecheng-plus-common</span><br>    <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure>

<p>3、添加配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.config;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.*;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/2/23 16:59</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayNotifyConfig</span> &#123;<br><br>    <span class="hljs-comment">//交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;paynotify_exchange_fanout&quot;</span>;<br>    <span class="hljs-comment">//支付结果通知消息类型</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MESSAGE_TYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;payresult_notify&quot;</span>;<br>    <span class="hljs-comment">//支付通知队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PAYNOTIFY_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;paynotify_queue&quot;</span>;<br><br>    <span class="hljs-comment">//声明交换机，且持久化</span><br>    <span class="hljs-meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span><br>    <span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title function_">paynotify_exchange_fanout</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-comment">//支付通知队列,且持久化</span><br>    <span class="hljs-meta">@Bean(PAYNOTIFY_QUEUE)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">course_publish_queue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build();<br>    &#125;<br><br>    <span class="hljs-comment">//交换机和支付通知队列绑定</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">binding_course_publish_queue</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="hljs-meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="接收支付结果-1"><a href="#接收支付结果-1" class="headerlink" title="接收支付结果"></a><strong>接收支付结果</strong></h5><p>监听MQ，接收支付结果，定义ReceivePayNotifyService类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.xuecheng.base.exception.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.config.PayNotifyConfig;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.service.MyCourseTablesService;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;<br><span class="hljs-keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 接收支付结果</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2023/2/23 19:04</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReceivePayNotifyService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MqMessageService mqMessageService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MyCourseTablesService myCourseTablesService;<br><br><br>    <span class="hljs-comment">//监听消息队列接收支付结果通知</span><br>    <span class="hljs-meta">@RabbitListener(queues = PayNotifyConfig.PAYNOTIFY_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">(Message message, Channel channel)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">5000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-comment">//获取消息</span><br>        <span class="hljs-type">MqMessage</span> <span class="hljs-variable">mqMessage</span> <span class="hljs-operator">=</span> JSON.parseObject(message.getBody(), MqMessage.class);<br>        log.debug(<span class="hljs-string">&quot;学习中心服务接收支付结果:&#123;&#125;&quot;</span>, mqMessage);<br><br>        <span class="hljs-comment">//消息类型</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">messageType</span> <span class="hljs-operator">=</span> mqMessage.getMessageType();<br>        <span class="hljs-comment">//订单类型,60201表示购买课程</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">businessKey2</span> <span class="hljs-operator">=</span> mqMessage.getBusinessKey2();<br>        <span class="hljs-comment">//这里只处理支付结果通知</span><br>        <span class="hljs-keyword">if</span> (PayNotifyConfig.MESSAGE_TYPE.equals(messageType) &amp;&amp; <span class="hljs-string">&quot;60201&quot;</span>.equals(businessKey2)) &#123;<br>            <span class="hljs-comment">//选课记录id</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">choosecourseId</span> <span class="hljs-operator">=</span> mqMessage.getBusinessKey1();<br>            <span class="hljs-comment">//添加选课</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> myCourseTablesService.saveChooseCourseStauts(choosecourseId);<br>            <span class="hljs-keyword">if</span>(!b)&#123;<br>                <span class="hljs-comment">//添加选课失败，抛出异常，消息重回队列</span><br>                XueChengPlusException.cast(<span class="hljs-string">&quot;收到支付结果，添加选课失败&quot;</span>);<br>            &#125;<br>        &#125;<br><br><br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="通知支付结果测试"><a href="#通知支付结果测试" class="headerlink" title="通知支付结果测试"></a><strong>通知支付结果测试</strong></h4><p>测试准备：</p>
<p>1、找一门已发布的收费课程。</p>
<p>2、如果在我的课程表存储则删除。</p>
<p>3、删除此课程的选课记录及订单信息。</p>
<p>测试流程：</p>
<p>1、进入课程详细页面，点击马上学习，生成二维码进行支付。</p>
<p>2、支付完成点击“支付完成”，观察订单服务控制台是否发送消息。</p>
<p>3、观察学习中心服务控制台是否接收到消息。</p>
<p>4、观察数据库中的消息表的相应记录是否已删除。</p>
<p>消费重试测试：</p>
<p>1、在学习中心服务接收支付结果方法中制造异常。</p>
<p>2、重新执行上边的测试流程，观察是否消费重试。</p>
<h3 id="在线学习-1"><a href="#在线学习-1" class="headerlink" title="在线学习"></a><strong>在线学习</strong></h3><h4 id="需求分析-4"><a href="#需求分析-4" class="headerlink" title="需求分析"></a>需求分析</h4><p>用户通过课程详情界面点击马上学习，进入视频播放界面进行视频点播</p>
<p>获取视频资源时进行<strong>学习资格校验</strong>，如下图： </p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228160002856.png" srcset="/img/loading.gif" lazyload alt="image-20231228160002856"></p>
<p>拥有学习资格则继续播放视频，不具有学习资格则引导去购买、续期等操作。</p>
<p><strong>如何判断是否拥有学习资格？</strong></p>
<p>首先判断是否为试学视频，如果为试学视频则可以正常学习。</p>
<p>如果为非试学课程首先判断用户是否登录，如果已登录则判断是否选课，如果已经选课且没有过期可以正常学习。</p>
<p>详细流程如下图：</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228160054086.png" srcset="/img/loading.gif" lazyload alt="image-20231228160054086"></p>
<h4 id="查询课程信息"><a href="#查询课程信息" class="headerlink" title="查询课程信息"></a><strong>查询课程信息</strong></h4><p>在视频点播页面需要查询课程信息，课程上线后也需要访问&#x2F;api&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p>
<p>课程预览时请求获取课程的接口为：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p>
<p>在nginx中进行配置：</p>
<p>&#x2F;open、&#x2F;api在nginx的配置如下：(已经配置的不要重复配置)</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">Plain Text<br>        <span class="hljs-comment">#api</span><br>        <span class="hljs-keyword">location</span> <span class="hljs-title">/api</span>/ &#123;<br>                proxy_pass http://gatewayserver/;<br>        &#125; <br>        <span class="hljs-comment">#openapi</span><br>        <span class="hljs-keyword">location</span> <span class="hljs-title">/open</span>/content/ &#123;<br>                proxy_pass http://gatewayserver/content/open/;<br>        &#125; <br>        <span class="hljs-keyword">location</span> <span class="hljs-title">/open</span>/media/ &#123;<br>                proxy_pass http://gatewayserver/media/open/;<br>        &#125; <br><br></code></pre></td></tr></table></figure>

<p>下边实现&#x2F;api&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId} 获取课程发布信息接口。</p>
<p>进入内容管理服务api工程CoursePublishController 类，定义查询课程预览信息接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">Java<br><span class="hljs-meta">@ApiOperation(&quot;获取课程发布信息&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@GetMapping(&quot;/course/whole/&#123;courseId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> CoursePreviewDto <span class="hljs-title function_">getCoursePublish</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;<br>    <span class="hljs-comment">//查询课程发布信息</span><br>    <span class="hljs-type">CoursePublish</span> <span class="hljs-variable">coursePublish</span> <span class="hljs-operator">=</span> coursePublishService.getCoursePublish(courseId);<br>    <span class="hljs-keyword">if</span> (coursePublish == <span class="hljs-literal">null</span>) &#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePreviewDto</span>();<br>     &#125;<br><br>    <span class="hljs-comment">//课程基本信息</span><br>    <span class="hljs-type">CourseBaseInfoDto</span> <span class="hljs-variable">courseBase</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseBaseInfoDto</span>();<br>    BeanUtils.copyProperties(coursePublish, courseBase);<br>    <span class="hljs-comment">//课程计划</span><br>    List&lt;TeachplanDto&gt; teachplans = JSON.parseArray(coursePublish.getTeachplan(), TeachplanDto.class);<br>    <span class="hljs-type">CoursePreviewDto</span> <span class="hljs-variable">coursePreviewInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePreviewDto</span>();<br>    coursePreviewInfo.setCourseBase(courseBase);<br>    coursePreviewInfo.setTeachplans(teachplans);<br>    <span class="hljs-keyword">return</span> coursePreviewInfo;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>重启内容管理服务，进入学习界面查看课程计划、课程名称等信息是否显示正常。</p>
<h4 id="获取视频"><a href="#获取视频" class="headerlink" title="获取视频"></a><strong>获取视频</strong></h4><h5 id="需求分析-5"><a href="#需求分析-5" class="headerlink" title="需求分析"></a>需求分析</h5><p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228160632215.png" srcset="/img/loading.gif" lazyload alt="image-20231228160632215"></p>
<h5 id="接口定义-3"><a href="#接口定义-3" class="headerlink" title="接口定义"></a>接口定义</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.api;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.base.model.XcUser;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcCourseTablesDto;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.service.LearningService;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.service.MyCourseTablesService;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.util.SecurityUtil;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 学习过程管理接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/2 14:52</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Api(value = <span class="hljs-string">&quot;学习过程管理接口&quot;</span>, tags = <span class="hljs-string">&quot;学习过程管理接口&quot;</span>)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLearningController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    LearningService learningService;<br><br><br>    <span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;获取视频&quot;</span>)</span><br>    <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/open/learn/getvideo/&#123;courseId&#125;/&#123;teachplanId&#125;/&#123;mediaId&#125;&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> RestResponse&lt;String&gt; getvideo(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> courseId,<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> teachplanId, <span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;mediaId&quot;</span>)</span> String mediaId) &#123;<br>        <span class="hljs-comment">//登录用户</span><br>        XcUser user = SecurityUtil.getUser();<br>        String userId = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span>(user != <span class="hljs-literal">null</span>)&#123;<br>            userId = user.getId();<br>        &#125;<br>        <span class="hljs-comment">//获取视频</span><br>       <br><br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>定义service接口</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.service;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;<br><span class="hljs-keyword">import</span> com.xuecheng.learning.model.dto.XcCourseTablesDto;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 学习过程管理service接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/2 16:07</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LearningService</span> &#123;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 获取教学视频</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId 课程id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> teachplanId 课程计划id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mediaId 视频文件id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.String&gt;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/5 9:08</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> RestResponse&lt;String&gt; getVideo(String userId,<span class="hljs-built_in">Long</span> courseId,<span class="hljs-built_in">Long</span> teachplanId,String mediaId);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>获取视频远程接口</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-keyword">package</span> com.xuecheng.learning.feignclient;<br><br><span class="hljs-keyword">import</span> com.xuecheng.base.model.RestResponse;<br><span class="hljs-keyword">import</span> com.xuecheng.content.model.po.CoursePublish;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RequestMapping;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 媒资管理服务远程接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/9/20 20:29</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-meta">@FeignClient(value = <span class="hljs-string">&quot;media-api&quot;</span>,fallbackFactory = MediaServiceClientFallbackFactory.class)</span><br> <span class="hljs-meta">@RequestMapping(<span class="hljs-string">&quot;/media&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MediaServiceClient</span> &#123;<br><br> <span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/open/preview/&#123;mediaId&#125;&quot;</span>)</span><br> <span class="hljs-keyword">public</span> RestResponse&lt;String&gt; getPlayUrlByMediaId(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;mediaId&quot;</span>)</span> String mediaId);<br><br> &#125;<br> <br><br></code></pre></td></tr></table></figure>

<p>FeignClient接口的降级类：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Java</span><br><br> package com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">learning</span>.<span class="hljs-property">feignclient</span>;<br><br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">base</span>.<span class="hljs-property">model</span>.<span class="hljs-property">RestResponse</span>;<br><span class="hljs-keyword">import</span> com.<span class="hljs-property">xuecheng</span>.<span class="hljs-property">content</span>.<span class="hljs-property">model</span>.<span class="hljs-property">po</span>.<span class="hljs-property">CoursePublish</span>;<br><span class="hljs-keyword">import</span> feign.<span class="hljs-property">hystrix</span>.<span class="hljs-property">FallbackFactory</span>;<br><span class="hljs-keyword">import</span> lombok.<span class="hljs-property">extern</span>.<span class="hljs-property">slf4j</span>.<span class="hljs-property">Slf4j</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.M</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> <span class="hljs-variable">TODO</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022/10/3 8:03</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaServiceClientFallbackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;<span class="hljs-title class_">MediaServiceClient</span>&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MediaServiceClient</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">Throwable throwable</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaServiceClient</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-title class_">RestResponse</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">getPlayUrlByMediaId</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> mediaId</span>) &#123;<br>                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;远程调用媒资管理服务熔断异常：&#123;&#125;&quot;</span>,throwable.<span class="hljs-title function_">getMessage</span>());<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="学习资格校验"><a href="#学习资格校验" class="headerlink" title="学习资格校验"></a><strong>学习资格校验</strong></h5><p>编写获取视频的接口实现方法：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs autoit">Java<br><span class="hljs-symbol">@Override</span><br>public RestResponse&lt;<span class="hljs-built_in">String</span>&gt; getVideo(<span class="hljs-built_in">String</span> userId,Long courseId,Long teachplanId, <span class="hljs-built_in">String</span> mediaId) &#123;<br>    //查询课程信息<br>    CoursePublish coursepublish = contentServiceClient.getCoursepublish(courseId)<span class="hljs-comment">;</span><br>    <span class="hljs-keyword">if</span>(coursepublish==<span class="hljs-literal">null</span>)&#123;<br>        XueChengPlusException.cast(<span class="hljs-string">&quot;课程信息不存在&quot;</span>)<span class="hljs-comment">;</span><br>    &#125;<br>    //校验学习资格<br><br>    //如果登录<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(userId))&#123;<br><br>        //判断是否选课，根据选课情况判断学习资格<br>        XcCourseTablesDto xcCourseTablesDto = myCourseTablesService.getLeanringStatus(userId, courseId)<span class="hljs-comment">;</span><br>        //学习资格状态 [&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702001&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;正常学习&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702002&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;没有选课或选课后没有支付&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;702003&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;已过期需要申请续期或重新支付&quot;</span>&#125;]<br>        <span class="hljs-built_in">String</span> learnStatus = xcCourseTablesDto.getLearnStatus()<span class="hljs-comment">;</span><br>        <span class="hljs-keyword">if</span>(learnStatus.equals(<span class="hljs-string">&quot;702001&quot;</span>))&#123;<br>            <span class="hljs-keyword">return</span> mediaServiceClient.getPlayUrlByMediaId(mediaId)<span class="hljs-comment">;</span><br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(learnStatus.equals(<span class="hljs-string">&quot;702003&quot;</span>))&#123;<br>            RestResponse.validfail(<span class="hljs-string">&quot;您的选课已过期需要申请续期或重新支付&quot;</span>)<span class="hljs-comment">;</span><br>        &#125;<br>    &#125;<br><br>    //未登录或未选课判断是否收费<br>    <span class="hljs-built_in">String</span> charge = coursepublish.getCharge()<span class="hljs-comment">;</span><br>    <span class="hljs-keyword">if</span>(charge.equals(<span class="hljs-string">&quot;201000&quot;</span>))&#123;//免费可以正常学习<br>        <span class="hljs-keyword">return</span> mediaServiceClient.getPlayUrlByMediaId(mediaId)<span class="hljs-comment">;</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> RestResponse.validfail(<span class="hljs-string">&quot;请购买课程后继续学习&quot;</span>)<span class="hljs-comment">;</span><br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a><strong>测试</strong></h5><p>1、完善接口</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;获取视频&quot;</span>)</span><br><span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/open/learn/getvideo/&#123;courseId&#125;/&#123;teachplanId&#125;/&#123;mediaId&#125;&quot;</span>)</span><br><span class="hljs-keyword">public</span> RestResponse&lt;String&gt; getvideo(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> courseId, <span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;courseId&quot;</span>)</span> <span class="hljs-built_in">Long</span> teachplanId, <span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;mediaId&quot;</span>)</span> String mediaId) &#123;<br><br>    <span class="hljs-comment">//登录用户</span><br>    SecurityUtil.XcUser user = SecurityUtil.getUser();<br>    String userId = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>        userId = user.getId();<br>    &#125;<br>    <span class="hljs-comment">//获取视频</span><br>    <span class="hljs-keyword">return</span> learningService.getVideo(userId, courseId, teachplanId, mediaId);<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>2、测试准备</p>
<p>选课成功一门课程。</p>
<p>没有选课的免费课程、收费课程各一门，其中收费课程具有试学课程。</p>
<p>3、测试项目</p>
<p>1）选课成功的课程是否可以正常获取视频</p>
<p>2）免费课程没有选课是否可以正常学习</p>
<p>可修改选课记录表中的课程id为不存在进行测试，测试完再恢复原样。</p>
<p>3）收费课程没有选课是否可以正常学习</p>
<p>可修改选课记录表中的课程id为不存在进行测试，测试完再恢复原样。</p>
<h4 id="我的课表"><a href="#我的课表" class="headerlink" title="我的课表"></a>我的课表</h4><h5 id="需求分析-6"><a href="#需求分析-6" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h5><h6 id="业务流程-1"><a href="#业务流程-1" class="headerlink" title="业务流程"></a>业务流程</h6><p>登录网站，点击“我的学习”进入个人中心，</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228161740547.png" srcset="/img/loading.gif" lazyload alt="image-20231228161740547"></p>
<p>我的课表中显示了选课成功的免费课程、收费课程。最近学习课程显示了当前用户最近学习的课程信息。</p>
<p>点击继续学习进入当前学习章节的视频继续学习。</p>
<p>点击课程评价进入课程评价界面。</p>
<h6 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a><strong>配置nginx</strong></h6><p>在nginx配置用户中心server ,如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">XML</span><br>    server &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  ucenter.51xuecheng.cn;<br>        <span class="hljs-comment">#charset koi8-r;</span><br>        <span class="hljs-attribute">ssi</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">ssi_silent_errors</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">alias</span>   D:/itcast2022/xc_edu3.<span class="hljs-number">0</span>/code_1/xc-ui-pc-static-portal/ucenter/;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br>        <span class="hljs-section">location</span> /include &#123;<br>            <span class="hljs-attribute">proxy_pass</span>   http://127.0.0.1;<br>        &#125;<br>        <span class="hljs-section">location</span> /img/ &#123;<br>            <span class="hljs-attribute">proxy_pass</span>   http://127.0.0.1/static/img/;<br>        &#125;<br>        <span class="hljs-section">location</span> /api/ &#123;<br>                <span class="hljs-attribute">proxy_pass</span> http://gatewayserver/;<br>        &#125; <br>   &#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="接口定义-4"><a href="#接口定义-4" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h6><p>在MyCourseTablesController中定义我的课程表接口：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Java<br><span class="hljs-meta">@ApiOperation(<span class="hljs-string">&quot;我的课程表&quot;</span>)</span><br><span class="hljs-meta">@GetMapping(<span class="hljs-string">&quot;/mycoursetable&quot;</span>)</span><br><span class="hljs-keyword">public</span> PageResult&lt;XcCourseTables&gt; mycoursetable(MyCourseTableParams params) &#123;<br>   <br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h5><h6 id="DAO"><a href="#DAO" class="headerlink" title="DAO"></a><strong>DAO</strong></h6><p>使用自动生成的mapper即可实现分页查询。</p>
<h6 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h6><p>在service中定义我的课程表接口：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">Java<br>/<span class="hljs-symbol">*</span><span class="hljs-symbol">*</span><br> <span class="hljs-symbol">*</span> <span class="hljs-meta">@description</span> 我的课程表<br> <span class="hljs-symbol">*</span> <span class="hljs-meta">@param</span> params<br> <span class="hljs-symbol">*</span> <span class="hljs-meta">@return</span> com.xuecheng.base.model.PageResult<span class="hljs-variable">&lt;com.xuecheng.learning.model.po.XcCourseTables&gt;</span><br> <span class="hljs-symbol">*</span> <span class="hljs-meta">@author</span> Mr.M<br> <span class="hljs-symbol">*</span> <span class="hljs-meta">@date</span> 2022/10/27 9:24<br><span class="hljs-symbol">*</span>/<br>public PageResult<span class="hljs-variable">&lt;XcCourseTables&gt;</span> mycourestabls(MyCourseTableParams params);<br><br></code></pre></td></tr></table></figure>

<p>编写接口实现：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs lasso">Java<br><span class="hljs-keyword">public</span> PageResult&lt;XcCourseTables&gt; mycourestabls( MyCourseTableParams <span class="hljs-keyword">params</span>)&#123;<br>    <span class="hljs-comment">//页码</span><br>    long pageNo = <span class="hljs-keyword">params</span>.getPage();<br>    <span class="hljs-comment">//每页记录数,固定为4</span><br>    long pageSize = <span class="hljs-number">4</span>;<br>    <span class="hljs-comment">//分页条件</span><br>    Page&lt;XcCourseTables&gt; page = <span class="hljs-literal">new</span> Page&lt;&gt;(pageNo, pageSize);<br>    <span class="hljs-comment">//根据用户id查询</span><br>    <span class="hljs-built_in">String</span> userId = <span class="hljs-keyword">params</span>.getUserId();<br>    LambdaQueryWrapper&lt;XcCourseTables&gt; lambdaQueryWrapper = <span class="hljs-literal">new</span> LambdaQueryWrapper&lt;XcCourseTables&gt;().<span class="hljs-literal">eq</span>(XcCourseTables<span class="hljs-type">::getUserId</span>, userId);<br>    <br>    <span class="hljs-comment">//分页查询</span><br>    Page&lt;XcCourseTables&gt; pageResult = courseTablesMapper.selectPage(page, lambdaQueryWrapper);<br>    <span class="hljs-built_in">List</span>&lt;XcCourseTables&gt; <span class="hljs-keyword">records</span> = pageResult.getRecords();<br>    <span class="hljs-comment">//记录总数</span><br>    long total = pageResult.getTotal();<br>    PageResult&lt;XcCourseTables&gt; courseTablesResult = <span class="hljs-literal">new</span> PageResult&lt;&gt;(<span class="hljs-keyword">records</span>, total, pageNo, pageSize);<br>    <span class="hljs-keyword">return</span> courseTablesResult;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>完善接口：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">Java<br>@ApiOperation(<span class="hljs-string">&quot;我的课程表&quot;</span>)<br>@GetMapping(<span class="hljs-string">&quot;/mycoursetable&quot;</span>)<br>public PageResult<span class="hljs-tag">&lt;XcCourseTables&gt;</span> mycoursetable(MyCourseTableParams <span class="hljs-keyword">params</span>) &#123;<br> //登录用户<br> SecurityUtil.XcUser <span class="hljs-keyword">user</span> <span class="hljs-title">= SecurityUtil</span>.getUser();<br> if(<span class="hljs-keyword">user</span> <span class="hljs-title">== null</span>)&#123;<br>  XueChengPlusException.cast(<span class="hljs-string">&quot;请登录后继续选课&quot;</span>);<br> &#125;<br> <span class="hljs-keyword">String</span> userId = user.getId();<br>//设置当前的登录用户<br> <span class="hljs-keyword">params</span>.setUserId(userId);<br><br>  return myCourseTablesService.mycourestabls(<span class="hljs-keyword">params</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="接口测试-4"><a href="#接口测试-4" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h4><p>登录网站，点击“我的学习”进入个人中心，查看我的课程表中课程是否是当前用户所选课程。</p>
<p><img src="https://fgj3.oss-cn-beijing.aliyuncs.com/image-20231228162734898.png" srcset="/img/loading.gif" lazyload alt="image-20231228162734898"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="category-chain-item">项目</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" class="print-no-link">#学成在线</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>学成在线选课学习模块</div>
      <div>http://example.com/2023/12/28/学成在线选课学习模块/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>fgj</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年12月28日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/12/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%9D%97/" title="学成在线项目部署模块">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">学成在线项目部署模块</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/12/27/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97/" title="学成在线认证授权模块">
                        <span class="hidden-mobile">学成在线认证授权模块</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":173,"height":346},"mobile":{"show":true},"log":false});</script></body>
</html>
